<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Chi tiết Go-live Core Banking Myanmar</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" xintegrity="sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIftl+Vegovlnee1c9QX4TctnWMn13TZye+giMm8e2LwA==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8fafc;
        }
        .task-card {
            transition: all 0.3s ease;
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.07), 0 1px 2px 0 rgba(0, 0, 0, 0.05);
        }
        .task-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -4px rgba(0, 0, 0, 0.1);
        }
        .status-select {
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            background-image: url('data:image/svg+xml;charset=UTF-8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd" /></svg>');
            background-repeat: no-repeat;
            background-position: right 0.5rem center;
            background-size: 1.25em;
            padding-right: 2rem;
        }
        .progress-bar {
            transition: width 0.5s ease-in-out;
        }
        .checkpoint {
            border-left: 4px solid #FFC62F; /* BIDV Yellow */
        }
        .golive-event {
             border-left: 4px solid #16a34a; /* Green 600 */
        }
        .timeline-container {
            position: relative;
        }
        #current-time-indicator-vertical {
            position: absolute;
            top: 0;
            bottom: 0;
            width: 2px;
            background-color: #ef4444; /* Red 500 */
            z-index: 10;
        }
        #current-time-label-vertical {
            position: absolute;
            top: -10px;
            transform: translateX(-50%);
            background-color: #ef4444;
            color: white;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
            white-space: nowrap;
        }
        #current-time-indicator-horizontal {
            position: relative;
            height: 2px;
            background-color: #ef4444;
            margin: 1rem 0;
            width: 100%;
        }
        #current-time-label-horizontal {
             position: absolute;
            left: 10px;
            top: 50%;
            transform: translateY(-50%);
            background-color: #ef4444;
            color: white;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
            white-space: nowrap;
        }
        .gemini-btn, .lang-btn {
            background-color: #006B68; /* BIDV Green */
            color: white;
            padding: 8px 12px;
            border-radius: 6px;
            font-weight: 500;
            font-size: 14px;
            transition: background-color 0.3s;
        }
        .gemini-btn:hover, .lang-btn:hover {
            background-color: #004a48; /* Darker BIDV Green */
        }
        .lang-btn {
            min-width: 50px;
            text-align: center;
        }
        /* Modal styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 50;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.5);
        }
        .modal-content {
            background-color: #fefefe;
            margin: 10% auto;
            padding: 24px;
            border: 1px solid #888;
            width: 80%;
            max-width: 640px;
            border-radius: 8px;
            position: relative;
        }
        .close-btn {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }
        .close-btn:hover,
        .close-btn:focus {
            color: black;
        }
         /* Spinner */
        .loader {
            border: 5px solid #f3f3f3;
            border-top: 5px solid #006B68; /* BIDV Green */
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="p-4 md:p-8">

    <div class="max-w-screen-xl mx-auto">
        <!-- Header -->
        <div class="mb-8 text-center">
            <h1 id="header-title" class="text-3xl md:text-4xl font-bold text-[#006B68]"></h1>
            <div class="flex items-center justify-center gap-4 mt-2">
                <p id="header-subtitle" class="text-lg text-gray-600"></p>
                <button id="quick-report-btn" class="gemini-btn"></button>
                <button id="lang-switcher-btn" class="lang-btn"></button>
            </div>
        </div>
        
        <!-- Banner Image -->
        <div class="w-full h-48 md:h-64 bg-cover bg-center rounded-lg shadow-lg mb-8" style="background-image: url('https://images.unsplash.com/photo-1524178232363-1fb2b075b655?q=80&w=2070&auto=format&fit=crop');">
        </div>

        <!-- Progress Bar -->
        <div class="mb-8">
            <div class="flex justify-between mb-1">
                <span id="progress-title" class="text-base font-medium text-[#006B68]"></span>
                <span class="text-sm font-medium text-[#006B68]" id="progress-text">0%</span>
            </div>
            <div class="w-full bg-gray-200 rounded-full h-2.5">
                <div id="progress-bar" class="bg-[#006B68] h-2.5 rounded-full" style="width: 0%"></div>
            </div>
        </div>

        <!-- Task Columns -->
        <div class="timeline-container">
             <div class="grid grid-cols-1 md:grid-cols-3 lg:grid-cols-5 gap-6" id="task-board">
                <!-- Columns will be generated by JavaScript -->
            </div>
            <div id="current-time-indicator-vertical" style="display: none;">
                <div id="current-time-label-vertical"></div>
            </div>
        </div>
    </div>
    
    <!-- Modal for Gemini Response -->
    <div id="gemini-modal" class="modal">
      <div class="modal-content">
        <span class="close-btn">&times;</span>
        <h2 id="modal-title" class="text-2xl font-bold mb-4 text-gray-800"></h2>
        <div id="modal-body" class="prose max-w-none">
            <!-- Content will be injected here -->
        </div>
      </div>
    </div>


    <script>
        const TASK_STATUS_STORAGE_KEY = 'goLiveTaskStatus';
        const LANG_STORAGE_KEY = 'goLiveLang';

        // --- Data and Translations ---
        const taskStructure = {
            day1: [ { id: 101, time: 'Deadline 16/09' }, { id: 102, time: 'Deadline 16/09' }, { id: 103, time: 'Deadline 18/09' }, { id: 104, time: 'Deadline 18/09' }, { id: 105, time: 'Deadline 19/09' }, { id: 106, time: 'Deadline 19/09' } ],
            day2: [ { id: 1, time: '18:00 - 23:00 MMT' }, { id: 2, time: '19:00 - 23:00 MMT' }, { id: 3, time: '23:30 MMT', type: 'checkpoint' } ],
            day3: [ { id: 4, time: '07:00 - 14:00' }, { id: 5, time: '07:00 - 14:00' }, { id: 6, time: '14:00 MMT', type: 'checkpoint' }, { id: 7, time: '14:00 MMT', type: 'checkpoint' }, { id: 8, time: 'Trước 15:00 MMT', type: 'checkpoint' }, { id: 9, time: '15:00 MMT' }, { id: 10, time: 'Sau 15:00' }, { id: 11, time: '23:49 MMT' } ],
            day4: [ { id: 12, time: 'Sau EOD' }, { id: 13, time: 'Cả ngày' }, { id: 14, time: 'Cuối ngày' } ],
            day5: [ { id: 15, time: '08:00 MMT', type: 'golive' } ]
        };
        
        const translations = {
            vi: {
                header_title: "Dashboard Kế hoạch Go-live",
                header_subtitle: "Dự án Chuyển đổi Core Banking BIDV tại Myanmar",
                quick_report_btn: "✨ Tạo Báo cáo Nhanh",
                lang_btn: "EN",
                progress_title: "Tiến độ tổng thể",
                current_time: "Hiện tại",
                modal_loading_title: "Đang xử lý...",
                modal_loading_text: "Vui lòng chờ trong giây lát...",
                risk_analysis_title: "✨ Phân tích Rủi ro & Đề xuất",
                quick_report_title: "✨ Báo cáo Nhanh Trạng thái Dự án",
                risk_analysis_btn: "✨ Phân tích Rủi ro",
                statuses: { pending: 'Chưa bắt đầu', inprogress: 'Đang thực hiện', done: 'Hoàn thành', blocked: 'Bị chặn' },
                days: { day1: "Thứ 5, 18/09/2025 (Chuẩn bị)", day2: "Thứ 6, 19/09/2025 (Chuyển đổi)", day3: "Thứ 7, 20/09/2025 (Kiểm thử & Quyết định)", day4: "Chủ nhật, 21/09/2025 (Vận hành T+1)", day5: "Thứ 2, 22/09/2025 (GO-LIVE)" },
                tasks: {
                    101: { task: 'Cài đặt và trình phê duyệt bộ tham số triển khai lên môi trường Production.', assignee: 'Ban QLDA CBM' },
                    102: { task: 'Hoàn thiện và bàn giao hồ sơ triển khai các ứng dụng ngoài tới TTCNTT.', assignee: 'Ban QLDA CBM' },
                    103: { task: 'Đăng ký user, IP máy tính để vận hành hệ thống mới theo quy định.', assignee: 'Ban QLDA CBM, CN Yangon, Ban QLPTCB, TTCNTT' },
                    104: { task: 'Trình Ban Lãnh đạo phê duyệt các văn bản hướng dẫn triển khai hệ thống mới.', assignee: 'Chi nhánh Yangon' },
                    105: { task: 'Thông báo tới khách hàng về thời gian gián đoạn dịch vụ.', assignee: 'Ban QLDA CBM, Chi nhánh Yangon' },
                    106: { task: 'Thiết kế ấn phẩm và thực hiện truyền thông nội bộ.', assignee: 'Ban QLDA CBM' },
                    1: { task: 'Cập nhật/nâng cấp các hệ thống ứng dụng tích hợp (ERP, BSMS, iBank, SWIFT GPI, CCS...).', assignee: 'Ban QLDA CBM, Ban QLPTCB, TTCNTT, TT PTNHS' },
                    2: { task: 'Chuyển đổi dữ liệu (thông tin KH, TK tiền gửi, tiền vay, TTTM) từ Intellect sang Profile.', assignee: 'Ban QLDA CBM' },
                    3: { task: 'CHECKPOINT #1: Đối chiếu, xác nhận dữ liệu chuyển đổi thành công. Ra quyết định Go/No-Go thực hiện bước tiếp theo.', assignee: 'Ban Chỉ đạo, Ban QLDA CBM' },
                    4: { task: 'Thực hiện Smoke test các tính năng nghiệp vụ, kỹ thuật trên Core Profile.', assignee: 'Ban QLDA CBM' },
                    5: { task: 'Kiểm tra tính năng tích hợp, kết nối giữa các ứng dụng và Profile.', assignee: 'Ban QLDA CBM' },
                    6: { task: 'CHECKPOINT #2: Xác nhận kết quả smoke test tính năng Core Banking Profile.', assignee: 'Ban Chỉ đạo, Ban QLDA CBM' },
                    7: { task: 'CHECKPOINT #3: Xác nhận kết quả smoke test các ứng dụng tích hợp.', assignee: 'Ban Chỉ đạo, Ban QLDA СВМ' },
                    8: { task: 'QUYẾT ĐỊNH GO/NO-GO TOÀN BỘ HỆ THỐNG.', assignee: 'Ban Chỉ đạo, Ban QLDA CBM' },
                    9: { task: 'Mở dịch vụ Online iBank, BSMS cho khách hàng.', assignee: 'Ban QLDA CBM' },
                    10: { task: 'Thực hiện các công việc sau Golive (Đóng hệ thống Intellect, chuyển sang chế độ chỉ vấn tin).', assignee: 'Ban QLDA CBM, CN Yangon' },
                    11: { task: 'Chạy xử lý cuối ngày (EOD) ngày đầu tiên trên hệ thống mới.', assignee: 'Ban QLDA CBM' },
                    12: { task: 'Kiểm tra toàn bộ hệ thống sau EOD ngày T+1.', assignee: 'Ban QLDA CBM' },
                    13: { task: 'Vận hành, kiểm tra và chấm dữ liệu ngày T+1 (Báo cáo MIS, GL-Core-Hub, SVS, iBank).', assignee: 'Chi nhánh Yangon' },
                    14: { task: 'Chạy xử lý cuối ngày (EOD) ngày thứ 2.', assignee: 'Ban QLDA CBM' },
                    15: { task: 'GO-LIVE: Hệ thống Core Banking Profile chính thức hoạt động tại kênh quầy (Branch Open).', assignee: 'CN Yangon, Ban QLDA CBM, Ban QLPTCB, TTCNTT, TT PTNHS & các TT liên quan' }
                }
            },
            en: {
                header_title: "Go-live Plan Dashboard",
                header_subtitle: "Core Banking Transformation Project in Myanmar",
                quick_report_btn: "✨ Quick Report",
                lang_btn: "VI",
                progress_title: "Overall Progress",
                current_time: "Current",
                modal_loading_title: "Processing...",
                modal_loading_text: "Please wait a moment...",
                risk_analysis_title: "✨ Risk Analysis & Recommendations",
                quick_report_title: "✨ Project Status Quick Report",
                risk_analysis_btn: "✨ Analyze Risk",
                statuses: { pending: 'Pending', inprogress: 'In Progress', done: 'Completed', blocked: 'Blocked' },
                days: { day1: "Thursday, 18/09/2025 (Preparation)", day2: "Friday, 19/09/2025 (Conversion)", day3: "Saturday, 20/09/2025 (Testing & Decision)", day4: "Sunday, 21/09/2025 (Post Go-live T+1)", day5: "Monday, 22/09/2025 (GO-LIVE)" },
                tasks: {
                    101: { task: 'Install and submit for approval the parameter set for the Production environment.', assignee: 'PMO CBM' },
                    102: { task: 'Finalize and hand over implementation documents for external applications to the IT Center.', assignee: 'PMO CBM' },
                    103: { task: 'Register users and IP addresses for the new system operation.', assignee: 'PMO CBM, Yangon Branch, Core Banking Dev Dept, IT Center' },
                    104: { task: 'Submit guidance documents for the new system deployment to the Board of Directors for approval.', assignee: 'Yangon Branch' },
                    105: { task: 'Notify customers about the service interruption period.', assignee: 'PMO CBM, Yangon Branch' },
                    106: { task: 'Design publications and carry out internal communications.', assignee: 'PMO CBM' },
                    1: { task: 'Update/upgrade integrated application systems (ERP, BSMS, iBank, SWIFT GPI, CCS...).', assignee: 'PMO CBM, Core Banking Dev Dept, IT Center, App Dev Center' },
                    2: { task: 'Convert data (customer info, deposits, loans, trade finance) from Intellect to Profile.', assignee: 'PMO CBM' },
                    3: { task: 'CHECKPOINT #1: Reconcile and confirm successful data conversion. Make Go/No-Go decision for the next step.', assignee: 'Steering Committee, PMO CBM' },
                    4: { task: 'Perform Smoke test for business and technical features on Core Profile.', assignee: 'PMO CBM' },
                    5: { task: 'Test integration and connectivity between applications and Profile.', assignee: 'PMO CBM' },
                    6: { task: 'CHECKPOINT #2: Confirm smoke test results for Core Banking Profile features.', assignee: 'Steering Committee, PMO CBM' },
                    7: { task: 'CHECKPOINT #3: Confirm smoke test results for integrated applications.', assignee: 'Steering Committee, PMO CBM' },
                    8: { task: 'FINAL GO/NO-GO DECISION FOR THE ENTIRE SYSTEM.', assignee: 'Steering Committee, PMO CBM' },
                    9: { task: 'Launch iBank and BSMS online services for customers.', assignee: 'PMO CBM' },
                    10: { task: 'Perform post-Golive tasks (Shut down Intellect system, switch to inquiry-only mode).', assignee: 'PMO CBM, Yangon Branch' },
                    11: { task: 'Run End of Day (EOD) processing for the first day on the new system.', assignee: 'PMO CBM' },
                    12: { task: 'Check the entire system after the first EOD (T+1).', assignee: 'PMO CBM' },
                    13: { task: 'Operate, check, and reconcile data for day T+1 (MIS, GL-Core-Hub, SVS, iBank reports).', assignee: 'Yangon Branch' },
                    14: { task: 'Run End of Day (EOD) for the second day.', assignee: 'PMO CBM' },
                    15: { task: 'GO-LIVE: The Core Banking Profile system is officially operational at the branch counter.', assignee: 'Yangon Branch, PMO CBM, Core Banking Dev Dept, IT Center, App Dev Center & related centers' }
                }
            }
        };

        const defaultStatuses = { 101: 'done', 102: 'done', 103: 'done', 104: 'done', 105: 'done', 106: 'done', 1: 'inprogress', 2: 'inprogress', 3: 'pending', 4: 'pending', 5: 'pending', 6: 'pending', 7: 'pending', 8: 'pending', 9: 'pending', 10: 'pending', 11: 'pending', 12: 'pending', 13: 'pending', 14: 'pending', 15: 'pending' };

        function getInitialStatuses() {
            try {
                const saved = localStorage.getItem(TASK_STATUS_STORAGE_KEY);
                return saved ? JSON.parse(saved) : defaultStatuses;
            } catch (e) {
                console.error("Failed to load statuses:", e);
                return defaultStatuses;
            }
        }
        
        let taskStatuses = getInitialStatuses();
        let currentLang = localStorage.getItem(LANG_STORAGE_KEY) || 'vi';

        const statusConfig = {
            pending:    { text_key: 'pending',   bg: 'bg-slate-100', text_color: 'text-slate-600' },
            inprogress: { text_key: 'inprogress',  bg: 'bg-amber-100', text_color: 'text-amber-800' },
            done:       { text_key: 'done',       bg: 'bg-teal-100', text_color: 'text-[#006B68]' },
            blocked:    { text_key: 'blocked',         bg: 'bg-rose-100', text_color: 'text-rose-700' }
        };

        const dayIcons = { day1: 'fa-solid fa-clipboard-list', day2: 'fa-solid fa-right-left', day3: 'fa-solid fa-magnifying-glass', day4: 'fa-solid fa-gears', day5: 'fa-solid fa-rocket' };

        const taskBoard = document.getElementById('task-board');
        const modal = document.getElementById('gemini-modal');
        const modalTitle = document.getElementById('modal-title');
        const modalBody = document.getElementById('modal-body');
        const closeBtn = document.querySelector('.close-btn');

        const API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=`; // Add your key here

        async function callGeminiAPI(prompt, retries = 3, delay = 1000) {
            try {
                const payload = { contents: [{ parts: [{ text: prompt }] }] };
                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                if (!response.ok) throw new Error(`API call failed with status: ${response.status}`);
                const result = await response.json();
                const candidate = result.candidates?.[0];
                if (candidate && candidate.content?.parts?.[0]?.text) {
                    return candidate.content.parts[0].text;
                } else {
                    throw new Error("Invalid response structure from API");
                }
            } catch (error) {
                console.error("Error calling Gemini API:", error);
                 if (retries > 0) {
                    await new Promise(res => setTimeout(res, delay));
                    return callGeminiAPI(prompt, retries - 1, delay * 2);
                }
                return "Đã xảy ra lỗi khi kết nối với Gemini API. Vui lòng thử lại sau.";
            }
        }

        function showModal(title, content) {
            modalTitle.textContent = title;
            modalBody.innerHTML = content;
            modal.style.display = 'block';
        }

        function showLoading() {
            showModal(translations[currentLang].modal_loading_title, `<div class="loader"></div><p class="text-center">${translations[currentLang].modal_loading_text}</p>`);
        }
        
        closeBtn.onclick = () => modal.style.display = 'none';
        window.onclick = (event) => { if (event.target == modal) modal.style.display = 'none'; };

        async function handleRiskAnalysis(taskId, dayKey) {
            const task = translations[currentLang].tasks[taskId];
            if (!task) return;
            showLoading();
            const prompt = `Bạn là một chuyên gia quản lý dự án cho một dự án chuyển đổi hệ thống Core Banking trọng điểm.
            Một công việc quan trọng đã bị chặn.
            - Tên công việc: "${task.task}"
            - Đơn vị phụ trách: "${task.assignee}"
            - Giai đoạn: "${translations[currentLang].days[dayKey]}"
            Hãy tạo một phân tích HTML thân thiện với người dùng.
            Sử dụng các thẻ HTML sau: <h3> cho tiêu đề chính, <p> cho mô tả, <ol> và <li> cho danh sách chiến lược, và <strong> để nhấn mạnh.
            Thêm các class Tailwind CSS đơn giản: h3 class="text-lg font-semibold text-gray-700 mt-4 mb-2", p class="text-gray-600 mb-2", ol class="list-decimal list-inside space-y-2".
            Phân tích các tác động dây chuyền và đề xuất 3 chiến lược giảm thiểu rủi ro cụ thể.`;
            const analysis = await callGeminiAPI(prompt);
            showModal(translations[currentLang].risk_analysis_title, analysis);
        }

        document.getElementById('quick-report-btn').addEventListener('click', async () => {
            showLoading();
            const T = translations[currentLang];
            let reportData = `Dưới đây là trạng thái hiện tại của các công việc trong dự án Go-live Core Banking Myanmar:\n\n`;
            for (const dayKey in taskStructure) {
                reportData += `**${T.days[dayKey]}**\n`;
                taskStructure[dayKey].forEach(taskInfo => {
                    const statusText = T.statuses[taskStatuses[taskInfo.id]];
                    const task = T.tasks[taskInfo.id];
                    reportData += `- ${task.task} (Trạng thái: ${statusText}, Phụ trách: ${task.assignee})\n`;
                });
                reportData += "\n";
            }
            const prompt = `Bạn là trợ lý quản lý dự án. Dựa trên báo cáo trạng thái công việc sau đây, hãy tạo một báo cáo tóm tắt dạng HTML thân thiện với người dùng.
            Sử dụng các thẻ HTML sau: <h3> cho tiêu đề mục, <ul> và <li> cho danh sách công việc, <strong> để nhấn mạnh.
            Thêm các class Tailwind CSS đơn giản: h3 class="text-lg font-semibold text-gray-700 mb-2", ul class="list-disc list-inside space-y-1", li class="text-gray-600".
            Cấu trúc báo cáo thành ba phần:
            1.  **Đã hoàn thành:**
            2.  **Đang thực hiện:**
            3.  **Rủi ro & Trở ngại:**
            Dữ liệu báo cáo: \n${reportData}`;
            const summary = await callGeminiAPI(prompt);
            showModal(T.quick_report_title, summary);
        });

        function renderAllUI() {
            document.documentElement.lang = currentLang;
            const T = translations[currentLang];

            // Update static text
            document.getElementById('header-title').textContent = T.header_title;
            document.getElementById('header-subtitle').textContent = T.header_subtitle;
            document.getElementById('quick-report-btn').textContent = T.quick_report_btn;
            document.getElementById('lang-switcher-btn').textContent = T.lang_btn;
            document.getElementById('progress-title').textContent = T.progress_title;
            document.getElementById('current-time-label-vertical').textContent = T.current_time;
            
            // Render dynamic task board
            taskBoard.innerHTML = '';
            let totalTasks = 0;
            let completedTasks = 0;
            let taskCounter = 1;

            for (const dayKey in taskStructure) {
                const dayColumn = document.createElement('div');
                dayColumn.className = 'bg-white/60 backdrop-blur-sm p-4 rounded-lg shadow-sm';
                let dayTitleColor = T.days[dayKey].includes("GO-LIVE") ? "text-[#006B68] font-bold" : "text-gray-700";
                let iconHTML = `<i class="${dayIcons[dayKey]} mr-2 text-[#006B68] opacity-80"></i>`;
                
                dayColumn.innerHTML = `<h2 class="text-xl font-semibold mb-4 pb-2 border-b ${dayTitleColor} flex items-center">${iconHTML}${T.days[dayKey]}</h2>`;
                const tasksContainer = document.createElement('div');
                tasksContainer.className = 'space-y-4';
                
                taskStructure[dayKey].forEach(taskInfo => {
                    const taskId = taskInfo.id;
                    const taskStatusKey = taskStatuses[taskId];
                    const status = statusConfig[taskStatusKey];
                    const taskData = T.tasks[taskId];

                    totalTasks++;
                    if (taskStatusKey === 'done') completedTasks++;

                    const taskCard = document.createElement('div');
                    taskCard.setAttribute('data-task-id', taskId);
                    taskCard.className = `task-card relative p-4 rounded-lg ${status.bg} ${taskInfo.type || ''}`;

                    let geminiButtonHTML = '';
                    if (taskStatusKey === 'blocked') {
                        geminiButtonHTML = `<button data-id="${taskId}" data-day-key="${dayKey}" class="risk-analysis-btn mt-3 w-full text-sm font-semibold text-rose-700 hover:text-rose-900">${T.risk_analysis_btn}</button>`;
                    }

                    let taskText = taskData.task;
                    const highlightClass = 'font-bold text-green-600';
                    taskText = taskText.replace(/CHECKPOINT|QUYẾT ĐỊNH GO\/NO-GO TOÀN BỘ HỆ THỐNG|GO-LIVE|CHECKPOINT|FINAL GO\/NO-GO DECISION FOR THE ENTIRE SYSTEM/g, match => `<strong class="${highlightClass}">${match}</strong>`);

                    const taskNumberHTML = `<div class="absolute -top-3 -left-3 flex items-center justify-center w-7 h-7 rounded-full bg-[#006B68] text-[#FFC62F] font-bold text-sm shadow-md">${taskCounter}</div>`;

                    let statusOptionsHTML = '';
                    for (const key in T.statuses) {
                        statusOptionsHTML += `<option value="${key}" ${taskStatusKey === key ? 'selected' : ''}>${T.statuses[key]}</option>`;
                    }

                    taskCard.innerHTML = `
                        ${taskNumberHTML}
                        <div class="flex justify-between items-start">
                            <p class="text-sm font-semibold ${status.text_color} opacity-80">${taskInfo.time}</p>
                            <select data-id="${taskId}" class="status-select text-xs font-medium rounded border-gray-300 focus:ring-[#006B68] focus:border-[#006B68]">${statusOptionsHTML}</select>
                        </div>
                        <p class="font-medium ${status.text_color} my-2">${taskText}</p>
                        <div class="flex items-center mt-2 ${status.text_color} opacity-90">
                            <svg class="w-4 h-4 mr-2 flex-shrink-0" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z" clip-rule="evenodd"></path></svg>
                            <p class="text-sm" title="${taskData.assignee}">${taskData.assignee}</p>
                        </div>
                        ${geminiButtonHTML}`;
                    
                    tasksContainer.appendChild(taskCard);
                    taskCounter++;
                });
                dayColumn.appendChild(tasksContainer);
                taskBoard.appendChild(dayColumn);
            }
            const progress = totalTasks > 0 ? Math.round((completedTasks / totalTasks) * 100) : 0;
            document.getElementById('progress-bar').style.width = `${progress}%`;
            document.getElementById('progress-text').innerText = `${progress}%`;
            
            updateCurrentTimeIndicator();
        }
        
        function parseTaskTime(taskInfo, dayKey) {
            const dayString = translations.en.days[dayKey]; // Use EN for consistent parsing
            const dateMatch = dayString.match(/(\d{2})\/(\d{2})\/(\d{4})/);
            if (!dateMatch) return null;
            const [, day, month, year] = dateMatch;
            const dateStr = `${year}-${month}-${day}`;
            let timeStr = '00:00:00';
            const timeMatch = taskInfo.time.match(/(\d{2}):(\d{2})/);
            if (timeMatch) timeStr = `${timeMatch[1]}:${timeMatch[2]}:00`;
            return new Date(`${dateStr}T${timeStr}+07:00`);
        }

        function updateCurrentTimeIndicator() {
            const verticalIndicator = document.getElementById('current-time-indicator-vertical');
            verticalIndicator.style.display = 'none';
            const oldHorizontal = document.getElementById('current-time-indicator-horizontal');
            if (oldHorizontal) oldHorizontal.remove();
            
            const now = new Date(); // Use real current time
            const mdBreakpoint = 768;

            if (window.innerWidth >= mdBreakpoint) {
                const timelineStart = new Date('2025-09-18T00:00:00+07:00');
                const timelineEnd = new Date('2025-09-22T23:59:59+07:00');
                const totalDuration = timelineEnd.getTime() - timelineStart.getTime();
                const elapsedDuration = now.getTime() - timelineStart.getTime();
                if (elapsedDuration >= 0 && elapsedDuration <= totalDuration) {
                    const positionPercent = (elapsedDuration / totalDuration) * 100;
                    verticalIndicator.style.left = `${positionPercent}%`;
                    verticalIndicator.style.display = 'block';
                }
            } else {
                let lastTaskBeforeNowEl = null;
                for (const dayKey in taskStructure) {
                    for (const taskInfo of taskStructure[dayKey]) {
                        const taskDate = parseTaskTime(taskInfo, dayKey);
                        if (taskDate && taskDate < now) {
                            lastTaskBeforeNowEl = document.querySelector(`[data-task-id="${taskInfo.id}"]`);
                        }
                    }
                }
                const horizontalIndicator = document.createElement('div');
                horizontalIndicator.id = 'current-time-indicator-horizontal';
                horizontalIndicator.innerHTML = `<div id="current-time-label-horizontal">${translations[currentLang].current_time}</div>`;
                if (lastTaskBeforeNowEl) {
                    lastTaskBeforeNowEl.after(horizontalIndicator);
                } else {
                    const firstTaskContainer = taskBoard.querySelector('.space-y-4');
                    if (firstTaskContainer) firstTaskContainer.prepend(horizontalIndicator);
                }
            }
        }
        
        // --- Event Listeners ---
        document.getElementById('lang-switcher-btn').addEventListener('click', () => {
            currentLang = currentLang === 'vi' ? 'en' : 'vi';
            localStorage.setItem(LANG_STORAGE_KEY, currentLang);
            renderAllUI();
        });

        taskBoard.addEventListener('change', (e) => {
            if (e.target.classList.contains('status-select')) {
                const taskId = e.target.dataset.id;
                taskStatuses[taskId] = e.target.value;
                try {
                    localStorage.setItem(TASK_STATUS_STORAGE_KEY, JSON.stringify(taskStatuses));
                } catch (err) {
                    console.error("Failed to save statuses:", err);
                }
                renderAllUI();
            }
        });
        
        taskBoard.addEventListener('click', (e) => {
            if (e.target.classList.contains('risk-analysis-btn')) {
                const taskId = parseInt(e.target.dataset.id);
                const dayKey = e.target.dataset.dayKey;
                handleRiskAnalysis(taskId, dayKey);
            }
        });

        window.addEventListener('resize', updateCurrentTimeIndicator);
        
        // --- Initial Load ---
        renderAllUI();

    </script>
</body>
</html>


