<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>CBAP Master - Premium Dark</title>
    
    <!-- Tailwind Config - Premium Dark Mode -->
    <script>
        window.tailwind = {
            config: {
                darkMode: 'class',
                theme: {
                    extend: {
                        colors: {
                            navy: { 
                                dark: '#001a33',   // Nền chính (Body)
                                DEFAULT: '#003366', // Nền thẻ (Cards)
                                light: 'rgba(255, 255, 255, 0.05)' 
                            },
                            orange: { 
                                DEFAULT: '#FF6600', // Accent chính
                                hover: '#FF8533' 
                            },
                            gray: {
                                300: '#D1D5DB',
                                400: '#9CA3AF',
                                800: '#1F2937',
                                900: '#111827'
                            }
                        },
                        fontFamily: { 
                            sans: ['Helvetica Neue', 'Helvetica', 'Arial', 'sans-serif'],
                            display: ['Arial', 'sans-serif'] 
                        },
                        animation: {
                            'view-fade': 'viewFade 0.4s ease-out forwards',
                            'pulse-slow': 'pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                        },
                        keyframes: {
                            viewFade: {
                                '0%': { opacity: '0', transform: 'translateY(15px)' },
                                '100%': { opacity: '1', transform: 'translateY(0)' },
                            }
                        }
                    }
                }
            }
        }
    </script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
    
    <!-- Libraries -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.7/dist/umd/supabase.min.js"></script>
    
    <style>
        /* Base Dark Styles */
        body { 
            font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif; 
            background-color: #001a33; /* Navy Dark */
            color: #D1D5DB; /* Gray 300 */
            -webkit-font-smoothing: antialiased; 
            -moz-osx-font-smoothing: grayscale; 
        }
        
        /* Typography Overrides */
        h1, h2, h3, h4, h5, h6 {
            color: white;
            font-weight: 900 !important; /* font-black */
            font-style: italic;
        }

        /* Custom Scrollbar - Dark Theme */
        .custom-scrollbar::-webkit-scrollbar { width: 6px; height: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #001a33; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #003366; border-radius: 3px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #FF6600; }
        
        /* Navigation Styles */
        .nav-item { transition: all 0.3s ease; border-left: 3px solid transparent; color: #9CA3AF; }
        .nav-item:hover { background-color: rgba(255, 102, 0, 0.1); color: #FF6600; }
        .nav-item.active { background-color: #003366; border-left-color: #FF6600; }
        .nav-item.active .nav-text { color: #FF6600; font-weight: 800; font-style: italic; }
        .nav-item.active i { color: #FF6600; }
        
        /* Swiss Buttons - Updated for Dark Mode */
        .swiss-btn { 
            border-radius: 4px; 
            font-weight: 700; 
            text-transform: uppercase; 
            letter-spacing: 1px; 
            font-size: 0.75rem; 
            transition: all 0.3s ease; 
            cursor: pointer; 
            padding: 12px 24px; 
            box-shadow: 0 4px 6px rgba(0,0,0,0.3);
        }
        .swiss-btn-primary { background-color: #FF6600; color: white; border: 1px solid #FF6600; }
        .swiss-btn-primary:hover { background-color: #E65C00; transform: translateY(-1px); box-shadow: 0 6px 12px rgba(255, 102, 0, 0.2); }
        .swiss-btn-outline { background-color: transparent; color: #D1D5DB; border: 1px solid rgba(255,255,255,0.05); }
        .swiss-btn-outline:hover { border-color: #FF6600; color: #FF6600; background: rgba(0, 51, 102, 0.5); }

        /* --- FLIP CARD STYLES (FIXED & ROBUST) --- */
        .flip-container { 
            perspective: 1000px; 
            transform-style: preserve-3d;
        }
        .flip-inner { 
            position: relative; 
            width: 100%; 
            height: 100%; 
            text-align: center; 
            transition: transform 0.8s cubic-bezier(0.175, 0.885, 0.32, 1.275); 
            transform-style: preserve-3d; 
        }
        
        /* Trạng thái lật */
        .flip-container.flipped .flip-inner { 
            transform: rotateY(180deg); 
        }

        .flip-front, .flip-back { 
            position: absolute; 
            width: 100%; 
            height: 100%; 
            -webkit-backface-visibility: hidden; 
            backface-visibility: hidden; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            flex-direction: column; 
            border-radius: 12px; 
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.5);
            top: 0; 
            left: 0;
        }

        /* Mặt trước (Front) */
        .flip-front { 
            background-color: #003366; 
            color: white; 
            z-index: 2; 
            transform: rotateY(0deg); 
            border: 1px solid rgba(255,255,255,0.02); 
        }

        /* Mặt sau (Back) */
        .flip-back { 
            background-color: #003366; 
            color: white; 
            transform: rotateY(180deg); 
            z-index: 1; 
            border: 2px solid #FF6600; 
        }

        /* Spinner & Toast */
        #loading-overlay { position: fixed; inset: 0; background: #001a33; z-index: 5000; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .spinner { width: 50px; height: 50px; border: 4px solid #003366; border-top: 4px solid #FF6600; border-radius: 50%; animation: spin 1s linear infinite; box-shadow: 0 0 15px rgba(255,102,0,0.2); }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        .toast { 
            min-width: 280px; 
            background: #003366; 
            border-left: 4px solid #FF6600; 
            padding: 16px; 
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.5); 
            animation: slideIn 0.3s ease-out forwards; 
            display: flex; align-items: center; gap: 12px; 
            z-index: 6000; 
            border: 1px solid rgba(255,255,255,0.05);
            color: white;
        }
        @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }

        /* Helpers */
        .glass-panel { background: rgba(0, 51, 102, 0.4); backdrop-filter: blur(8px); border: 1px solid rgba(255, 255, 255, 0.02); }
        .text-glow { text-shadow: 0 0 10px rgba(255, 102, 0, 0.3); }
        
        /* Inputs Override */
        input {
            background-color: #002244 !important;
            border-color: rgba(255,255,255,0.05) !important;
            color: white !important;
        }
        input:focus {
            border-color: #FF6600 !important;
            box-shadow: 0 0 0 1px #FF6600 !important;
        }
    </style>
</head>
<body class="h-screen flex flex-col md:flex-row overflow-hidden text-gray-300 bg-navy-dark font-sans selection:bg-orange selection:text-white">

    <!-- LOADING SCREEN -->
    <div id="loading-overlay">
        <div class="spinner mb-6"></div>
        <h2 class="text-3xl font-black text-white italic tracking-widest uppercase text-glow">CBAP<span class="text-orange">.PRO</span></h2>
        <p id="loading-status" class="text-[10px] text-gray-500 mt-2 font-mono font-bold tracking-[0.2em] uppercase">System Initializing...</p>
        <button id="manual-entry-btn" onclick="app.emergencyEnter()" class="hidden mt-8 px-8 py-3 bg-orange text-white text-xs font-black italic uppercase tracking-widest hover:bg-orange-hover transition shadow-lg rounded">Force Start</button>
    </div>

    <!-- MOBILE HEADER -->
    <header class="md:hidden h-16 bg-navy-dark border-b border-navy-light flex items-center justify-between px-4 z-40 flex-shrink-0 shadow-lg">
        <div class="flex items-center gap-4">
            <button onclick="app.toggleSidebar()" class="text-white text-xl focus:outline-none hover:text-orange transition"><i class="fa-solid fa-bars"></i></button>
            <div class="font-black italic text-white text-lg tracking-tight">CBAP<span class="text-orange">.PRO</span></div>
        </div>
        <div class="w-8 h-8 bg-orange text-white rounded flex items-center justify-center font-bold text-xs shadow-md" id="mobile-user-avatar">U</div>
    </header>

    <!-- MOBILE SIDEBAR OVERLAY -->
    <div id="mobile-overlay" onclick="app.toggleSidebar()" class="fixed inset-0 bg-black bg-opacity-80 z-30 hidden md:hidden transition-opacity backdrop-blur-sm"></div>

    <!-- SIDEBAR -->
    <aside id="sidebar" class="fixed inset-y-0 left-0 z-40 w-64 bg-navy-dark border-r border-navy-light transform -translate-x-full md:relative md:translate-x-0 sidebar-transition flex flex-col shadow-2xl md:shadow-none">
        <!-- Logo Area -->
        <div class="h-20 hidden md:flex items-center px-6 bg-navy-dark border-b border-navy-light">
            <div class="w-8 h-8 bg-orange text-white rounded flex items-center justify-center font-bold text-sm mr-3 shadow-lg shadow-orange/20">C</div>
            <div class="font-black italic text-white text-xl tracking-tighter">CBAP<span class="text-orange">.PRO</span></div>
        </div>
        
        <!-- User Info -->
        <div class="px-6 py-6 border-b border-navy-light flex items-center gap-3 cursor-pointer hover:bg-navy transition group" onclick="app.nav('auth')">
            <div class="w-10 h-10 rounded bg-navy border border-navy-light group-hover:border-orange text-white flex items-center justify-center font-bold text-sm shadow-inner" id="sidebar-avatar">G</div>
            <div class="overflow-hidden">
                <div class="text-sm font-bold text-white truncate group-hover:text-orange transition" id="sidebar-username">Guest User</div>
                <div class="text-[9px] text-gray-500 uppercase tracking-widest font-bold" id="sidebar-status">Click to Login</div>
            </div>
        </div>
        
        <!-- Nav Links -->
        <nav class="flex-1 overflow-y-auto py-6 space-y-1 bg-navy-dark custom-scrollbar">
            <button onclick="app.nav('dashboard')" id="nav-dashboard" class="nav-item w-full text-left px-6 py-3 flex items-center group">
                <i class="fa-solid fa-chart-pie w-5 text-center transition-colors"></i> 
                <span class="nav-text text-xs ml-3 uppercase tracking-widest">Dashboard</span>
            </button>
            <button onclick="app.nav('learn')" id="nav-learn" class="nav-item w-full text-left px-6 py-3 flex items-center group">
                <i class="fa-solid fa-graduation-cap w-5 text-center transition-colors"></i>
                <span class="nav-text text-xs ml-3 uppercase tracking-widest">Knowledge Hub</span>
            </button>
            <button onclick="app.nav('library')" id="nav-library" class="nav-item w-full text-left px-6 py-3 flex items-center group">
                <i class="fa-solid fa-book-open w-5 text-center transition-colors"></i>
                <span class="nav-text text-xs ml-3 uppercase tracking-widest">Library</span>
            </button>
            <button onclick="app.nav('exam')" id="nav-exam" class="nav-item w-full text-left px-6 py-3 flex items-center group">
                <i class="fa-solid fa-microchip w-5 text-center transition-colors"></i>
                <span class="nav-text text-xs ml-3 uppercase tracking-widest">Exam Engine</span>
            </button>
            <button onclick="app.nav('flashcards')" id="nav-flashcards" class="nav-item w-full text-left px-6 py-3 flex items-center group">
                <i class="fa-solid fa-bolt w-5 text-center transition-colors"></i>
                <span class="nav-text text-xs ml-3 uppercase tracking-widest">Flashcards</span>
            </button>
            
            <!-- Removed System/Settings and added Logout Button (Hidden by default) -->
            <button onclick="Auth.logout()" id="nav-logout" class="hidden nav-item w-full text-left px-6 py-3 flex items-center group text-red-400 hover:text-red-500 mt-auto">
                <i class="fa-solid fa-right-from-bracket w-5 text-center transition-colors"></i>
                <span class="nav-text text-xs ml-3 uppercase tracking-widest">Log Out</span>
            </button>
        </nav>
        
        <!-- Footer -->
        <div class="p-4 bg-navy-dark border-t border-navy-light hidden md:block">
            <div class="flex items-center justify-between opacity-50 hover:opacity-100 transition">
                <div>
                    <div class="text-[9px] text-gray-500 uppercase tracking-widest font-bold">Version 10.0</div>
                    <div class="text-[9px] font-black text-orange mt-0.5 italic">Premium Dark</div>
                </div>
                <i class="fa-solid fa-wifi text-gray-600 text-xs"></i>
            </div>
        </div>
    </aside>

    <!-- CONTENT -->
    <main class="flex-1 flex flex-col bg-navy-dark w-full overflow-hidden relative">
        <!-- Desktop Header -->
        <header class="h-20 bg-navy-dark border-b border-navy-light px-8 hidden md:flex items-center justify-between flex-shrink-0 z-10">
            <div>
                <h2 id="page-title" class="text-2xl font-black italic uppercase tracking-tighter text-white">Overview</h2>
                <div class="h-1 w-12 bg-orange mt-1 rounded-full shadow-[0_0_10px_#FF6600]"></div>
            </div>
            <div class="flex items-center gap-6">
                <div class="text-right">
                    <div class="text-[9px] font-bold text-gray-500 uppercase tracking-widest">Connection</div>
                    <div class="font-bold text-orange text-xs glow" id="header-status">Checking...</div>
                </div>
                <div class="w-10 h-10 bg-navy border border-navy-light text-white rounded flex items-center justify-center font-black cursor-pointer hover:bg-orange hover:border-orange hover:text-white transition shadow-lg" onclick="app.nav('auth')" id="header-avatar">G</div>
            </div>
        </header>
        
        <!-- Mobile Page Title -->
        <div class="md:hidden bg-navy-dark border-b border-navy-light px-4 py-3 flex items-center justify-between flex-shrink-0 z-10">
            <h2 id="mobile-page-title" class="text-sm font-black italic text-white uppercase tracking-wider">Dashboard</h2>
        </div>

        <!-- Scrollable Content -->
        <div id="app-container" class="flex-1 overflow-hidden relative bg-navy-dark"></div>
        <div id="toast-container" class="fixed bottom-6 right-6 flex flex-col gap-3 z-[6000]"></div>
    </main>

    <!-- APP LOGIC -->
    <script>
        // --- SUPABASE & CONFIG ---
        const SUPABASE_URL = 'https://rmbsxccrwrktbjlnezpu.supabase.co'; 
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJtYnN4Y2Nyd3JrdGJqbG5lenB1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDg2MjczNjQsImV4cCI6MjA2NDIwMzM2NH0.ydCqificftdtn1niRciFCifeuo8aX6SDGti-hCY5Z_Y';
        
        let sb = null;

        // --- UTILS ---
        const Toast = {
            show(msg, type = 'info') {
                const container = document.getElementById('toast-container');
                const div = document.createElement('div');
                div.className = 'toast';
                div.style.borderLeftColor = type === 'success' ? '#10B981' : (type === 'error' ? '#EF4444' : '#FF6600');
                const icon = type === 'success' ? '<i class="fa-solid fa-check-circle text-green-500"></i>' : (type === 'error' ? '<i class="fa-solid fa-circle-exclamation text-red-500"></i>' : '<i class="fa-solid fa-info-circle text-orange"></i>');
                div.innerHTML = `${icon} <span class="text-xs font-bold text-white uppercase tracking-widest">${msg}</span>`;
                container.appendChild(div);
                setTimeout(() => { div.style.opacity = '0'; div.style.transform = 'translateX(100%)'; setTimeout(() => div.remove(), 300); }, 3000);
            }
        };

        const Crypto = {
            async hash(str) {
                const msgBuffer = new TextEncoder().encode(str);
                const hashBuffer = await crypto.subtle.digest('SHA-256', msgBuffer);
                const hashArray = Array.from(new Uint8Array(hashBuffer));
                return hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
            }
        };

        const toOneD = (url) => {
            if (!url) return "";
            if (url.includes('1drv.ms') || url.includes('sharepoint.com') || url.includes('live.com')) {
                let cleanUrl = url.replace(/[?&]action=[^&]+/, '');
                return cleanUrl.includes('?') ? `${cleanUrl}&action=embedview` : `${cleanUrl}?action=embedview`;
            }
            return url;
        };

        // --- DATA ---
        const mediaPath = 'CbapMedia/';
        const videoMapping = {
            // Updated video link to use basic 'watch' format to ensure getEmbedLink parses correctly and strips parameters
            'INTRO': [{ title: "INTRODUCTION", url: "https://www.youtube.com/watch?v=-T7mQzxs4TM" }, { title: "Key Concepts", url: "https://www.youtube.com/watch?v=cVsGlP-DYPs" }],
            'BACCM': [{ title: "BACCM Overview", url: "https://1drv.ms/v/c/0ad9a5e369cb0bf2/IQQ1a9VaUUkIRazjdZLFgYDIAVP2QdsYXuehLzmyx9_igWc" }, { title: "Key Concepts", url: "https://www.youtube.com/watch?v=cVsGlP-DYPs" }],
            'BAPM': 'https://www.youtube.com/watch?v=ddo6gKe7Jhw&list=PLcsVLaGLO5v_5efVhsT7GmT-Ms3whvA5x&index=3',
            'ELIC': 'https://www.youtube.com/watch?v=nZB3e-yGSxk&list=PLcsVLaGLO5v_5efVhsT7GmT-Ms3whvA5x&index=8',
            'RLCM': 'https://www.youtube.com/watch?v=0zXvWPHzIZg&list=PLcsVLaGLO5v_5efVhsT7GmT-Ms3whvA5x&index=13',
            'SA': 'https://www.youtube.com/watch?v=0I10KLv79iY&list=PLcsVLaGLO5v_5efVhsT7GmT-Ms3whvA5x&index=19'
        };
        const textbookVnMapping = {
            'INTRO': 'https://1drv.ms/w/c/0ad9a5e369cb0bf2/IQTQDwN3GdgHQqDhojduHJRsATyqTG9UOzZYZkyDBtlxso4?action=embedview',
            'BACCM': 'https://1drv.ms/w/c/0ad9a5e369cb0bf2/IQTnsQnfHHmZQaI324IdGNKYAXFMal7wq-4LN4YkivPsU5I?action=embedview',
            'BAPM': 'https://1drv.ms/w/c/0ad9a5e369cb0bf2/IQQyec-WxF2QQqqKg0L3EakaAdnFJhshHi56Wwl6xZYzjUI?action=embedview',
            'ELIC': 'https://1drv.ms/w/c/0ad9a5e369cb0bf2/IQT9Xa3vYrIMTKHojgeZ3_onATTlY2EvFtxnCXICszi6wZ8?action=embedview',
            'RLCM': 'https://1drv.ms/w/c/0ad9a5e369cb0bf2/IQT5bGx0GlPvQ5A6WERHbW40AR3Prw4qYyJCpenwEpkcdT8?action=embedview',
            'SA': 'https://1drv.ms/w/c/0ad9a5e369cb0bf2/IQQ4-lqNpR5ZT5sbjFLIC66IAb2iBwSNGI4GIG8AZNLKTj4?action=embedview',
            'RADD': 'https://1drv.ms/w/c/0ad9a5e369cb0bf2/IQSvpv0sT-rrRL5rTXRfQw2JAeu93keX0xFg9jmJD_BxrZc?action=embedview',
            'SE': 'https://1drv.ms/w/c/0ad9a5e369cb0bf2/IQRbApyX5bAjRpHut2RsLXAvAVY9vzs-zZtx-mmT4q9EYXQ?action=embedview',
            'COMP': 'https://1drv.ms/w/c/0ad9a5e369cb0bf2/IQShGQ7gAWTxSpP3hn09SBd1AeCnQvu69EJwvzI1LmXV8Bo?action=embedview',
            'TECH': 'https://1drv.ms/w/c/0ad9a5e369cb0bf2/IQSrHgODW-PMTJ9QodzBaE8IAb7ufvTHLv-ab3TnbsES8fg?action=embedview',
            'PERSP': 'https://1drv.ms/w/c/0ad9a5e369cb0bf2/IQSpCGYUGP2XRan5GbFjulXBAQZQ9a132pm2Z3cb8zKIgRc?action=embedview'
        };
        const textbookEnMapping = { 'INTRO': 'https://1drv.ms/w/c/0ad9a5e369cb0bf2/IQTQDwN3GdgHQqDhojduHJRsATyqTG9UOzZYZkyDBtlxso4?action=embedview' };
        const resourceMapping = { 'BACCM': { slides: [{ title: "Part 1", url: `${mediaPath}BACCM_Slide_1.pdf` }, { title: "Part 2", url: `${mediaPath}BACCM_Slide_2.pdf` }], mindmaps: [{ title: "Concept Map", url: `${mediaPath}BACCM_Mindmap_1.png` }], info: [{ title: "Info 1", url: `${mediaPath}BACCM_Info_1.png` }] } };

        // --- DATABASE ---
        const DB = {
            key: 'CBAP_V10_DARK_DATA',
            state: { 
                user: { id: null, username: 'Guest', loggedIn: false }, 
                lastView: { code: 'INTRO', type: 'slide' },
                curriculum: [
                    { code: 'INTRO', name: '01. Introduction & Key Concepts', desc: 'Structure of the BABOK Guide.' },
                    { code: 'BACCM', name: '02. BA Core Concept Model', desc: 'Conceptual framework for BA.' },
                    { code: 'BAPM', name: '03. Planning & Monitoring', desc: 'Organizing BA efforts.' },
                    { code: 'ELIC', name: '04. Elicitation & Collaboration', desc: 'Working with stakeholders.' },
                    { code: 'RLCM', name: '05. Req. Life Cycle Mgmt', desc: 'Managing requirements.' },
                    { code: 'SA', name: '06. Strategy Analysis', desc: 'Identifying business need.' },
                    { code: 'RADD', name: '07. RADD (Design Definition)', desc: 'Specifying requirements.' },
                    { code: 'SE', name: '08. Solution Evaluation', desc: 'Assessing value.' },
                    { code: 'COMP', name: '09. Underlying Competencies', desc: 'Behaviors and knowledge.' },
                    { code: 'TECH', name: '10. Techniques', desc: 'Standard techniques.' },
                    { code: 'PERSP', name: '11. Perspectives', desc: 'Agile, BI, IT, Architecture.' }
                ],
                questions: [], flashcards: [], completedTasks: []
            },
            
            async init() {
                if (typeof supabase !== 'undefined') {
                    try { sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY); } catch (e) { console.warn("Supabase init failed", e); }
                }
                const stored = localStorage.getItem(this.key);
                if (stored) {
                    try {
                        const parsed = JSON.parse(stored);
                        this.state.completedTasks = parsed.completedTasks || [];
                        this.state.lastView = parsed.lastView || { code: 'INTRO', type: 'slide' };
                        this.state.user = parsed.user || { id: null, username: 'Guest', loggedIn: false };
                    } catch(e) { console.error("Load error", e); }
                }
                await this.fetchLocalData();
                this.ensureDataIntegrity();
                if (this.state.user.loggedIn && sb) await this.pullFromCloud();
                this.save();
                return true;
            },

            async fetchLocalData() {
                const files = ['questions.json', 'flashcards.json'];
                for (let file of files) {
                    try {
                        const res = await fetch(`${file}?t=${Date.now()}`);
                        if (res.ok) {
                            const data = await res.json();
                            if(Array.isArray(data) && data.length > 0) this.state[file.replace('.json', '')] = data;
                        }
                    } catch (e) { }
                }
            },

            ensureDataIntegrity() {
                this.state.curriculum.forEach((c) => {
                    if(!c.tasks || c.tasks.length === 0) {
                        c.tasks = Array(5).fill(0).map((_, i) => ({ id: `${c.code}_T${i+1}`, name: `${c.name} - Topic ${i+1}` }));
                    }
                });
                if(!this.state.questions || this.state.questions.length === 0) {
                     this.state.questions = Array(20).fill(0).map((_, i) => ({
                        id: `Q${i+1}`, ka: 'BAPM', 
                        stem: `Sample Question ${i+1}: What is the primary output of Plan Business Analysis Information Management?`, 
                        options: ["Information Management Approach", "BA Performance Assessment", "Governance Approach", "Stakeholder Engagement Plan"], 
                        correct: [0], explanation: "The Information Management Approach defines how BA information will be stored and accessed."
                    }));
                }
                if(!this.state.flashcards || this.state.flashcards.length === 0) {
                    this.state.flashcards = Array(10).fill(0).map((_, i) => ({
                        front: `Term ${i+1}`, back: `Definition for term ${i+1}. A key concept in BABOK guide.`
                    }));
                }
            },

            save() {
                localStorage.setItem(this.key, JSON.stringify({
                    completedTasks: this.state.completedTasks, lastView: this.state.lastView, user: this.state.user
                }));
            },

            async pushToCloud() {
                if (!this.state.user.id || !sb) return;
                await sb.from('user_progress').upsert({ user_id: this.state.user.id, data: { completedTasks: this.state.completedTasks }, updated_at: new Date() });
            },

            async pullFromCloud() {
                if (!this.state.user.id || !sb) return;
                const { data } = await sb.from('user_progress').select('data').eq('user_id', this.state.user.id).single();
                if (data && data.data) { this.state.completedTasks = data.data.completedTasks || []; this.save(); }
            },

            toggleTask(taskId) {
                const idx = this.state.completedTasks.indexOf(taskId);
                if (idx > -1) this.state.completedTasks.splice(idx, 1);
                else this.state.completedTasks.push(taskId);
                this.save();
                if(this.state.user.loggedIn) this.pushToCloud();
                return this.state.completedTasks.includes(taskId); 
            },
            setLastView(code, type) { this.state.lastView = { code, type }; this.save(); }
        };

        const Auth = {
            async login(username, password) {
                if(!sb) return { error: "Cloud service unavailable" };
                const hashed = await Crypto.hash(password);
                const { data, error } = await sb.from('custom_users').select('*').eq('username', username).eq('password', hashed).single();
                if (error || !data) return { error: "Invalid username or password" };
                DB.state.user = { id: data.id, username: data.username, loggedIn: true };
                await DB.pullFromCloud(); DB.save(); app.updateUserUI();
                return { success: true };
            },
            async register(username, password) {
                if(!sb) return { error: "Cloud service unavailable" };
                const hashed = await Crypto.hash(password);
                const { data: existing } = await sb.from('custom_users').select('id').eq('username', username).single();
                if (existing) return { error: "Username already taken" };
                const { data, error } = await sb.from('custom_users').insert([{ username, password: hashed }]).select().single();
                if (error) return { error: error.message };
                DB.state.user = { id: data.id, username: data.username, loggedIn: true };
                await sb.from('user_progress').insert({ user_id: data.id, data: { completedTasks: [] } });
                DB.save(); app.updateUserUI();
                return { success: true };
            },
            logout() {
                DB.state.user = { id: null, username: 'Guest', loggedIn: false };
                DB.state.completedTasks = []; DB.save(); app.updateUserUI(); app.nav('auth');
            }
        };

        // --- APP CONTROLLER ---
        const app = {
            isSidebarOpen: false, zoomLevel: 1, selectedSubResource: null,
            flashcardIndex: 0, flashcardFlipped: false,
            // Thêm trạng thái cho Sidebar của Library
            librarySidebarOpen: true,
            examState: { active: false, current: 0, answers: {} },

            async start() {
                await DB.init();
                document.getElementById('loading-overlay').style.display = 'none';
                this.updateUserUI();
                this.nav('dashboard');
            },
            emergencyEnter() { document.getElementById('loading-overlay').style.display = 'none'; this.nav('dashboard'); },

            updateUserUI() {
                const user = DB.state.user;
                const status = user.loggedIn ? (sb ? 'Online • Synced' : 'Local (No Cloud)') : 'Local Mode';
                document.getElementById('header-status').innerText = status;
                const username = user && user.username ? user.username : 'Guest';
                document.getElementById('sidebar-username').innerText = username;
                const initial = username.charAt(0).toUpperCase();
                document.getElementById('sidebar-avatar').innerText = initial;
                document.getElementById('header-avatar').innerText = initial;
                document.getElementById('mobile-user-avatar').innerText = initial;

                // Toggle visibility of Log Out button
                const logoutBtn = document.getElementById('nav-logout');
                if (logoutBtn) {
                    if (user.loggedIn) {
                        logoutBtn.classList.remove('hidden');
                        logoutBtn.classList.add('flex');
                    } else {
                        logoutBtn.classList.add('hidden');
                        logoutBtn.classList.remove('flex');
                    }
                }
            },

            toggleSidebar() {
                const sb = document.getElementById('sidebar');
                const overlay = document.getElementById('mobile-overlay');
                this.isSidebarOpen = !this.isSidebarOpen;
                if (this.isSidebarOpen) { sb.classList.remove('-translate-x-full'); overlay.classList.remove('hidden'); }
                else { sb.classList.add('-translate-x-full'); overlay.classList.add('hidden'); }
            },

            viewModule(code) { this.nav('task_detail', { code: code }); },

            nav(view, params) {
                if(window.innerWidth < 768 && this.isSidebarOpen) this.toggleSidebar();
                document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
                const btn = document.getElementById(`nav-${view}`);
                if(btn) btn.classList.add('active');

                if (view === 'library' && params) DB.setLastView(params.code, params.type);

                const titles = { dashboard: 'Dashboard', learn: 'Knowledge Hub', library: 'Study Library', exam: 'Exam Engine', flashcards: 'Flashcards', admin: 'Settings', auth: 'Login', task_detail: 'Topic Details' };
                document.getElementById('page-title').innerText = titles[view] || 'CBAP Pro';
                const mt = document.getElementById('mobile-page-title');
                if(mt) mt.innerText = titles[view] || 'CBAP Pro';
                
                const container = document.getElementById('app-container');
                container.innerHTML = '';
                try {
                    switch(view) {
                        case 'dashboard': this.renderDashboard(container); break;
                        case 'library': this.renderLibrary(container, params); break;
                        case 'learn': this.renderLearn(container); break;
                        case 'task_detail': this.renderTaskDetail(container, params); break;
                        case 'exam': this.renderExam(container); break;
                        case 'flashcards': this.renderFlashcards(container); break;
                        case 'admin': this.renderAdmin(container); break;
                        case 'auth': this.renderAuth(container); break;
                    }
                } catch(e) { console.error(e); container.innerHTML = `<div class="p-10 text-center text-red-500">Error: ${e.message}</div>`; }
            },

            // --- DASHBOARD (DARK) ---
            renderDashboard(container) {
                const curriculum = DB.state.curriculum || [];
                const kaCodes = ['BAPM', 'ELIC', 'RLCM', 'SA', 'RADD', 'SE'];
                let totalTasks = 0, totalCompleted = 0;
                
                const progressData = curriculum.map(c => {
                    const tCount = (c.tasks||[]).length;
                    const cCount = (c.tasks||[]).filter(t => DB.state.completedTasks.includes(t.id)).length;
                    totalTasks += tCount; totalCompleted += cCount;
                    return { ...c, percent: tCount > 0 ? Math.round((cCount / tCount) * 100) : 0 };
                });

                const overallPercent = totalTasks > 0 ? Math.round((totalCompleted / totalTasks) * 100) : 0;
                const chartValues = kaCodes.map(code => (progressData.find(p => p.code === code) || {percent:0}).percent);
                const lastView = DB.state.lastView || { code: 'INTRO', type: 'slide' };

                container.innerHTML = `
                    <div class="p-6 md:p-8 space-y-6 overflow-y-auto h-full custom-scrollbar view-fade">
                        <!-- Welcome Card (Navy) -->
                        <div class="bg-navy rounded-lg shadow-lg p-6 border border-navy-light relative overflow-hidden group">
                             <div class="relative z-10">
                                <h3 class="text-[10px] font-bold text-orange uppercase tracking-widest mb-2">My Dashboard</h3>
                                <h1 class="text-3xl font-black italic text-white mb-2">Hello, <span class="text-gray-300">${DB.state.user.username || 'Student'}</span></h1>
                                <p class="text-gray-400 text-sm mb-6 max-w-lg">
                                    Last viewed: <strong class="text-white">${lastView.code}</strong> (${lastView.type}).
                                </p>
                                <button onclick="app.nav('library', {code: '${lastView.code}', type: '${lastView.type}'})" class="bg-orange text-white px-6 py-3 rounded text-[10px] font-bold uppercase tracking-widest hover:bg-white hover:text-orange transition shadow-lg">
                                    Resume Session <i class="fa-solid fa-arrow-right ml-1"></i>
                                </button>
                            </div>
                            <div class="absolute right-0 bottom-0 opacity-5 group-hover:opacity-10 transition-opacity text-9xl text-white transform translate-x-10 translate-y-10">
                                <i class="fa-solid fa-chart-line"></i>
                            </div>
                        </div>

                        <!-- Shortcuts (Dark Cards) -->
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                            <button onclick="app.nav('learn')" class="bg-navy p-4 rounded-lg shadow-md border border-navy-light hover:border-orange transition text-left group flex items-center gap-3">
                                <!-- Đã bỏ border cho Icon -->
                                <div class="w-10 h-10 rounded bg-navy-dark text-orange group-hover:bg-orange group-hover:text-white transition flex items-center justify-center"><i class="fa-solid fa-graduation-cap"></i></div>
                                <div><div class="font-bold text-white text-xs uppercase tracking-wider">Knowledge</div><div class="text-[9px] text-gray-500 font-bold">Track Tasks</div></div>
                            </button>
                            <button onclick="app.nav('library')" class="bg-navy p-4 rounded-lg shadow-md border border-navy-light hover:border-orange transition text-left group flex items-center gap-3">
                                <div class="w-10 h-10 rounded bg-navy-dark text-orange group-hover:bg-orange group-hover:text-white transition flex items-center justify-center"><i class="fa-solid fa-book-open"></i></div>
                                <div><div class="font-bold text-white text-xs uppercase tracking-wider">Library</div><div class="text-[9px] text-gray-500 font-bold">Books & Slides</div></div>
                            </button>
                            <button onclick="app.nav('exam')" class="bg-navy p-4 rounded-lg shadow-md border border-navy-light hover:border-orange transition text-left group flex items-center gap-3">
                                <div class="w-10 h-10 rounded bg-navy-dark text-orange group-hover:bg-orange group-hover:text-white transition flex items-center justify-center"><i class="fa-solid fa-pen-to-square"></i></div>
                                <div><div class="font-bold text-white text-xs uppercase tracking-wider">Exam Sim</div><div class="text-[9px] text-gray-500 font-bold">Practice Quiz</div></div>
                            </button>
                            <button onclick="app.nav('flashcards')" class="bg-navy p-4 rounded-lg shadow-md border border-navy-light hover:border-orange transition text-left group flex items-center gap-3">
                                <div class="w-10 h-10 rounded bg-navy-dark text-orange group-hover:bg-orange group-hover:text-white transition flex items-center justify-center"><i class="fa-solid fa-bolt"></i></div>
                                <div><div class="font-bold text-white text-xs uppercase tracking-wider">Flashcards</div><div class="text-[9px] text-gray-500 font-bold">Memory Aid</div></div>
                            </button>
                        </div>

                        <!-- Stats (Dark) -->
                        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                            <div class="bg-navy p-6 rounded-lg shadow-md border border-navy-light lg:col-span-2">
                                <h3 class="text-[10px] font-bold text-gray-500 uppercase tracking-widest mb-4">Skill Radar</h3>
                                <div class="h-64 relative flex items-center justify-center" id="chart-container">
                                    <canvas id="proficiencyChart"></canvas>
                                </div>
                            </div>
                            <div class="bg-navy p-6 rounded-lg shadow-md border border-navy-light flex flex-col">
                                <h3 class="text-[10px] font-bold text-gray-500 uppercase tracking-widest mb-4">Total Progress</h3>
                                <div class="flex items-center gap-3 mb-6">
                                    <div class="text-4xl font-black italic text-white">${overallPercent}%</div>
                                    <div class="flex-1">
                                        <div class="h-2 bg-navy-dark border border-navy-light rounded-full overflow-hidden">
                                            <div class="h-full bg-orange shadow-[0_0_10px_#FF6600]" style="width: ${overallPercent}%"></div>
                                        </div>
                                        <div class="text-[9px] text-gray-500 mt-2 uppercase font-bold tracking-wider">${totalCompleted} / ${totalTasks} Tasks Done</div>
                                    </div>
                                </div>
                                <div class="flex-1 overflow-y-auto space-y-4 pr-2 custom-scrollbar max-h-60">
                                    ${progressData.map(p => `
                                        <div>
                                            <div class="flex justify-between text-[10px] font-bold text-gray-300 mb-1"><span>${p.code}</span><span class="${p.percent === 100 ? 'text-green-400' : 'text-orange'}">${p.percent}%</span></div>
                                            <div class="w-full bg-navy-dark border border-navy-light h-1.5 rounded-full overflow-hidden"><div class="bg-gray-500 h-full transition-all duration-1000" style="width: ${p.percent}%"></div></div>
                                        </div>`).join('')}
                                </div>
                            </div>
                        </div>
                    </div>`;

                setTimeout(() => {
                    const ctx = document.getElementById('proficiencyChart');
                    if(ctx && typeof Chart !== 'undefined') {
                        new Chart(ctx, {
                            type: 'radar',
                            data: { labels: kaCodes, datasets: [{ label: 'Score', data: chartValues, backgroundColor: 'rgba(255, 102, 0, 0.2)', borderColor: '#FF6600', pointBackgroundColor: '#001a33', pointBorderColor: '#fff', borderWidth: 2 }] },
                            options: { 
                                responsive: true, maintainAspectRatio: false, 
                                scales: { r: { angleLines: { color: '#004080' }, grid: { color: '#004080' }, pointLabels: { font: { size: 10, weight: 'bold' }, color: '#9CA3AF' }, ticks: { display: false, backdropColor: 'transparent' } } }, 
                                plugins: { legend: { display: false } } 
                            } 
                        });
                    }
                }, 500);
            },

            // --- LEARN (Dark) ---
            renderLearn(container) {
                const curriculum = DB.state.curriculum || [];
                container.innerHTML = `
                    <div class="p-6 md:p-8 overflow-y-auto h-full view-fade">
                        <h2 class="text-3xl font-black italic text-white mb-8">Knowledge Hub</h2>
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                            ${curriculum.map((c, i) => {
                                const tasks = c.tasks || [];
                                const done = tasks.filter(t => DB.state.completedTasks.includes(t.id)).length;
                                const percent = tasks.length > 0 ? Math.round((done/tasks.length)*100) : 0;
                                return `
                                <div class="bg-navy p-6 rounded-lg shadow-md border border-navy-light hover:border-orange hover:shadow-[0_0_15px_rgba(255,102,0,0.1)] transition group flex flex-col h-full cursor-pointer" onclick="app.viewModule('${c.code}')">
                                    <div class="flex justify-between items-start mb-4">
                                        <span class="text-4xl font-black text-navy-dark text-outline group-hover:text-orange/20 transition">${(i+1).toString().padStart(2,'0')}</span>
                                        <!-- Đã bỏ border quanh Code (INTRO, BACCM...) -->
                                        <span class="bg-navy-dark text-orange text-[9px] font-bold px-2 py-1 uppercase tracking-widest rounded">${c.code}</span>
                                    </div>
                                    <h3 class="text-lg font-bold text-white mb-2 group-hover:text-orange transition tracking-tight">${c.name}</h3>
                                    <div class="w-full bg-navy-dark border border-navy-light h-1.5 rounded-full overflow-hidden mb-3">
                                        <div class="bg-orange h-full shadow-[0_0_5px_#FF6600]" style="width: ${percent}%"></div>
                                    </div>
                                    <div class="text-[10px] text-gray-400 mb-6 uppercase tracking-wider font-bold">${done}/${tasks.length} Completed</div>
                                    <div class="mt-auto">
                                        <!-- Đã bỏ border quanh nút View Details -->
                                        <button class="w-full bg-navy-dark text-gray-300 py-3 rounded text-[10px] font-bold uppercase tracking-widest group-hover:bg-orange group-hover:text-white transition">View Details</button>
                                    </div>
                                </div>`;
                            }).join('')}
                        </div>
                    </div>`;
            },

            renderTaskDetail(container, params) {
                const item = DB.state.curriculum.find(c => c.code === params.code);
                if(!item) { container.innerHTML = '<div class="p-8 text-white">Module not found</div>'; return; }
                const tasks = item.tasks || [];
                const doneCount = tasks.filter(t => DB.state.completedTasks.includes(t.id)).length;
                const percent = tasks.length > 0 ? Math.round((doneCount/tasks.length)*100) : 0;

                container.innerHTML = `
                    <div class="p-6 md:p-8 max-w-4xl mx-auto h-full overflow-y-auto custom-scrollbar view-fade">
                        <div class="flex justify-between items-center mb-6">
                            <button onclick="app.nav('learn')" class="text-xs font-bold text-gray-500 uppercase tracking-widest hover:text-orange flex items-center gap-2 transition">
                                <i class="fa-solid fa-arrow-left"></i> Back
                            </button>
                            <button onclick="app.nav('library', {code:'${params.code}', type:'textbookvn'})" class="bg-navy-dark border border-navy-light text-gray-300 px-5 py-2 rounded text-[10px] font-bold uppercase tracking-widest hover:bg-orange hover:text-white hover:border-orange transition flex items-center gap-2 shadow-md">
                                <i class="fa-solid fa-book-open"></i> Read Textbook
                            </button>
                        </div>
                        <div class="bg-navy rounded-lg shadow-lg border border-navy-light overflow-hidden mb-6">
                            <div class="p-8 border-b border-navy-light bg-navy-dark/50 flex flex-col md:flex-row md:items-center justify-between gap-4">
                                <div><div class="text-[10px] font-bold text-orange uppercase tracking-[0.2em] mb-1">Module Detail</div><h1 class="text-2xl font-black italic text-white">${item.name}</h1></div>
                                <div class="text-right"><div class="text-4xl font-black italic text-white">${percent}%</div><div class="text-[9px] text-gray-500 uppercase font-bold tracking-widest">Completed</div></div>
                            </div>
                            <div class="p-0">
                                ${tasks.map((t, idx) => {
                                    const isDone = DB.state.completedTasks.includes(t.id);
                                    return `
                                        <div class="flex items-center justify-between p-5 border-b border-navy-light hover:bg-navy-dark transition group">
                                            <div class="flex items-center gap-5">
                                                <div class="w-8 h-8 rounded flex items-center justify-center text-xs font-bold ${isDone ? 'bg-green-900/30 text-green-500 border border-green-800' : 'bg-navy-dark text-gray-500 border border-navy-light'}">${idx + 1}</div>
                                                <div><div class="text-sm font-bold ${isDone ? 'text-gray-500 line-through' : 'text-white'}">${t.name}</div><div class="text-[9px] text-gray-600 font-mono mt-1">${t.id}</div></div>
                                            </div>
                                            <button onclick="app.toggleTaskState('${t.id}', '${params.code}')" class="px-4 py-2 rounded text-[9px] font-bold uppercase tracking-widest border transition flex items-center gap-2 ${isDone ? 'bg-green-900/20 text-green-500 border-green-800 hover:bg-red-900/20 hover:text-red-500 hover:border-red-800' : 'bg-navy-dark text-gray-400 border-navy-light hover:border-orange hover:text-orange'}">
                                                ${isDone ? '<span>Done</span> <i class="fa-solid fa-check"></i>' : '<span>Mark as Done</span>'}
                                            </button>
                                        </div>`;
                                }).join('')}
                            </div>
                        </div>
                    </div>`;
            },
            toggleTaskState(taskId, code) { const newState = DB.toggleTask(taskId); this.renderTaskDetail(document.getElementById('app-container'), { code: code }); Toast.show(newState ? "Task Completed" : "Task Unmarked", newState ? 'success' : 'info'); },

            // --- LIBRARY (Dark) ---
            renderLibrary(container, params) {
                const code = params?.code || DB.state.lastView.code || 'INTRO';
                const type = params?.type || 'textbookvn';
                const vMap = videoMapping||{}, vnMap = textbookVnMapping||{}, enMap = textbookEnMapping||{}, resMap = resourceMapping||{};
                let list = [], currentItem = this.selectedSubResource;
                
                // --- UPDATE: Helper xử lý link Youtube (Logic trích xuất ID chuẩn) ---
                const getEmbedLink = (url) => {
                    if (!url) return '';
                    let videoId = null;
                    
                    // Regex tìm ID từ mọi định dạng (watch?v=, embed/, youtu.be/)
                    // Quan trọng: Nó sẽ bỏ qua phần tham số sau dấu ? (như ?si=...)
                    const regExp = /^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|\&v=)([^#\&\?]*).*/;
                    const match = url.match(regExp);

                    if (match && match[2].length === 11) {
                        videoId = match[2];
                        return `https://www.youtube.com/embed/${videoId}`;
                    }
                    
                    // Nếu không phải link Youtube chuẩn, trả về nguyên gốc (ví dụ link OneDrive)
                    return url;
                };

                // Xử lý danh sách cho cả Video để hiển thị Sidebar chọn bài
                if (type === 'slide') list = (resMap[code]?.slides) || [];
                else if (type === 'mindmap') list = (resMap[code]?.mindmaps) || [];
                else if (type === 'info') list = (resMap[code]?.info) || [];
                
                // Chuẩn bị danh sách Video từ cấu hình
                let videoList = [];
                if (type === 'video') {
                    const raw = vMap[code];
                    if (Array.isArray(raw)) {
                        videoList = raw;
                    } else if (typeof raw === 'string' && raw.trim() !== '') {
                        videoList = [{ title: 'Main Video', url: raw }];
                    }
                }

                // Chọn item mặc định
                if (list.length > 0 && (!currentItem || !list.find(i => i.url === currentItem.url))) currentItem = list[0];

                const loader = `<div id="content-loader" class="absolute inset-0 flex flex-col items-center justify-center bg-navy-dark z-0"><div class="spinner mb-2"></div><span class="text-[10px] text-gray-500 font-bold tracking-widest uppercase">Loading Content...</span></div>`;
                let viewerHtml = `<div class="flex items-center justify-center h-full text-gray-500 font-bold uppercase tracking-widest text-xs">Content not available</div>`;

                if (type === 'textbookvn' || type === 'textbookEN') {
                    let rawUrl = (type === 'textbookvn') ? (vnMap[code] || vnMap['INTRO']) : (enMap[code] || enMap['INTRO']);
                    if (rawUrl) viewerHtml = `<div class="relative w-full h-full bg-gray-200">${loader}<iframe src="${toOneD(rawUrl)}" class="absolute inset-0 w-full h-full border-none z-10" onload="this.parentElement.querySelector('#content-loader')?.remove()"></iframe></div>`;
                } 
                // --- CẬP NHẬT GIAO DIỆN VIDEO (GIỐNG FILE MẪU KA.TXT) ---
                else if (type === 'video') {
                    if (videoList.length > 0) {
                        viewerHtml = `<div class="h-full w-full overflow-y-auto bg-navy-dark p-4 md:p-8 space-y-8 custom-scrollbar">`;
                        
                        videoList.forEach((v, index) => {
                            // Bước 1: Lấy link sạch (không còn ?si=...)
                            const embedUrl = getEmbedLink(v.url);
                            
                            if(embedUrl) {
                                viewerHtml += `
                                   <div class="max-w-4xl mx-auto bg-black border border-navy-light rounded-lg overflow-hidden shadow-2xl relative group">
                                        <div class="p-3 bg-navy border-b border-navy-light flex justify-between items-center z-20 relative">
                                            <h4 class="text-white text-xs font-bold uppercase tracking-widest flex items-center gap-2">
                                                <i class="fa-solid fa-play-circle text-orange"></i> ${v.title || `Video ${index + 1}`}
                                            </h4>
                                            <a href="${embedUrl}" target="_blank" class="text-[10px] text-gray-400 hover:text-white flex items-center gap-1 transition">
                                                <i class="fa-solid fa-arrow-up-right-from-square"></i> Open External
                                            </a>
                                        </div>
                                        <div class="relative w-full" style="padding-bottom: 56.25%;"> <!-- Tỉ lệ 16:9 -->
                                            <!-- FIX: Iframe tối giản, loại bỏ allow="accelerometer..." gây lỗi cấu hình -->
                                            <iframe src="${embedUrl}" 
                                                class="absolute top-0 left-0 w-full h-full border-none z-10 bg-black" 
                                                allowfullscreen>
                                            </iframe>
                                        </div>
                                   </div>
                                `;
                            }
                        });
                        viewerHtml += `</div>`;
                    } else {
                        viewerHtml = `<div class="flex flex-col items-center justify-center h-full text-gray-500 font-bold uppercase tracking-widest text-xs">No videos available for this module.</div>`;
                    }
                } 
                // --- END CẬP NHẬT VIDEO ---
                else if (currentItem) {
                    if (type === 'slide') viewerHtml = `<div class="relative w-full h-full bg-gray-200">${loader}<iframe src="${toOneD(currentItem.url)}" class="absolute inset-0 w-full h-full border-none z-10" onload="this.parentElement.querySelector('#content-loader')?.remove()"></iframe></div>`;
                    else viewerHtml = `<div class="relative w-full h-full bg-navy-dark overflow-hidden flex items-center justify-center">${loader}<img id="zoom-img" src="${currentItem.url}" class="max-w-full max-h-full shadow-lg transition-transform duration-200 z-10" style="transform: scale(${this.zoomLevel})" onload="this.parentElement.querySelector('#content-loader')?.remove()"></div>`;
                }

                // Xử lý ẩn/hiện sidebar
                const sidebarClass = this.librarySidebarOpen ? 'block' : 'hidden';

                // Nếu là Video thì không cần Sidebar file list (vì đã hiển thị list bên trong viewer)
                const showSubResourceSidebar = (type !== 'video' && list.length > 1) ? 'block' : 'hidden';

                container.innerHTML = `
                    <div class="flex h-full flex-col lg:flex-row border-t border-navy-light view-fade">
                        <!-- Module List (Sidebar) -->
                        <div id="lib-sidebar" class="${sidebarClass} w-full lg:w-64 bg-navy-dark border-r border-navy-light flex-shrink-0 flex flex-col h-48 lg:h-full lg:order-1 order-3 transition-all duration-300">
                            <div class="p-3 bg-navy border-b border-navy-light font-bold text-[9px] text-gray-500 uppercase tracking-[0.2em] sticky top-0">Modules</div>
                            <div class="flex-1 overflow-y-auto custom-scrollbar">
                                ${DB.state.curriculum.map(c => `
                                    <button onclick="app.nav('library', {code:'${c.code}'})" class="w-full text-left px-4 py-3 hover:bg-navy transition group ${c.code === code ? 'bg-navy border-l-4 border-l-orange' : ''}">
                                        <div class="flex justify-between items-center mb-1">
                                            <span class="text-xs font-bold uppercase tracking-wide ${c.code === code ? 'text-white' : 'text-gray-400'}">${c.code}</span>
                                        </div>
                                        <div class="text-[10px] truncate font-bold text-orange transition">${c.name}</div>
                                    </button>`).join('')}
                            </div>
                        </div>

                        <!-- Main Viewer -->
                        <div class="flex-1 flex flex-col h-full bg-navy relative lg:order-2 order-2 min-h-[400px]">
                            <!-- Toolbar -->
                            <div class="h-12 bg-navy-dark border-b border-navy-light flex items-center px-4 gap-2 overflow-x-auto custom-scrollbar">
                                <button onclick="app.toggleLibrarySidebar()" class="w-8 h-8 flex items-center justify-center text-orange border border-navy-light rounded hover:bg-navy hover:text-white transition mr-2" title="Toggle Modules">
                                    <i class="fa-solid fa-list text-xs"></i>
                                </button>

                                ${['textbookvn', 'textbookEN', 'slide', 'mindmap', 'info', 'video'].map(t => `<button onclick="app.nav('library', {code:'${code}', type:'${t}'})" class="px-3 py-1.5 rounded text-[9px] font-bold uppercase tracking-widest whitespace-nowrap transition border border-navy-light ${type === t ? 'bg-orange text-white border-orange' : 'text-gray-400 hover:bg-navy hover:text-white'}">${t==='textbookvn'?'Book VN':(t==='textbookEN'?'Book EN':t)}</button>`).join('')}
                                <div class="flex-1"></div>
                                ${['mindmap','info'].includes(type) ? `<button onclick="app.adjustZoom(-0.2)" class="w-7 h-7 flex items-center justify-center text-gray-400 border border-navy-light rounded hover:text-white"><i class="fa-solid fa-minus text-xs"></i></button><button onclick="app.adjustZoom(0.2)" class="w-7 h-7 flex items-center justify-center text-gray-400 border border-navy-light rounded hover:text-white"><i class="fa-solid fa-plus text-xs"></i></button>` : ''}
                                <button onclick="app.toggleFullscreen('app-container')" class="w-7 h-7 flex items-center justify-center text-gray-400 border border-navy-light rounded hover:text-white"><i class="fa-solid fa-expand text-xs"></i></button>
                            </div>
                            <div class="flex-1 relative overflow-hidden bg-black/20">${viewerHtml}</div>
                        </div>

                        <!-- File List (Sub-resource) -->
                        <div class="${showSubResourceSidebar} lg:block lg:order-3 h-full w-56 bg-navy-dark border-l border-navy-light flex-shrink-0 flex flex-col">
                             <div class="p-3 bg-navy border-b border-navy-light font-bold text-[9px] text-gray-500 uppercase tracking-[0.2em]">Files</div>
                             <div class="flex-1 overflow-y-auto custom-scrollbar">${list.map(item => `<button onclick="app.selectSubResource('${item.url}', '${item.title}')" class="w-full text-left px-4 py-3 border-b border-navy-light hover:bg-navy transition ${currentItem && currentItem.url === item.url ? 'bg-navy border-l-4 border-l-orange' : 'text-gray-500'}"><div class="text-[10px] font-bold ${currentItem && currentItem.url === item.url ? 'text-white' : ''}">${item.title}</div></button>`).join('')}</div>
                        </div>
                    </div>`;
            },
            
            // Hàm xử lý Toggle Sidebar
            toggleLibrarySidebar() {
                this.librarySidebarOpen = !this.librarySidebarOpen;
                const sidebar = document.getElementById('lib-sidebar');
                if (sidebar) {
                    if (this.librarySidebarOpen) {
                        sidebar.classList.remove('hidden');
                        sidebar.classList.add('block');
                    } else {
                        sidebar.classList.add('hidden');
                        sidebar.classList.remove('block');
                    }
                }
            },
            
            selectSubResource(url, title) { this.selectedSubResource = { url, title }; this.nav('library'); },
            adjustZoom(delta) { this.zoomLevel = Math.max(0.5, Math.min(3, this.zoomLevel + delta)); const img = document.getElementById('zoom-img'); if(img) img.style.transform = `scale(${this.zoomLevel})`; },
            toggleFullscreen(id) { const el = document.getElementById(id); if (!document.fullscreenElement) { el.requestFullscreen().catch(err => {}); } else { document.exitFullscreen(); } },

            // --- EXAM (Dark) ---
            renderExam(container) {
                if(!this.examState.active) {
                    const count = DB.state.questions.length;
                    container.innerHTML = `<div class="flex flex-col items-center justify-center h-full p-8 text-center bg-navy-dark view-fade"><div class="w-24 h-24 bg-navy border border-navy-light rounded-full flex items-center justify-center text-4xl text-orange mb-6 shadow-[0_0_20px_rgba(255,102,0,0.2)]"><i class="fa-solid fa-pen-to-square"></i></div><h2 class="text-3xl font-black italic text-white mb-2">Exam Simulator</h2><p class="text-gray-400 mb-8 max-w-md font-medium text-sm">Test your knowledge with ${count} practice questions.</p><button class="swiss-btn swiss-btn-primary px-10 py-4 shadow-lg text-sm" onclick="app.startExam()">Start Practice</button></div>`;
                } else {
                    const q = DB.state.questions[this.examState.current];
                    const userAns = this.examState.answers[q.id];
                    const isAnswered = userAns !== undefined;
                    container.innerHTML = `
                    <div class="max-w-3xl mx-auto p-4 md:p-8 view-fade">
                        <div class="flex justify-between items-center mb-6">
                            <div class="text-[10px] font-bold text-gray-500 uppercase tracking-[0.2em]">Question ${this.examState.current + 1}/${DB.state.questions.length}</div>
                            <button onclick="app.quitExam()" class="text-red-500 hover:text-red-400 font-bold text-[10px] uppercase border border-red-900/50 px-3 py-1 rounded bg-red-900/20 hover:bg-red-900/40">Exit Exam</button>
                        </div>
                        <div class="bg-navy p-6 md:p-10 rounded-lg shadow-lg border border-navy-light mb-8">
                            <h3 class="text-lg font-bold text-white mb-8 leading-relaxed">${q.stem}</h3>
                            <div class="space-y-4">
                                ${q.options.map((opt, i) => { 
                                    // Loại bỏ hoàn toàn các class liên quan đến border ở đây
                                    let cls = "hover:bg-navy-dark bg-navy-dark/30 text-gray-300"; 
                                    if(isAnswered) { 
                                        if(i === q.correct[0]) cls = "bg-green-900/40 text-green-400 font-bold shadow-[0_0_10px_rgba(16,185,129,0.2)]"; 
                                        else if(i === userAns) cls = "bg-red-900/40 text-red-400 font-bold"; 
                                        else cls = "opacity-40";
                                    } 
                                    // Bỏ class "border" ở div container
                                    return `<div onclick="${!isAnswered ? `app.answerExam(${i})` : ''}" class="p-4 rounded cursor-pointer transition flex items-center gap-4 ${cls}"><span class="font-bold border border-navy-light w-8 h-8 flex items-center justify-center rounded text-xs bg-navy text-white">${String.fromCharCode(65+i)}</span> ${opt}</div>`; 
                                }).join('')}
                            </div>
                            ${isAnswered ? `<div class="mt-8 p-5 bg-navy-dark text-gray-300 text-sm rounded border-l-4 border-orange"><strong>Explanation:</strong> ${q.explanation}</div>` : ''}
                        </div>
                        <div class="flex justify-between">
                            <button onclick="app.prevExam()" class="swiss-btn swiss-btn-outline px-6 py-3" ${this.examState.current===0 ? 'disabled':''}>Previous</button>
                            <button onclick="app.nextExam()" class="swiss-btn swiss-btn-primary px-6 py-3 shadow-lg" ${!isAnswered ? 'disabled opacity-50':''}>Next Question</button>
                        </div>
                    </div>`;
                }
            },
            startExam() { this.examState = { active: true, current: 0, answers: {}, score: 0 }; this.nav('exam'); },
            answerExam(idx) { const q = DB.state.questions[this.examState.current]; this.examState.answers[q.id] = idx; this.nav('exam'); },
            nextExam() { if(this.examState.current < DB.state.questions.length-1) { this.examState.current++; this.nav('exam'); } else { this.quitExam(); } },
            prevExam() { if(this.examState.current > 0) { this.examState.current--; this.nav('exam'); } },
            quitExam() { this.examState.active = false; this.nav('exam'); },

            // --- FLASHCARDS (Dark) ---
            renderFlashcards(container) {
                const total = DB.state.flashcards.length;
                const card = DB.state.flashcards[this.flashcardIndex];
                container.innerHTML = `
                    <div class="flex flex-col items-center justify-center h-full p-4 md:p-8 bg-navy-dark view-fade">
                        <div class="w-full max-w-xl mb-4 flex justify-between">
                            <span class="text-[10px] font-bold text-gray-500 uppercase tracking-widest">Card ${this.flashcardIndex + 1}/${total}</span>
                            <span class="text-[10px] font-bold text-orange uppercase tracking-widest">Active Recall</span>
                        </div>
                        
                        <!-- Flip Container with ID -->
                        <div id="flashcard-container" class="flip-container w-full max-w-xl aspect-[3/2] cursor-pointer group ${this.flashcardFlipped ? 'flipped' : ''}" onclick="app.flipCard()">
                            <div class="flip-inner shadow-2xl rounded-lg">
                                <!-- FRONT -->
                                <div class="flip-front p-8 text-center rounded-lg">
                                    <span class="text-[9px] font-bold text-gray-400 uppercase mb-6 tracking-[0.3em]">Concept</span>
                                    <h3 class="text-3xl font-black italic text-white leading-relaxed tracking-tight select-none">${card.front}</h3>
                                    <div class="mt-8 text-[10px] text-orange font-bold uppercase animate-pulse tracking-widest">Tap to Reveal</div>
                                </div>
                                <!-- BACK -->
                                <div class="flip-back p-8 text-center rounded-lg">
                                    <span class="text-[9px] font-bold text-gray-300 uppercase mb-6 tracking-[0.3em]">Definition</span>
                                    <!-- Ép màu trắng tuyệt đối cho text -->
                                    <h3 class="text-2xl font-bold text-white leading-relaxed select-none" style="color: #ffffff !important;">${card.back}</h3>
                                </div>
                            </div>
                        </div>

                        <div class="w-full max-w-xl flex gap-4 mt-8">
                            <button onclick="app.prevCard()" class="flex-1 py-3 border border-navy-light bg-navy text-gray-300 text-xs font-bold uppercase rounded hover:border-orange hover:text-orange transition tracking-widest">Prev</button>
                            <button onclick="app.nextCard()" class="flex-1 py-3 bg-orange text-white text-xs font-bold uppercase rounded shadow-lg hover:bg-orange-hover transition tracking-widest border border-orange">Next</button>
                        </div>
                    </div>`;
            },
            
            flipCard() { 
                // Chỉ toggle class CSS, không render lại HTML
                this.flashcardFlipped = !this.flashcardFlipped; 
                const container = document.getElementById('flashcard-container');
                if(container) {
                    if (this.flashcardFlipped) container.classList.add('flipped');
                    else container.classList.remove('flipped');
                }
            },
            
            nextCard() { if(this.flashcardIndex < DB.state.flashcards.length-1) { this.flashcardIndex++; this.flashcardFlipped = false; this.nav('flashcards'); } },
            prevCard() { if(this.flashcardIndex > 0) { this.flashcardIndex--; this.flashcardFlipped = false; this.nav('flashcards'); } },

            // --- AUTH & ADMIN (Dark) ---
            renderAuth(container) { container.innerHTML = `<div class="flex items-center justify-center h-full bg-navy-dark p-4 view-fade"><div class="w-full max-w-md bg-navy p-8 rounded-lg shadow-2xl border-t-4 border-orange relative"><div class="absolute top-0 right-0 p-4 opacity-10 text-white text-6xl"><i class="fa-solid fa-user-shield"></i></div><h2 class="text-2xl font-black italic text-white mb-8 text-center uppercase tracking-tight">System Access</h2><div class="space-y-5"><div><label class="block text-[10px] font-bold text-gray-400 uppercase mb-2 tracking-widest">Username</label><input type="text" id="login-user" class="w-full p-3 border border-navy-light rounded text-sm bg-navy-dark text-white focus:border-orange focus:outline-none placeholder-gray-600"></div><div><label class="block text-[10px] font-bold text-gray-400 uppercase mb-2 tracking-widest">Password</label><input type="password" id="login-pass" class="w-full p-3 border border-navy-light rounded text-sm bg-navy-dark text-white focus:border-orange focus:outline-none placeholder-gray-600"></div><button onclick="app.handleLogin()" class="w-full swiss-btn swiss-btn-primary py-3 mt-4">Log in</button><button onclick="app.handleRegister()" class="w-full swiss-btn swiss-btn-outline py-3 mt-2">Create New ID</button></div></div></div>`; },
            async handleLogin() { const u = document.getElementById('login-user').value; const p = document.getElementById('login-pass').value; if(u&&p) { const res = await Auth.login(u,p); if(res.error) Toast.show(res.error,'error'); else { Toast.show('Authenticated','success'); this.nav('dashboard'); } } },
            async handleRegister() { const u = document.getElementById('login-user').value; const p = document.getElementById('login-pass').value; if(u&&p) { const res = await Auth.register(u,p); if(res.error) Toast.show(res.error,'error'); else { Toast.show('ID Created','success'); this.nav('dashboard'); } } },
            renderAdmin(container) { container.innerHTML = `<div class="p-8 max-w-2xl mx-auto view-fade"><h2 class="text-2xl font-black italic text-white mb-6 uppercase">System Settings</h2><div class="bg-navy p-6 rounded-lg shadow-md border border-navy-light"><h3 class="text-[10px] font-bold text-orange uppercase tracking-widest mb-6">Data Management</h3><div class="p-8 border-2 border-dashed border-navy-light rounded bg-navy-dark/50 text-center cursor-pointer hover:border-orange hover:bg-navy-dark transition group"><i class="fa-solid fa-cloud-arrow-up text-gray-500 mb-3 text-2xl group-hover:text-white transition"></i><div class="text-xs font-bold text-gray-300 group-hover:text-white uppercase tracking-wider">Import Curriculum.json</div></div></div></div>`; }
        };

        document.addEventListener('DOMContentLoaded', () => app.start());
    </script>
    <style>
        .backface-hidden { -webkit-backface-visibility: hidden; backface-visibility: hidden; }
        .text-outline { -webkit-text-stroke: 1px rgba(255, 255, 255, 0.1); color: transparent; }
        .glow { text-shadow: 0 0 5px currentColor; }
    </style>
</body>
</html>
