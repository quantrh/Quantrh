<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CBAP Master - v6.0 Diagnostic</title>
    
    <!-- Visual Debug Console (Hiển thị log lỗi trực tiếp lên màn hình) -->
    <style>
        #debug-console {
            position: fixed; top: 0; left: 0; width: 100%; height: 120px;
            background: rgba(0,0,0,0.9); color: #0f0; font-family: monospace;
            font-size: 11px; padding: 10px; z-index: 9999; overflow-y: auto;
            border-bottom: 2px solid #0f0; display: block; pointer-events: none;
        }
        /* Ẩn console sau khi load thành công */
        body.loaded #debug-console { display: none; }
        
        /* Loading Overlay */
        #loading-overlay { position: fixed; inset: 0; background: #fff; z-index: 5000; display: flex; flex-direction: column; align-items: center; justify-content: center; top: 120px; /* Make space for console */ }
        .spinner { width: 40px; height: 40px; border: 4px solid #f3f3f3; border-top: 4px solid #003366; border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>

    <!-- Script ghi log ngay lập tức -->
    <script>
        function log(msg, type='info') {
            const c = document.getElementById('debug-console');
            if(c) {
                const time = new Date().toLocaleTimeString();
                const color = type === 'error' ? 'red' : (type === 'success' ? '#0f0' : '#ccc');
                c.innerHTML += `<div style="color:${color}">[${time}] ${msg}</div>`;
                c.scrollTop = c.scrollHeight;
            }
            console.log(msg);
        }
        window.onerror = function(msg, url, line) {
            log(`CRITICAL ERROR: ${msg} (Line ${line})`, 'error');
            document.getElementById('manual-entry-btn').style.display = 'block';
        };
    </script>

    <!-- External Libs (Load async to prevent blocking) -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <script>
        // Tailwind config
        window.tailwind = { config: { theme: { extend: { colors: { navy: '#003366', orange: '#FF6600' } } } } };
    </script>
</head>
<body class="h-screen flex overflow-hidden text-slate-800 bg-white">

    <!-- DEBUG CONSOLE -->
    <div id="debug-console">Waiting for JS engine...</div>

    <!-- LOADING SCREEN -->
    <div id="loading-overlay">
        <div class="spinner mb-4"></div>
        <h2 class="text-xl font-bold text-[#003366]">CBAP Master v6.0</h2>
        <p id="loading-status" class="text-sm text-gray-500 mt-2">Initializing...</p>
        
        <!-- Emergency Button -->
        <button id="manual-entry-btn" onclick="app.emergencyEnter()" style="display:none; margin-top:20px; padding:10px 20px; background:#FF6600; color:white; border:none; cursor:pointer;">
            Force Enter Dashboard (Skip Load)
        </button>
    </div>

    <!-- MAIN UI (Hidden initially) -->
    <div id="main-layout" class="flex h-full w-full opacity-0 transition-opacity duration-500">
        <!-- SIDEBAR -->
        <aside class="w-64 bg-white border-r flex-shrink-0 flex flex-col">
            <div class="h-16 flex items-center px-6 border-b font-bold text-[#003366] text-xl">CBAP.PRO</div>
            <nav class="p-4 space-y-2 flex-1 overflow-y-auto">
                <button onclick="app.nav('dashboard')" class="w-full text-left p-3 hover:bg-gray-100 rounded flex items-center"><i class="fa-solid fa-chart-pie w-8 text-center"></i> Dashboard</button>
                <button onclick="app.nav('learn')" class="w-full text-left p-3 hover:bg-gray-100 rounded flex items-center"><i class="fa-solid fa-book w-8 text-center"></i> Knowledge Hub</button>
                <button onclick="app.nav('library')" class="w-full text-left p-3 hover:bg-gray-100 rounded flex items-center"><i class="fa-solid fa-book-open w-8 text-center"></i> Library</button>
                <button onclick="app.nav('exam')" class="w-full text-left p-3 hover:bg-gray-100 rounded flex items-center"><i class="fa-solid fa-pen-ruler w-8 text-center"></i> Exam Engine</button>
                <button onclick="app.nav('flashcards')" class="w-full text-left p-3 hover:bg-gray-100 rounded flex items-center"><i class="fa-solid fa-clone w-8 text-center"></i> Flashcards</button>
                <button onclick="app.nav('admin')" class="w-full text-left p-3 hover:bg-gray-100 rounded flex items-center"><i class="fa-solid fa-gear w-8 text-center"></i> Settings</button>
            </nav>
        </aside>

        <!-- CONTENT -->
        <main class="flex-1 flex flex-col bg-gray-50">
            <header class="h-16 bg-white border-b px-8 flex items-center justify-between">
                <h2 id="page-title" class="text-xl font-bold text-[#003366]">Overview</h2>
            </header>
            <div id="app-container" class="flex-1 p-8 overflow-y-auto"></div>
        </main>
    </div>

    <!-- APP LOGIC -->
    <script>
        log("Script execution started...");

        const DB = {
            key: 'CBAP_V6_DATA',
            state: { user: {}, curriculum: [], questions: [], flashcards: [] },

            async init() {
                log("DB.init() called");
                // Reset flag for debugging
                // localStorage.removeItem(this.key); 

                const data = localStorage.getItem(this.key);
                if (data) {
                    try {
                        this.state = JSON.parse(data);
                        log(`Found local data: ${this.state.curriculum?.length || 0} KA chapters`);
                        if (this.state.curriculum && this.state.curriculum.length > 0) {
                            return true; // Data ready
                        }
                    } catch (e) {
                        log("Local data corrupted", "error");
                    }
                }
                
                log("No valid local data. Starting fetch sequence...");
                return await this.fetchData();
            },

            async fetchData() {
                const files = ['curriculum.json', 'questions.json', 'flashcards.json'];
                // Try subfolder first, then root
                const paths = ['CbapMedia/', '']; 
                let successCount = 0;

                for (let file of files) {
                    let loaded = false;
                    for (let pathPrefix of paths) {
                        const url = `${pathPrefix}${file}?t=${Date.now()}`; // Anti-cache
                        log(`Trying to fetch: ${url}`);
                        try {
                            const res = await fetch(url);
                            if (res.ok) {
                                let text = await res.text();
                                // Clean BOM
                                if (text.charCodeAt(0) === 0xFEFF) text = text.slice(1);
                                
                                const json = JSON.parse(text);
                                const key = file.replace('.json', '');
                                this.state[key] = json;
                                log(`✅ Loaded ${file} from ${pathPrefix || 'root'}`, 'success');
                                loaded = true;
                                successCount++;
                                break; // Stop trying paths for this file
                            } else {
                                log(`Failed ${url}: ${res.status}`);
                            }
                        } catch (e) {
                            log(`Error fetching ${url}: ${e.message}`, 'error');
                        }
                    }
                    if (!loaded) log(`❌ Could not load ${file}`, 'error');
                }

                this.save();
                return successCount > 0;
            },

            save() {
                localStorage.setItem(this.key, JSON.stringify(this.state));
            }
        };

        const app = {
            async start() {
                log("App starting...");
                try {
                    const ready = await DB.init();
                    if (ready) {
                        log("System ready. Launching UI...", 'success');
                        this.launch();
                    } else {
                        log("Initialization incomplete. Please import manually.", 'error');
                        document.getElementById('loading-status').innerText = "Data missing. Please manual import.";
                        document.getElementById('manual-entry-btn').style.display = 'block';
                    }
                } catch (e) {
                    log(`Fatal crash: ${e.message}`, 'error');
                    document.getElementById('manual-entry-btn').style.display = 'block';
                }
            },

            launch() {
                document.getElementById('loading-overlay').style.display = 'none';
                document.getElementById('main-layout').classList.remove('opacity-0');
                document.body.classList.add('loaded'); // Hides debug console
                this.nav('dashboard');
            },

            emergencyEnter() {
                document.getElementById('loading-overlay').style.display = 'none';
                document.getElementById('main-layout').classList.remove('opacity-0');
                this.nav('admin');
                alert("Please use the Import buttons to load your JSON files.");
            },

            nav(view, params) {
                const container = document.getElementById('app-container');
                document.getElementById('page-title').innerText = view.toUpperCase();
                container.innerHTML = '';

                switch(view) {
                    case 'dashboard': this.renderDashboard(container); break;
                    case 'library': this.renderLibrary(container, params); break;
                    case 'learn': this.renderLearn(container); break;
                    case 'admin': this.renderAdmin(container); break;
                    default: container.innerHTML = `<div class="p-4">View: ${view} (Coming soon)</div>`;
                }
            },

            renderDashboard(container) {
                const qs = DB.state.questions?.length || 0;
                const cs = DB.state.curriculum?.length || 0;
                container.innerHTML = `
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <div class="bg-white p-6 shadow border-t-4 border-navy">
                            <h3 class="font-bold text-gray-500 text-sm">Knowledge Areas</h3>
                            <div class="text-3xl font-bold text-navy mt-2">${cs}</div>
                        </div>
                        <div class="bg-white p-6 shadow border-t-4 border-orange">
                            <h3 class="font-bold text-gray-500 text-sm">Question Bank</h3>
                            <div class="text-3xl font-bold text-orange mt-2">${qs}</div>
                        </div>
                        <div class="bg-white p-6 shadow">
                            <h3 class="font-bold text-gray-500 text-sm">Action</h3>
                            <button onclick="app.nav('library')" class="mt-2 w-full bg-navy text-white py-2 px-4 rounded">Go to Library</button>
                        </div>
                    </div>
                `;
            },

            renderLibrary(container, params) {
                const curriculum = DB.state.curriculum || [];
                if(curriculum.length === 0) {
                    container.innerHTML = `<div class="text-center p-10">No data. Go to <button onclick="app.nav('admin')" class="text-blue-600 underline">Settings</button> to import.</div>`;
                    return;
                }

                const activeCode = params?.code || curriculum[0].code;
                const activeItem = curriculum.find(c => c.code === activeCode) || curriculum[0];
                const type = params?.type || 'pdf'; // pdf, video, image

                // File Path Logic
                const basePath = 'CbapMedia/';
                const fileMap = {
                    pdf: `${basePath}${activeCode}_Textbook.pdf`,
                    video: `${basePath}${activeCode}_Video.mp4`,
                    image: `${basePath}${activeCode}_Info.png`
                };

                let content = '';
                if(type === 'pdf') content = `<iframe src="${fileMap.pdf}" class="w-full h-[600px] border"></iframe>`;
                else if(type === 'image') content = `<img src="${fileMap.image}" class="max-w-full border">`;
                else if(type === 'video') content = `<video controls class="w-full"><source src="${fileMap.video}"></video>`;

                container.innerHTML = `
                    <div class="flex flex-col md:flex-row h-full gap-4">
                        <div class="w-full md:w-64 bg-white shadow overflow-y-auto h-[600px]">
                            ${curriculum.map(c => `
                                <div onclick="app.nav('library', {code:'${c.code}', type:'${type}'})" 
                                     class="p-3 border-b cursor-pointer hover:bg-gray-50 ${c.code === activeCode ? 'bg-blue-50 font-bold text-navy' : ''}">
                                    ${c.name}
                                </div>
                            `).join('')}
                        </div>
                        <div class="flex-1 bg-white shadow p-4">
                            <div class="flex gap-2 mb-4 border-b pb-2">
                                <button onclick="app.nav('library', {code:'${activeCode}', type:'pdf'})" class="px-4 py-1 rounded ${type==='pdf'?'bg-navy text-white':'bg-gray-200'}">Textbook</button>
                                <button onclick="app.nav('library', {code:'${activeCode}', type:'image'})" class="px-4 py-1 rounded ${type==='image'?'bg-navy text-white':'bg-gray-200'}">Infographic</button>
                                <button onclick="app.nav('library', {code:'${activeCode}', type:'video'})" class="px-4 py-1 rounded ${type==='video'?'bg-navy text-white':'bg-gray-200'}">Video</button>
                            </div>
                            ${content}
                            <div class="mt-2 text-xs text-gray-400">File: ${fileMap[type]}</div>
                        </div>
                    </div>
                `;
            },

            renderLearn(container) {
                // Simple list view for now
                const curriculum = DB.state.curriculum || [];
                container.innerHTML = `
                    <div class="space-y-4">
                        <h2 class="text-2xl font-bold mb-4">Knowledge Hub</h2>
                        ${curriculum.map(c => `
                            <div class="bg-white p-4 shadow rounded">
                                <h3 class="font-bold text-lg text-navy">${c.code}: ${c.name}</h3>
                                <p class="text-gray-600">${c.desc || 'No description'}</p>
                                <div class="mt-2 pl-4 border-l-2 border-orange">
                                    ${(c.tasks || []).map(t => `<div class="text-sm py-1">${t.id} - ${t.name}</div>`).join('')}
                                </div>
                            </div>
                        `).join('')}
                    </div>
                `;
            },

            renderAdmin(container) {
                container.innerHTML = `
                    <div class="max-w-xl mx-auto bg-white p-8 shadow">
                        <h3 class="text-xl font-bold mb-6">Manual Data Import</h3>
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-bold mb-1">Curriculum.json</label>
                                <input type="file" onchange="app.importFile(this, 'curriculum')" class="w-full border p-2">
                            </div>
                            <div>
                                <label class="block text-sm font-bold mb-1">Questions.json</label>
                                <input type="file" onchange="app.importFile(this, 'questions')" class="w-full border p-2">
                            </div>
                            <div>
                                <label class="block text-sm font-bold mb-1">Flashcards.json</label>
                                <input type="file" onchange="app.importFile(this, 'flashcards')" class="w-full border p-2">
                            </div>
                        </div>
                        <div class="mt-8 pt-4 border-t">
                            <button onclick="location.reload()" class="bg-navy text-white px-4 py-2 rounded hover:bg-blue-800">Reload App</button>
                        </div>
                    </div>
                `;
            },

            importFile(input, key) {
                const file = input.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = e => {
                    try {
                        DB.state[key] = JSON.parse(e.target.result);
                        DB.save();
                        alert(`Imported ${key} successfully!`);
                    } catch(err) { alert("Invalid JSON file"); }
                };
                reader.readAsText(file);
            }
        };

        // Run when DOM ready
        document.addEventListener('DOMContentLoaded', () => {
            log("DOM Ready. Calling app.start()...");
            // Safety timeout to force show controls if JS hangs
            setTimeout(() => {
                const btn = document.getElementById('manual-entry-btn');
                if(btn && document.getElementById('loading-overlay').style.display !== 'none') {
                    btn.style.display = 'block';
                    document.getElementById('loading-status').innerText = "Loading took too long.";
                }
            }, 5000);
            
            app.start();
        });
    </script>
</body>
</html>
