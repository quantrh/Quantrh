<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>CBAP Master - Pro Study Companion</title>
    
    <!-- Tailwind Config -->
    <script>
        window.tailwind = {
            config: {
                theme: {
                    extend: {
                        colors: {
                            navy: { DEFAULT: '#0a192f', light: '#112240', dark: '#020c1b' },
                            orange: { DEFAULT: '#ff6b00', light: '#ff8533' },
                            light: { DEFAULT: '#ccd6f6', bg: '#f0f4f8' },
                            grey: { line: '#E5E5E5', bg: '#F5F5F5', text: '#8892b0' }
                        },
                        fontFamily: { sans: ['Helvetica Neue', 'Helvetica', 'Arial', 'sans-serif'] },
                        borderRadius: { 'swiss': '4px' }
                    }
                }
            }
        }
    </script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
    
    <!-- Chart.js UMD Build (Safe for browser globals) -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <!-- Supabase Client UMD Build -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.7/dist/umd/supabase.min.js"></script>
    <!-- PDF.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script>
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
    </script>
    
    <style>
        body { font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif; background-color: #f0f4f8; color: #0a192f; }
        .custom-scrollbar::-webkit-scrollbar { width: 6px; height: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #f1f1f1; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        
        .nav-item { transition: all 0.2s ease-in-out; border-left: 3px solid transparent; }
        .nav-item:hover { background-color: #e6f1ff; border-left-color: #ff6b00; }
        .nav-item.active { background-color: #112240; border-left-color: #ff6b00; }
        .nav-item.active .nav-text { color: #ccd6f6; }
        .nav-item.active i { color: #ff6b00; }
        .sidebar-transition { transition: transform 0.3s ease-in-out; }

        #loading-overlay { position: fixed; inset: 0; background: #0a192f; z-index: 5000; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .spinner { width: 40px; height: 40px; border: 4px solid #112240; border-top: 4px solid #ff6b00; border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        .toast { min-width: 250px; background: white; border-left: 4px solid #ff6b00; padding: 16px; box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1); animation: slideIn 0.3s ease-out forwards; display: flex; align-items: center; gap: 12px; z-index: 6000; }
        @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
    </style>
</head>
<body class="h-screen flex flex-col md:flex-row overflow-hidden text-slate-800 bg-light-bg font-sans">

    <!-- LOADING SCREEN -->
    <div id="loading-overlay">
        <div class="spinner mb-4"></div>
        <h2 class="text-2xl font-bold text-white tracking-widest uppercase">CBAP<span class="text-orange">.PRO</span></h2>
        <p id="loading-status" class="text-xs text-blue-200 mt-2 font-mono">SYSTEM INITIALIZING...</p>
        <button id="manual-entry-btn" onclick="app.emergencyEnter()" class="hidden mt-6 px-6 py-2 bg-orange text-white text-xs font-bold uppercase tracking-widest hover:bg-orange-light transition">Force Start</button>
    </div>

    <!-- MOBILE HEADER -->
    <header class="md:hidden h-16 bg-navy text-white flex items-center justify-between px-4 z-40 flex-shrink-0 shadow-md">
        <div class="flex items-center gap-3">
            <button onclick="app.toggleSidebar()" class="text-white text-xl focus:outline-none"><i class="fa-solid fa-bars"></i></button>
            <div class="font-bold text-white tracking-tight">CBAP<span class="text-orange">.PRO</span></div>
        </div>
        <div class="w-8 h-8 bg-orange text-white rounded flex items-center justify-center font-bold text-xs" id="mobile-user-avatar">U</div>
    </header>

    <!-- MOBILE SIDEBAR OVERLAY -->
    <div id="mobile-overlay" onclick="app.toggleSidebar()" class="fixed inset-0 bg-black bg-opacity-50 z-30 hidden md:hidden transition-opacity"></div>

    <!-- SIDEBAR -->
    <aside id="sidebar" class="fixed inset-y-0 left-0 z-40 w-64 bg-white border-r border-gray-200 transform -translate-x-full md:relative md:translate-x-0 sidebar-transition flex flex-col shadow-xl md:shadow-none">
        <div class="h-20 hidden md:flex items-center px-6 bg-navy shadow-sm">
            <div class="w-8 h-8 bg-orange text-white rounded flex items-center justify-center font-bold text-sm mr-3">C</div>
            <div class="font-bold text-white text-lg tracking-tight">CBAP<span class="text-orange">.PRO</span></div>
        </div>
        
        <!-- User Info -->
        <div class="px-6 py-4 border-b border-gray-100 flex items-center gap-3 cursor-pointer hover:bg-gray-50 bg-white" onclick="app.nav('auth')">
            <div class="w-9 h-9 rounded bg-navy-light text-white flex items-center justify-center font-bold text-sm" id="sidebar-avatar">G</div>
            <div class="overflow-hidden">
                <div class="text-sm font-bold text-navy truncate" id="sidebar-username">Guest User</div>
                <div class="text-[10px] text-gray-500 uppercase tracking-wider" id="sidebar-status">Click to Login</div>
            </div>
        </div>
        
        <nav class="flex-1 overflow-y-auto py-4 space-y-1 bg-white">
            <button onclick="app.nav('dashboard')" id="nav-dashboard" class="nav-item w-full text-left px-6 py-3 flex items-center group">
                <i class="fa-solid fa-chart-pie w-5 text-center text-gray-400 group-hover:text-navy transition-colors"></i> 
                <span class="nav-text text-xs font-bold uppercase text-gray-500 ml-3">Dashboard</span>
            </button>
            <button onclick="app.nav('learn')" id="nav-learn" class="nav-item w-full text-left px-6 py-3 flex items-center group">
                <i class="fa-solid fa-graduation-cap w-5 text-center text-gray-400 group-hover:text-navy transition-colors"></i><span class="nav-text text-xs font-bold uppercase text-gray-500 ml-3">Knowledge Hub</span>
            </button>
            <button onclick="app.nav('library')" id="nav-library" class="nav-item w-full text-left px-6 py-3 flex items-center group">
                <i class="fa-solid fa-book-open w-5 text-center text-gray-400 group-hover:text-navy transition-colors"></i><span class="nav-text text-xs font-bold uppercase text-gray-500 ml-3">Study Library</span>
            </button>
            <button onclick="app.nav('exam')" id="nav-exam" class="nav-item w-full text-left px-6 py-3 flex items-center group">
                <i class="fa-solid fa-pen-to-square w-5 text-center text-gray-400 group-hover:text-navy transition-colors"></i><span class="nav-text text-xs font-bold uppercase text-gray-500 ml-3">Exam Engine</span>
            </button>
            <button onclick="app.nav('flashcards')" id="nav-flashcards" class="nav-item w-full text-left px-6 py-3 flex items-center group">
                <i class="fa-solid fa-layer-group w-5 text-center text-gray-400 group-hover:text-navy transition-colors"></i><span class="nav-text text-xs font-bold uppercase text-gray-500 ml-3">Flashcards</span>
            </button>
            
            <div class="px-6 mt-6 mb-2"><span class="text-[10px] font-bold text-gray-400 uppercase tracking-widest">System</span></div>
            <button onclick="app.nav('admin')" id="nav-admin" class="nav-item w-full text-left px-6 py-3 flex items-center group">
                <i class="fa-solid fa-sliders w-5 text-center text-gray-400 group-hover:text-navy transition-colors"></i><span class="nav-text text-xs font-bold uppercase text-gray-500 ml-3">Settings</span>
            </button>
        </nav>
        
        <div class="p-4 bg-gray-50 border-t border-gray-100 hidden md:block">
            <div class="flex items-center justify-between">
                <div>
                    <div class="text-[9px] text-gray-400 uppercase tracking-widest">Version 9.9.9</div>
                    <div class="text-[10px] font-bold text-navy mt-0.5">Fixed Edition</div>
                </div>
                <i class="fa-solid fa-cloud text-orange text-xs"></i>
            </div>
        </div>
    </aside>

    <!-- CONTENT -->
    <main class="flex-1 flex flex-col bg-light-bg w-full overflow-hidden relative">
        <header class="h-16 bg-white border-b border-gray-200 px-8 hidden md:flex items-center justify-between shadow-sm flex-shrink-0 z-10">
            <div>
                <h2 id="page-title" class="text-xl font-bold text-navy uppercase tracking-tight">Overview</h2>
                <div class="h-0.5 w-8 bg-orange mt-1"></div>
            </div>
            <div class="flex items-center gap-6">
                <div class="text-right">
                    <div class="text-[9px] font-bold text-gray-400 uppercase tracking-widest">System Status</div>
                    <div class="font-bold text-navy text-xs" id="header-status">Checking...</div>
                </div>
                <div class="w-9 h-9 bg-navy text-white rounded flex items-center justify-center font-bold cursor-pointer hover:bg-orange transition shadow-sm" onclick="app.nav('auth')" id="header-avatar">G</div>
            </div>
        </header>
        
        <div class="md:hidden bg-white border-b px-4 py-3 flex items-center justify-between shadow-sm flex-shrink-0 z-10">
            <h2 id="mobile-page-title" class="text-sm font-bold text-navy uppercase">Dashboard</h2>
        </div>

        <div id="app-container" class="flex-1 overflow-hidden relative"></div>
        <div id="toast-container" class="fixed bottom-5 right-5 flex flex-col gap-2 z-[6000]"></div>
    </main>

    <!-- APP LOGIC -->
    <script>
        // --- SUPABASE & CONFIG ---
        const SUPABASE_URL = 'https://rmbsxccrwrktbjlnezpu.supabase.co'; 
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJtYnN4Y2Nyd3JrdGJqbG5lenB1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDg2MjczNjQsImV4cCI6MjA2NDIwMzM2NH0.ydCqificftdtn1niRciFCifeuo8aX6SDGti-hCY5Z_Y';
        
        // Supabase Instance (initialized safely)
        let sb = null;

        // --- UTILS ---
        const Toast = {
            show(msg, type = 'info') {
                const container = document.getElementById('toast-container');
                const div = document.createElement('div');
                div.className = 'toast';
                div.style.borderLeftColor = type === 'success' ? '#10B981' : (type === 'error' ? '#EF4444' : '#ff6b00');
                const icon = type === 'success' ? '<i class="fa-solid fa-check-circle text-green-500"></i>' : (type === 'error' ? '<i class="fa-solid fa-circle-exclamation text-red-500"></i>' : '<i class="fa-solid fa-info-circle text-navy"></i>');
                div.innerHTML = `${icon} <span class="text-xs font-bold text-navy uppercase tracking-wide">${msg}</span>`;
                container.appendChild(div);
                setTimeout(() => { div.style.opacity = '0'; div.style.transform = 'translateX(100%)'; setTimeout(() => div.remove(), 300); }, 3000);
            }
        };

        const Crypto = {
            async hash(str) {
                const msgBuffer = new TextEncoder().encode(str);
                const hashBuffer = await crypto.subtle.digest('SHA-256', msgBuffer);
                const hashArray = Array.from(new Uint8Array(hashBuffer));
                return hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
            }
        };

        const toOneD = (url) => {
            if (!url) return "";
            if (url.includes('1drv.ms') || url.includes('sharepoint.com') || url.includes('live.com')) {
                if (!url.includes('action=embedview') && !url.includes('resid=')) {
                    return url.includes('?') ? `${url}&action=embedview` : `${url}?action=embedview`;
                }
            }
            return url;
        };

        // --- DATABASE ---
        const DB = {
            key: 'CBAP_V9_PRO_DATA',
            state: { 
                user: { id: null, username: 'Guest', loggedIn: false }, 
                lastView: { code: 'INTRO', type: 'slide' },
                curriculum: [
                    { code: 'INTRO', name: '01. Introduction & Key Concepts', desc: 'Structure of the BABOK Guide and Key Concepts.' },
                    { code: 'BACCM', name: '02. BA Core Concept Model', desc: 'The conceptual framework for Business Analysis.' },
                    { code: 'BAPM', name: '03. Planning & Monitoring', desc: 'Organizing and coordinating the efforts of BAs.' },
                    { code: 'ELIC', name: '04. Elicitation & Collaboration', desc: 'Drawing forth information and working with stakeholders.' },
                    { code: 'RLCM', name: '05. Req. Life Cycle Mgmt', desc: 'Managing and maintaining requirements.' },
                    { code: 'SA', name: '06. Strategy Analysis', desc: 'Identifying business need and aligning strategy.' },
                    { code: 'RADD', name: '07. RADD (Design Definition)', desc: 'Specifying and modelling requirements.' },
                    { code: 'SE', name: '08. Solution Evaluation', desc: 'Assessing value and solution performance.' },
                    { code: 'COMP', name: '09. Underlying Competencies', desc: 'Behaviors and knowledge supporting BA work.' },
                    { code: 'TECH', name: '10. Techniques', desc: 'The 50 standard techniques in BABOK.' },
                    { code: 'PERSP', name: '11. Perspectives', desc: 'Agile, BI, IT, Architecture, BPM.' }
                ],
                questions: [], 
                flashcards: [], 
                completedTasks: []
            },
            
            resources: {
                'INTRO': { slides: [{ title: "Course Introduction", url: "https://1drv.ms/p/s!Am8Lw2njpdkKgf4c_Sample_PPT?action=embedview" }], mindmaps: [{ title: "BA Career Path", url: "https://via.placeholder.com/800x600/0a192f/64ffda?text=Mindmap:+Career+Path" }], info: [{ title: "Exam Blueprint", url: "https://via.placeholder.com/600x800/fff/0a192f?text=Info:+Exam+Blueprint" }] },
                'BACCM': { slides: [{ title: "Core Concepts Overview", url: "https://1drv.ms/p/s!Am8Lw2njpdkKgf4e_Sample?action=embedview" }], mindmaps: [{ title: "BACCM Hexagon", url: "https://via.placeholder.com/800x600/0a192f/ff6b00?text=Mindmap:+BACCM+Core" }], info: [{ title: "Terminologies", url: "https://via.placeholder.com/600x800/fff/0a192f?text=Info:+Key+Terms" }] },
            },
            
            async init() {
                // Initialize Supabase safely
                if (typeof supabase !== 'undefined') {
                    try {
                        sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
                        console.log("Supabase initialized");
                    } catch (e) { console.warn("Supabase init failed", e); }
                } else {
                    console.warn("Supabase library not loaded");
                }

                // Load LocalStorage
                const stored = localStorage.getItem(this.key);
                if (stored) {
                    try {
                        const parsed = JSON.parse(stored);
                        this.state.completedTasks = parsed.completedTasks || [];
                        this.state.lastView = parsed.lastView || { code: 'INTRO', type: 'slide' };
                        this.state.user = parsed.user || { id: null, username: 'Guest', loggedIn: false };
                    } catch(e) { console.error("Load error", e); }
                }

                await this.fetchLocalData();
                this.ensureDataIntegrity();

                if (this.state.user.loggedIn && sb) await this.pullFromCloud();

                this.save();
                return true;
            },

            async fetchLocalData() {
                const files = ['questions.json', 'flashcards.json'];
                for (let file of files) {
                    try {
                        const res = await fetch(`${file}?t=${Date.now()}`);
                        if (res.ok) {
                            const data = await res.json();
                            if(Array.isArray(data) && data.length > 0) {
                                this.state[file.replace('.json', '')] = data;
                            }
                        }
                    } catch (e) { }
                }
            },

            ensureDataIntegrity() {
                this.state.curriculum.forEach((c) => {
                    if(!c.tasks || c.tasks.length === 0) {
                        const count = 5; 
                        c.tasks = Array(count).fill(0).map((_, i) => ({ 
                            id: `${c.code}_T${i+1}`, 
                            name: `${c.name} - Topic ${i+1}` 
                        }));
                    }
                });
                
                if(!this.state.questions || this.state.questions.length === 0) {
                     this.state.questions = Array(20).fill(0).map((_, i) => ({
                        id: `Q${i+1}`, ka: 'BAPM', 
                        stem: `Sample Question ${i+1}: This is a generated placeholder question because 'questions.json' was not found.`, 
                        options: ["Option A", "Option B", "Option C", "Option D"], 
                        correct: [0], 
                        explanation: "Explanation placeholder."
                    }));
                }

                if(!this.state.flashcards || this.state.flashcards.length === 0) {
                    this.state.flashcards = Array(10).fill(0).map((_, i) => ({
                        front: `Term ${i+1}`, back: `Definition for term ${i+1}. Generated automatically.`
                    }));
                }
            },

            save() {
                localStorage.setItem(this.key, JSON.stringify({
                    completedTasks: this.state.completedTasks,
                    lastView: this.state.lastView,
                    user: this.state.user
                }));
            },

            async pushToCloud() {
                if (!this.state.user.id || !sb) return;
                const payload = { completedTasks: this.state.completedTasks };
                await sb.from('user_progress').upsert({ user_id: this.state.user.id, data: payload, updated_at: new Date() });
            },

            async pullFromCloud() {
                if (!this.state.user.id || !sb) return;
                const { data, error } = await sb.from('user_progress').select('data').eq('user_id', this.state.user.id).single();
                if (data && data.data) {
                    this.state.completedTasks = data.data.completedTasks || [];
                    this.save();
                }
            },

            toggleTask(taskId) {
                const idx = this.state.completedTasks.indexOf(taskId);
                if (idx > -1) {
                    this.state.completedTasks.splice(idx, 1);
                } else {
                    this.state.completedTasks.push(taskId);
                }
                this.save();
                if(this.state.user.loggedIn) this.pushToCloud();
                return this.state.completedTasks.includes(taskId); 
            },
            
            setLastView(code, type) {
                this.state.lastView = { code, type };
                this.save();
            }
        };

        const Auth = {
            async login(username, password) {
                if(!sb) return { error: "Cloud service unavailable" };
                const hashed = await Crypto.hash(password);
                const { data, error } = await sb.from('custom_users').select('*').eq('username', username).eq('password', hashed).single();
                if (error || !data) return { error: "Invalid username or password" };
                DB.state.user = { id: data.id, username: data.username, loggedIn: true };
                await DB.pullFromCloud(); 
                DB.save();
                app.updateUserUI();
                return { success: true };
            },

            async register(username, password) {
                if(!sb) return { error: "Cloud service unavailable" };
                const hashed = await Crypto.hash(password);
                const { data: existing } = await sb.from('custom_users').select('id').eq('username', username).single();
                if (existing) return { error: "Username already taken" };
                const { data, error } = await sb.from('custom_users').insert([{ username, password: hashed }]).select().single();
                if (error) return { error: error.message };
                DB.state.user = { id: data.id, username: data.username, loggedIn: true };
                await sb.from('user_progress').insert({ user_id: data.id, data: { completedTasks: [] } });
                DB.save();
                app.updateUserUI();
                return { success: true };
            },

            logout() {
                DB.state.user = { id: null, username: 'Guest', loggedIn: false };
                DB.state.completedTasks = []; 
                DB.save();
                app.updateUserUI();
                app.nav('auth');
            }
        };

        // --- APP CONTROLLER ---
        const app = {
            isSidebarOpen: false,
            zoomLevel: 1,
            selectedSubResource: null,
            flashcardIndex: 0,
            flashcardFlipped: false,
            examState: { active: false, current: 0, answers: {} },

            async start() {
                await DB.init();
                document.getElementById('loading-overlay').style.display = 'none';
                this.updateUserUI();
                this.nav('dashboard');
            },

            emergencyEnter() { 
                document.getElementById('loading-overlay').style.display = 'none'; 
                this.nav('dashboard');
            },

            updateUserUI() {
                const user = DB.state.user;
                const status = user.loggedIn ? (sb ? 'Online â€¢ Synced' : 'Local (No Cloud)') : 'Local Mode';
                document.getElementById('header-status').innerText = status;
                document.getElementById('sidebar-username').innerText = user.username;
            },

            toggleSidebar() {
                const sb = document.getElementById('sidebar');
                const overlay = document.getElementById('mobile-overlay');
                this.isSidebarOpen = !this.isSidebarOpen;
                if (this.isSidebarOpen) {
                    sb.classList.remove('-translate-x-full');
                    overlay.classList.remove('hidden');
                } else {
                    sb.classList.add('-translate-x-full');
                    overlay.classList.add('hidden');
                }
            },

            // --- SAFE NAVIGATION HELPER ---
            viewModule(code) {
                this.nav('task_detail', { code: code });
            },

            nav(view, params) {
                if(window.innerWidth < 768 && this.isSidebarOpen) this.toggleSidebar();
                document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
                const btn = document.getElementById(`nav-${view}`);
                if(btn) btn.classList.add('active');

                if (view === 'library' && params) {
                    DB.setLastView(params.code, params.type);
                }

                const titles = {
                    dashboard: 'Dashboard', learn: 'Knowledge Hub', library: 'Study Library',
                    exam: 'Exam Engine', flashcards: 'Flashcards', admin: 'Settings', auth: 'Login',
                    task_detail: 'Topic Details'
                };
                document.getElementById('page-title').innerText = titles[view] || 'CBAP Pro';
                const mobileTitle = document.getElementById('mobile-page-title');
                if(mobileTitle) mobileTitle.innerText = titles[view] || 'CBAP Pro';
                
                const container = document.getElementById('app-container');
                container.innerHTML = '';

                try {
                    switch(view) {
                        case 'dashboard': this.renderDashboard(container); break;
                        case 'library': this.renderLibrary(container, params); break;
                        case 'learn': this.renderLearn(container); break;
                        case 'task_detail': this.renderTaskDetail(container, params); break;
                        case 'exam': this.renderExam(container); break;
                        case 'flashcards': this.renderFlashcards(container); break;
                        case 'admin': this.renderAdmin(container); break;
                        case 'auth': this.renderAuth(container); break;
                    }
                } catch(e) {
                    console.error(e);
                    container.innerHTML = `<div class="p-10 text-center text-red-500">Error: ${e.message}</div>`;
                }
            },

            // --- DASHBOARD ---
            renderDashboard(container) {
                const curriculum = DB.state.curriculum || [];
                const kaCodes = ['BAPM', 'ELIC', 'RLCM', 'SA', 'RADD', 'SE'];
                
                let totalTasks = 0;
                let totalCompleted = 0;
                
                const progressData = curriculum.map(c => {
                    const tasks = c.tasks || [];
                    const tCount = tasks.length;
                    const cCount = tasks.filter(t => DB.state.completedTasks.includes(t.id)).length;
                    totalTasks += tCount;
                    totalCompleted += cCount;
                    const percent = tCount > 0 ? Math.round((cCount / tCount) * 100) : 0;
                    return { ...c, percent };
                });

                const overallPercent = totalTasks > 0 ? Math.round((totalCompleted / totalTasks) * 100) : 0;
                const chartValues = kaCodes.map(code => {
                    const item = progressData.find(p => p.code === code);
                    return item ? item.percent : 0;
                });
                
                const lastView = DB.state.lastView;
                const resumeTitle = curriculum.find(c => c.code === lastView.code)?.name || lastView.code;

                container.innerHTML = `
                    <div class="p-6 md:p-8 space-y-6 overflow-y-auto h-full custom-scrollbar">
                        <!-- Welcome & Resume -->
                        <div class="bg-[#0a192f] rounded-lg shadow-lg p-6 text-white relative overflow-hidden border border-gray-700">
                             <div class="relative z-10">
                                <h3 class="text-xs font-bold text-orange uppercase tracking-widest mb-2">Study Dashboard</h3>
                                <h1 class="text-2xl font-bold mb-2">Welcome Back, ${DB.state.user.username}</h1>
                                <p class="text-blue-200 text-sm mb-6 max-w-lg">
                                    Last viewed: <strong>${resumeTitle}</strong> (${lastView.type.toUpperCase()}).
                                </p>
                                <button onclick="app.nav('library', {code: '${lastView.code}', type: '${lastView.type}'})" class="bg-orange text-white px-6 py-2 rounded text-xs font-bold uppercase tracking-widest hover:bg-white hover:text-orange transition shadow-md">
                                    Resume Session <i class="fa-solid fa-arrow-right ml-1"></i>
                                </button>
                            </div>
                            <div class="absolute right-0 bottom-0 opacity-10 text-9xl text-white transform translate-x-10 translate-y-10 pointer-events-none">
                                <i class="fa-solid fa-chart-line"></i>
                            </div>
                        </div>

                        <!-- Quick Shortcuts (REQUEST 3) -->
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                            <button onclick="app.nav('learn')" class="bg-white p-4 rounded-lg shadow-sm border border-gray-200 hover:border-orange hover:shadow-md transition text-left group flex items-center gap-3">
                                <div class="w-10 h-10 rounded-full bg-blue-50 text-navy flex items-center justify-center group-hover:bg-navy group-hover:text-white transition"><i class="fa-solid fa-graduation-cap"></i></div>
                                <div><div class="font-bold text-navy text-sm">Knowledge Hub</div><div class="text-[10px] text-gray-400">Track Tasks</div></div>
                            </button>
                            <button onclick="app.nav('library')" class="bg-white p-4 rounded-lg shadow-sm border border-gray-200 hover:border-orange hover:shadow-md transition text-left group flex items-center gap-3">
                                <div class="w-10 h-10 rounded-full bg-blue-50 text-navy flex items-center justify-center group-hover:bg-navy group-hover:text-white transition"><i class="fa-solid fa-book-open"></i></div>
                                <div><div class="font-bold text-navy text-sm">Study Library</div><div class="text-[10px] text-gray-400">Books & Slides</div></div>
                            </button>
                            <button onclick="app.nav('exam')" class="bg-white p-4 rounded-lg shadow-sm border border-gray-200 hover:border-orange hover:shadow-md transition text-left group flex items-center gap-3">
                                <div class="w-10 h-10 rounded-full bg-blue-50 text-navy flex items-center justify-center group-hover:bg-navy group-hover:text-white transition"><i class="fa-solid fa-pen-to-square"></i></div>
                                <div><div class="font-bold text-navy text-sm">Exam Engine</div><div class="text-[10px] text-gray-400">Practice Quiz</div></div>
                            </button>
                            <button onclick="app.nav('flashcards')" class="bg-white p-4 rounded-lg shadow-sm border border-gray-200 hover:border-orange hover:shadow-md transition text-left group flex items-center gap-3">
                                <div class="w-10 h-10 rounded-full bg-blue-50 text-navy flex items-center justify-center group-hover:bg-navy group-hover:text-white transition"><i class="fa-solid fa-layer-group"></i></div>
                                <div><div class="font-bold text-navy text-sm">Flashcards</div><div class="text-[10px] text-gray-400">Memory Aid</div></div>
                            </button>
                        </div>

                        <!-- Charts & Stats -->
                        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                            <!-- Radar Chart -->
                            <div class="bg-white p-6 rounded-lg shadow-sm border border-gray-200 lg:col-span-2">
                                <h3 class="text-xs font-bold text-gray-400 uppercase tracking-widest mb-4">Proficiency (Real-time)</h3>
                                <div class="h-64 relative flex items-center justify-center" id="chart-container">
                                    <canvas id="proficiencyChart"></canvas>
                                </div>
                            </div>

                            <!-- Progress List -->
                            <div class="bg-white p-6 rounded-lg shadow-sm border border-gray-200 flex flex-col">
                                <h3 class="text-xs font-bold text-gray-400 uppercase tracking-widest mb-4">Course Progress</h3>
                                <div class="flex items-center gap-3 mb-6">
                                    <div class="text-4xl font-bold text-navy">${overallPercent}%</div>
                                    <div class="flex-1">
                                        <div class="h-2 bg-gray-100 rounded-full overflow-hidden">
                                            <div class="h-full bg-orange transition-all duration-1000" style="width: ${overallPercent}%"></div>
                                        </div>
                                        <div class="text-[10px] text-gray-400 mt-1 uppercase">${totalCompleted} / ${totalTasks} Tasks Completed</div>
                                    </div>
                                </div>
                                <div class="flex-1 overflow-y-auto space-y-4 pr-2 custom-scrollbar max-h-60">
                                    ${progressData.map(p => `
                                        <div>
                                            <div class="flex justify-between text-[10px] font-bold text-navy mb-1"><span>${p.code}</span><span class="${p.percent === 100 ? 'text-green-500' : 'text-orange'}">${p.percent}%</span></div>
                                            <div class="w-full bg-gray-100 h-1.5 rounded-full overflow-hidden"><div class="bg-navy h-full transition-all duration-1000" style="width: ${p.percent}%"></div></div>
                                        </div>`).join('')}
                                </div>
                            </div>
                        </div>
                    </div>
                `;

                // Safe Chart Initialization
                setTimeout(() => {
                    const ctx = document.getElementById('proficiencyChart');
                    if(ctx && typeof Chart !== 'undefined') {
                        new Chart(ctx, {
                            type: 'radar',
                            data: { labels: kaCodes, datasets: [{ label: 'Completed %', data: chartValues, backgroundColor: 'rgba(255, 107, 0, 0.2)', borderColor: '#ff6b00', pointBackgroundColor: '#0a192f', pointBorderColor: '#fff', borderWidth: 2 }] },
                            options: { responsive: true, maintainAspectRatio: false, scales: { r: { angleLines: { color: '#f1f5f9' }, grid: { color: '#e2e8f0' }, pointLabels: { font: { size: 10, weight: 'bold' }, color: '#0a192f' }, suggestedMin: 0, suggestedMax: 100, ticks: { display: false } } }, plugins: { legend: { display: false } } } 
                        });
                    } else if (ctx) {
                        ctx.style.display = 'none';
                        document.getElementById('chart-container').innerHTML = '<div class="text-xs text-gray-400">Chart library loading...</div>';
                    }
                }, 500);
            },

            // --- KNOWLEDGE HUB (Fixed Click Issue) ---
            renderLearn(container) {
                const curriculum = DB.state.curriculum || [];
                container.innerHTML = `
                    <div class="p-6 md:p-8 overflow-y-auto h-full">
                        <h2 class="text-2xl font-bold text-navy mb-6">Knowledge Hub</h2>
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                            ${curriculum.map((c, i) => {
                                const tasks = c.tasks || [];
                                const done = tasks.filter(t => DB.state.completedTasks.includes(t.id)).length;
                                const total = tasks.length;
                                const percent = total > 0 ? Math.round((done/total)*100) : 0;
                                
                                return `
                                <div class="bg-white p-6 rounded shadow-sm border border-gray-200 hover:border-orange hover:shadow-md transition group flex flex-col h-full cursor-pointer" onclick="app.viewModule('${c.code}')">
                                    <div class="flex justify-between items-start mb-4">
                                        <span class="text-4xl font-bold text-gray-100 group-hover:text-navy transition">${(i+1).toString().padStart(2,'0')}</span>
                                        <span class="bg-navy-light text-blue-200 text-[9px] font-bold px-2 py-1 uppercase tracking-widest rounded">${c.code}</span>
                                    </div>
                                    <h3 class="text-lg font-bold text-navy mb-2 group-hover:text-orange transition">${c.name}</h3>
                                    <div class="w-full bg-gray-100 h-1.5 rounded-full overflow-hidden mb-2">
                                        <div class="bg-orange h-full" style="width: ${percent}%"></div>
                                    </div>
                                    <div class="text-[10px] text-gray-400 mb-4">${done}/${total} Completed</div>
                                    <div class="mt-auto flex gap-2">
                                        <button class="flex-1 bg-navy text-white py-2 rounded text-xs font-bold uppercase tracking-widest hover:bg-orange transition">View Details</button>
                                    </div>
                                </div>`;
                            }).join('')}
                        </div>
                    </div>
                `;
            },

            renderTaskDetail(container, params) {
                const item = DB.state.curriculum.find(c => c.code === params.code);
                if(!item) { container.innerHTML = '<div class="p-8">Module not found</div>'; return; }
                
                const tasks = item.tasks || [];
                const total = tasks.length;
                const doneCount = tasks.filter(t => DB.state.completedTasks.includes(t.id)).length;
                const percent = total > 0 ? Math.round((doneCount/total)*100) : 0;

                container.innerHTML = `
                    <div class="p-6 md:p-8 max-w-4xl mx-auto h-full overflow-y-auto custom-scrollbar">
                        <div class="flex justify-between items-center mb-6">
                            <button onclick="app.nav('learn')" class="text-xs font-bold text-gray-400 uppercase tracking-widest hover:text-navy flex items-center gap-2">
                                <i class="fa-solid fa-arrow-left"></i> Back to Hub
                            </button>
                            <!-- REQUEST 2: Added Textbook Link -->
                            <button onclick="app.nav('library', {code:'${params.code}', type:'textbookvn'})" class="bg-white border border-gray-300 text-navy px-4 py-2 rounded text-xs font-bold uppercase tracking-widest hover:bg-orange hover:text-white hover:border-orange transition flex items-center gap-2">
                                <i class="fa-solid fa-book-open"></i> Read Textbook
                            </button>
                        </div>
                        
                        <div class="bg-white rounded-lg shadow-sm border border-gray-200 overflow-hidden mb-6">
                            <div class="p-6 border-b border-gray-100 bg-gray-50 flex flex-col md:flex-row md:items-center justify-between gap-4">
                                <div><div class="text-xs font-bold text-orange uppercase tracking-widest mb-1">Module Detail</div><h1 class="text-2xl font-bold text-navy">${item.name}</h1></div>
                                <div class="text-right"><div class="text-3xl font-bold text-navy">${percent}%</div><div class="text-[10px] text-gray-400 uppercase">Module Progress</div></div>
                            </div>
                            
                            <div class="p-0">
                                ${tasks.map((t, idx) => {
                                    const isDone = DB.state.completedTasks.includes(t.id);
                                    return `
                                        <div class="flex items-center justify-between p-4 border-b border-gray-50 hover:bg-blue-50 transition group">
                                            <div class="flex items-center gap-4">
                                                <div class="w-8 h-8 rounded-full flex items-center justify-center text-xs font-bold ${isDone ? 'bg-green-100 text-green-600' : 'bg-gray-100 text-gray-400'}">${idx + 1}</div>
                                                <div><div class="text-sm font-bold ${isDone ? 'text-gray-400 line-through' : 'text-navy'}">${t.name}</div><div class="text-[10px] text-gray-400 font-mono">${t.id}</div></div>
                                            </div>
                                            <button onclick="app.toggleTaskState('${t.id}', '${params.code}')" class="px-4 py-2 rounded text-[10px] font-bold uppercase tracking-widest border transition flex items-center gap-2 ${isDone ? 'bg-green-50 text-green-600 border-green-200 hover:bg-red-50 hover:text-red-600 hover:border-red-200' : 'bg-white text-gray-400 border-gray-200 hover:border-orange hover:text-orange'}">
                                                ${isDone ? '<span>Completed</span> <i class="fa-solid fa-check"></i>' : '<span>Mark Complete</span>'}
                                            </button>
                                        </div>
                                    `;
                                }).join('')}
                            </div>
                        </div>
                    </div>
                `;
            },

            toggleTaskState(taskId, code) {
                const newState = DB.toggleTask(taskId);
                this.renderTaskDetail(document.getElementById('app-container'), { code: code });
                Toast.show(newState ? "Task Completed" : "Task Unmarked", newState ? 'success' : 'info');
            },

            // --- LIBRARY ---
            renderLibrary(container, params) {
                const code = params?.code || DB.state.lastView.code || 'INTRO';
                const type = params?.type || DB.state.lastView.type || 'slide';
                
                const resources = DB.resources[code] || { slides: [], mindmaps: [], info: [] };
                let list = (type === 'slide') ? resources.slides : (type === 'mindmap' ? resources.mindmaps : (type === 'info' ? resources.info : []));
                
                let currentItem = this.selectedSubResource;
                if (!currentItem || !list.find(i => i.url === currentItem.url)) currentItem = list[0];

                const loader = `<div id="content-loader" class="absolute inset-0 flex flex-col items-center justify-center bg-gray-50 z-0"><div class="spinner mb-2"></div><span class="text-xs text-gray-500 font-bold">LOADING...</span></div>`;
                let viewerHtml = `<div class="flex items-center justify-center h-full text-gray-400">Content not available</div>`;

                if (['textbookvn','textbookEN'].includes(type)) {
                    const url = type === 'textbookvn' ? 'https://1drv.ms/b/s!Am8Lw2njpdkKgf4a' : 'https://1drv.ms/b/s!Am8Lw2njpdkKgf4b';
                    viewerHtml = `<div class="relative w-full h-full bg-gray-200">${loader}<iframe src="${toOneD(url)}" class="absolute inset-0 w-full h-full border-none z-10" onload="this.parentElement.querySelector('#content-loader')?.remove()"></iframe></div>`;
                } else if (currentItem) {
                    if (type === 'slide') {
                        viewerHtml = `<div class="relative w-full h-full bg-gray-200">${loader}<iframe src="${toOneD(currentItem.url)}" class="absolute inset-0 w-full h-full border-none z-10" onload="this.parentElement.querySelector('#content-loader')?.remove()"></iframe></div>`;
                    } else if (['mindmap', 'info'].includes(type)) {
                        viewerHtml = `<div class="relative w-full h-full bg-slate-200 overflow-hidden flex items-center justify-center">${loader}<img id="zoom-img" src="${currentItem.url}" class="max-w-full max-h-full shadow-lg transition-transform duration-200 z-10" style="transform: scale(${this.zoomLevel})" onload="this.parentElement.querySelector('#content-loader')?.remove()"></div>`;
                    } else if (type === 'video') {
                         viewerHtml = `<div class="h-full w-full bg-black flex items-center justify-center"><iframe class="w-full max-w-4xl aspect-video shadow-2xl" src="https://www.youtube.com/embed/dQw4w9WgXcQ" frameborder="0" allowfullscreen></iframe></div>`;
                    }
                }

                container.innerHTML = `
                    <div class="flex h-full flex-col lg:flex-row border-t border-gray-200">
                        <div class="w-full lg:w-64 bg-white border-r border-gray-200 flex-shrink-0 flex flex-col h-48 lg:h-full lg:order-1 order-3">
                            <div class="p-3 bg-gray-50 border-b border-gray-100 font-bold text-[10px] text-gray-500 uppercase tracking-widest sticky top-0">Modules</div>
                            <div class="flex-1 overflow-y-auto custom-scrollbar">
                                ${DB.state.curriculum.map(c => `<button onclick="app.nav('library', {code:'${c.code}'})" class="w-full text-left px-4 py-3 border-b border-gray-50 hover:bg-gray-50 transition group ${c.code === code ? 'bg-navy border-l-4 border-l-orange' : ''}"><div class="flex justify-between items-center mb-1"><span class="text-xs font-bold ${c.code === code ? 'text-white' : 'text-navy'}">${c.code}</span></div><div class="text-[10px] truncate ${c.code === code ? 'text-blue-200' : 'text-gray-400'}">${c.name}</div></button>`).join('')}
                            </div>
                        </div>
                        <div class="flex-1 flex flex-col h-full bg-gray-100 relative lg:order-2 order-2 min-h-[400px]">
                            <div class="h-12 bg-white border-b border-gray-200 flex items-center px-4 flex-shrink-0 shadow-[0_2px_4px_rgba(0,0,0,0.02)] z-20 gap-2 overflow-x-auto no-scrollbar">
                                ${['slide', 'mindmap', 'info', 'textbookvn', 'textbookEN', 'video'].map(t => `<button onclick="app.nav('library', {code:'${code}', type:'${t}'})" class="px-3 py-1.5 rounded text-[10px] font-bold uppercase tracking-widest whitespace-nowrap transition ${type === t ? 'bg-orange text-white' : 'text-gray-500 hover:bg-gray-100 hover:text-navy'}">${t==='textbookvn'?'Book VN':(t==='textbookEN'?'Book EN':t)}</button>`).join('')}
                                <div class="flex-1"></div>
                                ${['mindmap','info'].includes(type) ? `<button onclick="app.adjustZoom(-0.2)" class="w-7 h-7 flex items-center justify-center text-gray-500 border rounded"><i class="fa-solid fa-minus text-xs"></i></button><button onclick="app.adjustZoom(0.2)" class="w-7 h-7 flex items-center justify-center text-gray-500 border rounded"><i class="fa-solid fa-plus text-xs"></i></button>` : ''}
                                <button onclick="app.toggleFullscreen('app-container')" class="w-7 h-7 flex items-center justify-center text-gray-500 border rounded"><i class="fa-solid fa-expand text-xs"></i></button>
                            </div>
                            <div class="flex-1 relative overflow-hidden">${viewerHtml}</div>
                        </div>
                        <div class="hidden lg:block lg:order-3 h-full w-56 bg-white border-l border-gray-200 flex-shrink-0 flex flex-col">
                             <div class="p-3 bg-gray-50 border-b border-gray-100 font-bold text-[10px] text-gray-500 uppercase tracking-widest">Files</div>
                             <div class="flex-1 overflow-y-auto">${list.map(item => `<button onclick="app.selectSubResource('${item.url}', '${item.title}')" class="w-full text-left px-4 py-3 border-b border-gray-50 hover:bg-blue-50 transition ${currentItem && currentItem.url === item.url ? 'bg-blue-50 border-l-4 border-l-orange' : 'text-gray-600'}"><div class="text-xs font-bold ${currentItem && currentItem.url === item.url ? 'text-navy' : ''}">${item.title}</div></button>`).join('')}</div>
                        </div>
                    </div>`;
            },
            
            selectSubResource(url, title) { this.selectedSubResource = { url, title }; this.nav('library'); },
            adjustZoom(delta) { this.zoomLevel = Math.max(0.5, Math.min(3, this.zoomLevel + delta)); const img = document.getElementById('zoom-img'); if(img) img.style.transform = `scale(${this.zoomLevel})`; },
            toggleFullscreen(id) { const el = document.getElementById(id); if (!document.fullscreenElement) { el.requestFullscreen().catch(err => {}); } else { document.exitFullscreen(); } },

            // --- EXAM ENGINE ---
            renderExam(container) {
                if(!this.examState.active) {
                    const count = DB.state.questions.length;
                    container.innerHTML = `<div class="flex flex-col items-center justify-center h-full p-8 text-center bg-white"><div class="w-20 h-20 bg-blue-50 rounded-full flex items-center justify-center text-3xl text-navy mb-6 shadow-sm"><i class="fa-solid fa-pen-to-square"></i></div><h2 class="text-2xl font-bold text-navy mb-2">Exam Simulator</h2><p class="text-gray-500 mb-8 max-w-md">Ready with ${count} questions.</p><button class="swiss-btn swiss-btn-primary px-8 py-3 shadow-lg" onclick="app.startExam()">Start Random Drill</button></div>`;
                } else {
                    const q = DB.state.questions[this.examState.current];
                    const userAns = this.examState.answers[q.id];
                    const isAnswered = userAns !== undefined;
                    container.innerHTML = `<div class="max-w-3xl mx-auto p-4 md:p-8"><div class="flex justify-between items-center mb-6"><div class="text-xs font-bold text-gray-400 uppercase">Question ${this.examState.current + 1}/${DB.state.questions.length}</div><button onclick="app.quitExam()" class="text-red-500 hover:text-red-700 font-bold text-xs uppercase">Exit</button></div><div class="bg-white p-6 md:p-8 rounded shadow-sm border border-gray-200 mb-6"><h3 class="text-lg font-bold text-navy mb-6 leading-relaxed">${q.stem}</h3><div class="space-y-3">${q.options.map((opt, i) => { let cls = "border-gray-200 hover:bg-gray-50"; if(isAnswered) { if(i === q.correct[0]) cls = "bg-green-50 border-green-500 text-green-800"; else if(i === userAns) cls = "bg-red-50 border-red-500 text-red-800"; } return `<div onclick="${!isAnswered ? `app.answerExam(${i})` : ''}" class="p-4 border ${cls} rounded cursor-pointer transition flex items-center gap-3"><span class="font-bold">${String.fromCharCode(65+i)}.</span> ${opt}</div>`; }).join('')}</div>${isAnswered ? `<div class="mt-6 p-4 bg-blue-50 text-navy text-sm border-l-4 border-navy">${q.explanation}</div>` : ''}</div><div class="flex justify-between"><button onclick="app.prevExam()" class="swiss-btn swiss-btn-outline px-6 py-2" ${this.examState.current===0 ? 'disabled':''}>Previous</button><button onclick="app.nextExam()" class="swiss-btn swiss-btn-primary px-6 py-2" ${!isAnswered ? 'disabled opacity-50':''}>Next</button></div></div>`;
                }
            },
            startExam() { this.examState = { active: true, current: 0, answers: {} }; this.nav('exam'); },
            answerExam(idx) { const q = DB.state.questions[this.examState.current]; this.examState.answers[q.id] = idx; this.nav('exam'); },
            nextExam() { if(this.examState.current < DB.state.questions.length-1) { this.examState.current++; this.nav('exam'); } else { this.quitExam(); } },
            prevExam() { if(this.examState.current > 0) { this.examState.current--; this.nav('exam'); } },
            quitExam() { this.examState.active = false; this.nav('exam'); },

            // --- FLASHCARDS ---
            renderFlashcards(container) {
                const total = DB.state.flashcards.length;
                const card = DB.state.flashcards[this.flashcardIndex];
                container.innerHTML = `<div class="flex flex-col items-center justify-center h-full p-4 md:p-8"><div class="w-full max-w-xl mb-4 flex justify-between"><span class="text-xs font-bold text-gray-400 uppercase">Card ${this.flashcardIndex + 1}/${total}</span><span class="text-xs font-bold text-orange uppercase">Active Recall</span></div><div class="w-full max-w-xl aspect-[3/2] perspective-1000 relative cursor-pointer group" onclick="app.flipCard()"><div id="card-inner" class="w-full h-full relative transition-transform duration-500 transform-style-3d shadow-lg rounded-xl border border-gray-200 ${this.flashcardFlipped ? 'rotate-y-180' : ''}"><div class="absolute inset-0 backface-hidden bg-white p-8 flex flex-col items-center justify-center text-center"><span class="text-[10px] font-bold text-gray-300 uppercase mb-4">Front</span><h3 class="text-xl md:text-2xl font-bold text-navy">${card.front}</h3><div class="mt-8 text-xs text-orange font-bold uppercase animate-pulse">Tap to Flip</div></div><div class="absolute inset-0 backface-hidden bg-navy p-8 flex flex-col items-center justify-center text-center rotate-y-180"><span class="text-[10px] font-bold text-blue-200 uppercase mb-4">Back</span><h3 class="text-lg md:text-xl font-medium text-white">${card.back}</h3></div></div></div><div class="w-full max-w-xl flex gap-4 mt-8"><button onclick="app.prevCard()" class="flex-1 py-3 border border-gray-200 bg-white text-gray-500 text-xs font-bold uppercase rounded hover:bg-gray-50">Previous</button><button onclick="app.nextCard()" class="flex-1 py-3 bg-navy text-white text-xs font-bold uppercase rounded hover:bg-orange transition">Next Card</button></div></div>`;
            },
            flipCard() { this.flashcardFlipped = !this.flashcardFlipped; this.nav('flashcards'); },
            nextCard() { if(this.flashcardIndex < DB.state.flashcards.length-1) { this.flashcardIndex++; this.flashcardFlipped = false; this.nav('flashcards'); } },
            prevCard() { if(this.flashcardIndex > 0) { this.flashcardIndex--; this.flashcardFlipped = false; this.nav('flashcards'); } },

            renderAuth(container) { container.innerHTML = `<div class="flex items-center justify-center h-full bg-light-bg p-4"><div class="w-full max-w-md bg-white p-8 rounded shadow-lg border-t-4 border-orange"><h2 class="text-2xl font-bold text-navy mb-6 text-center">Cloud Login</h2><div class="space-y-4"><div><label class="block text-xs font-bold text-gray-500 uppercase mb-1">Username</label><input type="text" id="login-user" class="w-full p-3 border border-gray-200 rounded text-sm bg-gray-50"></div><div><label class="block text-xs font-bold text-gray-500 uppercase mb-1">Password</label><input type="password" id="login-pass" class="w-full p-3 border border-gray-200 rounded text-sm bg-gray-50"></div><button onclick="app.handleLogin()" class="w-full swiss-btn swiss-btn-primary py-3 mt-4">Sign In</button><button onclick="app.handleRegister()" class="w-full swiss-btn swiss-btn-outline py-3 mt-2">Register</button></div></div></div>`; },
            async handleLogin() { const u = document.getElementById('login-user').value; const p = document.getElementById('login-pass').value; if(u&&p) { const res = await Auth.login(u,p); if(res.error) Toast.show(res.error,'error'); else { Toast.show('Welcome','success'); this.nav('dashboard'); } } },
            async handleRegister() { const u = document.getElementById('login-user').value; const p = document.getElementById('login-pass').value; if(u&&p) { const res = await Auth.register(u,p); if(res.error) Toast.show(res.error,'error'); else { Toast.show('Account created','success'); this.nav('dashboard'); } } },
            renderAdmin(container) { container.innerHTML = `<div class="p-8 max-w-2xl mx-auto"><h2 class="text-2xl font-bold text-navy mb-6">Settings</h2><div class="bg-white p-6 rounded shadow border border-gray-200"><h3 class="text-xs font-bold text-orange uppercase tracking-widest mb-4">Data Management</h3><div class="p-4 border border-dashed border-gray-300 rounded bg-gray-50 text-center cursor-pointer hover:bg-blue-50 transition"><i class="fa-solid fa-upload text-gray-400 mb-2"></i><div class="text-xs font-bold text-navy">Import Curriculum.json</div></div></div></div>`; }
        };

        document.addEventListener('DOMContentLoaded', () => app.start());
    </script>
    <style>
        .rotate-y-180 { transform: rotateY(180deg); }
        .transform-style-3d { transform-style: preserve-3d; }
        .backface-hidden { backface-visibility: hidden; -webkit-backface-visibility: hidden; }
        .perspective-1000 { perspective: 1000px; }
    </style>
</body>
</html>
