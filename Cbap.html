<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CBAP Master - GitHub Edition v4.1</title>
    <!-- Tailwind Config -->
    <script>
        window.tailwind = {
            config: {
                theme: {
                    extend: {
                        colors: {
                            navy: { DEFAULT: '#003366', light: '#004080', dark: '#002244' },
                            orange: { DEFAULT: '#FF6600', light: '#FF8533' },
                            grey: { line: '#E5E5E5', bg: '#F5F5F5', text: '#666666' }
                        },
                        fontFamily: { sans: ['Helvetica Neue', 'Helvetica', 'Arial', 'sans-serif'] },
                        borderRadius: { 'swiss': '2px' },
                        boxShadow: { 'swiss': '0 1px 2px rgba(0,0,0,0.05)' }
                    }
                }
            }
        }
    </script>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Fix CORS/Tracking Errors by adding crossorigin="anonymous" -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <script src="https://cdn.jsdelivr.net/npm/chart.js" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    
    <style>
        body { font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif; background-color: #FFFFFF; color: #333; }
        .swiss-card { background: #FFFFFF; border: 1px solid #E5E5E5; border-radius: 0px; }
        .swiss-btn { border-radius: 0px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; font-size: 0.8rem; transition: all 0.2s ease; cursor: pointer; }
        .swiss-btn-primary { background-color: #003366; color: white; border: 1px solid #003366; }
        .swiss-btn-primary:hover { background-color: #002244; }
        .swiss-btn-accent { background-color: #FF6600; color: white; border: 1px solid #FF6600; }
        .swiss-btn-outline { background-color: transparent; color: #003366; border: 1px solid #003366; }
        .swiss-btn-outline:hover { background-color: #F0F4F8; }
        .lib-tab { border-bottom: 2px solid transparent; color: #999; transition: all 0.3s; }
        .lib-tab:hover { color: #003366; }
        .lib-tab.active { border-bottom: 2px solid #FF6600; color: #003366; font-weight: bold; }
        .nav-item { border-left: 4px solid transparent; color: #666; }
        .nav-item.active { background-color: #F8F9FA; color: #003366; border-left: 4px solid #FF6600; font-weight: bold; }
        .perspective-1000 { perspective: 1000px; }
        .transform-style-3d { transform-style: preserve-3d; }
        .backface-hidden { backface-visibility: hidden; }
        .rotate-y-180 { transform: rotateY(180deg); }
        .card-container.flipped .card-inner { transform: rotateY(180deg); }
        #activityCanvas { width: 100%; height: 100%; background: #FFFFFF; }
        #toast-container { position: fixed; bottom: 20px; right: 20px; z-index: 50; display: flex; flex-direction: column; gap: 10px; }
        .toast { min-width: 250px; background: white; border: 1px solid #003366; border-left: 6px solid #FF6600; padding: 16px; box-shadow: 0 5px 15px rgba(0,0,0,0.1); animation: slideIn 0.3s ease-out forwards; display: flex; align-items: center; gap: 12px; }
        @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        h1, h2, h3, h4, h5, h6 { font-weight: 700; letter-spacing: -0.5px; color: #003366; }
        .grid-bg { background-size: 40px 40px; background-image: linear-gradient(to right, #f0f0f0 1px, transparent 1px), linear-gradient(to bottom, #f0f0f0 1px, transparent 1px); }
        
        /* Loading Overlay */
        #loading-overlay { position: fixed; inset: 0; background: rgba(255,255,255,0.98); z-index: 100; display: flex; flex-direction: column; align-items: center; justify-content: center; transition: opacity 0.5s; }
        #error-log { display: none; margin-top: 20px; padding: 15px; background: #FFF0F0; border: 1px solid #FFCDCD; color: #D8000C; font-family: monospace; font-size: 12px; white-space: pre-wrap; max-width: 90%; text-align: left; overflow-x: auto; max-height: 250px; overflow-y: auto; width: 600px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        
        /* Success Message styling within log */
        .log-success { color: #008000; font-weight: bold; }
    </style>
</head>
<body class="h-screen flex overflow-hidden text-slate-800 bg-white">

    <!-- LOADING OVERLAY -->
    <div id="loading-overlay">
        <div class="w-12 h-12 border-4 border-navy border-t-orange rounded-full animate-spin mb-4" id="spinner"></div>
        <h2 class="text-navy font-bold text-xl" id="loading-title">System Initializing</h2>
        <p class="text-gray-500 text-sm mt-2 font-mono" id="loading-text">Resolving paths...</p>
        <div id="error-log"></div>
        
        <div id="loading-controls" class="hidden flex gap-4 mt-6">
            <button onclick="location.reload()" class="swiss-btn swiss-btn-primary px-6 py-2">Retry</button>
            <button onclick="app.closeLoading()" class="swiss-btn swiss-btn-accent px-6 py-2">Force Enter Dashboard</button>
        </div>
    </div>

    <!-- SIDEBAR -->
    <aside class="w-16 lg:w-64 bg-white border-r border-grey-line flex flex-col z-20 transition-all duration-300 flex-shrink-0">
        <div class="h-16 lg:h-20 flex items-center justify-center lg:justify-start lg:px-6 border-b border-grey-line">
            <div class="w-8 h-8 bg-navy text-white flex items-center justify-center font-bold text-lg rounded-none">C</div>
            <span class="ml-3 font-bold text-xl hidden lg:block tracking-tight text-navy">CBAP<span class="text-orange">.PRO</span></span>
        </div>
        
        <nav class="flex-1 py-4 lg:py-6 space-y-1 overflow-y-auto">
            <button onclick="app.navigate('dashboard')" id="nav-dashboard" class="nav-item w-full flex items-center justify-center lg:justify-start p-3 lg:p-4 transition-all group hover:bg-gray-50">
                <i class="fa-solid fa-chart-pie text-lg w-6 text-center"></i><span class="hidden lg:block font-medium text-sm uppercase tracking-wide ml-3">Dashboard</span>
            </button>
            <button onclick="app.navigate('learn')" id="nav-learn" class="nav-item w-full flex items-center justify-center lg:justify-start p-3 lg:p-4 transition-all group hover:bg-gray-50">
                <i class="fa-solid fa-book-open text-lg w-6 text-center"></i><span class="hidden lg:block font-medium text-sm uppercase tracking-wide ml-3">Knowledge Hub</span>
            </button>
            <button onclick="app.navigate('library')" id="nav-library" class="nav-item w-full flex items-center justify-center lg:justify-start p-3 lg:p-4 transition-all group hover:bg-gray-50">
                <i class="fa-solid fa-book-journal-whills text-lg w-6 text-center"></i><span class="hidden lg:block font-medium text-sm uppercase tracking-wide ml-3">Library</span>
            </button>
            <button onclick="app.navigate('exam')" id="nav-exam" class="nav-item w-full flex items-center justify-center lg:justify-start p-3 lg:p-4 transition-all group hover:bg-gray-50">
                <i class="fa-solid fa-pen-ruler text-lg w-6 text-center"></i><span class="hidden lg:block font-medium text-sm uppercase tracking-wide ml-3">Exam Engine</span>
            </button>
            <button onclick="app.navigate('flashcards')" id="nav-flashcards" class="nav-item w-full flex items-center justify-center lg:justify-start p-3 lg:p-4 transition-all group hover:bg-gray-50">
                <i class="fa-solid fa-clone text-lg w-6 text-center"></i><span class="hidden lg:block font-medium text-sm uppercase tracking-wide ml-3">Flashcards</span>
            </button>
            <button onclick="app.navigate('help')" id="nav-help" class="nav-item w-full flex items-center justify-center lg:justify-start p-3 lg:p-4 transition-all group hover:bg-gray-50">
                <i class="fa-solid fa-circle-question text-lg w-6 text-center"></i><span class="hidden lg:block font-medium text-sm uppercase tracking-wide ml-3">Guide</span>
            </button>
             <button onclick="app.navigate('admin')" id="nav-admin" class="nav-item w-full flex items-center justify-center lg:justify-start p-3 lg:p-4 transition-all group hover:bg-gray-50">
                <i class="fa-solid fa-sliders text-lg w-6 text-center"></i><span class="hidden lg:block font-medium text-sm uppercase tracking-wide ml-3">Settings</span>
            </button>
        </nav>
        
        <div class="p-6 border-t border-grey-line hidden lg:block">
            <div class="text-[10px] uppercase tracking-widest text-gray-400">System v4.1</div>
            <div class="text-xs font-bold text-navy mt-1">BABOK® Aligned</div>
        </div>
    </aside>

    <!-- MAIN VIEW -->
    <main class="flex-1 flex flex-col relative overflow-hidden bg-white w-full">
        <!-- Header -->
        <header class="h-16 lg:h-20 bg-white border-b border-grey-line flex items-center justify-between px-4 lg:px-8 sticky top-0 z-10 flex-shrink-0">
            <div>
                <h2 id="page-title" class="text-lg lg:text-2xl font-bold text-navy uppercase tracking-tight">Overview</h2>
                <div class="h-1 w-8 lg:w-12 bg-orange mt-1"></div>
            </div>
            <div class="flex items-center gap-3 lg:gap-6">
                <div class="text-right hidden sm:block">
                    <div class="text-[10px] lg:text-xs font-bold text-gray-400 uppercase tracking-wider">Candidate Profile</div>
                    <div class="font-bold text-navy text-sm lg:text-base">User</div>
                </div>
                <div class="w-8 h-8 lg:w-10 lg:h-10 border border-navy flex items-center justify-center text-navy font-bold hover:bg-navy hover:text-white transition cursor-pointer">
                    <i class="fa-solid fa-user text-sm"></i>
                </div>
            </div>
        </header>

        <!-- Dynamic Content -->
        <div id="app-container" class="flex-1 overflow-y-auto p-4 lg:p-8 grid-bg w-full"></div>
    </main>

    <div id="toast-container"></div>

    <!-- JAVASCRIPT LOGIC -->
    <script>
        const Toast = {
            show(msg, type = 'info') {
                const container = document.getElementById('toast-container');
                const div = document.createElement('div');
                div.className = 'toast';
                const icon = type === 'success' ? '<i class="fa-solid fa-check text-orange"></i>' : (type === 'error' ? '<i class="fa-solid fa-triangle-exclamation text-red-600"></i>' : '<i class="fa-solid fa-info text-navy"></i>');
                div.innerHTML = `${icon} <span class="text-sm font-bold text-navy uppercase tracking-wide">${msg}</span>`;
                container.appendChild(div);
                setTimeout(() => { div.style.opacity = '0'; div.style.transform = 'translateX(100%)'; setTimeout(() => div.remove(), 300); }, 3000);
            }
        };

        const DB = {
            key: 'CBAP_CANVAS_V4_1_FIXED',
            state: { user: { name: 'User', xp: 0 }, questions: [], flashcards: [], attempts: [], curriculum: [] },
            
            async init() {
                const data = localStorage.getItem(this.key);
                if (data) {
                    try {
                        this.state = JSON.parse(data);
                    } catch(e) {
                        console.error("Local data corrupted, resetting.");
                        localStorage.removeItem(this.key);
                    }
                    
                    if(!this.state.curriculum || this.state.curriculum.length === 0) {
                        await this.seedFromJSON();
                    } else {
                        document.getElementById('loading-overlay').classList.add('hidden');
                        app.navigate('dashboard'); // Ensure navigation happens
                    }
                } else {
                    await this.seedFromJSON();
                }
            },

            async seedFromJSON() {
                const overlay = document.getElementById('loading-overlay');
                const loadingText = document.getElementById('loading-text');
                const errorLog = document.getElementById('error-log');
                const controls = document.getElementById('loading-controls');
                
                overlay.classList.remove('hidden');
                // Don't clear error log if it has useful info from previous attempts
                
                // Show controls if it takes too long
                setTimeout(() => {
                    if(!overlay.classList.contains('hidden')) {
                        controls.classList.remove('hidden');
                        loadingText.innerText = "Processing Complete. Click 'Force Enter' if stuck.";
                    }
                }, 2000);

                // List of possible folder names to try (GitHub Case Sensitivity Fix)
                const folders = ['CbapMedia', 'cbapmedia', 'CBAPMEDIA'];
                const filenames = ['curriculum.json', 'questions.json', 'flashcards.json'];
                
                let foundFolder = null;

                try {
                    // Step 1: Detect correct folder
                    loadingText.innerText = "Detecting data folder...";
                    for(let folder of folders) {
                        try {
                            const testUrl = `${folder}/curriculum.json?v=${new Date().getTime()}`;
                            const res = await fetch(testUrl, { method: 'HEAD', cache: 'no-store' });
                            if(res.ok) {
                                foundFolder = folder;
                                console.log("Found data folder:", foundFolder);
                                break;
                            }
                        } catch(e) { console.log(`Skipping ${folder}`); }
                    }

                    if (!foundFolder) foundFolder = 'CbapMedia'; // Default

                    // Step 2: Fetch files
                    let successCount = 0;
                    for (const name of filenames) {
                        loadingText.innerText = `Fetching ${name}...`;
                        const path = `${foundFolder}/${name}`;
                        
                        try {
                            const response = await fetch(`${path}?v=${new Date().getTime()}`, { cache: "no-store" });
                            if (!response.ok) throw new Error(`Status ${response.status}`);
                            
                            let text = await response.text();
                            if (text.charCodeAt(0) === 0xFEFF) text = text.slice(1); // Strip BOM
                            
                            if (text.trim().startsWith('<')) throw new Error("File content is HTML/404");

                            const json = JSON.parse(text);
                            const key = name.replace('.json', '');
                            this.state[key] = json;
                            successCount++;
                            errorLog.style.display = 'block';
                            errorLog.innerHTML += `<div class="mb-1 log-success">✅ Loaded ${name} from ${foundFolder}</div>`;
                        } catch (e) {
                            const msg = `Failed ${name}`;
                            console.warn(msg, e);
                            errorLog.style.display = 'block';
                            errorLog.innerHTML += `<div class="mb-1 text-red-600 text-xs">❌ ${msg}: ${e.message}</div>`;
                            this.state[name.replace('.json', '')] = []; 
                        }
                    }

                    this.save();
                    
                    if (this.state.curriculum.length > 0) {
                        loadingText.innerText = "Initialization Complete";
                        // Force navigation without timeout to avoid getting stuck
                        overlay.classList.add('hidden');
                        Toast.show(`Loaded ${successCount} files`, "success");
                        app.navigate('dashboard');
                    } else {
                        throw new Error("Curriculum failed to load. Manual upload required.");
                    }

                } catch (error) {
                    console.error("Fatal:", error);
                    document.getElementById('spinner').classList.add('hidden');
                    document.getElementById('loading-title').innerText = "Load Failed";
                    document.getElementById('loading-title').classList.add('text-red-600');
                    loadingText.innerText = "Cannot auto-load data.";
                    errorLog.innerHTML += `<div class="mt-2 border-t border-red-200 pt-2 text-red-700 font-bold">${error.message}</div>`;
                    controls.classList.remove('hidden');
                }
            },

            save() { localStorage.setItem(this.key, JSON.stringify(this.state)); }
        };

        const app = {
            view: 'dashboard',
            start() { DB.init(); },

            closeLoading() {
                document.getElementById('loading-overlay').classList.add('hidden');
                if(DB.state.curriculum && DB.state.curriculum.length > 0) {
                    this.navigate('dashboard');
                } else {
                    this.navigate('admin');
                    Toast.show("Data missing. Please import manually.", "info");
                }
            },

            forceManualMode() {
                document.getElementById('loading-overlay').classList.add('hidden');
                this.navigate('admin');
                Toast.show("Manual Mode Activated", "info");
            },

            navigate(target, param = null) {
                this.view = target;
                document.querySelectorAll('.nav-item').forEach(el => { el.classList.remove('active'); if(el.id === `nav-${target}`) el.classList.add('active'); });
                const titles = { dashboard: 'Dashboard', learn: 'Knowledge Hub', library: 'Study Library', exam: 'Exam Engine', flashcards: 'Flashcards', help: 'User Guide', admin: 'Data Admin' };
                document.getElementById('page-title').innerText = titles[target] || 'CBAP Master';
                const container = document.getElementById('app-container');
                container.innerHTML = '';
                
                try {
                    switch(target) {
                        case 'dashboard': this.renderDashboard(container); break;
                        case 'learn': this.renderLearn(container); break;
                        case 'library': this.renderLibrary(container, param); break;
                        case 'task_detail': this.renderTaskDetail(container, param); break;
                        case 'exam': this.renderExam(container); break;
                        case 'flashcards': this.renderFlashcards(container); break;
                        case 'help': this.renderHelp(container); break;
                        case 'admin': this.renderAdmin(container); break;
                    }
                } catch(e) {
                    console.error("Render Error:", e);
                    container.innerHTML = `<div class="p-8 text-red-600">Error rendering view: ${e.message}</div>`;
                }
            },

            toggleFullscreen(elementId) {
                const elem = document.getElementById(elementId);
                if (!elem) return;
                if (!document.fullscreenElement) { if (elem.requestFullscreen) elem.requestFullscreen(); } 
                else { if (document.exitFullscreen) document.exitFullscreen(); }
            },

            renderDashboard(container) {
                const totalCards = DB.state.flashcards ? DB.state.flashcards.length : 0;
                const totalQ = DB.state.questions ? DB.state.questions.length : 0;
                
                // Safe Chart Init (fixes chart.js storage error crash)
                setTimeout(() => { 
                    const canvas = document.getElementById('activityCanvas');
                    if(canvas) {
                        const ctx = canvas.getContext('2d');
                        ctx.fillStyle = '#FFFFFF'; ctx.fillRect(0,0,canvas.width,canvas.height); // Fallback bg
                        // Canvas visualizer logic here if needed
                    }
                }, 100);

                if (totalQ === 0) {
                    container.innerHTML = `<div class="flex flex-col items-center justify-center h-full text-center p-8"><div class="w-20 h-20 bg-gray-100 rounded-full flex items-center justify-center mb-6 text-gray-400 text-3xl"><i class="fa-solid fa-database"></i></div><h2 class="text-2xl font-bold text-navy mb-2">No Data Available</h2><p class="text-gray-500 max-w-md mb-8">Data load failed or blocked. Please import manually.</p><button onclick="app.navigate('admin')" class="swiss-btn swiss-btn-primary px-8 py-3">Go to Settings</button></div>`;
                    return;
                }

                container.innerHTML = `
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 lg:gap-8 mb-8">
                        <div class="swiss-card lg:col-span-2 relative h-[250px] lg:h-[300px] flex flex-col">
                            <div class="absolute inset-0 z-0"><canvas id="activityCanvas"></canvas></div>
                            <div class="relative z-10 p-6 pointer-events-none"><h3 class="font-bold text-navy uppercase text-xs tracking-widest mb-2">System Status</h3><div class="text-3xl lg:text-4xl font-bold text-navy mb-4">ACTIVE</div><div class="inline-block border border-orange text-orange px-2 py-1 text-xs font-bold uppercase bg-white">Ready</div></div>
                            <div class="relative z-10 mt-auto p-4 lg:p-6 grid grid-cols-3 gap-4 border-t border-grey-line bg-white/90">
                                <div class="text-center border-r border-grey-line last:border-0"><div class="text-2xl lg:text-3xl font-bold text-navy">${totalCards}</div><div class="text-[9px] lg:text-[10px] text-gray-500 uppercase tracking-wider mt-1">Cards</div></div>
                                <div class="text-center border-r border-grey-line last:border-0"><div class="text-2xl lg:text-3xl font-bold text-navy">${totalQ}</div><div class="text-[9px] lg:text-[10px] text-gray-500 uppercase tracking-wider mt-1">Questions</div></div>
                                <div class="text-center"><div class="text-2xl lg:text-3xl font-bold text-navy">--</div><div class="text-[9px] lg:text-[10px] text-gray-500 uppercase tracking-wider mt-1">Sessions</div></div>
                            </div>
                        </div>
                        <div class="swiss-card p-6 flex flex-col justify-between">
                            <div><h3 class="font-bold text-navy uppercase text-xs tracking-widest mb-6">Quick Actions</h3><div class="w-full bg-gray-100 h-1 mb-6"><div class="bg-navy h-1" style="width: 100%"></div></div></div>
                            <div class="space-y-3 mt-6"><button onclick="app.navigate('library')" class="swiss-btn swiss-btn-accent w-full py-3 lg:py-4">Library <i class="fa-solid fa-book ml-2"></i></button><button onclick="app.navigate('exam')" class="swiss-btn swiss-btn-outline w-full py-3 lg:py-4">Start Quiz</button></div>
                        </div>
                    </div>
                `;
            },

            renderLibrary(container, params) {
                if(!DB.state.curriculum || !DB.state.curriculum.length) { app.navigate('admin'); return; }
                const activeCode = (params && params.code) ? params.code : DB.state.curriculum[0].code;
                const activeTab = (params && params.tab) ? params.tab : 'textbook';
                const chapters = DB.state.curriculum;
                const activeChapter = chapters.find(c => c.code === activeCode) || chapters[0];
                const mediaPath = 'CbapMedia/'; // Standardize path
                const files = { textbook: `${mediaPath}${activeCode}_Textbook.pdf`, info: `${mediaPath}${activeCode}_Info.png`, video: `${mediaPath}${activeCode}_Video.mp4`, mindmap: `${mediaPath}${activeCode}_Mindmap.png` };
                
                let contentHtml = '';
                if(activeTab === 'textbook') contentHtml = `<div class="h-full flex flex-col"><div class="flex-1 bg-gray-100 border border-grey-line flex items-center justify-center relative"><iframe src="${files.textbook}" class="w-full h-full" onerror="this.style.display='none'; document.getElementById('pdf-error').style.display='flex'"></iframe><div id="pdf-error" class="hidden absolute inset-0 flex flex-col items-center justify-center p-8 text-center"><i class="fa-solid fa-file-circle-xmark text-4xl text-gray-300 mb-4"></i><h4 class="font-bold text-gray-500">PDF Not Found</h4><p class="text-sm text-gray-400 mt-2">${files.textbook}<br>Ensure file exists in CbapMedia/</p></div></div></div>`;
                else if(activeTab === 'info' || activeTab === 'mindmap') contentHtml = `<div class="h-full overflow-y-auto bg-white flex items-center justify-center"><img src="${activeTab === 'info' ? files.info : files.mindmap}" class="max-w-full max-h-full border border-grey-line" alt="Image" onerror="this.src='https://via.placeholder.com/800x600?text=Image+Not+Found'"></div>`;
                else if(activeTab === 'video') contentHtml = `<div class="h-full flex flex-col items-center justify-center bg-black"><video controls class="w-full max-h-full"><source src="${files.video}" type="video/mp4"></video></div>`;

                container.innerHTML = `
                    <div class="flex flex-col lg:flex-row h-full lg:h-[calc(100vh-140px)] gap-6">
                        <div class="w-full lg:w-64 flex-shrink-0 overflow-y-auto swiss-card h-48 lg:h-full">
                            <div class="p-4 border-b border-grey-line bg-gray-50 sticky top-0 z-10"><div class="text-xs font-bold text-gray-400 uppercase tracking-widest">Index</div></div>
                            <div>${chapters.map(c => `<button onclick="app.navigate('library', {code: '${c.code}', tab: '${activeTab}'})" class="w-full text-left p-4 border-b border-grey-line hover:bg-gray-50 transition-colors ${c.code === activeCode ? 'bg-navy text-white hover:bg-navy' : 'text-gray-600'}"><div class="flex items-center justify-between"><span class="font-bold text-sm">${c.code}</span>${c.code === activeCode ? '<i class="fa-solid fa-chevron-right text-xs"></i>' : ''}</div><div class="text-xs mt-1 ${c.code === activeCode ? 'text-blue-200' : 'text-gray-400'} truncate">${c.name}</div></button>`).join('')}</div>
                        </div>
                        <div class="flex-1 flex flex-col swiss-card h-[500px] lg:h-full">
                            <div class="flex border-b border-grey-line items-center justify-between pr-4 bg-gray-50 overflow-x-auto">
                                <div class="flex flex-nowrap"><button onclick="app.navigate('library', {code: '${activeCode}', tab: 'textbook'})" class="px-4 lg:px-6 py-4 text-[10px] lg:text-xs font-bold uppercase tracking-widest lib-tab ${activeTab === 'textbook' ? 'active' : ''} whitespace-nowrap"><i class="fa-solid fa-book mr-2"></i> PDF</button><button onclick="app.navigate('library', {code: '${activeCode}', tab: 'info'})" class="px-4 lg:px-6 py-4 text-[10px] lg:text-xs font-bold uppercase tracking-widest lib-tab ${activeTab === 'info' ? 'active' : ''} whitespace-nowrap"><i class="fa-solid fa-image mr-2"></i> Info</button><button onclick="app.navigate('library', {code: '${activeCode}', tab: 'video'})" class="px-4 lg:px-6 py-4 text-[10px] lg:text-xs font-bold uppercase tracking-widest lib-tab ${activeTab === 'video' ? 'active' : ''} whitespace-nowrap"><i class="fa-solid fa-video mr-2"></i> Video</button><button onclick="app.navigate('library', {code: '${activeCode}', tab: 'mindmap'})" class="px-4 lg:px-6 py-4 text-[10px] lg:text-xs font-bold uppercase tracking-widest lib-tab ${activeTab === 'mindmap' ? 'active' : ''} whitespace-nowrap"><i class="fa-solid fa-sitemap mr-2"></i> Map</button></div>
                                <div class="flex items-center gap-3"><a href="${files.textbook}" target="_blank" class="text-xs font-bold text-gray-500 hover:text-navy" title="Open External"><i class="fa-solid fa-arrow-up-right-from-square"></i></a><button onclick="app.toggleFullscreen('lib-viewer')" class="text-xs font-bold text-gray-500 hover:text-navy" title="Fullscreen"><i class="fa-solid fa-expand text-lg"></i></button></div>
                            </div>
                            <div id="lib-viewer" class="flex-1 p-0 overflow-hidden bg-white relative">${contentHtml}</div>
                        </div>
                    </div>
                `;
            },

            renderLearn(container) {
                if(!DB.state.curriculum || !DB.state.curriculum.length) { app.navigate('admin'); return; }
                let html = `<div class="max-w-5xl mx-auto"><div class="mb-8 flex items-end justify-between border-b border-navy pb-4"><div><h2 class="text-3xl font-bold text-navy">Knowledge Map</h2><p class="text-gray-500 mt-2 text-sm">BABOK® Guide v3 Structure</p></div><div class="text-right hidden sm:block"><div class="text-4xl font-bold text-orange leading-none">${DB.state.curriculum.length}</div><div class="text-xs font-bold text-navy uppercase tracking-widest">Areas</div></div></div><div class="grid grid-cols-1 gap-px bg-grey-line border border-grey-line">`;
                DB.state.curriculum.forEach((ka, idx) => {
                    html += `<div class="bg-white p-6 group hover:bg-gray-50 transition-colors"><div class="flex items-start justify-between cursor-pointer" onclick="document.getElementById('ka-content-${idx}').classList.toggle('hidden');"><div class="flex gap-6"><div class="text-2xl font-bold text-gray-200 group-hover:text-orange transition-colors font-mono">${(idx+1).toString().padStart(2, '0')}</div><div><div class="flex items-center gap-3 mb-2"><span class="bg-navy text-white text-[10px] font-bold px-2 py-0.5 uppercase tracking-wider">${ka.code}</span></div><h3 class="text-xl font-bold text-navy mb-2">${ka.name}</h3><p class="text-sm text-gray-500 max-w-2xl">${ka.desc}</p></div></div><button class="swiss-btn-outline h-8 w-8 flex items-center justify-center border border-gray-200 text-gray-400 group-hover:border-navy group-hover:text-navy"><i class="fa-solid fa-plus text-xs"></i></button></div><div id="ka-content-${idx}" class="hidden mt-6 pl-14 pt-6 border-t border-dashed border-gray-200"><div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">${ka.tasks.map(t => `<div onclick="app.navigate('task_detail', {kaId: '${ka.code}', taskId: '${t.id}'})" class="border border-gray-200 p-4 hover:border-orange cursor-pointer transition-colors bg-white hover:shadow-sm"><div class="text-xs font-bold text-gray-400 mb-2 uppercase">Task ${t.id}</div><h4 class="font-bold text-navy text-sm leading-tight">${t.name}</h4></div>`).join('')}</div></div></div>`;
                });
                html += `</div></div>`;
                container.innerHTML = html;
            },

            renderTaskDetail(container, param) {
                const ka = DB.state.curriculum.find(k => k.code === param.kaId);
                const task = ka.tasks.find(t => t.id === param.taskId);
                container.innerHTML = `<div class="max-w-5xl mx-auto"><button onclick="app.navigate('learn')" class="mb-4 text-xs font-bold text-gray-500 hover:text-navy uppercase tracking-widest"><i class="fa-solid fa-arrow-left"></i> Back</button><div class="swiss-card p-10 border-t-4 border-t-navy"><h1 class="text-3xl font-bold text-navy mb-4">${task.name}</h1><p class="text-gray-600">Detailed content maps would appear here.</p></div></div>`;
            },
            
            renderExam(container) { container.innerHTML = `<div class="max-w-xl mx-auto mt-12 text-center"><h2 class="text-3xl font-bold text-navy mb-2">Exam Simulation</h2><p class="text-gray-500 mb-6">Questions Loaded: ${DB.state.questions ? DB.state.questions.length : 0}</p><button onclick="app.startQuiz()" class="swiss-btn swiss-btn-primary px-8 py-3">Start Random Drill</button></div>`; },
            
            startQuiz() { 
                const questions = DB.state.questions ? DB.state.questions.slice(0, 5) : [];
                if(!questions.length) { document.getElementById('app-container').innerHTML = `<div class="text-center p-8">No questions loaded. Please import <b>questions.json</b> in Settings.</div>`; return; }
                const container = document.getElementById('app-container');
                let html = `<div class="max-w-3xl mx-auto"><h2 class="text-2xl font-bold text-navy mb-6">Quick Drill</h2>`;
                questions.forEach((q, i) => {
                    html += `<div class="swiss-card p-6 mb-4"><div class="text-xs font-bold text-gray-400 mb-2">Q${i+1} (${q.ka})</div><div class="font-bold text-navy mb-4">${q.stem}</div><div class="space-y-2">${q.options.map(o => `<div class="p-3 border border-gray-200 hover:bg-gray-50 cursor-pointer">${o}</div>`).join('')}</div></div>`;
                });
                html += `<div class="text-center mt-6"><button onclick="app.navigate('dashboard')" class="swiss-btn swiss-btn-accent px-8 py-3">Finish & Review</button></div></div>`;
                container.innerHTML = html;
            },

            renderFlashcards(container) { container.innerHTML = `<div class="p-8 text-center text-gray-400">Flashcards Loaded: ${DB.state.flashcards ? DB.state.flashcards.length : 0}<br>SRS Module Ready</div>`; },
            
            renderHelp(container) { container.innerHTML = `<div class="max-w-4xl mx-auto"><h2 class="text-3xl font-bold text-navy mb-6">User Guide</h2><div class="swiss-card p-8 border-l-4 border-orange"><h3 class="font-bold text-navy mb-2">Troubleshooting Load Errors</h3><p class="text-sm text-gray-600">If auto-loading fails, check: <br>1. Folder <b>CbapMedia</b> exists in the same place as Cbap.html.<br>2. JSON files are valid.<br>3. Try using the <b>Settings > Manual Import</b> feature.</p></div></div>`; },
            
            renderAdmin(container) { 
                container.innerHTML = `
                    <div class="max-w-2xl mx-auto">
                        <h2 class="text-3xl font-bold text-navy mb-6">Settings & Data</h2>
                        
                        <div class="swiss-card p-8 mb-6 border-l-4 border-navy">
                            <h3 class="font-bold text-navy mb-4 flex items-center"><i class="fa-solid fa-file-import mr-2"></i> Manual Data Import</h3>
                            <p class="text-sm text-gray-500 mb-6">Use this if auto-loading from folder fails (e.g. CORS error).</p>
                            
                            <div class="space-y-4">
                                <div><label class="block text-xs font-bold text-gray-400 uppercase tracking-wide mb-1">Curriculum</label><input type="file" class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:border-0 file:bg-navy file:text-white hover:file:bg-opacity-90" accept=".json" onchange="app.handleFileSelect(this, 'curriculum')"></div>
                                <div><label class="block text-xs font-bold text-gray-400 uppercase tracking-wide mb-1">Questions</label><input type="file" class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:border-0 file:bg-navy file:text-white hover:file:bg-opacity-90" accept=".json" onchange="app.handleFileSelect(this, 'questions')"></div>
                                <div><label class="block text-xs font-bold text-gray-400 uppercase tracking-wide mb-1">Flashcards</label><input type="file" class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:border-0 file:bg-navy file:text-white hover:file:bg-opacity-90" accept=".json" onchange="app.handleFileSelect(this, 'flashcards')"></div>
                            </div>
                        </div>

                        <div class="swiss-card p-6 flex justify-between items-center">
                            <div><h3 class="font-bold text-navy">Retry Auto-Load</h3><p class="text-xs text-gray-500">Attempt to fetch from CbapMedia folder</p></div>
                            <button onclick="DB.seedFromJSON()" class="swiss-btn swiss-btn-outline px-4 py-2">Reload</button>
                        </div>
                    </div>
                `; 
            },

            handleFileSelect(input, type) {
                const file = input.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const json = JSON.parse(e.target.result);
                        DB.state[type] = json;
                        DB.save();
                        Toast.show(`Imported ${type} successfully!`, "success");
                    } catch(err) { alert("Invalid JSON file"); console.error(err); }
                };
                reader.readAsText(file);
            }
        };

        app.start();
    </script>
</body>
</html>
