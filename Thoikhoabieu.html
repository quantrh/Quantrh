<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- Ti√™u ƒë·ªÅ s·∫Ω ƒë∆∞·ª£c c·∫≠p nh·∫≠t ƒë·ªông b·∫±ng JavaScript -->
    <title id="scheduleTitle">L·ªãch H·ªçc & T·∫≠p T·ªïng H·ª£p</title>
    <!-- T·∫£i Google Font: Be Vietnam Pro (h·ªó tr·ª£ ti·∫øng Vi·ªát) -->
    <link href="https://fonts.googleapis.com/css2?family=Be+Vietnam+Pro:wght@400;600;800&display=swap" rel="stylesheet">
    <!-- T·∫£i Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Thi·∫øt l·∫≠p c·∫•u h√¨nh Tailwind ƒë·ªÉ s·ª≠ d·ª•ng font Be Vietnam Pro v√† m√†u s·∫Øc t√πy ch·ªânh -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        // M√†u Ch√≠nh Kh√≥a - Indigo
                        'primary-class': '#4f46e5',
                        // M√†u L·ªãch T·∫≠p - Green
                        'secondary-study': '#10b981',
                        // M√†u H·ªçc Th√™m/T·ªëi - Rose
                        'tertiary-evening': '#f43f5e',
                        // M√ÄU L·ªäCH THI - Amber/Orange
                        'exam-color': '#f59e0b',
                    },
                    fontFamily: {
                        sans: ['"Be Vietnam Pro"', 'Inter', 'sans-serif'], // Thay ƒë·ªïi font
                    }
                }
            }
        }
    </script>
    <style>
        /* ƒê·∫£m b·∫£o to√†n b·ªô trang s·ª≠ d·ª•ng font Be Vietnam Pro */
        body {
            font-family: 'Be Vietnam Pro', sans-serif;
            background-color: #f8fafc; /* M√†u n·ªÅn nh·∫π nh√†ng (slate-50) */
        }
        /* Hi·ªáu ·ª©ng khi ·∫©n/hi·ªán */
        .activity-item {
            transition: all 0.3s ease-in-out;
        }
        /* Style cho Modal Overlay */
        .modal-overlay {
            z-index: 1000;
            background-color: rgba(0, 0, 0, 0.6);
        }
        /* Style cho Alert Message */
        #alert-box {
            z-index: 1001;
            transition: transform 0.3s ease-out, opacity 0.3s ease-out;
        }
        /* Th·∫ª ng√†y ·∫©n khi filter */
        .activity-item.hidden {
            display: none !important;
        }
    </style>
</head>
<body class="p-4 sm:p-8">

    <div class="max-w-4xl mx-auto">
        <!-- Ti√™u ƒë·ªÅ l·ªõn -->
        <header class="text-center mb-6 p-4 bg-white shadow-lg rounded-xl border-t-4 border-primary-class">
            <h1 class="3xl sm:text-4xl font-extrabold text-gray-900 flex items-center justify-center">
                <span class="mr-3 text-4xl">üóì</span> L·ªäCH H·ªåC & T·∫¨P T·ªîNG H·ª¢P
            </h1>
            <!-- C·∫≠p nh·∫≠t ph·∫°m vi ng√†y hi·ªÉn th·ªã -->
            <p id="dateRangeDisplay" class="mt-2 text-lg font-medium text-primary-class">
                ƒêang t·∫£i l·ªãch...
            </p>
            
            <!-- N√∫t Qu·∫£n l√Ω L·ªãch -->
            <button
                onclick="openManageEventModal('add')"
                class="mt-4 bg-teal-500 text-white font-semibold py-2 px-4 rounded-full transition-colors duration-200 hover:bg-teal-600 shadow-lg text-sm flex items-center mx-auto"
            >
                <span class="mr-2">‚ûï</span> Th√™m S·ª± Ki·ªán M·ªõi
            </button>
        </header>

        <!-- Thanh ƒêi·ªÅu H∆∞·ªõng Tu·∫ßn -->
        <div class="mb-4 flex justify-between items-center p-4 bg-white rounded-xl shadow-md">
            <button
                onclick="navigateWeek(-1)"
                class="bg-indigo-500 text-white font-semibold py-2 px-4 rounded-full transition-colors duration-200 hover:bg-indigo-600 shadow-md flex items-center text-sm"
            >
                <span class="mr-1">‚óÄ</span> Tu·∫ßn Tr∆∞·ªõc
            </button>
            <button
                onclick="resetDate()"
                class="bg-gray-200 text-gray-800 font-semibold py-2 px-4 rounded-full transition-colors duration-200 hover:bg-gray-300 shadow-md text-sm"
            >
                Tu·∫ßn G·ªëc
            </button>
            <button
                onclick="navigateWeek(1)"
                class="bg-indigo-500 text-white font-semibold py-2 px-4 rounded-full transition-colors duration-200 hover:bg-indigo-600 shadow-md flex items-center text-sm"
            >
                Tu·∫ßn Sau <span class="ml-1">‚ñ∂</span>
            </button>
        </div>

        <!-- B·ªô l·ªçc (Filters) -->
        <div id="filters" class="mb-8 p-4 bg-white rounded-xl shadow-md flex flex-wrap justify-center gap-3">
            <button data-filter="official" onclick="filterSchedule('official')" class="filter-btn bg-primary-class text-white font-semibold py-2 px-4 rounded-full text-sm transition-colors duration-200 hover:opacity-90 shadow-md flex items-center">
                <span class="mr-2">üéí</span> Ch√≠nh Kh√≥a
            </button>
            <button data-filter="extra" onclick="filterSchedule('extra')" class="filter-btn bg-tertiary-evening text-white font-semibold py-2 px-4 rounded-full text-sm transition-colors duration-200 hover:opacity-90 shadow-md flex items-center">
                <span class="mr-2">üí°</span> H·ªçc Th√™m
            </button>
            <button data-filter="study" onclick="filterSchedule('study')" class="filter-btn bg-secondary-study text-white font-semibold py-2 px-4 rounded-full text-sm transition-colors duration-200 hover:opacity-90 shadow-md flex items-center">
                <span class="mr-2">üèãÔ∏è</span> L·ªãch T·∫≠p
            </button>
            <button data-filter="exam" onclick="filterSchedule('exam')" class="filter-btn bg-exam-color text-white font-semibold py-2 px-4 rounded-full text-sm transition-colors duration-200 hover:opacity-90 shadow-md flex items-center">
                <span class="mr-2">üíØ</span> L·ªãch Thi
            </button>
        </div>

        <!-- Container cho c√°c th·∫ª ng√†y (N∆°i l·ªãch ƒë∆∞·ª£c render) -->
        <div id="scheduleContainer" class="space-y-6">
            <!-- N·ªôi dung l·ªãch s·∫Ω ƒë∆∞·ª£c ch√®n ·ªü ƒë√¢y b·ªüi JavaScript -->
        </div>

    </div>

    <!-- Alert Box (H·ªôp th√¥ng b√°o t√πy ch·ªânh) -->
    <div id="alert-box" class="fixed top-5 right-5 p-4 rounded-lg shadow-xl text-white opacity-0 transform translate-x-full transition duration-300 pointer-events-none" style="min-width: 250px;">
        <p id="alert-message" class="font-semibold"></p>
    </div>

    <!-- Modal Qu·∫£n L√Ω S·ª± Ki·ªán (Th√™m / S·ª≠a) -->
    <div id="manageEventModal" class="fixed inset-0 hidden modal-overlay items-center justify-center p-4">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-lg p-6 transform transition-all duration-300 scale-95 opacity-0" id="modal-content">
            <h3 class="text-2xl font-bold text-gray-800 mb-4 border-b pb-2 flex justify-between items-center">
                <span id="modal-title">Qu·∫£n L√Ω S·ª± Ki·ªán</span>
                <button onclick="closeManageEventModal()" class="text-gray-400 hover:text-gray-600">&times;</button>
            </h3>
            <form id="manageEventForm" onsubmit="handleManageEvent(event)">
                <input type="hidden" id="eventId">
                <input type="hidden" id="eventType">
                
                <div class="space-y-4">
                    <!-- Lo·∫°i L·ªãch (C·ªë ƒê·ªãnh / L·∫∑p L·∫°i) -->
                    <div>
                        <label for="recurrenceTypeSelect" class="block text-sm font-medium text-gray-700">Lo·∫°i L·ªãch</label>
                        <select id="recurrenceTypeSelect" onchange="toggleRecurrenceFields(this.value)" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2 focus:ring-primary-class focus:border-primary-class">
                            <option value="fixed">S·ª± ki·ªán C·ªë ƒê·ªãnh (Ng√†y c·ª• th·ªÉ)</option>
                            <option value="weekly">L·∫∑p l·∫°i H√†ng Tu·∫ßn (Theo Th·ª©)</option>
                            <!-- T·∫°m th·ªùi ·∫©n c√°c t√πy ch·ªçn ph·ª©c t·∫°p h∆°n -->
                            <!-- <option value="monthly" disabled>L·∫∑p l·∫°i H√†ng Th√°ng (Ch∆∞a h·ªó tr·ª£)</option>
                            <option value="yearly" disabled>L·∫∑p l·∫°i H√†ng NƒÉm (Ch∆∞a h·ªó tr·ª£)</option> -->
                        </select>
                    </div>

                    <!-- Tr∆∞·ªùng L·ªãch C·ªë ƒê·ªãnh -->
                    <div id="fixedFields" class="space-y-4">
                        <label for="eventDate" class="block text-sm font-medium text-gray-700">Ng√†y (YYYY-MM-DD)</label>
                        <input type="date" id="eventDate" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2 focus:ring-primary-class focus:border-primary-class">
                    </div>

                    <!-- Tr∆∞·ªùng L·ªãch L·∫∑p L·∫°i -->
                    <div id="recurringFields" class="space-y-4 hidden border p-4 rounded-lg bg-gray-50">
                         <h4 class="text-base font-semibold text-gray-800">C√†i ƒë·∫∑t L·∫∑p l·∫°i H√†ng Tu·∫ßn</h4>
                        
                         <!-- Ch·ªçn Th·ª© trong tu·∫ßn -->
                        <div>
                            <label for="eventDayIndex" class="block text-sm font-medium text-gray-700">Th·ª© trong tu·∫ßn (√°p d·ª•ng cho l·ªãch l·∫∑p l·∫°i)</label>
                            <select id="eventDayIndex" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2 focus:ring-primary-class focus:border-primary-class">
                                <option value="1">Th·ª© 2</option>
                                <option value="2">Th·ª© 3</option>
                                <option value="3">Th·ª© 4</option>
                                <option value="4">Th·ª© 5</option>
                                <option value="5">Th·ª© 6</option>
                                <option value="6">Th·ª© 7</option>
                                <option value="0">Ch·ªß nh·∫≠t</option>
                            </select>
                        </div>
                        
                        <!-- Ng√†y H·∫øt H·∫°n -->
                        <div>
                            <label for="eventRecurrenceEnd" class="block text-sm font-medium text-gray-700">Ng√†y H·∫øt H·∫°n L·∫∑p L·∫°i (YYYY-MM-DD)</label>
                            <input type="date" id="eventRecurrenceEnd" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2 focus:ring-primary-class focus:border-primary-class">
                        </div>
                    </div>


                    <!-- Tr∆∞·ªùng th√¥ng tin chung -->
                    <div>
                        <label for="eventTime" class="block text-sm font-medium text-gray-700">Th·ªùi gian (VD: 13h00 ‚Äì 14h00)</label>
                        <input type="text" id="eventTime" placeholder="VD: 13h00 ‚Äì 14h00" required class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2 focus:ring-primary-class focus:border-primary-class">
                    </div>
                    <div>
                        <label for="eventSubject" class="block text-sm font-medium text-gray-700">N·ªôi dung / M√¥n h·ªçc</label>
                        <input type="text" id="eventSubject" placeholder="VD: Thi V·∫≠t l√Ω" required class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2 focus:ring-primary-class focus:border-primary-class">
                    </div>
                    <div>
                        <label for="eventDetail" class="block text-sm font-medium text-gray-700">Chi ti·∫øt / Ghi ch√∫</label>
                        <input type="text" id="eventDetail" placeholder="VD: L·ªãch Thi - Ti·∫øt 2" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2">
                    </div>
                    <!-- Danh m·ª•c -->
                    <div>
                        <label for="eventCategory" class="block text-sm font-medium text-gray-700">Danh m·ª•c</label>
                        <select id="eventCategory" required onchange="updateDetailPlaceholder(this.value)" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2 focus:ring-primary-class focus:border-primary-class">
                            <option value="official">üéí Ch√≠nh Kh√≥a</option>
                            <option value="extra">üí° H·ªçc Th√™m</option>
                            <option value="study">üèãÔ∏è L·ªãch T·∫≠p</option>
                            <option value="exam">üíØ L·ªãch Thi</option>
                        </select>
                    </div>
                </div>
                <!-- N√∫t Submit -->
                <div class="mt-6 flex justify-end">
                    <button type="button" onclick="closeManageEventModal()" class="mr-3 py-2 px-4 border border-gray-300 rounded-md text-sm font-medium text-gray-700 hover:bg-gray-50">
                        H·ªßy
                    </button>
                    <button type="submit" id="saveEventButton" class="py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-teal-600 hover:bg-teal-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-teal-500">
                        Th√™m & L∆∞u
                    </button>
                </div>
            </form>
        </div>
    </div>


    <!-- H√†m h·ªó tr·ª£ v√† Logic l·ªçc (JavaScript) -->
    <script>
        // --- C·∫§U TR√öC D·ªÆ LI·ªÜU C·ªê ƒê·ªäNH BAN ƒê·∫¶U ---

        const RECURRENCE_END_DATE_DEFAULT = '2026-12-31';
        const RECURRENCE_ICON = 'üîÑ';
        let currentDate = new Date('2025-10-14T00:00:00'); 
        const activeFilters = new Set(['official', 'extra', 'study', 'exam']);
        let currentScheduleData; 
        let nextId = 1000; // Counter for new IDs

        const dayNamesVN = ["Ch·ªß nh·∫≠t", "Th·ª© 2", "Th·ª© 3", "Th·ª© 4", "Th·ª© 5", "Th·ª© 6", "Th·ª© 7"];
        const dayNamesMap = { 0: "Ch·ªß nh·∫≠t", 1: "Th·ª© 2", 2: "Th·ª© 3", 3: "Th·ª© 4", 4: "Th·ª© 5", 5: "Th·ª© 6", 6: "Th·ª© 7" };


        const activityMap = {
            'GDQP & Th·ªÉ d·ª•c': { icon: 'üõ°Ô∏è', category: 'extra' }, 'ƒê·ªãa l√≠': { icon: 'üó∫Ô∏è', category: 'official' },
            'Tin h·ªçc': { icon: 'üíª', category: 'official' }, 'VƒÉn h·ªçc': { icon: 'üìö', category: 'official' },
            'Ch√†o c·ªù': { icon: 'üáªüá≥', category: 'official' }, 'VƒÉn Pƒê': { icon: '‚ö°', category: 'extra' },
            'To√°n': { icon: 'üìê', category: 'official' }, 'L·ªãch s·ª≠': { icon: 'üèõÔ∏è', category: 'official' },
            'Ngo·∫°i ng·ªØ': { icon: 'üí¨', category: 'official' }, 'Anh Pƒê': { icon: '‚ö°', category: 'extra' },
            'V·∫≠t l√Ω': { icon: '‚öõÔ∏è', category: 'official' }, 'M·ªπ thu·∫≠t': { icon: 'üé®', category: 'official' },
            'Sinh ho·∫°t': { icon: 'üë•', category: 'official' }, 'T·∫≠p': { icon: 'üí™', category: 'study' },
            'To√°n (th·∫ßy B√¨nh)': { icon: 'üåÉ', category: 'extra' }, 'Ti·∫øng H√†n (online)': { icon: 'üåê', category: 'extra' },
            'Thi Ti·∫øng Anh': { icon: 'üìù', category: 'exam' }, 'Thi Tin h·ªçc': { icon: 'üìù', category: 'exam' },
            'Thi V·∫≠t l√Ω': { icon: 'üìù', category: 'exam' }, 'Thi M·ªπ thu·∫≠t': { icon: 'üìù', category: 'exam' },
            'Thi ƒê·ªãa l√Ω': { icon: 'üìù', category: 'exam' }, 'Thi L·ªãch s·ª≠': { icon: 'üìù', category: 'exam' },
            'Thi Ng·ªØ VƒÉn': { icon: 'üìù', category: 'exam' }, 'Thi To√°n': { icon: 'üìù', category: 'exam' },
        };

        // D·ªØ li·ªáu ban ƒë·∫ßu ƒë∆∞·ª£c ƒë·ªãnh nghƒ©a d∆∞·ªõi d·∫°ng m·∫£ng ph·∫≥ng
        const DEMO_RECURRING_EVENTS = [
            // TH·ª® 2 (Official)
            { id: 'R1', time: "13h00 ‚Äì 13h45", subject: "ƒê·ªãa l√≠", detail: "Ch√≠nh Kh√≥a - Ti·∫øt 1", category: 'official', dayIndex: 1, recurrenceEnd: RECURRENCE_END_DATE_DEFAULT },
            { id: 'R2', time: "13h55 ‚Äì 14h40", subject: "Tin h·ªçc", detail: "Ch√≠nh Kh√≥a - Ti·∫øt 2", category: 'official', dayIndex: 1, recurrenceEnd: RECURRENCE_END_DATE_DEFAULT },
            { id: 'R3', time: "14h50 ‚Äì 15h35", subject: "VƒÉn h·ªçc", detail: "Ch√≠nh Kh√≥a - Ti·∫øt 3", category: 'official', dayIndex: 1, recurrenceEnd: RECURRENCE_END_DATE_DEFAULT },
            { id: 'R4', time: "15h50 ‚Äì 16h35", subject: "VƒÉn h·ªçc", detail: "Ch√≠nh Kh√≥a - Ti·∫øt 4", category: 'official', dayIndex: 1, recurrenceEnd: RECURRENCE_END_DATE_DEFAULT },
            { id: 'R5', time: "16h45 ‚Äì 17h30", subject: "Ch√†o c·ªù", detail: "Ch√≠nh Kh√≥a - Ti·∫øt 5", category: 'official', dayIndex: 1, recurrenceEnd: RECURRENCE_END_DATE_DEFAULT },
            // TH·ª® 3 (Official)
            { id: 'R6', time: "13h00 ‚Äì 13h45", subject: "To√°n", detail: "Ch√≠nh Kh√≥a - Ti·∫øt 1", category: 'official', dayIndex: 2, recurrenceEnd: RECURRENCE_END_DATE_DEFAULT },
            { id: 'R7', time: "13h55 ‚Äì 14h40", subject: "To√°n", detail: "Ch√≠nh Kh√≥a - Ti·∫øt 2", category: 'official', dayIndex: 2, recurrenceEnd: RECURRENCE_END_DATE_DEFAULT },
            { id: 'R8', time: "14h45 ‚Äì 15h30", subject: "L·ªãch s·ª≠", detail: "Ch√≠nh Kh√≥a - Ti·∫øt 3", category: 'official', dayIndex: 2, recurrenceEnd: RECURRENCE_END_DATE_DEFAULT },
            { id: 'R9', time: "15h35 ‚Äì 16h20", subject: "Ngo·∫°i ng·ªØ", detail: "Ch√≠nh Kh√≥a - Ti·∫øt 4", category: 'official', dayIndex: 2, recurrenceEnd: RECURRENCE_END_DATE_DEFAULT },
            // TH·ª® 4 (Official)
            { id: 'R10', time: "13h00 ‚Äì 13h45", subject: "Ngo·∫°i ng·ªØ", detail: "Ch√≠nh Kh√≥a - Ti·∫øt 1", category: 'official', dayIndex: 3, recurrenceEnd: RECURRENCE_END_DATE_DEFAULT },
            { id: 'R11', time: "13h55 ‚Äì 14h40", subject: "Ngo·∫°i ng·ªØ", detail: "Ch√≠nh Kh√≥a - Ti·∫øt 2", category: 'official', dayIndex: 3, recurrenceEnd: RECURRENCE_END_DATE_DEFAULT },
            { id: 'R12', time: "14h45 ‚Äì 15h30", subject: "ƒê·ªãa l√≠", detail: "Ch√≠nh Kh√≥a - Ti·∫øt 3", category: 'official', dayIndex: 3, recurrenceEnd: RECURRENCE_END_DATE_DEFAULT },
            // TH·ª® 5 (Official)
            { id: 'R13', time: "13h00 ‚Äì 13h45", subject: "To√°n", detail: "Ch√≠nh Kh√≥a - Ti·∫øt 1", category: 'official', dayIndex: 4, recurrenceEnd: RECURRENCE_END_DATE_DEFAULT },
            { id: 'R14', time: "13h55 ‚Äì 14h40", subject: "Tin h·ªçc", detail: "Ch√≠nh Kh√≥a - Ti·∫øt 2", category: 'official', dayIndex: 4, recurrenceEnd: RECURRENCE_END_DATE_DEFAULT },
            { id: 'R15', time: "14h50 ‚Äì 15h35", subject: "V·∫≠t l√Ω", detail: "Ch√≠nh Kh√≥a - Ti·∫øt 3", category: 'official', dayIndex: 4, recurrenceEnd: RECURRENCE_END_DATE_DEFAULT },
            { id: 'R16', time: "15h50 ‚Äì 16h35", subject: "To√°n", detail: "Ch√≠nh Kh√≥a - Ti·∫øt 4", category: 'official', dayIndex: 4, recurrenceEnd: RECURRENCE_END_DATE_DEFAULT },
            // TH·ª® 6 (Official)
            { id: 'R17', time: "13h00 ‚Äì 13h45", subject: "M·ªπ thu·∫≠t", detail: "Ch√≠nh Kh√≥a - Ti·∫øt 1", category: 'official', dayIndex: 5, recurrenceEnd: RECURRENCE_END_DATE_DEFAULT },
            { id: 'R18', time: "13h55 ‚Äì 14h40", subject: "V·∫≠t l√Ω", detail: "Ch√≠nh Kh√≥a - Ti·∫øt 2", category: 'official', dayIndex: 5, recurrenceEnd: RECURRENCE_END_DATE_DEFAULT },
            { id: 'R19', time: "14h50 ‚Äì 15h35", subject: "VƒÉn h·ªçc", detail: "Ch√≠nh Kh√≥a - Ti·∫øt 3", category: 'official', dayIndex: 5, recurrenceEnd: RECURRENCE_END_DATE_DEFAULT },
            { id: 'R20', time: "15h50 ‚Äì 16h35", subject: "M·ªπ thu·∫≠t", detail: "Ch√≠nh Kh√≥a - Ti·∫øt 4", category: 'official', dayIndex: 5, recurrenceEnd: RECURRENCE_END_DATE_DEFAULT },
            { id: 'R21', time: "16h45 ‚Äì 17h30", subject: "Sinh ho·∫°t", detail: "Ch√≠nh Kh√≥a - Ti·∫øt 5", category: 'official', dayIndex: 5, recurrenceEnd: RECURRENCE_END_DATE_DEFAULT },

            // L·ªãch H·ªçc Th√™m (Extra - Recurring)
            { id: 'R22', time: "7h00 ‚Äì 10h50", subject: "GDQP & Th·ªÉ d·ª•c", detail: "H·ªçc Th√™m - S√°ng", category: 'extra', dayIndex: 1, recurrenceEnd: RECURRENCE_END_DATE_DEFAULT },
            { id: 'R23', time: "7h30 ‚Äì 10h30", subject: "VƒÉn Pƒê", detail: "H·ªçc Th√™m - S√°ng", category: 'extra', dayIndex: 2, recurrenceEnd: RECURRENCE_END_DATE_DEFAULT },
            { id: 'R24', time: "18h00 ‚Äì 21h00", subject: "To√°n (th·∫ßy B√¨nh)", detail: "H·ªçc Th√™m - T·ªëi", category: 'extra', dayIndex: 2, recurrenceEnd: RECURRENCE_END_DATE_DEFAULT }, // Th·ª© 3
            { id: 'R25', time: "7h30 ‚Äì 10h30", subject: "Anh Pƒê", detail: "H·ªçc Th√™m - S√°ng", category: 'extra', dayIndex: 3, recurrenceEnd: RECURRENCE_END_DATE_DEFAULT },
            { id: 'R26', time: "T·ªëi", subject: "Ti·∫øng H√†n (online)", detail: "H·ªçc Th√™m - T·ªëi", category: 'extra', dayIndex: 3, recurrenceEnd: RECURRENCE_END_DATE_DEFAULT },
            { id: 'R27', time: "18h00 ‚Äì 21h00", subject: "To√°n (th·∫ßy B√¨nh)", detail: "H·ªçc Th√™m - T·ªëi", category: 'extra', dayIndex: 4, recurrenceEnd: RECURRENCE_END_DATE_DEFAULT }, // Th·ª© 5
            { id: 'R28', time: "S√°ng", subject: "Ti·∫øng H√†n (online)", detail: "H·ªçc Th√™m - Online", category: 'extra', dayIndex: 6, recurrenceEnd: RECURRENCE_END_DATE_DEFAULT }, // Th·ª© 7
        ];

        // S·ª± ki·ªán C·ªë ƒê·ªãnh (Fixed Date Events)
        const DEMO_SPECIAL_EVENTS = {
            "2025-10-14": [{ id: 'S1', time: "11h00 ‚Äì 13h00", subject: "T·∫≠p", detail: "L·ªãch T·∫≠p - T·ª± h·ªçc/T·ª± luy·ªán", category: "study" }],
            "2025-10-15": [
                { id: 'S2', time: "11h00 ‚Äì 13h00", subject: "T·∫≠p", detail: "L·ªãch T·∫≠p - T·ª± h·ªçc/T·ª± luy·ªán (L·∫ßn 1)", category: "study" },
                { id: 'S3', time: "15h30 ‚Äì 17h30", subject: "T·∫≠p", detail: "L·ªãch T·∫≠p - T·ª± h·ªçc/T·ª± luy·ªán (L·∫ßn 2)", category: "study" },
                { id: 'S4', time: "13h00 ‚Äì 13h45", subject: "Thi Ti·∫øng Anh", detail: "L·ªãch Thi - Ti·∫øt 1", category: "exam" },
            ],
            "2025-10-16": [
                { id: 'S5', time: "11h00 ‚Äì 13h00", subject: "T·∫≠p", detail: "L·ªãch T·∫≠p - T·ª± h·ªçc/T·ª± luy·ªán", category: "study" },
                { id: 'S6', time: "13h55 ‚Äì 14h40", subject: "Thi Tin h·ªçc", detail: "L·ªãch Thi - Ti·∫øt 2", category: "exam" },
            ],
            "2025-10-17": [
                { id: 'S7', time: "11h00 ‚Äì 13h00", subject: "T·∫≠p", detail: "L·ªãch T·∫≠p - T·ª± h·ªçc/T·ª± luy·ªán", category: "study" },
                { id: 'S8', time: "13h55 ‚Äì 14h40", subject: "Thi V·∫≠t l√Ω", detail: "L·ªãch Thi - Ti·∫øt 2", category: "exam" },
                { id: 'S9', time: "15h50 ‚Äì 16h35", subject: "Thi M·ªπ thu·∫≠t", detail: "L·ªãch Thi - Ti·∫øt 4", category: "exam" },
            ],
            "2025-10-18": [{ id: 'S10', time: "11h00 ‚Äì 13h00", subject: "T·∫≠p", detail: "L·ªãch T·∫≠p - T·ª± h·ªçc/T·ª± luy·ªán", category: "study" }],
            "2025-10-19": [{ id: 'S11', time: "14h00 ‚Äì 17h00", subject: "T·∫≠p", detail: "L·ªãch T·∫≠p - T·ª± h·ªçc/T·ª± luy·ªán", category: "study" }],
            "2025-10-20": [{ id: 'S12', time: "13h00 ‚Äì 13h45", subject: "Thi ƒê·ªãa l√Ω", detail: "L·ªãch Thi - Ti·∫øt 1", category: "exam" }],
            "2025-10-21": [{ id: 'S13', time: "14h45 ‚Äì 15h30", subject: "Thi L·ªãch s·ª≠", detail: "L·ªãch Thi - Ti·∫øt 3", category: "exam" }],
            "2025-10-22": [
                { id: 'S14', time: "9h00 ‚Äì 10h45", subject: "Thi Ng·ªØ VƒÉn", detail: "L·ªãch Thi - S√°ng", category: "exam" },
                { id: 'S15', time: "15h15 ‚Äì 17h00", subject: "Thi To√°n", detail: "L·ªãch Thi - Chi·ªÅu", category: "exam" },
            ],
        };

        const INITIAL_DATA = {
            recurringEvents: DEMO_RECURRING_EVENTS,
            specialEvents: DEMO_SPECIAL_EVENTS
        };

        // --- CH·ª®C NƒÇNG LOCAL STORAGE V√Ä L∆ØU D·ªÆ LI·ªÜU ---

        function getNextId() {
            return `U${nextId++}`;
        }

        function alertMessage(message, type) {
            const alertBox = document.getElementById('alert-box');
            const alertMessageElement = document.getElementById('alert-message');

            let bgColor = 'bg-blue-500'; 
            if (type === 'success') bgColor = 'bg-green-500';
            if (type === 'error') bgColor = 'bg-red-500';

            alertBox.className = 'fixed top-5 right-5 p-4 rounded-lg shadow-xl text-white opacity-0 transform translate-x-full transition duration-300 pointer-events-none';
            alertBox.classList.add(bgColor);
            alertMessageElement.textContent = message;

            setTimeout(() => {
                alertBox.classList.remove('opacity-0', 'translate-x-full', 'pointer-events-none');
                alertBox.classList.add('opacity-100', 'translate-x-0', 'pointer-events-auto');
            }, 50);

            setTimeout(() => {
                alertBox.classList.remove('opacity-100', 'translate-x-0', 'pointer-events-auto');
                alertBox.classList.add('opacity-0', 'translate-x-full', 'pointer-events-none');
            }, 3000);
        }

        function loadScheduleData() {
            const storedData = localStorage.getItem('userSchedule');
            if (storedData) {
                try {
                    const data = JSON.parse(storedData);
                    // Update nextId for new custom events
                    const allIds = [
                        ...data.recurringEvents.map(e => e.id),
                        ...Object.values(data.specialEvents).flat().map(e => e.id)
                    ].filter(id => id.startsWith('U')).map(id => parseInt(id.substring(1)));
                    
                    if (allIds.length > 0) {
                        nextId = Math.max(...allIds) + 1;
                    }

                    alertMessage("ƒê√£ t·∫£i l·ªãch c√° nh√¢n t·ª´ b·ªô nh·ªõ.", 'success');
                    return data;
                } catch (e) {
                    console.error("L·ªói khi ph√¢n t√≠ch l·ªãch t·ª´ localStorage:", e);
                    alertMessage("L·ªói d·ªØ li·ªáu. T·∫£i l·ªãch demo.", 'error');
                    return INITIAL_DATA;
                }
            }
            alertMessage("T·∫£i l·ªãch demo ban ƒë·∫ßu. D·ªØ li·ªáu s·∫Ω ƒë∆∞·ª£c l∆∞u khi b·∫°n ch·ªânh s·ª≠a.", 'success');
            return INITIAL_DATA; 
        }

        function saveScheduleData() {
            try {
                localStorage.setItem('userSchedule', JSON.stringify(currentScheduleData));
                // Do not show alert here, it is shown in calling functions
            } catch (e) {
                console.error("L·ªói khi l∆∞u l·ªãch v√†o localStorage:", e);
                alertMessage("L·ªói khi l∆∞u l·ªãch! Kh√¥ng th·ªÉ ghi v√†o b·ªô nh·ªõ.", 'error');
            }
        }
        
        // --- LOGIC DUY·ªÜT NG√ÄY & RENDER ---

        function getDayNameVN(date) {
            return dayNamesVN[date.getDay()];
        }

        function formatDate(date) {
            const y = date.getFullYear();
            const m = String(date.getMonth() + 1).padStart(2, '0');
            const d = String(date.getDate()).padStart(2, '0');
            return `${d}/${m}`;
        }

        function formatFullDateKey(date) {
            const y = date.getFullYear();
            const m = String(date.getMonth() + 1).padStart(2, '0');
            const d = String(date.getDate()).padStart(2, '0');
            return `${y}-${m}-${d}`;
        }

        function getRecurrenceEndDisplay(dateStr) {
            if (!dateStr) return '';
            const [y, m, d] = dateStr.split('-');
            return `${d}/${m}/${y}`;
        }

        function getActivity(subject) {
            return activityMap[subject] || { icon: 'üìù', category: 'official' }; 
        }

        function renderActivity(id, time, subject, detail, category, isRecurring, recurrenceEnd, dateKey) {
            const info = getActivity(subject);
            const finalCategory = category || info.category;
            const isExam = finalCategory === 'exam';

            let bgColor = 'bg-white';
            let borderColorClass = 'border-gray-300';
            let textColorClass = 'text-gray-500';

            if (finalCategory === 'official') {
                bgColor = 'bg-indigo-50';
                borderColorClass = 'border-primary-class';
                textColorClass = 'text-primary-class';
            } else if (finalCategory === 'study') {
                bgColor = 'bg-green-50';
                borderColorClass = 'border-secondary-study';
                textColorClass = 'text-secondary-study';
            } else if (finalCategory === 'extra') {
                bgColor = 'bg-rose-50';
                borderColorClass = 'border-tertiary-evening';
                textColorClass = 'text-tertiary-evening';
            } else if (finalCategory === 'exam') {
                bgColor = 'bg-amber-100';
                borderColorClass = 'border-exam-color';
                textColorClass = 'text-exam-color';
            }

            const displaySubject = isExam ? `KI·ªÇM TRA / THI: ${subject}` : subject;
            
            let recurrenceDetail = '';
            let managementBtns = '';

            if (isRecurring) {
                const endDateDisplay = getRecurrenceEndDisplay(recurrenceEnd);
                recurrenceDetail = `
                    <p class="text-xs text-gray-500 mt-1 flex items-center">
                        <span class="mr-1">${RECURRENCE_ICON}</span> L·∫∑p l·∫°i H√†ng Tu·∫ßn | H·∫øt h·∫°n: ${endDateDisplay}
                    </p>`;
                // Management for Recurring events (ID is enough)
                managementBtns = `
                    <div class="mt-2 flex space-x-2">
                        <button onclick="openManageEventModal('edit', '${id}', 'recurring')" class="text-xs text-indigo-500 hover:text-indigo-700 font-medium">S·ª≠a</button>
                        <button onclick="deleteEvent('${id}', 'recurring')" class="text-xs text-red-500 hover:text-red-700 font-medium">X√≥a</button>
                    </div>`;
            } else if (id && id.startsWith('S')) {
                 // Management for Special Events (Need ID and DateKey)
                 managementBtns = `
                    <div class="mt-2 flex space-x-2">
                        <button onclick="openManageEventModal('edit', '${id}', 'fixed', '${dateKey}')" class="text-xs text-indigo-500 hover:text-indigo-700 font-medium">S·ª≠a</button>
                        <button onclick="deleteEvent('${id}', 'fixed', '${dateKey}')" class="text-xs text-red-500 hover:text-red-700 font-medium">X√≥a</button>
                    </div>`;
            }

            return `
                <div class="activity-item flex items-start p-3 ${bgColor} border-l-4 ${borderColorClass} rounded-lg shadow-sm transition hover:shadow-md relative" data-category="${finalCategory}">
                    <span class="text-xl mr-3 mt-1">${info.icon}</span>
                    <div class="flex-grow">
                        <p class="text-xs font-semibold uppercase ${textColorClass}">
                            ${displaySubject}
                        </p>
                        <p class="text-sm font-bold text-gray-800">${time}</p>
                        ${detail ? `<p class="text-xs text-gray-500 mt-1">${detail}</p>` : ''}
                        ${recurrenceDetail}
                        ${managementBtns}
                    </div>
                </div>
            `;
        }

        function renderDayCard(dayTitle, dateStr, activitiesHtml) {
            const hasExam = activitiesHtml.some(a => a.includes('data-category="exam"'));
            const headerColor = hasExam ? 'bg-amber-600/90' : 'bg-indigo-600/90';
            const headerBorder = hasExam ? 'border-exam-color' : 'border-indigo-200';

            return `
                <div class="day-card bg-white rounded-xl shadow-2xl overflow-hidden transform transition-all duration-300 hover:scale-[1.01] border-b-4 ${headerBorder}">
                    <h2 class="text-xl font-bold p-4 text-white ${headerColor} flex items-center justify-between">
                        <span>${dayTitle}</span>
                        <span class="text-sm font-normal bg-white/20 px-2 py-0.5 rounded-full">${dateStr}</span>
                    </h2>
                    <div class="p-5 space-y-4">
                        ${activitiesHtml.join('')}
                    </div>
                </div>
            `;
        }
        
        function renderSchedule() {
            const container = document.getElementById('scheduleContainer');
            container.innerHTML = '';
            
            // 1. T√≠nh to√°n ng√†y b·∫Øt ƒë·∫ßu tu·∫ßn (lu√¥n l√† Th·ª© 2)
            let tempDate = new Date(currentDate);
            let dayIndex = tempDate.getDay(); 
            const daysToSubtract = (dayIndex - 1 + 7) % 7;
            tempDate.setDate(tempDate.getDate() - daysToSubtract);
            let mondayDate = tempDate; 

            let currentDay = new Date(mondayDate); 
            const activitiesHtml = [];

            let startRange = new Date(currentDay);
            let endRange = new Date(startRange);
            endRange.setDate(endRange.getDate() + 6);

            // C·∫≠p nh·∫≠t ti√™u ƒë·ªÅ ng√†y
            document.getElementById('dateRangeDisplay').textContent = `${formatDate(startRange)} ‚Äì ${formatDate(endRange)} / ${startRange.getFullYear()}`;
            document.getElementById('scheduleTitle').textContent = `L·ªãch H·ªçc & T·∫≠p T·ªïng H·ª£p (${formatDate(startRange)} ‚Äì ${formatDate(endRange)})`;

            const { recurringEvents, specialEvents } = currentScheduleData;

            for (let i = 0; i < 7; i++) {
                const dateKey = formatFullDateKey(currentDay);
                const dayIndex = currentDay.getDay(); // 0 (CN) ƒë·∫øn 6 (T7)
                const dayTitle = getDayNameVN(currentDay);
                const dateStr = formatDate(currentDay);

                let dayActivities = [];
                
                // 1. L·ªãch L·∫∑p L·∫°i (Recurring)
                const todayRecurring = recurringEvents.filter(e => {
                    if (e.dayIndex !== dayIndex) return false;
                    
                    // Ki·ªÉm tra ng√†y h·∫øt h·∫°n
                    const endDate = new Date(e.recurrenceEnd + 'T23:59:59');
                    return currentDay <= endDate;
                });

                todayRecurring.forEach(activity => {
                    dayActivities.push(renderActivity(
                        activity.id, 
                        activity.time, 
                        activity.subject, 
                        activity.detail, 
                        activity.category, 
                        true, // isRecurring
                        activity.recurrenceEnd 
                    ));
                });


                // 2. S·ª± ki·ªán C·ªë ƒê·ªãnh (Fixed Date)
                const special = specialEvents[dateKey] || [];
                special.forEach(activity => {
                    dayActivities.push(renderActivity(
                        activity.id, 
                        activity.time, 
                        activity.subject, 
                        activity.detail, 
                        activity.category, 
                        false, 
                        null,
                        dateKey // Pass dateKey for fixed event management
                    ));
                });
                
                activitiesHtml.push(renderDayCard(dayTitle, dateStr, dayActivities));
                
                currentDay.setDate(currentDay.getDate() + 1);
            }

            container.innerHTML = activitiesHtml.join('');
            
            updateFilterDisplay();
            applyCurrentFilters(); 
        }

        // --- LOGIC L·ªåC (FILTER) ---

        function applyCurrentFilters() {
            const items = document.querySelectorAll('.activity-item');
            items.forEach(item => {
                const itemCategory = item.getAttribute('data-category');
                if (activeFilters.has(itemCategory)) {
                    item.classList.remove('hidden');
                } else {
                    item.classList.add('hidden');
                }
            });
        }

        function filterSchedule(category) {
            if (activeFilters.has(category)) {
                activeFilters.delete(category);
            } else {
                activeFilters.add(category);
            }

            updateFilterDisplay();
            applyCurrentFilters();
        }

        function updateFilterDisplay() {
             document.querySelectorAll('.filter-btn').forEach(button => {
                const category = button.getAttribute('data-filter');
                button.classList.remove('bg-primary-class', 'bg-tertiary-evening', 'bg-secondary-study', 'bg-exam-color', 'text-white', 'bg-gray-200', 'text-gray-600');

                if (activeFilters.has(category)) {
                    if (category === 'official') button.classList.add('bg-primary-class', 'text-white');
                    else if (category === 'extra') button.classList.add('bg-tertiary-evening', 'text-white');
                    else if (category === 'study') button.classList.add('bg-secondary-study', 'text-white');
                    else if (category === 'exam') button.classList.add('bg-exam-color', 'text-white');
                } else {
                    button.classList.add('bg-gray-200', 'text-gray-600');
                }
            });
        }

        // --- LOGIC DUY·ªÜT NG√ÄY ---

        function navigateWeek(weeks) {
            currentDate.setDate(currentDate.getDate() + (weeks * 7));
            renderSchedule();
        }

        function resetDate() {
            currentDate = new Date('2025-10-14T00:00:00');
            renderSchedule();
        }

        // --- LOGIC QU·∫¢N L√ù S·ª∞ KI·ªÜN (CRUD) ---

        function toggleRecurrenceFields(type) {
            const fixed = document.getElementById('fixedFields');
            const recurring = document.getElementById('recurringFields');
            const categorySelect = document.getElementById('eventCategory');
            
            if (type === 'fixed') {
                fixed.classList.remove('hidden');
                recurring.classList.add('hidden');
                // L·ªãch c·ªë ƒë·ªãnh c√≥ th·ªÉ l√† L·ªãch T·∫≠p/L·ªãch Thi
                categorySelect.value = 'study'; // M·∫∑c ƒë·ªãnh L·ªãch T·∫≠p
            } else {
                fixed.classList.add('hidden');
                recurring.classList.remove('hidden');
                // L·ªãch l·∫∑p l·∫°i kh√¥ng th·ªÉ l√† L·ªãch Thi/L·ªãch T·∫≠p (ch√∫ng th∆∞·ªùng l√† c·ªë ƒë·ªãnh)
                if (categorySelect.value === 'study' || categorySelect.value === 'exam') {
                    categorySelect.value = 'official'; // M·∫∑c ƒë·ªãnh Ch√≠nh Kh√≥a
                }
            }
        }
        
        function updateDetailPlaceholder(category) {
             const detailInput = document.getElementById('eventDetail');
             if (category === 'official') detailInput.placeholder = 'VD: Ch√≠nh Kh√≥a - Ti·∫øt 1';
             else if (category === 'extra') detailInput.placeholder = 'VD: H·ªçc Th√™m - T·ªëi';
             else if (category === 'study') detailInput.placeholder = 'VD: L·ªãch T·∫≠p - T·ª± h·ªçc';
             else if (category === 'exam') detailInput.placeholder = 'VD: L·ªãch Thi - Ti·∫øt 2';
        }

        function openManageEventModal(mode, id = null, type = 'fixed', dateKey = null) {
            const modal = document.getElementById('manageEventModal');
            const modalContent = document.getElementById('modal-content');
            const form = document.getElementById('manageEventForm');
            const title = document.getElementById('modal-title');
            const saveBtn = document.getElementById('saveEventButton');
            
            form.reset();

            // Setup fields based on mode
            if (mode === 'add') {
                title.textContent = 'Th√™m S·ª± Ki·ªán M·ªõi';
                saveBtn.textContent = 'Th√™m & L∆∞u';
                document.getElementById('eventId').value = '';
                document.getElementById('eventType').value = 'add';
                document.getElementById('recurrenceTypeSelect').value = 'fixed';
                
                // M·∫∑c ƒë·ªãnh ng√†y hi·ªán t·∫°i ho·∫∑c ng√†y ƒë·∫ßu tu·∫ßn
                document.getElementById('eventDate').valueAsDate = new Date(currentDate);
                document.getElementById('eventRecurrenceEnd').value = RECURRENCE_END_DATE_DEFAULT;
                document.getElementById('eventCategory').value = 'official';
                toggleRecurrenceFields('fixed');
            } else if (mode === 'edit') {
                title.textContent = 'S·ª≠a S·ª± Ki·ªán';
                saveBtn.textContent = 'L∆∞u Thay ƒê·ªïi';
                document.getElementById('eventId').value = id;
                document.getElementById('eventType').value = 'edit';
                
                let eventData = null;
                
                if (type === 'fixed') {
                    document.getElementById('recurrenceTypeSelect').value = 'fixed';
                    toggleRecurrenceFields('fixed');
                    eventData = currentScheduleData.specialEvents[dateKey]?.find(e => e.id === id);
                    if (eventData) document.getElementById('eventDate').value = dateKey;
                } else if (type === 'recurring') {
                    document.getElementById('recurrenceTypeSelect').value = 'weekly';
                    toggleRecurrenceFields('weekly');
                    eventData = currentScheduleData.recurringEvents.find(e => e.id === id);
                    if (eventData) {
                        document.getElementById('eventDayIndex').value = eventData.dayIndex;
                        document.getElementById('eventRecurrenceEnd').value = eventData.recurrenceEnd;
                    }
                }
                
                if (eventData) {
                    document.getElementById('eventTime').value = eventData.time;
                    document.getElementById('eventSubject').value = eventData.subject;
                    document.getElementById('eventDetail').value = eventData.detail || '';
                    document.getElementById('eventCategory').value = eventData.category;
                }
            }

            modal.classList.remove('hidden');
            modal.classList.add('flex');
            setTimeout(() => {
                modalContent.classList.remove('scale-95', 'opacity-0');
                modalContent.classList.add('scale-100', 'opacity-100');
            }, 50);
        }

        function closeManageEventModal() {
            const modal = document.getElementById('manageEventModal');
            const modalContent = document.getElementById('modal-content');
            
            modalContent.classList.remove('scale-100', 'opacity-100');
            modalContent.classList.add('scale-95', 'opacity-0');

            setTimeout(() => {
                modal.classList.remove('flex');
                modal.classList.add('hidden');
                document.getElementById('manageEventForm').reset();
            }, 300);
        }
        
        // H√†m X√≥a S·ª± Ki·ªán
        function deleteEvent(id, type, dateKey = null) {
            // Thay v√¨ alert, d√πng confirm modal (nh∆∞ng ·ªü ƒë√¢y d√πng code block v√¨ gi·ªõi h·∫°n iframe)
            if (!confirm(`B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a s·ª± ki·ªán ID ${id}?`)) return;

            if (type === 'fixed') {
                if (currentScheduleData.specialEvents[dateKey]) {
                    currentScheduleData.specialEvents[dateKey] = currentScheduleData.specialEvents[dateKey].filter(e => e.id !== id);
                    // X√≥a m·∫£ng n·∫øu tr·ªëng
                    if (currentScheduleData.specialEvents[dateKey].length === 0) {
                        delete currentScheduleData.specialEvents[dateKey];
                    }
                    alertMessage("ƒê√£ x√≥a s·ª± ki·ªán c·ªë ƒë·ªãnh.", 'success');
                }
            } else if (type === 'recurring') {
                currentScheduleData.recurringEvents = currentScheduleData.recurringEvents.filter(e => e.id !== id);
                alertMessage("ƒê√£ x√≥a s·ª± ki·ªán l·∫∑p l·∫°i.", 'success');
            }
            
            saveScheduleData();
            renderSchedule();
        }

        // H√†m Th√™m/S·ª≠a S·ª± Ki·ªán
        function handleManageEvent(event) {
            event.preventDefault();
            
            const mode = document.getElementById('eventType').value; // 'add' or 'edit'
            const id = document.getElementById('eventId').value;
            const recurrenceTypeSelect = document.getElementById('recurrenceTypeSelect').value;
            
            const time = document.getElementById('eventTime').value;
            const subject = document.getElementById('eventSubject').value;
            const detail = document.getElementById('eventDetail').value || '';
            const category = document.getElementById('eventCategory').value;

            if (!time || !subject) {
                alertMessage("Vui l√≤ng ƒëi·ªÅn ƒë·ªß Th·ªùi gian v√† N·ªôi dung.", 'error');
                return;
            }

            let newEvent = { time, subject, detail, category };
            
            if (recurrenceTypeSelect === 'fixed') {
                const date = document.getElementById('eventDate').value;
                if (!date) { alertMessage("Vui l√≤ng ch·ªçn Ng√†y c·ªë ƒë·ªãnh.", 'error'); return; }

                if (mode === 'add') {
                    newEvent.id = getNextId();
                    if (!currentScheduleData.specialEvents[date]) {
                        currentScheduleData.specialEvents[date] = [];
                    }
                    currentScheduleData.specialEvents[date].push(newEvent);
                    alertMessage(`ƒê√£ th√™m s·ª± ki·ªán c·ªë ƒë·ªãnh "${subject}".`, 'success');
                } else if (mode === 'edit') {
                    // C·∫ßn ph·∫£i t√¨m v√† c·∫≠p nh·∫≠t ƒë√∫ng s·ª± ki·ªán. N·∫øu ng√†y thay ƒë·ªïi, c·∫ßn x√≥a ·ªü ng√†y c≈© v√† th√™m ·ªü ng√†y m·ªõi (kh√¥ng h·ªó tr·ª£ trong phi√™n b·∫£n ƒë∆°n gi·∫£n n√†y).
                    // Gi·∫£ s·ª≠ ng√†y kh√¥ng ƒë·ªïi khi s·ª≠a Fixed Event
                    const oldDateKey = Object.keys(currentScheduleData.specialEvents).find(key => 
                        currentScheduleData.specialEvents[key].some(e => e.id === id)
                    );

                    if (oldDateKey) {
                        const eventIndex = currentScheduleData.specialEvents[oldDateKey].findIndex(e => e.id === id);
                        
                        // N·∫øu ng√†y b·ªã thay ƒë·ªïi
                        if (oldDateKey !== date) {
                            // X√≥a s·ª± ki·ªán kh·ªèi ng√†y c≈©
                            currentScheduleData.specialEvents[oldDateKey].splice(eventIndex, 1);
                            if (currentScheduleData.specialEvents[oldDateKey].length === 0) {
                                delete currentScheduleData.specialEvents[oldDateKey];
                            }
                            // Th√™m v√†o ng√†y m·ªõi
                            if (!currentScheduleData.specialEvents[date]) {
                                currentScheduleData.specialEvents[date] = [];
                            }
                            currentScheduleData.specialEvents[date].push({ id, ...newEvent });
                            
                        } else {
                            // C·∫≠p nh·∫≠t s·ª± ki·ªán trong c√πng ng√†y
                            currentScheduleData.specialEvents[date][eventIndex] = { id, ...newEvent };
                        }
                        
                        alertMessage(`ƒê√£ c·∫≠p nh·∫≠t s·ª± ki·ªán c·ªë ƒë·ªãnh "${subject}".`, 'success');
                    } else {
                         alertMessage("L·ªói: Kh√¥ng t√¨m th·∫•y s·ª± ki·ªán c·ªë ƒë·ªãnh ƒë·ªÉ s·ª≠a.", 'error');
                         return;
                    }
                }
            } 
            else if (recurrenceTypeSelect === 'weekly') {
                const dayIndex = parseInt(document.getElementById('eventDayIndex').value);
                const recurrenceEnd = document.getElementById('eventRecurrenceEnd').value;
                
                if (category === 'exam' || category === 'study') {
                     alertMessage("L·ªãch Thi v√† L·ªãch T·∫≠p n√™n l√† S·ª± ki·ªán C·ªë ƒê·ªãnh (Fixed Date).", 'error');
                     return;
                }

                newEvent.dayIndex = dayIndex;
                newEvent.recurrenceEnd = recurrenceEnd;

                if (mode === 'add') {
                    newEvent.id = getNextId();
                    currentScheduleData.recurringEvents.push(newEvent);
                    alertMessage(`ƒê√£ th√™m s·ª± ki·ªán l·∫∑p l·∫°i "${subject}" v√†o ${dayNamesMap[dayIndex]}.`, 'success');
                } else if (mode === 'edit') {
                    const index = currentScheduleData.recurringEvents.findIndex(e => e.id === id);
                    if (index !== -1) {
                        currentScheduleData.recurringEvents[index] = { ...currentScheduleData.recurringEvents[index], ...newEvent };
                        alertMessage(`ƒê√£ c·∫≠p nh·∫≠t s·ª± ki·ªán l·∫∑p l·∫°i "${subject}".`, 'success');
                    }
                }
            }

            saveScheduleData();
            closeManageEventModal();
            renderSchedule();
        }

        // Kh·ªüi ch·∫°y khi t·∫£i trang
        document.addEventListener('DOMContentLoaded', () => {
            currentScheduleData = loadScheduleData();
            renderSchedule();
        });
    </script>

</body>
</html>
