<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat với GPT Agent</title>
    <!-- Tailwind CSS CDN để dễ dàng định kiểu -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
    <!-- Marked.js CDN để chuyển đổi Markdown sang HTML -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/marked/12.0.2/marked.min.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif; /* Font Inter hỗ trợ tiếng Việt tốt */
            background-color: #f0f2f5;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            padding: 0; /* Remove padding from body for full-screen effect on mobile */
            box-sizing: border-box;
        }
        .app-container {
            display: flex;
            width: 100%;
            max-width: 1000px;
            height: 95vh; /* Use 95vh to give some margin from screen edges */
            background-color: #fff;
            border-radius: 12px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
            overflow: hidden;
            position: relative; /* Needed for hamburger menu overlay positioning */
        }
        /* Styles for desktop (sidebar always visible) */
        .thread-sidebar {
            width: 280px;
            background-color: #f8fafc;
            border-right: 1px solid #e2e8f0;
            display: flex;
            flex-direction: column;
            padding: 16px;
            box-sizing: border-box;
            flex-shrink: 0; /* Prevent sidebar from shrinking */
        }
        .thread-sidebar-header {
            font-size: 1.15rem;
            font-weight: 700;
            color: #334155;
            margin-bottom: 16px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .new-thread-button {
            background-color: #006B68; /* Màu thương hiệu BIDV */
            color: white;
            border: none;
            border-radius: 8px;
            padding: 8px 12px;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 500;
            transition: background-color 0.2s, transform 0.1s;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            white-space: nowrap;
        }
        .new-thread-button:hover {
            background-color: #FFC62F; /* Màu thương hiệu BIDV cho hover */
            color: #000; /* Chữ đen để dễ đọc trên nền vàng */
            transform: translateY(-1px);
        }
        .search-input, .agent-select { /* Added agent-select */
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #d0d0d0;
            border-radius: 8px;
            margin-bottom: 16px;
            font-size: 0.9rem;
            outline: none;
            transition: border-color 0.2s;
            background-color: #fff; /* Ensure white background for dropdown */
        }
        .search-input:focus, .agent-select:focus { /* Added agent-select */
            border-color: #006B68; /* Màu thương hiệu BIDV */
        }
        .thread-list {
            flex-grow: 1;
            overflow-y: auto;
            margin-top: 10px;
        }
        .thread-item {
            padding: 10px 12px;
            border-radius: 8px;
            margin-bottom: 8px;
            cursor: pointer;
            background-color: #cbd5e1;
            color: #334155;
            font-weight: 500;
            transition: background-color 0.2s, color 0.2s;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .thread-item:hover {
            background-color: #005C5A; /* Tông màu hơi đậm hơn của BIDV primary */
            color: #f8fafc;
        }
        .thread-item.active {
            background-color: #006B68; /* Màu thương hiệu BIDV */
            color: white;
            box-shadow: 0 2px 8px rgba(0, 107, 104, 0.3); /* Điều chỉnh màu shadow */
        }
        .thread-item-name {
            flex-grow: 1;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            padding-right: 10px;
        }
        .delete-thread-button {
            background: none;
            border: none;
            color: inherit;
            cursor: pointer;
            font-size: 1rem;
            line-height: 1;
            padding: 0 5px;
            opacity: 0.7;
            transition: opacity 0.2s;
        }
        .delete-thread-button:hover {
            opacity: 1;
            color: #ef4444;
        }

        /* User Manual Section Styles */
        .user-manual-section {
            border-top: 1px solid #e2e8f0;
            padding-top: 16px;
            margin-top: 16px;
        }
        .user-manual-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            cursor: pointer;
            font-weight: 600;
            color: #334155;
            transition: color 0.2s;
        }
        .user-manual-header:hover {
            color: #006B68; /* Hover color for manual header */
        }
        .user-manual-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-out;
            padding: 0 8px; /* Add some horizontal padding */
            font-size: 0.9rem;
            color: #4a5568;
        }
        .user-manual-content.open {
            max-height: 500px; /* Adjust as needed for content height */
            overflow-y: auto; /* Enable vertical scrolling */
            transition: max-height 0.5s ease-in;
        }
        .user-manual-content ul {
            list-style-type: disc;
            margin-left: 20px;
            padding-left: 0;
        }
        .user-manual-content ol {
            list-style-type: decimal;
            margin-left: 20px;
            padding-left: 0;
        }

        .chat-area {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            width: calc(100% - 280px); /* Adjust width for desktop sidebar */
        }
        .chat-header {
            background-color: #006B68; /* Màu thương hiệu BIDV */
            color: white;
            padding: 16px;
            font-size: 1.25rem;
            font-weight: 700;
            border-top-right-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
        }
        .hamburger-button {
            display: none; /* Hidden by default on desktop */
            background: none;
            border: none;
            color: white;
            font-size: 1.5rem;
            cursor: pointer;
            padding: 0 10px;
            position: absolute;
            left: 10px;
            top: 50%;
            transform: translateY(-50%);
            z-index: 60;
        }
        .chat-header-title-text { /* New span for title text */
            flex-grow: 1; /* Allow title text to take available space */
            text-align: center;
        }
        .chat-window {
            flex-grow: 1;
            padding: 20px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 12px;
            background-color: #EBF2FA;
            position: relative;
        }
        .message-bubble {
            padding: 12px 18px;
            border-radius: 20px;
            max-width: 80%;
            word-wrap: break-word;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.08);
        }
        .user-message {
            align-self: flex-end;
            background-color: #C8E6C9; /* Giữ màu trung tính cho tin nhắn người dùng */
            color: #333;
            border-bottom-right-radius: 4px;
        }
        .bot-message {
            align-self: flex-start;
            background-color: #DDEBF7; /* Giữ màu trung tính cho tin nhắn bot */
            color: #333;
            border-bottom-left-radius: 44px;
        }
        .bot-message p:first-child { margin-top: 0; }
        .bot-message p:last-child { margin-bottom: 0; }
        .bot-message pre {
            background-color: #e0e0e0;
            padding: 10px;
            border-radius: 5px;
            overflow-x: auto;
            margin-top: 5px;
            margin-bottom: 5px;
        }
        .bot-message code {
            font-family: monospace;
            background-color: #d0d0d0;
            padding: 2px 4px;
            border-radius: 3px;
        }
        .bot-message ul, .bot-message ol {
            margin-left: 20px;
            margin-bottom: 5px;
        }
        .bot-message li {
            margin-bottom: 5px;
        }
        .chat-input-area {
            display: flex;
            padding: 16px;
            border-top: 1px solid #E0E0E0;
            background-color: #FFFFFF;
            align-items: center;
        }
        .chat-input-area input[type="text"] {
            flex-grow: 1;
            padding: 12px 18px;
            border: 1px solid #D0D0D0;
            border-radius: 25px;
            margin-right: 12px;
            font-size: 1rem;
            outline: none;
            transition: border-color 0.2s;
        }
        .chat-input-area input[type="text"]:focus {
            border-color: #006B68; /* Màu thương hiệu BIDV */
        }
        .chat-input-area button {
            background-color: #006B68; /* Màu thương hiệu BIDV */
            color: white;
            border: none;
            border-radius: 25px;
            padding: 12px 24px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 500;
            transition: background-color 0.2s, transform 0.1s;
            box-shadow: 0 2px 4px rgba(0,0,0,0.15);
        }
        .chat-input-area button:hover {
            background-color: #FFC62F; /* Màu thương hiệu BIDV cho hover */
            color: #000; /* Chữ đen để dễ đọc trên nền vàng */
            transform: translateY(-1px);
        }
        .chat-input-area button:active {
            transform: translateY(0);
        }
        .loading-indicator {
            text-align: center;
            font-style: italic;
            color: #888;
            margin-top: 10px;
        }
        .user-id-display {
            font-size: 0.85rem;
            color: #666;
            text-align: center;
            padding-bottom: 10px;
            padding-top: 10px; /* Added padding to separate from thread list */
        }

        /* Scroll to Top Button */
        #scroll-to-top-button {
            position: absolute; /* Position relative to chat-area or body if fixed */
            bottom: 30px; /* Adjust as needed */
            left: 30px; /* Changed from right to left */
            background-color: #006B68; /* Màu thương hiệu BIDV */
            color: white;
            border: none;
            border-radius: 50%; /* Make it circular */
            width: 45px;
            height: 45px;
            font-size: 1.5rem;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            opacity: 0; /* Initially hidden */
            transition: opacity 0.3s, transform 0.3s;
            transform: translateY(10px); /* Slightly below initially */
            z-index: 10; /* Ensure it's above chat messages */
        }

        #scroll-to-top-button.visible {
            opacity: 1;
            transform: translateY(0);
        }

        #scroll-to-top-button:hover {
            background-color: #FFC62F; /* Màu thương hiệu BIDV cho hover */
            color: #000;
        }

        /* Mobile specific styles (max-width: 768px) */
        @media (max-width: 768px) {
            body {
                padding: 0; /* No padding on body for full screen */
            }
            .app-container {
                border-radius: 0; /* Remove border radius on full screen */
                height: 100vh; /* Use full viewport height */
                max-width: 100%; /* Use full width */
                box-shadow: none; /* Remove shadow */
            }
            .thread-sidebar {
                position: fixed;
                top: 0;
                left: 0;
                height: 100vh;
                width: 280px;
                transform: translateX(-100%); /* Hidden by default */
                transition: transform 0.3s ease-in-out;
                z-index: 50;
                border-right: none; /* No border when hidden off-screen */
                box-shadow: 2px 0 5px rgba(0,0,0,0.2); /* Shadow for when it slides in */
                border-radius: 0; /* No border radius */
            }
            .thread-sidebar.open {
                transform: translateX(0); /* Slide in */
            }
            .chat-area {
                width: 100%; /* Full width for chat area */
            }
            .chat-header {
                border-top-right-radius: 0; /* Remove border radius on full screen */
                border-top-left-radius: 0; /* For mobile, header spans full width */
            }
            .hamburger-button {
                display: block; /* Show hamburger button on mobile */
            }
            /* Overlay when sidebar is open */
            .sidebar-overlay {
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background-color: rgba(0,0,0,0.5);
                z-index: 40; /* Behind sidebar, above chat content */
                display: none; /* Hidden by default */
            }
            .sidebar-overlay.visible {
                display: block;
            }
            /* Adjust scroll to top button for mobile */
            #scroll-to-top-button {
                bottom: 20px;
                left: 20px; /* Changed from right to left */
                width: 40px;
                height: 40px;
                font-size: 1.3rem;
            }
        }

        /* Auth Container Styles */
        .auth-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            width: 100%;
            max-width: 400px;
            padding: 40px;
            background-color: #fff;
            border-radius: 12px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 100;
        }

        .auth-container h2 {
            font-size: 2rem;
            font-weight: 700;
            color: #006B68;
            margin-bottom: 24px;
        }

        .auth-container input[type="email"],
        .auth-container input[type="password"] {
            width: 100%;
            padding: 12px 18px;
            border: 1px solid #D0D0D0;
            border-radius: 8px;
            margin-bottom: 16px;
            font-size: 1rem;
            outline: none;
            transition: border-color 0.2s;
        }

        .auth-container input[type="email"]:focus,
        .auth-container input[type="password"]:focus {
            border-color: #006B68;
        }

        .auth-container button {
            width: 100%;
            background-color: #006B68;
            color: white;
            border: none;
            border-radius: 8px;
            padding: 12px 24px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 500;
            transition: background-color 0.2s, opacity 0.2s;
            box-shadow: 0 2px 4px rgba(0,0,0,0.15);
            margin-bottom: 12px;
        }

        .auth-container button:hover:not(:disabled) {
            background-color: #FFC62F;
            color: #000;
        }

        .auth-container button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .auth-container .toggle-auth-mode {
            background: none;
            border: none;
            color: #006B68;
            cursor: pointer;
            font-size: 0.9rem;
            text-decoration: underline;
        }
        .auth-container .auth-message {
            margin-top: 10px;
            font-size: 0.9rem;
            color: #ef4444; /* Error color */
            text-align: center;
        }
        .auth-container .auth-message.success {
            color: #10B981; /* Success color */
        }
        .logout-button {
            background-color: #EF4444; /* Red color for logout */
            color: white;
            border: none;
            border-radius: 8px;
            padding: 8px 12px;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 500;
            transition: background-color 0.2s;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-top: 20px;
        }
        .logout-button:hover {
            background-color: #DC2626; /* Darker red on hover */
        }
        /* Crucial for ensuring elements hide properly */
        .hidden {
            display: none !important;
        }

    </style>
</head>
<body>
    <!-- Authentication Container -->
    <div id="auth-container" class="auth-container">
        <h2 id="auth-title">Đăng nhập</h2>
        <input type="email" id="auth-email" placeholder="Email BIDV của bạn (vd: abc@bidv.com.vn)">
        <input type="password" id="auth-password" placeholder="Mật khẩu">
        <button id="auth-main-button">Đăng nhập</button>
        <button id="toggle-auth-mode" class="toggle-auth-mode">Chưa có tài khoản? Đăng ký tại đây</button>
        <div id="auth-message" class="auth-message"></div>
    </div>

    <!-- Main Chat Application Container -->
    <div class="app-container hidden" id="app-container">
        <!-- Sidebar Overlay (for mobile) -->
        <div id="sidebar-overlay" class="sidebar-overlay"></div>

        <div class="thread-sidebar" id="thread-sidebar">
            <div class="thread-sidebar-header">
                <span>Luồng chat</span>
                <button id="new-thread-button" class="new-thread-button">
                    + Luồng mới
                </button>
            </div>
            <input type="text" id="search-input" class="search-input" placeholder="Tìm kiếm luồng chat...">
            
            <!-- Agent Selection Dropdown -->
            <label for="agent-select" class="text-sm font-semibold text-gray-700 mb-2">Chọn Agent:</label>
            <select id="agent-select" class="agent-select">
                <!-- Options will be dynamically loaded here -->
            </select>

            <!-- User Manual Section -->
            <div class="user-manual-section">
                <div class="user-manual-header" id="user-manual-header">
                    <span>Hướng dẫn sử dụng</span>
                    <span>&#x25BC;</span> <!-- Down arrow unicode -->
                </div>
                <div class="user-manual-content" id="user-manual-content">
                    <p>Chào mừng bạn đến với ứng dụng chat AI của BIDV!</p>
                    <p>Để sử dụng ứng dụng hiệu quả, vui lòng tham khảo các bước sau:</p>
                    <ul>
                        <li><strong>Tạo luồng chat mới:</strong> Nhấn vào nút "+ Luồng mới" để bắt đầu một cuộc trò chuyện mới.</li>
                        <li><strong>Chọn Agent:</strong> Sử dụng menu thả xuống "Chọn Agent" để lựa chọn trợ lý AI phù hợp với nhu cầu của bạn (ví dụ: SmartCounterHub cho các câu hỏi về quầy giao dịch thông minh, ITBOOK cho thông tin IT, QuyHoachBoNhiem cho các vấn đề liên quan đến quy hoạch bổ nhiệm).</li>
                        <li><strong>Tìm kiếm luồng chat:</strong> Gõ từ khóa vào ô "Tìm kiếm luồng chat..." để nhanh chóng tìm lại các cuộc trò chuyện cũ.</li>
                        <li><strong>Xóa luồng chat:</strong> Nhấn biểu tượng "x" bên cạnh tên luồng chat để xóa luồng đó khỏi danh sách.</li>
                        <li><strong>Cuộn lên đầu trang:
</strong> Sử dụng nút mũi tên lên ở góc dưới bên trái để cuộn nhanh về đầu cuộc trò chuyện.</li>
                        <li><strong>Sử dụng trên thiết bị di động:</strong> Khi thu nhỏ màn hình, một menu hamburger (☰) sẽ xuất hiện. Nhấn vào đó để mở/đóng thanh bên chứa các luồng chat và tùy chọn Agent.</li>
                        <li><strong>Gửi tin nhắn:</strong> Gõ tin nhắn vào ô nhập liệu và nhấn Enter hoặc nút "Gửi".</li>
                    </ul>
                    <p>Nếu bạn có bất kỳ câu hỏi nào khác, đừng ngần ngại hỏi Agent của bạn!</p>
                </div>
            </div>
            
            <div class="thread-list" id="thread-list">
                <!-- Thread items will be rendered here -->
            </div>
            <div class="user-id-display mt-4" id="user-id-display">
                <!-- User ID will be displayed here -->
                <button id="logout-button" class="logout-button">Đăng xuất</button>
            </div>
        </div>

        <div class="chat-area">
            <div class="chat-header" id="chat-header">
                <button id="hamburger-button" class="hamburger-button">☰</button>
                <span id="chat-header-title-text">Chat với GPT Agent</span> <!-- Updated ID for title text -->
            </div>
            <div class="chat-window" id="chat-window">
                <!-- Messages will be displayed here -->
            </div>
            <div class="chat-input-area">
                <input type="text" id="user-input" placeholder="Gõ tin nhắn của bạn...">
                <button id="send-button">Gửi</button>
            </div>
            <!-- Scroll to Top Button -->
            <button id="scroll-to-top-button" title="Cuộn lên đầu trang">&#x2191;</button> <!-- Up arrow Unicode -->
        </div>
    </div>

    <!-- MAIN SCRIPT BLOCK -->
    <script type="module">
        // Supabase Client SDK
        import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm';

        // Global variables provided by the Canvas environment (for Supabase)
        const supabaseUrl = 'https://fietpawfxftojbmzuwei.supabase.co'; 
        // VUI LÒNG THAY THẾ CHUỖI NÀY BẰNG KHÓA "Anon Public" CỦA DỰ ÁN SUPABASE CỦA BẠN.
        // KHÔNG PHẢI LÀ ACCESS TOKEN.
        const supabaseAnonKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZpZXRwYXdmeGZ0b2pibXp1d2VpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDY4NDU2MDAsImV4cCI6MjA2MjQyMTYwMH0.ANi4fxJ9pyO_5d-DCTFpHrPaZEHwSYjGnpXtf6u-Rik'; 

        let supabaseClient; // Supabase Client variable
        let currentUserId = null;
        let isChatReady = false; 
        let authMode = 'login'; // 'login' or 'register'

        // Arrays to store threads and messages in local memory
        let chatThreads = []; // Stores { id, name, lastMessageTimestamp }
        let chatMessages = []; // Stores { text, senderId, timestamp, type, threadId }
        let currentActiveThreadId = null;
        let currentSelectedAgentId = null; // New variable to store selected agent ID

        // Define available agents
        const availableAgents = [
            { name: "SmartCounterHub", id: "asst_o8G2LqrbzqP73ZaQQKBGYSqj" },
            { name: "ITBOOK", id: "asst_iyjtFwcQQlUhwNBI8DZLPZ5A" },
            { name: "QuyHoachBoNhiem", id: "asst_5ALG676dm3BRVKp5Ou6txCxa" }
        ];

        // Chat UI Elements
        const appContainer = document.getElementById('app-container');
        const chatWindow = document.getElementById('chat-window');
        const userInput = document.getElementById('user-input');
        const sendButton = document.getElementById('send-button');
        const userIdDisplay = document.getElementById('user-id-display');
        const threadList = document.getElementById('thread-list');
        const newThreadButton = document.getElementById('new-thread-button');
        const chatHeader = document.getElementById('chat-header'); 
        const chatHeaderTitleText = document.getElementById('chat-header-title-text'); 
        const hamburgerButton = document.getElementById('hamburger-button'); 
        const sidebarOverlay = document.getElementById('sidebar-overlay'); 
        const threadSidebar = document.getElementById('thread-sidebar'); 
        const searchInput = document.getElementById('search-input'); 
        const agentSelect = document.getElementById('agent-select'); 
        const scrollToTopButton = document.getElementById('scroll-to-top-button'); 
        const userManualHeader = document.getElementById('user-manual-header'); 
        const userManualContent = document.getElementById('user-manual-content');
        const logoutButton = document.getElementById('logout-button');

        // Auth UI Elements
        const authContainer = document.getElementById('auth-container');
        const authTitle = document.getElementById('auth-title');
        const authEmailInput = document.getElementById('auth-email');
        const authPasswordInput = document.getElementById('auth-password');
        const authMainButton = document.getElementById('auth-main-button');
        const toggleAuthModeButton = document.getElementById('toggle-auth-mode');
        const authMessageDiv = document.getElementById('auth-message');


        // --- LocalStorage Functions ---
        // Lưu ý: Sau khi có xác thực Supabase, dữ liệu này có thể được chuyển sang DB
        // để hỗ trợ đa thiết bị và liên tục. Hiện tại vẫn dùng localStorage cho tiện.
        function loadDataFromLocalStorage() {
            try {
                // Load data specific to the current authenticated user
                const storedThreads = localStorage.getItem(`chatThreads_${currentUserId}`);
                chatThreads = storedThreads ? JSON.parse(storedThreads) : [];
                
                const storedMessages = localStorage.getItem(`chatMessages_${currentUserId}`);
                chatMessages = storedMessages ? JSON.parse(storedMessages) : [];

                currentActiveThreadId = localStorage.getItem(`currentActiveThreadId_${currentUserId}`);
                currentSelectedAgentId = localStorage.getItem(`currentSelectedAgentId_${currentUserId}`) || availableAgents[0].id; // Load selected agent, default to first if not found
            } catch (error) {
                console.error("Lỗi khi tải dữ liệu từ LocalStorage:", error);
                chatThreads = [];
                chatMessages = [];
                currentActiveThreadId = null;
                currentSelectedAgentId = availableAgents[0].id; // Default to first agent on error
            }
        }

        function saveDataToLocalStorage() {
            try {
                if (!currentUserId) return; // Only save if a user is logged in
                localStorage.setItem(`chatThreads_${currentUserId}`, JSON.stringify(chatThreads));
                localStorage.setItem(`chatMessages_${currentUserId}`, JSON.stringify(chatMessages));
                if (currentActiveThreadId) {
                    localStorage.setItem(`currentActiveThreadId_${currentUserId}`, currentActiveThreadId);
                } else {
                    localStorage.removeItem(`currentActiveThreadId_${currentUserId}`);
                }
                localStorage.setItem(`currentSelectedAgentId_${currentUserId}`, currentSelectedAgentId); // Save selected agent ID
            } catch (error) {
                console.error("Lỗi khi lưu dữ liệu vào LocalStorage:", error);
            }
        }

        function clearLocalStorageForUser() {
            if (!currentUserId) return;
            localStorage.removeItem(`chatThreads_${currentUserId}`);
            localStorage.removeItem(`chatMessages_${currentUserId}`);
            localStorage.removeItem(`currentActiveThreadId_${currentUserId}`);
            localStorage.removeItem(`currentSelectedAgentId_${currentUserId}`);
        }

        // --- UI Rendering Functions ---

        // Function to display messages in the chat window
        function addMessageToUI(message, sender, timestamp) {
            const messageDiv = document.createElement('div');
            messageDiv.classList.add('message-bubble');

            if (sender === currentUserId) {
                messageDiv.classList.add('user-message');
                messageDiv.textContent = message; // User messages do not need Markdown conversion
            } else {
                messageDiv.classList.add('bot-message');
                messageDiv.innerHTML = marked.parse(message); // Convert Markdown to HTML for bot messages
            }

            const time = document.createElement('span');
            time.classList.add('text-xs', 'text-gray-500', 'mt-1', 'block', sender === currentUserId ? 'text-right' : 'text-left');
            if (timestamp) {
                const date = new Date(timestamp);
                if (!isNaN(date)) {
                    time.textContent = date.toLocaleTimeString('vi-VN', { hour: '2-digit', minute: '2-digit' });
                } else {
                    time.textContent = new Date().toLocaleTimeString('vi-VN', { hour: '2-digit', minute: '2-digit' });
                }
            } else {
                time.textContent = new Date().toLocaleTimeString('vi-VN', { hour: '2-digit', minute: '2-digit' });
            }
            messageDiv.appendChild(time);
            
            chatWindow.appendChild(messageDiv);
        }

        function renderChatWindow() {
            chatWindow.innerHTML = ''; // Clear current messages
            const messagesForCurrentThread = chatMessages.filter(msg => msg.threadId === currentActiveThreadId);
            messagesForCurrentThread.forEach(msg => {
                addMessageToUI(msg.text, msg.senderId, msg.timestamp);
            });
            chatWindow.scrollTop = chatWindow.scrollHeight; // Scroll to the bottom
            updateChatHeaderTitle(); // Update header title and hamburger button visibility
            checkScrollToTopButtonVisibility(); // Check button visibility after rendering
        }

        function renderThreadList(threadsToRender = chatThreads) { // Added parameter for filtered threads
            threadList.innerHTML = ''; // Clear current thread list
            threadsToRender.sort((a, b) => new Date(b.lastMessageTimestamp) - new Date(a.lastMessageTimestamp)); // Sort by last message time

            threadsToRender.forEach(thread => {
                const threadItem = document.createElement('div');
                threadItem.id = `thread-${thread.id}`;
                threadItem.classList.add('thread-item', 'relative');
                if (thread.id === currentActiveThreadId) {
                    threadItem.classList.add('active');
                }

                const threadNameSpan = document.createElement('span');
                threadNameSpan.classList.add('thread-item-name');
                threadNameSpan.textContent = thread.name;
                threadItem.appendChild(threadNameSpan);

                const deleteButton = document.createElement('button');
                deleteButton.classList.add('delete-thread-button');
                deleteButton.innerHTML = '&times;'; // HTML entity for multiplication sign (X)
                deleteButton.title = 'Xóa luồng chat';
                deleteButton.addEventListener('click', (e) => {
                    e.stopPropagation(); // Prevent thread selection when deleting
                    deleteThread(thread.id);
                });
                threadItem.appendChild(deleteButton);

                threadItem.addEventListener('click', () => selectThread(thread.id));
                threadList.appendChild(threadItem);
            });
        }

        function updateChatHeaderTitle() {
            const activeThread = chatThreads.find(t => t.id === currentActiveThreadId);
            chatHeaderTitleText.textContent = activeThread ? activeThread.name : 'Chat với GPT Agent';
            
            // Ensure hamburger button is visible in header when on mobile, hidden on desktop
            if (window.innerWidth <= 768) {
                hamburgerButton.style.display = 'block';
            } else {
                hamburgerButton.style.display = 'none';
            }
        }

        function populateAgentSelect() {
            agentSelect.innerHTML = ''; // Clear existing options
            availableAgents.forEach(agent => {
                const option = document.createElement('option');
                option.value = agent.id;
                option.textContent = agent.name;
                agentSelect.appendChild(option);
            });
            // Set the selected agent in the dropdown
            agentSelect.value = currentSelectedAgentId;
        }

        // Function to display temporary error/success messages
        function showTempMessage(message, type = 'info', targetElement = chatWindow) {
            const messageDiv = document.createElement('div');
            messageDiv.classList.add('loading-indicator');
            messageDiv.textContent = message;
            if (type === 'error') {
                messageDiv.style.color = 'red';
            } else if (type === 'success') {
                messageDiv.style.color = 'green';
            } else if (type === 'info') {
                messageDiv.style.color = '#888';
            }
            targetElement.appendChild(messageDiv);
            targetElement.scrollTop = targetElement.scrollHeight; // Scroll to the bottom if it's chatWindow
            setTimeout(() => {
                if (targetElement.contains(messageDiv)) { // Ensure it's still there before trying to remove
                    targetElement.removeChild(messageDiv);
                }
            }, 5000); // Disappear after 5 seconds
        }

        // --- Thread Management Functions ---
        function createNewThread() {
            const threadName = prompt("Nhập tên cho luồng chat mới:", `Luồng chat mới ${chatThreads.length + 1}`);
            if (threadName === null || threadName.trim() === '') {
                showTempMessage("Tạo luồng chat bị hủy.", "info");
                return;
            }
            const newThreadId = crypto.randomUUID();
            const newThread = {
                id: newThreadId,
                name: threadName.trim(),
                lastMessageTimestamp: new Date().toISOString()
            };
            chatThreads.push(newThread);
            currentActiveThreadId = newThreadId;
            saveDataToLocalStorage();
            renderThreadList();
            renderChatWindow(); // Clear chat window and prepare for new thread
            showTempMessage(`Đã tạo luồng chat: "${newThread.name}"`, "success");
            closeSidebar(); // Close sidebar after creating a new thread
        }

        function selectThread(threadId) {
            if (currentActiveThreadId === threadId) return; // Already active

            currentActiveThreadId = threadId;
            saveDataToLocalStorage();
            renderThreadList(); // Update active class
            renderChatWindow(); // Display messages for the selected thread
            showTempMessage(`Đã chuyển sang luồng: "${chatThreads.find(t => t.id === threadId)?.name}"`, "info");
            closeSidebar(); // Close sidebar after selecting a thread
        }

        async function deleteThread(threadIdToDelete) {
            const threadToDelete = chatThreads.find(t => t.id === threadIdToDelete);
            if (!threadToDelete) return;

            // In a real app, this should be replaced by a custom modal UI.
            const userConfirmed = confirm(`Bạn có chắc chắn muốn xóa luồng "${threadToDelete.name}" không?`);
            if (!userConfirmed) return;

            showTempMessage(`Đang xóa luồng "${threadToDelete.name}"...`, "info");

            try {
                // Step 1: Delete from Supabase Function (which will delete from OpenAI and Supabase DB)
                const serverDeleteSuccess = await deleteOpenAIThreadOnServer(threadIdToDelete);

                if (!serverDeleteSuccess) {
                    throw new Error("Không thể xóa luồng chat trên máy chủ.");
                }

                // Step 2: Remove messages belonging to this thread from local storage
                chatMessages = chatMessages.filter(msg => msg.threadId !== threadIdToDelete);
                
                // Step 3: Remove the thread itself from local storage
                chatThreads = chatThreads.filter(thread => thread.id !== threadIdToDelete);

                if (currentActiveThreadId === threadIdToDelete) {
                    // If the deleted thread was active, select the first available thread
                    // or create a new default one if no threads are left
                    if (chatThreads.length > 0) {
                        currentActiveThreadId = chatThreads[0].id;
                    } else {
                        currentActiveThreadId = null; // No active thread, will create default on next load
                    }
                }
                saveDataToLocalStorage();
                renderThreadList();
                renderChatWindow(); // Update chat window based on new active thread or empty
                showTempMessage(`Đã xóa luồng chat: "${threadToDelete.name}"`, "success");

            } catch (error) {
                console.error('Lỗi khi xóa luồng chat:', error);
                showTempMessage(`Lỗi khi xóa luồng: ${error.message}`, "error");
            }
        }

        // --- API Interaction Function ---
        async function getGPTReply(message, conversationId) {
            const functionName = 'chat-with-gpt';
            const backendUrl = `${supabaseUrl}/functions/v1/${functionName}`;
            // Use the currently selected agent ID
            const gptAssistantId = currentSelectedAgentId; 

            const payload = {
                message: message, 
                userId: currentUserId,
                assistantId: gptAssistantId,
                conversationId: conversationId, // Pass the thread ID as conversationId
                action: 'send_message' // Explicitly define action
            };

            try {
                const response = await fetch(backendUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'apikey': supabaseAnonKey, 
                        'Authorization': `Bearer ${supabaseAnonKey}` 
                    },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    let errorDetails = `HTTP error! status: ${response.status}`;
                    try {
                        const errorData = await response.json();
                        errorDetails += ` - ${errorData.message || JSON.stringify(errorData)}`;
                    } catch (parseError) {
                        errorDetails += ` - ${response.statusText}`;
                    }
                    throw new Error(`Lỗi từ Supabase Function: ${errorDetails}`);
                }

                const data = await response.json();
                if (data && typeof data.reply === 'string') {
                    return data.reply;
                } else {
                    throw new Error('Phản hồi không hợp lệ từ Supabase Function (thiếu trường "reply").');
                }
            } catch (error) {
                if (error instanceof TypeError && error.message === 'Failed to fetch') {
                    throw new Error('Không thể kết nối đến Supabase Function. Vui lòng kiểm tra URL, Anon Key, và cấu hình CORS trên Supabase.');
                } else {
                    console.error('Lỗi khi gọi Supabase Function:', error);
                    throw new Error(`Không thể nhận phản hồi từ GPT Agent thông qua Supabase: ${error.message}.`);
                }
            }
        }

        // New function to delete OpenAI thread on server
        async function deleteOpenAIThreadOnServer(conversationId) {
            const functionName = 'chat-with-gpt'; // Or a dedicated delete function
            const backendUrl = `${supabaseUrl}/functions/v1/${functionName}`;

            const payload = {
                userId: currentUserId,
                conversationId: conversationId,
                action: 'delete_thread' // Action to tell the Supabase function what to do
            };

            try {
                const response = await fetch(backendUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'apikey': supabaseAnonKey,
                        'Authorization': `Bearer ${supabaseAnonKey}`
                    },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    let errorDetails = `HTTP error! status: ${response.status}`;
                    try {
                        const errorData = await response.json();
                        errorDetails += ` - ${errorData.message || JSON.stringify(errorData)}`;
                    } catch (parseError) {
                        errorDetails += ` - ${response.statusText}`;
                    }
                    console.error('Lỗi khi gọi Supabase Function để xóa luồng:', errorDetails);
                    return false; // Indicate failure
                }

                const data = await response.json();
                if (data && data.success) {
                    return true; // Indicate success
                } else {
                    console.error('Phản hồi không thành công từ Supabase Function khi xóa luồng:', data);
                    return false;
                }
            } catch (error) {
                console.error('Lỗi khi gọi Supabase Function để xóa luồng:', error);
                return false;
            }
        }

        // --- Message Sending Logic ---
        async function sendMessage() {
            if (!isChatReady || !currentActiveThreadId) {
                showTempMessage("Hệ thống chat chưa sẵn sàng hoặc chưa có luồng chat được chọn. Vui lòng đợi hoặc tạo luồng chat mới.", "error");
                return;
            }
            if (!currentSelectedAgentId) {
                showTempMessage("Vui lòng chọn một Agent để bắt đầu trò chuyện.", "error");
                return;
            }

            const message = userInput.value.trim();
            if (message === '') {
                return;
            }

            userInput.value = ''; // Clear input field
            sendButton.disabled = true; // Disable send button
            showTempMessage("Đang gửi tin nhắn...", "info");

            try {
                // Add user message to local array
                const userMessage = {
                    text: message,
                    senderId: currentUserId,
                    timestamp: new Date().toISOString(), 
                    type: 'user',
                    threadId: currentActiveThreadId, // Associate message with active thread
                };
                chatMessages.push(userMessage);
                addMessageToUI(userMessage.text, userMessage.senderId, userManualHeader.timestamp); 
                chatWindow.scrollTop = chatWindow.scrollHeight; // Scroll to bottom after user message

                // Update last message timestamp for the active thread
                const activeThread = chatThreads.find(t => t.id === currentActiveThreadId);
                if (activeThread) {
                    activeThread.lastMessageTimestamp = userMessage.timestamp;
                }
                renderThreadList(); // Re-render to update sort order if necessary

                saveDataToLocalStorage();

                // Call GPT Agent and get response, passing current thread ID
                const gptReply = await getGPTReply(message, currentActiveThreadId);

                // Add GPT response to local array
                const botMessage = {
                    text: gptReply,
                    senderId: 'gpt_agent', 
                    timestamp: new Date().toISOString(), 
                    type: 'bot',
                    threadId: currentActiveThreadId, // Associate message with active thread
                };
                chatMessages.push(botMessage);
                addMessageToUI(botMessage.text, botMessage.senderId, botMessage.timestamp); 
                chatWindow.scrollTop = chatWindow.scrollHeight; // Scroll to bottom after bot message

                // Update last message timestamp for the active thread again after bot reply
                if (activeThread) {
                    activeThread.lastMessageTimestamp = botMessage.timestamp;
                }
                renderThreadList(); 

                saveDataToLocalStorage();

                showTempMessage("Tin nhắn đã được gửi!", "success");

            } catch (error) {
                console.error('Lỗi khi gửi/nhận tin nhắn:', error);
                showTempMessage(`Lỗi: ${error.message}`, "error");
            } finally {
                sendButton.disabled = false; // Re-enable send button
            }
        }

        // --- Sidebar & Search Logic ---
        function toggleSidebar() {
            threadSidebar.classList.toggle('open');
            sidebarOverlay.classList.toggle('visible');
        }

        function closeSidebar() {
            threadSidebar.classList.remove('open');
            sidebarOverlay.classList.remove('visible');
        }

        function filterThreads() {
            const searchTerm = searchInput.value.toLowerCase();
            const filtered = chatThreads.filter(thread => 
                thread.name.toLowerCase().includes(searchTerm)
            );
            renderThreadList(filtered);
        }

        // --- Scroll to Top Button Logic ---
        function checkScrollToTopButtonVisibility() {
            // chatWindow.scrollTop là vị trí hiện tại của thanh cuộn từ trên xuống.
            // chatWindow.scrollHeight là tổng chiều cao nội dung có thể cuộn.
            // chatWindow.clientHeight là chiều cao hiển thị của cửa sổ chat.
            // Nếu nội dung chat cao hơn chiều cao hiển thị và người dùng đã cuộn xuống một khoảng nhất định
            if (chatWindow.scrollHeight > chatWindow.clientHeight && chatWindow.scrollTop > 200) { 
                scrollToTopButton.classList.add('visible');
            } else {
                scrollToTopButton.classList.remove('visible');
            }
        }

        function scrollToTop() {
            chatWindow.scrollTo({
                top: 0,
                behavior: 'smooth' // Smooth scroll
            });
        }

        // --- User Manual Logic ---
        function toggleUserManual() {
            userManualContent.classList.toggle('open');
            const arrow = userManualHeader.querySelector('span:last-child');
            if (userManualContent.classList.contains('open')) {
                arrow.innerHTML = '&#x25B2;'; // Up arrow
            } else {
                arrow.innerHTML = '&#x25BC;'; // Down arrow
            }
        }

        // --- Authentication Functions ---
        function isValidBIDVEmail(email) {
            return email.endsWith('@bidv.com.vn');
        }

        function updateAuthUI() {
            authMessageDiv.textContent = ''; // Clear previous messages
            const email = authEmailInput.value.trim();
            const password = authPasswordInput.value.trim();

            if (authMode === 'register') {
                if (!isValidBIDVEmail(email)) {
                    authMainButton.disabled = true;
                    authMainButton.textContent = 'Đăng ký (email không hợp lệ)';
                    showTempMessage("Email phải có đuôi '@bidv.com.vn'", "error", authMessageDiv);
                } else if (password.length < 6) { // Supabase default min password length is 6
                    authMainButton.disabled = true;
                    authMainButton.textContent = 'Đăng ký (mật khẩu quá ngắn)';
                    showTempMessage("Mật khẩu phải có ít nhất 6 ký tự.", "error", authMessageDiv);
                }
                else {
                    authMainButton.disabled = false;
                    authMainButton.textContent = 'Đăng ký';
                }
            } else { // login mode
                if (email === '' || password === '') {
                    authMainButton.disabled = true;
                    authMainButton.textContent = 'Đăng nhập';
                } else {
                    authMainButton.disabled = false;
                    authMainButton.textContent = 'Đăng nhập';
                }
            }
        }

        async function handleAuth() {
            const email = authEmailInput.value.trim();
            const password = authPasswordInput.value.trim();
            authMainButton.disabled = true;
            authMessageDiv.textContent = '';

            if (authMode === 'register') {
                if (!isValidBIDVEmail(email)) {
                    showTempMessage("Email phải có đuôi '@bidv.com.vn'", "error", authMessageDiv);
                    authMainButton.disabled = false;
                    return;
                }
                if (password.length < 6) {
                    showTempMessage("Mật khẩu phải có ít nhất 6 ký tự.", "error", authMessageDiv);
                    authMainButton.disabled = false;
                    return;
                }
                try {
                    showTempMessage("Đang đăng ký...", "info", authMessageDiv);
                    const { data, error } = await supabaseClient.auth.signUp({
                        email: email,
                        password: password,
                        options: {
                            emailRedirectTo: window.location.origin // Redirect back to your app after email verification
                        }
                    });

                    if (error) throw error;

                    if (data.user) {
                        showTempMessage("Đăng ký thành công! Vui lòng kiểm tra email của bạn để xác thực tài khoản.", "success", authMessageDiv);
                    } else if (data.session === null && data.user === null) {
                        // This case often means email sent, but no direct login (e.g., if "confirm_email" is true in Supabase settings)
                        showTempMessage("Đăng ký thành công! Vui lòng kiểm tra email của bạn để xác thực tài khoản và đăng nhập.", "success", authMessageDiv);
                    }
                } catch (error) {
                    showTempMessage(`Lỗi đăng ký: ${error.message}`, "error", authMessageDiv);
                } finally {
                    authMainButton.disabled = false;
                }
            } else { // login mode
                try {
                    showTempMessage("Đang đăng nhập...", "info", authMessageDiv);
                    const { data, error } = await supabaseClient.auth.signInWithPassword({
                        email: email,
                        password: password,
                    });

                    if (error) throw error;
                    
                    // onAuthStateChanged will handle UI update if login is successful
                } catch (error) {
                    showTempMessage(`Lỗi đăng nhập: ${error.message}`, "error", authMessageDiv);
                } finally {
                    authMainButton.disabled = false;
                }
            }
        }

        function toggleAuthMode() {
            authMode = authMode === 'login' ? 'register' : 'login';
            if (authMode === 'register') {
                authTitle.textContent = 'Đăng ký';
                authMainButton.textContent = 'Đăng ký';
                toggleAuthModeButton.textContent = 'Đã có tài khoản? Đăng nhập tại đây';
            } else {
                authTitle.textContent = 'Đăng nhập';
                authMainButton.textContent = 'Đăng nhập';
                toggleAuthModeButton.textContent = 'Chưa có tài khoản? Đăng ký tại đây';
            }
            authMessageDiv.textContent = ''; // Clear message when toggling mode
            updateAuthUI(); // Update button state based on new mode
        }

        async function handleLogout() {
            showTempMessage("Đang đăng xuất...", "info");
            try {
                const { error } = await supabaseClient.auth.signOut();
                if (error) throw error;
                showTempMessage("Đăng xuất thành công!", "success");
                // onAuthStateChanged will handle UI update
            } catch (error) {
                console.error("Lỗi đăng xuất:", error);
                showTempMessage(`Lỗi đăng xuất: ${error.message}`, "error");
            }
        }

        // --- Initialization ---
        async function initializeChatAppUI(user) {
            console.log("initializeChatAppUI called for user:", user.id);
            // Only initialize UI once per successful login
            if (isChatReady && currentUserId === user.id) {
                console.log("Chat already ready for this user, skipping re-initialization.");
                return;
            }
            currentUserId = user.id;
            userIdDisplay.textContent = `ID của bạn: ${currentUserId}`;

            // Hide auth and show app
            authContainer.classList.add('hidden');
            console.log("authContainer has 'hidden' class:", authContainer.classList.contains('hidden'));
            appContainer.classList.remove('hidden');
            console.log("appContainer does NOT have 'hidden' class:", !appContainer.classList.contains('hidden'));

            // Load all data for the new user
            loadDataFromLocalStorage();

            // If no threads exist or no active thread, create a default one
            if (chatThreads.length === 0) {
                const defaultThreadId = crypto.randomUUID();
                const defaultThread = {
                    id: defaultThreadId,
                    name: "Luồng chat mặc định",
                    lastMessageTimestamp: new Date().toISOString()
                };
                chatThreads.push(defaultThread);
                currentActiveThreadId = defaultThreadId;
                saveDataToLocalStorage();
                console.log("Created default thread:", defaultThread);
            } else if (!currentActiveThreadId || !chatThreads.some(t => t.id === currentActiveThreadId)) {
                currentActiveThreadId = chatThreads[0].id;
                saveDataToLocalStorage();
                console.log("Set active thread to first existing thread:", currentActiveThreadId);
            }

            // Populate and set selected agent
            populateAgentSelect();
            console.log("Agent select populated and set.");

            // Render UI components
            renderThreadList();
            renderChatWindow(); // Display messages for the active thread
            console.log("Threads and chat window rendered.");

            isChatReady = true;
            showTempMessage("Hệ thống chat đã sẵn sàng!", "success");
            console.log("Chat system is now ready.");
        }

        // Call the main initialization function when the window finishes loading
        window.addEventListener('load', () => {
            // Parse URL hash for errors on initial load (e.g., from email verification redirect)
            const hashParams = new URLSearchParams(window.location.hash.substring(1));
            const errorParam = hashParams.get('error');
            const errorDescriptionParam = hashParams.get('error_description');

            if (errorParam || errorDescriptionParam) {
                const message = `Lỗi từ Supabase: ${errorParam || 'Không rõ lỗi'}. Mô tả: ${decodeURIComponent(errorDescriptionParam || 'Không có mô tả.')}`;
                showTempMessage(message, 'error', authMessageDiv);
                window.history.replaceState({}, document.title, window.location.pathname);
            }
            // Initial UI state. This ensures the auth screen is visible while the auth state is being determined.
            authContainer.classList.remove('hidden');
            appContainer.classList.add('hidden');
            console.log("Initial UI state set: authContainer visible, appContainer hidden.");
            updateAuthUI(); // Set initial button state for auth form

            // --- IMPORTANT CHECK FOR SUPABASE ANON KEY ---
            if (supabaseAnonKey === 'CHOOSE_YOUR_SUPABASE_ANON_PUBLIC_KEY_HERE') {
                console.error("LỖI CẤU HÌNH SUPABASE: Vui lòng thay thế 'CHOOSE_YOUR_SUPABASE_ANON_PUBLIC_KEY_HERE' bằng khóa 'anon public' thực sự của dự án Supabase của bạn. Bạn có thể tìm thấy nó trong bảng điều khiển Supabase -> Project Settings -> API.");
                showTempMessage("LỖI CẤU HÌNH: Vui lòng cập nhật khóa Supabase Anon Public trong mã nguồn!", "error", authMessageDiv);
                return; // Stop initialization if key is not set
            }

            try {
                supabaseClient = createClient(supabaseUrl, supabaseAnonKey);
                console.log("Supabase client initialized:", supabaseClient);
                
                // Immediately attach auth state changed listener
                if (supabaseClient && supabaseClient.auth && typeof supabaseClient.auth.onAuthStateChanged === 'function') {
                    console.log("onAuthStateChanged is available. Attaching listener.");
                    supabaseClient.auth.onAuthStateChanged((event, session) => {
                        console.log("onAuthStateChanged triggered. Event:", event, "Session:", session);
                        if (session && session.user) {
                            console.log("User is signed in. Calling initializeChatAppUI.");
                            initializeChatAppUI(session.user);
                        } else {
                            console.log("User is logged out or no session. Hiding app, showing auth.");
                            isChatReady = false;
                            currentUserId = null;
                            chatWindow.innerHTML = '';
                            threadList.innerHTML = '';
                            userIdDisplay.textContent = '';
                            chatThreads = [];
                            chatMessages = [];
                            currentActiveThreadId = null;

                            appContainer.classList.add('hidden'); // Ensure app is hidden
                            authContainer.classList.remove('hidden'); // Ensure auth is visible
                            console.log("authContainer visibility (should be visible):", !authContainer.classList.contains('hidden'));
                            console.log("appContainer visibility (should be hidden):", appContainer.classList.contains('hidden'));
                            showTempMessage("Vui lòng đăng nhập để tiếp tục.", "info", authMessageDiv);
                            updateAuthUI();
                        }
                    });
                } else {
                    // This error means createClient likely failed to initialize the auth module,
                    // most commonly due to an incorrect supabaseAnonKey or severe CDN issue.
                    console.error("Lỗi nghiêm trọng: supabaseClient.auth.onAuthStateChanged không được định nghĩa sau khi khởi tạo client. Vui lòng kiểm tra kỹ supabaseAnonKey (phải là khóa anon public) và URL Supabase của bạn. Có thể CDN hoặc thư viện không tải đúng.");
                    showTempMessage("Lỗi khởi tạo Supabase: Dịch vụ xác thực không khả dụng. Vui lòng kiểm tra khóa Anon Public và URL Supabase.", "error", authMessageDiv);
                    authContainer.classList.remove('hidden');
                    appContainer.classList.add('hidden');
                }
            } catch (e) {
                console.error("Lỗi khi khởi tạo Supabase client:", e);
                showTempMessage(`Lỗi khởi tạo Supabase: ${e.message}. Vui lòng kiểm tra URL và Anon Key.`, "error", authMessageDiv);
                authContainer.classList.remove('hidden');
                appContainer.classList.add('hidden');
            }
        });
    </script>
</body>
</html>
