<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>L·ªãch Ngh·ªâ Ph√©p C√¥ng Ty</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts - Inter for Vietnamese support -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700&display=swap" rel="stylesheet">
    <!-- SheetJS library for Excel parsing -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <!-- D3.js library for charting -->
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif; /* Use Inter, with sans-serif fallback */
            background-color: #f0f2f5;
            color: #333;
        }
        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 8px;
        }
        .calendar-day {
            background-color: #ffffff;
            border-radius: 8px;
            padding: 12px;
            min-height: 120px;
            display: flex;
            flex-direction: column;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }
        .calendar-day.inactive {
            background-color: #f9fafb;
            color: #ccc;
        }
        .day-number {
            font-weight: bold;
            font-size: 1.2em;
            margin-bottom: 8px;
            color: #333;
        }
        .event-list {
            list-style: none;
            padding: 0;
            margin: 0;
            flex-grow: 1;
            overflow-y: auto; /* Enable scrolling for events */
        }
        /* BIDV Brand Colors */
        .event-item {
            background-color: #FFC62F; /* BIDV Yellow for events */
            color: #006B68; /* BIDV Green for text */
            padding: 4px 8px;
            border-radius: 4px;
            margin-bottom: 4px;
            font-size: 0.85em;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        /* New style for Business Trip events */
        .event-item.business-trip {
            background-color: #e0f2fe; /* Light blue for business trips */
            color: #007bff; /* Darker blue text */
        }

        /* Keep standard colors for status for clarity */
        .event-item.approved {
            background-color: #d4edda; /* Light green for approved */
            color: #155724;
        }
        .event-item.pending {
            background-color: #fff3cd; /* Light yellow for pending */
            color: #856404;
        }
        .event-item.rejected, .event-item.cancelled, .event-item.b·ªã-t·ª´-ch·ªëi, .event-item.ƒë√£-h·ªßy {
            background-color: #f8d7da; /* Light red for rejected/cancelled */
            color: #721c24;
        }
        .weekdays {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 8px;
            margin-bottom: 16px;
            font-weight: bold;
            color: #555;
            text-align: center;
        }
        .weekday-item {
            padding: 8px;
            background-color: #e2e8f0; /* Neutral background, can be light green if desired */
            border-radius: 8px;
        }
        .month-year-header {
            font-size: 2em;
            font-weight: bold;
            color: #006B68; /* BIDV Green for header */
            margin-bottom: 20px;
            text-align: center;
        }
        .navigation-buttons button {
            background-color: #006B68; /* BIDV Green */
            color: white;
            padding: 10px 15px;
            border-radius: 8px;
            transition: background-color 0.3s ease;
        }
        .navigation-buttons button:hover {
            background-color: #005654; /* Slightly darker BIDV Green on hover */
        }
        .file-upload-section {
            background-color: #ffffff;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
        }
        .file-upload-section input[type="file"] {
            border: 1px solid #ccc;
            padding: 10px;
            border-radius: 8px;
            width: 100%;
            margin-top: 10px;
        }
        .file-upload-section button {
            background-color: #006B68; /* BIDV Green */
            color: white;
            padding: 10px 20px;
            border-radius: 8px;
            margin-top: 10px;
            transition: background-color 0.3s ease;
        }
        .file-upload-section button:hover {
            background-color: #005654; /* Slightly darker BIDV Green on hover */
        }
        .event-details-modal {
            display: none; /* Hidden by default */
            position: fixed; /* Stay in place */
            z-index: 1000; /* Sit on top */
            left: 0;
            top: 0;
            width: 100%; /* Full width */
            height: 100%; /* Full height */
            overflow: auto; /* Enable scroll if needed */
            background-color: rgba(0,0,0,0.4); /* Black w/ opacity */
            justify-content: center;
            align-items: center;
        }
        .modal-content {
            background-color: #fefefe;
            margin: auto;
            padding: 20px;
            border-radius: 12px;
            width: 80%;
            max-width: 500px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            position: relative;
        }
        .close-button {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }
        .close-button:hover,
        .close-button:focus {
            color: black;
            text-decoration: none;
            cursor: pointer;
        }
        .modal-title {
            font-size: 1.5em;
            font-weight: bold;
            margin-bottom: 15px;
            color: #006B68; /* BIDV Green for modal title */
        }
        .modal-body p {
            margin-bottom: 8px;
        }
        .modal-body strong {
            color: #34495e;
        }
        /* Styles for search suggestions */
        .suggestions-list {
            list-style: none;
            padding: 0;
            margin: 0;
            border: 1px solid #ddd;
            border-top: none;
            max-height: 150px;
            overflow-y: auto;
            background-color: white;
            position: absolute; /* Position relative to filter-section */
            width: calc(100% - 32px); /* Adjust width to match input */
            z-index: 10; /* Ensure it's above other content */
            border-radius: 0 0 8px 8px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        .suggestions-list li {
            padding: 8px 12px;
            cursor: pointer;
            border-bottom: 1px solid #eee;
        }
        .suggestions-list li:last-child {
            border-bottom: none;
        }
        .suggestions-list li:hover {
            background-color: #f0f0f0;
        }
    </style>
</head>
<body>
    <div class="container mx-auto max-w-7xl p-6">
        <h1 class="text-4xl font-extrabold text-center text-gray-900 mb-8">L·ªäCH NGH·ªà PH√âP C√îNG TY</h1>

        <!-- File Upload Section -->
        <div class="file-upload-section">
            <h2 class="text-2xl font-semibold text-gray-800 mb-4">T·∫£i l√™n file d·ªØ li·ªáu ngh·ªâ ph√©p</h2>
            <!-- Updated accept attribute for Excel files -->
            <input type="file" id="leaveFile" accept=".xlsx, .xls" class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100"/>
            <button id="uploadButton" class="mt-4 px-6 py-2 bg-blue-600 text-white rounded-lg shadow hover:bg-blue-700 transition duration-300">T·∫£i l√™n v√† C·∫≠p nh·∫≠t L·ªãch</button>
            <p id="uploadStatus" class="mt-2 text-sm text-gray-600"></p>
        </div>

        <!-- Filter Section -->
        <div class="filter-section bg-white p-6 rounded-lg shadow-md mb-8 relative"> <!-- Added relative positioning for suggestions -->
            <h2 class="text-2xl font-semibold text-gray-800 mb-4">L·ªçc theo c√°n b·ªô</h2>
            <div class="flex flex-col sm:flex-row items-center gap-4">
                <label for="employeeSearchInput" class="text-lg font-medium text-gray-700">T√¨m ki·∫øm c√°n b·ªô:</label>
                <input type="text" id="employeeSearchInput" placeholder="Nh·∫≠p t√™n c√°n b·ªô..." class="flex-grow p-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"/>
                <ul id="employeeSuggestions" class="suggestions-list">
                    <!-- Search suggestions will be dynamically generated here -->
                </ul>
            </div>
            <div class="flex flex-col sm:flex-row items-center gap-4 mt-4">
                <label for="employeeFilterDropdown" class="text-lg font-medium text-gray-700">Ch·ªçn c√°n b·ªô:</label>
                <select id="employeeFilterDropdown" class="flex-grow p-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <option value="all">T·∫•t c·∫£ c√°n b·ªô</option>
                    <!-- Options will be populated by JavaScript -->
                </select>
                <button id="clearFilterButton" class="px-6 py-2 bg-gray-200 text-gray-800 rounded-lg shadow hover:bg-gray-300 transition duration-300">X√≥a l·ªçc</button>
            </div>
        </div>

        <!-- Calendar Header -->
        <div class="flex justify-between items-center mb-6">
            <button id="prevMonth" class="navigation-buttons px-4 py-2 rounded-lg shadow-md">&lt; Th√°ng tr∆∞·ªõc</button>
            <div id="monthYear" class="month-year-header"></div>
            <button id="nextMonth" class="navigation-buttons px-4 py-2 rounded-lg shadow-md">Th√°ng sau &gt;</button>
        </div>

        <!-- Weekday Headers -->
        <div class="weekdays">
            <div class="weekday-item">CN</div>
            <div class="weekday-item">T2</div>
            <div class="weekday-item">T3</div>
            <div class="weekday-item">T4</div>
            <div class="weekday-item">T5</div>
            <div class="weekday-item">T6</div>
            <div class="weekday-item">T7</div>
        </div>

        <!-- Calendar Grid -->
        <div id="calendarGrid" class="calendar-grid">
            <!-- Calendar days will be dynamically generated here -->
        </div>

        <!-- Gemini API Section: Leave Policy Q&A -->
        <div class="gemini-section bg-white p-6 rounded-lg shadow-md mt-8">
            <h2 class="text-2xl font-semibold text-gray-800 mb-4">‚ú® H·ªèi ƒë√°p ch√≠nh s√°ch ngh·ªâ ph√©p ‚ú®</h2>
            <div class="mb-4">
                <label for="policyQuestionInput" class="block text-lg font-medium text-gray-700 mb-2">Nh·∫≠p c√¢u h·ªèi c·ªßa b·∫°n v·ªÅ ch√≠nh s√°ch ngh·ªâ ph√©p:</label>
                <textarea id="policyQuestionInput" class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" rows="4" placeholder="V√≠ d·ª•: T√¥i c√≥ bao nhi√™u ng√†y ngh·ªâ ph√©p h∆∞·ªüng l∆∞∆°ng?"></textarea>
            </div>
            <button id="askPolicyButton" class="px-6 py-2 bg-purple-600 text-white rounded-lg shadow hover:bg-purple-700 transition duration-300">
                H·ªèi Gemini
            </button>
            <div id="policyAnswerOutput" class="mt-4 p-4 bg-gray-100 rounded-lg border border-gray-200 text-gray-800 min-h-[50px]">
                <!-- Gemini's answer will appear here -->
                <p class="text-gray-500">C√¢u tr·∫£ l·ªùi s·∫Ω hi·ªÉn th·ªã ·ªü ƒë√¢y...</p>
            </div>
        </div>

        <!-- Gemini API Section: Leave Data Analysis -->
        <div class="gemini-section bg-white p-6 rounded-lg shadow-md mt-8">
            <h2 class="text-2xl font-semibold text-gray-800 mb-4">üìä Ph√¢n t√≠ch t√¨nh h√¨nh ngh·ªâ ph√©p v√† Khuy·∫øn ngh·ªã ‚ú®</h2>
            <div class="mb-4">
                <p class="text-lg font-medium text-gray-700 mb-2">Nh·∫•n n√∫t b√™n d∆∞·ªõi ƒë·ªÉ nh·∫≠n ph√¢n t√≠ch v√† khuy·∫øn ngh·ªã v·ªÅ t√¨nh h√¨nh ngh·ªâ ph√©p d·ª±a tr√™n d·ªØ li·ªáu ƒë√£ t·∫£i l√™n:</p>
            </div>
            <button id="analyzeLeaveButton" class="px-6 py-2 bg-blue-600 text-white rounded-lg shadow hover:bg-blue-700 transition duration-300">
                Ph√¢n t√≠ch v√† ƒë∆∞a ra khuy·∫øn ngh·ªã
            </button>
            <div id="analysisOutput" class="mt-4 p-4 bg-gray-100 rounded-lg border border-gray-200 text-gray-800 min-h-[50px]">
                <!-- Analysis results will appear here -->
                <p class="text-gray-500">Nh·∫≠n x√©t v√† khuy·∫øn ngh·ªã s·∫Ω hi·ªÉn th·ªã ·ªü ƒë√¢y...</p>
            </div>
        </div>

        <!-- New Section: Leave Trend Chart -->
        <div class="gemini-section bg-white p-6 rounded-lg shadow-md mt-8">
            <h2 class="text-2xl font-semibold text-gray-800 mb-4">üìà Th·ªëng k√™ theo th·ªùi gian ngh·ªâ ‚ú®</h2>
            <div class="mb-4 flex flex-col sm:flex-row items-center gap-4">
                <label for="chartTypeSelect" class="text-lg font-medium text-gray-700">Hi·ªÉn th·ªã bi·ªÉu ƒë·ªì theo:</label>
                <select id="chartTypeSelect" class="p-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <option value="daily">Ng√†y trong th√°ng</option>
                    <option value="monthly">Th√°ng</option>
                </select>
            </div>
            <div id="dailyChartControls" class="mb-4 flex flex-col sm:flex-row items-center gap-4">
                <label for="chartMonthSelect" class="text-lg font-medium text-gray-700">Ch·ªçn th√°ng:</label>
                <select id="chartMonthSelect" class="p-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <!-- Months populated by JS -->
                </select>
                <label for="chartYearSelect" class="text-lg font-medium text-gray-700">Ch·ªçn nƒÉm:</label>
                <select id="chartYearSelect" class="p-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <!-- Years populated by JS -->
                </select>
            </div>
            <div id="leaveTrendChart" class="mt-4 p-4 bg-gray-100 rounded-lg border border-gray-200 text-gray-800 min-h-[200px] flex items-center justify-center">
                <p class="text-gray-500">Bi·ªÉu ƒë·ªì s·∫Ω hi·ªÉn th·ªã ·ªü ƒë√¢y sau khi b·∫°n t·∫£i d·ªØ li·ªáu.</p>
            </div>
        </div>

        <!-- Statistics Section -->
        <div id="statisticsSection" class="statistics-section bg-white p-6 rounded-lg shadow-md mt-8">
            <h2 id="statisticsHeader" class="text-2xl font-semibold text-gray-800 mb-4 flex items-center justify-between cursor-pointer">
                Th·ªëng k√™ ng√†y ngh·ªâ ph√©p
                <span id="statisticsToggleIcon" class="transform transition-transform duration-300 rotate-0">‚ñº</span>
            </h2>
            <div id="statisticsContent" class="hidden"> <!-- This div will be toggled -->
                <div id="perPersonStatistics" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                    <!-- Per-person statistics will be dynamically generated here -->
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-4 pt-4 border-t border-gray-200">
                    <div class="bg-green-50 p-4 rounded-lg flex items-center justify-between">
                        <span class="font-medium text-green-800">T·ªïng s·ªë ng√†y ngh·ªâ h∆∞·ªüng l∆∞∆°ng (T·ªïng):</span>
                        <span id="totalPaidLeaveDays" class="text-xl font-bold text-green-700">0 ng√†y</span>
                    </div>
                    <div class="bg-red-50 p-4 rounded-lg flex items-center justify-between">
                        <span class="font-medium text-red-800">T·ªïng s·ªë ng√†y ngh·ªâ kh√¥ng h∆∞·ªüng l∆∞∆°ng (T·ªïng):</span>
                        <span id="totalUnpaidLeaveDays" class="text-xl font-bold text-red-700">0 ng√†y</span>
                    </div>
                </div>
            </div>
        </div>

    </div>

    <!-- Event Details Modal -->
    <div id="eventDetailsModal" class="event-details-modal">
        <div class="modal-content">
            <span class="close-button">&times;</span>
            <h3 class="modal-title">Chi ti·∫øt s·ª± ki·ªán</h3>
            <div class="modal-body">
                <p><strong>Lo·∫°i ngh·ªâ:</strong> <span id="modalLeaveType"></span></p>
                <p><strong>Ng√†y b·∫Øt ƒë·∫ßu:</strong> <span id="modalStartDate"></span></p>
                <p><strong>Ng√†y k·∫øt th√∫c:</strong> <span id="modalEndDate"></span></p>
                <p><strong>Tr·∫°ng th√°i:</strong> <span id="modalStatus"></span></p>
                <p><strong>Ng∆∞·ªùi ƒëƒÉng k√Ω:</strong> <span id="modalRequester"></span></p>
                <p><strong>Ng∆∞·ªùi duy·ªát:</strong> <span id="modalApprover"></span></p>
                <p><strong>L√Ω do:</strong> <span id="modalReason"></span></p>
            </div>
        </div>
    </div>

    <script>
        // Global variables for calendar
        let currentMonth = new Date().getMonth();
        let currentYear = new Date().getFullYear();
        let leaveData = []; // Stores parsed leave data

        const monthYearDisplay = document.getElementById('monthYear');
        const calendarGrid = document.getElementById('calendarGrid');
        const prevMonthBtn = document.getElementById('prevMonth');
        const nextMonthBtn = document.getElementById('nextMonth');
        const uploadFileBtn = document.getElementById('uploadButton');
        const leaveFileInput = document.getElementById('leaveFile');
        const uploadStatus = document.getElementById('uploadStatus');

        const eventDetailsModal = document.getElementById('eventDetailsModal');
        const closeModalBtn = document.querySelector('.close-button');
        const modalLeaveType = document.getElementById('modalLeaveType');
        const modalStartDate = document.getElementById('modalStartDate');
        const modalEndDate = document.getElementById('modalEndDate');
        const modalStatus = document.getElementById('modalStatus');
        const modalRequester = document.getElementById('modalRequester');
        const modalApprover = document.getElementById('modalApprover');
        const modalReason = document.getElementById('modalReason');

        // Statistics elements
        const totalPaidLeaveDaysElement = document.getElementById('totalPaidLeaveDays');
        const totalUnpaidLeaveDaysElement = document.getElementById('totalUnpaidLeaveDays');
        const perPersonStatisticsElement = document.getElementById('perPersonStatistics'); // New element for per-person stats

        // Filter elements
        const employeeSearchInput = document.getElementById('employeeSearchInput');
        const employeeSuggestions = document.getElementById('employeeSuggestions');
        const employeeFilterDropdown = document.getElementById('employeeFilterDropdown'); // New dropdown element
        const clearFilterBtn = document.getElementById('clearFilterButton');

        // Gemini API elements
        const policyQuestionInput = document.getElementById('policyQuestionInput');
        const askPolicyButton = document.getElementById('askPolicyButton');
        const policyAnswerOutput = document.getElementById('policyAnswerOutput');

        const analyzeLeaveButton = document.getElementById('analyzeLeaveButton'); // New analysis button
        const analysisOutput = document.getElementById('analysisOutput'); // New analysis output div

        // Chart elements
        const leaveTrendChartDiv = document.getElementById('leaveTrendChart');
        const chartTypeSelect = document.getElementById('chartTypeSelect');
        const dailyChartControls = document.getElementById('dailyChartControls');
        const chartMonthSelect = document.getElementById('chartMonthSelect');
        const chartYearSelect = document.getElementById('chartYearSelect');

        // Statistics section toggle elements
        const statisticsSection = document.getElementById('statisticsSection');
        const statisticsHeader = document.getElementById('statisticsHeader');
        const statisticsContent = document.getElementById('statisticsContent');
        const statisticsToggleIcon = document.getElementById('statisticsToggleIcon');

        // Initial state for statistics section: collapsed
        statisticsContent.classList.add('hidden');
        statisticsToggleIcon.classList.add('rotate-0'); // Pointing down

        // Toggle function for statistics section
        statisticsHeader.addEventListener('click', () => {
            statisticsContent.classList.toggle('hidden');
            statisticsToggleIcon.classList.toggle('rotate-180'); // Rotate 180 degrees
        });


        // Function to render the calendar
        function renderCalendar() {
            calendarGrid.innerHTML = ''; // Clear previous days
            const firstDayOfMonth = new Date(currentYear, currentMonth, 1).getDay(); // 0 for Sunday, 1 for Monday, etc.
            const daysInMonth = new Date(currentYear, currentMonth + 1, 0).getDate();

            monthYearDisplay.textContent = `Th√°ng ${currentMonth + 1}, ${currentYear}`;

            // Get the currently selected employee for filtering from dropdown
            const selectedEmployee = employeeFilterDropdown.value;

            // Add empty cells for days before the 1st (adjusting for Monday start if needed)
            const startDayOffset = firstDayOfMonth;

            for (let i = 0; i < startDayOffset; i++) {
                const emptyDay = document.createElement('div');
                emptyDay.classList.add('calendar-day', 'inactive');
                calendarGrid.appendChild(emptyDay);
            }

            // Add days of the month
            for (let day = 1; day <= daysInMonth; day++) {
                const dayElement = document.createElement('div');
                dayElement.classList.add('calendar-day');
                dayElement.innerHTML = `<div class="day-number">${day}</div><ul class="event-list"></ul>`;
                calendarGrid.appendChild(dayElement);

                const currentDay = new Date(currentYear, currentMonth, day);
                let eventsForDay = getEventsForDate(currentDay);

                // Filter events based on selected employee from dropdown
                if (selectedEmployee !== 'all') {
                    eventsForDay = eventsForDay.filter(event => event.requester === selectedEmployee);
                }
                
                const eventList = dayElement.querySelector('.event-list');

                eventsForDay.forEach(event => {
                    const eventItem = document.createElement('li');
                    eventItem.classList.add('event-item');
                    eventItem.textContent = event.requester && event.requester !== 'N/A' ? event.requester : 'Ngh·ªâ ph√©p';
                    
                    // Apply specific class for "ƒëi c√¥ng t√°c"
                    if (event.leaveType && event.leaveType.toLowerCase().includes('ƒëi c√¥ng t√°c')) {
                        eventItem.classList.add('business-trip');
                    } else if (event.status) {
                        const statusClass = event.status.toLowerCase().replace(/[^a-z0-9√†√°·∫°·∫£√£ƒÉ·∫±·∫Ø·∫≥·∫µ·∫∑√¢·∫ß·∫•·∫©·∫´·∫≠√®√©·∫π·∫ª·∫Ω√™·ªÅ·∫ø·ªÉ·ªÖ·ªáƒë√¨√≠·ªã·ªâƒ©√≤√≥·ªç·ªè√µ√¥·ªì·ªë·ªï·ªó·ªô∆°·ªù·ªõ·ªü·ª°·ª£√π√∫·ª•·ªß≈©∆∞·ª´·ª©·ª≠·ªØ·ª±·ª≥√Ω·ªµ·ª∑·ªπ]+/g, '-').replace(/^-*|-*$/g, '');
                        eventItem.classList.add(statusClass);
                    }
                    eventItem.title = `${event.leaveType || 'Ngh·ªâ ph√©p'}: ${event.requester || 'Kh√¥ng r√µ'} - ${event.reason || 'Kh√¥ng c√≥ l√Ω do'}`;
                    eventItem.addEventListener('click', () => showEventDetails(event));
                    eventList.appendChild(eventItem);
                });
            }
        }

        // Function to parse the uploaded Excel file content
        async function parseLeaveData(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const data = new Uint8Array(e.target.result);
                        // Use cellDates: true to let SheetJS parse dates into Date objects
                        const workbook = XLSX.read(data, { type: 'array', cellDates: true });

                        const firstSheetName = workbook.SheetNames[0];
                        const worksheet = workbook.Sheets[firstSheetName];

                        const parsedData = [];
                        let actualExcelHeaders = [];

                        // Define column indices (0-based) for direct cell access
                        const COL_INDEX_NAME = 2; // Column C
                        const COL_INDEX_LEAVE_TYPE = 4; // Column E
                        const COL_INDEX_START_DATE = 5; // Column F
                        const COL_INDEX_END_DATE = 6; // Column G
                        const COL_INDEX_STATUS = 7; // Column H
                        const COL_INDEX_REASON = 8; // Column I
                        const COL_INDEX_APPROVER = 11; // Column L

                        // Get headers from Excel row 2 (0-indexed row 1)
                        const headerRowIndex = 1;
                        if (worksheet['!ref']) {
                            const range = XLSX.utils.decode_range(worksheet['!ref']);
                            for (let C = range.s.c; C <= range.e.c; ++C) {
                                const cell_address = { c: C, r: headerRowIndex };
                                const cell_ref = XLSX.utils.encode_cell(cell_address);
                                const cell = worksheet[cell_ref];
                                actualExcelHeaders.push(cell && cell.v !== undefined ? String(cell.v).trim() : '');
                            }
                        }
                        console.log("Ti√™u ƒë·ªÅ c·ªôt th·ª±c t·∫ø t·ª´ Excel (h√†ng 2):", actualExcelHeaders);

                        // Iterate over data rows, starting from Excel row 4 (0-indexed row 3)
                        const startDataRowIndex = 3;
                        if (worksheet['!ref']) {
                            const range = XLSX.utils.decode_range(worksheet['!ref']);
                            for (let R = startDataRowIndex; R <= range.e.r; ++R) {
                                // Get cell values directly
                                const getCellValue = (colIndex) => {
                                    const cell_address = { c: colIndex, r: R };
                                    const cell_ref = XLSX.utils.encode_cell(cell_address);
                                    const cell = worksheet[cell_ref];
                                    return cell ? cell.v : null; // Return null for empty cells
                                };

                                const requester = getCellValue(COL_INDEX_NAME);
                                const leaveType = getCellValue(COL_INDEX_LEAVE_TYPE);
                                const startDateRaw = getCellValue(COL_INDEX_START_DATE);
                                const endDateRaw = getCellValue(COL_INDEX_END_DATE);
                                const status = getCellValue(COL_INDEX_STATUS);
                                const reason = getCellValue(COL_INDEX_REASON);
                                const approver = getCellValue(COL_INDEX_APPROVER);

                                // Check if the row is completely empty or just the key fields are empty
                                // If all key fields are null/empty, skip the row
                                const isKeyFieldsEmpty = [requester, leaveType, startDateRaw, endDateRaw, status].every(val => val === null || (typeof val === 'string' && val.trim() === ''));
                                if (isKeyFieldsEmpty) {
                                    console.log(`D√≤ng ${R + 1} (Excel) tr·ªëng ho·∫∑c kh√¥ng c√≥ d·ªØ li·ªáu h·ª£p l·ªá (c√°c tr∆∞·ªùng ch√≠nh tr·ªëng), b·ªè qua.`);
                                    continue;
                                }

                                const parsedRequester = requester ? String(requester).trim() : 'N/A';
                                const parsedLeaveType = leaveType ? String(leaveType).trim() : '';
                                const parsedStatus = status ? String(status).trim() : '';
                                const parsedReason = reason ? String(reason).trim() : 'Kh√¥ng c√≥ l√Ω do';
                                const parsedApprover = approver ? String(approver).trim() : 'N/A';

                                // formatDate should now receive Date objects directly from SheetJS
                                const startDate = formatDate(startDateRaw);
                                const endDate = formatDate(endDateRaw);

                                console.log(`D√≤ng d·ªØ li·ªáu ${R + 1} (Excel):`, {
                                    rawRequester: requester,
                                    rawLeaveType: leaveType,
                                    rawStartDate: startDateRaw,
                                    rawEndDate: endDateRaw,
                                    rawStatus: status,
                                    rawReason: reason,
                                    rawApprover: approver,
                                    parsedStartDate: startDate,
                                    parsedEndDate: endDate
                                });

                                // Ensure all critical fields are present and valid
                                if (parsedLeaveType && startDate !== 'N/A' && endDate !== 'N/A' && parsedStatus && parsedRequester !== 'N/A') {
                                    parsedData.push({
                                        leaveType: parsedLeaveType,
                                        startDate: startDate,
                                        endDate: endDate,
                                        status: parsedStatus,
                                        requester: parsedRequester,
                                        approver: parsedApprover,
                                        reason: parsedReason
                                    });
                                } else {
                                    console.log(`D√≤ng ${R + 1} (Excel) kh√¥ng ƒë·ªß d·ªØ li·ªáu h·ª£p l·ªá ƒë·ªÉ th√™m v√†o l·ªãch, b·ªè qua.`);
                                    console.log("Thi·∫øu d·ªØ li·ªáu:", { parsedLeaveType, startDate, endDate, parsedStatus, parsedRequester });
                                }
                            }
                        } else {
                            console.log("File Excel tr·ªëng ho·∫∑c kh√¥ng c√≥ d·ªØ li·ªáu.");
                        }

                        console.log("D·ªØ li·ªáu ƒë√£ ph√¢n t√≠ch (parsedData cu·ªëi c√πng):", parsedData);
                        resolve({ parsedData, actualExcelHeaders: actualExcelHeaders });
                    } catch (error) {
                        console.error("L·ªói khi ph√¢n t√≠ch file Excel:", error);
                        reject("L·ªói khi ƒë·ªçc file Excel. Vui l√≤ng ki·ªÉm tra ƒë·ªãnh d·∫°ng file v√† c·∫•u tr√∫c c·ªôt.");
                    }
                };
                reader.onerror = (error) => {
                    reject("L·ªói khi ƒë·ªçc file.");
                };
                reader.readAsArrayBuffer(file);
            });
        }

        // Helper to format date from Excel (which might be a Date object) to DD/MM/YYYY
        function formatDate(dateValue) {
            if (dateValue instanceof Date) {
                const day = String(dateValue.getDate()).padStart(2, '0');
                const month = String(dateValue.getMonth() + 1).padStart(2, '0');
                const year = dateValue.getFullYear();
                return `${day}/${month}/${year}`;
            }
            // If it's already a string in DD/MM/YYYY format, return it as is
            if (typeof dateValue === 'string' && dateValue.match(/^\d{2}\/\d{2}\/\d{4}$/)) {
                return dateValue;
            }
            // This case should ideally not be hit if cellDates: true works
            if (typeof dateValue === 'number') {
                const excelEpoch = new Date(1899, 11, 30);
                const date = new Date(excelEpoch.getTime() + dateValue * 24 * 60 * 60 * 1000);
                const day = String(date.getDate()).padStart(2, '0');
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const year = date.getFullYear();
                return `${day}/${month}/${year}`;
            }
            return 'N/A';
        }

        // Function to get events for a specific date
        function getEventsForDate(date) {
            const eventsOnDate = [];
            // Format targetDate to YYYYMMDD for reliable comparison
            const targetNum = date.getFullYear() * 10000 + (date.getMonth() + 1) * 100 + date.getDate();

            leaveData.forEach(event => {
                const startDate = parseDate(event.startDate);
                const endDate = parseDate(event.endDate);

                console.log(`Ki·ªÉm tra s·ª± ki·ªán: ${event.requester}, T·ª´: ${event.startDate}, ƒê·∫øn: ${event.endDate}`);
                console.log(`  Parsed Start Date: ${startDate}, Parsed End Date: ${endDate}`);
                console.log(`  Target Date: ${date.toLocaleDateString('vi-VN')}, Target Num: ${targetNum}`);


                if (startDate && endDate) {
                    // Convert dates to YYYYMMDD for reliable comparison
                    const startNum = startDate.getFullYear() * 10000 + (startDate.getMonth() + 1) * 100 + startDate.getDate();
                    const endNum = endDate.getFullYear() * 10000 + (endDate.getMonth() + 1) * 100 + endDate.getDate();

                    console.log(`  Start Num: ${startNum}, End Num: ${endNum}`);

                    if (targetNum >= startNum && targetNum <= endNum) {
                        eventsOnDate.push(event);
                        console.log(`  S·ª± ki·ªán ${event.requester} ƒë∆∞·ª£c th√™m v√†o ng√†y ${date.toLocaleDateString('vi-VN')}`);
                    } else {
                        console.log(`  S·ª± ki·ªán ${event.requester} KH√îNG n·∫±m trong ng√†y ${date.toLocaleDateString('vi-VN')}`);
                    }
                } else {
                    console.log(`  Ng√†y b·∫Øt ƒë·∫ßu ho·∫∑c ng√†y k·∫øt th√∫c kh√¥ng h·ª£p l·ªá cho s·ª± ki·ªán: ${event.requester}`);
                }
            });
            return eventsOnDate;
        }

        // Helper to parse date string (DD/MM/YYYY) to Date object
        function parseDate(dateString) {
            const parts = String(dateString).split('/'); // Ensure dateString is string
            if (parts.length === 3) {
                const day = parseInt(parts[0], 10);
                const month = parseInt(parts[1], 10) - 1; // Month is 0-indexed
                const year = parseInt(parts[2], 10);
                const date = new Date(year, month, day);
                // Check for invalid date (e.g., new Date('invalid string') results in Invalid Date)
                if (isNaN(date.getTime())) {
                    console.error(`L·ªói: Kh√¥ng th·ªÉ ph√¢n t√≠ch ng√†y "${dateString}". Tr·∫£ v·ªÅ null.`);
                    return null;
                }
                return date;
            }
            console.error(`L·ªói: ƒê·ªãnh d·∫°ng ng√†y kh√¥ng h·ª£p l·ªá "${dateString}". Tr·∫£ v·ªÅ null.`);
            return null;
        }

        // Function to calculate working days between two dates (inclusive)
        function getWorkingDays(startDate, endDate) {
            let count = 0;
            const currentDate = new Date(startDate.getTime());
            while (currentDate <= endDate) {
                const dayOfWeek = currentDate.getDay(); // 0 = Sunday, 6 = Saturday
                if (dayOfWeek !== 0 && dayOfWeek !== 6) { // Exclude Sunday (0) and Saturday (6)
                    count++;
                }
                currentDate.setDate(currentDate.getDate() + 1);
            }
            return count;
        }

        // Function to update leave statistics
        function updateLeaveStatistics() {
            let totalPaidDaysOverall = 0;
            let totalUnpaidDaysOverall = 0;
            const selectedEmployee = employeeFilterDropdown.value;

            // { requester: { year: { unpaidLeave: 0, businessTrip: 0, otherPaidLeave: 0 } } }
            const perPersonYearStats = {}; 

            let dataToProcessForStats = leaveData;
            if (selectedEmployee !== 'all') {
                dataToProcessForStats = dataToProcessForStats.filter(event => event.requester === selectedEmployee);
            }

            dataToProcessForStats.forEach(event => {
                const startDate = parseDate(event.startDate);
                const endDate = parseDate(event.endDate);
                const requester = event.requester;
                const statusLower = event.status ? event.status.toLowerCase() : '';

                // Only count if status is NOT "B·ªã t·ª´ ch·ªëi"
                if (statusLower === 'b·ªã t·ª´ ch·ªëi') {
                    return; // Skip this event
                }

                if (startDate && endDate && requester && requester !== 'N/A') {
                    // Calculate working days only
                    const workingDays = getWorkingDays(startDate, endDate);

                    const leaveTypeLower = event.leaveType ? event.leaveType.toLowerCase() : '';
                    const year = startDate.getFullYear(); 

                    if (!perPersonYearStats[requester]) {
                        perPersonYearStats[requester] = {};
                    }
                    if (!perPersonYearStats[requester][year]) {
                        perPersonYearStats[requester][year] = { unpaidLeave: 0, businessTrip: 0, otherPaidLeave: 0 };
                    }

                    if (leaveTypeLower.includes('kh√¥ng l∆∞∆°ng')) {
                        perPersonYearStats[requester][year].unpaidLeave += workingDays;
                    } else if (leaveTypeLower.includes('ƒëi c√¥ng t√°c')) {
                        perPersonYearStats[requester][year].businessTrip += workingDays;
                    } else {
                        // All other types are considered "other paid leave"
                        perPersonYearStats[requester][year].otherPaidLeave += workingDays;
                    }
                }
            });

            // Calculate overall totals based on the *filtered* data
            totalPaidDaysOverall = 0;
            totalUnpaidDaysOverall = 0;
            dataToProcessForStats.forEach(event => {
                const startDate = parseDate(event.startDate);
                const endDate = parseDate(event.endDate);
                const statusLower = event.status ? event.status.toLowerCase() : '';

                // Only count if status is NOT "B·ªã t·ª´ ch·ªëi"
                if (statusLower === 'b·ªã t·ª´ ch·ªëi') {
                    return; // Skip this event
                }

                if (startDate && endDate) {
                    // Calculate working days only for overall totals
                    const workingDays = getWorkingDays(startDate, endDate);
                    const leaveTypeLower = event.leaveType ? event.leaveType.toLowerCase() : '';

                    if (leaveTypeLower.includes('kh√¥ng l∆∞∆°ng')) {
                        totalUnpaidDaysOverall += workingDays;
                    } else {
                        // All other types (including business trip and other paid leave) contribute to total paid
                        totalPaidDaysOverall += workingDays;
                    }
                }
            });

            // Clear previous per-person statistics
            perPersonStatisticsElement.innerHTML = '';

            // Display per-person and per-year statistics
            const sortedRequesters = Object.keys(perPersonYearStats).sort();
            if (sortedRequesters.length > 0) {
                sortedRequesters.forEach(requester => {
                    const requesterStats = perPersonYearStats[requester];
                    const personDiv = document.createElement('div');
                    personDiv.classList.add('bg-blue-50', 'p-4', 'rounded-lg', 'shadow-sm', 'col-span-1'); 
                    
                    let content = `<h3 class="font-bold text-blue-800 mb-2">${requester}</h3>`;
                    const sortedYears = Object.keys(requesterStats).sort();
                    sortedYears.forEach(year => {
                        const stats = requesterStats[year];
                        content += `
                            <p class="text-sm text-blue-700 mt-2"><strong>NƒÉm ${year}:</strong></p>
                            <p class="text-xs text-blue-600 ml-2">Ngh·ªâ ph√©p kh√¥ng l∆∞∆°ng: <span class="font-semibold">${stats.unpaidLeave} ng√†y</span></p>
                            <p class="text-xs text-blue-600 ml-2">ƒêi c√¥ng t√°c: <span class="font-semibold">${stats.businessTrip} ng√†y</span></p>
                            <p class="text-xs text-blue-600 ml-2">Ngh·ªâ ph√©p kh√°c: <span class="font-semibold">${stats.otherPaidLeave} ng√†y</span></p>
                        `;
                    });
                    personDiv.innerHTML = content;
                    perPersonStatisticsElement.appendChild(personDiv);
                });
            } else {
                const noDataMessage = document.createElement('p');
                noDataMessage.classList.add('text-gray-500', 'col-span-full');
                noDataMessage.textContent = 'Kh√¥ng c√≥ d·ªØ li·ªáu ngh·ªâ ph√©p ƒë·ªÉ th·ªëng k√™ cho l·ª±a ch·ªçn n√†y.';
                perPersonStatisticsElement.appendChild(noDataMessage);
            }

            // Update overall totals
            totalPaidLeaveDaysElement.textContent = `${totalPaidDaysOverall} ng√†y`;
            totalUnpaidLeaveDaysElement.textContent = `${totalUnpaidDaysOverall} ng√†y`;

            // Update the leave trend chart
            updateLeaveTrendChart();
        }

        // Function to handle search input and display suggestions
        function handleEmployeeSearch() {
            const searchTerm = employeeSearchInput.value.trim().toLowerCase();
            employeeSuggestions.innerHTML = ''; // Clear previous suggestions

            if (searchTerm.length > 0) {
                const uniqueRequesters = new Set();
                leaveData.forEach(event => {
                    if (event.requester && String(event.requester).toLowerCase().includes(searchTerm)) {
                        uniqueRequesters.add(event.requester);
                    }
                });

                const sortedRequesters = Array.from(uniqueRequesters).sort();

                sortedRequesters.forEach(requester => {
                    const listItem = document.createElement('li');
                    listItem.textContent = requester;
                    listItem.addEventListener('click', () => {
                        employeeSearchInput.value = requester;
                        employeeFilterDropdown.value = requester; // Set dropdown value
                        employeeSuggestions.innerHTML = ''; // Hide suggestions
                        renderCalendar();
                        updateLeaveStatistics();
                    });
                    employeeSuggestions.appendChild(listItem);
                });
            }
        }

        // New function to populate the employee filter dropdown
        function populateEmployeeFilterDropdown() {
            employeeFilterDropdown.innerHTML = '<option value="all">T·∫•t c·∫£ c√°n b·ªô</option>'; // Default option

            const uniqueRequesters = new Set();
            leaveData.forEach(event => {
                if (event.requester && event.requester !== 'N/A') {
                    uniqueRequesters.add(event.requester);
                }
            });

            const sortedRequesters = Array.from(uniqueRequesters).sort();

            sortedRequesters.forEach(requester => {
                const option = document.createElement('option');
                option.value = requester;
                option.textContent = requester;
                employeeFilterDropdown.appendChild(option);
            });
        }


        // Show event details in modal
        function showEventDetails(event) {
            modalLeaveType.textContent = event.leaveType || 'N/A';
            modalStartDate.textContent = event.startDate || 'N/A';
            modalEndDate.textContent = event.endDate || 'N/A';
            modalStatus.textContent = event.status || 'N/A';
            modalRequester.textContent = event.requester || 'N/A';
            modalApprover.textContent = event.approver || 'N/A';
            modalReason.textContent = event.reason || 'N/A';
            eventDetailsModal.style.display = 'flex'; // Show modal
        }

        // Close modal
        closeModalBtn.addEventListener('click', () => {
            eventDetailsModal.style.display = 'none';
        });

        // Close modal when clicking outside of it
        window.addEventListener('click', (event) => {
            if (event.target == eventDetailsModal) {
                employeeSuggestions.innerHTML = ''; // Hide suggestions when clicking outside
                eventDetailsModal.style.display = 'none';
            }
        });


        // Event Listeners for navigation
        prevMonthBtn.addEventListener('click', () => {
            currentMonth--;
            if (currentMonth < 0) {
                currentMonth = 11;
                currentYear--;
            }
            renderCalendar();
            updateLeaveStatistics(); // Update statistics on month change (which now includes chart)
        });

        nextMonthBtn.addEventListener('click', () => {
            currentMonth++;
            if (currentMonth > 11) {
                currentMonth = 0;
                currentYear++;
            }
            renderCalendar();
            updateLeaveStatistics(); // Update statistics on month change (which now includes chart)
        });

        // Event Listener for search input
        employeeSearchInput.addEventListener('input', handleEmployeeSearch);
        employeeSearchInput.addEventListener('keydown', (event) => {
            if (event.key === 'Enter') {
                // If there's only one suggestion, select it
                if (employeeSuggestions.children.length === 1) {
                    employeeSearchInput.value = employeeSuggestions.children[0].textContent;
                    employeeFilterDropdown.value = employeeSuggestions.children[0].textContent;
                } else if (employeeSearchInput.value.trim() !== '') {
                    // If no suggestions or multiple, but user typed something, try to match exactly
                    const exactMatch = Array.from(employeeFilterDropdown.options).find(option => 
                        option.value.toLowerCase() === employeeSearchInput.value.trim().toLowerCase()
                    );
                    if (exactMatch) {
                        employeeFilterDropdown.value = exactMatch.value;
                    } else {
                        employeeFilterDropdown.value = 'all'; // Reset if no exact match
                    }
                } else {
                    employeeFilterDropdown.value = 'all'; // If input is empty, clear filter
                }
                employeeSuggestions.innerHTML = ''; // Hide suggestions on Enter
                renderCalendar();
                updateLeaveStatistics(); // Update statistics and chart
            }
        });

        // Event Listener for dropdown change
        employeeFilterDropdown.addEventListener('change', () => {
            employeeSearchInput.value = employeeFilterDropdown.value === 'all' ? '' : employeeFilterDropdown.value; // Sync search input
            employeeSuggestions.innerHTML = ''; // Clear suggestions
            renderCalendar();
            updateLeaveStatistics(); // Update statistics and chart
        });


        // Event listener for "Clear Filter" button
        clearFilterBtn.addEventListener('click', () => {
            employeeSearchInput.value = ''; // Clear search input
            employeeSuggestions.innerHTML = ''; // Clear suggestions
            employeeFilterDropdown.value = 'all'; // Reset dropdown
            renderCalendar();
            updateLeaveStatistics(); // Update statistics and chart
        });

        // Event Listener for file upload
        uploadFileBtn.addEventListener('click', async () => {
            const file = leaveFileInput.files[0];
            if (file) {
                uploadStatus.textContent = 'ƒêang x·ª≠ l√Ω file...';
                try {
                    const { parsedData, actualExcelHeaders } = await parseLeaveData(file);
                    leaveData = parsedData; // Assign the parsed data to the global leaveData

                    // Clear search input and suggestions after new data load
                    employeeSearchInput.value = '';
                    employeeSuggestions.innerHTML = '';
                    populateEmployeeFilterDropdown(); // Repopulate dropdown after data load

                    // Automatically navigate to the month of the first event if data exists
                    if (leaveData.length > 0) {
                        const firstEventStartDate = parseDate(leaveData[0].startDate);
                        if (firstEventStartDate) {
                            currentMonth = firstEventStartDate.getMonth();
                            currentYear = firstEventStartDate.getFullYear();
                        }
                    }

                    // Populate chart month/year selectors based on loaded data
                    populateChartMonthYearSelectors();
                    // Set default chart month/year to current calendar month/year
                    chartMonthSelect.value = currentMonth;
                    chartYearSelect.value = currentYear;


                    renderCalendar();
                    updateLeaveStatistics(); // Call statistics update after data is loaded and calendar rendered (includes chart)

                    if (leaveData.length > 0 && leaveData.every(event => event.requester === 'N/A')) {
                        uploadStatus.textContent = 'ƒê√£ t·∫£i l√™n v√† c·∫≠p nh·∫≠t l·ªãch th√†nh c√¥ng! Tuy nhi√™n, kh√¥ng t√¨m th·∫•y c·ªôt "H·ªç v√† t√™n" ho·∫∑c d·ªØ li·ªáu t√™n trong file Excel.';
                    } else if (leaveData.length === 0) {
                        uploadStatus.textContent = 'ƒê√£ t·∫£i l√™n file nh∆∞ng kh√¥ng t√¨m th·∫•y d·ªØ li·ªáu ngh·ªâ ph√©p h·ª£p l·ªá.';
                    }
                    else {
                        uploadStatus.textContent = 'ƒê√£ t·∫£i l√™n v√† c·∫≠p nh·∫≠t l·ªãch th√†nh c√¥ng!';
                    }
                } catch (error) {
                    uploadStatus.textContent = `L·ªói: ${error}`;
                    console.error(error);
                }
            } else {
                uploadStatus.textContent = 'Vui l√≤ng ch·ªçn m·ªôt file ƒë·ªÉ t·∫£i l√™n.';
            }
        });

        // Gemini API Integration - Policy Q&A
        async function askGeminiAboutPolicy() {
            const question = policyQuestionInput.value.trim();
            if (!question) {
                policyAnswerOutput.innerHTML = '<p class="text-red-500">Vui l√≤ng nh·∫≠p c√¢u h·ªèi c·ªßa b·∫°n.</p>';
                return;
            }

            policyAnswerOutput.innerHTML = '<p class="text-gray-500">ƒêang h·ªèi Gemini... <span class="animate-pulse">...</span></p>';
            askPolicyButton.disabled = true;

            // Mock policy text for the LLM to refer to
            const policyText = `
                Ch√≠nh s√°ch ngh·ªâ ph√©p c·ªßa c√¥ng ty quy ƒë·ªãnh:
                - M·ªói nh√¢n vi√™n c√≥ 12 ng√†y ngh·ªâ ph√©p h∆∞·ªüng l∆∞∆°ng m·ªói nƒÉm.
                - Ngh·ªâ ·ªëm c√≥ h∆∞·ªüng l∆∞∆°ng t·ªëi ƒëa 5 ng√†y/nƒÉm, c·∫ßn c√≥ gi·∫•y x√°c nh·∫≠n c·ªßa b√°c sƒ©.
                - Ngh·ªâ kh√¥ng l∆∞∆°ng kh√¥ng gi·ªõi h·∫°n s·ªë ng√†y nh∆∞ng ph·∫£i ƒë∆∞·ª£c s·ª± ƒë·ªìng √Ω c·ªßa qu·∫£n l√Ω tr·ª±c ti·∫øp.
                - Ngh·ªâ ƒëi c√¥ng t√°c kh√¥ng t√≠nh v√†o ng√†y ngh·ªâ ph√©p h∆∞·ªüng l∆∞∆°ng.
                - Ngh·ªâ c∆∞·ªõi ƒë∆∞·ª£c 3 ng√†y h∆∞·ªüng l∆∞∆°ng.
                - Ngh·ªâ tang (ng∆∞·ªùi th√¢n tr·ª±c h·ªá) ƒë∆∞·ª£c 5 ng√†y h∆∞·ªüng l∆∞∆°ng.
                - C√°c lo·∫°i ngh·ªâ ph√©p kh√°c kh√¥ng ƒë∆∞·ª£c ƒë·ªÅ c·∫≠p c·ª• th·ªÉ trong ch√≠nh s√°ch n√†y s·∫Ω kh√¥ng ƒë∆∞·ª£c t√≠nh l√† ngh·ªâ h∆∞·ªüng l∆∞∆°ng.
            `;

            const prompt = `B·∫°n l√† m·ªôt tr·ª£ l√Ω nh√¢n s·ª± chuy√™n v·ªÅ ch√≠nh s√°ch ngh·ªâ ph√©p. D·ª±a tr√™n ch√≠nh s√°ch sau, h√£y tr·∫£ l·ªùi c√¢u h·ªèi c·ªßa ng∆∞·ªùi d√πng. N·∫øu th√¥ng tin kh√¥ng c√≥ trong ch√≠nh s√°ch, h√£y n√≥i r·∫±ng b·∫°n kh√¥ng c√≥ th√¥ng tin ƒë√≥.
            Vui l√≤ng ƒë·ªãnh d·∫°ng c√¢u tr·∫£ l·ªùi b·∫±ng HTML, s·ª≠ d·ª•ng c√°c th·∫ª <p> cho m·ªói ƒëo·∫°n vƒÉn.

            Ch√≠nh s√°ch:
            ${policyText}

            C√¢u h·ªèi c·ªßa ng∆∞·ªùi d√πng: "${question}"

            Tr·∫£ l·ªùi (ƒë·ªãnh d·∫°ng HTML):`;

            let chatHistory = [];
            chatHistory.push({ role: "user", parts: [{ text: prompt }] });
            const payload = { contents: chatHistory };
            const apiKey = ""; 
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;

            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                const result = await response.json();

                if (result.candidates && result.candidates.length > 0 &&
                    result.candidates[0].content && result.candidates[0].content.parts &&
                    result.candidates[0].content.parts.length > 0) {
                    const text = result.candidates[0].content.parts[0].text;
                    policyAnswerOutput.innerHTML = text; // Directly set HTML
                } else {
                    policyAnswerOutput.innerHTML = '<p class="text-red-500">Kh√¥ng th·ªÉ nh·∫≠n ƒë∆∞·ª£c c√¢u tr·∫£ l·ªùi t·ª´ Gemini. Vui l√≤ng th·ª≠ l·∫°i.</p>';
                    console.error("Unexpected Gemini API response structure:", result);
                }
            } catch (error) {
                policyAnswerOutput.innerHTML = `<p class="text-red-500">ƒê√£ x·∫£y ra l·ªói khi g·ªçi Gemini API: ${error.message}</p>`;
                console.error("Error calling Gemini API:", error);
            } finally {
                askPolicyButton.disabled = false;
            }
        }

        askPolicyButton.addEventListener('click', askGeminiAboutPolicy);

        // Gemini API Integration - Leave Data Analysis
        async function analyzeLeaveData() {
            if (leaveData.length === 0) {
                analysisOutput.innerHTML = '<p class="text-red-500">Vui l√≤ng t·∫£i l√™n file d·ªØ li·ªáu ngh·ªâ ph√©p tr∆∞·ªõc khi ph√¢n t√≠ch.</p>';
                return;
            }

            analysisOutput.innerHTML = '<p class="text-gray-500">ƒêang ph√¢n t√≠ch d·ªØ li·ªáu ngh·ªâ ph√©p... <span class="animate-pulse">...</span></p>';
            analyzeLeaveButton.disabled = true;

            // Recalculate perPersonYearStats to ensure it's up-to-date and includes all data
            const currentPerPersonYearStats = {};
            // Also gather reasons for analysis
            const leaveReasons = {}; // { reason: count }

            leaveData.forEach(event => {
                const startDate = parseDate(event.startDate);
                const endDate = parseDate(event.endDate);
                const requester = event.requester;
                const statusLower = event.status ? event.status.toLowerCase() : '';
                const reason = event.reason ? event.reason.trim() : 'Kh√¥ng c√≥ l√Ω do c·ª• th·ªÉ';

                if (statusLower === 'b·ªã t·ª´ ch·ªëi') {
                    return; // Skip rejected events
                }

                if (startDate && endDate && requester && requester !== 'N/A') {
                    // Calculate working days only
                    const workingDays = getWorkingDays(startDate, endDate);

                    const leaveTypeLower = event.leaveType ? event.leaveType.toLowerCase() : '';
                    const year = startDate.getFullYear();

                    if (!currentPerPersonYearStats[requester]) {
                        currentPerPersonYearStats[requester] = {};
                    }
                    if (!currentPerPersonYearStats[requester][year]) {
                        currentPerPersonYearStats[requester][year] = { unpaidLeave: 0, businessTrip: 0, otherPaidLeave: 0 };
                    }

                    if (leaveTypeLower.includes('kh√¥ng l∆∞∆°ng')) {
                        currentPerPersonYearStats[requester][year].unpaidLeave += workingDays;
                    } else if (leaveTypeLower.includes('ƒëi c√¥ng t√°c')) {
                        currentPerPersonYearStats[requester][year].businessTrip += workingDays;
                    } else {
                        currentPerPersonYearStats[requester][year].otherPaidLeave += workingDays;
                    }

                    // Aggregate reasons
                    if (reason) {
                        leaveReasons[reason] = (leaveReasons[reason] || 0) + workingDays; // Count working days for reasons too
                    }
                }
            });

            let statsSummary = "D·ªØ li·ªáu th·ªëng k√™ ngh·ªâ ph√©p theo c√°n b·ªô v√† nƒÉm (ch·ªâ t√≠nh ng√†y l√†m vi·ªác):\n";
            const sortedRequestersForPrompt = Object.keys(currentPerPersonYearStats).sort();
            if (sortedRequestersForPrompt.length > 0) {
                sortedRequestersForPrompt.forEach(requester => {
                    statsSummary += `- C√°n b·ªô: ${requester}\n`;
                    const sortedYearsForPrompt = Object.keys(currentPerPersonYearStats[requester]).sort();
                    sortedYearsForPrompt.forEach(year => {
                        const stats = currentPerPersonYearStats[requester][year];
                        statsSummary += `  NƒÉm ${year}: Ngh·ªâ kh√¥ng l∆∞∆°ng: ${stats.unpaidLeave} ng√†y, ƒêi c√¥ng t√°c: ${stats.businessTrip} ng√†y, Ngh·ªâ ph√©p kh√°c: ${stats.otherPaidLeave} ng√†y.\n`;
                    });
                });
            } else {
                statsSummary += "Kh√¥ng c√≥ d·ªØ li·ªáu th·ªëng k√™ ƒë·ªÉ ph√¢n t√≠ch.\n";
            }

            statsSummary += "\nTh·ªëng k√™ l√Ω do ngh·ªâ ph√©p (t·ªïng s·ªë ng√†y l√†m vi·ªác):\n";
            const sortedReasons = Object.keys(leaveReasons).sort((a, b) => leaveReasons[b] - leaveReasons[a]); // Sort by most frequent reasons
            if (sortedReasons.length > 0) {
                sortedReasons.forEach(reason => {
                    statsSummary += `- ${reason}: ${leaveReasons[reason]} ng√†y\n`;
                });
            } else {
                statsSummary += "Kh√¥ng c√≥ d·ªØ li·ªáu l√Ω do ngh·ªâ ph√©p ƒë·ªÉ ph√¢n t√≠ch.";
            }


            const prompt = `B·∫°n l√† m·ªôt chuy√™n gia ph√¢n t√≠ch d·ªØ li·ªáu nh√¢n s·ª±. D·ª±a v√†o d·ªØ li·ªáu th·ªëng k√™ ngh·ªâ ph√©p v√† l√Ω do ngh·ªâ ph√©p sau, h√£y ƒë∆∞a ra nh·∫≠n x√©t v·ªÅ t√¨nh h√¨nh ngh·ªâ ph√©p c·ªßa c√¥ng ty v√† c√°c khuy·∫øn ngh·ªã ƒë·ªÉ c·∫£i thi·ªán ho·∫∑c qu·∫£n l√Ω hi·ªáu qu·∫£ h∆°n.
            L∆∞u √Ω: C√°c s·ªë li·ªáu ƒë√£ ƒë∆∞·ª£c t√≠nh to√°n ch·ªâ d·ª±a tr√™n ng√†y l√†m vi·ªác (kh√¥ng bao g·ªìm Th·ª© B·∫£y v√† Ch·ªß Nh·∫≠t).
            Vui l√≤ng ƒë·ªãnh d·∫°ng c√¢u tr·∫£ l·ªùi b·∫±ng HTML, s·ª≠ d·ª•ng c√°c th·∫ª <p> cho m·ªói ƒëo·∫°n vƒÉn, v√† c√°c th·∫ª <ul>, <li> n·∫øu c·∫ßn cho danh s√°ch.

            D·ªØ li·ªáu:
            ${statsSummary}

            H√£y ƒë∆∞a ra nh·∫≠n x√©t v√† khuy·∫øn ngh·ªã chi ti·∫øt, c√≥ c·∫•u tr√∫c.`;

            let chatHistory = [];
            chatHistory.push({ role: "user", parts: [{ text: prompt }] });
            const payload = { contents: chatHistory };
            const apiKey = ""; 
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;

            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                const result = await response.json();

                if (result.candidates && result.candidates.length > 0 &&
                    result.candidates[0].content && result.candidates[0].content.parts &&
                    result.candidates[0].content.parts.length > 0) {
                    const text = result.candidates[0].content.parts[0].text;
                    analysisOutput.innerHTML = text; // Directly set HTML
                } else {
                    analysisOutput.innerHTML = '<p class="text-red-500">Kh√¥ng th·ªÉ nh·∫≠n ƒë∆∞·ª£c ph√¢n t√≠ch t·ª´ Gemini. Vui l√≤ng th·ª≠ l·∫°i.</p>';
                    console.error("Unexpected Gemini API response structure:", result);
                }
            } catch (error) {
                analysisOutput.innerHTML = `<p class="text-red-500">ƒê√£ x·∫£y ra l·ªói khi g·ªçi Gemini API: ${error.message}</p>`;
                console.error("Error calling Gemini API:", error);
            } finally {
                analyzeLeaveButton.disabled = false;
            }
        }

        analyzeLeaveButton.addEventListener('click', analyzeLeaveData);

        // Function to populate month and year dropdowns for chart
        function populateChartMonthYearSelectors() {
            chartMonthSelect.innerHTML = '';
            chartYearSelect.innerHTML = '';

            const months = [
                "Th√°ng 1", "Th√°ng 2", "Th√°ng 3", "Th√°ng 4", "Th√°ng 5", "Th√°ng 6",
                "Th√°ng 7", "Th√°ng 8", "Th√°ng 9", "Th√°ng 10", "Th√°ng 11", "Th√°ng 12"
            ];

            months.forEach((month, index) => {
                const option = document.createElement('option');
                option.value = index; // 0-indexed month
                option.textContent = month;
                chartMonthSelect.appendChild(option);
            });

            const currentYearChart = new Date().getFullYear();
            // Populate years, e.g., current year +/- 5 years, or based on data range
            const yearsInLeaveData = new Set();
            leaveData.forEach(event => {
                const startDate = parseDate(event.startDate);
                const endDate = parseDate(event.endDate);
                if (startDate) yearsInLeaveData.add(startDate.getFullYear());
                if (endDate) yearsInLeaveData.add(endDate.getFullYear());
            });

            let startYear = currentYearChart - 5;
            let endYear = currentYearChart + 5;

            if (yearsInLeaveData.size > 0) {
                startYear = Math.min(...Array.from(yearsInLeaveData), currentYearChart - 1);
                endYear = Math.max(...Array.from(yearsInLeaveData), currentYearChart + 1);
            }

            for (let year = startYear; year <= endYear; year++) {
                const option = document.createElement('option');
                option.value = year;
                option.textContent = year;
                chartYearSelect.appendChild(option);
            }

            // Set default selected values
            chartMonthSelect.value = currentMonth;
            chartYearSelect.value = currentYear;
        }


        // Function to get leave counts based on chart type
        function getLeaveCountsForChart(chartType, dataSubset, selectedMonth, selectedYear) {
            if (chartType === 'daily') {
                const dailyCounts = {}; // { 'YYYY-MM-DD': Set<requester_name> }
                const daysInMonth = new Date(selectedYear, selectedMonth + 1, 0).getDate();

                // Initialize dailyCounts for all working days in the selected month
                for (let day = 1; day <= daysInMonth; day++) {
                    const date = new Date(selectedYear, selectedMonth, day);
                    const dayOfWeek = date.getDay();
                    if (dayOfWeek !== 0 && dayOfWeek !== 6) { // Exclude Sunday (0) and Saturday (6)
                        const dateString = `${selectedYear}-${String(selectedMonth + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                        dailyCounts[dateString] = new Set();
                    }
                }

                dataSubset.forEach(event => {
                    const startDate = parseDate(event.startDate);
                    const endDate = parseDate(event.endDate);
                    const requester = event.requester;
                    const statusLower = event.status ? event.status.toLowerCase() : '';

                    if (statusLower === 'b·ªã t·ª´ ch·ªëi') {
                        return; // Skip rejected leaves
                    }

                    if (startDate && endDate && requester && requester !== 'N/A') {
                        let currentDate = new Date(startDate.getTime());
                        while (currentDate <= endDate) {
                            const dayOfWeek = currentDate.getDay();
                            // Only count if it's a working day and within the selected calendar month and year
                            if (dayOfWeek !== 0 && dayOfWeek !== 6 &&
                                currentDate.getMonth() === selectedMonth &&
                                currentDate.getFullYear() === selectedYear) {
                                
                                const dateString = `${currentDate.getFullYear()}-${String(currentDate.getMonth() + 1).padStart(2, '0')}-${String(currentDate.getDate()).padStart(2, '0')}`;
                                if (dailyCounts[dateString]) { // Ensure it's a working day in our initialized map
                                    dailyCounts[dateString].add(requester);
                                }
                            }
                            currentDate.setDate(currentDate.getDate() + 1);
                        }
                    }
                });

                // Convert Sets to counts and prepare data for D3
                const chartData = [];
                for (let day = 1; day <= daysInMonth; day++) {
                    const date = new Date(selectedYear, selectedMonth, day);
                    const dayOfWeek = date.getDay();
                    const dateString = `${selectedYear}-${String(selectedMonth + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                    
                    // Only include working days in the chart data
                    if (dayOfWeek !== 0 && dayOfWeek !== 6) {
                        chartData.push({
                            date: date,
                            label: day, // Use day for x-axis label
                            count: dailyCounts[dateString] ? dailyCounts[dateString].size : 0
                        });
                    }
                }
                return chartData;

            } else if (chartType === 'monthly') {
                const monthlyCounts = {}; // { 'YYYY-MM': Set<requester_name> }

                leaveData.forEach(event => {
                    const startDate = parseDate(event.startDate);
                    const endDate = parseDate(event.endDate);
                    const requester = event.requester;
                    const statusLower = event.status ? event.status.toLowerCase() : '';

                    if (statusLower === 'b·ªã t·ª´ ch·ªëi') {
                        return; // Skip rejected leaves
                    }

                    if (startDate && endDate && requester && requester !== 'N/A') {
                        let currentDate = new Date(startDate.getTime());
                        while (currentDate <= endDate) {
                            const dayOfWeek = currentDate.getDay();
                            if (dayOfWeek !== 0 && dayOfWeek !== 6) { // Only count working days
                                const monthYearString = `${currentDate.getFullYear()}-${String(currentDate.getMonth() + 1).padStart(2, '0')}`;
                                if (!monthlyCounts[monthYearString]) {
                                    monthlyCounts[monthYearString] = new Set();
                                }
                                monthlyCounts[monthYearString].add(requester);
                            }
                            currentDate.setDate(currentDate.getDate() + 1);
                        }
                    }
                });

                const chartData = Object.keys(monthlyCounts).map(monthYearStr => {
                    const [year, month] = monthYearStr.split('-').map(Number);
                    return {
                        date: new Date(year, month - 1, 1), // First day of the month for sorting
                        label: `T${month}/${year}`, // Label for x-axis
                        count: monthlyCounts[monthYearStr].size
                    };
                }).sort((a, b) => a.date - b.date); // Sort chronologically

                return chartData;
            }
            return []; // Should not happen
        }

        // Function to draw the leave trend chart using D3.js
        function drawLeaveTrendChart(data, chartType) {
            const chartContainer = document.getElementById('leaveTrendChart');
            chartContainer.innerHTML = ''; // Clear previous chart content

            if (data.length === 0 || data.every(d => d.count === 0)) {
                chartContainer.innerHTML = '<p class="text-gray-500">Kh√¥ng c√≥ d·ªØ li·ªáu ngh·ªâ ph√©p h·ª£p l·ªá ƒë·ªÉ hi·ªÉn th·ªã bi·ªÉu ƒë·ªì trong th√°ng/kho·∫£ng th·ªùi gian n√†y.</p>';
                return;
            }

            const margin = { top: 20, right: 30, bottom: 60, left: 50 }; // Increased bottom margin for labels
            const width = chartContainer.clientWidth - margin.left - margin.right;
            const height = 300 - margin.top - margin.bottom;

            const svg = d3.select("#leaveTrendChart")
                .append("svg")
                .attr("width", width + margin.left + margin.right)
                .attr("height", height + margin.top + margin.bottom)
                .append("g")
                .attr("transform", `translate(${margin.left},${margin.top})`);

            // X scale
            const x = d3.scaleBand()
                .domain(data.map(d => d.label)) // Use 'label' for domain
                .range([0, width])
                .padding(0.1);

            // Y scale (number of people)
            const y = d3.scaleLinear()
                .domain([0, d3.max(data, d => d.count) + 1]) // +1 for a little padding above max
                .range([height, 0]);

            // Add X axis
            svg.append("g")
                .attr("transform", `translate(0,${height})`)
                .call(d3.axisBottom(x))
                .selectAll("text")
                .attr("transform", "translate(-10,0)rotate(-45)")
                .style("text-anchor", "end");

            // Add Y axis
            svg.append("g")
                .call(d3.axisLeft(y).tickFormat(d3.format("d"))); // Ensure integer ticks for count of people

            // Add Y axis label
            svg.append("text")
                .attr("transform", "rotate(-90)")
                .attr("y", 0 - margin.left)
                .attr("x", 0 - (height / 2))
                .attr("dy", "1em")
                .style("text-anchor", "middle")
                .text("S·ªë ng∆∞·ªùi ngh·ªâ");

            // Add bars
            svg.selectAll(".bar")
                .data(data)
                .enter()
                .append("rect")
                .attr("class", "bar")
                .attr("x", d => x(d.label)) // Use 'label' for x position
                .attr("y", d => y(d.count))
                .attr("width", x.bandwidth())
                .attr("height", d => height - y(d.count))
                .attr("fill", "#006B68"); // BIDV Green
        }

        // Function to update the leave trend chart based on current selections
        function updateLeaveTrendChart() {
            const selectedChartType = chartTypeSelect.value;
            const selectedEmployee = employeeFilterDropdown.value;

            let dataToProcessForChart = leaveData;
            if (selectedEmployee !== 'all') {
                dataToProcessForChart = dataToProcessForChart.filter(event => event.requester === selectedEmployee);
            }

            let chartData;
            if (selectedChartType === 'daily') {
                dailyChartControls.style.display = 'flex'; // Show month/year selectors
                const selectedMonth = parseInt(chartMonthSelect.value, 10);
                const selectedYear = parseInt(chartYearSelect.value, 10);
                chartData = getLeaveCountsForChart('daily', dataToProcessForChart, selectedMonth, selectedYear);
            } else { // monthly
                dailyChartControls.style.display = 'none'; // Hide month/year selectors
                chartData = getLeaveCountsForChart('monthly', dataToProcessForChart);
            }
            drawLeaveTrendChart(chartData, selectedChartType);
        }

        // Event listeners for chart controls
        chartTypeSelect.addEventListener('change', updateLeaveTrendChart);
        chartMonthSelect.addEventListener('change', updateLeaveTrendChart);
        chartYearSelect.addEventListener('change', updateLeaveTrendChart);


        // Initial render
        populateChartMonthYearSelectors(); // Populate selectors on initial load
        renderCalendar();
        updateLeaveStatistics(); // Initial call for statistics (includes chart)
    </script>
</body>
</html>
