<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Demo Tính Phí Tổng Hợp</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome CDN -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        /* Custom font for better aesthetics */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f2f5; /* Light gray background */
        }
        /* Ensure inputs and buttons have consistent styling */
        input[type="number"], input[type="text"], input[type="date"], select, button, textarea {
            border-radius: 0.5rem; /* Rounded corners */
            padding: 0.75rem 1rem;
            border: 1px solid #d1d5db; /* Light gray border */
            transition: all 0.2s ease-in-out;
        }
        input[type="number"]:focus, input[type="text"]:focus, input[type="date"]:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #006B68; /* Brand color for focus border */
            box-shadow: 0 0 0 3px rgba(0, 107, 104, 0.25); /* Brand color for focus shadow */
        }
        button {
            cursor: pointer;
            font-weight: 600;
            display: inline-flex; /* Use flex for centering content if needed */
            align-items: center;
            justify-content: center;
            gap: 0.5rem; /* Space between icon and text */
        }
        /* Primary button style */
        .btn-primary {
            background-color: #006B68; /* Brand color 1 */
            color: white; /* Ensure white text on dark background */
        }
        .btn-primary:hover {
            background-color: #004F4C; /* Darker shade of brand color 1 */
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }
        .section-separator {
            height: 2rem; /* Space between sections */
        }
        /* Style for the clear data button */
        #clearDataBtn {
            background-color: #ef4444; /* Red button */
            color: white; /* Ensure white text on red background */
        }
        #clearDataBtn:hover {
            background-color: #dc2626; /* Darker red on hover */
        }
        .action-button {
            padding: 0.5rem 0.75rem;
            font-size: 0.875rem;
            margin-left: 0.5rem;
        }
        .edit-button {
            background-color: #f59e0b; /* Amber - keeping for now, can be adjusted */
            /* Text color remains default for amber, as it's not a "dark" background */
        }
        .edit-button:hover {
            background-color: #FFC62F; /* Brand color 2 for hover */
            color: #333; /* Darker text on light background */
        }
        .delete-button {
            background-color: #ef4444; /* Red */
            color: white; /* Ensure white text on red background */
        }
        .delete-button:hover {
            background-color: #dc2626; /* Darker red on hover */
        }
        .cancel-edit-button {
            background-color: #6b7280; /* Gray */
            color: white; /* Ensure white text on gray background */
        }
        .cancel-edit-button:hover {
            background-color: #4b5563;
        }
        /* Ensure table is scrollable horizontally */
        .overflow-x-auto {
            overflow-x: auto;
        }
        table {
            min-width: 1200px; /* Ensure table is wide enough to prevent excessive wrapping */
        }

        /* Tab styles */
        .tab-button {
            background-color: #e2e8f0; /* Light gray for inactive tab */
            color: #4a5568; /* Dark gray text */
            padding: 0.75rem 1.5rem;
            border-top-left-radius: 0.5rem;
            border-top-right-radius: 0.5rem;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.2s ease-in-out, border-bottom-color 0.2s ease-in-out, color 0.2s ease-in-out;
            border-bottom: 2px solid transparent; /* Highlight active tab */
        }
        .tab-button.active {
            background-color: #fff; /* White for active tab */
            color: #006B68; /* Brand color 1 text for active tab */
            border-bottom: 2px solid #006B68; /* Brand color 1 border for active tab */
        }
        .tab-button:hover:not(.active) {
            background-color: #cbd5e0; /* Slightly darker gray on hover */
        }
        .tab-content {
            display: none;
            padding-top: 1rem;
        }
        .tab-content.active {
            display: block;
        }

        /* Collapsible section styles */
        .collapsible-header {
            background-color: #006B68; /* Brand color */
            color: white;
            padding: 1rem 1.5rem;
            border-radius: 0.5rem;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 1.25rem;
            font-weight: bold;
            margin-bottom: 1rem;
            transition: background-color 0.2s ease-in-out;
        }
        .collapsible-header:hover {
            background-color: #004F4C; /* Darker shade on hover */
        }
        .collapsible-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-out;
            padding: 0 1.5rem; /* Padding to match header, but top/bottom will be managed by max-height */
        }
        .collapsible-content.expanded {
            max-height: 400px; /* Adjusted to a more reasonable height for scrolling */
            overflow-y: auto; /* Add scrollbar for vertical overflow */
            padding: 1.5rem; /* Apply padding when expanded */
            border: 1px solid #e2e8f0;
            border-radius: 0.5rem;
            background-color: #fdfdfd;
        }
        .collapsible-header .icon {
            transition: transform 0.3s ease-out;
        }
        .collapsible-header.expanded .icon {
            transform: rotate(90deg);
        }

        /* Styling for AI explanation content */
        #explanationContentDiv, #simplifiedExplanationContentDiv {
            /* Removed whitespace-pre-wrap to allow normal HTML rendering */
            line-height: 1.6; /* Improve readability */
        }
        #simplifiedExplanationContentDiv p {
            margin-bottom: 0.75rem; /* Space between paragraphs */
        }
        #simplifiedExplanationContentDiv ul {
            list-style-type: disc;
            margin-left: 1.25rem;
            margin-bottom: 0.75rem;
        }
        #simplifiedExplanationContentDiv li {
            margin-bottom: 0.25rem;
        }

        /* Scroll to top button */
        #scrollToTopBtn {
            display: none; /* Hidden by default */
            position: fixed; /* Fixed position */
            bottom: 1.5rem; /* 24px from bottom */
            right: 1.5rem; /* 24px from right */
            background-color: #006B68; /* Brand color */
            color: white;
            padding: 0.75rem 1rem;
            border-radius: 9999px; /* Fully rounded */
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            cursor: pointer;
            transition: background-color 0.3s ease, opacity 0.3s ease;
            z-index: 1000; /* Ensure it's above other content */
        }
        #scrollToTopBtn:hover {
            background-color: #004F4C; /* Darker shade on hover */
        }
    </style>
</head>
<body class="p-4 sm:p-6 md:p-8 lg:p-12">
    <div class="max-w-5xl mx-auto bg-white p-6 sm:p-8 md:p-10 rounded-xl shadow-lg">
        <h1 class="text-3xl font-bold text-center mb-8 text-gray-800">Demo Chức Năng Tính Phí Tổng Hợp</h1>

        <!-- Instruction Section (New) -->
        <div class="mb-8 p-0 rounded-lg shadow-sm">
            <div id="instructionHeader" class="collapsible-header">
                <span><i class="fas fa-info-circle mr-2"></i> Hướng Dẫn & Nguyên Lý Tính Phí</span>
                <i class="fas fa-chevron-right icon"></i>
            </div>
            <div id="instructionContent" class="collapsible-content">
                <h3 class="text-xl font-semibold text-gray-700 mb-3">1) Nguyên lý và cơ chế tính phí</h3>
                <p class="mb-2">Hệ thống tính phí hoạt động dựa trên việc khớp các thuộc tính của giao dịch với các "Tham số Phí" đã được khai báo. Khi một giao dịch được thực hiện, hệ thống sẽ kiểm tra từng tham số phí để tìm ra quy tắc phù hợp nhất.</p>
                <p class="mb-2">Các tiêu chí chính để khớp tham số phí bao gồm:</p>
                <ul class="list-disc list-inside ml-4 mb-3">
                    <li><strong>Sản phẩm chuyển tiền (Payment Type):</strong> Ví dụ: Chuyển tiền nội bộ (IFT), Chuyển tiền trong nước đi (DRO).</li>
                    <li><strong>Giao dịch trong/ngoài hệ thống (On Us Transaction):</strong> Giao dịch giữa các tài khoản cùng ngân hàng hay khác ngân hàng.</li>
                    <li><strong>Ứng dụng thực hiện giao dịch (Channel ID):</strong> Kênh giao dịch như TPTL, WebCSR.</li>
                    <li><strong>Loại phí (Fee Type)</strong> áp dụng cho 1 sản phẩm chuyển tiền (bao gồm: Phí thực hiện giao dịch, Phí thiết lập chuyển tiền định kỳ và Phí chi trả).</li>
                    <li><strong>Cấp độ áp dụng biểu phí (Level Type):</strong> Mức độ áp dụng phí (toàn hệ thống, theo chi nhánh, theo khách hàng, theo gói sản phẩm, theo tỉnh/thành phố).</li>
                    <li><strong>Chi tiết cấp độ áp dụng biểu phí (Level Detail):</strong> Đây là giá trị cụ thể của cấp độ áp dụng biểu phí.
                        <ul class="list-disc list-inside ml-6 mt-2">
                            <li>Nếu <strong>Level Type</strong> là "HO (Áp dụng toàn hệ thống)", <strong>Level Detail</strong> sẽ mặc định là "HO".</li>
                            <li>Nếu <strong>Level Type</strong> là "PROVINCE (Theo địa bàn Tỉnh/thành phố)", <strong>Level Detail</strong> sẽ là mã tỉnh/thành phố (ví dụ: "01" cho Hà Nội, "79" cho TP.HCM).</li>
                            <li>Nếu <strong>Level Type</strong> là "BRANCH (Theo Chi nhánh)", <strong>Level Detail</strong> sẽ là mã chi nhánh (ví dụ: "120000" cho CN Sở Giao dịch I).</li>
                            <li>Nếu <strong>Level Type</strong> là "PACKAGE (Theo Gói sản phẩm)", <strong>Level Detail</strong> sẽ là mã gói sản phẩm (ví dụ: "PACKAGE_GOLD", "TEST UAT3").</li>
                            <li>Nếu <strong>Level Type</strong> là "CIF (Theo Khách hàng)", <strong>Level Detail</strong> sẽ là số CIF của khách hàng (ví dụ: "369565").</li>
                        </ul>
                        <p class="mt-2"><strong>Ví dụ:</strong> Nếu bạn muốn áp dụng phí cho khách hàng có số CIF "1234567", bạn sẽ chọn Level Type là "CIF" và nhập "1234567" vào Level Detail.</p>
                    </li>
                    <li><strong>Phạm vi áp dụng biểu phí (Branch):</strong> Tiêu chí này xác định chi nhánh hoặc phạm vi địa lý mà biểu phí được áp dụng.
                        <ul class="list-disc list-inside ml-6 mt-2">
                            <li>Nếu chọn "ALL (Toàn hệ thống)", biểu phí sẽ áp dụng cho tất cả các chi nhánh.</li>
                            <li>Nếu chọn một mã chi nhánh cụ thể (ví dụ: "120100 - CN HÀ NỘI"), biểu phí chỉ áp dụng cho giao dịch tại chi nhánh đó.</li>
                        </ul>
                        <p class="mt-2"><strong>Ví dụ:</strong> Nếu bạn muốn một biểu phí chỉ áp dụng riêng cho Chi nhánh Hà Nội, bạn sẽ chọn "120100 - CN HÀ NỘI" ở trường Branch.</p>
                    </li>
                    <li><strong>Mối quan hệ (Relationship):</strong> Mối quan hệ giữa chủ tài khoản và chi nhánh (ví dụ: cùng chủ tài khoản, cùng chi nhánh).</li>
                    <li><strong>Đối tượng khách hàng chịu phí (Customer Fee Type):</strong> Phân loại khách hàng (cá nhân, tổ chức, ngân hàng).</li>
                    <li><strong>Nguồn tiền giao dịch (Funding Option):</strong> Nguồn tiền được sử dụng cho giao dịch (tài khoản khách hàng, tiền mặt).</li>
                    <li><strong>Ngày hiệu lực (Effective Date From/To):</strong> Đảm bảo tham số phí còn hiệu lực tại thời điểm giao dịch.</li>
                </ul>
                <p class="mb-2">Khi một tham số phí khớp, hệ thống sẽ áp dụng "Mã Mức Phí" (Fee Code) được liên kết với tham số đó để tính toán số tiền phí. Mã Mức Phí có thể là:</p>
                <ul class="list-disc list-inside ml-4 mb-3">
                    <li><strong>Phí cố định (AMTFIX):</strong> Một số tiền cụ thể được áp dụng.</li>
                    <li><strong>Phí tỷ lệ (PERCENT):</strong> Một phần trăm của số tiền giao dịch.</li>
                    <li><strong>Giá trị tối thiểu (AMTMIN) và tối đa (AMTMAX):</strong> Giới hạn phí áp dụng khi tính theo tỷ lệ.</li>
                    <li><strong>Lựa chọn tối thiểu (Minimum Option):</strong> Quy định cách xử lý khi phí tính toán nhỏ hơn mức tối thiểu.</li>
                </ul>

                <h4 class="font-semibold mt-4 mb-2">Ví dụ minh họa:</h4>
                <p class="mb-2">Giả sử bạn khai báo một Tham số Phí như sau:</p>
                <ul class="list-disc list-inside ml-4 mb-3">
                    <li>Sản phẩm chuyển tiền: IFT</li>
                    <li>Giao dịch trong/ngoài hệ thống: ALL</li>
                    <li>Cấp độ áp dụng: HO (Toàn hệ thống)</li>
                    <li>Mã Mức phí VND: VND_0.02_10000_500000 (Phí 0.02%, Min 10.000 VND, Max 500.000 VND)</li>
                </ul>
                <p class="mb-2">Nếu bạn thực hiện giao dịch chuyển tiền nội bộ (IFT) với số tiền 10.000.000 VND:</p>
                <ul class="list-disc list-inside ml-4 mb-3">
                    <li>Phí ban đầu: $10.000.000 \times 0.02\% = 2.000$ VND.</li>
                    <li>Nếu "Lựa chọn tối thiểu" là `0` (Increase to Minimum): Vì 2.000 VND nhỏ hơn mức tối thiểu 10.000 VND, phí áp dụng sẽ là <strong>10.000 VND</strong>.</li>
                    <li>Nếu "Lựa chọn tối thiểu" là `1` (Reduce to Zero): Vì 2.000 VND nhỏ hơn mức tối thiểu 10.000 VND, phí áp dụng sẽ là <strong>0 VND</strong>.</li>
                </ul>
                <p class="mb-2">Nếu bạn thực hiện giao dịch với số tiền 5.000.000.000 VND:</p>
                <ul class="list-disc list-inside ml-4 mb-3">
                    <li>Phí ban đầu: $5.000.000.000 \times 0.02\% = 1.000.000$ VND.</li>
                    <li>Vì 1.000.000 VND lớn hơn mức tối đa 500.000 VND, phí áp dụng sẽ là <strong>500.000 VND</strong>.</li>
                </ul>

                <h3 class="text-xl font-semibold text-gray-700 mt-4 mb-3">2) Hướng dẫn sử dụng chương trình</h3>
                <p class="mb-2">Chương trình này mô phỏng quá trình khai báo và tính toán phí giao dịch. Bạn có thể tương tác với các phần sau:</p>
                <ul class="list-disc list-inside ml-4 mb-3">
                    <li><strong>Tab "1. Khai báo Tham số Phí":</strong>
                        <ul class="list-disc list-inside ml-6">
                            <li>Điền thông tin vào các trường để định nghĩa một tham số phí mới.</li>
                            <li>Nhấn "Lưu Tham Số" để thêm vào danh sách.</li>
                            <li>Bạn có thể "Chỉnh sửa" hoặc "Xóa" các tham số đã có trong bảng.</li>
                        </ul>
                    </li>
                    <li><strong>Tab "1.2.3. Khai báo Mã Mức Phí":</strong>
                        <ul class="list-disc list-inside ml-6">
                            <li>Định nghĩa các "Mã Mức Phí" với các giá trị cố định, tỷ lệ, min/max.</li>
                            <li>Các Mã Mức Phí này sẽ được sử dụng trong phần khai báo Tham số Phí.</li>
                        </ul>
                    </li>
                    <li><strong>Mục "3. Demo Chuyển Tiền":</strong>
                        <ul class="list-disc list-inside ml-6">
                            <li>Chọn một khách hàng demo từ danh sách để tự động điền các thông tin liên quan đến khách hàng vào các trường giao dịch tại Mục này.</li>
                            <li>Bạn cũng có thể tự chỉnh sửa các thông tin này sau khi tải.</li>
                            <li>Nhập "Số Tiền Chuyển Khoản" và các thông tin giao dịch khác.</li>
                            <li>Tất cả các tiêu chí để khớp phí sẽ được lấy trực tiếp từ các trường trong mục này.</li>
                            <li>Nhấn "Tính Phí" để xem kết quả "Tổng Phí" và "Số Tiền Khách Hàng Nhận Được", cùng với "Chi Tiết Tính Phí & Thuyết Minh Logic" đầy đủ.</li>
                            <li>Nhấn "✨ Giải thích phí dễ hiểu" để nhận được bản tóm tắt, đơn giản hóa của phần thuyết minh logic, giúp người dùng phổ thông dễ hiểu hơn.</li>
                            <li>Nhấn "Xóa Toàn Bộ Dữ Liệu" để xóa tất cả dữ liệu đã lưu trong trình duyệt và đặt lại chương trình về trạng thái ban đầu.</li>
                        </ul>
                    </li>
                </ul>
                <p>Mọi thay đổi bạn thực hiện trên các biểu mẫu và bảng sẽ được tự động lưu vào bộ nhớ cục bộ của trình duyệt (Local Storage) để bạn có thể tiếp tục công việc sau này.</p>
            </div>
        </div>

        <!-- Tab Navigation -->
        <div class="flex border-b border-gray-200 mb-6">
            <button class="tab-button active" data-tab="fee-params">1. Khai báo Tham số Phí</button>
            <button class="tab-button" data-tab="fee-codes">1.2.3. Khai báo Mã Mức Phí</button>
        </div>

        <!-- Tab Content: Fee Parameters -->
        <div id="fee-params-tab-content" class="tab-content active">
            <!-- Section 1: Fee Parameters -->
            <div class="mb-8 p-6 bg-gray-50 rounded-lg shadow-sm">
                <h2 class="text-2xl font-semibold text-gray-700 mb-4">1. Khai báo Phí</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    <div>
                        <label for="feePlanCode" class="block text-sm font-medium text-gray-700 mb-1">Mã Biểu phí (Fee Plan Code)</label>
                        <input type="text" id="feePlanCode" value="DN1B" class="w-full">
                    </div>
                    <div>
                        <label for="feeType" class="block text-sm font-medium text-gray-700 mb-1">Loại phí (Fee Type)</label>
                        <select id="feeType" class="w-full">
                            <option value="1">1 - Transaction Fee</option>
                            <option value="2">2 - SI Fee</option>
                            <option value="3">3 - Payout Fee</option>
                        </select>
                    </div>
                    <div>
                        <label for="paymentType" class="block text-sm font-medium text-gray-700 mb-1">Sản phẩm chuyển tiền (Payment Type)</label>
                        <select id="paymentType" class="w-full">
                            <option value="IFT">IFT - Chuyển tiền nội bộ BIDV</option>
                            <option value="DRO">DRO - Chuyển tiền trong nước đi</option>
                            <option value="INBP">INBP - Chuyển tiền liên chi nhánh (đi và chi trả)</option>
                            <option value="DROIN">DROIN - Chuyển tiền trong nước đến (chờ chi trả)</option>
                            <option value="SPO">SPO - Chuyển tiền định kỳ</option>
                            <option value="SCO">SCO - Nhờ thu định kỳ</option>
                            <option value="CBROUT">CBROUT - Chuyển tiền biên mậu đi</option>
                            <option value="CBRIN">CBRIN - Chuyển tiền biên mậu đến (đến và chi trả)</option>
                            <option value="CBRINV">CBRINV - Tra soát chuyển tiền biên mậu</option>
                        </select>
                    </div>
                    <div>
                        <label for="onUsTransaction" class="block text-sm font-medium text-gray-700 mb-1">Giao dịch trong/ ngoài hệ thống (On Us Transaction)</label>
                        <select id="onUsTransaction" class="w-full">
                            <option value="2">2 - ALL (Không phân biệt)</option>
                            <option value="1">1 - Yes (Trong hệ thống)</option>
                            <option value="0">0 - No (Ngoài hệ thống)</option>
                        </select>
                    </div>
                    <div>
                        <label for="channelID" class="block text-sm font-medium text-gray-700 mb-1">Ứng dụng thực hiện giao dịch (Channel ID)</label>
                        <select id="channelID" class="w-full">
                            <option value="22">22 - TPTL</option>
                            <option value="2">2 - WebCSR</option>
                            <option value="2000">2000 - WEBCSR Bulk Upload</option>
                            <option value="86">86 - IMAP</option>
                        </select>
                    </div>
                    <div>
                        <label for="effectiveDateFrom" class="block text-sm font-medium text-gray-700 mb-1">Ngày bắt đầu hiệu lực (Effective Date From)</label>
                        <input type="date" id="effectiveDateFrom" class="w-full">
                    </div>
                    <div>
                        <label for="effectiveDateTo" class="block text-sm font-medium text-gray-700 mb-1">Ngày hết hiệu lực (Effective Date To)</label>
                        <input type="date" id="effectiveDateTo" class="w-full">
                    </div>
                    <div>
                        <label for="levelType" class="block text-sm font-medium text-gray-700 mb-1">Cấp độ áp dụng biểu phí (Level Type)</label>
                        <select id="levelType" class="w-full">
                            <option value="5">5 - HO (Áp dụng toàn hệ thống)</option>
                            <option value="4">4 - PROVINCE (Theo địa bàn Tỉnh/thành phố)</option>
                            <option value="3">3 - BRANCH (Theo Chi nhánh)</option>
                            <option value="2">2 - PACKAGE (Theo Gói sản phẩm)</option>
                            <option value="1">1 - CIF (Theo Khách hàng)</option>
                        </select>
                    </div>
                    <div>
                        <label for="levelDetail" class="block text-sm font-medium text-gray-700 mb-1">Chi tiết cấp độ áp dụng biểu phí (Level Detail)</label>
                        <input type="text" id="levelDetail" value="HO" class="w-full">
                    </div>
                    <div>
                        <label for="branch" class="block text-sm font-medium text-gray-700 mb-1">Phạm vi áp dụng biểu phí (Branch)</label>
                        <select id="branch" class="w-full">
                            <option value="ALL">ALL (Toàn hệ thống)</option>
                            <option value="120000">120000 - CN SỞ GIAO DỊCH I</option>
                            <option value="120100">120100 - CN HÀ NỘI</option>
                            <option value="120150">120150 - PGD HOÀN KIẾM</option>
                            <option value="120200">120200 - CN ĐÔNG HÀ NỘI</option>
                        </select>
                    </div>
                    <div>
                        <label for="relationship" class="block text-sm font-medium text-gray-700 mb-1">Mối quan hệ (Relationship)</label>
                        <select id="relationship" class="w-full">
                            <option value="0">0 - ALL</option>
                            <option value="1">1 - Cùng chủ tài khoản, Cùng chi nhánh</option>
                            <option value="2">2 - Khác chủ tài khoản, Cùng chi nhánh</option>
                            <option value="3">3 - Cùng chủ tài khoản, Khác chi nhánh</option>
                            <option value="4">4 - Khác chủ tài khoản, Khác chi nhánh</option>
                        </select>
                    </div>
                    <div>
                        <label for="customerFeeType" class="block text-sm font-medium text-gray-700 mb-1">Đối tượng khách hàng chịu phí (Customer Fee Type)</label>
                        <select id="customerFeeType" class="w-full">
                            <option value="4">4 - Cá nhân/ Hộ gia đình</option>
                            <option value="1">1 - Ngân hàng</option>
                            <option value="2">2 - Định chế tài chính phi ngân hàng</option>
                            <option value="3">3 - Tổ chức</option>
                        </select>
                    </div>
                    <div>
                        <label for="fundingOption" class="block text-sm font-medium text-gray-700 mb-1">Nguồn tiền giao dịch (Funding Option)</label>
                        <select id="fundingOption" class="w-full">
                        <option value="2">2 - Tài khoản khách hàng</option>
                            <option value="ALL">ALL</option>
                            <option value="1">1 - Tiền mặt</option>
                            <option value="3">3 - Tài khoản GL</option>
                        </select>
                    </div>
                    <div>
                        <label for="feeCodeHomeCurrency" class="block text-sm font-medium text-gray-700 mb-1">Mã Mức phí VND (Fee Code – Home Currency)</label>
                        <select id="feeCodeHomeCurrency" class="w-full">
                            <!-- Options will be dynamically loaded by JS -->
                        </select>
                    </div>
                    <div>
                        <label for="feeCodeForeignCurrency" class="block text-sm font-medium text-gray-700 mb-1">Mã Mức phí ngoại tệ (Fee Code – Foreign Currency)</label>
                        <select id="feeCodeForeignCurrency" class="w-full">
                            <!-- Options will be dynamically loaded by JS -->
                        </select>
                    </div>
                </div>
                <div class="mt-6 flex flex-col sm:flex-row justify-center gap-4">
                    <button id="saveFeeParamBtn" class="btn-primary px-8 py-3 rounded-lg shadow-md hover:shadow-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-50">
                        <i class="fas fa-save"></i> Lưu Tham Số
                    </button>
                    <button id="cancelEditBtn" class="cancel-edit-button px-8 py-3 rounded-lg shadow-md hover:shadow-lg focus:outline-none focus:ring-2 focus:ring-gray-500 focus:ring-opacity-50 hidden">
                        <i class="fas fa-times-circle"></i> Hủy Chỉnh Sửa
                    </button>
                </div>
            </div>

            <div class="section-separator"></div>

            <!-- Section 1.1: Fee Parameters Table -->
            <div class="mb-8 p-6 bg-gray-50 rounded-lg shadow-sm">
                <h2 class="text-2xl font-semibold text-gray-700 mb-4">1.1. Danh sách Tham số Phí Đã Khai Báo</h2>
                <div class="flex flex-col sm:flex-row justify-between mb-4 gap-2">
                    <button id="deleteSelectedFeeParamsBtn" class="btn-primary px-4 py-2 rounded-lg shadow-md hover:shadow-lg focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-opacity-50 bg-red-500 hover:bg-red-600">
                        <i class="fas fa-trash-alt"></i> Xóa các bản ghi đã chọn
                    </button>
                    <div class="flex gap-2">
                        <button id="exportFeeParamsBtn" class="btn-primary px-4 py-2 rounded-lg shadow-md hover:shadow-lg focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-opacity-50 bg-green-500 hover:bg-green-600">
                            <i class="fas fa-file-excel"></i> Xuất Excel (CSV)
                        </button>
                        <input type="file" id="importFeeParamsInput" accept=".csv" class="hidden">
                        <button id="importFeeParamsBtn" class="btn-primary px-4 py-2 rounded-lg shadow-md hover:shadow-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-50 bg-blue-500 hover:bg-blue-600">
                            <i class="fas fa-file-import"></i> Nhập Excel (CSV)
                        </button>
                    </div>
                </div>
                <div class="overflow-x-auto">
                    <table class="min-w-full bg-white rounded-lg shadow-md">
                        <thead>
                            <tr class="bg-gray-200 text-gray-600 uppercase text-sm leading-normal">
                                <th class="py-3 px-3 text-left">
                                    <input type="checkbox" id="selectAllFeeParams">
                                </th>
                                <th class="py-3 px-3 text-left">Mã BP</th>
                                <th class="py-3 px-3 text-left">Loại phí</th>
                                <th class="py-3 px-3 text-left">Sản phẩm</th>
                                <th class="py-3 px-3 text-left">On Us Trans</th>
                                <th class="py-3 px-3 text-left">Channel ID</th>
                                <th class="py-3 px-3 text-left">Ngày BĐ HL</th>
                                <th class="py-3 px-3 text-left">Ngày KT HL</th>
                                <th class="py-3 px-3 text-left">Cấp độ</th>
                                <th class="py-3 px-3 text-left">Chi tiết CĐ</th>
                                <th class="py-3 px-3 text-left">Phạm vi Áp dụng</th>
                                <th class="py-3 px-3 text-left">Mối quan hệ</th>
                                <th class="py-3 px-3 text-left">Đối tượng KH</th>
                                <th class="py-3 px-3 text-left">Nguồn tiền</th>
                                <th class="py-3 px-3 text-left">Mã phí VND</th>
                                <th class="py-3 px-3 text-left">Mã phí Ngoại tệ</th>
                                <th class="py-3 px-3 text-center">Thao tác</th>
                            </tr>
                        </thead>
                        <tbody id="feeParametersTableBody" class="text-gray-700 text-sm font-light">
                            <!-- Table rows will be inserted here by JavaScript -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Tab Content: Fee Codes -->
        <div id="fee-codes-tab-content" class="tab-content">
            <!-- Section 1.2.3: Fee Code Declaration -->
            <div class="mb-8 p-6 bg-gray-50 rounded-lg shadow-sm">
                <h2 class="text-2xl font-semibold text-gray-700 mb-4">1.2.3. Khai báo Mã Mức Phí (Fee Code)</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    <div>
                        <label for="feeCode_code" class="block text-sm font-medium text-gray-700 mb-1">Mã mức phí (CODE)</label>
                        <input type="text" id="feeCode_code" class="w-full" placeholder="Ví dụ: VND_0.02_10.000_500.000">
                    </div>
                    <div>
                        <label for="feeCode_desc" class="block text-sm font-medium text-gray-700 mb-1">Mô tả Mã mức phí (DESC)</label>
                        <input type="text" id="feeCode_desc" class="w-full">
                    </div>
                    <div>
                        <label for="feeCode_currency" class="block text-sm font-medium text-gray-700 mb-1">Loại tiền của Mức phí (ZFEECRCD)</label>
                        <select id="feeCode_currency" class="w-full">
                            <option value="VND">VND</option>
                            <option value="USD">USD</option>
                            <option value="EUR">EUR</option>
                            <option value="CNY">CNY</option>
                            <option value="">Để trống (mặc định VND)</option>
                        </select>
                    </div>
                    <div>
                        <label for="feeCode_amtfix" class="block text-sm font-medium text-gray-700 mb-1">Số tiền cố định (AMTFIX)</label>
                        <input type="text" id="feeCode_amtfix" class="w-full text-right" placeholder="Để trống nếu không có">
                    </div>
                    <div>
                        <label for="feeCode_percent" class="block text-sm font-medium text-gray-700 mb-1">Giá trị % của Mức phí (PERCENT)</label>
                        <input type="number" id="feeCode_percent" step="0.01" class="w-full text-right" placeholder="Để trống nếu không có">
                    </div>
                    <div>
                        <label for="feeCode_amtmin" class="block text-sm font-medium text-gray-700 mb-1">Giá trị tối thiểu (AMTMIN)</label>
                        <input type="text" id="feeCode_amtmin" class="w-full text-right" placeholder="Để trống nếu không có">
                    </div>
                    <div>
                        <label for="feeCode_amtmax" class="block text-sm font-medium text-gray-700 mb-1">Giá trị tối đa (AMTMAX)</label>
                        <input type="text" id="feeCode_amtmax" class="w-full text-right" placeholder="Để trống nếu không có">
                    </div>
                    <!-- NEW FIELD: Minimum Option -->
                    <div>
                        <label for="feeCode_minimumOption" class="block text-sm font-medium text-gray-700 mb-1">Lựa chọn tối thiểu (Minimum Option)</label>
                        <select id="feeCode_minimumOption" class="w-full">
                            <option value="0">0 - Increase to Minimum when Calculated Amount is Less Than Minimum</option>
                            <option value="1">1 - Reduce to Zero if Calculated Amount is Less Than Minimum</option>
                        </select>
                    </div>
                </div>
                <div class="mt-6 flex flex-col sm:flex-row justify-center gap-4">
                    <button id="saveFeeCodeBtn" class="btn-primary px-8 py-3 rounded-lg shadow-md hover:shadow-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-50">
                        <i class="fas fa-save"></i> Lưu Mã Mức Phí
                    </button>
                    <button id="cancelFeeCodeEditBtn" class="cancel-edit-button px-8 py-3 rounded-lg shadow-md hover:shadow-lg focus:outline-none focus:ring-2 focus:ring-gray-500 focus:ring-opacity-50 hidden">
                        <i class="fas fa-times-circle"></i> Hủy Chỉnh Sửa
                    </button>
                </div>
            </div>

            <div class="section-separator"></div>

            <!-- Section 1.2.3.1: Fee Code Table -->
            <div class="mb-8 p-6 bg-gray-50 rounded-lg shadow-sm">
                <h2 class="text-2xl font-semibold text-gray-700 mb-4">1.2.3.1. Danh sách Mã Mức Phí</h2>
                <div class="overflow-x-auto">
                    <table class="min-w-full bg-white rounded-lg shadow-md">
                        <thead>
                            <tr class="bg-gray-200 text-gray-600 uppercase text-sm leading-normal">
                                <th class="py-3 px-3 text-left">Mã mức phí</th>
                                <th class="py-3 px-3 text-left">Mô tả</th>
                                <th class="py-3 px-3 text-left">Loại tiền</th>
                                <th class="py-3 px-3 text-right">Cố định</th>
                                <th class="py-3 px-3 text-right">Tỷ lệ (%)</th>
                                <th class="py-3 px-3 text-right">Min</th>
                                <th class="py-3 px-3 text-right">Max</th>
                                <th class="py-3 px-3 text-left">Lựa chọn tối thiểu</th>
                                <th class="py-3 px-3 text-center">Thao tác</th>
                            </tr>
                        </thead>
                        <tbody id="feeCodesTableBody" class="text-gray-700 text-sm font-light">
                            <!-- Table rows will be inserted here by JavaScript -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <div class="section-separator"></div>

        <!-- Section 3: Remittance Demo - Now self-contained for transaction inputs -->
        <div class="p-6 bg-gray-50 rounded-lg shadow-sm">
            <h2 class="text-2xl font-semibold text-gray-700 mb-4">3. Demo Chuyển Tiền</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-6">
                <!-- Moved Customer Demo fields -->
                <div class="md:col-span-full lg:col-span-3">
                    <label for="customerSelect" class="block text-sm font-medium text-gray-700 mb-1">Chọn Khách Hàng Demo</label>
                    <select id="customerSelect" class="w-full">
                        <!-- Options will be dynamically loaded by JS -->
                    </select>
                </div>
                <div>
                    <label for="customerName" class="block text-sm font-medium text-gray-700 mb-1">Tên Khách Hàng</label>
                    <input type="text" id="customerName" value="Nguyễn Văn A" class="w-full">
                </div>
                <!-- End of Moved Customer Demo fields -->

                <div>
                    <label for="transferAmount" class="block text-sm font-medium text-gray-700 mb-1">Số Tiền Chuyển Khoản (VND)</label>
                    <input type="text" id="transferAmount" value="1,000,000" class="w-full text-right">
                </div>
                <div>
                    <label for="recipientBank" class="block text-sm font-medium text-gray-700 mb-1">Ngân hàng thụ hưởng</label>
                    <select id="recipientBank" class="w-full">
                        <option value="BIDV">BIDV - Ngân hàng TMCP Đầu tư và Phát triển Việt Nam</option>
                        <option value="VCB">VCB - Ngân hàng TMCP Ngoại thương Việt Nam</option>
                        <option value="ACB">ACB - Ngân hàng TMCP Á Châu</option>
                        <option value="TPB">TPB - Ngân hàng TMCP Tiên Phong</option>
                        <option value="OTHER">Ngân hàng khác</option>
                    </select>
                </div>
                <div>
                    <label for="recipientAccount" class="block text-sm font-medium text-gray-700 mb-1">Số tài khoản thụ hưởng</label>
                    <input type="text" id="recipientAccount" value="1234567890" class="w-full">
                </div>
                <div>
                    <label for="transferMessage" class="block text-sm font-medium text-gray-700 mb-1">Nội dung chuyển khoản</label>
                    <textarea id="transferMessage" rows="2" class="w-full" placeholder="Nhập nội dung chuyển khoản"></textarea>
                </div>

                <!-- NEW FIELDS FOR TRANSACTION CONTEXT -->
                <div>
                    <label for="transfer_onUsTransaction" class="block text-sm font-medium text-gray-700 mb-1">Giao dịch trong/ ngoài hệ thống (On Us Transaction)</label>
                    <select id="transfer_onUsTransaction" class="w-full">
                        <option value="2">2 - ALL (Không phân biệt)</option>
                        <option value="1">1 - Yes (Trong hệ thống)</option>
                        <option value="0">0 - No (Ngoài hệ thống)</option>
                    </select>
                </div>
                <div>
                    <label for="transfer_channelID" class="block text-sm font-medium text-gray-700 mb-1">Kênh thực hiện giao dịch (Channel ID)</label>
                    <select id="transfer_channelID" class="w-full">
                        <option value="22">22 - TPTL</option>
                        <option value="2">2 - WebCSR</option>
                        <option value="2000">2000 - WEBCSR Bulk Upload</option>
                        <option value="86">86 - IMAP</option>
                    </select>
                </div>
                <div>
                    <label for="transfer_levelType" class="block text-sm font-medium text-gray-700 mb-1">Cấp độ áp dụng biểu phí (Level Type)</label>
                    <select id="transfer_levelType" class="w-full">
                        <option value="5">5 - HO (Áp dụng toàn hệ thống)</option>
                        <option value="4">4 - PROVINCE (Theo địa bàn Tỉnh/thành phố)</option>
                        <option value="3">3 - BRANCH (Theo Chi nhánh)</option>
                        <option value="2">2 - PACKAGE (Theo Gói sản phẩm)</option>
                        <option value="1">1 - CIF (Theo Khách hàng)</option>
                    </select>
                </div>
                <div>
                    <label for="transfer_levelDetail" class="block text-sm font-medium text-gray-700 mb-1">Chi tiết cấp độ áp dụng biểu phí (Level Detail)</label>
                    <input type="text" id="transfer_levelDetail" value="HO" class="w-full">
                </div>
                <div>
                    <label for="transfer_branch" class="block text-sm font-medium text-gray-700 mb-1">Phạm vi áp dụng biểu phí (Branch)</label>
                    <select id="transfer_branch" class="w-full">
                        <option value="ALL">ALL (Toàn hệ thống)</option>
                        <option value="120000">120000 - CN SỞ GIAO DỊCH I</option>
                        <option value="120100">120100 - CN HÀ NỘI</option>
                        <option value="120150">120150 - PGD HOÀN KIẾM</option>
                        <option value="120200">120200 - CN ĐÔNG HÀ NỘI</option>
                    </select>
                </div>
                <div>
                    <label for="transfer_relationship" class="block text-sm font-medium text-gray-700 mb-1">Mối quan hệ (Relationship)</label>
                    <select id="transfer_relationship" class="w-full">
                        <option value="0">0 - ALL</option>
                        <option value="1">1 - Cùng chủ tài khoản, Cùng chi nhánh</option>
                        <option value="2">2 - Khác chủ tài khoản, Cùng chi nhánh</option>
                        <option value="3">3 - Cùng chủ tài khoản, Khác chi nhánh</option>
                        <option value="4">4 - Khác chủ tài khoản, Khác chi nhánh</option>
                    </select>
                </div>
                <div>
                    <label for="transfer_customerFeeType" class="block text-sm font-medium text-gray-700 mb-1">Đối tượng khách hàng chịu phí (Customer Fee Type)</label>
                    <select id="transfer_customerFeeType" class="w-full">
                        <option value="4">4 - Cá nhân/ Hộ gia đình</option>
                        <option value="1">1 - Ngân hàng</option>
                        <option value="2">2 - Định chế tài chính phi ngân hàng</option>
                        <option value="3">3 - Tổ chức</option>
                    </select>
                </div>
                <div>
                    <label for="transfer_fundingOption" class="block text-sm font-medium text-gray-700 mb-1">Nguồn tiền giao dịch (Funding Option)</label>
                    <select id="transfer_fundingOption" class="w-full">
                        <option value="2">2 - Tài khoản khách hàng</option>
                        <option value="ALL">ALL</option>
                        <option value="1">1 - Tiền mặt</option>
                        <option value="3">3 - Tài khoản GL</option>
                    </select>
                </div>
            </div>

            <div class="mt-6 flex flex-col sm:flex-row justify-center gap-4">
                <button id="calculateBtn" class="btn-primary px-8 py-3 rounded-lg shadow-md hover:shadow-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-50">
                    <i class="fas fa-calculator"></i> Tính Phí
                </button>
                <button id="simplifyExplanationBtn" class="btn-primary px-8 py-3 rounded-lg shadow-md hover:shadow-lg focus:outline-none focus:ring-2 focus:ring-yellow-500 focus:ring-opacity-50">
                    <i class="fas fa-magic"></i> ✨ Giải thích phí dễ hiểu
                </button>
                <button id="clearDataBtn" class="px-8 py-3 rounded-lg shadow-md hover:shadow-lg focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-opacity-50">
                    <i class="fas fa-eraser"></i> Xóa Toàn Bộ Dữ Liệu
                </button>
            </div>

            <div class="mt-8 p-4 bg-white rounded-lg shadow-inner">
                <h3 class="text-xl font-semibold text-gray-700 mb-3"><i class="fas fa-info-circle"></i> Kết Quả Tính Phí</h3>
                <div class="space-y-2 mb-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Tổng Phí:</label>
                        <p id="totalFeeDisplay" class="text-lg font-bold text-blue-600">0 VND</p>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Số Tiền Khách Hàng Nhận Được:</label>
                        <p id="amountReceivedDisplay" class="text-lg font-bold text-green-600">0 VND</p>
                    </div>
                </div>
                <div id="feeCalculationExplanation" class="text-gray-800 text-sm bg-gray-100 p-3 rounded-md border border-gray-200">
                    <p class="font-bold mb-2">Chi Tiết Tính Phí & Thuyết Minh Logic:</p>
                    <div id="explanationContentDiv">Nhấn "Tính Phí" để xem chi tiết.</div>
                </div>
                <div id="simplifiedFeeExplanationContainer" class="mt-4 p-4 bg-gray-100 rounded-lg border border-gray-200">
                    <h3 class="text-xl font-semibold text-gray-700 mb-3"><i class="fas fa-magic"></i> Giải Thích Phí Dễ Hiểu ✨</h3>
                    <div id="simplifiedExplanationContentDiv" class="text-gray-700">Nhấn "Tính Phí" sau đó nhấn "Giải thích phí dễ hiểu" để xem.</div>
                </div>
                <div id="messageBox" class="hidden bg-yellow-100 border-l-4 border-yellow-500 text-yellow-700 p-4 rounded-md mt-4" role="alert">
                    <p class="font-bold">Lưu ý:</p>
                    <p id="messageText"></p>
                </div>
            </div>
        </div>
    </div>

    <!-- Scroll to Top Button -->
    <button id="scrollToTopBtn" title="Cuộn lên đầu trang">
        <i class="fas fa-arrow-up"></i>
    </button>

    <script>
        // Gemini API configuration
        const GEMINI_API_KEY = "AIzaSyBaLi7TzZJ9SwmHilU24SRcV2i7lU6gqdQ"; // THAY THẾ BẰNG API KEY CỦA BẠN TẠI ĐÂY
        const GEMINI_API_URL = "https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent";

        // Function to format numbers as currency (VND)
        function formatCurrency(amount) {
            return new Intl.NumberFormat('vi-VN', {
                style: 'currency',
                currency: 'VND',
                minimumFractionDigits: 0
            }).format(amount);
        }

        // Function to format number input with thousand separators
        function formatNumberInput(inputElement) {
            let value = inputElement.value.replace(/[^0-9]/g, ''); // Remove non-numeric characters
            if (value) {
                inputElement.value = new Intl.NumberFormat('en-US').format(parseFloat(value));
            } else {
                inputElement.value = '';
            }
        }

        // Function to parse formatted number string to float
        function parseFormattedNumber(formattedString) {
            return parseFloat(formattedString.replace(/,/g, ''));
        }

        // Function to show a custom message box instead of alert()
        function showMessageBox(message) {
            messageText.textContent = message;
            messageBox.classList.remove('hidden');
            // Optionally hide after some time
            setTimeout(() => {
                messageBox.classList.add('hidden');
            }, 5000);
        }

        // Helper function to get text content from select element based on value
        function getSelectText(selectElement, value) {
            const option = selectElement.querySelector(`option[value="${value}"]`);
            return option ? option.textContent : value;
        }

        // Mapping for display names of parameters
        const paramDisplayNames = {
            // Parameters for Fee Declaration (Section 1)
            feePlanCode: 'Mã Biểu phí (Fee Plan Code)',
            feeType: 'Loại phí (Fee Type)',
            paymentType_declaration: 'Sản phẩm chuyển tiền (Payment Type) (Khai báo)', // Clarify for declaration
            onUsTransaction_declaration: 'Giao dịch trong/ngoài hệ thống (On Us Transaction) (Khai báo)',
            channelID_declaration: 'Ứng dụng thực hiện giao dịch (Channel ID) (Khai báo)',
            effectiveDateFrom: 'Ngày bắt đầu hiệu lực (Effective Date From)',
            effectiveDateTo: 'Ngày hết hiệu lực (Effective Date To)',
            levelType_declaration: 'Cấp độ áp dụng biểu phí (Level Type) (Khai báo)',
            levelDetail_declaration: 'Chi tiết cấp độ áp dụng biểu phí (Level Detail) (Khai báo)',
            branch_declaration: 'Phạm vi áp dụng biểu phí (Branch) (Khai báo)',
            relationship_declaration: 'Mối quan hệ (Relationship) (Khai báo)',
            customerFeeType_declaration: 'Đối tượng khách hàng chịu phí (Customer Fee Type) (Khai báo)',
            fundingOption_declaration: 'Nguồn tiền giao dịch (Funding Option) (Khai báo)',
            feeCodeHomeCurrency: 'Mã Mức phí VND (Fee Code – Home Currency)',
            feeCodeForeignCurrency: 'Mã Mức phí ngoại tệ (Fee Code – Foreign Currency)',
            // New Fee Code Parameter
            minimumOption_declaration: 'Lựa chọn tối thiểu (Minimum Option)',


            // Parameters for Transaction Demo (Section 3)
            customerSelect: 'Chọn Khách Hàng Demo', // Moved
            customerName: 'Tên Khách Hàng', // Moved
            transferAmount: 'Số tiền chuyển khoản',
            recipientBank: 'Ngân hàng thụ hưởng',
            recipientAccount: 'Số tài khoản thụ hưởng',
            transferMessage: 'Nội dung chuyển khoản',
            paymentType_transaction: 'Sản phẩm chuyển tiền (Payment Type) (Giao dịch)', // Derived
            onUsTransaction_transaction: 'Giao dịch trong/ngoài hệ thống (On Us Transaction) (Giao dịch)',
            channelID_transaction: 'Kênh thực hiện giao dịch (Channel ID) (Giao dịch)',
            levelType_transaction: 'Cấp độ áp dụng biểu phí (Level Type) (Giao dịch)',
            levelDetail_transaction: 'Chi tiết cấp độ áp dụng biểu phí (Level Detail) (Giao dịch)',
            branch_transaction: 'Phạm vi áp dụng biểu phí (Branch) (Giao dịch)',
            relationship_transaction: 'Mối quan hệ (Relationship) (Giao dịch)',
            customerFeeType_transaction: 'Đối tượng khách hàng chịu phí (Customer Fee Type) (Giao dịch)',
            fundingOption_transaction: 'Nguồn tiền giao dịch (Funding Option) (Giao dịch)'
        };


        // Get references to DOM elements for Fee Parameters (Section 1)
        const feePlanCodeInput = document.getElementById('feePlanCode');
        const feeTypeSelect = document.getElementById('feeType');
        const paymentTypeSelect = document.getElementById('paymentType'); // This is the declaration payment type
        const onUsTransactionSelect = document.getElementById('onUsTransaction');
        const channelIDSelect = document.getElementById('channelID'); // Declaration channel ID
        const effectiveDateFromInput = document.getElementById('effectiveDateFrom');
        const effectiveDateToInput = document.getElementById('effectiveDateTo');
        const levelTypeSelect = document.getElementById('levelType');
        const levelDetailInput = document.getElementById('levelDetail');
        const branchSelect = document.getElementById('branch');
        const relationshipSelect = document.getElementById('relationship');
        const customerFeeTypeSelect = document.getElementById('customerFeeType');
        const fundingOptionSelect = document.getElementById('fundingOption');
        const feeCodeHomeCurrencySelect = document.getElementById('feeCodeHomeCurrency');
        const feeCodeForeignCurrencySelect = document.getElementById('feeCodeForeignCurrency');
        const saveFeeParamBtn = document.getElementById('saveFeeParamBtn');
        const cancelEditBtn = document.getElementById('cancelEditBtn');
        const feeParametersTableBody = document.getElementById('feeParametersTableBody');
        const selectAllFeeParamsCheckbox = document.getElementById('selectAllFeeParams'); // NEW
        const deleteSelectedFeeParamsBtn = document.getElementById('deleteSelectedFeeParamsBtn'); // NEW
        const exportFeeParamsBtn = document.getElementById('exportFeeParamsBtn'); // NEW
        const importFeeParamsBtn = document.getElementById('importFeeParamsBtn'); // NEW
        const importFeeParamsInput = document.getElementById('importFeeParamsInput'); // NEW

        // Get references to DOM elements for Fee Codes
        const feeCode_code_Input = document.getElementById('feeCode_code');
        const feeCode_desc_Input = document.getElementById('feeCode_desc');
        const feeCode_currency_Select = document.getElementById('feeCode_currency');
        const feeCode_amtfix_Input = document.getElementById('feeCode_amtfix');
        const feeCode_percent_Input = document.getElementById('feeCode_percent');
        const feeCode_amtmin_Input = document.getElementById('feeCode_amtmin');
        const feeCode_amtmax_Input = document.getElementById('feeCode_amtmax');
        const feeCode_minimumOption_Select = document.getElementById('feeCode_minimumOption'); // NEW
        const saveFeeCodeBtn = document.getElementById('saveFeeCodeBtn');
        const cancelFeeCodeEditBtn = document.getElementById('cancelFeeCodeEditBtn');
        const feeCodesTableBody = document.getElementById('feeCodesTableBody');

        // Get references to DOM elements for Transfer Demo (Section 3) - All transaction inputs
        const customerSelect = document.getElementById('customerSelect'); // MOVED
        const customerNameInput = document.getElementById('customerName'); // MOVED
        const transferAmountInput = document.getElementById('transferAmount');
        const recipientBankSelect = document.getElementById('recipientBank');
        const recipientAccountInput = document.getElementById('recipientAccount');
        const transferMessageInput = document.getElementById('transferMessage');
        const transfer_onUsTransactionSelect = document.getElementById('transfer_onUsTransaction'); // NEW
        const transfer_channelIDSelect = document.getElementById('transfer_channelID');
        const transfer_levelTypeSelect = document.getElementById('transfer_levelType'); // NEW
        const transfer_levelDetailInput = document.getElementById('transfer_levelDetail'); // NEW
        const transfer_branchSelect = document.getElementById('transfer_branch'); // NEW
        const transfer_relationshipSelect = document.getElementById('transfer_relationship');
        const transfer_customerFeeTypeSelect = document.getElementById('transfer_customerFeeType'); // NEW
        const transfer_fundingOptionSelect = document.getElementById('transfer_fundingOption');

        const explanationContentDiv = document.getElementById('explanationContentDiv');
        const simplifiedExplanationContentDiv = document.getElementById('simplifiedExplanationContentDiv');
        const simplifyExplanationBtn = document.getElementById('simplifyExplanationBtn');

        const calculateBtn = document.getElementById('calculateBtn');
        const clearDataBtn = document.getElementById('clearDataBtn');
        const totalFeeDisplay = document.getElementById('totalFeeDisplay');
        const amountReceivedDisplay = document.getElementById('amountReceivedDisplay');
        const messageBox = document.getElementById('messageBox');
        const messageText = document.getElementById('messageText');

        // Tab elements
        const tabButtons = document.querySelectorAll('.tab-button');
        const tabContents = document.querySelectorAll('.tab-content');

        // Collapsible instruction section elements
        const instructionHeader = document.getElementById('instructionHeader');
        const instructionContent = document.getElementById('instructionContent');

        // Scroll to top button
        const scrollToTopBtn = document.getElementById('scrollToTopBtn');

        let feeParametersData = []; // Array to store fee parameter objects
        let editingFeeParamId = null; // Stores the ID of the fee parameter being edited

        let feeCodesData = []; // Array to store fee code objects
        let editingFeeCodeId = null; // Stores the ID of the fee code being edited

        // Default values for inputs
        const defaultValues = {
            // Section 1: Fee Declaration Defaults
            feePlanCode: 'DN1B',
            feeType: '1', // Transaction Fee
            paymentType_declaration: 'IFT',
            onUsTransaction_declaration: '2', // ALL
            channelID_declaration: '22', // TPTL
            effectiveDateFrom: new Date().toISOString().slice(0, 10), // Current date
            effectiveDateTo: '2099-12-31', // Far future date
            levelType_declaration: '5', // HO
            levelDetail_declaration: 'HO',
            branch_declaration: 'ALL',
            relationship_declaration: '0', // ALL
            customerFeeType_declaration: '4', // Individual/Household
            fundingOption_declaration: '2', // Customer Account
            feeCodeHomeCurrency: 'VND_0.02_10000_500000',
            feeCodeForeignCurrency: 'USD_0.01_2_100',

            // Section 3: Transaction Demo Defaults
            customerName: 'Nguyễn Văn A', // Moved
            transferAmount: 1000000,
            recipientBank: 'BIDV',
            recipientAccount: '1234567890',
            transferMessage: 'Chuyển tiền demo',
            onUsTransaction_transaction: '2', // ALL
            channelID_transaction: '22', // TPTL
            levelType_transaction: '5', // HO
            levelDetail_transaction: 'HO',
            branch_transaction: 'ALL',
            relationship_transaction: '0', // ALL
            customerFeeType_transaction: '4', // Individual/Household
            fundingOption_transaction: '2' // Customer Account
        };

        // Demo data for fee parameters table
        const initialFeeParametersData = [
            {
                id: 'fp1', feePlanCode: 'DN1B', feeType: '1', paymentType: 'IFT', onUsTransaction: '2', channelID: '22',
                effectiveDateFrom: '2023-01-01', effectiveDateTo: '2099-12-31', levelType: '5', levelDetail: 'HO',
                branch: 'ALL', relationship: '0', customerFeeType: '4', fundingOption: '2',
                feeCodeHomeCurrency: 'VND_0.02_10000_500000', feeCodeForeignCurrency: ''
            },
            {
                id: 'fp2', feePlanCode: 'DN2B', feeType: '1', paymentType: 'DRO', onUsTransaction: '1', channelID: '2',
                effectiveDateFrom: '2023-01-01', effectiveDateTo: '2099-12-31', levelType: '3', levelDetail: '120100', // Branch 120100
                branch: '120100', relationship: '0', customerFeeType: '3', fundingOption: '1',
                feeCodeHomeCurrency: 'VND_0.01_15000_750000', feeCodeForeignCurrency: 'USD_0.01_5_100'
            },
            {
                id: 'fp3', feePlanCode: 'DN3F', feeType: '3', paymentType: 'INBP', onUsTransaction: '2', channelID: '22',
                effectiveDateFrom: '2023-01-01', effectiveDateTo: '2099-12-31', levelType: '1', levelDetail: '369565', // CIF 369565
                branch: 'ALL', relationship: '0', customerFeeType: '4', fundingOption: '2',
                feeCodeHomeCurrency: 'VND_FIX_5000', feeCodeForeignCurrency: ''
            },
            {
                id: 'fp4', feePlanCode: 'DN4C', feeType: '2', paymentType: 'SPO', onUsTransaction: '0', channelID: '2000',
                effectiveDateFrom: '2023-06-01', effectiveDateTo: '2024-12-31', levelType: '2', levelDetail: 'PACKAGE_GOLD', // Package GOLD
                branch: 'ALL', relationship: '0', customerFeeType: '1', fundingOption: '2',
                feeCodeHomeCurrency: 'VND_0.025_20000_1000000', feeCodeForeignCurrency: 'USD_0.025_5_50'
            }
        ];

        // Demo data for fee codes table
        const initialFeeCodesData = [
            {
                id: 'fc1', code: 'VND_0.02_10000_500000', desc: 'Phí 0.02%, Min 10k, Max 500k VND', currency: 'VND',
                amtfix: '', percent: 0.02, amtmin: 10000, amtmax: 500000, minimumOption: '0'
            },
            {
                id: 'fc2', code: 'USD_0.01_2_100', desc: 'Phí 0.01%, Min 2, Max 100 USD', currency: 'USD',
                amtfix: '', percent: 0.01, amtmin: 2, amtmax: 100, minimumOption: '0'
            },
            {
                id: 'fc3', code: 'OTHERFEECODE', desc: 'Mã phí khác (không tính phí)', currency: '',
                amtfix: '', percent: '', amtmin: '', amtmax: '', minimumOption: '0'
            },
            {
                id: 'fc4', code: 'VND_FIX_5000', desc: 'Phí cố định 5.000 VND', currency: 'VND',
                amtfix: 5000, percent: '', amtmin: '', amtmax: '', minimumOption: '0'
            },
            {
                id: 'fc5', code: 'VND_0.01_15000_750000', desc: 'Phí 0.01%, Min 15k, Max 750k VND', currency: 'VND',
                amtfix: '', percent: 0.01, amtmin: 15000, amtmax: 750000, minimumOption: '0'
            },
            {
                id: 'fc6', code: 'USD_0.01_5_100', desc: 'Phí 0.01%, Min 5, Max 100 USD', currency: 'USD',
                amtfix: '', percent: 0.01, amtmin: 5, amtmax: 100, minimumOption: '0'
            },
            {
                id: 'fc7', code: 'VND_0.025_20000_1000000', desc: 'Phí 0.025%, Min 20k, Max 1M VND', currency: 'VND',
                amtfix: '', percent: 0.025, amtmin: 20000, amtmax: 1000000, minimumOption: '0'
            },
            {
                id: 'fc8', code: 'USD_0.025_5_50', desc: 'Phí 0.025%, Min 5, Max 50 USD', currency: 'USD',
                amtfix: '', percent: 0.025, amtmin: 5, amtmax: 50, minimumOption: '0'
            }
        ];

        // Demo Customer Data (New) - These values will populate Section 3 fields
        const demoCustomers = [
            {
                id: 'cust1', name: 'Nguyễn Văn A (Cá nhân, HO)', transactionAmount: 1000000,
                onUsTransaction: '2', channelID: '22', levelType: '5', levelDetail: 'HO', branch: 'ALL',
                relationship: '0', customerFeeType: '4', fundingOption: '2'
            },
            {
                id: 'cust2', name: 'Công ty B (Tổ chức, CN Hà Nội)', transactionAmount: 5000000,
                onUsTransaction: '1', channelID: '2', levelType: '3', levelDetail: '120100', branch: '120100',
                relationship: '0', customerFeeType: '3', fundingOption: '1'
            },
            {
                id: 'cust3', name: 'Khách hàng VIP (CIF: 369565)', transactionAmount: 200000,
                onUsTransaction: '2', channelID: '86', levelType: '1', levelDetail: '369565', branch: 'ALL',
                relationship: '0', customerFeeType: '4', fundingOption: '2'
            },
            {
                id: 'cust4', name: 'Gói Vàng (Package: GOLD)', transactionAmount: 750000,
                onUsTransaction: '0', channelID: '2000', levelType: '2', levelDetail: 'PACKAGE_GOLD', branch: 'ALL',
                relationship: '0', customerFeeType: '1', fundingOption: '2'
            }
        ];

        // Function to update levelDetail input based on levelType selection (for Fee Parameters tab)
        function updateLevelDetailInput() {
            const levelType = levelTypeSelect.value;
            levelDetailInput.readOnly = false;
            levelDetailInput.value = ''; // Clear previous value
            levelDetailInput.placeholder = ''; // Clear previous placeholder

            switch (levelType) {
                case '1': // CIF
                    levelDetailInput.placeholder = 'Ví dụ: 369565 (Số CIF khách hàng)';
                    break;
                case '2': // PACKAGE
                    levelDetailInput.placeholder = 'Ví dụ: TEST UAT3 (Mã gói sản phẩm)';
                    break;
                case '3': // BRANCH
                    levelDetailInput.placeholder = 'Ví dụ: 120000 (Mã chi nhánh)';
                    break;
                case '4': // PROVINCE
                    levelDetailInput.placeholder = 'Ví dụ: 01 (Mã Tỉnh/thành phố)';
                    break;
                case '5': // HO
                    levelDetailInput.value = 'HO';
                    levelDetailInput.readOnly = true;
                    break;
                default:
                    levelDetailInput.placeholder = '';
                    break;
            }
            saveDataToLocalStorage(); // Save changes to levelDetail input
        }

        // Function to update transaction levelDetail input based on levelType selection (for Transaction Demo tab)
        function updateTransferLevelDetailInput() {
            const levelType = transfer_levelTypeSelect.value;
            transfer_levelDetailInput.readOnly = false;
            transfer_levelDetailInput.value = ''; // Clear previous value
            transfer_levelDetailInput.placeholder = ''; // Clear previous placeholder

            switch (levelType) {
                case '1': // CIF
                    transfer_levelDetailInput.placeholder = 'Ví dụ: 369565 (Số CIF khách hàng)';
                    break;
                case '2': // PACKAGE
                    transfer_levelDetailInput.placeholder = 'Ví dụ: TEST UAT3 (Mã gói sản phẩm)';
                    break;
                case '3': // BRANCH
                    transfer_levelDetailInput.placeholder = 'Ví dụ: 120000 (Mã chi nhánh)';
                    break;
                case '4': // PROVINCE
                    transfer_levelDetailInput.placeholder = 'Ví dụ: 01 (Mã Tỉnh/thành phố)';
                    break;
                case '5': // HO
                    transfer_levelDetailInput.value = 'HO';
                    transfer_levelDetailInput.readOnly = true;
                    break;
                default:
                    transfer_levelDetailInput.placeholder = '';
                    break;
            }
            saveDataToLocalStorage(); // Save changes to transfer_levelDetail input
        }

        // --- Customer Demo Functions ---
        function populateCustomerDropdown() {
            customerSelect.innerHTML = '<option value="">-- Chọn khách hàng demo --</option>';
            demoCustomers.forEach(customer => {
                const option = document.createElement('option');
                option.value = customer.id;
                option.textContent = customer.name;
                customerSelect.appendChild(option);
            });
        }

        function loadSelectedCustomerData() {
            const selectedCustomerId = customerSelect.value;
            const selectedCustomer = demoCustomers.find(cust => cust.id === selectedCustomerId);

            if (selectedCustomer) {
                customerNameInput.value = selectedCustomer.name;
                
                // Populate transaction fields in Section 3
                transferAmountInput.value = new Intl.NumberFormat('en-US').format(selectedCustomer.transactionAmount);
                recipientBankSelect.value = 'BIDV'; // Default to BIDV when loading customer
                transfer_onUsTransactionSelect.value = selectedCustomer.onUsTransaction;
                transfer_channelIDSelect.value = selectedCustomer.channelID;
                transfer_levelTypeSelect.value = selectedCustomer.levelType;
                transfer_levelDetailInput.value = selectedCustomer.levelDetail;
                transfer_branchSelect.value = selectedCustomer.branch;
                transfer_relationshipSelect.value = selectedCustomer.relationship;
                transfer_customerFeeTypeSelect.value = selectedCustomer.customerFeeType;
                transfer_fundingOptionSelect.value = selectedCustomer.fundingOption;

            } else {
                // Reset to default customer values if no customer is selected
                customerNameInput.value = 'Nguyễn Văn A'; // Default customer name

                transferAmountInput.value = new Intl.NumberFormat('en-US').format(defaultValues.transferAmount);
                recipientBankSelect.value = defaultValues.recipientBank;
                transfer_onUsTransactionSelect.value = defaultValues.onUsTransaction_transaction;
                transfer_channelIDSelect.value = defaultValues.channelID_transaction;
                transfer_levelTypeSelect.value = defaultValues.levelType_transaction;
                transfer_levelDetailInput.value = defaultValues.levelDetail_transaction;
                transfer_branchSelect.value = defaultValues.branch_transaction;
                transfer_relationshipSelect.value = defaultValues.relationship_transaction;
                transfer_customerFeeTypeSelect.value = defaultValues.customerFeeType_transaction;
                transfer_fundingOptionSelect.value = defaultValues.fundingOption_transaction;
            }
            updateTransferLevelDetailInput(); // Update placeholder/readonly for transfer_levelDetail
            saveDataToLocalStorage();
        }

        // Function to perform fee calculation
        function calculateFee() {
            try {
                const transferAmount = parseFormattedNumber(transferAmountInput.value);
                let totalFee = 0;
                let explanationHtml = '';

                // Reset simplified explanation
                simplifiedExplanationContentDiv.innerHTML = 'Nhấn "Tính Phí" sau đó nhấn "Giải thích phí dễ hiểu" để xem.';

                // Determine transaction Payment Type based on Recipient Bank
                const derivedPaymentType = (recipientBankSelect.value === 'BIDV' ? 'IFT' : 'DRO');

                // Collect all attributes for matching and display from Section 3
                const transactionAttributes = {
                    paymentType: derivedPaymentType, // Derived from recipientBank
                    onUsTransaction: transfer_onUsTransactionSelect.value,
                    channelID: transfer_channelIDSelect.value,
                    levelType: transfer_levelTypeSelect.value,
                    levelDetail: transfer_levelDetailInput.value,
                    branch: transfer_branchSelect.value,
                    relationship: transfer_relationshipSelect.value,
                    customerFeeType: transfer_customerFeeTypeSelect.value,
                    fundingOption: transfer_fundingOptionSelect.value,
                    
                    // Additional display-only transaction info
                    transferAmount: transferAmount,
                    recipientBank: recipientBankSelect.value,
                    recipientAccount: recipientAccountInput.value,
                    transferMessage: transferMessageInput.value
                };

                explanationHtml += '<strong>Chi Tiết Tính Phí & Thuyết Minh Logic:</strong>';
                explanationHtml += '<p><strong>📍THÔNG TIN GIAO DỊCH:</strong></p><ul>';
                
                // Display transaction attributes from Section 3
                explanationHtml += `<li><strong>${paramDisplayNames.customerSelect}:</strong> ${getSelectText(customerSelect, customerSelect.value)}</li>`; // Added
                explanationHtml += `<li><strong>${paramDisplayNames.customerName}:</strong> ${customerNameInput.value}</li>`; // Added
                explanationHtml += `<li><strong>${paramDisplayNames.transferAmount}:</strong> ${formatCurrency(transactionAttributes.transferAmount)}</li>`;
                explanationHtml += `<li><strong>${paramDisplayNames.recipientBank}:</strong> ${getSelectText(recipientBankSelect, transactionAttributes.recipientBank)}</li>`;
                explanationHtml += `<li><strong>${paramDisplayNames.recipientAccount}:</strong> ${transactionAttributes.recipientAccount}</li>`;
                explanationHtml += `<li><strong>${paramDisplayNames.transferMessage}:</strong> ${transactionAttributes.transferMessage}</li>`;
                explanationHtml += `<li><strong>${paramDisplayNames.paymentType_transaction}:</strong> ${getSelectText(paymentTypeSelect, transactionAttributes.paymentType)}</li>`; // Use paymentTypeSelect for text
                explanationHtml += `<li><strong>${paramDisplayNames.onUsTransaction_transaction}:</strong> ${getSelectText(transfer_onUsTransactionSelect, transactionAttributes.onUsTransaction)}</li>`;
                explanationHtml += `<li><strong>${paramDisplayNames.channelID_transaction}:</strong> ${getSelectText(transfer_channelIDSelect, transactionAttributes.channelID)}</li>`;
                explanationHtml += `<li><strong>${paramDisplayNames.levelType_transaction}:</strong> ${getSelectText(transfer_levelTypeSelect, transactionAttributes.levelType)}</li>`;
                explanationHtml += `<li><strong>${paramDisplayNames.levelDetail_transaction}:</strong> ${transactionAttributes.levelDetail}</li>`;
                explanationHtml += `<li><strong>${paramDisplayNames.branch_transaction}:</strong> ${getSelectText(transfer_branchSelect, transactionAttributes.branch)}</li>`;
                explanationHtml += `<li><strong>${paramDisplayNames.relationship_transaction}:</strong> ${getSelectText(transfer_relationshipSelect, transactionAttributes.relationship)}</li>`;
                explanationHtml += `<li><strong>${paramDisplayNames.customerFeeType_transaction}:</strong> ${getSelectText(transfer_customerFeeTypeSelect, transactionAttributes.customerFeeType)}</li>`;
                explanationHtml += `<li><strong>${paramDisplayNames.fundingOption_transaction}:</strong> ${getSelectText(transfer_fundingOptionSelect, transactionAttributes.fundingOption)}</li>`;
                
                explanationHtml += '</ul>';

                // Find a matching fee parameter
                let matchedFeeParam = null;
                const currentDate = new Date().toISOString().slice(0, 10);
                
                for (const param of feeParametersData) {
                    const isDateValid = (currentDate >= param.effectiveDateFrom && currentDate <= param.effectiveDateTo);
                    
                    const isMatch = isDateValid &&
                        (param.paymentType === transactionAttributes.paymentType) &&
                        (param.onUsTransaction === transactionAttributes.onUsTransaction) &&
                        (param.channelID === transactionAttributes.channelID) &&
                        (param.levelType === transactionAttributes.levelType) &&
                        (param.levelDetail === transactionAttributes.levelDetail) &&
                        (param.branch === 'ALL' || param.branch === transactionAttributes.branch) &&
                        (param.relationship === 'ALL' || param.relationship === transactionAttributes.relationship) &&
                        (param.customerFeeType === transactionAttributes.customerFeeType) &&
                        (param.fundingOption === 'ALL' || param.fundingOption === transactionAttributes.fundingOption);

                    if (isMatch) {
                        matchedFeeParam = param;
                        break;
                    }
                }

                explanationHtml += '<p><strong>❤️KẾT QUẢ KHỚP THAM SỐ:</strong></p><ul>';
                if (matchedFeeParam) {
                    explanationHtml += `<li><strong>Trạng thái khớp:</strong> Đã tìm thấy tham số phí phù hợp.</li>`;
                    explanationHtml += `<li><strong>Mã Biểu phí khớp:</strong> "${matchedFeeParam.feePlanCode}" (ID: ${matchedFeeParam.id})</li>`;

                    // List all parameters from matchedFeeParam and compare with transactionAttributes
                    const matchedParamKeys = Object.keys(matchedFeeParam).filter(key => key !== 'id'); // Exclude ID
                    for (const key of matchedParamKeys) {
                        let displayValue = matchedFeeParam[key];
                        let status = '';
                        let transactionValue = transactionAttributes[key]; // Value from the transaction

                        if (key === 'effectiveDateFrom' || key === 'effectiveDateTo') {
                            displayValue = matchedFeeParam[key];
                            status = `(Hợp lệ: ${currentDate} nằm trong khoảng ${matchedFeeParam.effectiveDateFrom} đến ${matchedFeeParam.effectiveDateTo})`;
                        } else if (matchedFeeParam[key] === 'ALL') {
                            status = '(Tham số áp dụng cho mọi trường hợp)';
                        } else if (matchedFeeParam[key] === transactionValue) {
                            status = '(Khớp)';
                        } else if (transactionValue === undefined) {
                             status = '(Không áp dụng cho giao dịch này)'; // If transaction attribute doesn't exist for this key
                        } else {
                            status = `(Không khớp: Giá trị tham số "${matchedFeeParam[key]}" khác giá trị giao dịch "${transactionValue}")`;
                        }

                        // Get display text for select values for declaration parameters
                        if (key === 'feeType') displayValue = getSelectText(feeTypeSelect, displayValue);
                        if (key === 'paymentType') displayValue = getSelectText(paymentTypeSelect, displayValue);
                        if (key === 'onUsTransaction') displayValue = getSelectText(onUsTransactionSelect, displayValue);
                        if (key === 'channelID') displayValue = getSelectText(channelIDSelect, displayValue);
                        if (key === 'levelType') displayValue = getSelectText(levelTypeSelect, displayValue);
                        if (key === 'branch') displayValue = getSelectText(branchSelect, displayValue);
                        if (key === 'relationship') displayValue = getSelectText(relationshipSelect, displayValue);
                        if (key === 'customerFeeType') displayValue = getSelectText(customerFeeTypeSelect, displayValue);
                        if (key === 'fundingOption') displayValue = getSelectText(fundingOptionSelect, displayValue);
                        
                        explanationHtml += `<li><strong>${paramDisplayNames[`${key}_declaration`] || paramDisplayNames[key] || key}:</strong> ${displayValue} ${status}</li>`;
                    }

                    const selectedHomeFeeCodeId = matchedFeeParam.feeCodeHomeCurrency;
                    if (selectedHomeFeeCodeId) {
                        const homeFeeCode = feeCodesData.find(code => code.code === selectedHomeFeeCodeId);
                        if (homeFeeCode) {
                            explanationHtml += `<li><strong>Mã Mức Phí VND được áp dụng:</strong> "${homeFeeCode.code}" - "${homeFeeCode.desc}"</li><ul>`;
                            if (homeFeeCode.amtfix !== '') {
                                totalFee = parseFloat(homeFeeCode.amtfix);
                                explanationHtml += `<li><strong>Loại phí:</strong> Cố định.</li>`;
                                explanationHtml += `<li><strong>Số tiền cố định được áp dụng:</strong> ${formatCurrency(totalFee)}.</li>`;
                            } else if (homeFeeCode.percent !== '') {
                                totalFee = (parseFloat(homeFeeCode.percent) / 100) * transferAmount;
                                explanationHtml += `<li><strong>Loại phí:</strong> Tỷ lệ (${homeFeeCode.percent}%).</li>`;
                                explanationHtml += `<li><strong>Số tiền phí ban đầu (trước khi áp dụng Min/Max):</strong> ${formatCurrency(totalFee)}.</li>`;

                                if (homeFeeCode.amtmin !== '') {
                                    const minAmount = parseFloat(homeFeeCode.amtmin);
                                    if (totalFee < minAmount) {
                                        if (homeFeeCode.minimumOption === '0') { // Increase to Minimum
                                            totalFee = minAmount;
                                            explanationHtml += `<li><strong>Áp dụng mức tối thiểu (Lựa chọn 0 - Tăng lên mức tối thiểu):</strong> ${formatCurrency(minAmount)} (vì phí ban đầu nhỏ hơn Min).</li>`;
                                        } else if (homeFeeCode.minimumOption === '1') { // Reduce to Zero
                                            totalFee = 0;
                                            explanationHtml += `<li><strong>Áp dụng mức tối thiểu (Lựa chọn 1 - Giảm về 0):</strong> ${formatCurrency(0)} (vì phí ban đầu nhỏ hơn Min).</li>`;
                                        }
                                    } else {
                                        explanationHtml += `<li>Mức tối thiểu (Min): ${formatCurrency(minAmount)} (Không áp dụng vì phí ban đầu lớn hơn hoặc bằng Min).</li>`;
                                    }
                                } else {
                                    explanationHtml += `<li>Mức tối thiểu (Min): Không áp dụng.</li>`;
                                }

                                if (homeFeeCode.amtmax !== '' && totalFee > parseFloat(homeFeeCode.amtmax)) {
                                    totalFee = parseFloat(homeFeeCode.amtmax);
                                    explanationHtml += `<li><strong>Áp dụng mức tối đa:</strong> ${formatCurrency(homeFeeCode.amtmax)} (vì phí ban đầu lớn hơn Max).</li>`;
                                } else if (homeFeeCode.amtmax === '') {
                                    explanationHtml += `<li>Mức tối đa (Max): Không áp dụng.</li>`;
                                } else {
                                    explanationHtml += `<li>Mức tối đa (Max): ${formatCurrency(homeFeeCode.amtmax)} (Không áp dụng vì phí ban đầu nhỏ hơn hoặc bằng Max).</li>`;
                                }
                            } else {
                                explanationHtml += `<li>Mã mức phí này không có giá trị cố định hoặc tỷ lệ. Phí được áp dụng: 0 VND.</li>`;
                            }
                            explanationHtml += '</ul>';
                        } else {
                            explanationHtml += `<li>Lỗi: Không tìm thấy chi tiết cho Mã mức phí VND: "${selectedHomeFeeCodeId}". Phí được áp dụng: 0 VND.</li>`;
                            showMessageBox(`Không tìm thấy chi tiết cho Mã mức phí VND: ${selectedHomeFeeCodeId}`);
                        }
                    } else {
                        explanationHtml += `<li>Tham số phí phù hợp không có Mã mức phí VND được khai báo. Phí được áp dụng: 0 VND.</li>`;
                        showMessageBox('Tham số phí phù hợp không có Mã mức phí VND được khai báo.');
                    }
                    
                    // Foreign currency fee code - explicitly state if not applicable
                    const selectedForeignFeeCodeId = matchedFeeParam.feeCodeForeignCurrency;
                    if (selectedForeignFeeCodeId) {
                        const foreignFeeCode = feeCodesData.find(code => code.code === selectedForeignFeeCodeId);
                        if (foreignFeeCode) {
                            explanationHtml += `<li><strong>Mã Mức Phí Ngoại tệ:</strong> "${foreignFeeCode.code}" - "${foreignFeeCode.desc}". (Không áp dụng cho giao dịch VND)</li>`;
                        } else {
                            explanationHtml += `<li><strong>Mã Mức Phí Ngoại tệ:</strong> "${selectedForeignFeeCodeId}" (Không tìm thấy chi tiết, không áp dụng cho giao dịch VND).</li>`;
                        }
                    } else {
                        explanationHtml += `<li><strong>Mã Mức Phí Ngoại tệ:</strong> Không được khai báo hoặc không áp dụng cho giao dịch VND.</li>`;
                    }

                } else {
                    explanationHtml += '<li><strong>Trạng thái khớp:</strong> Không tìm thấy tham số phí phù hợp cho khách hàng và giao dịch này dựa trên các tiêu chí đã chọn.</li>';
                    explanationHtml += '<li>Phí được áp dụng: 0 VND.</li>';
                    showMessageBox('Không tìm thấy tham số phí phù hợp cho khách hàng và giao dịch này. Vui lòng kiểm tra lại khai báo phí.');
                }
                explanationHtml += '</ul>';

                // Calculate amount customer receives
                const amountReceived = transferAmount - totalFee;

                // Update display using formatCurrency
                totalFeeDisplay.textContent = formatCurrency(totalFee);
                amountReceivedDisplay.textContent = formatCurrency(amountReceived);
                explanationContentDiv.innerHTML = explanationHtml; // Set innerHTML

                // Optional: Provide feedback if amount received is negative
                if (amountReceived < 0) {
                    showMessageBox('Lưu ý: Số tiền khách hàng nhận được là âm. Vui lòng kiểm tra lại số tiền giao dịch hoặc thông số phí.');
                }

            } catch (error) {
                console.error("Lỗi khi tính toán phí:", error);
                explanationContentDiv.innerHTML = `<p>Đã xảy ra lỗi trong quá trình tính toán: ${error.message}. Vui lòng thử lại.</p>`;
                showMessageBox('Đã xảy ra lỗi trong quá trình tính toán. Vui lòng thử lại.');
            }
        }

        // Function to get simplified explanation from Gemini API
        async function getSimplifiedFeeExplanation(detailedExplanation) {
            if (!detailedExplanation || detailedExplanation.trim() === 'Nhấn "Tính Phí" để xem chi tiết.') {
                return "Không có thông tin chi tiết để giải thích.";
            }

            const clientTimezone = Intl.DateTimeFormat().resolvedOptions().timeZone;
            const prompt = `Phân tích chi tiết tính phí sau đây và cung cấp một bản tóm tắt, giải thích dễ hiểu cho người dùng phổ thông bằng tiếng Việt.
            Hãy định dạng phản hồi của bạn bằng HTML (sử dụng các thẻ như <p>, <strong>, <ul>, <li>) một cách rõ ràng, mạch lạc, tránh các ký tự HTML thừa và đảm bảo khoảng cách dòng hợp lý để dễ đọc.
            Chi tiết tính phí: ${detailedExplanation}`;

            const geminiPayload = {
                contents: [
                    {
                        role: "user",
                        parts: [
                            {
                                text: prompt
                            }
                        ]
                    }
                ]
            };

            try {
                simplifiedExplanationContentDiv.innerHTML = "Đang tạo giải thích dễ hiểu... Vui lòng chờ.";
                simplifiedExplanationContentDiv.classList.add('text-gray-500', 'italic');

                if (!GEMINI_API_KEY) {
                    showMessageBox('Lỗi: Gemini API Key chưa được cấu hình. Vui lòng thêm API Key vào mã nguồn.');
                    return "Lỗi: Gemini API Key chưa được cấu hình.";
                }

                const response = await fetch(`${GEMINI_API_URL}?key=${GEMINI_API_KEY}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(geminiPayload)
                });

                const result = await response.json();

                if (response.ok && result.candidates && result.candidates.length > 0 && result.candidates[0].content && result.candidates[0].content.parts && result.candidates[0].content.parts.length > 0) {
                    const analysisText = result.candidates[0].content.parts[0].text;
                    return analysisText;
                } else {
                    console.error("Error from Gemini API:", result.error || "Unknown error", result);
                    return `Lỗi từ Gemini API: ${result.error?.message || JSON.stringify(result)}. Vui lòng kiểm tra console để biết chi tiết.`;
                }
            } catch (error) {
                console.error("Error calling Gemini API:", error);
                return `Lỗi khi gọi Gemini API: ${error.message}. Vui lòng thử lại.`;
            } finally {
                simplifiedExplanationContentDiv.classList.remove('text-gray-500', 'italic');
                // Scroll to the simplified explanation section
                simplifiedExplanationContentDiv.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }
        }

        // --- Fee Parameters Table Functions ---
        function renderFeeParametersTable() {
            feeParametersTableBody.innerHTML = ''; // Clear existing rows
            selectAllFeeParamsCheckbox.checked = false; // Uncheck select all checkbox

            if (feeParametersData.length === 0) {
                const noDataRow = document.createElement('tr');
                noDataRow.innerHTML = `<td colspan="17" class="py-3 px-6 text-center text-gray-500">Chưa có tham số phí nào được khai báo.</td>`;
                feeParametersTableBody.appendChild(noDataRow);
                return;
            }

            feeParametersData.forEach(param => {
                const row = document.createElement('tr');
                row.className = 'border-b border-gray-200 hover:bg-gray-100';
                row.innerHTML = `
                    <td class="py-3 px-3 text-left">
                        <input type="checkbox" class="fee-param-checkbox" data-id="${param.id}">
                    </td>
                    <td class="py-3 px-3 text-left whitespace-nowrap">${param.feePlanCode}</td>
                    <td class="py-3 px-3 text-left">${getSelectText(feeTypeSelect, param.feeType)}</td>
                    <td class="py-3 px-3 text-left">${getSelectText(paymentTypeSelect, param.paymentType).split(' - ')[0]}</td>
                    <td class="py-3 px-3 text-left">${getSelectText(onUsTransactionSelect, param.onUsTransaction).split(' - ')[0]}</td>
                    <td class="py-3 px-3 text-left">${getSelectText(channelIDSelect, param.channelID).split(' - ')[0]}</td>
                    <td class="py-3 px-3 text-left">${param.effectiveDateFrom}</td>
                    <td class="py-3 px-3 text-left">${param.effectiveDateTo}</td>
                    <td class="py-3 px-3 text-left">${getSelectText(levelTypeSelect, param.levelType).split(' - ')[0]}</td>
                    <td class="py-3 px-3 text-left">${param.levelDetail}</td>
                    <td class="py-3 px-3 text-left">${getSelectText(branchSelect, param.branch).split(' - ')[0]}</td>
                    <td class="py-3 px-3 text-left">${getSelectText(relationshipSelect, param.relationship).split(' - ')[0]}</td>
                    <td class="py-3 px-3 text-left">${getSelectText(customerFeeTypeSelect, param.customerFeeType).split(' - ')[0]}</td>
                    <td class="py-3 px-3 text-left">${getSelectText(fundingOptionSelect, param.fundingOption).split(' - ')[0]}</td>
                    <td class="py-3 px-3 text-left">${param.feeCodeHomeCurrency}</td>
                    <td class="py-3 px-3 text-left">${param.feeCodeForeignCurrency}</td>
                    <td class="py-3 px-3 text-center whitespace-nowrap">
                        <button onclick="editFeeParameter('${param.id}')" class="action-button edit-button rounded-md hover:bg-amber-600"><i class="fas fa-edit"></i> Chỉnh sửa</button>
                        <button onclick="deleteFeeParameter('${param.id}')" class="action-button delete-button rounded-md hover:bg-red-600"><i class="fas fa-trash-alt"></i> Xóa</button>
                    </td>
                `;
                feeParametersTableBody.appendChild(row);
            });
            saveDataToLocalStorage(); // Save after rendering
        }

        function addOrUpdateFeeParameter() {
            const newParam = {
                id: editingFeeParamId || Date.now().toString(), // Use existing ID or generate new
                feePlanCode: feePlanCodeInput.value,
                feeType: feeTypeSelect.value,
                paymentType: paymentTypeSelect.value,
                onUsTransaction: onUsTransactionSelect.value,
                channelID: channelIDSelect.value,
                effectiveDateFrom: effectiveDateFromInput.value,
                effectiveDateTo: effectiveDateToInput.value,
                levelType: levelTypeSelect.value,
                levelDetail: levelDetailInput.value,
                branch: branchSelect.value,
                relationship: relationshipSelect.value,
                customerFeeType: customerFeeTypeSelect.value,
                fundingOption: fundingOptionSelect.value,
                feeCodeHomeCurrency: feeCodeHomeCurrencySelect.value,
                feeCodeForeignCurrency: feeCodeForeignCurrencySelect.value
            };

            // Basic validation for required fields
            if (!newParam.feePlanCode || !newParam.effectiveDateFrom || !newParam.effectiveDateTo || !newParam.levelDetail || (!newParam.feeCodeHomeCurrency && !newParam.feeCodeForeignCurrency)) {
                showMessageBox('Vui lòng điền đầy đủ các trường bắt buộc và chọn ít nhất một Mã mức phí.');
                return;
            }

            if (editingFeeParamId) {
                // Update existing parameter
                const index = feeParametersData.findIndex(p => p.id === editingFeeParamId);
                if (index !== -1) {
                    feeParametersData[index] = newParam;
                    showMessageBox('Tham số phí đã được cập nhật.');
                }
                editingFeeParamId = null; // Exit edit mode
                cancelEditBtn.classList.add('hidden');
                saveFeeParamBtn.innerHTML = '<i class="fas fa-save"></i> Lưu Tham Số'; // Reset button text and icon
            } else {
                // Add new parameter
                feeParametersData.push(newParam);
                showMessageBox('Tham số phí đã được thêm mới.');
            }
            clearFeeParameterForm(); // Clear form after saving
            renderFeeParametersTable(); // Re-render table
        }

        function editFeeParameter(id) {
            const paramToEdit = feeParametersData.find(p => p.id === id);
            if (paramToEdit) {
                feePlanCodeInput.value = paramToEdit.feePlanCode;
                feeTypeSelect.value = paramToEdit.feeType;
                paymentTypeSelect.value = paramToEdit.paymentType;
                onUsTransactionSelect.value = paramToEdit.onUsTransaction;
                channelIDSelect.value = paramToEdit.channelID;
                effectiveDateFromInput.value = paramToEdit.effectiveDateFrom;
                effectiveDateToInput.value = paramToEdit.effectiveDateTo;
                levelTypeSelect.value = paramToEdit.levelType;
                levelDetailInput.value = paramToEdit.levelDetail;
                branchSelect.value = paramToEdit.branch;
                relationshipSelect.value = paramToEdit.relationship;
                customerFeeTypeSelect.value = paramToEdit.customerFeeType;
                fundingOptionSelect.value = paramToEdit.fundingOption;
                feeCodeHomeCurrencySelect.value = paramToEdit.feeCodeHomeCurrency;
                feeCodeForeignCurrencySelect.value = paramToEdit.feeCodeForeignCurrency;

                editingFeeParamId = id; // Set editing mode
                saveFeeParamBtn.innerHTML = '<i class="fas fa-pencil-alt"></i> Cập nhật Tham Số'; // Change button text and icon
                cancelEditBtn.classList.remove('hidden');
                updateLevelDetailInput(); // Update placeholder/readonly for levelDetail
                window.scrollTo({ top: 0, behavior: 'smooth' }); // Scroll to top
            }
        }

        function deleteFeeParameter(ids) {
            // Ensure `ids` is always an array
            const idsToDelete = Array.isArray(ids) ? ids : [ids];

            if (idsToDelete.length === 0) {
                showMessageBox('Vui lòng chọn ít nhất một bản ghi để xóa.');
                return;
            }

            if (confirm(`Bạn có chắc chắn muốn xóa ${idsToDelete.length} tham số phí này?`)) {
                feeParametersData = feeParametersData.filter(p => !idsToDelete.includes(p.id));
                renderFeeParametersTable();
                showMessageBox(`${idsToDelete.length} tham số phí đã được xóa.`);
                if (editingFeeParamId && idsToDelete.includes(editingFeeParamId)) { // If the deleted item was being edited
                    cancelEditFeeParam();
                }
            }
        }

        function clearFeeParameterForm() {
            feePlanCodeInput.value = defaultValues.feePlanCode;
            feeTypeSelect.value = defaultValues.feeType;
            paymentTypeSelect.value = defaultValues.paymentType_declaration;
            onUsTransactionSelect.value = defaultValues.onUsTransaction_declaration;
            channelIDSelect.value = defaultValues.channelID_declaration;
            effectiveDateFromInput.value = defaultValues.effectiveDateFrom;
            effectiveDateToInput.value = defaultValues.effectiveDateTo;
            levelTypeSelect.value = defaultValues.levelType_declaration;
            levelDetailInput.value = defaultValues.levelDetail_declaration;
            branchSelect.value = defaultValues.branch_declaration;
            relationshipSelect.value = defaultValues.relationship_declaration;
            customerFeeTypeSelect.value = defaultValues.customerFeeType_declaration;
            fundingOptionSelect.value = defaultValues.fundingOption_declaration;
            feeCodeHomeCurrencySelect.value = '';
            feeCodeForeignCurrencySelect.value = '';
            updateLevelDetailInput(); // Reset levelDetail input placeholder/readonly
        }

        function cancelEditFeeParam() {
            editingFeeParamId = null;
            saveFeeParamBtn.innerHTML = '<i class="fas fa-save"></i> Lưu Tham Số'; // Reset button text and icon
            cancelEditBtn.classList.add('hidden');
            clearFeeParameterForm();
        }

        // --- Multi-select Delete Functions ---
        function toggleAllFeeParamsCheckboxes() {
            const checkboxes = document.querySelectorAll('.fee-param-checkbox');
            checkboxes.forEach(checkbox => {
                checkbox.checked = selectAllFeeParamsCheckbox.checked;
            });
        }

        function deleteSelectedFeeParameters() {
            const selectedIds = Array.from(document.querySelectorAll('.fee-param-checkbox:checked'))
                                 .map(checkbox => checkbox.dataset.id);
            deleteFeeParameter(selectedIds);
        }

        // --- Export/Import Functions ---
        function convertToCsv(data) {
            if (data.length === 0) return '';

            const headers = Object.keys(data[0]);
            const csvRows = [];

            // Add header row
            csvRows.push(headers.map(header => `"${header}"`).join(','));

            // Add data rows
            for (const row of data) {
                const values = headers.map(header => {
                    const value = row[header];
                    // Handle null/undefined, and escape double quotes
                    return `"${value === null || value === undefined ? '' : String(value).replace(/"/g, '""')}"`;
                });
                csvRows.push(values.join(','));
            }
            return csvRows.join('\n');
        }

        function exportFeeParametersToCsv() {
            const csvContent = convertToCsv(feeParametersData);
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.setAttribute('download', 'fee_parameters.csv');
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            showMessageBox('Dữ liệu tham số phí đã được xuất ra file "fee_parameters.csv".');
        }

        function importFeeParametersFromCsv(event) {
            const file = event.target.files[0];
            if (!file) {
                showMessageBox('Vui lòng chọn một tệp CSV để nhập.');
                return;
            }

            if (file.type !== 'text/csv') {
                showMessageBox('Tệp được chọn không phải là định dạng CSV. Vui lòng chọn tệp CSV.');
                return;
            }

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const csvText = e.target.result;
                    const importedData = parseCsv(csvText);

                    if (importedData.length === 0) {
                        showMessageBox('Tệp CSV không chứa dữ liệu hoặc định dạng không hợp lệ.');
                        return;
                    }

                    // Basic validation: Check if essential headers exist
                    const requiredHeaders = ['id', 'feePlanCode', 'effectiveDateFrom', 'effectiveDateTo', 'levelDetail'];
                    const hasRequiredHeaders = requiredHeaders.every(header => Object.keys(importedData[0]).includes(header));

                    if (!hasRequiredHeaders) {
                        showMessageBox('Tệp CSV có vẻ không đúng định dạng. Thiếu một số cột cần thiết (id, feePlanCode, effectiveDateFrom, effectiveDateTo, levelDetail).');
                        return;
                    }

                    // Assign new IDs to imported data to avoid conflicts if IDs are not unique
                    const processedData = importedData.map(item => ({
                        ...item,
                        id: item.id && feeParametersData.some(p => p.id === item.id) ? Date.now().toString() + Math.random().toString(36).substring(2, 8) : item.id || Date.now().toString() + Math.random().toString(36).substring(2, 8)
                    }));


                    feeParametersData = processedData; // Replace existing data
                    renderFeeParametersTable();
                    showMessageBox(`Đã nhập thành công ${importedData.length} tham số phí từ tệp CSV.`);
                } catch (error) {
                    console.error("Lỗi khi nhập tệp CSV:", error);
                    showMessageBox(`Lỗi khi xử lý tệp CSV: ${error.message}. Vui lòng kiểm tra định dạng tệp.`);
                }
            };
            reader.readAsText(file);
        }

        function parseCsv(csvString) {
            const lines = csvString.split('\n').filter(line => line.trim() !== '');
            if (lines.length === 0) return [];

            const headers = lines[0].split(',').map(header => header.trim().replace(/^"|"$/g, ''));
            const result = [];

            for (let i = 1; i < lines.length; i++) {
                const values = parseCsvLine(lines[i]);
                if (values.length !== headers.length) {
                    console.warn(`Dòng ${i + 1} có số cột không khớp với tiêu đề. Bỏ qua dòng này.`);
                    continue;
                }
                const rowObject = {};
                for (let j = 0; j < headers.length; j++) {
                    rowObject[headers[j]] = values[j];
                }
                result.push(rowObject);
            }
            return result;
        }

        // Helper to parse a single CSV line, handling quoted fields
        function parseCsvLine(line) {
            const result = [];
            let inQuote = false;
            let currentField = '';
            for (let i = 0; i < line.length; i++) {
                const char = line[i];
                if (char === '"') {
                    if (inQuote && i + 1 < line.length && line[i+1] === '"') {
                        // Escaped double quote ""
                        currentField += '"';
                        i++; // Skip the next quote
                    } else {
                        inQuote = !inQuote;
                    }
                } else if (char === ',' && !inQuote) {
                    result.push(currentField.trim());
                    currentField = '';
                } else {
                    currentField += char;
                }
            }
            result.push(currentField.trim()); // Add the last field
            return result.map(field => field.replace(/^"|"$/g, '')); // Remove surrounding quotes
        }


        // --- Fee Codes Table Functions ---
        function populateFeeCodeDropdowns() {
            feeCodeHomeCurrencySelect.innerHTML = '<option value="">-- Chọn --</option>';
            feeCodeForeignCurrencySelect.innerHTML = '<option value="">-- Chọn --</option>';

            feeCodesData.forEach(code => {
                const option = document.createElement('option');
                option.value = code.code;
                option.textContent = code.code + (code.desc ? ` - ${code.desc}` : '');
                
                if (code.currency === 'VND' || code.currency === '') { // Assuming empty currency defaults to VND
                    feeCodeHomeCurrencySelect.appendChild(option.cloneNode(true));
                } else {
                    feeCodeForeignCurrencySelect.appendChild(option.cloneNode(true));
                }
            });
        }

        function renderFeeCodesTable() {
            feeCodesTableBody.innerHTML = ''; // Clear existing rows
            if (feeCodesData.length === 0) {
                const noDataRow = document.createElement('tr');
                noDataRow.innerHTML = `<td colspan="9" class="py-3 px-6 text-center text-gray-500">Chưa có mã mức phí nào được khai báo.</td>`;
                feeCodesTableBody.appendChild(noDataRow);
                return;
            }

            feeCodesData.forEach(code => {
                const row = document.createElement('tr');
                row.className = 'border-b border-gray-200 hover:bg-gray-100';
                row.innerHTML = `
                    <td class="py-3 px-3 text-left whitespace-nowrap">${code.code}</td>
                    <td class="py-3 px-3 text-left">${code.desc}</td>
                    <td class="py-3 px-3 text-left">${code.currency}</td>
                    <td class="py-3 px-3 text-right">${code.amtfix ? new Intl.NumberFormat('en-US').format(code.amtfix) : ''}</td>
                    <td class="py-3 px-3 text-right">${code.percent !== '' ? code.percent + '%' : ''}</td>
                    <td class="py-3 px-3 text-right">${code.amtmin ? new Intl.NumberFormat('en-US').format(code.amtmin) : ''}</td>
                    <td class="py-3 px-3 text-right">${code.amtmax ? new Intl.NumberFormat('en-US').format(code.amtmax) : ''}</td>
                    <td class="py-3 px-3 text-left">${getSelectText(feeCode_minimumOption_Select, code.minimumOption)}</td>
                    <td class="py-3 px-3 text-center whitespace-nowrap">
                        <button onclick="editFeeCode('${code.id}')" class="action-button edit-button rounded-md hover:bg-amber-600"><i class="fas fa-edit"></i> Chỉnh sửa</button>
                        <button onclick="deleteFeeCode('${code.id}')" class="action-button delete-button rounded-md hover:bg-red-600"><i class="fas fa-trash-alt"></i> Xóa</button>
                    </td>
                `;
                feeCodesTableBody.appendChild(row);
            });
            saveDataToLocalStorage(); // Save after rendering
        }

        function addOrUpdateFeeCode() {
            const newFeeCode = {
                id: editingFeeCodeId || Date.now().toString(),
                code: feeCode_code_Input.value,
                desc: feeCode_desc_Input.value,
                currency: feeCode_currency_Select.value,
                amtfix: feeCode_amtfix_Input.value ? parseFormattedNumber(feeCode_amtfix_Input.value) : '',
                percent: feeCode_percent_Input.value ? parseFloat(feeCode_percent_Input.value) : '',
                amtmin: feeCode_amtmin_Input.value ? parseFormattedNumber(feeCode_amtmin_Input.value) : '',
                amtmax: feeCode_amtmax_Input.value ? parseFormattedNumber(feeCode_amtmax_Input.value) : '',
                minimumOption: feeCode_minimumOption_Select.value // NEW FIELD
            };

            // Basic validation
            if (!newFeeCode.code) {
                showMessageBox('Vui lòng nhập Mã mức phí (CODE).');
                return;
            }

            if (editingFeeCodeId) {
                const index = feeCodesData.findIndex(c => c.id === editingFeeCodeId);
                if (index !== -1) {
                    feeCodesData[index] = newFeeCode;
                    showMessageBox('Mã mức phí đã được cập nhật.');
                }
                editingFeeCodeId = null;
                cancelFeeCodeEditBtn.classList.add('hidden');
                saveFeeCodeBtn.innerHTML = '<i class="fas fa-save"></i> Lưu Mã Mức Phí'; // Reset button text and icon
            } else {
                feeCodesData.push(newFeeCode);
                showMessageBox('Mã mức phí đã được thêm mới.');
            }
            clearFeeCodeForm();
            populateFeeCodeDropdowns(); // Re-populate dropdowns after adding/updating
            renderFeeCodesTable();
        }

        function editFeeCode(id) {
            const codeToEdit = feeCodesData.find(c => c.id === id);
            if (codeToEdit) {
                feeCode_code_Input.value = codeToEdit.code;
                feeCode_desc_Input.value = codeToEdit.desc;
                feeCode_currency_Select.value = codeToEdit.currency;
                feeCode_amtfix_Input.value = codeToEdit.amtfix ? new Intl.NumberFormat('en-US').format(codeToEdit.amtfix) : '';
                feeCode_percent_Input.value = codeToEdit.percent;
                feeCode_amtmin_Input.value = codeToEdit.amtmin ? new Intl.NumberFormat('en-US').format(codeToEdit.amtmin) : '';
                feeCode_amtmax_Input.value = codeToEdit.amtmax ? new Intl.NumberFormat('en-US').format(codeToEdit.amtmax) : '';
                feeCode_minimumOption_Select.value = codeToEdit.minimumOption; // NEW FIELD

                editingFeeCodeId = id;
                saveFeeCodeBtn.innerHTML = '<i class="fas fa-pencil-alt"></i> Cập nhật Mã Mức Phí'; // Change button text and icon
                cancelFeeCodeEditBtn.classList.remove('hidden');
                window.scrollTo({ top: 0, behavior: 'smooth' });
            }
        }

        function deleteFeeCode(id) {
            if (confirm('Bạn có chắc chắn muốn xóa mã mức phí này?')) {
                feeCodesData = feeCodesData.filter(c => c.id !== id);
                renderFeeCodesTable();
                populateFeeCodeDropdowns(); // Re-populate dropdowns after deleting
                showMessageBox('Mã mức phí đã được xóa.');
                if (editingFeeCodeId === id) {
                    cancelEditFeeCode();
                }
            }
        }

        function clearFeeCodeForm() {
            feeCode_code_Input.value = '';
            feeCode_desc_Input.value = '';
            feeCode_currency_Select.value = '';
            feeCode_amtfix_Input.value = '';
            feeCode_percent_Input.value = '';
            feeCode_amtmin_Input.value = '';
            feeCode_amtmax_Input.value = '';
            feeCode_minimumOption_Select.value = '0'; // NEW FIELD: Reset to default
        }

        function cancelEditFeeCode() {
            editingFeeCodeId = null;
            saveFeeCodeBtn.innerHTML = '<i class="fas fa-save"></i> Lưu Mã Mức Phí'; // Reset button text and icon
            cancelFeeCodeEditBtn.classList.add('hidden');
            clearFeeCodeForm();
        }

        // --- Tab Switching Logic ---
        function switchTab(selectedTabId) {
            tabButtons.forEach(button => {
                if (button.dataset.tab === selectedTabId) {
                    button.classList.add('active');
                } else {
                    button.classList.remove('active');
                }
            });

            tabContents.forEach(content => {
                if (content.id === selectedTabId + '-tab-content') {
                    content.classList.add('active');
                } else {
                    content.classList.remove('active');
                }
            });
            saveDataToLocalStorage(); // Save state when switching tabs
        }

        // --- Collapsible Instruction Section Logic ---
        function toggleInstructions() {
            instructionContent.classList.toggle('expanded');
            instructionHeader.classList.toggle('expanded');
            const isExpanded = instructionContent.classList.contains('expanded');
            localStorage.setItem('instructionsExpanded', isExpanded); // Save state
        }

        // --- Scroll to Top Button Logic ---
        window.addEventListener('scroll', () => {
            if (window.scrollY > 200) { // Show button after scrolling 200px
                scrollToTopBtn.style.display = 'flex';
            } else {
                scrollToTopBtn.style.display = 'none';
            }
        });

        scrollToTopBtn.addEventListener('click', () => {
            window.scrollTo({ top: 0, behavior: 'smooth' });
        });


        // Function to save all data to Local Storage
        function saveDataToLocalStorage() {
            // Save Fee Parameters form data (Section 1)
            localStorage.setItem('feePlanCode', feePlanCodeInput.value);
            localStorage.setItem('feeType', feeTypeSelect.value);
            localStorage.setItem('paymentType_declaration', paymentTypeSelect.value); // Use specific key
            localStorage.setItem('onUsTransaction_declaration', onUsTransactionSelect.value); // Use specific key
            localStorage.setItem('channelID_declaration', channelIDSelect.value); // Use specific key
            localStorage.setItem('effectiveDateFrom', effectiveDateFromInput.value);
            localStorage.setItem('effectiveDateTo', effectiveDateToInput.value);
            localStorage.setItem('levelType_declaration', levelTypeSelect.value); // Use specific key
            localStorage.setItem('levelDetail_declaration', levelDetailInput.value); // Use specific key
            localStorage.setItem('branch_declaration', branchSelect.value); // Use specific key
            localStorage.setItem('relationship_declaration', relationshipSelect.value); // Use specific key
            localStorage.setItem('customerFeeType_declaration', customerFeeTypeSelect.value); // Use specific key
            localStorage.setItem('fundingOption_declaration', fundingOptionSelect.value); // Use specific key
            localStorage.setItem('feeCodeHomeCurrency', feeCodeHomeCurrencySelect.value);
            localStorage.setItem('feeCodeForeignCurrency', feeCodeForeignCurrencySelect.value);

            // Save Fee Codes form data (Section 1.2.3)
            localStorage.setItem('feeCode_code', feeCode_code_Input.value);
            localStorage.setItem('feeCode_desc', feeCode_desc_Input.value);
            localStorage.setItem('feeCode_currency', feeCode_currency_Select.value);
            localStorage.setItem('feeCode_amtfix', feeCode_amtfix_Input.value);
            localStorage.setItem('feeCode_percent', feeCode_percent_Input.value);
            localStorage.setItem('feeCode_amtmin', feeCode_amtmin_Input.value);
            localStorage.setItem('feeCode_amtmax', feeCode_amtmax_Input.value);
            localStorage.setItem('feeCode_minimumOption', feeCode_minimumOption_Select.value); // NEW FIELD

            // Save Transfer Demo data (Section 3) - All transaction inputs
            localStorage.setItem('selectedCustomer', customerSelect.value); // MOVED
            localStorage.setItem('customerName', customerNameInput.value); // MOVED
            localStorage.setItem('transferAmount', transferAmountInput.value);
            localStorage.setItem('recipientBank', recipientBankSelect.value);
            localStorage.setItem('recipientAccount', recipientAccountInput.value);
            localStorage.setItem('transferMessage', transferMessageInput.value);
            localStorage.setItem('transfer_onUsTransaction', transfer_onUsTransactionSelect.value);
            localStorage.setItem('transfer_channelID', transfer_channelIDSelect.value);
            localStorage.setItem('transfer_levelType', transfer_levelTypeSelect.value);
            localStorage.setItem('transfer_levelDetail', transfer_levelDetailInput.value);
            localStorage.setItem('transfer_branch', transfer_branchSelect.value);
            localStorage.setItem('transfer_relationship', transfer_relationshipSelect.value);
            localStorage.setItem('transfer_customerFeeType', transfer_customerFeeTypeSelect.value);
            localStorage.setItem('transfer_fundingOption', transfer_fundingOptionSelect.value);

            localStorage.setItem('explanationTextContent', explanationContentDiv.innerHTML);
            localStorage.setItem('simplifiedExplanationTextContent', simplifiedExplanationContentDiv.innerHTML);

            // Save table data
            localStorage.setItem('feeParametersData', JSON.stringify(feeParametersData));
            localStorage.setItem('feeCodesData', JSON.stringify(feeCodesData));
        }

        // Function to load all data from Local Storage and populate inputs
        function loadDataFromLocalStorage() {
            // Load Fee Parameters form data (Section 1)
            feePlanCodeInput.value = localStorage.getItem('feePlanCode') || defaultValues.feePlanCode;
            feeTypeSelect.value = localStorage.getItem('feeType') || defaultValues.feeType;
            paymentTypeSelect.value = localStorage.getItem('paymentType_declaration') || defaultValues.paymentType_declaration;
            onUsTransactionSelect.value = localStorage.getItem('onUsTransaction_declaration') || defaultValues.onUsTransaction_declaration;
            channelIDSelect.value = localStorage.getItem('channelID_declaration') || defaultValues.channelID_declaration;
            effectiveDateFromInput.value = localStorage.getItem('effectiveDateFrom') || defaultValues.effectiveDateFrom;
            effectiveDateToInput.value = localStorage.getItem('effectiveDateTo') || defaultValues.effectiveDateTo;
            levelTypeSelect.value = localStorage.getItem('levelType_declaration') || defaultValues.levelType_declaration;
            levelDetailInput.value = localStorage.getItem('levelDetail_declaration') || defaultValues.levelDetail_declaration;
            branchSelect.value = localStorage.getItem('branch_declaration') || defaultValues.branch_declaration;
            relationshipSelect.value = localStorage.getItem('relationship_declaration') || defaultValues.relationship_declaration;
            customerFeeTypeSelect.value = localStorage.getItem('customerFeeType_declaration') || defaultValues.customerFeeType_declaration;
            fundingOptionSelect.value = localStorage.getItem('fundingOption_declaration') || defaultValues.fundingOption_declaration;

            // Load Fee Codes form data (Section 1.2.3)
            feeCode_code_Input.value = localStorage.getItem('feeCode_code') || '';
            feeCode_desc_Input.value = localStorage.getItem('feeCode_desc') || '';
            feeCode_currency_Select.value = localStorage.getItem('feeCode_currency') || '';
            feeCode_amtfix_Input.value = localStorage.getItem('feeCode_amtfix') || '';
            feeCode_percent_Input.value = localStorage.getItem('feeCode_percent') || '';
            feeCode_amtmin_Input.value = localStorage.getItem('feeCode_amtmin') || '';
            feeCode_amtmax_Input.value = localStorage.getItem('feeCode_amtmax') || '';
            feeCode_minimumOption_Select.value = localStorage.getItem('feeCode_minimumOption') || '0'; // NEW FIELD

            // Load Transfer Demo data (Section 3) - All transaction inputs
            customerSelect.value = localStorage.getItem('selectedCustomer') || ''; // MOVED
            customerNameInput.value = localStorage.getItem('customerName') || defaultValues.customerName; // MOVED
            transferAmountInput.value = localStorage.getItem('transferAmount') || new Intl.NumberFormat('en-US').format(defaultValues.transferAmount);
            recipientBankSelect.value = localStorage.getItem('recipientBank') || defaultValues.recipientBank;
            recipientAccountInput.value = localStorage.getItem('recipientAccount') || defaultValues.recipientAccount;
            transferMessageInput.value = localStorage.getItem('transferMessage') || defaultValues.transferMessage;
            transfer_onUsTransactionSelect.value = localStorage.getItem('transfer_onUsTransaction') || defaultValues.onUsTransaction_transaction;
            transfer_channelIDSelect.value = localStorage.getItem('transfer_channelID') || defaultValues.channelID_transaction;
            transfer_levelTypeSelect.value = localStorage.getItem('transfer_levelType') || defaultValues.levelType_transaction;
            transfer_levelDetailInput.value = localStorage.getItem('transfer_levelDetail') || defaultValues.levelDetail_transaction;
            transfer_branchSelect.value = localStorage.getItem('transfer_branch') || defaultValues.branch_transaction;
            transfer_relationshipSelect.value = localStorage.getItem('transfer_relationship') || defaultValues.relationship_transaction;
            transfer_customerFeeTypeSelect.value = localStorage.getItem('transfer_customerFeeType') || defaultValues.customerFeeType_transaction;
            transfer_fundingOptionSelect.value = localStorage.getItem('transfer_fundingOption') || defaultValues.fundingOption_transaction;

            explanationContentDiv.innerHTML = localStorage.getItem('explanationTextContent') || 'Nhấn "Tính Phí" để xem chi tiết.';
            simplifiedExplanationContentDiv.innerHTML = localStorage.getItem('simplifiedExplanationTextContent') || 'Nhấn "Tính Phí" sau đó nhấn "Giải thích phí dễ hiểu" để xem.';

            // Load table data
            const storedFeeParams = localStorage.getItem('feeParametersData');
            feeParametersData = storedFeeParams ? JSON.parse(storedFeeParams) : initialFeeParametersData;

            const storedFeeCodes = localStorage.getItem('feeCodesData');
            feeCodesData = storedFeeCodes ? JSON.parse(storedFeeCodes) : initialFeeCodesData;

            // Populate Fee Code dropdowns first as they are needed by fee parameters table
            populateFeeCodeDropdowns();

            // Load selected fee codes for fee parameters form
            feeCodeHomeCurrencySelect.value = localStorage.getItem('feeCodeHomeCurrency') || defaultValues.feeCodeHomeCurrency;
            feeCodeForeignCurrencySelect.value = localStorage.getItem('feeCodeForeignCurrency') || defaultValues.feeCodeForeignCurrency;

            // Populate customer dropdown and load selected customer data
            populateCustomerDropdown();
            // No need to call loadSelectedCustomerData here, as all fields are loaded directly

            // Apply formatting to number inputs that are not handled by loadSelectedCustomerData
            formatNumberInput(feeCode_amtfix_Input);
            formatNumberInput(feeCode_amtmin_Input);
            formatNumberInput(feeCode_amtmax_Input);
            formatNumberInput(transferAmountInput);


            // Update dynamic inputs
            updateLevelDetailInput(); // For fee parameters tab
            updateTransferLevelDetailInput(); // For transaction demo tab

            // Render tables
            renderFeeParametersTable();
            renderFeeCodesTable();

            // Load instruction section state
            const instructionsExpanded = localStorage.getItem('instructionsExpanded');
            if (instructionsExpanded === 'true') {
                instructionContent.classList.add('expanded');
                instructionHeader.classList.add('expanded');
            } else {
                instructionContent.classList.remove('expanded');
                instructionHeader.classList.remove('expanded');
            }

            // Immediately calculate fees if data was loaded
            calculateFee();
        }

        // Function to clear all data from Local Storage and reset inputs/display
        function clearLocalStorageAndReset() {
            localStorage.clear(); // Clear all relevant local storage items

            // Reset Fee Parameters inputs to default values (Section 1)
            feePlanCodeInput.value = defaultValues.feePlanCode;
            feeTypeSelect.value = defaultValues.feeType;
            paymentTypeSelect.value = defaultValues.paymentType_declaration;
            onUsTransactionSelect.value = defaultValues.onUsTransaction_declaration;
            channelIDSelect.value = defaultValues.channelID_declaration;
            effectiveDateFromInput.value = defaultValues.effectiveDateFrom;
            effectiveDateToInput.value = defaultValues.effectiveDateTo;
            levelTypeSelect.value = defaultValues.levelType_declaration;
            levelDetailInput.value = defaultValues.levelDetail_declaration;
            branchSelect.value = defaultValues.branch_declaration;
            relationshipSelect.value = defaultValues.relationship_declaration;
            customerFeeTypeSelect.value = defaultValues.customerFeeType_declaration;
            fundingOptionSelect.value = defaultValues.fundingOption_declaration;
            feeCodeHomeCurrencySelect.value = '';
            feeCodeForeignCurrencySelect.value = '';

            // Reset Fee Codes inputs (Section 1.2.3)
            feeCode_code_Input.value = '';
            feeCode_desc_Input.value = '';
            feeCode_currency_Select.value = '';
            feeCode_amtfix_Input.value = '';
            feeCode_percent_Input.value = '';
            feeCode_amtmin_Input.value = '';
            feeCode_amtmax_Input.value = '';
            feeCode_minimumOption_Select.value = '0'; // NEW FIELD

            // Reset Transfer Demo data (Section 3) - All transaction inputs
            customerSelect.value = ''; // MOVED
            customerNameInput.value = defaultValues.customerName; // MOVED
            transferAmountInput.value = new Intl.NumberFormat('en-US').format(defaultValues.transferAmount);
            recipientBankSelect.value = defaultValues.recipientBank;
            recipientAccountInput.value = defaultValues.recipientAccount;
            transferMessageInput.value = defaultValues.transferMessage;
            transfer_onUsTransactionSelect.value = defaultValues.onUsTransaction_transaction;
            transfer_channelIDSelect.value = defaultValues.channelID_transaction;
            transfer_levelTypeSelect.value = defaultValues.levelType_transaction;
            transfer_levelDetailInput.value = defaultValues.levelDetail_transaction;
            transfer_branchSelect.value = defaultValues.branch_transaction;
            transfer_relationshipSelect.value = defaultValues.relationship_transaction;
            transfer_customerFeeTypeSelect.value = defaultValues.customerFeeType_transaction;
            transfer_fundingOptionSelect.value = defaultValues.fundingOption_transaction;

            explanationContentDiv.innerHTML = 'Nhấn "Tính Phí" để xem chi tiết.';
            simplifiedExplanationContentDiv.innerHTML = 'Nhấn "Tính Phí" sau đó nhấn "Giải thích phí dễ hiểu" để xem.';


            // Reset table data to initial demo data
            feeParametersData = [...initialFeeParametersData];
            feeCodesData = [...initialFeeCodesData];

            // Reset display
            totalFeeDisplay.textContent = formatCurrency(0);
            amountReceivedDisplay.textContent = formatCurrency(0);

            showMessageBox('Dữ liệu đã được xóa khỏi Local Storage và các trường đã được đặt lại.');
            
            populateFeeCodeDropdowns(); // Repopulate dropdowns after reset
            populateCustomerDropdown(); // Repopulate customer dropdown after reset
            updateLevelDetailInput(); // Reset levelDetail input for fee parameters
            updateTransferLevelDetailInput(); // Reset transaction levelDetail input
            renderFeeParametersTable(); // Re-render table with default data
            renderFeeCodesTable(); // Re-render fee codes table with default data
            calculateFee(); // Recalculate with default values
            cancelEditFeeParam(); // Exit fee param edit mode
            cancelEditFeeCode(); // Exit fee code edit mode
            
            // Reset instruction section to collapsed
            instructionContent.classList.remove('expanded');
            instructionHeader.classList.remove('expanded');
            localStorage.setItem('instructionsExpanded', 'false');
        }


        // Event Listeners
        document.addEventListener('DOMContentLoaded', () => {
            loadDataFromLocalStorage();
            // Set initial active tab
            switchTab('fee-params'); // Default to fee parameters tab
        });

        tabButtons.forEach(button => {
            button.addEventListener('click', () => {
                switchTab(button.dataset.tab);
            });
        });

        calculateBtn.addEventListener('click', () => {
            saveDataToLocalStorage(); // Save current input values
            calculateFee();
        });

        clearDataBtn.addEventListener('click', clearLocalStorageAndReset);

        // New LLM feature button event listener
        simplifyExplanationBtn.addEventListener('click', async () => {
            const detailedExplanation = explanationContentDiv.innerHTML; // Get HTML content
            const simplifiedText = await getSimplifiedFeeExplanation(detailedExplanation);
            simplifiedExplanationContentDiv.innerHTML = simplifiedText; // Set HTML content
            saveDataToLocalStorage(); // Save the generated explanation
        });

        // Collapsible instruction section event listener
        instructionHeader.addEventListener('click', toggleInstructions);

        // Multi-select and Export/Import Event Listeners
        selectAllFeeParamsCheckbox.addEventListener('change', toggleAllFeeParamsCheckboxes);
        deleteSelectedFeeParamsBtn.addEventListener('click', deleteSelectedFeeParameters);
        exportFeeParamsBtn.addEventListener('click', exportFeeParametersToCsv);
        importFeeParamsBtn.addEventListener('click', () => importFeeParamsInput.click()); // Trigger hidden file input click
        importFeeParamsInput.addEventListener('change', importFeeParametersFromCsv);


        // Fee Parameter Form Event Listeners (Section 1)
        saveFeeParamBtn.addEventListener('click', addOrUpdateFeeParameter);
        cancelEditBtn.addEventListener('click', cancelEditFeeParam);
        levelTypeSelect.addEventListener('change', () => {
            updateLevelDetailInput();
            saveDataToLocalStorage();
        });

        // New Fee Code dropdowns change listeners
        feeCodeHomeCurrencySelect.addEventListener('change', saveDataToLocalStorage);
        feeCodeForeignCurrencySelect.addEventListener('change', saveDataToLocalStorage);


        // Fee Code Form Event Listeners (Section 1.2.3)
        saveFeeCodeBtn.addEventListener('click', addOrUpdateFeeCode);
        cancelFeeCodeEditBtn.addEventListener('click', cancelEditFeeCode);
        feeCode_minimumOption_Select.addEventListener('change', saveDataToLocalStorage); // NEW EVENT LISTENER

        // Input event listeners for auto-saving and formatting
        // Fee Parameters (Section 1)
        feePlanCodeInput.addEventListener('input', saveDataToLocalStorage);
        feeTypeSelect.addEventListener('change', saveDataToLocalStorage);
        paymentTypeSelect.addEventListener('change', saveDataToLocalStorage);
        onUsTransactionSelect.addEventListener('change', saveDataToLocalStorage);
        channelIDSelect.addEventListener('change', saveDataToLocalStorage);
        effectiveDateFromInput.addEventListener('change', saveDataToLocalStorage);
        effectiveDateToInput.addEventListener('change', saveDataToLocalStorage);
        levelDetailInput.addEventListener('input', saveDataToLocalStorage);
        branchSelect.addEventListener('change', saveDataToLocalStorage);
        relationshipSelect.addEventListener('change', saveDataToLocalStorage);
        customerFeeTypeSelect.addEventListener('change', saveDataToLocalStorage);
        fundingOptionSelect.addEventListener('change', saveDataToLocalStorage);
        
        // Fee Codes (Section 1.2.3)
        feeCode_code_Input.addEventListener('input', saveDataToLocalStorage);
        feeCode_desc_Input.addEventListener('input', saveDataToLocalStorage);
        feeCode_currency_Select.addEventListener('change', saveDataToLocalStorage);
        feeCode_percent_Input.addEventListener('input', saveDataToLocalStorage);

        feeCode_amtfix_Input.addEventListener('input', () => formatNumberInput(feeCode_amtfix_Input));
        feeCode_amtfix_Input.addEventListener('blur', saveDataToLocalStorage);
        feeCode_amtmin_Input.addEventListener('input', () => formatNumberInput(feeCode_amtmin_Input));
        feeCode_amtmin_Input.addEventListener('blur', saveDataToLocalStorage);
        feeCode_amtmax_Input.addEventListener('input', () => formatNumberInput(feeCode_amtmax_Input));
        feeCode_amtmax_Input.addEventListener('blur', saveDataToLocalStorage);

        // Customer Demo (Section 2) - Now part of Section 3
        customerSelect.addEventListener('change', loadSelectedCustomerData);
        customerNameInput.addEventListener('input', saveDataToLocalStorage);
        
        // Transfer Demo (Section 3) - All transaction inputs
        transferAmountInput.addEventListener('input', () => formatNumberInput(transferAmountInput));
        transferAmountInput.addEventListener('blur', saveDataToLocalStorage);
        recipientBankSelect.addEventListener('change', () => {
            saveDataToLocalStorage();
            calculateFee(); // Recalculate when recipient bank changes (and thus payment type changes)
        });
        recipientAccountInput.addEventListener('input', saveDataToLocalStorage);
        transferMessageInput.addEventListener('input', saveDataToLocalStorage);
        transfer_onUsTransactionSelect.addEventListener('change', saveDataToLocalStorage); // NEW
        transfer_channelIDSelect.addEventListener('change', saveDataToLocalStorage);
        transfer_levelTypeSelect.addEventListener('change', () => { // NEW
            updateTransferLevelDetailInput();
            saveDataToLocalStorage();
        });
        transfer_levelDetailInput.addEventListener('input', saveDataToLocalStorage); // NEW
        transfer_branchSelect.addEventListener('change', saveDataToLocalStorage); // NEW
        transfer_relationshipSelect.addEventListener('change', saveDataToLocalStorage);
        transfer_customerFeeTypeSelect.addEventListener('change', saveDataToLocalStorage); // NEW
        transfer_fundingOptionSelect.addEventListener('change', saveDataToLocalStorage);

    </script>
</body>
</html>
