<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bài Kiểm Tra Giữa Kỳ I - Tiếng Anh 11</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Be+Vietnam+Pro:wght@400;500;700&display=swap" rel="stylesheet">
    <!-- Chosen Palette: Calm Harmony (White, Gray, Soft Green for accents) -->
    <style>
        body {
            font-family: 'Be Vietnam Pro', sans-serif;
            background-color: #F8F7F4;
            color: #3C3C3B;
        }
        .container {
            max-width: 1000px;
        }
        .question-block {
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            border-radius: 0.5rem;
            background-color: white;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.06);
        }
        .topic-header {
            border-left: 6px solid #3A5A40;
            padding-left: 1rem;
        }
        .mcq-option {
            display: flex;
            align-items: center;
            padding: 0.75rem;
            margin-bottom: 0.5rem;
            border-radius: 0.5rem;
            border: 1px solid #E5E7EB;
            cursor: pointer;
            transition: background-color 0.15s;
        }
        .mcq-option:hover {
            background-color: #F3F4F6;
        }
        .mcq-option input[type="radio"] {
            margin-right: 0.75rem;
        }
        .correct-answer-option {
            background-color: #D1FAE5 !important;
            border-color: #10B981 !important;
            color: #065F46;
        }
        .incorrect-answer-option {
            background-color: #FEE2E2 !important;
            border-color: #EF4444 !important;
            color: #991B1B;
        }
        .correct-fill {
            background-color: #D1FAE5;
            border-color: #10B981;
        }
        .incorrect-fill {
            background-color: #FEE2E2;
            border-color: #EF4444;
        }
        .cloze-input {
            width: 100%;
            padding: 4px 8px;
            border: 1px solid #ccc;
            border-radius: 4px;
            box-sizing: border-box;
            font-size: 16px;
        }
        .rationale-text {
            border-top: 1px dashed #ccc;
            padding-top: 0.5rem;
            margin-top: 0.5rem;
            color: #1F2937;
        }
        .reveal-button {
            background-color: #3A5A40; 
            color: white;
            padding: 4px 8px;
            border-radius: 0.375rem;
            font-size: 0.875rem;
            cursor: pointer;
            transition: background-color 0.3s;
            margin-left: 1rem;
        }
        .reveal-button:hover {
            background-color: #4CAF50;
        }
        .reveal-button:disabled {
            background-color: #A0A0A0;
            cursor: default;
        }
        .delete-button {
            background-color: #EF4444;
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            font-weight: 500;
            transition: background-color 0.3s;
        }
        .delete-button:hover {
            background-color: #DC2626;
        }
        .history-button {
            background-color: #588157; /* Màu xanh lá đậm hơn */
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            font-weight: 500;
            transition: background-color 0.3s;
        }
        .history-button:hover {
            background-color: #4CAF50;
        }
        .new-test-button {
            background-color: #3B82F6; /* Blue for new action */
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            font-weight: 500;
            transition: background-color 0.3s;
        }
        .new-test-button:hover {
            background-color: #2563EB;
        }

        /* Modal Styles */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            display: none; /* Hidden by default */
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        .modal-content {
            background-color: #fff;
            padding: 2rem;
            border-radius: 0.75rem;
            max-width: 90%;
            width: 600px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.5);
            max-height: 80vh;
            overflow-y: auto;
        }
        .close-button {
            float: right;
            font-size: 1.5rem;
            font-weight: bold;
            cursor: pointer;
            color: #aaa;
        }
        .close-button:hover {
            color: #3C3C3B;
        }
        #timer-display {
            background-color: #FEEBC7; 
            color: #9C551F; 
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            font-weight: 700;
            font-size: 1.25rem;
        }
    </style>
</head>
<body class="antialiased">
    <div class="container mx-auto p-4 md:p-8">
        <header class="bg-white p-6 mb-6 rounded-lg shadow-xl text-center">
            <h1 class="text-3xl font-bold text-[#3A5A40] mb-2">TÀI LIỆU ÔN THI GIỮA KỲ I</h1>
            <h2 class="text-xl text-gray-700">MÔN: TIẾNG ANH 11 (NĂM HỌC 2025 - 2026)</h2>
            <div class="mt-4 flex flex-col md:flex-row justify-center space-y-4 md:space-y-0 md:space-x-8">
                <input type="text" id="student-name" placeholder="Họ và tên: ............................." class="p-2 border rounded-lg focus:ring-[#3A5A40] focus:border-[#3A5A40] md:w-1/4">
                <input type="text" id="student-class" placeholder="Lớp: ...................................." class="p-2 border rounded-lg focus:ring-[#3A5A40] focus:border-[#3A5A40] md:w-1/4">
            </div>
            <div class="flex justify-center items-center mt-4 space-x-4">
                <p id="timer-display" class="hidden">00:00</p>
                <p id="total-score" class="text-2xl font-bold text-gray-800 hidden"></p>
            </div>
            <button id="back-to-latest" type="button" class="mt-4 px-4 py-2 bg-blue-500 text-white font-medium rounded-lg shadow-md hover:bg-blue-600 hidden">
                &lt; Quay Lại Bài Mới Nhất
            </button>
        </header>

        <div class="flex flex-wrap justify-center space-x-4 mb-6">
            <button type="button" id="start-new-test" class="new-test-button">
                TẠO BÀI LÀM MỚI (Reset)
            </button>
            <button type="button" id="view-history" class="history-button">
                XEM LỊCH SỬ LÀM BÀI
            </button>
            <button type="button" id="clear-history" class="delete-button">
                XÓA TOÀN BỘ LỊCH SỬ
            </button>
        </div>

        <form id="test-form" class="hidden">
            
            <!-- CONTENT RENDERING AREA -->
            <div id="test-content">
                <p class="text-gray-600 mb-6 italic text-center">Nội dung đề thi sẽ hiện ra sau khi bạn chọn chế độ làm bài.</p>
            </div>

            <div class="mt-10 text-center">
                <button type="button" id="submit-test" class="px-10 py-4 bg-[#3A5A40] text-white font-bold text-lg rounded-xl shadow-lg hover:bg-opacity-90 transition-transform transform hover:scale-105">
                    HOÀN THÀNH BÀI LÀM VÀ CHẤM ĐIỂM
                </button>
            </div>
        </form>
    </div>

    <!-- Test Generation Modal -->
    <div id="generation-modal" class="modal" style="display: flex;">
        <div class="modal-content text-left">
            <h3 class="text-2xl font-bold text-[#3A5A40] mb-4">LỰA CHỌN CÁCH TẠO BÀI KIỂM TRA</h3>
            <p class="mb-6 text-gray-600">Vui lòng chọn một trong hai chế độ sau để bắt đầu:</p>
            
            <div id="selection-options" class="space-y-4">
                <div class="p-4 border border-gray-200 rounded-lg hover:bg-gray-50 cursor-pointer transition" 
                     onclick="window.setTestMode('FULL')">
                    <h4 class="font-bold text-lg text-gray-800 flex items-center">
                        <input type="radio" name="testMode" id="modeFull" value="FULL" class="w-5 h-5 text-blue-500 mr-3">
                        <label for="modeFull">1. ĐỀ ÔN TẬP CỐ ĐỊNH (Full Test)</label>
                    </h4>
                    <p class="text-sm text-gray-500 ml-8">Toàn bộ nội dung đề ôn tập (gồm 196 câu hỏi) theo thứ tự có sẵn.</p>
                </div>

                <div class="p-4 border border-gray-200 rounded-lg hover:bg-gray-50 cursor-pointer transition" 
                     onclick="window.setTestMode('RANDOM')">
                    <h4 class="font-bold text-lg text-gray-800 flex items-center">
                        <input type="radio" name="testMode" id="modeRandom" value="RANDOM" class="w-5 h-5 text-blue-500 mr-3">
                        <label for="modeRandom">2. ĐỀ THI NGẪU NHIÊN (Random Test)</label>
                    </h4>
                    <p class="text-sm text-gray-500 ml-8">Tạo một bộ đề ngẫu nhiên 40 câu theo cấu trúc: 6 Cloze Announce, 6 Cloze Leaflet, 5 Cloze Reading, 8 Reading Comp, 3 Sắp xếp, 6 Điền từ hộp, 6 Word Form.</p>
                </div>
            </div>
            
            <div class="mt-6">
                <label for="test-time" class="block text-sm font-medium text-gray-700 mb-2">Thời gian làm bài (Phút):</label>
                <input type="number" id="test-time" value="45" min="10" max="180" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-[#3A5A40] focus:border-[#3A5A40]">
            </div>

            <button type="button" id="start-test-button" class="w-full mt-6 px-4 py-2 bg-[#3A5A40] text-white font-bold rounded-lg shadow-md hover:bg-opacity-90 transition-transform transform hover:scale-105" disabled>
                BẮT ĐẦU BÀI LÀM
            </button>
        </div>
    </div>
    
    <!-- History Modal -->
    <div id="history-modal" class="modal">
        <div class="modal-content">
            <span id="history-modal-close" class="close-button">&times;</span>
            <h3 class="text-2xl font-bold text-[#3A5A40] mb-4">Lịch Sử Các Lần Nộp Bài</h3>
            <div id="history-list" class="space-y-3">
                <!-- History items will be loaded here -->
            </div>
        </div>
    </div>

    <script>
        // Key for storing history array (array of submitted tests)
        const TEST_HISTORY_KEY = 'tienganh11_submission_history';
        // Key for storing current progress/draft (used for autosave)
        const CURRENT_DRAFT_KEY = 'tienganh11_current_draft';

        // --- GLOBAL STATE ---
        let currentTestStructure = []; // The structure of the test currently rendered (full or random)
        let questionData = {}; // Stores the fetched data from questions_data.json
        let timerInterval;
        let timeRemaining = 0; // in seconds
        let isTestRunning = false;

        // --- DATA LOADING LOGIC ---
        async function loadQuestionData() {
            try {
                // Try loading from the new separate file
                const response = await fetch('questions_data.json');
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                questionData = await response.json();
                console.log('Question data loaded successfully.');
                return true;
            } catch (error) {
                console.error("Error loading question data. Check if 'questions_data.json' exists and is valid JSON.", error);
                alert("Lỗi: Không thể tải dữ liệu câu hỏi. Vui lòng kiểm tra file 'questions_data.json' và đảm bảo nó có định dạng JSON hợp lệ.");
                return false;
            }
        }

        // --- HELPER FUNCTION: SHUFFLE AND RANDOM PICK ---
        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        }

        function pickRandom(array, count) {
            const shuffled = shuffleArray([...array]);
            return shuffled.slice(0, count);
        }
        
        // --- TEST GENERATION LOGIC ---

        function generateRandomTestStructure() {
            const { mcqSinglePool, wordFormPool, rearrangePool, announceClozePool, leafletClozePool, readingClozePool, readingCompPool, fillInBoxPool } = questionData;
            
            const testStructure = [];
            let globalQIndex = 1;

            // --- I. MULTIPLE-CHOICE QUESTIONS (28 Qs: 6+6+3+5+8) ---
            
            // 1. Announcement (Cloze - 6 Qs) - Pick 1 passage (6 questions)
            const announcePassage = pickRandom(announceClozePool, 1)[0];
            testStructure.push({ topic: "I. MULTIPLE-CHOICE QUESTIONS (28 CÂU)", exercises: [{ 
                id: `Announce_${announcePassage.id}`, 
                title: `Thông báo/Quảng cáo (Cloze) (6 câu - Câu ${globalQIndex} - ${globalQIndex + announcePassage.questions.length - 1})`,
                type: 'cloze',
                passage: announcePassage.passage,
                questions: announcePassage.questions.map(q => ({...q, globalQIndex: globalQIndex++}))
            }]});

            // 2. Leaflet (Cloze - 6 Qs) - Pick 1 passage (6 questions)
            const leafletPassage = pickRandom(leafletClozePool, 1)[0];
            testStructure[0].exercises.push({
                id: `Leaflet_${leafletPassage.id}`,
                title: `Tờ rơi/Bài báo (Cloze) (6 câu - Câu ${globalQIndex} - ${globalQIndex + leafletPassage.questions.length - 1})`,
                type: 'cloze',
                passage: leafletPassage.passage,
                questions: leafletPassage.questions.map(q => ({...q, globalQIndex: globalQIndex++}))
            });

            // 3. Re-arrange (3 Qs) - Pick 3 random questions (3 questions)
            const rearrangeQuestions = pickRandom(rearrangePool, 3);
            testStructure[0].exercises.push({
                id: 'Rearrange_Set',
                title: `Sắp xếp câu/đoạn văn (Re-arrange) (3 câu - Câu ${globalQIndex} - ${globalQIndex + rearrangeQuestions.length - 1})`,
                type: 'rearrange',
                questions: rearrangeQuestions.map((q) => ({ 
                    ...q, 
                    q: q.id, 
                    globalQIndex: globalQIndex++ 
                }))
            });

            // 4. Reading: Gap-filling (Cloze from Reading passage - 5 Qs) - Pick 1 passage (5 questions)
            const readingClozePassage = pickRandom(readingClozePool, 1)[0];
            testStructure[0].exercises.push({
                id: `R_Cloze_${readingClozePassage.id}`,
                title: `Đọc hiểu (Gap-filling) (5 câu - Câu ${globalQIndex} - ${globalQIndex + readingClozePassage.questions.length - 1})`,
                type: 'cloze',
                passage: readingClozePassage.passage,
                questions: readingClozePassage.questions.map(q => ({...q, globalQIndex: globalQIndex++}))
            });

            // 5. Reading comprehension (8 Qs) - Pick 1 passage (8 questions)
            const readingCompPassage = pickRandom(readingCompPool, 1)[0];
            testStructure[0].exercises.push({
                id: `R_Comp_${readingCompPassage.id}`,
                title: `Đọc hiểu (Comprehension) (8 câu - Câu ${globalQIndex} - ${globalQIndex + readingCompPassage.questions.length - 1})`,
                type: 'reading',
                passage: readingCompPassage.passage,
                questions: readingCompPassage.questions.map(q => ({...q, globalQIndex: globalQIndex++}))
            });

            // --- II. OPEN-ENDED QUESTIONS (12 Qs: 6+6) ---

            // 1. Choose the words to fill in the gaps (6 Qs) - Use the single FillBox pool (6 questions)
            const fillInBox = fillInBoxPool[0];
            testStructure.push({ topic: "II. OPEN-ENDED QUESTIONS (12 CÂU)", exercises: [{
                id: fillInBox.id,
                title: `${fillInBox.title} (6 câu - Câu ${globalQIndex} - ${globalQIndex + fillInBox.questions.length - 1})`,
                type: 'fill_in_box',
                words: fillInBox.words,
                questions: fillInBox.questions.map(q => ({...q, globalQIndex: globalQIndex++}))
            }]});
            
            // 2. Give the correct forms of the given words (Word Form - 6 Qs) - Pick 6 random questions (6 questions)
            const randomWordForms = pickRandom(wordFormPool, 6);
            testStructure[1].exercises.push({
                id: 'WordForm_Set',
                title: `Điền dạng đúng của từ (Word Form) (6 câu - Câu ${globalQIndex} - ${globalQIndex + randomWordForms.length - 1})`,
                type: 'wordform',
                questions: randomWordForms.map(q => ({ 
                    ...q, 
                    globalQIndex: globalQIndex++ 
                }))
            });

            return testStructure;
        }

        // --- TIMER LOGIC ---
        function formatTime(totalSeconds) {
            const minutes = Math.floor(totalSeconds / 60);
            const seconds = totalSeconds % 60;
            return `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
        }

        function startTimer(durationMinutes) {
            clearInterval(timerInterval);
            timeRemaining = durationMinutes * 60;
            const timerDisplay = document.getElementById('timer-display');
            timerDisplay.textContent = formatTime(timeRemaining);
            timerDisplay.classList.remove('hidden');
            isTestRunning = true;
            
            timerInterval = setInterval(() => {
                timeRemaining--;
                timerDisplay.textContent = formatTime(timeRemaining);
                
                if (timeRemaining <= 0) {
                    clearInterval(timerInterval);
                    timerDisplay.textContent = "HẾT GIỜ!";
                    timerDisplay.style.backgroundColor = '#EF4444'; 
                    timerDisplay.style.color = 'white';
                    alert("Đã hết thời gian làm bài. Hệ thống sẽ tự động chấm điểm.");
                    checkTest(false);
                }
            }, 1000);
        }

        function stopTimer() {
            clearInterval(timerInterval);
            isTestRunning = false;
        }


        // --- CORE STORAGE AND HISTORY FUNCTIONS ---

        function collectAnswers() {
            const answers = {};
            const formElements = document.getElementById('test-form').elements;
            
            for (let i = 0; i < formElements.length; i++) {
                const el = formElements[i];
                if (el.name && (el.type === 'radio' && el.checked || (el.type === 'text' && el.value.trim() !== ''))) {
                    answers[el.name] = el.value;
                }
            }
            return answers;
        }

        function saveDraft() {
            if (currentTestStructure.length === 0) return; 

            const draft = {
                name: document.getElementById('student-name').value,
                class: document.getElementById('student-class').value,
                answers: collectAnswers(),
                testStructure: currentTestStructure,
                timeRemaining: timeRemaining,
                timestamp: new Date().getTime()
            };
            localStorage.setItem(CURRENT_DRAFT_KEY, JSON.stringify(draft));
        }

        function loadDraft(testMode) {
            const draftJSON = localStorage.getItem(CURRENT_DRAFT_KEY);
            const draft = draftJSON ? JSON.parse(draftJSON) : null;
            
            const fullTestContent = questionData.fullTestContent;

            // Decide whether to resume or start new
            let shouldResume = false;
            if (draft && draft.testStructure && draft.testStructure.length > 0) {
                 if (window.confirm("Phát hiện bài làm dang dở. Bạn có muốn tiếp tục không?")) {
                    shouldResume = true;
                 }
            }

            if (shouldResume) {
                // RESUME DRAFT
                currentTestStructure = draft.testStructure;
                renderTest(currentTestStructure);
                
                document.getElementById('student-name').value = draft.name || '';
                document.getElementById('student-class').value = draft.class || '';

                // Restore answers
                for (const name in draft.answers) {
                    const value = draft.answers[name];
                    const elements = document.getElementsByName(name);
                    elements.forEach(el => {
                        if (el.type === 'radio' && el.value === value) {
                            el.checked = true;
                        } else if (el.type === 'text') {
                            el.value = value;
                        }
                    });
                }
                
                // Resume timer
                const resumeTime = draft.timeRemaining > 0 ? draft.timeRemaining : (parseInt(document.getElementById('test-time').value) * 60);
                startTimer(Math.ceil(resumeTime / 60)); 
            } else {
                // START NEW TEST
                localStorage.removeItem(CURRENT_DRAFT_KEY); // Clear old draft if starting new
                 if (testMode === 'FULL') {
                    currentTestStructure = fullTestContent;
                 } else if (testMode === 'RANDOM') {
                    currentTestStructure = generateRandomTestStructure();
                 }
                 renderTest(currentTestStructure);
                 startTimer(parseInt(document.getElementById('test-time').value));
            }
        }

        function clearHistory() {
            if (window.confirm("Bạn có chắc chắn muốn xóa TOÀN BỘ lịch sử làm bài và bản nháp đã lưu?")) {
                localStorage.removeItem(TEST_HISTORY_KEY);
                localStorage.removeItem(CURRENT_DRAFT_KEY);
                alert("Đã xóa lịch sử làm bài và bản nháp thành công. Vui lòng tải lại trang.");
                window.location.reload(); 
            }
        }
        
        function startNewTest() {
            if (isTestRunning) {
                if (!window.confirm("Bài làm đang diễn ra. Bạn có muốn dừng bài làm hiện tại và bắt đầu một bài mới không?")) {
                    return;
                }
                stopTimer();
            }
            document.getElementById('generation-modal').style.display = 'flex';
            document.getElementById('test-form').classList.add('hidden');
            document.getElementById('total-score').classList.add('hidden');
            document.getElementById('timer-display').classList.add('hidden');
            document.getElementById('back-to-latest').classList.add('hidden');
            document.getElementById('submit-test').classList.remove('hidden');
            document.getElementById('submit-test').disabled = false;
        }

        window.setTestMode = function(mode) {
            document.getElementById('modeFull').checked = (mode === 'FULL');
            document.getElementById('modeRandom').checked = (mode === 'RANDOM');
            document.getElementById('start-test-button').disabled = false;
            document.getElementById('start-test-button').dataset.mode = mode;
        }

        function startTestFromModal() {
            const mode = document.getElementById('start-test-button').dataset.mode;
            if (!mode) return;
            
            document.getElementById('generation-modal').style.display = 'none';
            document.getElementById('test-form').classList.remove('hidden');
            document.getElementById('timer-display').style.backgroundColor = '#FEEBC7'; 
            document.getElementById('timer-display').style.color = '#9C551F';
            
            document.getElementById('test-form').reset();
            document.querySelectorAll('input').forEach(input => input.disabled = false);
            
            loadDraft(mode);
        }

        function viewHistory() {
            const history = JSON.parse(localStorage.getItem(TEST_HISTORY_KEY) || '[]');
            const historyList = document.getElementById('history-list');
            historyList.innerHTML = '';
            
            if (history.length === 0) {
                historyList.innerHTML = `<p class="text-gray-500 italic">Chưa có bài làm nào được nộp.</p>`;
            } else {
                history.slice().reverse().forEach((submission, index) => {
                    const originalIndex = history.length - 1 - index; 
                    const date = new Date(submission.timestamp).toLocaleString('vi-VN');
                    
                    const item = document.createElement('div');
                    item.className = 'p-3 border rounded-lg bg-gray-50 flex justify-between items-center hover:bg-gray-100 cursor-pointer transition';
                    item.innerHTML = `
                        <div>
                            <p class="font-bold text-gray-700">${submission.name} - Lớp ${submission.class}</p>
                            <p class="text-sm text-gray-500">Ngày nộp: ${date}</p>
                            <p class="text-lg font-extrabold text-[#3A5A40]">Điểm: ${submission.totalCorrect} / ${submission.totalQuestions}</p>
                        </div>
                        <button type="button" class="px-3 py-1 bg-blue-500 text-white text-sm rounded-md" onclick="window.viewSubmission('${TEST_HISTORY_KEY}', ${originalIndex})">
                            Xem Chi Tiết
                        </button>
                    `;
                    historyList.appendChild(item);
                });
            }

            document.getElementById('history-modal').style.display = 'flex';
        }

        window.viewSubmission = function(historyKey, index) {
            const history = JSON.parse(localStorage.getItem(historyKey));
            if (!history || index < 0 || index >= history.length) {
                alert("Không tìm thấy lịch sử bài nộp.");
                return;
            }

            const submission = history[index];
            document.getElementById('history-modal').style.display = 'none'; 
            stopTimer();
            
            currentTestStructure = submission.testStructure;
            renderTest(currentTestStructure);

            document.getElementById('student-name').value = submission.name || '';
            document.getElementById('student-class').value = submission.class || '';

            checkTest(true, submission);

            document.querySelectorAll('input').forEach(input => input.disabled = true);
            document.getElementById('submit-test').disabled = true;

            document.getElementById('back-to-latest').classList.remove('hidden');
            document.getElementById('submit-test').classList.add('hidden');
            document.getElementById('timer-display').classList.add('hidden');
            
            document.getElementById('total-score').textContent = `Điểm [LỊCH SỬ]: ${submission.totalCorrect} / ${submission.totalQuestions}`;
            document.getElementById('total-score').classList.remove('hidden');
            
            window.scrollTo(0, 0);
        }

        function resetView() {
            window.location.reload(); 
        }

        function checkTest(isLoading = false, submissionData = null) {
            stopTimer();
            
            let totalCorrect = 0;
            let totalQuestions = 0;
            let currentAnswers = submissionData ? submissionData.answers : collectAnswers();

            currentTestStructure.forEach(topicBlock => {
                topicBlock.exercises.forEach(exercise => {
                    const questionsInExercise = exercise.questions || [];
                    questionsInExercise.forEach(q => {
                        // Use a consistent ID format, using q.id for rearrange, q.q for others
                        const questionId = (exercise.type === 'rearrange') ? q.id : q.q;
                        const qContainer = document.querySelector(`[data-q-id="${exercise.id}_q${questionId}"]`);
                        if (!qContainer) return;
                        
                        const rationaleTextElement = qContainer.querySelector('.rationale-text');
                        const revealButton = qContainer.querySelector('.reveal-button');
                        const correctIndicator = qContainer.querySelector('.correct-indicator');

                        if (isLoading) {
                            const rationale = q.rationale || "Không có giải thích chi tiết.";
                            rationaleTextElement.innerHTML = `Giải thích: ${rationale}`;
                            rationaleTextElement.classList.remove('hidden');
                            if (revealButton) revealButton.textContent = 'Ẩn Giải thích';
                        }
                        if (revealButton) revealButton.disabled = true;
                        
                        totalQuestions++;
                        let isCorrect = false;

                        const inputName = `${exercise.id}_q${questionId}`;
                        const userAnswer = currentAnswers[inputName];
                        const correctAnswer = q.answer;

                        if (exercise.type === 'mcq' || exercise.type === 'cloze' || exercise.type === 'reading' || exercise.type === 'rearrange') {
                            qContainer.querySelectorAll('.mcq-option').forEach(label => {
                                label.classList.remove('correct-answer-option', 'incorrect-answer-option');
                                if (label.dataset.optionId === correctAnswer) {
                                    label.classList.add('correct-answer-option');
                                }
                            });

                            if (userAnswer === correctAnswer) {
                                isCorrect = true;
                            } else if (userAnswer) {
                                const incorrectOption = qContainer.querySelector(`[data-option-id="${userAnswer}"]`);
                                if (incorrectOption) {
                                    incorrectOption.classList.add('incorrect-answer-option');
                                }
                            }
                        } else if (exercise.type === 'wordform' || exercise.type === 'fill_in_box') {
                            const inputField = qContainer.querySelector('input[type="text"]');
                            if (inputField) {
                                const userText = (userAnswer || '').trim().toLowerCase();
                                if (userText === correctAnswer.toLowerCase()) {
                                    isCorrect = true;
                                    inputField.classList.add('correct-fill');
                                } else if (userText) {
                                    inputField.classList.add('incorrect-fill');
                                }
                                if (isLoading) inputField.value = userAnswer || ''; 
                            }
                        }

                        if (isCorrect) {
                            totalCorrect++;
                            correctIndicator.textContent = "CHÍNH XÁC";
                            correctIndicator.className = 'correct-indicator mt-2 block font-bold text-green-600';
                        } else {
                            correctIndicator.textContent = `${userAnswer ? 'SAI' : 'CHƯA LÀM'}. Đáp án đúng: ${correctAnswer}`;
                            correctIndicator.className = 'correct-indicator mt-2 block font-bold text-red-600';
                        }
                        correctIndicator.classList.remove('hidden');
                        qContainer.querySelectorAll('input').forEach(input => input.disabled = true);
                    });
                });
            });

            const scoreElement = document.getElementById('total-score');
            scoreElement.textContent = `Điểm: ${totalCorrect} / ${totalQuestions}`;
            scoreElement.classList.remove('hidden');
            
            if (!isLoading) {
                localStorage.removeItem(CURRENT_DRAFT_KEY);
                const newSubmission = {
                    timestamp: new Date().getTime(),
                    name: document.getElementById('student-name').value || 'Ẩn danh',
                    class: document.getElementById('student-class').value || 'Không rõ',
                    totalCorrect,
                    totalQuestions,
                    answers: currentAnswers,
                    testStructure: currentTestStructure
                };
                
                const history = JSON.parse(localStorage.getItem(TEST_HISTORY_KEY) || '[]');
                history.push(newSubmission);
                localStorage.setItem(TEST_HISTORY_KEY, JSON.stringify(history));

                document.getElementById('submit-test').disabled = true;
                alert(`Bạn đã hoàn thành. Số câu đúng: ${totalCorrect} / ${totalQuestions}. Kết quả đã được lưu.`);
            }
        }

        // --- RENDER FUNCTIONS ---

        function renderMCQ(q, exId, answer, rationale) {
            const optionsHtml = q.options.map((option, idx) => `
                <label class="mcq-option" data-option-id="${String.fromCharCode(65 + idx)}">
                    <input type="radio" name="${exId}_q${q.q}" value="${String.fromCharCode(65 + idx)}" class="w-5 h-5 text-[#3A5A40] focus:ring-[#3A5A40]">
                    <span class="font-medium">${String.fromCharCode(65 + idx)}. ${option}</span>
                </label>
            `).join('');
            const rationaleSafe = (rationale || "").replace(/"/g, '&quot;');
            return `
                <div class="mb-6 p-4 border-l-4 border-gray-200" data-q-id="${exId}_q${q.q}">
                    <div class="flex justify-between items-start mb-3">
                        <p class="font-medium">Câu ${q.globalQIndex || q.q}: ${q.text}</p>
                        <button type="button" class="reveal-button flex-shrink-0" 
                                data-answer="${answer}"
                                data-rationale="${rationaleSafe}"
                                >Xem Đáp án</button>
                    </div>
                    <div class="space-y-2">${optionsHtml}</div>
                    <span class="correct-indicator mt-2 block font-bold hidden"></span>
                    <p class="rationale-text mt-2 italic text-sm text-gray-600 hidden"></p>
                </div>
            `;
        }

        function renderWordForm(q, exId, answer, rationale) {
            const textWithInput = q.text.replace('_________________________', `<input type="text" name="${exId}_q${q.q}" class="cloze-input w-2/5 p-1 border-b-2 border-gray-400 focus:border-[#3A5A40] focus:outline-none" placeholder="Nhập đáp án">`);
            const rationaleSafe = (rationale || "").replace(/"/g, '&quot;');
            return `
                <div class="mb-6 p-4 border-l-4 border-gray-200" data-q-id="${exId}_q${q.q}">
                    <div class="flex justify-between items-start mb-2">
                        <p class="font-medium">Câu ${q.globalQIndex || q.q}: ${textWithInput}</p>
                        <button type="button" class="reveal-button flex-shrink-0" 
                                data-answer="${answer}"
                                data-rationale="${rationaleSafe}"
                                >Xem Đáp án</button>
                    </div>
                    <span class="correct-indicator mt-2 block font-bold hidden"></span>
                    <p class="rationale-text mt-2 italic text-sm text-gray-600 hidden"></p>
                </div>
            `;
        }
        
        function renderFillInBox(exercise) {
            let html = `<div class="bg-gray-100 p-4 mb-6 rounded-lg border border-gray-200">
                                <h4 class="font-bold mb-3 text-red-700">TỪ GỢI Ý:</h4>
                                <p class="text-base font-mono">${exercise.words.join(' | ')}</p>
                             </div>`;
            exercise.questions.forEach(q => {
                const rationaleSafe = (q.rationale || "").replace(/"/g, '&quot;');
                html += `
                    <div class="mb-6 p-4 border-l-4 border-gray-200" data-q-id="${exercise.id}_q${q.q}">
                        <div class="flex justify-between items-start mb-2">
                            <p class="font-medium">Câu ${q.globalQIndex || q.q}: ${q.text.replace('_______', `<input type="text" name="${exercise.id}_q${q.q}" class="cloze-input w-2/5 p-1 border-b-2 border-gray-400 focus:border-[#3A5A40] focus:outline-none" placeholder="Nhập đáp án">`)}</p>
                            <button type="button" class="reveal-button flex-shrink-0" 
                                    data-answer="${q.answer}"
                                    data-rationale="${rationaleSafe}"
                                    >Xem Đáp án</button>
                        </div>
                        <span class="correct-indicator mt-2 block font-bold hidden"></span>
                        <p class="rationale-text mt-2 italic text-sm text-gray-600 hidden"></p>
                    </div>
                `;
            });
            return html;
        }

        function renderPassageQuestions(exercise) {
            let html = `<div class="bg-gray-50 p-4 mb-6 rounded-lg border border-gray-200">
                                <h4 class="font-bold mb-3">${exercise.title.split('(')[0]}</h4>
                                <p class="whitespace-pre-wrap">${exercise.passage.replace(/\n/g, '<br>')}</p>
                             </div>`;
            exercise.questions.forEach(q => {
                if (!q || !Array.isArray(q.options)) return;
                html += renderMCQ(q, exercise.id, q.answer, q.rationale);
            });
            return html;
        }
        
        function renderRearrange(q, exId, answer, rationale) {
            const paragraphs = q.text.split('\n').map(line => `<p class="ml-4 text-gray-700">${line}</p>`).join('');
            const optionsHtml = q.options.map((option, idx) => `
                <label class="mcq-option" data-option-id="${String.fromCharCode(65 + idx)}">
                    <input type="radio" name="${exId}_q${q.q}" value="${String.fromCharCode(65 + idx)}" class="w-5 h-5 text-[#3A5A40] focus:ring-[#3A5A40]">
                    <span class="font-medium">${String.fromCharCode(65 + idx)}. ${option}</span>
                </label>
            `).join('');
            const rationaleSafe = (rationale || "").replace(/"/g, '&quot;');
            return `
                <div class="mb-6 p-4 border-l-4 border-gray-200" data-q-id="${exId}_q${q.q}">
                    <div class="flex justify-between items-start mb-3">
                        <p class="font-medium text-lg">Câu ${q.globalQIndex || q.q}: ${q.title || 'Sắp xếp câu/đoạn'}</p>
                        <button type="button" class="reveal-button flex-shrink-0" 
                                data-answer="${answer}"
                                data-rationale="${rationaleSafe}"
                                >Xem Đáp án</button>
                    </div>
                    <div class="bg-gray-50 p-4 mb-4 rounded-lg border border-gray-200">${paragraphs}</div>
                    <p class="font-medium mb-3">Chọn thứ tự sắp xếp đúng:</p>
                    <div class="space-y-2">${optionsHtml}</div>
                    <span class="correct-indicator mt-2 block font-bold hidden"></span>
                    <p class="rationale-text mt-2 italic text-sm text-gray-600 hidden"></p>
                </div>
            `;
        }

        // --- MAIN RENDER FUNCTION ---
        function renderTest(testStructure) {
            const container = document.getElementById('test-content');
            container.innerHTML = '';
            let globalQIndex = 1;

            testStructure.forEach(topicBlock => {
                const topicDiv = document.createElement('div');
                topicDiv.className = 'my-8';
                topicDiv.innerHTML = `<h2 class="text-2xl font-bold topic-header mb-6">${topicBlock.topic}</h2>`;
                
                topicBlock.exercises.forEach(exercise => {
                    const exDiv = document.createElement('div');
                    exDiv.id = exercise.id;
                    exDiv.className = 'question-block';
                    exDiv.innerHTML = `<h3 class="text-xl font-semibold mb-4 text-[#3A5A40]">${exercise.title}</h3>`;
                    
                    let htmlBuffer = '';
                    
                    // A robust check to see if the structure is resolved (like in random mode) 
                    // or needs to be resolved (like in full mode).
                    // Full mode structure has a 'pool' property in its question references.
                    const isFullMode = exercise.questions && exercise.questions.length > 0 && typeof exercise.questions[0].pool !== 'undefined';

                    if (!isFullMode) {
                        // --- LOGIC FOR RANDOM / PRE-RESOLVED STRUCTURE ---
                        if (exercise.type === 'wordform') {
                            exercise.questions.forEach(qData => {
                                htmlBuffer += renderWordForm(qData, exercise.id, qData.answer, qData.rationale);
                            });
                        } else if (exercise.type === 'rearrange') {
                            exercise.questions.forEach(qData => {
                                qData.q = qData.id; // Ensure q property is set from id for consistency
                                htmlBuffer += renderRearrange(qData, exercise.id, qData.answer, qData.rationale);
                            });
                        } else if (exercise.type === 'fill_in_box') {
                            htmlBuffer += renderFillInBox(exercise);
                        } else if (exercise.type === 'cloze' || exercise.type === 'reading') {
                            htmlBuffer += renderPassageQuestions(exercise);
                        }
                    } else {
                        // --- LOGIC FOR FULL / REFERENCE STRUCTURE ---
                        if (exercise.type === 'mcq') {
                            exercise.questions.forEach(qRef => {
                                const pool = questionData[qRef.pool];
                                const qData = pool.find(q => q.q === qRef.q);
                                if (qData) {
                                    qData.globalQIndex = globalQIndex++;
                                    htmlBuffer += renderMCQ(qData, exercise.id, qData.answer, qData.rationale);
                                }
                            });
                        } else if (exercise.type === 'wordform') {
                            exercise.questions.forEach(qRef => {
                                const pool = questionData[qRef.pool];
                                const qData = pool.find(q => q.q === qRef.q);
                                if (qData) {
                                    qData.globalQIndex = globalQIndex++;
                                    htmlBuffer += renderWordForm(qData, exercise.id, qData.answer, qData.rationale);
                                }
                            });
                        } else if (exercise.type === 'rearrange') {
                            exercise.questions.forEach(qRef => {
                                const pool = questionData[qRef.pool];
                                const qData = pool.find(q => q.id === qRef.q);
                                if (qData) {
                                    qData.globalQIndex = globalQIndex++;
                                    qData.q = qRef.q; // Use ID for tracking
                                    htmlBuffer += renderRearrange(qData, exercise.id, qData.answer, qData.rationale);
                                }
                            });
                        } else if (exercise.type === 'fill_in_box') {
                            const fillInBoxContent = questionData.fillInBoxPool[0];
                            if (fillInBoxContent) {
                                const resolvedExercise = { ...fillInBoxContent, questions: fillInBoxContent.questions.map(q => ({...q, globalQIndex: globalQIndex++}))};
                                htmlBuffer += renderFillInBox(resolvedExercise);
                            }
                        } else if ((exercise.type === 'cloze' || exercise.type === 'reading') && exercise.passageId) {
                            const poolName = exercise.questions[0].pool;
                            const pool = questionData[poolName];
                            const passageObj = pool.find(p => p.id === exercise.passageId);
                            if (passageObj) {
                                const resolvedExercise = {
                                    ...exercise,
                                    passage: passageObj.passage,
                                    questions: exercise.questions.map(qRef => {
                                        const originalQ = passageObj.questions.find(pq => pq.q === qRef.q);
                                        return originalQ ? { ...originalQ, globalQIndex: globalQIndex++ } : null;
                                    }).filter(Boolean)
                                };
                                 htmlBuffer += renderPassageQuestions(resolvedExercise);
                            }
                        }
                    }
                    
                    exDiv.innerHTML += htmlBuffer;
                    topicDiv.appendChild(exDiv);
                });
                container.appendChild(topicDiv);
            });
            attachRevealListeners();
        }


        // --- ATTACH LISTENERS ---

        function attachRevealListeners() {
            document.querySelectorAll('.reveal-button').forEach(button => {
                button.addEventListener('click', (e) => {
                    const { answer, rationale } = e.target.dataset;
                    const qContainer = e.target.closest('[data-q-id]');
                    revealAnswer(qContainer, answer, rationale);
                });
            });
        }
        
        function revealAnswer(qContainer, correctAnswer, rationale) {
            if (!qContainer) return;
            const rationaleEl = qContainer.querySelector('.rationale-text');
            const button = qContainer.querySelector('.reveal-button');
            const indicatorEl = qContainer.querySelector('.correct-indicator');

            if (rationaleEl.classList.contains('hidden')) {
                // REVEAL
                rationaleEl.innerHTML = `Giải thích: ${rationale}`;
                rationaleEl.classList.remove('hidden');
                indicatorEl.textContent = `Đáp án đúng: ${correctAnswer}`;
                indicatorEl.className = 'correct-indicator mt-2 block font-bold text-blue-600';
                indicatorEl.classList.remove('hidden');

                if (qContainer.querySelector('input[type="radio"]')) {
                    qContainer.querySelectorAll('.mcq-option').forEach(label => {
                        if (label.dataset.optionId === correctAnswer) {
                            label.classList.add('correct-answer-option');
                        }
                    });
                } else if (qContainer.querySelector('input[type="text"]')) {
                    const inputField = qContainer.querySelector('input[type="text"]');
                    inputField.value = correctAnswer;
                    inputField.classList.add('correct-fill');
                }
                button.textContent = 'Ẩn Giải thích';
            } else {
                // HIDE
                rationaleEl.classList.add('hidden');
                indicatorEl.classList.add('hidden');
                button.textContent = 'Xem Đáp án';
                qContainer.querySelectorAll('.mcq-option, .cloze-input').forEach(el => {
                    el.classList.remove('correct-answer-option', 'correct-fill');
                });
            }
        }

        // --- INITIALIZATION ---
        document.addEventListener('DOMContentLoaded', async () => {
            const dataLoaded = await loadQuestionData();
            if (!dataLoaded) {
                 document.getElementById('generation-modal').innerHTML = '<div class="modal-content text-center"><h3 class="text-2xl font-bold text-red-600 mb-4">Lỗi tải dữ liệu</h3><p>Không thể tải dữ liệu câu hỏi từ file questions_data.json. Vui lòng kiểm tra lại file.</p></div>';
                 return;
            }
            initializeApplication();
        });

        function initializeApplication() {
            document.getElementById('start-test-button').addEventListener('click', startTestFromModal);
            document.getElementById('test-form').addEventListener('input', saveDraft);
            ['student-name', 'student-class'].forEach(id => document.getElementById(id).addEventListener('input', saveDraft));
            document.getElementById('submit-test').addEventListener('click', () => checkTest(false));
            document.getElementById('clear-history').addEventListener('click', clearHistory);
            document.getElementById('view-history').addEventListener('click', viewHistory);
            document.getElementById('start-new-test').addEventListener('click', startNewTest); 
            
            const historyModal = document.getElementById('history-modal');
            document.getElementById('history-modal-close').addEventListener('click', () => historyModal.style.display = 'none');
            window.addEventListener('click', (event) => {
                if (event.target == historyModal) historyModal.style.display = 'none';
            });

            document.getElementById('back-to-latest').addEventListener('click', resetView);
        }
    </script>
</body>
</html>

