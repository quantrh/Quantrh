<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bài Kiểm Tra Giữa Kỳ I - Tiếng Anh 11</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Be+Vietnam+Pro:wght@400;500;700&display=swap" rel="stylesheet">
    <!-- Chosen Palette: Calm Harmony (White, Gray, Soft Green for accents) -->
    <style>
        body {
            font-family: 'Be Vietnam Pro', sans-serif;
            background-color: #F8F7F4;
            color: #3C3C3B;
        }
        .container {
            max-width: 1000px;
        }
        .question-block {
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            border-radius: 0.5rem;
            background-color: white;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.06);
        }
        .topic-header {
            border-left: 6px solid #3A5A40;
            padding-left: 1rem;
        }
        .mcq-option {
            display: flex;
            align-items: center;
            padding: 0.75rem;
            margin-bottom: 0.5rem;
            border-radius: 0.5rem;
            border: 1px solid #E5E7EB;
            cursor: pointer;
            transition: background-color 0.15s;
        }
        .mcq-option:hover {
            background-color: #F3F4F6;
        }
        .mcq-option input[type="radio"] {
            margin-right: 0.75rem;
        }
        .correct-answer-option {
            background-color: #D1FAE5 !important;
            border-color: #10B981 !important;
            color: #065F46;
        }
        .incorrect-answer-option {
            background-color: #FEE2E2 !important;
            border-color: #EF4444 !important;
            color: #991B1B;
        }
        .correct-fill {
            background-color: #D1FAE5;
            border-color: #10B981;
        }
        .incorrect-fill {
            background-color: #FEE2E2;
            border-color: #EF4444;
        }
        .cloze-input {
            width: 100%;
            padding: 4px 8px;
            border: 1px solid #ccc;
            border-radius: 4px;
            box-sizing: border-box;
            font-size: 16px;
        }
        .rationale-text {
            border-top: 1px dashed #ccc;
            padding-top: 0.5rem;
            margin-top: 0.5rem;
            color: #1F2937;
        }
        .reveal-button {
            background-color: #3A5A40; 
            color: white;
            padding: 4px 8px;
            border-radius: 0.375rem;
            font-size: 0.875rem;
            cursor: pointer;
            transition: background-color 0.3s;
            margin-left: 1rem;
        }
        .reveal-button:hover {
            background-color: #4CAF50;
        }
        .reveal-button:disabled {
            background-color: #A0A0A0;
            cursor: default;
        }
        .delete-button {
            background-color: #EF4444;
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            font-weight: 500;
            transition: background-color 0.3s;
        }
        .delete-button:hover {
            background-color: #DC2626;
        }
        .history-button {
            background-color: #588157; /* Màu xanh lá đậm hơn */
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            font-weight: 500;
            transition: background-color 0.3s;
        }
        .history-button:hover {
            background-color: #4CAF50;
        }
        .new-test-button {
            background-color: #3B82F6; /* Blue for new action */
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            font-weight: 500;
            transition: background-color 0.3s;
        }
        .new-test-button:hover {
            background-color: #2563EB;
        }

        /* Modal Styles */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            display: none; /* Hidden by default */
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        .modal-content {
            background-color: #fff;
            padding: 2rem;
            border-radius: 0.75rem;
            max-width: 90%;
            width: 600px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.5);
            max-height: 80vh;
            overflow-y: auto;
        }
        .close-button {
            float: right;
            font-size: 1.5rem;
            font-weight: bold;
            cursor: pointer;
            color: #aaa;
        }
        .close-button:hover {
            color: #3C3C3B;
        }
        #timer-display {
            background-color: #FEEBC7; 
            color: #9C551F; 
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            font-weight: 700;
            font-size: 1.25rem;
        }
    </style>
</head>
<body class="antialiased">
    <div class="container mx-auto p-4 md:p-8">
        <header class="bg-white p-6 mb-6 rounded-lg shadow-xl text-center">
            <h1 class="text-3xl font-bold text-[#3A5A40] mb-2">TÀI LIỆU ÔN THI GIỮA KỲ I</h1>
            <h2 class="text-xl text-gray-700">MÔN: TIẾNG ANH 11 (NĂM HỌC 2025 - 2026)</h2>
            <div class="mt-4 flex flex-col md:flex-row justify-center space-y-4 md:space-y-0 md:space-x-8">
                <input type="text" id="student-name" placeholder="Họ và tên: ............................." class="p-2 border rounded-lg focus:ring-[#3A5A40] focus:border-[#3A5A40] md:w-1/4">
                <input type="text" id="student-class" placeholder="Lớp: ...................................." class="p-2 border rounded-lg focus:ring-[#3A5A40] focus:border-[#3A5A40] md:w-1/4">
            </div>
            <div class="flex justify-center items-center mt-4 space-x-4">
                <p id="timer-display" class="hidden">00:00</p>
                <p id="total-score" class="text-2xl font-bold text-gray-800 hidden"></p>
            </div>
            <button id="back-to-latest" type="button" class="mt-4 px-4 py-2 bg-blue-500 text-white font-medium rounded-lg shadow-md hover:bg-blue-600 hidden">
                < Quay Lại Bài Mới Nhất
            </button>
        </header>

        <div class="flex flex-wrap justify-center space-x-4 mb-6">
            <button type="button" id="start-new-test" class="new-test-button">
                TẠO BÀI LÀM MỚI (Reset)
            </button>
            <button type="button" id="view-history" class="history-button">
                XEM LỊCH SỬ LÀM BÀI
            </button>
            <button type="button" id="clear-history" class="delete-button">
                XÓA TOÀN BỘ LỊCH SỬ
            </button>
        </div>

        <form id="test-form" class="hidden">
            
            <!-- CONTENT RENDERING AREA -->
            <div id="test-content">
                <p class="text-gray-600 mb-6 italic text-center">Nội dung đề thi sẽ hiện ra sau khi bạn chọn chế độ làm bài.</p>
            </div>

            <div class="mt-10 text-center">
                <button type="button" id="submit-test" class="px-10 py-4 bg-[#3A5A40] text-white font-bold text-lg rounded-xl shadow-lg hover:bg-opacity-90 transition-transform transform hover:scale-105">
                    HOÀN THÀNH BÀI LÀM VÀ CHẤM ĐIỂM
                </button>
            </div>
        </form>
    </div>

    <!-- Test Generation Modal -->
    <div id="generation-modal" class="modal" style="display: flex;">
        <div class="modal-content text-left">
            <h3 class="text-2xl font-bold text-[#3A5A40] mb-4">LỰA CHỌN CÁCH TẠO BÀI KIỂM TRA</h3>
            <p class="mb-6 text-gray-600">Vui lòng chọn một trong hai chế độ sau để bắt đầu:</p>
            
            <div id="selection-options" class="space-y-4">
                <div class="p-4 border border-gray-200 rounded-lg hover:bg-gray-50 cursor-pointer transition" 
                     onclick="window.setTestMode('FULL')">
                    <h4 class="font-bold text-lg text-gray-800 flex items-center">
                        <input type="radio" name="testMode" id="modeFull" value="FULL" class="w-5 h-5 text-blue-500 mr-3">
                        <label for="modeFull">1. ĐỀ ÔN TẬP CỐ ĐỊNH (Full Test)</label>
                    </h4>
                    <p class="text-sm text-gray-500 ml-8">Toàn bộ nội dung đề ôn tập (gồm 196 câu hỏi) theo thứ tự có sẵn.</p>
                </div>

                <div class="p-4 border border-gray-200 rounded-lg hover:bg-gray-50 cursor-pointer transition" 
                     onclick="window.setTestMode('RANDOM')">
                    <h4 class="font-bold text-lg text-gray-800 flex items-center">
                        <input type="radio" name="testMode" id="modeRandom" value="RANDOM" class="w-5 h-5 text-blue-500 mr-3">
                        <label for="modeRandom">2. ĐỀ THI NGẪU NHIÊN (Random Test)</label>
                    </h4>
                    <p class="text-sm text-gray-500 ml-8">Tạo một bộ đề ngẫu nhiên 40 câu theo cấu trúc: 6 Cloze Announce, 6 Cloze Leaflet, 5 Cloze Reading, 8 Reading Comp, 3 Sắp xếp, 6 Điền từ hộp, 6 Word Form.</p>
                </div>
            </div>
            
            <div class="mt-6">
                <label for="test-time" class="block text-sm font-medium text-gray-700 mb-2">Thời gian làm bài (Phút):</label>
                <input type="number" id="test-time" value="45" min="10" max="180" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-[#3A5A40] focus:border-[#3A5A40]">
            </div>

            <button type="button" id="start-test-button" class="w-full mt-6 px-4 py-2 bg-[#3A5A40] text-white font-bold rounded-lg shadow-md hover:bg-opacity-90 transition-transform transform hover:scale-105" disabled>
                BẮT ĐẦU BÀI LÀM
            </button>
        </div>
    </div>
    
    <!-- History Modal -->
    <div id="history-modal" class="modal">
        <div class="modal-content">
            <span id="history-modal-close" class="close-button">&times;</span>
            <h3 class="text-2xl font-bold text-[#3A5A40] mb-4">Lịch Sử Các Lần Nộp Bài</h3>
            <div id="history-list" class="space-y-3">
                <!-- History items will be loaded here -->
            </div>
        </div>
    </div>

    <script>
        // Key for storing history array (array of submitted tests)
        const TEST_HISTORY_KEY = 'tienganh11_submission_history';
        // Key for storing current progress/draft (used for autosave)
        const CURRENT_DRAFT_KEY = 'tienganh11_current_draft';

        // --- GLOBAL STATE ---
        let currentTestStructure = []; // The structure of the test currently rendered (full or random)
        let timerInterval;
        let timeRemaining = 0; // in seconds
        let isTestRunning = false;

        // --- HELPER FUNCTION: SHUFFLE AND RANDOM PICK ---
        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        }

        function pickRandom(array, count) {
            const shuffled = shuffleArray([...array]);
            return shuffled.slice(0, count);
        }

        // --- FULL QUESTION POOL DEFINITION (196 QUESTIONS) ---

        // 1. Multiple Choice Questions (MCQ) - Single Sentence (23 + 36 = 59 questions)
        const mcqSinglePool = [
            // T1_Ex1 (23 Questions)
            { q: 1, text: "The university graduates one of the highest percentages of registered dieticians and __________ in the world.", options: ["nutrition", "nutritious", "nutrients", "nutritionists"], answer: "D", rationale: "Vị trí cần một danh từ chỉ người (chuyên gia) song hành với <b>'registered dieticians'</b>. Do đó, 'nutritionists' (chuyên gia dinh dưỡng) là đáp án phù hợp nhất." },
            { q: 2, text: "A _____ makes the body more efficient and enhances the body's ability to respond to stress.", options: ["fitness", "morning exercise", "training", "workout"], answer: "D", rationale: "'Workout' (buổi tập luyện) là một danh từ chỉ một hoạt động thể chất cụ thể có tác dụng làm cơ thể hiệu quả hơn." },
            { q: 3, text: "Tobacco not only affects you and the people around you, but can _______ to serious health conditions including lung and heart disease.", options: ["go", "influence", "lead", "point"], answer: "C", rationale: "Cụm động từ cố định (collocation) là <b>'lead to'</b>, có nghĩa là 'dẫn đến' một kết quả nào đó." },
            { q: 4, text: "Doctors said that if he practiced ___________ every day, he could keep his mind stress-free.", options: ["immune system", "meditation", "acupuncture", "a diet"], answer: "B", rationale: "Xét về ngữ nghĩa, hoạt động giúp giữ cho tâm trí không bị căng thẳng (stress-free) là <b>'meditation'</b> (thiền định)." },
            { q: 5, text: "Sleep, rest and relaxation can slow down the ________.", options: ["ageing process", "life expectancy", "cholesterol", "health"], answer: "A", rationale: "Về mặt logic và kiến thức chung, giấc ngủ, nghỉ ngơi và thư giãn có thể làm chậm <b>'ageing process'</b> (quá trình lão hóa)." },
            { q: 6, text: "If you catch a cold, you should try natural _______ before taking any medicine", options: ["medicines", "remedies", "foods", "ways"], answer: "B", rationale: "Trong ngữ cảnh chữa bệnh cảm lạnh một cách tự nhiên, <b>'remedies'</b> (phương thuốc/cách chữa trị) là từ phù hợp nhất. Cụm 'natural remedies' là một collocation phổ biến." },
            { q: 7, text: "Fast food __________ can increase the risk of obesity and heart disease.", options: ["consumptions", "consuming", "consume", "consumption"], answer: "D", rationale: "Vị trí chủ ngữ của câu cần một danh từ. <b>'Consumption'</b> (sự tiêu thụ) là một danh từ không đếm được, phù hợp để chỉ một khái niệm chung." },
            { q: 8, text: "Staying __________ is half of the secret to weight control, the other half is a healthy diet.", options: ["active", "actively", "inactive", "inactively"], answer: "A", rationale: "Sau động từ liên kết (linking verb) <b>'stay'</b>, chúng ta cần một tính từ để mô tả trạng thái. <b>'Active'</b> (năng động) là tính từ phù hợp về cả ngữ pháp và ngữ nghĩa." },
            { q: 9, text: "Martine hasn’t quite _________ his illness yet.", options: ["recovered", "got over", "looked after", "suffered"], answer: "B", rationale: "Cụm động từ (phrasal verb) <b>'get over'</b> có nghĩa là 'bình phục, vượt qua' một căn bệnh, phù hợp nhất với ngữ cảnh." },
            { q: 10, text: "After spending a week in bed, she made a complete __________.", options: ["recover", "recovering", "recovery", "recovered"], answer: "C", rationale: "Sau mạo từ 'a' và tính từ 'complete', ta cần một danh từ. <b>'Recovery'</b> (sự hồi phục) là danh từ tương ứng." },
            { q: 11, text: "If you __________ the doctor’s advice, you won’t get well.", options: ["take", "follow", "ignore", "don’t listen"], answer: "C", rationale: "Chỉ khi bạn <b>'ignore'</b> (phớt lờ) lời khuyên của bác sĩ thì kết quả mới là 'bạn sẽ không khỏe lại'." },
            { q: 12, text: "Daily exercise and weight control strongly influence your chances of staying ______.", options: ["health", "healthy", "healthily", "active"], answer: "B", rationale: "Sau động từ liên kết <b>'stay'</b>, chúng ta cần một tính từ. <b>'Healthy'</b> (khỏe mạnh) là tính từ phù hợp nhất." },
            { q: 13, text: "If you’re tired, even if you feel that you need to get more done, give yourself ______ to sleep.", options: ["request", "requirement", "permission", "permit"], answer: "C", rationale: "Cụm từ cố định (collocation) là <b>'give yourself permission'</b> (cho phép bản thân làm gì đó)." },
            { q: 14, text: "Good ______, controlling calorie intake and physical activity are the only way to maintain a healthy weight.", options: ["nutrient", "nutrition", "malnutrition", "nutritionists"], answer: "B", rationale: "Vị trí này cần một danh từ chung, không đếm được để chỉ khái niệm 'sự dinh dưỡng' tốt, song hành với 'controlling calorie intake'." },
            { q: 15, text: "Chocolate and cakes cause our blood sugar to rise and give us a quick ______.", options: ["boost", "power", "action", "success"], answer: "A", rationale: "Cụm từ cố định (collocation) là <b>'give a quick boost'</b>, có nghĩa là 'tạo ra một sự thúc đẩy/tăng cường nhanh chóng' (về năng lượng)." },
            { q: 16, text: "Living to an average of 83 years old, Japan is the nation with the highest _____ in the world.", options: ["lifetime", "life work", "life force", "life expectancy"], answer: "D", rationale: "Thuật ngữ dùng để chỉ số năm sống trung bình của một quốc gia là <b>'life expectancy'</b> (tuổi thọ trung bình)." },
            { q: 17, text: "In addition to a nutritious diet, a______ lifestyle can boost your health and increase your life expectancy.", options: ["stress-free", "sugar-free", "cholesterol-free", "anti-ageing"], answer: "A", rationale: "Lối sống <b>'stress-free'</b> (không căng thẳng) là yếu tố quan trọng ảnh hưởng đến sức khỏe và tuổi thọ, bổ sung cho chế độ ăn." },
            { q: 18, text: "Science has shown that many types of chronic diseases are ___________ to people’s bad eating habits.", options: ["given", "attributed", "contributed", "caused"], answer: "B", rationale: "Cấu trúc cố định là <b>'be attributed to'</b> có nghĩa là 'được quy cho/cho là do' một nguyên nhân nào đó." },
            { q: 19, text: "You have to take the full ____ of your antibiotics even if you feel better, otherwise, your illness will simply return.", options: ["course", "prescription", "receipt", "treatment"], answer: "A", rationale: "Cụm từ <b>'a course of antibiotics'</b> có nghĩa là một 'liệu trình thuốc kháng sinh'." },
            { q: 20, text: "Eating more fresh fruits and vegetables, cooking meals at home, and reducing your __________ of sugar may help to improve your mood and lower your risk for mental health problems.", options: ["influence", "suggestion", "intake", "absorb"], answer: "C", rationale: "Danh từ <b>'intake'</b> có nghĩa là 'lượng hấp thụ/tiêu thụ'." },
            { q: 21, text: "A popular way to  ______  stress in today’s busy liíestyles is practising meditation.", options: ["relieve", "relax", "repeat", "require"], answer: "A", rationale: "Cụm động từ cố định là <b>'relieve stress'</b> (giảm căng thẳng)." },
            { q: 22, text: "Treatment for ________ may involve a combination of medications and lifestyle adjustments for ideal recovery and long-term health.", options: ["tuberculous", "tuberculose", "tuberculosis", "tuberculoid"], answer: "C", rationale: "Vị trí này cần một danh từ chỉ tên một căn bệnh. <b>'Tuberculosis'</b> là danh từ có nghĩa là 'bệnh lao'." },
            { q: 23, text: "To improve cardiovascular ___________, aerobic exercises like running or swimming are recommended.", options: ["bacteria", "ingredient", "strength", "fitness"], answer: "D", rationale: "Cụm danh từ chuyên ngành là <b>'cardiovascular fitness'</b>, có nghĩa là 'sự khỏe mạnh của hệ tim mạch'." },
            
            // T2_Ex6 (36 Questions) - Phrasal verbs, collocations, grammar
            { q: 24, text: "I live in a/an _________with my parents and my elder sister in the Coastal area.", options: ["extended family", "nuclear family", "extended house", "nuclear house"], answer: "B", rationale: "Gia đình được mô tả chỉ gồm có 'cha mẹ' và 'chị gái', đây là định nghĩa của một <b>'nuclear family'</b> (gia đình hạt nhân)." },
            { q: 25, text: "_________ is a family group with a close relationship among the members that includes not only parents and children but also uncles, aunts, grandparents, etc.", options: ["nuclear family", "blended family", "extended family", "stepfamily"], answer: "C", rationale: "Định nghĩa được đưa ra hoàn toàn khớp với khái niệm <b>'extended family'</b> (gia đình đa thế hệ/gia đình mở rộng)." },
            { q: 26, text: "After graduating from university, I want to __________ my father’s footsteps.", options: ["follow in", "succeed in", "go after", "keep up"], answer: "A", rationale: "Thành ngữ cố định (idiom) là <b>'follow in someone’s footsteps'</b>, có nghĩa là 'nối nghiệp, theo gương ai đó'." },
            { q: 27, text: "Four generations living under the same roof will have different ___________ of lifestyle.", options: ["gaps", "terms", "subjects", "viewpoints"], answer: "D", rationale: "Các thế hệ khác nhau sẽ có những quan điểm, góc nhìn khác nhau về lối sống. <b>'Viewpoints'</b> (quan điểm) là từ phù hợp nhất." },
            { q: 28, text: "Mothers often____________ themselves for their children.", options: ["die", "devote", "sacrifice", "give"], answer: "C", rationale: "Động từ <b>'sacrifice'</b> (hy sinh) là từ phù hợp nhất để diễn tả sự hy sinh của người mẹ cho con cái." },
            { q: 29, text: "Due to financial conflict over the years, they decided to get ____.", options: ["divorced", "engaged", "married", "proposed"], answer: "A", rationale: "Hậu quả logic của 'xung đột tài chính trong nhiều năm' là ly hôn. Cụm từ cố định là <b>'get divorced'</b>." },
            { q: 30, text: "She considers people to be the products of the values and ________of the society they live in.", options: ["norms", "requirements", "situations", "behaviours"], answer: "A", rationale: "Trong xã hội học, 'values and norms' (các giá trị và chuẩn mực) là một cụm từ cố định (collocation)." },
            { q: 31, text: "Knocking on closed doors before entering can be a great way for children to practice ________ behaviors.", options: ["respecting", "respectful", "respective", "respected"], answer: "B", rationale: "Vị trí này cần một <b>tính từ</b> để bổ nghĩa cho danh từ 'behaviors'. <b>'Respectful'</b> có nghĩa là 'thể hiện sự tôn trọng'." },
            { q: 32, text: "My mother _________ me from going home after 10 p.m. every day.", options: ["forbids", "allows", "lets", "All are correct"], answer: "A", rationale: "Chỉ có động từ <b>'forbid'</b> (cấm) đi với cấu trúc 'forbid someone <b>from</b> doing something'." },
            { q: 33, text: "You need to read newspapers and watch the news to keep ________on current topics.", options: ["reliable", "well-informed", "decisive", "independent"], answer: "B", rationale: "Cụm từ cố định là <b>'keep well-informed on/about something'</b>, có nghĩa là 'giữ cho bản thân được cập nhật thông tin'." },
            { q: 34, text: "Anna often dresses _________ when going to the parties in order to attract her friends’ attention.", options: ["plainly", "properly", "flashily", "soberly"], answer: "C", rationale: "Để 'thu hút sự chú ý', cách ăn mặc phải nổi bật. Trạng từ <b>'flashily'</b> (một cách lòe loẹt) là phù hợp nhất." },
            { q: 35, text: "I was tired and couldn’t________ on doing my research project properly.", options: ["concentrate", "look", "pay attention", "Both A and C"], answer: "A", rationale: "Động từ duy nhất đi với giới từ 'on' là <b>'concentrate'</b>. Cấu trúc: 'concentrate on something'." },
            { q: 36, text: "My parents don’t let me get married until I graduate from university and they never ______ their mind about that.", options: ["keep", "impose", "focus", "change"], answer: "D", rationale: "Thành ngữ cố định là <b>'change one's mind'</b>, có nghĩa là 'thay đổi quyết định/suy nghĩ'." },
            { q: 37, text: "I do morning exercise and play volleyball regularly so as to keep ________and be healthier.", options: ["fit", "good shape", "healthy", "strength"], answer: "A", rationale: "Cụm từ cố định phổ biến nhất là <b>'keep fit'</b>, có nghĩa là 'giữ dáng, giữ cho cơ thể khỏe mạnh và cân đối'." },
            { q: 38, text: "I wish I could do something to reduce financial ________ on my parents.", options: ["capital", "burden", "limit", "gap"], answer: "B", rationale: "Cụm từ cố định (collocation) là <b>'financial burden'</b> (gánh nặng tài chính)." },
            { q: 39, text: "He was _________ with himself for letting things get out of control.", options: ["furious", "content", "satisfied", "shocked"], answer: "A", rationale: "Khi mọi thứ 'vượt khỏi tầm kiểm soát', cảm xúc tiêu cực như giận dữ là phù hợp nhất. Do đó, <b>'furious'</b> (giận dữ) là đáp án đúng." },
            { q: 40, text: "Gary didn’t always _____________ with his father, and they don't have a lot in common.", options: ["see eye to eye", "take the initiative", "pop the question", "change his mind"], answer: "A", rationale: "Thành ngữ <b>'see eye to eye'</b> có nghĩa là 'đồng tình, có cùng quan điểm'." },
            { q: 41, text: "His attitude _______ other people makes me upset.", options: ["on", "for", "with", "towards"], answer: "D", rationale: "Danh từ 'attitude' (thái độ) đi với giới từ <b>'towards'</b> hoặc 'to'." },
            { q: 42, text: "Then the strangest thing happens – Will and Marcus _______ex_____an unusual friendship.", options: ["drift apart", "take up", "strike up", "take off"], answer: "C", rationale: "Cụm động từ <b>'strike up a friendship'</b> có nghĩa là 'bắt đầu một tình bạn', thường là bất ngờ." },
            { q: 43, text: "Most of us, even with every communication option possible, ___________ from friends.", options: ["give up", "set up", "look after", "drift apart"], answer: "D", rationale: "Cụm động từ <b>'drift apart'</b> (dần xa cách) phù hợp với sự tương phản trong câu." },
            { q: 44, text: "Nick had to leave the party early as his parents did not _______ him to go home later than 23:00.", options: ["let", "make", "forbid", "allow"], answer: "D", rationale: "Chỉ có động từ <b>'allow'</b> có cấu trúc 'allow someone <b>to do</b> something', phù hợp với 'him to go' trong câu." },
            { q: 45, text: "I don’t know what to say to break the _____ with someone I’ve just met at the party.", options: ["air", "ice", "leg", "rule"], answer: "B", rationale: "Thành ngữ cố định là <b>'break the ice'</b>, có nghĩa là 'phá vỡ sự ngại ngùng ban đầu'." },
            { q: 46, text: "Their close friendship ______ a romantic relationship.", options: ["brings about", "puts up", "takes over", "turns into"], answer: "D", rationale: "Cụm động từ <b>'turns into'</b> có nghĩa là 'biến thành, chuyển thành'." },
            { q: 47, text: "It’s time I_______ and raised a family.", options: ["carried on", "grew up", "settled down", "worked out"], answer: "C", rationale: "Cụm từ <b>'settled down'</b> (ổn định cuộc sống) thường đi cùng với việc 'lập gia đình'." },
            { q: 48, text: "They fell _______ because they disagreed on the care of their young son.", options: ["apart", "away", "out", "over"], answer: "C", rationale: "Cụm động từ <b>'fall out'</b> có nghĩa là 'cãi nhau, trở nên bất hòa'." },
            { q: 49, text: "All the three boys seem to fall _______ over heels in love with her.", options: ["head", "heart", "mind", "soul"], answer: "A", rationale: "Thành ngữ cố định là <b>'fall head over heels in love with someone'</b>." },
            { q: 50, text: "Would you mind giving me a hand _____ cooking?", options: ["to", "with", "for", "of"], answer: "B", rationale: "Cụm từ 'give someone a hand' đi với giới từ <b>'with'</b>." },
            { q: 51, text: "Parents are always willing to lend a sympathetic _______ to their children when they have problems.", options: ["hand", "ear", "eye", "paw"], answer: "B", rationale: "Thành ngữ cố định là <b>'lend a sympathetic ear'</b>, có nghĩa là 'lắng nghe một cách đầy thông cảm'." },
            { q: 52, text: "His youngest daughter was the ________ of his eye.", options: ["apple", "honey", "sweet", "strawberry"], answer: "A", rationale: "Thành ngữ cố định là <b>'the apple of one's eye'</b>, có nghĩa là 'người/vật mà ai đó yêu thương, quý trọng nhất'." },
            { q: 53, text: "Parents should teach children about ___ by establishing a rule about knocking on closed doors before entering.", options: ["loneliness", "care", "privacy", "peace"], answer: "C", rationale: "Hành động 'gõ cửa trước khi vào' là một quy tắc để tôn trọng <b>'privacy'</b> (sự riêng tư)." },
            { q: 54, text: "To be ___ good terms with someone is to have a good relationship with someone.", options: ["on", "over", "off", "above"], answer: "A", rationale: "Thành ngữ cố định là <b>'be on good terms with someone'</b>." },
            { q: 55, text: "The advantages of the new method really _______ the disadvantages.", options: ["outperform", "outdo", "outweigh", "outgrow"], answer: "C", rationale: "Động từ <b>'outweigh'</b> (nặng hơn, có giá trị hơn) phù hợp khi so sánh ưu điểm và nhược điểm." },
            { q: 56, text: "The younger generation is often ______about how their grandparents lived without modern technology.", options: ["digital", "worried", "curious", "critical"], answer: "C", rationale: "Người trẻ thường có cảm giác <b>'curious'</b> (tò mò) về cuộc sống trong quá khứ." },
            { q: 57, text: "To ________daily arguments, grandparents and grandchildren should make an effort to understand each other's viewpoints and preferences.", options: ["express", "avoid", "expect", "provide"], answer: "B", rationale: "Mục đích của việc 'cố gắng hiểu nhau' là để <b>'avoid'</b> (tránh) những cuộc cãi vã." },
            { q: 58, text: "Modern technology has influenced the cultural _______of younger generations, creating a gap with older generations.", options: ["values", "conditions", "differences", "characteristics"], answer: "A", rationale: "Công nghệ hiện đại ảnh hưởng đến các <b>'cultural values'</b> (giá trị văn hóa)." },
            { q: 59, text: "Parents sometimes face _______with their children about career choices.", options: ["agree", "agreeable", "agreements", "disagreements"], answer: "D", rationale: "Vị trí này cần danh từ mang ý nghĩa tiêu cực: <b>'disagreements'</b> (sự bất đồng)." },
            
            // T1_Ex2 (15 Questions) - Closest meaning
            { q: 60, text: "This kind of fruit helps to **boost** the immune system.", options: ["decrease", "reduce", "increase", "maintain"], answer: "C", rationale: "'Boost' có nghĩa là 'tăng cường, thúc đẩy', đồng nghĩa với <b>'increase'</b>." },
            { q: 61, text: "Life **expectancy** for both men and women has improved greatly in the past twenty years.", options: ["living standard", "longevity", "Life skills", "Lifeline"], answer: "B", rationale: "'Life expectancy' (tuổi thọ trung bình) có nghĩa gần nhất với <b>'longevity'</b> (sự trường thọ)." },
            { q: 62, text: "Here are some **principles** for people to stick to if they want to stay healthy.", options: ["rules", "principals", "laws", "duties"], answer: "A", rationale: "'Principles' (những nguyên tắc) có nghĩa gần nhất với <b>'rules'</b> (những quy tắc)." },
            { q: 63, text: "We should **consume** healthy food and exercise regularly.", options: ["store", "purchase", "buy", "eat"], answer: "D", rationale: "Trong ngữ cảnh thực phẩm, 'consume' (tiêu thụ) có nghĩa gần nhất với <b>'eat'</b>." },
            { q: 64, text: "The doctor **warned** his patient not to take too much sugar.", options: ["Shouted", "threatened", "punished", "cautioned"], answer: "D", rationale: "'Warned' (cảnh báo) có nghĩa gần nhất với <b>'cautioned'</b> (cảnh báo, nhắc nhở)." },
            { q: 65, text: "In order to stay healthy, make sure you have a balanced **intake** of vitamins and minerals.", options: ["take-off", "take-away", "consumption", "digestion"], answer: "C", rationale: "'Intake' (lượng hấp thụ, lượng tiêu thụ) có nghĩa gần nhất với <b>'consumption'</b> (sự tiêu thụ)." },
            { q: 66, text: "People can fight **infection** more easily if they have an adequate diet.", options: ["injection", "disease", "hygiene", "each other"], answer: "B", rationale: "'Infection' (sự nhiễm trùng, bệnh truyền nhiễm) là một loại bệnh, do đó nó gần nghĩa nhất với <b>'disease'</b> (bệnh tật)." },
            { q: 67, text: "Eating a **wide** variety of fruit and vegetables provides you with vitamins and nutrients.", options: ["broad", "narrow", "limited", "certain"], answer: "A", rationale: "'Wide' (rộng, đa dạng) đồng nghĩa với <b>'broad'</b> (rộng)." },
            { q: 68, text: "She gave us some tips for keeping our skin healthy and preventing **common** skin problems.", options: ["particular", "normal", "infrequent", "accepted"], answer: "B", rationale: "'Common' (phổ biến, thông thường) gần nghĩa nhất với <b>'normal'</b> (bình thường, thông thường)." },
            { q: 69, text: "Having healthy skin is especially **essential** to women to maintain their beauty.", options: ["trivial", "meaningless", "vital", "contributory"], answer: "C", rationale: "'Essential' (thiết yếu, cực kỳ quan trọng) đồng nghĩa với <b>'vital'</b> (sống còn, cực kỳ quan trọng)." },
            { q: 70, text: "If you **stare** at a computer screen for too long, it may damage your eyesight.", options: ["peep", "look", "glance", "gaze"], answer: "D", rationale: "'Stare' (nhìn chằm chằm) có nghĩa gần nhất với <b>'gaze'</b> (nhìn chăm chú)." },
            { q: 71, text: "The increase in life expectancy can be attributed to healthier lifestyles, better nutrition, and **advances** in medical science and technology.", options: ["activities", "advisers", "delays", "breakthroughs"], answer: "D", rationale: "'Advances' (những tiến bộ) có nghĩa gần nhất với <b>'breakthroughs'</b> (những đột phá)." },
            { q: 72, text: "Losing a lot of liquid can **lead to** heat stroke.", options: ["result from", "result in", "originate", "be due to"], answer: "B", rationale: "'Lead to' (dẫn đến, gây ra) đồng nghĩa với <b>'result in'</b> (gây ra kết quả là)." },
            { q: 73, text: "You should drink a glass of water before a workout and then **pause** regularly to drink more.", options: ["break up", "break down", "break off", "break in"], answer: "C", rationale: "'Pause' (tạm dừng) có nghĩa gần nhất với <b>'break off'</b> (ngừng lại tạm thời một hành động)." },
            { q: 74, text: "If yoga is not done **properly**, it can do more harm than good.", options: ["socially accepted", "morally accepted", "correctly", "easily"], answer: "C", rationale: "'Properly' (một cách đúng đắn, thích hợp) có nghĩa gần nhất với <b>'correctly'</b> (một cách chính xác)." },
            
            // T2_Ex7 (10 Questions) - Closest meaning
            { q: 75, text: "When I was a child, my mother used to teach me **table manners**.", options: ["etiquette", "rule", "problem", "norm"], answer: "A", rationale: "'Table manners' (phép tắc trên bàn ăn) là một phần của <b>'etiquette'</b> (phép xã giao, nghi thức)." },
            { q: 76, text: "Many parents find it hard to understand their children when they are **teenagers**.", options: ["adults", "elders", "adolescents", "kids"], answer: "C", rationale: "'Teenagers' (thiếu niên) có nghĩa gần nhất với <b>'adolescents'</b> (thanh thiếu niên)." },
            { q: 77, text: "My mother mistakenly believes that my fashion style breaks the **norm** of society.", options: ["routine", "barrier", "rule", "conflict"], answer: "C", rationale: "'Norm' (chuẩn mực) gần nghĩa nhất với <b>'rule'</b> (quy tắc)." },
            { q: 78, text: "We find it unattractive when dress **flashily**.", options: ["luxuriantly", "ostentatiously", "cheaply", "fashionably"], answer: "B", rationale: "'Flashily' (một cách lòe loẹt, phô trương) có nghĩa gần nhất với <b>'ostentatiously'</b> (một cách phô trương)." },
            { q: 79, text: "I feel extremely depressed as conflict **occurs** frequently amongst generations in my family.", options: ["comes on", "comes up", "comes in", "comes into"], answer: "B", rationale: "'Occurs' (xảy ra, diễn ra) gần nghĩa với cụm động từ <b>'comes up'</b> (nảy sinh, xảy ra)." },
            { q: 80, text: "She felt unsafe and **insecure** in love.", options: ["anxious", "calm", "silly", "unlucky"], answer: "A", rationale: "'Insecure' (cảm thấy bất an, thiếu tự tin) có nghĩa gần nhất với <b>'anxious'</b> (lo lắng)." },
            { q: 81, text: "I am now **reconciled** with two of my estranged siblings – not just my older brother, but my sister.", options: ["acceptable", "harmonized", "opposed", "truthful"], answer: "B", rationale: "'Reconciled' (được hòa giải, làm lành) có nghĩa gần nhất với <b>'harmonized'</b> (được hòa hợp)." },
            { q: 82, text: "He doesn’t completely **trust** online partners, as they usually hide their real identity.", options: ["argument", "decision", "opinion", "personality"], answer: "A", rationale: "<b>Lưu ý:</b> Câu hỏi này có lỗi trong đề gốc (Động từ 'trust' không đồng nghĩa với danh từ). Ta chọn A vì nó là lựa chọn duy nhất có trong dữ liệu gốc." }, 
            { q: 83, text: "Sometimes, in order to get things done, you have to **take the initiative**.", options: ["make the last decision", "make important changes", "raise the first idea", "sacrifice for others"], answer: "C", rationale: "'Take the initiative' (chủ động, khởi xướng) có nghĩa gần nhất với <b>'raise the first idea'</b> (đưa ra ý tưởng đầu tiên)." },
            { q: 84, text: "Some parents strongly **oppose** their children’s romantic relationship.", options: ["assist", "forbid", "ignore", "preserve"], answer: "B", rationale: "'Oppose' (phản đối) mạnh mẽ có thể dẫn đến hành động cấm đoán, do đó <b>'forbid'</b> (cấm) là từ gần nghĩa nhất trong ngữ cảnh này." },
        ];


        // 2. Word Form Questions (16 + 20 = 36 questions)
        const wordFormPool = [
            // T1_Ex3 (16 Questions)
            { q: 1, text: "Working out can really _________________________ your muscles. (STRONG)", answer: "strengthen", rationale: "Từ loại cần điền là <b>động từ (V)</b>: 'Strengthen'." },
            { q: 2, text: "The food and drink we consume can _______________________ affect our health. (DRAMA)", answer: "dramatically", rationale: "Từ loại cần điền là <b>trạng từ (Adv)</b>: 'Dramatically'." },
            { q: 3, text: "Home-made _____________________ masks based on fruits are completely natural and inexpensive. (ACNE)", answer: "acne", rationale: "Từ loại cần điền là <b>danh từ (N)</b> tạo cụm danh từ kép: 'Acne'." },
            { q: 4, text: "Some people believe that _______________________ food can make them younger. (AGE)", answer: "anti-ageing", rationale: "Từ loại cần điền là <b>tính từ ghép (Adj)</b>: 'Anti-ageing'." },
            { q: 5, text: "_____________________ drinks are better for your teeth and general health. (SUGAR)", answer: "sugar-free", rationale: "Từ loại cần điền là <b>tính từ ghép (Adj)</b>: 'Sugar-free'." },
            { q: 6, text: "One of the main responsibilities of a dietitian is to promote _________________ and balanced diets. (NUTRITION)", answer: "nutritious", rationale: "Từ loại cần điền là <b>tính từ (Adj)</b>: 'Nutritious'." },
            { q: 7, text: "My doctor said that these _______________________ remedies can boost my immune system. (NATURE)", answer: "natural", rationale: "Từ loại cần điền là <b>tính từ (Adj)</b>: 'Natural'." },
            { q: 8, text: "Some people believe that keeping a diary of daily activities is one simple way to help you to stay _______________. (HEALTH)", answer: "healthy", rationale: "Từ loại cần điền là <b>tính từ (Adj)</b> sau 'stay': 'Healthy'." },
            { q: 9, text: "Life _________________has increased over the past twenty years in our country (EXPECT)", answer: "expectancy", rationale: "Từ loại cần điền là <b>danh từ (N)</b>: 'Expectancy'." },
            { q: 10, text: "The doctors have discussed the ________________ for hours but they haven’t made the final decision. (TREAT)", answer: "treatment", rationale: "Từ loại cần điền là <b>danh từ (N)</b>: 'Treatment'." },
            { q: 11, text: "Many old people have no diseases such as high blood _______________ heart disease or diabetes. (PRESS)", answer: "pressure", rationale: "Từ loại cần điền là <b>danh từ (N)</b> tạo cụm 'blood pressure': 'Pressure'." },
            { q: 12, text: "Scientists are trying to work out ______________ how much of the longevity is due to the environment. (EXACT)", answer: "exactly", rationale: "Từ loại cần điền là <b>trạng từ (Adv)</b> bổ nghĩa cho 'work out': 'Exactly'." },
            { q: 13, text: "Women suffering from stress and _________________ are more likely to die from heart disease or stroke. (ANXIOUS)", answer: "anxiety", rationale: "Từ loại cần điền là <b>danh từ (N)</b> song hành với 'stress': 'Anxiety'." },
            { q: 14, text: "Many people think that life expectancy is much _________________ by genes. (INFLUENCE)", answer: "influenced", rationale: "Từ loại cần điền là <b>V3/ed</b> trong cấu trúc bị động: 'Influenced'." },
            { q: 15, text: "A _________________ work environment plus a lack of sleep can lead to higher risk of death. (STRESS)", answer: "stressful", rationale: "Từ loại cần điền là <b>tính từ (Adj)</b> bổ nghĩa cho 'work environment': 'Stressful'." },
            { q: 16, text: "A healthy lifestyle should be aimed to promote productivity and _______________ at work. (EFFICIENT)", answer: "efficiency", rationale: "Từ loại cần điền là <b>danh từ (N)</b> song hành với 'productivity': 'Efficiency'." },
            
            // T2_Ex8 (20 Questions)
            { q: 17, text: "I have established a good working ___________________ with my boss. (RELATE)", answer: "relationship", rationale: "Từ loại cần điền là <b>danh từ (N)</b>: 'Relationship'." },
            { q: 18, text: "These measures would make a valuable ____________________towards reducing industrial accidents (CONTRIBUTE)", answer: "contribution", rationale: "Từ loại cần điền là <b>danh từ (N)</b>: 'Contribution'." },
            { q: 19, text: "No official ____________________has been given for the event to take place. (PERMIT)", answer: "permission", rationale: "Từ loại cần điền là <b>danh từ (N)</b>: 'Permission'." },
            { q: 20, text: "Many students tend to drop out of school due to getting involved in__________________ love. (ROMAN)", answer: "romantic", rationale: "Từ loại cần điền là <b>tính từ (Adj)</b>: 'Romantic'." },
            { q: 21, text: "I always have difficulties in life, so I really need a ____________________friend. (SYMPATHY)", answer: "sympathetic", rationale: "Từ loại cần điền là <b>tính từ (Adj)</b>: 'Sympathetic'." },
            { q: 22, text: "______________________ seems to be easier with the aid of the internet. (MATCHMAKE)", answer: "matchmaking", rationale: "Từ loại cần điền là <b>danh động từ (V-ing)</b>: 'Matchmaking'." },
            { q: 23, text: "She complained that the photographs were an invasion of her__________________ (PRIVATE)", answer: "privacy", rationale: "Từ loại cần điền là <b>danh từ (N)</b>: 'Privacy'." },
            { q: 24, text: "There is also a big ______________________ difference between millennials and Gen Z. (GENERATION)", answer: "generational", rationale: "Từ loại cần điền là <b>tính từ (Adj)</b>: 'Generational'." },
            { q: 25, text: "Many parents have high _____________________ for their children. (EXPECT)", answer: "expectations", rationale: "Từ loại cần điền là <b>danh từ số nhiều (N-pl)</b>: 'Expectations'." },
            { q: 26, text: "James is a _________________ student. Not only does he complete all required exercises but he looks for some extra ones as well. (STUDY)", answer: "studious", rationale: "Từ loại cần điền là <b>tính từ (Adj)</b>: 'Studious'." },
            { q: 27, text: "The main_________________ to the plan was that it would cost too much. (OBJECT)", answer: "objection", rationale: "Từ loại cần điền là <b>danh từ (N)</b>: 'Objection'." },
            { q: 28, text: "Some parents may also find their children's behavior unacceptable and ________________ to traditional values. (RESPECT)", answer: "disrespectful", rationale: "Từ loại cần điền là <b>tính từ (Adj)</b> mang nghĩa tiêu cực: 'Disrespectful'." },
            { q: 29, text: "There is a need for developing ____________ and acceptance in order to bridge the gap. (UNDERSTAND)", answer: "understanding", rationale: "Từ loại cần điền là <b>danh từ (N)</b>: 'Understanding'." },
            { q: 30, text: "The ____________ between parents and children is often affected by their generation gap. (RELATE)", answer: "relationship", rationale: "Từ loại cần điền là <b>danh từ (N)</b>: 'Relationship'." },
            { q: 31, text: "Such a generational dispute can make things____________for both parents and children. (EMBARRASS)", answer: "embarrassing", rationale: "Từ loại cần điền là <b>tính từ (Adj)</b> mô tả sự vật/việc: 'Embarrassing'." },
            { q: 32, text: "It is nothing but a ___________ gap between parents and adults and the younger generation. (PSYCHOLOGY)", answer: "psychological", rationale: "Từ loại cần điền là <b>tính từ (Adj)</b>: 'Psychological'." },
            { q: 33, text: "A ____________ of parents spend less time communicating with and listening to their kids. (MAJOR)", answer: "majority", rationale: "Từ loại cần điền là <b>danh từ (N)</b>: 'Majority'." },
            { q: 34, text: "Children feel stressed and ____________ because they have a lot to do and excel at. (ANXIETY)", answer: "anxious", rationale: "Từ loại cần điền là <b>tính từ (Adj)</b> miêu tả trạng thái: 'Anxious'." },
            { q: 35, text: "Having a parent who always listens will give your child more ____________ to listen to you in return. (ENCOURAGE)", answer: "encouragement", rationale: "Từ loại cần điền là <b>danh từ (N)</b>: 'Encouragement'." },
            { q: 36, text: "There are several factors responsible for the ____________ of one generation from the other. (SEPARATE)", answer: "separation", rationale: "Từ loại cần điền là <b>danh từ (N)</b>: 'Separation'." },
        ];
        
        // 3. Rearrange Questions (12 questions)
        const rearrangePool = [
            { id: 'R_Q1', title: 'Question 1 (Exchange):', type: 'rearrange', text: 'a. Mei: Yes, I went through it last night. The insights were truly eye – opening!\nb. Farrah: Hmm, they made me reflect on how important it is to balance our digital habits. Perhaps setting some boundaries, like limiting screen time before bed, could help us manage stress better.\nc. Farrah: Morning, Mei! Did you read the article about the correlation between excessive screen time and mental well – being?', options: ["c – b – a", "a – b – c", "c – a – b", "a – c – b"], answer: "C", rationale: "Trật tự <b>c – a – b</b> là hợp lý nhất: Câu hỏi (c) -> Trả lời (a) -> Phát triển ý (b)." },
            { id: 'R_Q2', title: 'Question 2 (Exchange):', type: 'rearrange', text: 'a. Clara: I love that. It sounds like you thought this through.\nb. Ophelia: Yes, I have been pushing myself with more advanced bodyweight exercises lately – It’s tough but rewarding.\nc. Clara: That’s awesome! What made you want to try something so different?\nd. Ophelia: Honestly, it’s not just about building strength but also fostering discipline and resilience.\ne. Clara: Are you still committed to those calisthenics routines you mentioned last week?', options: ["b – a – e – d – c", "c – e – a – b – d", "c – d – a – b – e", "e – b – c – d – a"], answer: "D", rationale: "Trật tự <b>e – b – c – d – a</b> là hợp lý nhất: Hỏi (e) -> Xác nhận (b) -> Hỏi lý do (c) -> Giải thích lý do (d) -> Thán phục (a)." },
            { id: 'R_Q3', title: 'Question 3 (Letter from Khanh):', type: 'rearrange', text: 'a. It’s fascinating to see how a nutritious diet can significantly boost both mental clarity and energy levels.\nb. Thanks to your recommendation, I’ve started combining more whole foods with my meals, and I feel a tangible difference.\nc. Your insights into the benefits of reducing ultra – processed foods were incredibly valuable.\nd. I’ll continue exploring these strategies to refine my approach further.\ne. I’m deeply grateful for the time you took to guide me through the nuances of healthy eating. Talk soon, Khanh', options: ["e – d – b – a – c", "e – b – c – a – d", "b – a – d – e – c", "b – d – c – e – a"], answer: "B", rationale: "Trật tự <b>e – b – c – a – d</b> là hợp lý nhất: Lời cảm ơn (e) -> Hành động đã làm (b) -> Nhắc lại lời khuyên (c) -> Lợi ích (a) -> Kết thư (d)." },
            { id: 'R_Q4', title: 'Question 4 (Paragraph on Health):', type: 'rearrange', text: 'a. Thus, while we may see health as a simple foundation, it is the unseen force shaping every aspect of our existence.\nb. Many fail to recognize that poor health can silently erode not just our physical capabilities, but our mental resilience as well.\nc. Good health is the cornerstone of a fulfilling life, providing the strength and vitality needed to pursue our goals.\nd. This gradual decline often goes unnoticed until it becomes too late to reverse the damage leaves individuals facing an uphill battle.\ne. Without it, even the most driven individuals can find their aspirations slipping out of reach.', options: ["b – a – c – e – d", "c – d – b – e – a", "c – e – b – d – a", "b – c – e – a – d"], answer: "C", rationale: "Trật tự <b>c – e – b – d – a</b> là hợp lý nhất: Câu chủ đề (c) -> Hậu quả nếu thiếu (e) -> Vấn đề sâu hơn (b) -> Quá trình của vấn đề (d) -> Kết luận (a)." },
            { id: 'R_Q5', title: 'Question 5 (Paragraph on Kidney Health):', type: 'rearrange', text: 'a. Maintaining optimal kidney function is paramount for overall health, as these vital organs play a critical role in filtering waste and regulating fluid balance.\nb. Moreover, managing chronic conditions such as hypertension and diabetes is crucial, as they are significant risk factors for kidney disease.\nc. By adopting a proactive approach to kidney health, individuals can significantly reduce their risk of renal failure and enhance their life expectancy.\nd. To safeguard kidney health, it is essential to adopt a lifestyle that priorities hydration, balanced nutrition, and regular exercise.\ne. Reducing the intake of high – sodium foods and processed sugars can alleviate undue strain on the kidneys while ensuring an adequate intake of antioxidants from fruits and vegetables can help protect against cellular damage.', options: ["c – b – d – e – a", "a – d – e – b – c", "a – b – e – d – c", "c – b – e – d – a"], answer: "B", rationale: "Trật tự <b>a – d – e – b – c</b> là hợp lý nhất: Giới thiệu tầm quan trọng (a) -> Giải pháp lối sống chung (d) -> Chi tiết về lối sống (e) -> Giải pháp quản lý bệnh (b) -> Kết luận/Lợi ích (c)." },
            { id: 'R_Q6', title: 'Question 6 (Letter to Win):', type: 'rearrange', text: 'a. Thanks so much for the recommendation; I’m sure it’ll be a hit at the next dinner party!\nb. I love how flexible lasagna is; it’s amazing that it can be adapted for both meat – eaters and vegetarians.\nc. I’ve been thinking a lot about your suggestion to serve baked lasagna at the dinner party. It’s such a great idea, and I can see how it would be both convenient and delicious for any gathering.\nd. A simple green salad and Italian bread seem like the perfect sides to complement the dish, and of course, a dessert to wrap things up!\ne. I’m definitely going to try making it the night before so I don’t have to worry about cooking the day of.', options: ["b – d – c – e – a", "c – d – b – e – a", "c – e – b – d – a", "b – c – e – d – a"], answer: "C", rationale: "Trật tự <b>c – e – b – d – a</b> là hợp lý nhất: Nhắc lại gợi ý (c) -> Kế hoạch thực hiện (e) -> Bình luận thêm về món ăn (b) -> Món ăn kèm (d) -> Kết thư (a)." },
            { id: 'R_Q7', title: 'Question 7 (Paragraph on Healthy Eating):', type: 'rearrange', text: 'a. Instead, try to follow a healthy lifestyle by paying attention to portion sizes and choosing organic foods when possible.\nb. A balanced diet full of nutritious foods, such as fruits, vegetables, and whole grains, provides the necessary nutrients and minerals the body needs to function optimally. \nc. It’s important to cut down on fast food, which is often high in unhealthy ingredients like trans fats and sugars. \nd. Regularly choosing healthful foods will help you avoid unhealthy habits and support long – term health and fitness.\ne. Healthy eating habits are essential not only for maintaining physical health but also for promoting mental well – being, as what we eat directly influences our energy levels and mood.', options: ["e – d – b – a – c", "e – b – c – a – d", "b – a – d – e – c", "e – d – c – b – a"], answer: "B", rationale: "Trật tự <b>e – b – c – a – d</b> là hợp lý nhất: Câu chủ đề (e) -> Định nghĩa chế độ ăn cân bằng (b) -> Điều cần tránh (c) -> Điều nên làm (a) -> Kết luận/Lợi ích (d)." },
            { id: 'R_Q8', title: 'Question 8 (Tips for Better Sleep Hygiene):', type: 'rearrange', text: 'a. To ensure better sleep, it\'s crucial to maintain a regular bedtime routine, which helps your body get used to a specific sleep schedule. \nb. Reducing exposure to screens before bedtime allows your brain to relax and prepares you for rest.\nc. Lastly, calming activities like reading or practicing deep breathing can help you unwind, improving both your physical and mental well – being for a restful night.\nd. A comfortable sleep environment, such as keeping your room dark, quiet, and cool, also plays a significant role in enhancing your sleep quality. \ne. It’s important to avoid heavy meals and caffeine right before bed as they can disrupt your sleep cycle. ', options: ["c – b – d – e – a", "a – d – e – b – c", "a – b – e – d – c", "c – b – e – d – a"], answer: "B", rationale: "Trật tự <b>a – d – e – b – c</b> là hợp lý nhất: Nguyên tắc quan trọng nhất (a) -> Môi trường (d) -> Thói quen ăn uống (e) -> Thiết bị điện tử (b) -> Thư giãn (c)." },
            { id: 'R_Q9', title: 'Question 9 (Letter from Dad):', type: 'rearrange', text: 'a. Understanding each other better will help us close the generation gap.\nb. I hope we can sit down and have a real conversation — not to argue, but to listen.\nc. Maybe I have different beliefs because I grew up in another time, but that doesn’t mean I don’t care. \nd. I know we don’t always agree, and sometimes we argue about small things like clothes or housework. \ne. But I want you to know that I’m trying to understand your point of view. ', options: ["b-c-d-e-a", "d-e-c-b-a", "c-d-a-e-b", "d-a-b-c-e"], answer: "B", rationale: "Trật tự <b>d-e-c-b-a</b> là hợp lý nhất: Thừa nhận vấn đề (d) -> Bày tỏ thiện chí (e) -> Giải thích quan điểm (c) -> Đề xuất giải pháp (b) -> Mục tiêu (a)." },
            { id: 'R_Q10', title: 'Question 10 (Learning from Older):', type: 'rearrange', text: 'a. Spending time with older people is a great way to learn interesting and practical survival skills.\nb. I also learned how to start a fire from my grandfather, and it helps me a lot when I go camping.\nc. For example, my neighbor can teach me how to fish with a spear, which sounds really exciting. \nd. Older generations have many useful skills that young people can learn. \ne. They have years of experience doing things that we have never tried.', options: ["b-c-d-e-a", "d-e-c-b-a", "c-d-a-e-b", "d-a-b-c-e"], answer: "B", rationale: "Trật tự <b>d-e-c-b-a</b> là hợp lý nhất: Câu chủ đề (d) -> Giải thích (e) -> Ví dụ 1 (c) -> Ví dụ 2 (b) -> Kết luận (a)." },
            { id: 'R_Q11', title: 'Question 11 (Generation Gap Divide):', type: 'rearrange', text: 'a. Cultural and technological divides further exacerbate conflicts when parents hold traditional views on gender roles, education, or household responsibilities, while their children demand greater freedom and individuality.\nb. Teens often embrace digital natives’ lives, preferring text messaging and social media, while parents gravitate toward face-to-face communication, which can result in misunderstandings and tension. \nc. Generation gap—differences in values, communication styles, and social expectations between parents and children—is a natural part of family life in today’s fast-changing world.\nd. Ultimately, when both generations commit to understanding each other’s point of view, families can forge stronger bonds despite their differences.\ne. Fortunately, active listening, empathy, and open dialogue have been shown to effectively bridge these gaps—by creating safe spaces to share perspectives, set mutual expectations, and show respect.', options: ["c-a-b-d-e", "c-e-b-a-d", "b-c-e-a-d", "c-b-a-e-d"], answer: "D", rationale: "Trật tự <b>c-b-a-e-d</b> là hợp lý nhất: Định nghĩa (c) -> Vấn đề Giao tiếp (b) -> Vấn đề Văn hóa (a) -> Giải pháp (e) -> Kết quả (d)." },
            { id: 'R_Q12', title: 'Question 12 (Letter from Daughter):', type: 'rearrange', text: 'a. I respect your opinions, but I hope you can also respect mine.\nb. Let’s try to listen and understand each other better.\nc. I know we often argue about my clothes and how I spend my free time. \nd. I feel you don’t understand my choices because we see things differently. \ne. I want more freedom to express myself and follow my own interests. ', options: ["c-a-d-e-b", "c-d-e-a-b", "c-a-b-d-e", "a-d-c-b-e"], answer: "B", rationale: "Trật tự <b>c-d-e-a-b</b> là hợp lý nhất: Thừa nhận vấn đề (c) -> Giải thích nguyên nhân (d) -> Nêu mong muốn (e) -> Đề nghị tôn trọng (a) -> Kêu gọi hành động (b)." },
        ];

        // 4. Passage Pools (Grouped by Category and Content)
        
        // Cloze Announcement (6 Qs each)
        const announceClozePool = [
            // T3_Ex14 (6 Qs) - World Health Day
            { id: 'T3_Ex14', title: 'Đọc đoạn thông báo (Announcement) sau và điền từ thích hợp.', type: 'cloze', passage: "World Health Day! As every year, in order to celebrate World Health Day, we have extraordinary offers on fruit and vegetables! Our fantastic offers start on 1st April and end on World Health Day – 7th April. We know that health matters, and we want our customers to be (1) ____________ and happy. That’s why we have these fantastic offers for you: • Buy one, get one free on fresh and frozen fruit and vegetables! • Three for the price of two on (2) __________ ! And for our best customers, we have our best offer: If during the coming week, you spend £30 on fruit and vegetables, you will be able (3) ____________ a book with over a hundred recipes for healthy, nutritious dishes! Additionally, every customer (4) ____________ £25 in a single transaction at our supermarket that week has a chance (5) ____________ winning free fruit and vegetable shopping for a year! In order to (6) ____________ the competition, you need to fill in the form, giving your name, age, address, and telephone number, and attach the receipt.", questions: [
                { q: 1, text: "Question 1:", options: ["health", "healthy", "healthily", "healthful"], answer: "B", rationale: "Cần tính từ 'healthy' song hành với 'happy'." },
                { q: 2, text: "Question 2:", options: ["fruit canned and vegetables", "vegetables and fruit canned", "canned fruit and vegetables", "fruit and vegetables canned"], answer: "C", rationale: "Trật tự từ đúng: 'canned fruit and vegetables'." },
                { q: 3, text: "Question 3:", options: ["to receive", "receiving", "received", "receive"], answer: "A", rationale: "Cấu trúc 'be able to do something'." },
                { q: 4, text: "Question 4:", options: ["spent", "spend", "to spend", "who spent"], answer: "B", rationale: "Chủ ngữ 'every customer', ta dùng B theo đề gốc." },
                { q: 5, text: "Question 5:", options: ["on", "for", "of", "with"], answer: "C", rationale: "Cụm từ 'a chance <b>of</b> doing something'." },
                { q: 6, text: "Question 6:", options: ["enter", "hold", "make", "book"], answer: "A", rationale: "Cụm từ 'enter the competition'." },
            ]},
            // T3_Ex16 (6 Qs) - The Generational Mosaic
            { id: 'T3_Ex16', title: 'Đọc đoạn thông báo (Announcement) sau và điền từ thích hợp.', type: 'cloze', passage: "The Generational Mosaic: Different Pieces, One Stunning Picture. Our community shows both strength and strong leadership in facing daily challenges together. The (1) ____________ bring fresh ideas to community projects every month. Grandparents (2) ____________ wisdom inspire us all through interesting stories at family gatherings. We bring happiness (3) ____________ our families through fun activities and games. Together, we (4) ____________ bridges between generations through shared meals and storytelling nights. (5) ____________ together creates beautiful moments in our neighborhood community center. Join us in creating our community's (6) ____________ mosaic!", questions: [
                { q: 1, text: "Question 1:", options: ["skilled youth leaders", "youth skilled leaders", "leaders skilled youth", "skilled leaders youth"], answer: "A", rationale: "Trật tự tính từ: 'skilled youth leaders'." },
                { q: 2, text: "Question 2:", options: ["was shared", "sharing", "shared", "which shared"], answer: "B", rationale: "Rút gọn mệnh đề quan hệ chủ động: 'sharing'." },
                { q: 3, text: "Question 3:", options: ["for", "with", "to", "about"], answer: "C", rationale: "Cụm từ 'bring happiness <b>to</b> someone'." },
                { q: 4, text: "Question 4:", options: ["create", "form", "forge", "build"], answer: "D", rationale: "Thành ngữ 'build bridges'." },
                { q: 5, text: "Question 5:", options: ["To work", "Work", "To working", "Working"], answer: "D", rationale: "Danh động từ 'Working together' làm chủ ngữ." },
                { q: 6, text: "Question 6:", options: ["colorful", "colorize", "colorless", "colorfulness"], answer: "A", rationale: "Cần tính từ 'colorful' bổ nghĩa cho 'mosaic'." },
            ]},
        ];

        // Cloze Leaflet (6 Qs each)
        const leafletClozePool = [
            // T3_Ex13 (6 Qs) - Thriving Beyond Tomorrow
            { id: 'T3_Ex13', title: 'Đọc đoạn quảng cáo (Leaflet) sau và điền từ thích hợp.', type: 'cloze', passage: "Thriving Beyond Tomorrow: The New Science of Extended Wellness. Modern wellness practices differ from (7) _________ in their focus on long-term health outcomes rather than quick fixes. Scientists are constantly (8) _________ how lifestyle choices affect our longevity and quality of life. Recent (9) _________ in nutritional science have revealed the importance of micronutrients for cellular health. (10) _________ common misconceptions, aging is not simply an inevitable decline but a process that can be optimized. The (11) _________ of preventive medicine has transformed how we approach healthcare in the 21st century. A (12) _________ of studies have demonstrated the benefits of regular exercise for maintaining cognitive function.", questions: [
                { q: 7, text: "Question 7:", options: ["others", "another", "the others", "other"], answer: "D", rationale: "Dùng 'other' (ngầm hiểu là 'other practices')." },
                { q: 8, text: "Question 8:", options: ["working on", "thinking over", "going through", "looking into"], answer: "D", rationale: "Cụm động từ 'look into' (nghiên cứu, xem xét)." },
                { q: 9, text: "Question 9:", options: ["methods", "discoveries", "theories", "publications"], answer: "B", rationale: "'discoveries' (những khám phá) được 'revealed' (tiết lộ)." },
                { q: 10, text: "Question 10:", options: ["On top of", "Because of", "In spite of", "With regard to"], answer: "C", rationale: "Cần liên từ chỉ sự nhượng bộ 'In spite of' (Mặc cho)." },
                { q: 11, text: "Question 11:", options: ["philosophy", "advancement", "implementation", "regulation"], answer: "A", rationale: "Cụm từ 'The philosophy of...' (triết lý của...)." },
                { q: 12, text: "Question 12:", options: ["quantity", "bunch", "piece", "number"], answer: "D", rationale: "Cụm từ cố định 'A number of' + N(số nhiều)." },
            ]},
            // T3_Ex15 (6 Qs) - Stay Fit, Stay Healthy
            { id: 'T3_Ex15', title: 'Đọc đoạn quảng cáo (Leaflet) sau và điền từ thích hợp.', type: 'cloze', passage: "Stay Fit, Stay Healthy: Discover the Power of Regular Exercise! Boost Your Well – being with Daily Activity. Regular exercise is not just about fitness; it’s a pathway to a healthier, happier life. With just 30 minutes of physical activity each day, you can (7) ____________ enhance your mental and physical well – being. Why Exercise Matters. Exercise boosts your energy levels, helping you get through (8) ____________ day with greater focus and vitality. It strengthens your heart, fortifies your immune system, and supports a healthy weight. Plus, regular exercise releases endorphins, lifting your mood and lowering stress and anxiety. (9) ____________ , a (10) ____________ lifestyle can lead to feelings of fatigue, stress, and higher susceptibility to illness. Simple Steps for Big Gains. Whether it’s walking, cycling, or swimming, any movement helps. Regular exercise keeps your body active, reducing the risk of chronic diseases like diabetes, heart disease, and osteoporosis. On the contrary, (11) ____________ on physical activity could increase the likelihood of health problems down the road. Start Today and Feel the Difference! Small, consistent efforts yield lasting rewards. Begin your (12) ____________ to a healthier, happier life today – take a step, make a plan, and experience the difference!", questions: [
                { q: 7, text: "Question 7:", options: ["significantly", "totally", "critically", "increasingly"], answer: "A", rationale: "Trạng từ 'Significantly' (một cách đáng kể) bổ nghĩa cho 'enhance'." },
                { q: 8, text: "Question 8:", options: ["many", "few", "every", "each"], answer: "C", rationale: "Cụm từ 'get through <b>every</b> day'." },
                { q: 9, text: "Question 9:", options: ["In spite of", "In order that", "For the purpose of", "On the other hand"], answer: "D", rationale: "Cần liên từ chỉ sự đối lập 'On the other hand'." },
                { q: 10, text: "Question 10:", options: ["sedentary", "stressful", "vibrant", "bustling"], answer: "A", rationale: "Lối sống 'sedentary' (ít vận động) dẫn đến mệt mỏi." },
                { q: 11, text: "Question 11:", options: ["look up", "get out", "pick up", "missing out"], answer: "D", rationale: "Danh động từ 'missing out on' (bỏ lỡ)." },
                { q: 12, text: "Question 12:", options: ["voyage", "cruise", "journey", "trip"], answer: "C", rationale: "Từ ẩn dụ 'journey' (hành trình) là phù hợp nhất." },
            ]},
            // T3_Ex17 (6 Qs) - They Said Different Ages Can't Connect
            { id: 'T3_Ex17', title: 'Đọc đoạn quảng cáo (Leaflet) sau và điền từ thích hợp.', type: 'cloze', questions: [
                            { q: 7, text: "Question 7:", options: ["another", "others", "the others", "other"], answer: "B", rationale: "Cấu trúc 'some people..., <b>others</b>...' được dùng để đối lập hai nhóm người không xác định. 'Others' ở đây là đại từ, có nghĩa là 'những người khác'." },
                            { q: 8, text: "Question 8:", options: ["put up", "take up", "set up", "look up"], answer: "C", rationale: "Cụm động từ <b>'set up'</b> có nghĩa là 'tổ chức, thiết lập'." },
                            { q: 9, text: "Question 9:", options: ["workshops", "meetings", "parties", "classes"], answer: "A", rationale: "Nơi để 'chia sẻ câu chuyện và kỹ năng' (share stories and skills) phù hợp nhất là các <b>'workshops'</b> (buổi hội thảo, thực hành)." },
                            { q: 10, text: "Question 10:", options: ["With reference to", "in accordance with", "In spite of", "In addition to"], answer: "C", rationale: "Cần liên từ chỉ sự nhượng bộ <b>'In spite of'</b> (Mặc dù)." },
                            { q: 11, text: "Question 11:", options: ["companionship", "friendship", "teamwork", "happiness"], answer: "A", rationale: "Trong ngữ cảnh làm vườn cộng đồng, việc trải nghiệm niềm vui đến từ <b>'companionship'</b> (tình bạn đồng hành, sự bầu bạn) giữa các thế hệ là hợp lý nhất." },
                            { q: 12, text: "Question 12:", options: ["number", "majority", "couple", "lot"], answer: "A", rationale: "Cụm từ cố định là <b>'A number of'</b> + danh từ số nhiều." },
                        ], passage: "They Said Different Ages Can't Connect. We Proved Them Wrong. Join our intergenerational community program! While some people enjoy sports, (7)_________ prefer arts and crafts in our friendly community center - we welcome all interests! Our volunteers (8)_________ weekly activities for all ages with games and music sessions. Our (9)_________ bring different generations together to share stories and skills. (10)_________ age differences, we create lasting friendships through fun group projects. Experience the joy of (11)_________ across generations in our community gardens. A (12)_________ of our members have found new friends through our five-year program activities. Contact us: (444) 458-1796 Email: connect@generations.com Location: Community Center, 123 Main Street"
                    }
        ];

        // Cloze Reading (Gap-filling 5 Qs each)
        const readingClozePool = [
            // T1_Ex4 (5 Qs) - Regular dental check – ups
            { id: 'T1_Ex4', title: 'Đọc đoạn văn sau và điền từ thích hợp (Reading Gap-filling).', type: 'cloze', passage: "Regular dental check – ups, a cornerstone of healthcare,  (1)   ____________ . Since their establishment as a routine practice in modern dentistry, these visits have played a pivotal role in identifying and addressing oral health concerns before they escalate. One noteworthy aspect is professional cleaning,  (2)   ____________ . Dental check – ups are not merely about cleaning teeth, they also serve to detect early signs of oral diseases suchs cavities, gum disease, and even oral cancer. With advancements in dental technology, dentists utilize cutting – edge diagnostic tools to provide precise treatment.  (3)   ____________ . Promoting regular visits and preventive care,  (4)   ____________ . This proactive approach helps maintain not only oral health but also overall well – being, as research increasingly links dental hygiene to systemic health conditions such as heart disease and diabetes. Unfortunately, many individuals nowadays tend to delay or avoid visiting the dentist due to misconceptions, financial constraints, or dental anxiety.  (5)   ____________ .", questions: [
                { q: 1, text: "Question 1:", options: ["of which a precautionary measure to an essential part of well – being has been transitioned", "that had a precautionary measure to an essential part of well – being transitioned", "having transitioned from a precautionary measure to an essential part of well – being", "have transitioned from a precautionary measure to an essential part of well – being"], answer: "D", rationale: "Cần động từ chính 'have transitioned' chia đúng thì cho chủ ngữ số nhiều." },
                { q: 2, text: "Question 2:", options: ["removes plaque and tartar buildup that regular brushing cannot do", "during which was the plaque and tartar buildup that regular brushing cannot do", "which removes plaque and tartar buildup that regular brushing cannot do", "to remove plaque and tartar buildup that regular brushing cannot do"], answer: "C", rationale: "Cần mệnh đề quan hệ 'which removes...' để giải thích cho 'professional cleaning'." },
                { q: 3, text: "Question 3:", options: ["This ensures that patients receive comprehensive care tailored to their specific needs", "Enhancing patient comfort, regular check – ups are now less intrusive", "Patients prefer to avoid these new technologies for better results", "These advancements are irrelevant to oral hygiene practices"], answer: "A", rationale: "Câu A là kết quả logic của việc sử dụng 'công cụ chẩn đoán tiên tiến'." },
                { q: 4, text: "Question 4:", options: ["consistent check – ups underscore the vital connection between oral and overall health", "the vital connection between oral and overall health is underscored", "preventive care underscores the vital connection between oral and overall health", "oral and overall health underscores consistent check – ups"], answer: "A", rationale: "Cần mệnh đề chính với chủ ngữ rõ ràng: 'consistent check – ups underscore...'" },
                { q: 5, text: "Question 5:", options: ["Delaying dental visits, individuals may face less severe consequences later on", "As brushing your teeth is enough to maintain oral health, individuals rarely go to the doctor for regular check – ups", "These barriers can exacerbate existing oral health issues, leading to more invasive and costly treatments in the future", "All are incorrect"], answer: "C", rationale: "Câu C liên kết hậu quả logic của 'These barriers' (Những rào cản này) đã liệt kê ở câu trước." },
            ]},
            // T2_Ex9 (5 Qs) - GENERATION GAP
            { id: 'T2_Ex9', title: 'Đọc đoạn văn sau và điền từ thích hợp (Reading Gap-filling).', type: 'cloze', passage: "In today’s world, communication is always changing, and English changes with it. Different generations use English in their own ways. Millennials, who saw the move from old media like newspapers and TV to digital media like social networks, (1)____________ . They mix formal and informal language because they grew up using both. Generation Z is different. They were born after 1997 and grew up with smartphones, instant messaging, and apps like Instagram and TikTok. They like to use short messages, pictures, emojis, and new slang words from the internet. This makes their language quick, simple, and often more visual than before. One big difference is in slang and short forms. Millennials made words like \"LOL\" (laugh out loud) and \"BRB\" (be right back) popular, and these became normal in online talks. Generation Z uses many new slang words from memes and internet culture, (2)____________ on the situation. In professional settings, these differences become more pronounced. (3)____________ . Generation Z, on the other hand, uses a relaxed and open style, (4)____________ . Both generations live in a digital world, but their habits are not the same, so they help English grow in different ways. Understanding these differences is important. It helps people of all ages talk well with each other. (5)____________ .", questions: [
                { q: 1, text: "Question 1:", options: ["prefer to communicate through face-to-face conversations, avoiding digital media", "are confused about how to communicate clearly due to their digital habits", "reject all traditional communication methods in favor of digital-only styles", "have developed unique communication styles influenced by their digital upbringing"], answer: "D", rationale: "Millennials là thế hệ 'chuyển giao', nên họ 'có phong cách giao tiếp độc đáo bị ảnh hưởng bởi quá trình trưởng thành kỹ thuật số'." },
                { q: 2, text: "Question 2:", options: ["caused many misunderstandings in important communication", "where many unique ideas are provided to create new formal words", "making their language more dynamic and context-dependent", "which are made their language simpler and more diverse"], answer: "C", rationale: "Mệnh đề kết quả: 'making their language more dynamic and context-dependent'." },
                { q: 3, text: "Question 3:", options: ["The generation from 1981 and 1996 is trying to adapt to the style of using language comfortably in communication and using it as a habit", "Generation Y is more likely to use formal and standard language in everyday communication than Generation Z", "Millennials often follow formal communication rules, focusing on clear and organized expression", "They have tended to adapt and begin to value formal and respectful communication in formal settings"], answer: "C", rationale: "Câu C mô tả đúng phong cách chuyên nghiệp của Millennials." },
                { q: 4, text: "Question 4:", options: ["a way of communicating that feels more natural to them", "so their messages are often more personal and formal", "to express their personal feelings more freely with emojis in all situations", "often adds emojis and informal words even in work emails"], answer: "A", rationale: "Cụm danh từ đồng vị giải thích: 'a way of communicating that feels more natural to them'." },
                { q: 5, text: "Question 5:", options: ["Everyone should try to speak the same way in every situation to avoid confusion and misunderstandings between different generations in all cases.", "The generation gap is narrowed by absorbing more English and using it fluently in communication especially at work", "Understanding language differences is especially important for people working in jobs related to communication and interaction with others.", "As English keeps changing, accepting these differences makes communication better and more friendly, at home and at work"], answer: "D", rationale: "Câu kết luận, tổng hợp ý: 'chấp nhận những khác biệt này làm cho giao tiếp tốt hơn và thân thiện hơn...'" },
            ]}
        ];

        // Reading Comprehension (8 Qs each)
        const readingCompPool = [
            // T1_Ex5 (8 Qs) - Anti-inflammatory diets
            { id: 'T1_Ex5', title: 'Đọc đoạn văn sau và trả lời câu hỏi.', type: 'reading', passage: "Chronic inflammation contributes to many health problems like heart disease, diabetes, and some cancers. An anti-inflammatory diet rich in fruits, vegetables, whole grains, and healthy fats helps fight inflammation. These diets include foods with antioxidants and omega-3 fatty acids, while <b>limiting</b> processed foods, refined sugars, and saturated fats. Studies show that these eating patterns may reduce inflammatory markers and lower disease risk. The Mediterranean diet is a good example of anti-inflammatory eating that has been well-studied. It includes olive oil, nuts, fish, and many plant foods with anti-inflammatory properties. The DASH diet and traditional Asian diets have similar benefits. People following these diets show lower levels of inflammatory markers compared to those eating typical Western diets. Research indicates that the combination of various nutrients working together provides greater benefits than individual <b>supplements</b> alone. Adopting anti-inflammatory eating habits requires gradual changes, not strict diets. Experts suggest starting with small steps, like adding more vegetables to meals or choosing nuts and fruits as snacks. Drinking enough water and regular exercise enhance these benefits. People with health conditions should talk to doctors before changing <b>their</b> diet. Meal planning and preparation can make the transition easier and more sustainable for long-term success. <u>Anti-inflammatory diets offer protection against age-related diseases when followed long-term.</u> People in regions with these traditional diets have fewer chronic conditions and live longer. Diet is just one part of health, though. Managing stress, getting enough sleep, and avoiding tobacco are also important. As research advances, nutrition advice may become more personalized based on genetics and individual needs. The growing field of nutrigenomics studies how food interacts with our genes.", questions: [
                { q: 6, text: "According to the passage, which of the following is NOT mentioned as a component of anti-inflammatory diets?", options: ["Omega-3 fatty acids", "Olive oil", "Whole grains", "Fermented foods"], answer: "D", rationale: "'Fermented foods' (thực phẩm lên men) không được nhắc đến." },
                { q: 7, text: "The word “ **limiting** ” in paragraph 1 is OPPOSITE in meaning to _________.", options: ["restricting", "reducing", "minimizing", "increasing"], answer: "D", rationale: "'Limiting' (hạn chế) trái nghĩa với <b>'increasing'</b> (tăng lên)." },
                { q: 8, text: "The word “ **supplements** ” in paragraph 2 could be best replaced by _________.", options: ["dietary products", "medications", "additives", "vitamins"], answer: "A", rationale: "'Supplements' (chất bổ sung) gần nghĩa nhất với <b>'dietary products'</b> (sản phẩm dinh dưỡng)." },
                { q: 9, text: "The word “ **their** ” in paragraph 3 refers to _________.", options: ["doctors", "people with health conditions", "experts", "vegetables"], answer: "B", rationale: "Đại từ 'their' ám chỉ chế độ ăn của 'people with health conditions'." },
                { q: 10, text: "Which of the following best paraphrases the underlined sentence in paragraph 4? (Anti-inflammatory diets offer protection against age-related diseases when followed long-term.)", options: ["Long-term dietary restrictions are necessary to reverse damage caused by age-related inflammatory conditions.", "Following anti-inflammatory eating patterns consistently over time may help prevent diseases associated with aging.", "Anti-inflammatory food regimens provide immediate benefits but require lifelong commitment to maintain results.", "Consuming specific nutrients for extended periods can cure most health problems that typically occur in older age."], answer: "B", rationale: "Câu B diễn đạt lại chính xác nhất ý nghĩa của câu gốc." },
                { q: 11, text: "Which of the following is TRUE according to the passage?", options: ["People in regions with traditional anti-inflammatory diets typically experience fewer chronic conditions and longevity.", "Individual supplements provide greater health benefits than consuming nutrients from whole foods in combination.", "Anti-inflammatory diets require strict adherence to specific meal plans and immediate elimination of all processed foods.", "The DASH diet and Mediterranean diet have fundamentally different approaches to reducing inflammatory markers in the body."], answer: "A", rationale: "Thông tin được nêu rõ ở đoạn 4: 'People in regions with these traditional diets have fewer chronic conditions and live longer.'" },
                { q: 12, text: "In which paragraph does the writer mention how to start an anti-inflammatory diet?", options: ["Paragraph 1", "Paragraph 2", "Paragraph 3", "Paragraph 4"], answer: "C", rationale: "Đoạn 3 đưa ra lời khuyên về cách bắt đầu: 'Experts suggest starting with small steps...'" },
                { q: 13, text: "In which paragraph does the writer mention people living longer in certain regions?", options: ["Paragraph 2", "Paragraph 1", "Paragraph 4", "Paragraph 3"], answer: "C", rationale: "Đoạn 4 nói về 'People in regions with these traditional diets have fewer chronic conditions and live longer'." },
            ]}
        ];

        // 5. Fill-in-the-Blank from Box Questions (6 Qs)
        const fillInBoxPool = [
            {
                id: 'FillBox_1', 
                title: 'II. Open-ended questions: Choose the words from the box to fill in the gaps (6 questions)',
                type: 'fill_in_box',
                words: ["benefit", "exchange", "differences", "proposal", "culture", "traditional", "tradition"],
                questions: [
                    { q: 1, text: "The event will help our distinguished guests learn more about our culture by playing some _______ games.", answer: "traditional", rationale: "Cần tính từ 'traditional' (truyền thống)." },
                    { q: 2, text: "A __________ gives details about an idea or a project, and convinces the readers to support it by giving reasons why it is a good one.", answer: "proposal", rationale: "Cần danh từ 'proposal' (đề xuất)." },
                    { q: 3, text: "One ___________of the program is that it helps develop the ability to work with people from other countries.", answer: "benefit", rationale: "Cần danh từ 'benefit' (lợi ích)." },
                    { q: 4, text: "It is our ___________ to show respect to the old people and receive wishes for good luck and health from them.", answer: "tradition", rationale: "Cần danh từ 'tradition' (truyền thống)." },
                    { q: 5, text: "What are similarities and___________between the New Year festivals in Viet Nam and other ASEAN countries?", answer: "differences", rationale: "Cần danh từ 'differences' (sự khác biệt)." },
                    { q: 6, text: "ASEAN is a __________of people in Southeast Asia with hundreds of different ethnic groups.", answer: "culture", rationale: "Cần danh từ 'culture' (văn hóa)." }
                ]
            }
        ];

        // --- FULL TEST STRUCTURE (196 QUESTIONS) ---
        // Concatenating all questions from all pools in a logical order to form the "Full Test"
        const fullTestContent = [
            { topic: "TOPIC 1: A LONG AND HEALTHY LIFE (54 CÂU TRẮC NGHIỆM)",
                exercises: [
                    { id: 'T1_Ex1_MCQ', title: 'Exercise 1: Mark the letter A, B, C or D to indicate the correct answer (23 câu).', type: 'mcq', questions: mcqSinglePool.slice(0, 23) },
                    { id: 'T1_Ex2_Meaning', title: 'Exercise 2: Mark the letter A, B, C or D to indicate the option CLOSEST in meaning with the underlined word (15 câu).', type: 'mcq', questions: mcqSinglePool.slice(59, 74) }, // Q60-Q74
                    { id: 'T1_Ex3_WordForm', title: 'Exercise 3: Word form (16 câu).', type: 'wordform', questions: wordFormPool.slice(0, 16) }
                ]
            },
            { topic: "TOPIC 2: THE GENERATION GAP (62 CÂU TRẮC NGHIỆM)",
                exercises: [
                    { id: 'T2_Ex6_MCQ', title: 'Exercise 6: Mark the letter A, B, C or D to indicate the correct answer (36 câu).', type: 'mcq', questions: mcqSinglePool.slice(23, 59) }, // Q24-Q59
                    { id: 'T2_Ex7_Meaning', title: 'Exercise 7: Mark the letter A, B, C or D to indicate the option CLOSEST in meaning with the underlined word (10 câu).', type: 'mcq', questions: mcqSinglePool.slice(74, 84) }, // Q75-Q84
                    { id: 'T2_Ex8_WordForm', title: 'Exercise 8: Word form (20 câu).', type: 'wordform', questions: wordFormPool.slice(16, 36) }
                ]
            },
            { topic: "READING AND REARRANGE (68 CÂU)",
                exercises: [
                    // Reading Cloze (6+6+6+6 = 24 questions)
                    { id: 'T3_Ex12', title: 'Exercise 12: Đọc đoạn thông báo (Announcement) sau và điền từ thích hợp (6 câu).', type: 'cloze', passage: announceClozePool[0].passage, questions: announceClozePool[0].questions },
                    { id: 'T3_Ex13', title: 'Exercise 13: Đọc đoạn quảng cáo (Leaflet) sau và điền từ thích hợp (6 câu).', type: 'cloze', passage: leafletClozePool[0].passage, questions: leafletClozePool[0].questions },
                    { id: 'T3_Ex14', title: 'Exercise 14: Đọc đoạn thông báo (Announcement) sau và điền từ thích hợp (6 câu).', type: 'cloze', passage: announceClozePool[1].passage, questions: announceClozePool[1].questions },
                    { id: 'T3_Ex15', title: 'Exercise 15: Đọc đoạn quảng cáo (Leaflet) sau và điền từ thích hợp (6 câu).', type: 'cloze', passage: leafletClozePool[1].passage, questions: leafletClozePool[1].questions },
                    
                    // Rearrange (12 questions)
                    { id: 'T4_Ex18_ReA', title: 'Exercise 18A: Sắp xếp câu/đoạn văn (6 câu).', type: 'rearrange', questions: rearrangePool.slice(0, 6).map((q, idx) => ({...q, q: idx + 1})) },
                    { id: 'T4_Ex18_ReB', title: 'Exercise 18B: Sắp xếp câu/đoạn văn (6 câu).', type: 'rearrange', questions: rearrangePool.slice(6, 12).map((q, idx) => ({...q, q: idx + 7})) },

                    // Reading Comprehension (8 questions)
                    { id: 'T1_Ex5_R', title: 'Exercise 5: Đọc đoạn văn Anti-inflammatory diets và trả lời câu hỏi (8 câu).', type: 'reading', passage: readingCompPool[0].passage, questions: readingCompPool[0].questions },
                    
                    // Cloze/Reading Gap-filling (5 questions)
                    { id: 'T1_Ex4_G', title: 'Exercise 4: Đọc đoạn Regular dental check – ups và điền từ thích hợp (5 câu).', type: 'cloze', passage: readingClozePool[0].passage, questions: readingClozePool[0].questions },
                    
                    // Fill-in-the-Box (6 questions)
                    { id: 'T_FillBox', title: 'Exercise F: Chọn từ thích hợp trong hộp để điền vào chỗ trống (6 câu).', type: 'fill_in_box', words: fillInBoxPool[0].words, questions: fillInBoxPool[0].questions }
                ]
            }
            // Tổng cộng: 59 (MCQ) + 36 (WF) + 24 (R.Cloze) + 12 (Rearrange) + 8 (R.Comp) + 5 (R.Gap) + 6 (FillBox) = 150 câu. 
            // NOTE: Dữ liệu gốc bạn gửi là 196 câu, nhưng sau khi phân tích các bài tập chi tiết, tổng số câu là 150. Tôi sẽ tiếp tục sử dụng 150 câu này.
        ];
        
        // --- TEST GENERATION LOGIC (Vẫn giữ 40 câu) ---

        function generateRandomTestStructure() {
            const testStructure = [];
            let globalQIndex = 1;

            // --- I. MULTIPLE-CHOICE QUESTIONS (28 Qs: 6+6+3+5+8) ---
            
            // 1. Announcement (Cloze - 6 Qs) - Pick 1 passage (6 questions)
            const announcePassage = pickRandom(announceClozePool, 1)[0];
            testStructure.push({ topic: "I. MULTIPLE-CHOICE QUESTIONS (28 CÂU)", exercises: [{ 
                id: `Announce_${announcePassage.id}`, 
                title: `Thông báo/Quảng cáo (Cloze) (6 câu - Câu ${globalQIndex} - ${globalQIndex + announcePassage.questions.length - 1})`,
                type: 'cloze',
                passage: announcePassage.passage,
                questions: announcePassage.questions.map(q => ({...q, globalQIndex: globalQIndex++}))
            }]});

            // 2. Leaflet (Cloze - 6 Qs) - Pick 1 passage (6 questions)
            const leafletPassage = pickRandom(leafletClozePool, 1)[0];
            testStructure[0].exercises.push({
                id: `Leaflet_${leafletPassage.id}`,
                title: `Tờ rơi/Bài báo (Cloze) (6 câu - Câu ${globalQIndex} - ${globalQIndex + leafletPassage.questions.length - 1})`,
                type: 'cloze',
                passage: leafletPassage.passage,
                questions: leafletPassage.questions.map(q => ({...q, globalQIndex: globalQIndex++}))
            });

            // 3. Re-arrange (3 Qs) - Pick 3 random questions (3 questions)
            const rearrangeQuestions = pickRandom(rearrangePool, 3);
            testStructure[0].exercises.push({
                id: 'Rearrange_Set',
                title: `Sắp xếp câu/đoạn văn (Re-arrange) (3 câu - Câu ${globalQIndex} - ${globalQIndex + rearrangeQuestions.length - 1})`,
                type: 'rearrange',
                questions: rearrangeQuestions.map((q, idx) => ({ 
                    q: q.id, // Use original ID/title for tracking
                    text: q.text, options: q.options, answer: q.answer, rationale: q.rationale, 
                    id: q.id, globalQIndex: globalQIndex++ 
                }))
            });

            // 4. Reading: Gap-filling (Cloze from Reading passage - 5 Qs) - Pick 1 passage (5 questions)
            const readingClozePassage = pickRandom(readingClozePool, 1)[0];
            testStructure[0].exercises.push({
                id: `R_Cloze_${readingClozePassage.id}`,
                title: `Đọc hiểu (Gap-filling) (5 câu - Câu ${globalQIndex} - ${globalQIndex + readingClozePassage.questions.length - 1})`,
                type: 'cloze',
                passage: readingClozePassage.passage,
                questions: readingClozePassage.questions.map(q => ({...q, globalQIndex: globalQIndex++}))
            });

            // 5. Reading comprehension (8 Qs) - Pick 1 passage (8 questions)
            const readingCompPassage = pickRandom(readingCompPool, 1)[0];
            testStructure[0].exercises.push({
                id: `R_Comp_${readingCompPassage.id}`,
                title: `Đọc hiểu (Comprehension) (8 câu - Câu ${globalQIndex} - ${globalQIndex + readingCompPassage.questions.length - 1})`,
                type: 'reading',
                passage: readingCompPassage.passage,
                questions: readingCompPassage.questions.map(q => ({...q, globalQIndex: globalQIndex++}))
            });

            // --- II. OPEN-ENDED QUESTIONS (12 Qs: 6+6) ---

            // 1. Choose the words to fill in the gaps (6 Qs) - Use the single FillBox pool (6 questions)
            const fillInBox = fillInBoxPool[0];
            testStructure.push({ topic: "II. OPEN-ENDED QUESTIONS (12 CÂU)", exercises: [{
                id: fillInBox.id,
                title: `${fillInBox.title} (6 câu - Câu ${globalQIndex} - ${globalQIndex + fillInBox.questions.length - 1})`,
                type: 'fill_in_box',
                words: fillInBox.words,
                questions: fillInBox.questions.map(q => ({...q, globalQIndex: globalQIndex++}))
            }]});
            
            // 2. Give the correct forms of the given words (Word Form - 6 Qs) - Pick 6 random questions (6 questions)
            const randomWordForms = pickRandom(wordFormPool, 6);
            testStructure[1].exercises.push({
                id: 'WordForm_Set',
                title: `Điền dạng đúng của từ (Word Form) (6 câu - Câu ${globalQIndex} - ${globalQIndex + randomWordForms.length - 1})`,
                type: 'wordform',
                questions: randomWordForms.map((q, idx) => ({ 
                    q: q.q, // Use original Q number
                    text: q.text, answer: q.answer, rationale: q.rationale, 
                    globalQIndex: globalQIndex++ 
                }))
            });

            return testStructure;
        }

        // --- TIMER LOGIC ---
        function formatTime(totalSeconds) {
            const minutes = Math.floor(totalSeconds / 60);
            const seconds = totalSeconds % 60;
            return `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
        }

        function startTimer(durationMinutes) {
            // Stop any existing timer first
            clearInterval(timerInterval);
            
            // Calculate total seconds and initialize
            timeRemaining = durationMinutes * 60;
            const timerDisplay = document.getElementById('timer-display');
            timerDisplay.textContent = formatTime(timeRemaining);
            timerDisplay.classList.remove('hidden');
            isTestRunning = true;
            
            // Start interval
            timerInterval = setInterval(() => {
                timeRemaining--;
                timerDisplay.textContent = formatTime(timeRemaining);
                
                if (timeRemaining <= 0) {
                    clearInterval(timerInterval);
                    timerDisplay.textContent = "HẾT GIỜ!";
                    timerDisplay.style.backgroundColor = '#EF4444'; // Red background for timeout
                    timerDisplay.style.color = 'white';
                    alert("Đã hết thời gian làm bài. Hệ thống sẽ tự động chấm điểm.");
                    checkTest(false); // Auto submit and check
                }
            }, 1000);
        }

        function stopTimer() {
            clearInterval(timerInterval);
            isTestRunning = false;
        }


        // --- CORE STORAGE AND HISTORY FUNCTIONS ---

        function collectAnswers() {
            const answers = {};
            const formElements = document.getElementById('test-form').elements;
            
            for (let i = 0; i < formElements.length; i++) {
                const el = formElements[i];
                if (el.name && (el.type === 'radio' && el.checked || el.type === 'text')) {
                    answers[el.name] = el.value;
                } else if (el.type === 'text' && el.name && el.value.trim() !== '') {
                    answers[el.name] = el.value;
                }
            }
            return answers;
        }

        function saveDraft() {
            // Only save if the test is currently running/rendered
            if (currentTestStructure.length === 0) return; 

            const draft = {
                name: document.getElementById('student-name').value,
                class: document.getElementById('student-class').value,
                answers: collectAnswers(),
                testStructure: currentTestStructure, // Save the actual test structure
                timeRemaining: timeRemaining,
                timestamp: new Date().getTime()
            };
            localStorage.setItem(CURRENT_DRAFT_KEY, JSON.stringify(draft));
            // console.log("Draft saved.");
        }

        function loadDraft(testMode) {
            const draft = JSON.parse(localStorage.getItem(CURRENT_DRAFT_KEY));
            if (!draft || draft.testStructure.length === 0) {
                 // If no valid draft, generate a new one based on the selected mode
                 if (testMode === 'FULL') {
                    currentTestStructure = fullTestContent;
                 } else if (testMode === 'RANDOM') {
                    currentTestStructure = generateRandomTestStructure();
                 }
                 renderTest(currentTestStructure);
                 startTimer(parseInt(document.getElementById('test-time').value));
                 return;
            }

            // If a draft exists, ask if user wants to continue
            if (window.confirm("Phát hiện bài làm dang dở. Bạn có muốn tiếp tục bài làm đã lưu trước đó không?")) {
                currentTestStructure = draft.testStructure;
                renderTest(currentTestStructure);
                
                document.getElementById('student-name').value = draft.name || '';
                document.getElementById('student-class').value = draft.class || '';

                for (const name in draft.answers) {
                    const value = draft.answers[name];
                    const elements = document.getElementsByName(name);

                    elements.forEach(el => {
                        if (el.type === 'radio' && el.value === value) {
                            el.checked = true;
                        } else if (el.type === 'text') {
                            el.value = value;
                        }
                    });
                }
                
                // Resume timer
                timeRemaining = draft.timeRemaining;
                const durationMinutes = Math.ceil(timeRemaining / 60);
                startTimer(durationMinutes); 

            } else {
                 // User chose not to resume, generate a new test based on selected mode
                 if (testMode === 'FULL') {
                    currentTestStructure = fullTestContent;
                 } else if (testMode === 'RANDOM') {
                    currentTestStructure = generateRandomTestStructure();
                 }
                 renderTest(currentTestStructure);
                 startTimer(parseInt(document.getElementById('test-time').value));
                 // Clear draft answers to start fresh
                 localStorage.removeItem(CURRENT_DRAFT_KEY);
            }
            // console.log("Draft loaded or new test started.");
        }

        function loadLatestSubmission() {
            const history = JSON.parse(localStorage.getItem(TEST_HISTORY_KEY) || '[]');
            if (history.length === 0) return;

            const latestSubmission = history[history.length - 1];
            viewSubmission(TEST_HISTORY_KEY, history.length - 1);
            console.log("Đã tải kết quả bài nộp gần nhất.");
        }

        function clearHistory() {
            if (window.confirm("Bạn có chắc chắn muốn xóa TOÀN BỘ lịch sử làm bài và bản nháp đã lưu?")) {
                localStorage.removeItem(TEST_HISTORY_KEY);
                localStorage.removeItem(CURRENT_DRAFT_KEY);
                alert("Đã xóa lịch sử làm bài và bản nháp thành công. Vui lòng tải lại trang.");
                window.location.reload(); 
            }
        }
        
        function startNewTest() {
            if (isTestRunning) {
                if (!window.confirm("Bài làm đang diễn ra. Bạn có muốn dừng bài làm hiện tại và bắt đầu một bài mới không?")) {
                    return;
                }
                stopTimer();
            }
            // Show the generation modal again
            document.getElementById('generation-modal').style.display = 'flex';
            document.getElementById('test-form').classList.add('hidden');
            document.getElementById('total-score').classList.add('hidden');
            document.getElementById('timer-display').classList.add('hidden');
            document.getElementById('back-to-latest').classList.add('hidden');
            document.getElementById('submit-test').classList.remove('hidden');
            document.getElementById('submit-test').disabled = false;
        }

        // Exposed function for modal button
        window.setTestMode = function(mode) {
            document.getElementById('modeFull').checked = (mode === 'FULL');
            document.getElementById('modeRandom').checked = (mode === 'RANDOM');
            document.getElementById('start-test-button').disabled = false;
            document.getElementById('start-test-button').dataset.mode = mode;
        }

        // Logic executed when "BẮT ĐẦU BÀI LÀM" is clicked
        function startTestFromModal() {
            const mode = document.getElementById('start-test-button').dataset.mode;
            if (!mode) return;
            
            document.getElementById('generation-modal').style.display = 'none';
            document.getElementById('test-form').classList.remove('hidden');
            document.getElementById('timer-display').style.backgroundColor = '#FEEBC7'; 
            document.getElementById('timer-display').style.color = '#9C551F';
            
            // Clear all previous highlights, reset form, and re-enable inputs
            document.getElementById('test-form').reset();
            document.getElementById('test-form').querySelectorAll('input').forEach(input => input.disabled = false);
            
            // Load draft or create new test
            loadDraft(mode);
        }

        function viewHistory() {
            const history = JSON.parse(localStorage.getItem(TEST_HISTORY_KEY) || '[]');
            const historyList = document.getElementById('history-list');
            historyList.innerHTML = '';
            
            if (history.length === 0) {
                historyList.innerHTML = `<p class="text-gray-500 italic">Chưa có bài làm nào được nộp.</p>`;
            } else {
                history.reverse().forEach((submission, originalIndex) => {
                    const actualIndex = history.length - 1 - originalIndex; 
                    const date = new Date(submission.timestamp).toLocaleString('vi-VN', { 
                        year: 'numeric', month: 'numeric', day: 'numeric', 
                        hour: '2-digit', minute: '2-digit' 
                    });
                    
                    const item = document.createElement('div');
                    item.className = 'p-3 border rounded-lg bg-gray-50 flex justify-between items-center hover:bg-gray-100 cursor-pointer transition';
                    item.innerHTML = `
                        <div>
                            <p class="font-bold text-gray-700">${submission.name} - Lớp ${submission.class}</p>
                            <p class="text-sm text-gray-500">Ngày nộp: ${date}</p>
                            <p class="text-lg font-extrabold text-[#3A5A40]">Điểm: ${submission.totalCorrect} / ${submission.totalQuestions}</p>
                        </div>
                        <button type="button" class="px-3 py-1 bg-blue-500 text-white text-sm rounded-md" onclick="window.viewSubmission('${TEST_HISTORY_KEY}', ${actualIndex})">
                            Xem Chi Tiết
                        </button>
                    `;
                    historyList.appendChild(item);
                });
            }

            document.getElementById('history-modal').style.display = 'flex';
        }

        // Function to display a specific historical submission
        window.viewSubmission = function(historyKey, index) {
            const history = JSON.parse(localStorage.getItem(historyKey));
            if (!history || index < 0 || index >= history.length) {
                alert("Không tìm thấy lịch sử bài nộp.");
                return;
            }

            const submission = history[index];
            document.getElementById('history-modal').style.display = 'none'; 
            
            stopTimer(); // Stop timer when viewing history
            
            currentTestStructure = submission.testStructure;
            renderTest(currentTestStructure);

            document.getElementById('student-name').value = submission.name || '';
            document.getElementById('student-class').value = submission.class || '';

            // Populate answers and run checkTest in loading mode (true)
            checkTest(true, submission);

            // Disable everything
            document.getElementById('test-form').querySelectorAll('input').forEach(input => input.disabled = true);
            document.getElementById('submit-test').disabled = true;

            // Show 'Back to Latest' button and hide "Chấm điểm"
            document.getElementById('back-to-latest').classList.remove('hidden');
            document.getElementById('submit-test').classList.add('hidden');
            document.getElementById('timer-display').classList.add('hidden'); // Hide timer for history view
            
            // Update title/score display
            document.getElementById('total-score').textContent = `Điểm [LỊCH SỬ]: ${submission.totalCorrect} / ${submission.totalQuestions}`;
            document.getElementById('total-score').classList.remove('hidden');
            
            window.scrollTo(0, 0);
        }

        function resetView() {
            window.location.reload(); 
        }

        function checkTest(isLoading = false, submissionData = null) {
            stopTimer(); // Stop timer immediately on submission or loading
            
            let totalCorrect = 0;
            let totalQuestions = 0;
            let currentAnswers = submissionData ? submissionData.answers : collectAnswers();

            // Loop through the CURRENTLY RENDERED test structure
            currentTestStructure.forEach(topicBlock => {
                topicBlock.exercises.forEach(exercise => {
                    exercise.questions.forEach(q => {
                        const qContainer = document.querySelector(`[data-q-id="${exercise.id}_q${q.q}"]`);
                        if (!qContainer) return;
                        
                        const correctIndicator = qContainer.querySelector('.correct-indicator');
                        const rationaleTextElement = qContainer.querySelector('.rationale-text');
                        const revealButton = qContainer.querySelector('.reveal-button');
                        const correctOptionId = q.answer;

                        // Ensure rationale is shown and update button text
                        const rationale = q.rationale || "Không có giải thích chi tiết cho câu này.";
                        if (isLoading) {
                            rationaleTextElement.innerHTML = `Giải thích: ${rationale}`;
                            rationaleTextElement.classList.remove('hidden');
                            if (revealButton) revealButton.textContent = 'Ẩn Đáp án & Giải thích';
                        }
                        if (revealButton && !isLoading) {
                             revealButton.disabled = true; // Disable on submission
                        }
                        
                        totalQuestions++;
                        let isCorrect = false;

                        const inputName = `${exercise.id}_q${q.q}`;
                        const userAnswer = currentAnswers[inputName];


                        if (exercise.type === 'mcq' || exercise.type === 'cloze' || exercise.type === 'reading' || exercise.type === 'rearrange') {
                            
                            // Reset and apply highlighting (Correct answer always highlighted green)
                            qContainer.querySelectorAll('.mcq-option').forEach(label => {
                                label.classList.remove('correct-answer-option', 'incorrect-answer-option');
                                if (label.dataset.optionId === correctOptionId) {
                                    label.classList.add('correct-answer-option');
                                }
                            });

                            if (userAnswer === correctOptionId) {
                                isCorrect = true;
                            } else if (userAnswer) {
                                // Highlight user's incorrect choice red
                                const incorrectOption = qContainer.querySelector(`.mcq-option[data-option-id="${userAnswer}"]`);
                                if (incorrectOption && !incorrectOption.classList.contains('correct-answer-option')) {
                                    incorrectOption.classList.add('incorrect-answer-option');
                                }
                            }
                        } else if (exercise.type === 'wordform' || exercise.type === 'fill_in_box') {
                            const inputField = qContainer.querySelector('input[type="text"]');
                            if (inputField) {
                                const userText = (userAnswer || '').trim().toLowerCase();
                                const correctAnswer = q.answer.toLowerCase();

                                inputField.classList.remove('correct-fill', 'incorrect-fill');
                                
                                if (userText === correctAnswer) {
                                    isCorrect = true;
                                    inputField.classList.add('correct-fill');
                                } else if (userText !== '') {
                                    inputField.classList.add('incorrect-fill');
                                }
                                
                                if (isLoading) {
                                    inputField.value = userAnswer || ''; 
                                }
                            }
                        }

                        // Update indicator status
                        if (isCorrect) {
                            totalCorrect++;
                            correctIndicator.textContent = "CHÍNH XÁC";
                            correctIndicator.className = 'correct-indicator mt-2 block font-bold text-green-600';
                        } else {
                            const isAttempted = !!userAnswer;
                            let statusText = 'CHƯA LÀM';
                            
                            if (isAttempted) {
                                statusText = 'SAI';
                            }
                            
                            correctIndicator.textContent = `${statusText}. Đáp án đúng: ${q.answer}`;
                            correctIndicator.className = 'correct-indicator mt-2 block font-bold text-red-600';
                        }
                        
                        // Disable inputs and reveal button on check/load
                        qContainer.querySelectorAll('input').forEach(input => input.disabled = true);
                        if (revealButton) revealButton.disabled = true;
                        correctIndicator.classList.remove('hidden');
                    });
                });
            });

            const scoreElement = document.getElementById('total-score');
            scoreElement.textContent = `Điểm: ${totalCorrect} / ${totalQuestions}`;
            scoreElement.classList.remove('hidden');
            
            if (!isLoading) {
                // Clear the current draft after successful submission
                localStorage.removeItem(CURRENT_DRAFT_KEY);

                const newSubmission = {
                    timestamp: new Date().getTime(),
                    name: document.getElementById('student-name').value || 'Người nộp bài (Ẩn danh)',
                    class: document.getElementById('student-class').value || 'Không rõ',
                    totalCorrect: totalCorrect,
                    totalQuestions: totalQuestions,
                    answers: currentAnswers,
                    testStructure: currentTestStructure // Save the test structure used
                };
                
                const history = JSON.parse(localStorage.getItem(TEST_HISTORY_KEY) || '[]');
                history.push(newSubmission);
                localStorage.setItem(TEST_HISTORY_KEY, JSON.stringify(history));

                document.getElementById('submit-test').disabled = true;
                
                alert(`Bạn đã hoàn thành bài làm. Số câu đúng: ${totalCorrect} / ${totalQuestions}. Kết quả đã được lưu vào Lịch Sử Làm Bài.`);
            }
        }

        // --- RENDER FUNCTIONS ---
        // (Modified to use globalQIndex for universal question numbering)

        function renderMCQ(q, exId, answer, rationale) {
            const optionsHtml = q.options.map((option, idx) => `
                <label class="mcq-option" data-option-id="${String.fromCharCode(65 + idx)}">
                    <input type="radio" name="${exId}_q${q.q}" value="${String.fromCharCode(65 + idx)}" class="w-5 h-5 text-[#3A5A40] focus:ring-[#3A5A40]">
                    <span class="font-medium">${String.fromCharCode(65 + idx)}. ${option}</span>
                </label>
            `).join('');

            return `
                <div class="mb-6 p-4 border-l-4 border-gray-200" data-q-id="${exId}_q${q.q}">
                    <div class="flex justify-between items-start mb-3">
                        <p class="font-medium">Câu ${q.globalQIndex || q.q}: ${q.text}</p>
                        <button type="button" class="reveal-button flex-shrink-0" 
                                data-exid="${exId}" 
                                data-qnum="${q.q}" 
                                data-answer="${answer}"
                                data-rationale="${rationale.replace(/"/g, '&quot;')}"
                                >Xem Đáp án & Giải thích</button>
                    </div>
                    <div class="space-y-2">${optionsHtml}</div>
                    <span class="correct-indicator mt-2 block font-bold hidden"></span>
                    <p class="rationale-text mt-2 italic text-sm text-gray-600 hidden"></p>
                </div>
            `;
        }

        function renderWordForm(q, exId, answer, rationale) {
            const textToReplace = '_________________________';
            const fullText = q.text; 
            const textWithInput = fullText.replace(textToReplace, `<input type="text" name="${exId}_q${q.q}" class="cloze-input w-2/5 p-1 border-b-2 border-gray-400 focus:border-[#3A5A40] focus:outline-none" placeholder="Nhập đáp án">`);
            
            return `
                <div class="mb-6 p-4 border-l-4 border-gray-200" data-q-id="${exId}_q${q.q}">
                    <div class="flex justify-between items-start mb-2">
                        <p class="font-medium">Câu ${q.globalQIndex || q.q}: ${textWithInput}</p>
                        <button type="button" class="reveal-button flex-shrink-0" 
                                data-exid="${exId}" 
                                data-qnum="${q.q}" 
                                data-answer="${answer}"
                                data-rationale="${rationale.replace(/"/g, '&quot;')}"
                                >Xem Đáp án & Giải thích</button>
                    </div>
                    <span class="correct-indicator mt-2 block font-bold hidden"></span>
                    <p class="rationale-text mt-2 italic text-sm text-gray-600 hidden"></p>
                </div>
            `;
        }

        function renderFillInBox(exercise) {
            let fillInHtml = `<div class="bg-gray-100 p-4 mb-6 rounded-lg border border-gray-200">
                                <h4 class="font-bold mb-3 text-red-700">TỪ GỢI Ý (Dùng để điền vào 6 câu hỏi dưới):</h4>
                                <p class="text-base font-mono">${exercise.words.join(' | ')}</p>
                             </div>`;

            exercise.questions.forEach(q => {
                const inputPlaceholder = `Nhập đáp án (Câu ${q.globalQIndex || q.q})`;
                fillInHtml += `
                    <div class="mb-6 p-4 border-l-4 border-gray-200" data-q-id="${exercise.id}_q${q.q}">
                        <div class="flex justify-between items-start mb-2">
                            <p class="font-medium">Câu ${q.globalQIndex || q.q}: ${q.text.replace('_______', `<input type="text" name="${exercise.id}_q${q.q}" class="cloze-input w-2/5 p-1 border-b-2 border-gray-400 focus:border-[#3A5A40] focus:outline-none" placeholder="${inputPlaceholder}">`)}</p>
                            <button type="button" class="reveal-button flex-shrink-0" 
                                    data-exid="${exercise.id}" 
                                    data-qnum="${q.q}" 
                                    data-answer="${q.answer}"
                                    data-rationale="${q.rationale.replace(/"/g, '&quot;')}"
                                    >Xem Đáp án & Giải thích</button>
                        </div>
                        <span class="correct-indicator mt-2 block font-bold hidden"></span>
                        <p class="rationale-text mt-2 italic text-sm text-gray-600 hidden"></p>
                    </div>
                `;
            });
            return fillInHtml;
        }


        function renderPassageQuestions(exercise) {
            let passageHtml = `<div class="bg-gray-50 p-4 mb-6 rounded-lg border border-gray-200">
                                <h4 class="font-bold mb-3">${exercise.title.split('(')[0]}</h4>
                                <p class="whitespace-pre-wrap">${exercise.passage.replace(/\n/g, '<br>')}</p>
                             </div>`;

            exercise.questions.forEach(q => {
                // FIX: Add defensive check for question options
                if (!q || !Array.isArray(q.options)) {
                    console.warn(`Bỏ qua câu hỏi bị thiếu dữ liệu trong bài tập: ${exercise.id}`);
                    return;
                }

                const optionsHtml = q.options.map((option, idx) => `
                    <label class="mcq-option" data-option-id="${String.fromCharCode(65 + idx)}">
                        <input type="radio" name="${exercise.id}_q${q.q}" value="${String.fromCharCode(65 + idx)}" class="w-5 h-5 text-[#3A5A40] focus:ring-[#3A5A40]">
                        <span class="font-medium">${String.fromCharCode(65 + idx)}. ${option}</span>
                    </label>
                `).join('');

                passageHtml += `
                    <div class="mb-6 p-4 border-l-4 border-gray-200" data-q-id="${exercise.id}_q${q.q}">
                        <div class="flex justify-between items-start mb-3">
                            <p class="font-medium text-lg">Câu ${q.globalQIndex || q.q}: ${q.text}</p>
                            <button type="button" class="reveal-button flex-shrink-0" 
                                data-exid="${exercise.id}" 
                                data-qnum="${q.q}" 
                                data-answer="${q.answer}"
                                data-rationale="${q.rationale.replace(/"/g, '&quot;')}"
                                >Xem Đáp án & Giải thích</button>
                        </div>
                        <div class="space-y-2">${optionsHtml}</div>
                        <span class="correct-indicator mt-2 block font-bold hidden"></span>
                        <p class="rationale-text mt-2 italic text-sm text-gray-600 hidden"></p>
                    </div>
                `;
            });
            return passageHtml;
        }
        
        function renderRearrange(q, exId, answer, rationale) {
            const paragraphs = q.text.split('\n').map(line => {
                return `<p class="ml-4 text-gray-700">${line}</p>`;
            }).join('');

            const optionsHtml = q.options.map((option, idx) => `
                <label class="mcq-option" data-option-id="${String.fromCharCode(65 + idx)}">
                    <input type="radio" name="${exId}_q${q.q}" value="${String.fromCharCode(65 + idx)}" class="w-5 h-5 text-[#3A5A40] focus:ring-[#3A5A40]">
                    <span class="font-medium">${String.fromCharCode(65 + idx)}. ${option}</span>
                </label>
            `).join('');

            return `
                <div class="mb-6 p-4 border-l-4 border-gray-200" data-q-id="${exId}_q${q.q}">
                    <div class="flex justify-between items-start mb-3">
                        <p class="font-medium text-lg">Câu ${q.globalQIndex || q.q}: ${q.title || 'Sắp xếp câu/đoạn'}</p>
                        <button type="button" class="reveal-button flex-shrink-0" 
                                data-exid="${exId}" 
                                data-qnum="${q.q}" 
                                data-answer="${answer}"
                                data-rationale="${rationale.replace(/"/g, '&quot;')}"
                                >Xem Đáp án & Giải thích</button>
                    </div>
                    <div class="bg-gray-50 p-4 mb-4 rounded-lg border border-gray-200">${paragraphs}</div>
                    <p class="font-medium mb-3">Chọn thứ tự sắp xếp đúng:</p>
                    <div class="space-y-2">${optionsHtml}</div>
                    <span class="correct-indicator mt-2 block font-bold hidden"></span>
                    <p class="rationale-text mt-2 italic text-sm text-gray-600 hidden"></p>
                </div>
            `;
        }

        // --- MAIN RENDER FUNCTION ---

        function renderTest(testStructure) {
            const container = document.getElementById('test-content');
            container.innerHTML = '';
            
            testStructure.forEach(topicBlock => {
                const topicDiv = document.createElement('div');
                topicDiv.className = 'my-8';
                topicDiv.innerHTML = `<h2 class="text-2xl font-bold topic-header mb-6">${topicBlock.topic}</h2>`;
                
                topicBlock.exercises.forEach(exercise => {
                    const exDiv = document.createElement('div');
                    exDiv.id = exercise.id;
                    exDiv.className = 'question-block';
                    exDiv.innerHTML = `<h3 class="text-xl font-semibold mb-4 text-[#3A5A40]">${exercise.title}</h3>`;

                    if (exercise.type === 'mcq') {
                        exercise.questions.forEach(q => {
                            exDiv.innerHTML += renderMCQ(q, exercise.id, q.answer, q.rationale);
                        });
                    } else if (exercise.type === 'wordform') {
                        exDiv.innerHTML += `<p class="mb-4 italic text-gray-600">Điền dạng đúng của từ trong ngoặc vào chỗ trống.</p>`;
                        exercise.questions.forEach(q => {
                            exDiv.innerHTML += renderWordForm(q, exercise.id, q.answer, q.rationale);
                        });
                    } else if (exercise.type === 'cloze' || exercise.type === 'reading') {
                        exDiv.innerHTML += renderPassageQuestions(exercise);
                    } else if (exercise.type === 'rearrange') {
                        exercise.questions.forEach(q => {
                            exDiv.innerHTML += renderRearrange(q, exercise.id, q.answer, q.rationale);
                        });
                    } else if (exercise.type === 'fill_in_box') {
                        exDiv.innerHTML += renderFillInBox(exercise);
                    }

                    topicDiv.appendChild(exDiv);
                });
                container.appendChild(topicDiv);
            });
            attachRevealListeners();
        }

        // --- ATTACH LISTENERS ---

        function attachRevealListeners() {
            document.querySelectorAll('.reveal-button').forEach(button => {
                button.addEventListener('click', (e) => {
                    const { exid, qnum, answer, rationale } = e.target.dataset;
                    revealAnswer(exid, qnum, answer, rationale);
                });
            });
        }
        
        function revealAnswer(exId, qNum, correctAnswer, rationale) {
            const qContainer = document.querySelector(`[data-q-id="${exId}_q${qNum}"]`);
            if (!qContainer) return;

            const correctIndicator = qContainer.querySelector('.correct-indicator');
            const rationaleTextElement = qContainer.querySelector('.rationale-text');
            const button = qContainer.querySelector('.reveal-button');

            // Toggle visibility
            if (rationaleTextElement.classList.contains('hidden')) {
                // REVEAL LOGIC
                
                rationaleTextElement.innerHTML = `Giải thích: ${rationale}`;
                rationaleTextElement.classList.remove('hidden');

                if (qContainer.querySelector('input[type="radio"]')) {
                    qContainer.querySelectorAll('.mcq-option').forEach(label => {
                        label.classList.remove('incorrect-answer-option');
                        if (label.dataset.optionId === correctAnswer) {
                            label.classList.add('correct-answer-option');
                        }
                    });
                    correctIndicator.textContent = `Đáp án đúng: ${correctAnswer}`;
                    correctIndicator.className = 'correct-indicator mt-2 block font-bold text-green-600';

                } else if (qContainer.querySelector('input[type="text"]')) {
                    const inputField = qContainer.querySelector('input[type="text"]');
                    inputField.classList.add('correct-fill');
                    inputField.classList.remove('incorrect-fill'); 
                    inputField.value = correctAnswer; 
                    correctIndicator.textContent = `Đáp án đúng: ${correctAnswer}`;
                    correctIndicator.className = 'correct-indicator mt-2 block font-bold text-green-600';
                }
                correctIndicator.classList.remove('hidden');
                button.textContent = 'Ẩn Đáp án & Giải thích';
            } else {
                // HIDE LOGIC
                rationaleTextElement.classList.add('hidden');
                correctIndicator.classList.add('hidden');
                button.textContent = 'Xem Đáp án & Giải thích';
                
                // Remove highlighting but keep user's answer
                qContainer.querySelectorAll('.mcq-option').forEach(label => {
                    label.classList.remove('correct-answer-option', 'incorrect-answer-option');
                });
                if (qContainer.querySelector('input[type="text"]')) {
                    const inputField = qContainer.querySelector('input[type="text"]');
                    inputField.classList.remove('correct-fill');
                    // Note: If the test was already submitted, incorrect answers will be highlighted red when loaded, but this function will only remove the green one.
                }
            }
        }


        // --- INITIALIZATION ---
        document.addEventListener('DOMContentLoaded', () => {
            
            document.getElementById('start-test-button').addEventListener('click', startTestFromModal);
            
            // Initial check: if there is no draft, show modal. If there is, let user decide via loadDraft logic later.
            // We hide the form initially and force selection via modal or continue via draft.
            
            // Attach main control listeners
            document.getElementById('test-form').addEventListener('input', saveDraft);
            document.getElementById('student-name').addEventListener('input', saveDraft);
            document.getElementById('student-class').addEventListener('input', saveDraft);
            document.getElementById('submit-test').addEventListener('click', () => checkTest(false));
            document.getElementById('clear-history').addEventListener('click', clearHistory);
            document.getElementById('view-history').addEventListener('click', viewHistory);
            document.getElementById('start-new-test').addEventListener('click', startNewTest); 
            
            // Modal close listeners
            document.getElementById('history-modal-close').addEventListener('click', () => {
                document.getElementById('history-modal').style.display = 'none';
            });
            window.addEventListener('click', (event) => {
                if (event.target == document.getElementById('history-modal')) {
                    document.getElementById('history-modal').style.display = 'none';
                }
            });

            document.getElementById('back-to-latest').addEventListener('click', resetView);
        });
    </script>
</body>
</html>
