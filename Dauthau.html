<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>·ª®ng d·ª•ng Tr·∫Øc nghi·ªám Online</title>
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- TH√äM M·ªöI: Th∆∞ vi·ªán Supabase Client -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <style>
        /* Custom Tailwind Configuration (BIDV Colors) */
        :root {
            --color-bidv-green: #006B68; /* Xanh BIDV */
            --color-bidv-yellow: #FFC62F; /* V√†ng BIDV */
            --color-bidv-green-light: #e0f2f1; /* Light tone */
        }
        
        /* Custom classes based on BIDV colors */
        .bg-bidv-green { background-color: var(--color-bidv-green); }
        .text-bidv-green { color: var(--color-bidv-green); }
        .bg-bidv-yellow { background-color: var(--color-bidv-yellow); }
        .text-bidv-yellow { color: var(--color-bidv-yellow); }
        .border-bidv-green { border-color: var(--color-bidv-green); }
        
        /* Custom styles for better UI */
        body {
            font-family: 'Inter', sans-serif;
        }
        .screen {
            display: none;
        }
        .screen.active {
            display: block;
        }

        /* --- QU·∫¢N L√ù C√ÅC LO·∫†I N·ªÄN --- */
        
        /* 1. N·ªÅn Hoa h·ªìng (M·∫∑c ƒë·ªãnh) - D√πng ·∫£nh */
        .theme-flower {
            background-image: url('https://quantrh.github.io/Quantrh/Dauthau_nen.png');
            background-size: 100% 100%; 
            background-repeat: no-repeat;
            background-position: center;
        }
        @media (max-width: 640px) {
            .theme-flower {
                background-size: cover; 
            }
        }

        /* 2. N·ªÅn Tr·∫Øng */
        .theme-white {
            background-color: #ffffff;
            background-image: none;
            border: 1px solid #e5e7eb; /* Th√™m vi·ªÅn nh·∫π cho d·ªÖ nh√¨n */
        }

        /* 3. N·ªÅn Kem */
        .theme-cream {
            background-color: #fffbeb; /* amber-50 */
            background-image: none;
            border: 1px solid #fef3c7;
        }

        /* --- HI·ªÜU ·ª®NG TRONG SU·ªêT (√Åp d·ª•ng chung) --- */
        .screen-content-wrapper {
            background-color: rgba(255, 255, 255, 0); 
            backdrop-filter: blur(10px); 
            -webkit-backdrop-filter: blur(10px); 
            border-radius: 0.75rem;
            padding: 1.5rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        /* Style for radio buttons */
        .option-label {
            display: block;
            padding: 1rem;
            border: 1px solid #9ca3af; /* Vi·ªÅn ƒë·∫≠m h∆°n (gray-400) */
            border-radius: 0.5rem;
            cursor: pointer;
            transition: all 0.2s ease-in-out;
            background-color: rgba(255, 255, 255, 0.6); /* N·ªÅn ƒë·ª•c h∆°n m·ªôt ch√∫t ƒë·ªÉ d·ªÖ ƒë·ªçc */
            color: #111827; /* Ch·ªØ ƒëen (gray-900) */
            font-weight: 500;
        }
        .option-label:hover {
            background-color: rgba(255, 255, 255, 0.9);
        }
        input[type="radio"]:checked + .option-label {
            background-color: var(--color-bidv-green-light);
            border-color: var(--color-bidv-green);
            color: #004d4a; /* Xanh ƒë·∫≠m */
        }
        .correct-answer {
            background-color: #dcfce7 !important; /* green-100 */
            border-color: #22c55e !important; /* green-500 */
            color: #14532d !important; /* green-900 */
        }
        .wrong-answer {
            background-color: #fee2e2 !important; /* red-100 */
            border-color: #ef4444 !important; /* red-500 */
            color: #7f1d1d !important; /* red-900 */
        }
        
        /* Explanation boxes */
        .explanation-box {
            padding: 1rem;
            border-radius: 0.5rem;
            margin-top: 0.75rem;
        }
        .explanation-title {
            font-weight: 700;
            margin-bottom: 0.5rem;
        }
        .explanation-right {
            background-color: rgba(236, 253, 245, 0.9); 
            border-left: 4px solid #10b981; 
            color: #064e3b;
        }
        .explanation-wrong {
            background-color: rgba(254, 242, 242, 0.9); 
            border-left: 4px solid #ef4444; 
            color: #7f1d1d;
        }
        .explanation-question {
            background-color: rgba(240, 249, 255, 0.9); 
            border-left: 4px solid #3b82f6; 
            color: #1e3a8a;
        }
        
        /* Question Navigation Buttons */
        .q-nav-btn {
            @apply w-10 h-10 flex items-center justify-center rounded-full text-sm font-bold cursor-pointer transition-colors shadow-sm;
        }
        .q-nav-btn.unanswered {
            @apply bg-white text-gray-900 hover:bg-gray-100 border-2 border-gray-300;
        }
        .q-nav-btn.answered {
            background-color: var(--color-bidv-green);
            color: white;
            border: 2px solid var(--color-bidv-green);
            @apply hover:opacity-90;
        }
        .q-nav-btn.active-q {
            background-color: var(--color-bidv-yellow);
            color: #000;
            border: 2px solid #b45309; /* Vi·ªÅn n√¢u cam */
            @apply ring-2 ring-yellow-400/50;
        }
        
        /* Result Navigation Buttons - Styles ri√™ng cho ph·∫ßn k·∫øt qu·∫£ - C·∫¨P NH·∫¨T M√ÄU S·∫ÆC TR·ª∞C TI·∫æP */
        .result-nav-btn {
            @apply w-8 h-8 flex items-center justify-center rounded text-xs font-bold cursor-pointer transition-colors text-white shadow-sm border;
        }
        .res-correct {
            background-color: #16a34a !important; /* Green-600 */
            border-color: #14532d !important; /* Green-900 */
            color: white !important;
        }
        .res-wrong {
            background-color: #dc2626 !important; /* Red-600 */
            border-color: #7f1d1d !important; /* Red-900 */
            color: white !important;
        }
        .res-unanswered {
            background-color: #6b7280 !important; /* Gray-500 */
            border-color: #374151 !important; /* Gray-700 */
            color: white !important;
        }
        
        /* Scroll to top button */
        #scroll-to-top-btn {
            transition: all 0.3s ease-in-out;
            opacity: 0;
            visibility: hidden;
        }
        #scroll-to-top-btn.visible {
            opacity: 1;
            visibility: visible;
        }
        
        /* Modal Backdrop */
        .modal-backdrop {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            z-index: 1000;
            display: none;
            align-items: center;
            justify-content: center;
        }
        .modal-backdrop.active {
            display: flex;
        }
        .modal-content {
            background: rgba(255, 255, 255, 0.98); /* N·ªÅn modal ƒë·ª•c h∆°n ƒë·ªÉ d·ªÖ ƒë·ªçc */
            padding: 2rem;
            border-radius: 0.75rem;
            max-width: 90%;
            max-height: 90%;
            overflow-y: auto;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        }
        
        /* Dropdown Menu Styles */
        #bg-dropdown-menu {
            transition: all 0.2s ease-in-out;
            transform-origin: top right;
        }
        
        /* Quiz screen specific colors overrides */
        #quiz-screen #question-timer {
            color: #dc2626; /* ƒê·ªè ƒë·∫≠m h∆°n */
            font-weight: 800;
            text-shadow: 0 1px 1px rgba(255,255,255,0.8);
        }
        #quiz-screen #submit-btn {
            @apply bg-bidv-green hover:opacity-90;
        }
        
        /* Help content styles */
        .help-content h2 {
            border-bottom: 2px solid var(--color-bidv-yellow);
            padding-bottom: 0.5rem;
            margin-top: 2rem;
        }
        .help-content .feature-card {
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        .help-content .feature-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 15px rgba(0, 107, 104, 0.1);
        }
        /* Search result styling */
        .search-result-item em {
            background-color: #fef08a; /* Yellow highlight */
            font-style: normal;
            font-weight: bold;
        }
        .delete-result-btn:hover {
            background-color: #dc2626; /* red-600 */
        }
    </style>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
</head>
<body class="bg-gray-100 text-gray-900 font-medium">

    <div id="app" class="container mx-auto p-4 md:p-8 max-w-6xl">
        
        <!-- Banner (BIDV Look and Feel) -->
        <div class="mb-6 rounded-xl shadow-lg overflow-hidden">
            <img src="https://quantrh.github.io/Quantrh/Bannerluyenthi.png" alt="Banner Luy·ªán Thi" class="w-full h-auto object-cover">
        </div>

        <!-- Header -->
        <header class="mb-8 flex flex-col md:flex-row justify-between items-center gap-4">
            <h1 class="text-3xl font-bold text-bidv-green drop-shadow-sm bg-white/50 px-2 rounded">Tr·∫Øc nghi·ªám Ph√°p lu·∫≠t ƒê·∫•u th·∫ßu</h1>
            <div class="flex items-center space-x-2 relative">
                <button id="home-btn" class="px-4 py-2 bg-bidv-green text-white rounded-lg shadow hover:opacity-90 transition-colors font-bold">Trang ch·ªß</button>
                <button id="history-btn" class="px-4 py-2 bg-gray-600 text-white rounded-lg shadow hover:bg-gray-700 transition-colors font-bold">L·ªãch s·ª≠</button>
                
                <!-- N√öT M√ÄU N·ªÄN & DROPDOWN -->
                <div class="relative inline-block text-left">
                    <button id="bg-settings-btn" class="px-4 py-2 bg-bidv-yellow text-gray-900 rounded-lg shadow hover:opacity-90 transition-colors flex items-center font-bold">
                        <span>M√†u n·ªÅn</span>
                        <svg class="w-4 h-4 ml-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                    </button>
                    <!-- Dropdown Menu -->
                    <div id="bg-dropdown-menu" class="hidden absolute right-0 mt-2 w-48 bg-white rounded-md shadow-xl z-50 ring-1 ring-black ring-opacity-5 focus:outline-none">
                        <div class="py-1">
                            <button class="bg-option w-full text-left px-4 py-2 text-sm text-gray-800 hover:bg-gray-100 hover:text-bidv-green font-semibold" data-theme="theme-flower">
                                üåπ N·ªÅn Hoa h·ªìng
                            </button>
                            <button class="bg-option w-full text-left px-4 py-2 text-sm text-gray-800 hover:bg-gray-100 hover:text-bidv-green font-semibold" data-theme="theme-white">
                                ‚ö™ N·ªÅn Tr·∫Øng
                            </button>
                            <button class="bg-option w-full text-left px-4 py-2 text-sm text-gray-800 hover:bg-gray-100 hover:text-bidv-green font-semibold" data-theme="theme-cream">
                                üç¶ N·ªÅn Kem
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </header>

        <!-- Main Content -->
        <!-- M·∫∑c ƒë·ªãnh d√πng class theme-flower, s·∫Ω ƒë∆∞·ª£c JS c·∫≠p nh·∫≠t -->
        <main id="main-container" class="theme-flower p-6 rounded-xl shadow-lg min-h-[500px] transition-all duration-300">
            
            <!-- Start Screen -->
            <div id="start-screen" class="screen active">
                <div class="screen-content-wrapper"> <!-- Wrapper n·ªÅn tr·∫Øng m·ªù -->

                    <!-- KH·ªêI TH·ªêNG K√ä TO√ÄN TRANG -->
                    <div id="global-stats-section" class="mb-6 p-4 bg-white/30 rounded-lg shadow-inner backdrop-blur-sm border border-white/40">
                        <h3 class="text-xl font-bold text-bidv-green mb-4 border-b border-bidv-green/30 pb-2">Th·ªëng k√™ To√†n h·ªá th·ªëng</h3>
                        <div id="stats-loading" class="text-center text-gray-800 font-semibold">
                            <svg class="animate-spin h-6 w-6 text-bidv-green mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                            </svg>
                            <p>ƒêang t·∫£i d·ªØ li·ªáu th·ªëng k√™...</p>
                        </div>
                        <div id="stats-content" class="hidden grid grid-cols-2 md:grid-cols-5 gap-4 text-center">
                            <div class="bg-white/40 p-2 rounded">
                                <p class="text-2xl font-bold text-bidv-green" id="stats-total-visits">--</p>
                                <p class="text-sm font-bold text-gray-900">L∆∞·ª£t truy c·∫≠p</p>
                            </div>
                            <div class="bg-white/40 p-2 rounded">
                                <p class="text-2xl font-bold text-bidv-green" id="stats-total-quizzes">--</p>
                                <p class="text-sm font-bold text-gray-900">L∆∞·ª£t b√†i ƒë√£ l√†m</p>
                            </div>
                            <div class="bg-white/40 p-2 rounded">
                                <p class="text-2xl font-bold text-bidv-green" id="stats-avg-score">--</p>
                                <p class="text-sm font-bold text-gray-900">ƒêi·ªÉm b√¨nh qu√¢n</p>
                            </div>
                            <div class="bg-white/40 p-2 rounded">
                                <p class="text-2xl font-bold text-bidv-green" id="stats-avg-questions">--</p>
                                <p class="text-sm font-bold text-gray-900">C√¢u h·ªèi / B√†i</p>
                            </div>
                            <div class="bg-white/40 p-2 rounded">
                                <p class="text-2xl font-bold text-bidv-green" id="stats-avg-time-per-q">--</p>
                                <p class="text-sm font-bold text-gray-900">Gi√¢y / C√¢u</p>
                            </div>
                        </div>
                    </div>

                    <!-- KH·ªêI T√åM KI·∫æM TRA C·ª®U -->
                    <div id="search-section" class="mb-8 p-6 bg-white/30 border-2 border-bidv-yellow/50 rounded-xl shadow-md backdrop-blur-sm">
                        <div class="flex items-center mb-4 border-b border-gray-400 pb-2">
                            <svg class="w-6 h-6 text-bidv-green mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                            </svg>
                            <h3 class="text-xl font-bold text-bidv-green">Tra c·ª©u Ki·∫øn th·ª©c / C√¢u h·ªèi</h3>
                        </div>
                        
                        <div class="relative group">
                            <input type="text" id="search-input" class="w-full px-5 py-4 pl-12 bg-white/70 border border-gray-400 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-bidv-green focus:border-bidv-green focus:bg-white transition-all text-black placeholder-gray-600 font-semibold" placeholder="Nh·∫≠p t·ª´ kh√≥a b·∫•t k·ª≥ ƒë·ªÉ t√¨m ki·∫øm trong c√¢u h·ªèi, ƒë√°p √°n ho·∫∑c gi·∫£i th√≠ch... (V√≠ d·ª•: 'g√≥i th·∫ßu', '45 ng√†y', 'ƒëi·ªÅu 22')">
                            <div class="absolute inset-y-0 left-0 pl-4 flex items-center pointer-events-none">
                                <svg class="h-6 w-6 text-gray-700 group-focus-within:text-bidv-green transition-colors" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                                </svg>
                            </div>
                            <button id="clear-search-btn" class="absolute inset-y-0 right-0 pr-4 flex items-center text-gray-600 hover:text-black hidden">
                                <svg class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                                </svg>
                            </button>
                        </div>
                        <div id="search-status" class="mt-2 text-sm text-gray-900 font-bold italic hidden">ƒêang t√¨m ki·∫øm...</div>
                        <div id="search-results" class="mt-4 space-y-4 max-h-[500px] overflow-y-auto hidden pr-2 custom-scrollbar">
                            <!-- Search results will appear here -->
                        </div>
                    </div>

                    <h2 class="text-2xl font-bold mb-4 text-center text-bidv-green drop-shadow-sm">C·∫•u h√¨nh B√†i thi</h2>
                    <p class="text-center mb-6 text-black font-semibold text-lg">Vui l√≤ng c·∫•u h√¨nh b√†i thi v√† nh·∫•n "B·∫Øt ƒë·∫ßu" ƒë·ªÉ th·ª≠ s·ª©c.</p>
                    
                    <div class="space-y-6">
                        <div>
                            <label for="student-name" class="block text-sm font-bold text-gray-900 mb-1">Nh·∫≠p t√™n c·ªßa b·∫°n:</label>
                            <input type="text" id="student-name" class="w-full px-3 py-2 border border-gray-400 rounded-md shadow-sm focus:outline-none focus:ring-bidv-green focus:border-bidv-green bg-white/70 backdrop-blur-sm text-black placeholder-gray-600 font-semibold" placeholder="V√≠ d·ª•: Tr∆∞∆°ng H·ªìng Qu√¢n">
                        </div>
                    
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label for="num-questions" class="block text-sm font-bold text-gray-900 mb-1">S·ªë c√¢u h·ªèi:</label>
                                <select id="num-questions" class="w-full px-3 py-2 border border-gray-400 rounded-md shadow-sm focus:outline-none focus:ring-bidv-green focus:border-bidv-green bg-white/70 backdrop-blur-sm text-black font-semibold">
                                    <option value="70">70 c√¢u (Ti√™u chu·∫©n)</option>
                                    <option value="1">1 c√¢u</option>
                                    <option value="10">10 c√¢u</option>
                                    <option value="20">20 c√¢u</option>
                                    <option value="30">30 c√¢u</option>
                                    <option value="40">40 c√¢u</option>
                                    <option value="50">50 c√¢u</option>
                                    <option value="100">100 c√¢u</option>
                                    <option value="150">150 c√¢u</option>
                                    <option value="200">200 c√¢u</option>
                                    <option value="250">250 c√¢u</option>
                                    <option value="0">T·∫•t c·∫£</option>
                                </select>
                            </div>
                            <div>
                                <label for="time-per-question" class="block text-sm font-bold text-gray-900 mb-1">Th·ªùi gian m·ªói c√¢u (gi√¢y):</label>
                                <select id="time-per-question" class="w-full px-3 py-2 border border-gray-400 rounded-md shadow-sm focus:outline-none focus:ring-bidv-green focus:border-bidv-green bg-white/70 backdrop-blur-sm text-black font-semibold">
                                    <option value="51">51 gi√¢y (cho 70 c√¢u)</option>
                                    <option value="30">30 gi√¢y</option>
                                    <option value="60">60 gi√¢y</option>
                                    <option value="90">90 gi√¢y</option>
                                    <option value="120">120 gi√¢y</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label for="quiz-order" class="block text-sm font-bold text-gray-900 mb-1">Th·ª© t·ª± c√¢u h·ªèi:</label>
                                <select id="quiz-order" class="w-full px-3 py-2 border border-gray-400 rounded-md shadow-sm focus:outline-none focus:ring-bidv-green focus:border-bidv-green bg-white/70 backdrop-blur-sm text-black font-semibold">
                                    <option value="sequential" selected>Theo th·ª© t·ª± ID (ƒê·ªÉ xem l·∫°i)</option>
                                    <option value="random">Ng·∫´u nhi√™n (ƒê·ªÅ thi th·ª≠)</option>
                                </select>
                                
                                <div id="start-from-container" class="mt-2 bg-white/60 p-2 rounded border border-gray-400">
                                    <label for="start-from-question" class="block text-sm font-bold text-bidv-green mb-1">B·∫Øt ƒë·∫ßu t·ª´ c√¢u s·ªë:</label>
                                    <input type="number" id="start-from-question" min="1" value="1" class="w-full px-3 py-2 border border-gray-400 rounded-md shadow-sm focus:outline-none focus:ring-bidv-green focus:border-bidv-green bg-white/80 text-black font-bold" placeholder="Nh·∫≠p ID c√¢u b·∫Øt ƒë·∫ßu">
                                </div>
                            </div>
                            <div>
                                <label for="timing-mode" class="block text-sm font-bold text-gray-900 mb-1">Ch·∫ø ƒë·ªô t√≠nh gi·ªù:</label>
                                <select id="timing-mode" class="w-full px-3 py-2 border border-gray-400 rounded-md shadow-sm focus:outline-none focus:ring-bidv-green focus:border-bidv-green bg-white/70 backdrop-blur-sm text-black font-semibold">
                                    <option value="no_timer" selected>Kh√¥ng t√≠nh gi·ªù (Tho·∫£i m√°i)</option>
                                    <option value="total">T·ªïng th·ªùi gian (M·∫∑c ƒë·ªãnh)</option>
                                    <option value="per_question">T√≠nh gi·ªù m·ªói c√¢u h·ªèi</option>
                                   </select>
                            </div>
                        </div>
                        
                        <div class="md:grid md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-bold text-gray-900 mb-1">T·ªïng th·ªùi gian l√†m b√†i:</label>
                                <p id="total-quiz-time" class="w-full px-3 py-2 bg-white/70 border border-gray-400 rounded-md shadow-sm font-bold text-black backdrop-blur-sm">
                                    -- ph√∫t
                                </p>
                            </div>
                        </div>

                        <p id="data-status" class="text-sm text-center text-gray-800 font-semibold">ƒêang t·∫£i d·ªØ li·ªáu c√¢u h·ªèi...</p>
                        <button id="start-btn" class="w-full py-3 px-4 bg-bidv-green text-white font-bold text-lg rounded-lg shadow-md hover:opacity-90 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-bidv-green disabled:bg-gray-400 disabled:cursor-not-allowed uppercase tracking-wide">B·∫Øt ƒë·∫ßu l√†m b√†i</button>
                        
                        <div class="mt-8 pt-4 border-t border-gray-300">
                            <button id="toggle-help-btn" class="w-full py-2 px-4 bg-bidv-yellow text-gray-900 font-bold rounded-lg shadow-md hover:opacity-90 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-bidv-yellow">
                                Hi·ªÉn th·ªã H∆∞·ªõng d·∫´n s·ª≠ d·ª•ng
                            </button>
                            <div id="help-content-container" class="mt-4 p-6 border border-gray-300 rounded-xl shadow-inner bg-white/80 help-content backdrop-blur-sm" style="display: none;">
                                <h2 class="text-2xl font-bold text-bidv-green mb-4">I. T√ìM T·∫ÆT T√çNH NƒÇNG N·ªîI TR·ªòI</h2>
                                <p class="mb-6 text-black font-medium">·ª®ng d·ª•ng ƒë∆∞·ª£c thi·∫øt k·∫ø nh·∫±m m√¥ ph·ªèng s√°t nh·∫•t k·ª≥ thi th·ª±c t·∫ø, ƒë·ªìng th·ªùi cung c·∫•p c√°c c√¥ng c·ª• ph√¢n t√≠ch s√¢u s·∫Øc gi√∫p th√≠ sinh d·ªÖ d√†ng √¥n t·∫≠p v√† c·∫£i thi·ªán ki·∫øn th·ª©c m·ªôt c√°ch hi·ªáu qu·∫£.</p>

                                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                                    <div class="feature-card p-5 bg-white/60 border-l-4 border-bidv-green rounded-lg shadow-sm">
                                        <h3 class="text-xl font-bold mb-2 text-bidv-green">1. M√¥ ph·ªèng Thi th·ª±c t·∫ø</h3>
                                        <p class="text-sm text-black">T√πy ch·ªânh s·ªë l∆∞·ª£ng c√¢u h·ªèi, th·ªùi gian v√† ch·∫ø ƒë·ªô t√≠nh gi·ªù.</p>
                                    </div>
                                    <div class="feature-card p-5 bg-white/60 border-l-4 border-bidv-green rounded-lg shadow-sm">
                                        <h3 class="text-xl font-bold mb-2 text-bidv-green">2. Ph√¢n t√≠ch &amp; Gi·∫£i th√≠ch</h3>
                                        <p class="text-sm text-black">Gi·∫£i th√≠ch chuy√™n s√¢u v√† "B√≥c ph·ªët ƒë·ªÅ".</p>
                                    </div>
                                    <div class="feature-card p-5 bg-white/60 border-l-4 border-bidv-green rounded-lg shadow-sm">
                                        <h3 class="text-xl font-bold mb-2 text-bidv-green">3. Th·ªëng k√™ L·ªãch s·ª≠</h3>
                                        <p class="text-sm text-black">L∆∞u l·∫°i l·ªãch s·ª≠ v√† th·ªëng k√™ c√¢u hay sai.</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div> <!-- End screen-content-wrapper -->
            </div>

            <!-- Quiz Screen -->
            <div id="quiz-screen" class="screen">
                <div class="screen-content-wrapper"> <!-- Wrapper n·ªÅn tr·∫Øng m·ªù -->
                    <div class="md:flex md:space-x-6">
                        
                        <div class="md:w-3/4 flex flex-col space-y-6">
                            <div class="flex justify-between items-center p-4 bg-white/60 rounded-lg shadow backdrop-blur-sm border border-gray-300">
                                <div class="text-left">
                                    <span class="text-xs font-bold text-bidv-green uppercase">Th√≠ sinh</span>
                                    <p id="student-name-display" class="text-lg font-bold text-black"></p>
                                </div>
                                <div class="text-right">
                                    <span class="text-xs font-bold text-gray-700 uppercase">T·ªïng th·ªùi gian</span>
                                    <p id="total-timer" class="text-xl font-bold text-bidv-green">00:00</p>
                                </div>
                            </div>

                            <div id="question-card" class="p-6 border border-gray-300 rounded-lg shadow-md bg-white/90 backdrop-blur-sm">
                                <div class="flex justify-between items-center mb-4 border-b border-gray-300 pb-2">
                                    <div class="text-lg font-bold text-black">
                                        C√¢u <span id="current-q-num"></span> / <span id="total-q-num"></span>
                                    </div>
                                    <div class="text-lg font-bold text-right text-gray-800">
                                        C√≤n l·∫°i: <span id="question-timer" class="text-red-600">00</span>s
                                    </div>
                                </div>
                                
                                <div id="question-container" class="mb-6">
                                    <p id="question-text" class="text-xl font-bold mb-4 text-black leading-relaxed"></p>
                                    <div id="options-container" class="space-y-3">
                                        <!-- Options will be generated here -->
                                    </div>
                                </div>
                                
                                <div class="flex justify-between items-center mt-6">
                                    <button id="prev-btn" class="py-2 px-6 bg-white text-gray-900 border-2 border-gray-300 rounded-lg hover:bg-gray-100 font-bold">C√¢u tr∆∞·ªõc</button>
                                    <button id="view-answer-btn" class="py-2 px-6 bg-bidv-yellow text-gray-900 rounded-lg hover:opacity-90 font-bold border-2 border-yellow-500">Xem ƒë√°p √°n</button>
                                    <div>
                                        <button id="next-btn" class="py-2 px-6 bg-bidv-green text-white rounded-lg hover:opacity-90 font-bold">C√¢u ti·∫øp</button>
                                        <button id="submit-btn" class="py-2 px-6 bg-bidv-green text-white rounded-lg hover:opacity-90 font-bold" style="display: none;">N·ªôp b√†i</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="md:w-1/4 mt-6 md:mt-0">
                            <div class="sticky top-0 p-4 bg-white/80 border border-gray-300 rounded-lg shadow-md backdrop-blur-sm">
                                <h3 class="text-lg font-bold mb-3 border-b border-gray-300 pb-2 text-black">Danh s√°ch c√¢u h·ªèi</h3>
                                <div id="question-nav-list" class="grid grid-cols-5 gap-3">
                                    <!-- Question number buttons go here -->
                                </div>
                                <div class="mt-4 pt-2 border-t border-gray-300 text-sm text-gray-900 font-medium">
                                    <p class="flex items-center space-x-2 mb-1"><span class="q-nav-btn w-4 h-4 answered"></span><span>ƒê√£ tr·∫£ l·ªùi</span></p>
                                    <p class="flex items-center space-x-2 mb-1"><span class="q-nav-btn w-4 h-4 unanswered"></span><span>Ch∆∞a tr·∫£ l·ªùi</span></p>
                                    <p class="flex items-center space-x-2"><span class="q-nav-btn w-4 h-4 active-q"></span><span>ƒêang xem</span></p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Result Screen -->
            <div id="result-screen" class="screen">
                <div class="screen-content-wrapper">
                    <h2 class="text-2xl font-bold mb-4 text-center text-bidv-green bg-white/60 py-2 rounded">K·∫øt qu·∫£ b√†i l√†m</h2>
                    <div id="result-summary" class="text-center bg-white/80 p-6 rounded-lg mb-6 backdrop-blur-sm border border-gray-300 shadow-sm">
                        <!-- Summary here -->
                    </div>
                    
                    <div class="flex flex-col md:flex-row md:space-x-6">
                        
                        <!-- C·ªôt b√™n tr√°i: Chi ti·∫øt t·ª´ng c√¢u h·ªèi (Mobile: Hi·ªán sau - Order 2) -->
                        <div class="md:w-3/4 order-2 md:order-1">
                            <h3 class="text-xl font-bold mb-4 text-black bg-white/40 inline-block px-2 rounded">Xem l·∫°i chi ti·∫øt:</h3>
                            <div id="result-details" class="space-y-6">
                                <!-- Detailed results here -->
                            </div>
                        </div>

                        <!-- C·ªôt b√™n ph·∫£i: B·∫£ng ƒëi·ªÅu h∆∞·ªõng c√¢u h·ªèi k·∫øt qu·∫£ (Mobile: Hi·ªán tr∆∞·ªõc - Order 1) -->
                        <div class="md:w-1/4 order-1 md:order-2 mb-6 md:mb-0">
                            <div class="sticky top-0 p-4 bg-white/80 border border-gray-300 rounded-lg shadow-md backdrop-blur-sm">
                                <h3 class="text-lg font-bold mb-3 border-b border-gray-300 pb-2 text-black">M·ª•c l·ª•c c√¢u h·ªèi</h3>
                                <div id="result-nav-list" class="grid grid-cols-5 gap-2">
                                    <!-- Result nav buttons go here -->
                                </div>
                                <!-- CH√ö TH√çCH M·ªöI -->
                                <div class="mt-4 pt-2 border-t border-gray-300 text-xs text-black font-bold space-y-2">
                                    <p class="flex items-center space-x-2"><span class="result-nav-btn w-4 h-4 res-correct text-[8px] flex items-center justify-center">‚úì</span><span>ƒê√∫ng (Xanh)</span></p>
                                    <p class="flex items-center space-x-2"><span class="result-nav-btn w-4 h-4 res-wrong text-[8px] flex items-center justify-center">‚úï</span><span>Sai (ƒê·ªè)</span></p>
                                    <p class="flex items-center space-x-2"><span class="result-nav-btn w-4 h-4 res-unanswered text-[8px] flex items-center justify-center">-</span><span>Ch∆∞a l√†m (X√°m)</span></p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="text-center mt-8">
                        <button id="back-to-home-btn" class="py-3 px-6 bg-bidv-green text-white font-bold rounded-lg shadow-md hover:opacity-90 text-lg">L√†m b√†i thi m·ªõi</button>
                    </div>
                </div>
            </div>

            <!-- History Screen -->
            <div id="history-screen" class="screen">
                <div class="screen-content-wrapper">
                    <h2 class="text-2xl font-bold mb-4 text-bidv-green bg-white/50 inline-block px-2 rounded">L·ªãch s·ª≠ l√†m b√†i</h2>
                    
                    <div class="text-right mb-4">
                        <button id="clear-history-btn" class="py-2 px-4 bg-red-600 text-white font-bold rounded-lg shadow-md hover:bg-red-700 transition-colors">X√≥a t·∫•t c·∫£ l·ªãch s·ª≠ thi</button>
                    </div>
                    
                    <div id="history-stats" class="mb-6">
                        <h3 class="text-xl font-bold mb-2 text-black bg-white/40 inline-block px-2 rounded">Th·ªëng k√™ c√°c c√¢u hay sai</h3>
                        <p class="text-sm text-gray-900 font-semibold mb-2 italic">D·ªØ li·ªáu ƒë∆∞·ª£c t·ªïng h·ª£p t·ª´ c√°c l·∫ßn thi hi·ªán c√≥ trong l·ªãch s·ª≠.</p>
                        <div id="missed-questions-stats" class="text-black font-medium p-4 bg-white/60 rounded border border-gray-300 backdrop-blur-sm">Ch∆∞a c√≥ d·ªØ li·ªáu.</div>
                    </div>
                    <div id="history-list" class="space-y-4">
                        <p>Ch∆∞a c√≥ l·ªãch s·ª≠ l√†m b√†i.</p>
                    </div>
                </div>
            </div>
            
            <!-- Modal for Review/Explanation -->
            <div id="review-modal-backdrop" class="modal-backdrop">
                <div id="review-modal" class="modal-content md:max-w-3xl">
                    <div id="modal-content-placeholder">
                        <!-- Content will be inserted here -->
                    </div>
                </div>
            </div>

        </main>
        
        <!-- Footer -->
        <footer class="mt-8 text-center text-gray-900 font-bold text-sm bg-white/40 py-2 rounded">
            <p>B·∫£n quy·ªÅn thu·ªôc v·ªÅ: Tr∆∞∆°ng H·ªìng Qu√¢n</p>
            <p>Email: <a href="mailto:Quantrhvn@gmail.com" class="text-bidv-green hover:underline">Quantrhvn@gmail.com</a></p>
        </footer>
    </div>

    <!-- N√öT SCROLL TO TOP -->
    <button id="scroll-to-top-btn" class="fixed bottom-8 right-8 p-3 bg-bidv-green text-white rounded-full shadow-lg hover:bg-teal-700 focus:outline-none z-50">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 10l7-7m0 0l7 7m-7-7v18" />
        </svg>
    </button>

<script>
document.addEventListener('DOMContentLoaded', () => {
    
    // --- C·∫§U H√åNH SUPABASE ---
    const SUPABASE_URL = 'https://rmbsxccrwrktbjlnezpu.supabase.co'; 
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJtYnN4Y2Nyd3JrdGJqbG5lenB1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDg2MjczNjQsImV4cCI6MjA2NDIwMzM2NH0.ydCqificftdtn1niRciFCifeuo8aX6SDGti-hCY5Z_Y';
    
    let supabaseClient = null;
    try {
        if (SUPABASE_URL !== 'YOUR_SUPABASE_URL' && SUPABASE_KEY !== 'YOUR_SUPABASE_ANON_KEY') {
            supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
        } else {
            console.warn('Supabase ch∆∞a ƒë∆∞·ª£c c·∫•u h√¨nh.');
        }
    } catch (error) {
        console.error('L·ªói kh·ªüi t·∫°o Supabase:', error);
    }

    const quizApp = {
        // DOM Elements
        screens: {
            start: document.getElementById('start-screen'),
            quiz: document.getElementById('quiz-screen'),
            result: document.getElementById('result-screen'),
            history: document.getElementById('history-screen'),
        },
        buttons: {
            home: document.getElementById('home-btn'),
            history: document.getElementById('history-btn'),
            start: document.getElementById('start-btn'),
            prev: document.getElementById('prev-btn'),
            next: document.getElementById('next-btn'),
            submit: document.getElementById('submit-btn'),
            viewAnswer: document.getElementById('view-answer-btn'),
            backToHome: document.getElementById('back-to-home-btn'),
            clearHistory: document.getElementById('clear-history-btn'),
            toggleHelp: document.getElementById('toggle-help-btn'),
            clearSearch: document.getElementById('clear-search-btn'),
            bgSettings: document.getElementById('bg-settings-btn'),
            // N√∫t Scroll Top
            scrollToTop: document.getElementById('scroll-to-top-btn'),
        },
        inputs: {
            studentName: document.getElementById('student-name'),
            numQuestions: document.getElementById('num-questions'),
            timePerQuestion: document.getElementById('time-per-question'),
            quizOrder: document.getElementById('quiz-order'),
            startFromQuestion: document.getElementById('start-from-question'),
            timingMode: document.getElementById('timing-mode'), 
            searchInput: document.getElementById('search-input'),
        },
        displays: {
            dataStatus: document.getElementById('data-status'),
            currentQNum: document.getElementById('current-q-num'),
            totalQNum: document.getElementById('total-q-num'),
            totalTimer: document.getElementById('total-timer'),
            questionTimer: document.getElementById('question-timer'),
            questionText: document.getElementById('question-text'),
            optionsContainer: document.getElementById('options-container'),
            resultSummary: document.getElementById('result-summary'),
            resultDetails: document.getElementById('result-details'),
            historyList: document.getElementById('history-list'),
            missedQuestionsStats: document.getElementById('missed-questions-stats'),
            totalQuizTime: document.getElementById('total-quiz-time'),
            questionNavList: document.getElementById('question-nav-list'),
            resultNavList: document.getElementById('result-nav-list'),
            studentNameDisplay: document.getElementById('student-name-display'),
            reviewModalBackdrop: document.getElementById('review-modal-backdrop'),
            modalContentPlaceholder: document.getElementById('modal-content-placeholder'),
            helpContentContainer: document.getElementById('help-content-container'),
            mainContainer: document.getElementById('main-container'),
            bgDropdown: document.getElementById('bg-dropdown-menu'),
            
            // Th·ªëng k√™
            statsLoading: document.getElementById('stats-loading'),
            statsContent: document.getElementById('stats-content'),
            statsTotalVisits: document.getElementById('stats-total-visits'),
            statsTotalQuizzes: document.getElementById('stats-total-quizzes'),
            statsAvgScore: document.getElementById('stats-avg-score'),
            statsAvgQuestions: document.getElementById('stats-avg-questions'),
            statsAvgTimePerQ: document.getElementById('stats-avg-time-per-q'),

            // Search
            searchResults: document.getElementById('search-results'),
            searchStatus: document.getElementById('search-status'),
        },

        // State
        allQuestions: [],
        quizQuestions: [],
        userAnswers: [],
        currentQuestionIndex: 0,
        timePerQuestion: 60,
        timingMode: 'total',
        visitorIP: null,
        searchDebounceTimer: null,
        currentTheme: 'theme-flower', 
        timers: {
            total: null,
            question: null,
            totalSeconds: 0,
            questionSeconds: 0,
            remainingTotalSeconds: 0,
        },
        
        init() {
            this.loadTheme(); 
            this.addEventListeners();
            this.loadQuestions();
            this.showScreen('start');
            this.calculateTotalTime();
            this.initializeTracking();
            this.loadGlobalStats();
        },

        // --- BACKGROUND THEME LOGIC ---
        loadTheme() {
            const savedTheme = localStorage.getItem('quizTheme') || 'theme-flower';
            this.setTheme(savedTheme);
        },

        setTheme(themeName) {
            this.displays.mainContainer.classList.remove('theme-flower', 'theme-white', 'theme-cream');
            this.displays.mainContainer.classList.add(themeName);
            this.currentTheme = themeName;
            localStorage.setItem('quizTheme', themeName);
        },

        // --- Tracking ---
        async initializeTracking() {
            await this.getVisitorIP();
            await this.logPageVisit();
        },

        async getVisitorIP() {
            try {
                const response = await fetch('https://api.ipify.org?format=json');
                if (!response.ok) throw new Error('Kh√¥ng th·ªÉ l·∫•y IP');
                const data = await response.json();
                this.visitorIP = data.ip;
            } catch (error) {
                console.error('L·ªói khi l·∫•y IP:', error);
                this.visitorIP = 'unknown';
            }
        },

        async logPageVisit() {
            if (!supabaseClient) return;
            try {
                const { error } = await supabaseClient
                    .from('page_visits')
                    .insert({ ip_address: this.visitorIP });
                if (error) throw error;
            } catch (error) {
                console.error('L·ªói ghi nh·∫≠n l∆∞·ª£t truy c·∫≠p:', error.message);
            }
        },
        
        async loadGlobalStats() {
            if (!supabaseClient) {
                this.displays.statsLoading.innerHTML = '';
                return;
            }

            try {
                const { data, error } = await supabaseClient.rpc('get_global_stats');
                
                if (error) throw error;
                
                if (data && data.length > 0) {
                    const stats = data[0];
                    const totalVisits = stats.total_visits || 0;
                    const totalQuizzes = stats.total_quizzes || 0;
                    const avgScore = stats.avg_score || 0;
                    const totalTime = stats.total_time_all_quizzes || 0;
                    const totalQuestions = stats.total_questions_all_quizzes || 0;
                    const avgQuestionsPerQuiz = (totalQuizzes > 0) ? (totalQuestions / totalQuizzes) : 0;
                    const avgTimePerQuestion = (totalQuestions > 0) ? (totalTime / totalQuestions) : 0;

                    this.displays.statsTotalVisits.textContent = totalVisits;
                    this.displays.statsTotalQuizzes.textContent = totalQuizzes;
                    this.displays.statsAvgScore.textContent = avgScore.toFixed(1);
                    this.displays.statsAvgQuestions.textContent = avgQuestionsPerQuiz.toFixed(1);
                    this.displays.statsAvgTimePerQ.textContent = avgTimePerQuestion.toFixed(1);

                    this.displays.statsLoading.style.display = 'none';
                    this.displays.statsContent.classList.remove('hidden');
                }
            } catch (error) {
                console.error('L·ªói t·∫£i th·ªëng k√™:', error.message);
                this.displays.statsLoading.innerHTML = `<p class="text-red-500 text-xs">Kh√¥ng t·∫£i ƒë∆∞·ª£c th·ªëng k√™.</p>`;
            }
        },
        
        async logQuizResult(result, config) {
            if (!supabaseClient) return;

            const payload = {
                student_name: result.name,
                score: result.score,
                total_questions: result.totalQuestions,
                time_taken_seconds: result.timeTaken,
                quiz_date: result.date,
                ip_address: this.visitorIP,
                config_num_questions: config.numQuestions,
                config_time_per_question: config.timePerQuestion,
                config_quiz_order: config.quizOrder,
                config_timing_mode: config.timingMode
            };

            try {
                const { error } = await supabaseClient.from('quiz_results').insert(payload);
                if (error) throw error;
            } catch (error) {
                console.error('L·ªói l∆∞u k·∫øt qu·∫£ thi:', error.message);
            }
        },
        
        // --- SEARCH ---
        handleSearch(query) {
            const resultsContainer = this.displays.searchResults;
            const statusContainer = this.displays.searchStatus;
            const clearBtn = this.buttons.clearSearch;
            
            if(query.length > 0) {
                clearBtn.classList.remove('hidden');
            } else {
                clearBtn.classList.add('hidden');
            }

            const cleanQuery = query.trim().toLowerCase();

            if (cleanQuery.length < 2) {
                resultsContainer.innerHTML = '';
                resultsContainer.classList.add('hidden');
                statusContainer.classList.add('hidden');
                return;
            }
            
            statusContainer.textContent = "ƒêang t√¨m ki·∫øm...";
            statusContainer.classList.remove('hidden');

            setTimeout(() => {
                const results = this.allQuestions.filter(q => {
                    const textToSearch = [
                        q.question,
                        q.options?.A, q.options?.B, q.options?.C, q.options?.D,
                        q.explanation_right,
                        q.explanation_wrong,
                        q.explanation_question
                    ].join(' ').toLowerCase();
                    
                    return textToSearch.includes(cleanQuery);
                }).slice(0, 20);

                statusContainer.classList.add('hidden');
                resultsContainer.innerHTML = '';

                if (results.length === 0) {
                    resultsContainer.innerHTML = '<p class="text-center text-gray-800 font-semibold py-4">Kh√¥ng t√¨m th·∫•y k·∫øt qu·∫£ n√†o ph√π h·ª£p.</p>';
                    resultsContainer.classList.remove('hidden');
                    return;
                }

                results.forEach(q => {
                    const card = document.createElement('div');
                    card.className = 'search-result-item bg-white/80 p-4 rounded-lg border border-gray-400 hover:shadow-md transition-all text-black';
                    
                    const highlight = (text) => {
                        if (!text) return '';
                        const escapedQuery = cleanQuery.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
                        const regex = new RegExp(`(${escapedQuery})`, 'gi');
                        return text.replace(regex, '<em>$1</em>');
                    };

                    let optionsHtml = '';
                    ['A', 'B', 'C', 'D'].forEach(key => {
                        if (q.options[key]) {
                            let classList = 'p-2 rounded mt-1 text-sm border border-transparent';
                            if (key === q.answer) {
                                classList += ' bg-green-100 border-green-300 text-green-900 font-bold';
                            } else {
                                classList += ' bg-white/60 border-gray-300 text-gray-800';
                            }
                            optionsHtml += `<div class="${classList}">${key}. ${highlight(q.options[key])}</div>`;
                        }
                    });

                    let explanationHtml = '';
                    if (q.explanation_right) {
                        explanationHtml += `<div class="mt-2 text-xs text-green-900 bg-green-100 p-2 rounded border-l-4 border-green-600"><strong>Gi·∫£i th√≠ch ƒë√∫ng:</strong> ${highlight(q.explanation_right)}</div>`;
                    }
                    if (q.explanation_wrong) {
                         explanationHtml += `<div class="mt-2 text-xs text-red-900 bg-red-100 p-2 rounded border-l-4 border-red-600"><strong>Gi·∫£i th√≠ch sai:</strong> ${highlight(q.explanation_wrong)}</div>`;
                    }
                     if (q.explanation_question) {
                         explanationHtml += `<div class="mt-2 text-xs text-blue-900 bg-blue-100 p-2 rounded border-l-4 border-blue-600"><strong>Ph√¢n t√≠ch ƒë·ªÅ:</strong> ${highlight(q.explanation_question)}</div>`;
                    }

                    card.innerHTML = `
                        <p class="font-bold text-gray-900 mb-2">C√¢u h·ªèi ${q.id}: ${highlight(q.question)}</p>
                        <div class="space-y-1 mb-2">${optionsHtml}</div>
                        ${explanationHtml}
                    `;
                    resultsContainer.appendChild(card);
                });
                
                resultsContainer.classList.remove('hidden');
            }, 100);
        },

        addEventListeners() {
            this.buttons.home.addEventListener('click', () => this.showScreen('start'));
            this.buttons.history.addEventListener('click', () => this.showHistory());
            this.buttons.start.addEventListener('click', () => this.startQuiz());
            this.buttons.next.addEventListener('click', () => this.navigateQuestion(1));
            this.buttons.prev.addEventListener('click', () => this.navigateQuestion(-1));
            this.buttons.submit.addEventListener('click', () => this.confirmSubmit());
            this.buttons.viewAnswer.addEventListener('click', () => this.showCurrentAnswer());
            this.buttons.backToHome.addEventListener('click', () => this.showScreen('start'));
            this.buttons.clearHistory.addEventListener('click', () => this.clearHistory());
            
            this.buttons.toggleHelp.addEventListener('click', () => this.toggleHelpContent());
            
            this.inputs.numQuestions.addEventListener('change', () => this.calculateTotalTime());
            this.inputs.timePerQuestion.addEventListener('change', () => this.calculateTotalTime());
            this.inputs.timingMode.addEventListener('change', () => this.calculateTotalTime());
            
            this.inputs.quizOrder.addEventListener('change', (e) => {
                const container = document.getElementById('start-from-container');
                if (e.target.value === 'sequential') {
                    container.classList.remove('hidden');
                } else {
                    container.classList.add('hidden');
                }
            });

            this.displays.reviewModalBackdrop.addEventListener('click', (e) => {
                if (e.target === this.displays.reviewModalBackdrop) {
                    this.closeModal();
                }
            });

            this.inputs.searchInput.addEventListener('input', (e) => {
                clearTimeout(this.searchDebounceTimer);
                this.searchDebounceTimer = setTimeout(() => {
                    this.handleSearch(e.target.value);
                }, 400);
            });

            this.buttons.clearSearch.addEventListener('click', () => {
                this.inputs.searchInput.value = '';
                this.handleSearch('');
                this.inputs.searchInput.focus();
            });

            this.buttons.bgSettings.addEventListener('click', (e) => {
                e.stopPropagation(); 
                this.displays.bgDropdown.classList.toggle('hidden');
            });

            document.addEventListener('click', (e) => {
                if (!this.buttons.bgSettings.contains(e.target) && !this.displays.bgDropdown.contains(e.target)) {
                    this.displays.bgDropdown.classList.add('hidden');
                }
            });

            const bgOptions = document.querySelectorAll('.bg-option');
            bgOptions.forEach(option => {
                option.addEventListener('click', (e) => {
                    const theme = e.currentTarget.getAttribute('data-theme');
                    this.setTheme(theme);
                    this.displays.bgDropdown.classList.add('hidden');
                });
            });

            // --- Scroll to Top Logic ---
            this.buttons.scrollToTop.addEventListener('click', () => {
                window.scrollTo({ top: 0, behavior: 'smooth' });
            });

            window.addEventListener('scroll', () => {
                if (window.pageYOffset > 300) {
                    this.buttons.scrollToTop.classList.add('visible');
                } else {
                    this.buttons.scrollToTop.classList.remove('visible');
                }
            });
        },
        
        toggleHelpContent() {
            const container = this.displays.helpContentContainer;
            const button = this.buttons.toggleHelp;
            if (container.style.display === 'none') {
                container.style.display = 'block';
                button.textContent = '·∫®n H∆∞·ªõng d·∫´n s·ª≠ d·ª•ng';
            } else {
                container.style.display = 'none';
                button.textContent = 'Hi·ªÉn th·ªã H∆∞·ªõng d·∫´n s·ª≠ d·ª•ng';
            }
        },

        calculateTotalTime() {
            const timingMode = this.inputs.timingMode.value;

            if (timingMode === 'no_timer') {
                this.displays.totalQuizTime.textContent = 'Kh√¥ng gi·ªõi h·∫°n';
                return;
            }

            let numQuestions = parseInt(this.inputs.numQuestions.value);
            const timePerQuestion = parseInt(this.inputs.timePerQuestion.value);

            if (numQuestions === 0) {
                numQuestions = this.allQuestions.length;
            }

            if (numQuestions > 0 && !isNaN(timePerQuestion)) {
                const totalSeconds = numQuestions * timePerQuestion;
                const totalMinutes = Math.ceil(totalSeconds / 60);
                this.displays.totalQuizTime.textContent = `${totalMinutes} ph√∫t`;
            } else {
                 this.displays.totalQuizTime.textContent = `-- ph√∫t`;
            }
        },

        showScreen(screenId) {
            Object.values(this.screens).forEach(screen => screen.classList.remove('active'));
            if (this.screens[screenId]) {
                this.screens[screenId].classList.add('active');
            }
            // Scroll to top when switching screens
            window.scrollTo(0, 0);
        },

        async loadQuestions() {
            try {
                const uniqueParam = new Date().getTime();
                const response = await fetch(`./Dauthaujson.json?v=${uniqueParam}`);
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const data = await response.json();
                
                this.allQuestions = data.filter(q => q.question && q.answer);
                
                if (this.allQuestions.length > 0) {
                    this.displays.dataStatus.textContent = `S·∫µn s√†ng! T·∫£i th√†nh c√¥ng ${this.allQuestions.length} c√¢u h·ªèi.`;
                    this.calculateTotalTime(); 
                } else {
                    throw new Error("T·ªáp JSON kh√¥ng ch·ª©a c√¢u h·ªèi h·ª£p l·ªá.");
                }

            } catch (error) {
                console.error("L·ªói t·∫£i t·ªáp JSON c√¢u h·ªèi:", error);
                this.displays.dataStatus.innerHTML = '<span class="text-red-500 font-bold text-lg">L·ªñI: Kh√¥ng t·∫£i ƒë∆∞·ª£c t·ªáp <code>./Dauthaujson.json</code>.<br>H√£y ƒë·∫£m b·∫£o t·ªáp JSON n·∫±m C√ôNG TH∆Ø M·ª§C v·ªõi t·ªáp HTML tr√™n GitHub.</span>';
                this.allQuestions = [];
            }
        },

        startQuiz() {
            if (this.allQuestions.length === 0) {
                alert('D·ªØ li·ªáu c√¢u h·ªèi ch∆∞a s·∫µn s√†ng. Vui l√≤ng ki·ªÉm tra l·ªói ·ªü m·ª•c "data-status".');
                return;
            }
            
            if (this.inputs.studentName.value.trim() === '') {
                alert('Vui l√≤ng nh·∫≠p t√™n c·ªßa b·∫°n.'); 
                return;
            }
            
            this.timingMode = this.inputs.timingMode.value;

            let selectedQuestions = [...this.allQuestions];
            const order = this.inputs.quizOrder.value;
            
            if (order === 'sequential') {
                selectedQuestions.sort((a, b) => {
                    const idA = parseInt(a.id);
                    const idB = parseInt(b.id);
                    if (!isNaN(idA) && !isNaN(idB)) {
                        return idA - idB;
                    }
                    return 0; 
                });

                const startFromVal = parseInt(this.inputs.startFromQuestion.value);
                if (!isNaN(startFromVal) && startFromVal > 1) {
                    const startIndex = startFromVal - 1;
                    if (startIndex < selectedQuestions.length) {
                        selectedQuestions = selectedQuestions.slice(startIndex);
                    } else {
                        alert(`S·ªë c√¢u b·∫Øt ƒë·∫ßu (${startFromVal}) l·ªõn h∆°n t·ªïng s·ªë c√¢u h·ªèi hi·ªán c√≥ (${selectedQuestions.length})! S·∫Ω b·∫Øt ƒë·∫ßu t·ª´ c√¢u ƒë·∫ßu ti√™n.`);
                    }
                }
            } else {
                selectedQuestions.sort(() => 0.5 - Math.random());
            }

            const num = parseInt(this.inputs.numQuestions.value);
            if (num > 0 && num < selectedQuestions.length) {
                this.quizQuestions = selectedQuestions.slice(0, num);
            } else {
                this.quizQuestions = selectedQuestions;
            }

            this.timePerQuestion = parseInt(this.inputs.timePerQuestion.value);
            this.timers.remainingTotalSeconds = this.quizQuestions.length * this.timePerQuestion;

            this.userAnswers = new Array(this.quizQuestions.length).fill(null);
            this.currentQuestionIndex = 0;
            
            this.displays.totalQNum.textContent = this.quizQuestions.length;
            this.displays.studentNameDisplay.textContent = this.inputs.studentName.value.trim();
            
            this.startTimers();
            this.displayQuestion();
            this.renderQuestionNav();
            this.showScreen('quiz');
        },

        renderQuestionNav() {
            this.displays.questionNavList.innerHTML = '';
            this.quizQuestions.forEach((q, index) => {
                const btn = document.createElement('button');
                btn.className = 'q-nav-btn';
                btn.textContent = index + 1;
                btn.setAttribute('data-index', index);

                btn.addEventListener('click', () => {
                    this.saveAnswer(); 
                    if (confirm('B·∫°n c√≥ mu·ªën xem ƒë√°p √°n v√† gi·∫£i th√≠ch cho c√¢u h·ªèi n√†y kh√¥ng?')) {
                         this.showExplanationModal(index);
                    } else {
                         this.jumpToQuestion(index);
                    }
                });
                this.displays.questionNavList.appendChild(btn);
            });
            this.updateQuestionNav();
        },
        
        updateQuestionNav() {
            const navButtons = this.displays.questionNavList.querySelectorAll('.q-nav-btn');
            navButtons.forEach((btn, index) => {
                btn.classList.remove('active-q', 'answered', 'unanswered');
                
                if (index === this.currentQuestionIndex) {
                    btn.classList.add('active-q');
                } else if (this.userAnswers[index] !== null) {
                    btn.classList.add('answered');
                } else {
                    btn.classList.add('unanswered');
                }
            });
        },
        
        jumpToQuestion(index) {
            this.saveAnswer();
            this.currentQuestionIndex = index;
            this.displayQuestion();
        },

        displayQuestion() {
            if (this.currentQuestionIndex < 0 || this.currentQuestionIndex >= this.quizQuestions.length) {
                return;
            }

            const q = this.quizQuestions[this.currentQuestionIndex];
            this.displays.currentQNum.textContent = this.currentQuestionIndex + 1;
            this.displays.questionText.textContent = q.question;

            this.displays.optionsContainer.innerHTML = '';
            ['A', 'B', 'C', 'D'].forEach(key => {
                if (q.options[key]) {
                    const optionId = `q${this.currentQuestionIndex}-opt${key}`;
                    const wrapper = document.createElement('div');
                    const input = document.createElement('input');
                    input.type = 'radio';
                    input.name = `question-${this.currentQuestionIndex}`;
                    input.id = optionId;
                    input.value = key;
                    input.className = 'hidden';
                    
                    if (this.userAnswers[this.currentQuestionIndex] === key) {
                        input.checked = true;
                    }
                    
                    const label = document.createElement('label');
                    label.htmlFor = optionId;
                    label.className = 'option-label';
                    label.textContent = `${key}. ${q.options[key]}`;

                    wrapper.appendChild(input);
                    wrapper.appendChild(label);
                    this.displays.optionsContainer.appendChild(wrapper);

                    input.addEventListener('change', () => this.saveAnswer());
                }
            });
            
            this.updateNavButtons();
            this.resetQuestionTimer();
            this.updateQuestionNav();
        },
        
        saveAnswer() {
            const selectedOption = document.querySelector(`input[name="question-${this.currentQuestionIndex}"]:checked`);
            if(selectedOption) {
                this.userAnswers[this.currentQuestionIndex] = selectedOption.value;
            }
            this.updateQuestionNav();
        },

        navigateQuestion(direction) {
            this.saveAnswer();
            const newIndex = this.currentQuestionIndex + direction;
            if (newIndex >= 0 && newIndex < this.quizQuestions.length) {
                this.currentQuestionIndex = newIndex;
                this.displayQuestion();
            }
        },
        
        updateNavButtons() {
            this.buttons.prev.disabled = this.currentQuestionIndex === 0;
            this.buttons.prev.classList.toggle('opacity-50', this.buttons.prev.disabled);
            
            if (this.currentQuestionIndex === this.quizQuestions.length - 1) {
                this.buttons.next.style.display = 'none';
                this.buttons.submit.style.display = 'inline-block';
            } else {
                this.buttons.next.style.display = 'inline-block';
                this.buttons.submit.style.display = 'none';
            }
        },
        
        confirmSubmit() {
            this.saveAnswer();
            const unanswered = this.userAnswers.filter(a => a === null).length;
            if (unanswered > 0) {
                 if(!confirm(`B·∫°n c√≤n ${unanswered} c√¢u ch∆∞a tr·∫£ l·ªùi. B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën n·ªôp b√†i kh√¥ng?`)) {
                     return;
                 }
            } else {
                if (!confirm('B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën n·ªôp b√†i kh√¥ng?')) {
                    return;
                }
            }
            this.submitQuiz();
        },

        submitQuiz() {
            this.stopTimers();
            
            let score = 0;
            this.quizQuestions.forEach((q, index) => {
                if (q.answer === this.userAnswers[index]) {
                    score++;
                }
            });

            const result = {
                name: this.inputs.studentName.value.trim(),
                date: new Date().toISOString(),
                score: score,
                totalQuestions: this.quizQuestions.length,
                timeTaken: this.timers.totalSeconds,
                questions: this.quizQuestions,
                userAnswers: this.userAnswers,
            };
            
            const quizConfig = {
                numQuestions: this.inputs.numQuestions.options[this.inputs.numQuestions.selectedIndex].text, 
                timePerQuestion: this.inputs.timePerQuestion.options[this.inputs.timePerQuestion.selectedIndex].text, 
                quizOrder: this.inputs.quizOrder.value,
                timingMode: this.inputs.timingMode.value
            };
            this.logQuizResult(result, quizConfig);

            this.saveResult(result);
            this.displayResult(result);
            this.showScreen('result');
        },

        showCurrentAnswer() {
            this.showExplanationModal(this.currentQuestionIndex);
        },
        
        showExplanationModal(index) {
            this.jumpToQuestion(index);
            const q = this.quizQuestions[index];
            const userAnswer = this.userAnswers[index];
            
            let optionsHtml = '';
            ['A', 'B', 'C', 'D'].forEach(key => {
                if (q.options[key]) {
                    let classList = 'option-label mt-2 cursor-default';
                    if (key === q.answer) {
                        classList += ' correct-answer';
                    }
                    if (key === userAnswer && key !== q.answer) {
                         classList += ' wrong-answer';
                    }
                    optionsHtml += `<div class="${classList}">${key}. ${q.options[key]}</div>`;
                }
            });

            let explanationHtml = '';
            if (q.explanation_right) {
                explanationHtml += `
                    <div class="explanation-box explanation-right">
                        <p class="explanation-title text-green-900">Gi·∫£i th√≠ch ƒë√°p √°n ƒë√∫ng (${q.answer}):</p>
                        <p class="text-sm text-green-800 font-medium">${q.explanation_right.replace(/\n/g, '<br>')}</p>
                    </div>
                `;
            }

            if (q.explanation_wrong) {
                explanationHtml += `
                    <div class="explanation-box explanation-wrong">
                        <p class="explanation-title text-red-900">Gi·∫£i th√≠ch c√°c ph∆∞∆°ng √°n sai:</p>
                        <p class="text-sm text-red-800 font-medium">${q.explanation_wrong.replace(/\n/g, '<br>')}</p>
                    </div>
                `;
            }
            
            if (q.explanation_question) {
                explanationHtml += `
                    <div class="explanation-box explanation-question">
                        <p class="explanation-title text-blue-900">B√≥c ph·ªët ƒë·ªÅ (Ph√¢n t√≠ch c√°ch ra ƒë·ªÅ):</p>
                        <p class="text-sm text-blue-800 font-medium">${q.explanation_question.replace(/\n/g, '<br>')}</p>
                    </div>
                `;
            }

            this.displays.modalContentPlaceholder.innerHTML = `
                <div class="flex justify-between items-center border-b pb-2 mb-4">
                    <h3 class="text-xl font-bold text-bidv-green">ƒê√°p √°n v√† Gi·∫£i th√≠ch (C√¢u ${index + 1})</h3>
                    <button id="modal-close-btn" class="text-gray-500 hover:text-gray-900 font-bold text-2xl leading-none">&times;</button>
                </div>
                <p class="font-bold mb-3 text-black text-lg">${q.question}</p>
                <div class="mb-4">
                    <p class="text-sm text-gray-800 mb-2 font-semibold">
                        C√¢u tr·∫£ l·ªùi c·ªßa b·∫°n: <strong>${userAnswer ? userAnswer : 'Ch∆∞a tr·∫£ l·ªùi'}</strong>. 
                        ƒê√°p √°n ƒë√∫ng: <strong class="text-green-800">${q.answer}</strong>
                    </p>
                    ${optionsHtml}
                </div>
                <div class="mt-4 border-t pt-4">
                    ${explanationHtml}
                </div>
            `;
            
            document.getElementById('modal-close-btn').addEventListener('click', () => this.closeModal());
            this.displays.reviewModalBackdrop.classList.add('active');
            
            if (this.timers.question) {
                 clearInterval(this.timers.question);
            }
            if (this.timingMode === 'per_question' && this.timers.total) {
                clearInterval(this.timers.total);
            }
        },
        
        closeModal() {
            this.displays.reviewModalBackdrop.classList.remove('active');
            if (this.timingMode === 'per_question') {
                 if (!this.timers.total) { 
                    this.timers.total = setInterval(() => {
                        this.timers.totalSeconds++;
                        this.displays.totalTimer.textContent = this.formatTime(this.timers.totalSeconds);
                    }, 1000);
                 }
                this.resetQuestionTimer(); 
            } else {
                this.resetQuestionTimer();
            }
        },
        
        displayResult(result) {
            const { name, date, score, totalQuestions, timeTaken } = result;
            const percentage = totalQuestions > 0 ? (score / totalQuestions * 100).toFixed(2) : 0;
            const formattedTime = this.formatTime(timeTaken);

            this.displays.resultSummary.innerHTML = `
                <p class="text-lg mb-2 text-black font-semibold">Th√≠ sinh: <span class="font-bold text-bidv-green">${name}</span></p>
                <p class="text-4xl font-bold my-4 ${percentage >= 50 ? 'text-green-700' : 'text-red-700'}">
                    ${score} / ${totalQuestions} (${percentage}%)
                </p>
                <div class="flex justify-center space-x-6 text-gray-900 font-bold">
                     <p>Th·ªùi gian l√†m b√†i: <strong>${formattedTime}</strong></p>
                     <p>Ng√†y l√†m: <strong>${new Date(date).toLocaleString('vi-VN')}</strong></p>
                </div>
            `;
            
            this.displays.resultDetails.innerHTML = '';
            this.displays.resultNavList.innerHTML = '';

            result.questions.forEach((q, index) => {
                const userAnswer = result.userAnswers[index];
                const isCorrect = q.answer === userAnswer;
                
                const navBtn = document.createElement('button');
                navBtn.textContent = index + 1;
                navBtn.className = 'result-nav-btn';
                
                if (!userAnswer) {
                    navBtn.classList.add('res-unanswered');
                } else if (isCorrect) {
                    navBtn.classList.add('res-correct');
                } else {
                    navBtn.classList.add('res-wrong');
                }

                navBtn.addEventListener('click', () => {
                    const targetElement = document.getElementById(`result-q-${index}`);
                    if (targetElement) {
                        targetElement.scrollIntoView({ behavior: 'smooth', block: 'center' });
                        targetElement.classList.add('ring-4', 'ring-blue-500');
                        setTimeout(() => targetElement.classList.remove('ring-4', 'ring-blue-500'), 2000);
                    }
                });
                this.displays.resultNavList.appendChild(navBtn);

                const card = document.createElement('div');
                card.className = `p-4 border rounded-lg ${isCorrect ? 'border-green-300 bg-green-50/90' : 'border-yellow-500 bg-yellow-100/95'} backdrop-blur-sm transition-all duration-300 shadow-sm`;
                card.id = `result-q-${index}`; 
                
                let optionsHtml = '';
                ['A', 'B', 'C', 'D'].forEach(key => {
                    if (q.options[key]) {
                        let classList = 'option-label mt-2 text-black font-medium';
                        if (key === q.answer) {
                            classList += ' correct-answer';
                        }
                        if (key === userAnswer && !isCorrect) {
                            classList += ' wrong-answer';
                        }
                        optionsHtml += `<div class="${classList}">${key}. ${q.options[key]}</div>`;
                    }
                });

                let explanationHtml = '';
                if (q.explanation_right) {
                    explanationHtml += `
                        <div class="explanation-box explanation-right">
                            <p class="explanation-title text-green-900">Gi·∫£i th√≠ch ƒë√°p √°n ƒë√∫ng (${q.answer}):</p>
                            <p class="text-sm text-green-800 font-medium">${q.explanation_right.replace(/\n/g, '<br>')}</p>
                        </div>
                    `;
                }
                if (q.explanation_wrong) {
                    explanationHtml += `
                        <div class="explanation-box explanation-wrong">
                            <p class="explanation-title text-red-900">Gi·∫£i th√≠ch c√°c ph∆∞∆°ng √°n sai:</p>
                            <p class="text-sm text-red-800 font-medium">${q.explanation_wrong.replace(/\n/g, '<br>')}</p>
                        </div>
                    `;
                }
                if (q.explanation_question) {
                    explanationHtml += `
                        <div class="explanation-box explanation-question">
                            <p class="explanation-title text-blue-900">B√≥c ph·ªët ƒë·ªÅ (Ph√¢n t√≠ch c√°ch ra ƒë·ªÅ):</p>
                            <p class="text-sm text-blue-800 font-medium">${q.explanation_question.replace(/\n/g, '<br>')}</p>
                        </div>
                    `;
                }

                card.innerHTML = `
                    <p class="font-bold text-black text-lg">C√¢u ${index + 1}: ${q.question}</p>
                    <p class="text-sm text-gray-900 mt-2 font-semibold">
                        B·∫°n ƒë√£ ch·ªçn: <strong class="${isCorrect ? 'text-green-800' : 'text-red-700'}">${userAnswer ? userAnswer : 'Ch∆∞a tr·∫£ l·ªùi'}</strong>. 
                        ƒê√°p √°n ƒë√∫ng: <strong class="text-green-800">${q.answer}</strong>
                    </p>
                    <div class="mt-3">${optionsHtml}</div>
                    <div class="mt-4 p-3 bg-white/60 rounded-md border border-gray-300">
                        <p class="font-bold text-sm mb-2 text-black">Ph√¢n t√≠ch chuy√™n s√¢u:</p>
                        ${explanationHtml}
                    </div>
                `;
                this.displays.resultDetails.appendChild(card);
            });
        },

        saveResult(result) {
            let history = JSON.parse(localStorage.getItem('quizHistory')) || [];
            history.unshift(result);
            localStorage.setItem('quizHistory', JSON.stringify(history));
        },

        // --- C·∫¨P NH·∫¨T 2: QU·∫¢N L√ù L·ªäCH S·ª¨ ---
        showHistory() {
            const history = JSON.parse(localStorage.getItem('quizHistory')) || [];
            
            this.buttons.clearHistory.disabled = (history.length === 0);

            if (history.length === 0) {
                this.displays.historyList.innerHTML = '<p class="text-center text-gray-800 font-semibold italic">Ch∆∞a c√≥ l·ªãch s·ª≠ l√†m b√†i.</p>';
                this.displays.missedQuestionsStats.innerHTML = 'Ch∆∞a c√≥ d·ªØ li·ªáu.';
                this.showScreen('history');
                return;
            }

            this.displays.historyList.innerHTML = '';
            history.forEach((result, index) => {
                const item = document.createElement('div');
                item.className = 'p-4 border rounded-lg flex flex-col sm:flex-row justify-between items-center bg-white/40 shadow-sm backdrop-blur-sm border-gray-400';
                item.innerHTML = `
                    <div class="flex-1 mb-2 sm:mb-0">
                        <p class="font-bold text-lg text-bidv-green">${result.name}</p>
                        <p class="text-sm text-black font-semibold">${new Date(result.date).toLocaleString('vi-VN')}</p>
                    </div>
                    <div class="flex items-center space-x-4">
                        <div class="text-center mr-4">
                            <span class="block text-xl font-bold ${result.score / result.totalQuestions >= 0.5 ? 'text-green-800' : 'text-red-700'}">
                                ${result.score}/${result.totalQuestions}
                            </span>
                            <span class="text-xs text-black font-bold">ƒêi·ªÉm s·ªë</span>
                        </div>
                        <div class="flex space-x-2">
                            <button data-history-index="${index}" class="view-result-btn px-3 py-2 bg-bidv-green text-white text-sm rounded hover:opacity-90 transition-colors flex items-center font-bold shadow">
                                Xem
                            </button>
                            <button data-history-index="${index}" class="delete-result-btn px-3 py-2 bg-red-600 text-white text-sm rounded hover:bg-red-700 transition-colors flex items-center font-bold shadow">
                                X√≥a
                            </button>
                        </div>
                    </div>
                `;
                this.displays.historyList.appendChild(item);
            });
            
            document.querySelectorAll('.view-result-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const index = e.currentTarget.getAttribute('data-history-index');
                    const selectedResult = history[index];
                    if (selectedResult) {
                        this.displayResult(selectedResult);
                        this.showScreen('result');
                    }
                });
            });

            document.querySelectorAll('.delete-result-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const index = e.currentTarget.getAttribute('data-history-index');
                    this.deleteHistoryItem(index);
                });
            });

            this.calculateStats(history);
            this.showScreen('history');
        },
        
        deleteHistoryItem(index) {
            if(confirm('B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a k·∫øt qu·∫£ thi n√†y? H√†nh ƒë·ªông n√†y s·∫Ω c·∫≠p nh·∫≠t l·∫°i b·∫£ng th·ªëng k√™ c√¢u sai.')) {
                let history = JSON.parse(localStorage.getItem('quizHistory')) || [];
                history.splice(index, 1);
                localStorage.setItem('quizHistory', JSON.stringify(history));
                this.showHistory();
            }
        },
        
        clearHistory() {
            if (confirm('B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a T·∫§T C·∫¢ l·ªãch s·ª≠ l√†m b√†i? H√†nh ƒë·ªông n√†y kh√¥ng th·ªÉ ho√†n t√°c.')) {
                localStorage.removeItem('quizHistory');
                this.showHistory();
            }
        },

        calculateStats(history) {
            const missedCounter = {};
            history.forEach(result => {
                result.questions.forEach((q, index) => {
                    if (q.answer !== result.userAnswers[index]) {
                        const questionId = q.id || q.question.slice(0, 50);
                        if (!missedCounter[questionId]) {
                             missedCounter[questionId] = { count: 0, text: q.question };
                        }
                        missedCounter[questionId].count++;
                    }
                });
            });

            const sortedMissed = Object.values(missedCounter).sort((a, b) => b.count - a.count).slice(0, 5);

            if (sortedMissed.length > 0) {
                let statsHtml = '<ul class="list-disc list-inside space-y-2">';
                sortedMissed.forEach(item => {
                    statsHtml += `<li><strong>Sai ${item.count} l·∫ßn:</strong> ${item.text}</li>`;
                });
                statsHtml += '</ul>';
                this.displays.missedQuestionsStats.innerHTML = statsHtml;
            } else {
                this.displays.missedQuestionsStats.innerHTML = 'Tuy·ªát v·ªùi! Kh√¥ng c√≥ c√¢u n√†o b·ªã sai nhi·ªÅu l·∫ßn trong c√°c b√†i thi n√†y.';
            }
        },

        startTimers() {
            this.stopTimers();
            this.timers.totalSeconds = 0;
            
            this.timers.total = setInterval(() => {
                this.timers.totalSeconds++;
                
                if (this.timingMode === 'no_timer') {
                    this.displays.totalTimer.textContent = this.formatTime(this.timers.totalSeconds);
                } else if (this.timingMode === 'per_question') {
                    this.displays.totalTimer.textContent = this.formatTime(this.timers.totalSeconds);
                } else {
                    this.timers.remainingTotalSeconds--;
                    this.displays.totalTimer.textContent = this.formatTime(this.timers.remainingTotalSeconds);
                    if (this.timers.remainingTotalSeconds <= 0) {
                        this.stopTimers();
                        this.submitQuiz();
                    }
                }
            }, 1000);
            
            this.resetQuestionTimer();
        },
        
        resetQuestionTimer() {
            clearInterval(this.timers.question);
            
            if (this.timingMode === 'per_question') {
                this.timers.questionSeconds = this.timePerQuestion;
                this.displays.questionTimer.textContent = this.timers.questionSeconds.toString().padStart(2, '0') + 's';
                
                this.timers.question = setInterval(() => {
                    this.timers.questionSeconds--;
                    this.displays.questionTimer.textContent = this.timers.questionSeconds.toString().padStart(2, '0') + 's';
                    
                    if (this.timers.questionSeconds <= 0) {
                        if (this.currentQuestionIndex === this.quizQuestions.length - 1) {
                            this.submitQuiz(); 
                        } else {
                            this.navigateQuestion(1); 
                        }
                    }
                }, 1000);
            } else {
                this.displays.questionTimer.textContent = '---';
            }
        },

        stopTimers() {
            clearInterval(this.timers.total);
            clearInterval(this.timers.question);
        },
        
        formatTime(seconds) {
            seconds = Math.max(0, seconds);
            const mins = Math.floor(seconds / 60).toString().padStart(2, '0');
            const secs = (seconds % 60).toString().padStart(2, '0');
            return `${mins}:${secs}`;
        }
    };
    
    quizApp.init();
});
</script>

</body>
</html>
