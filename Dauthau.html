<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ứng dụng Trắc nghiệm Online</title>
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- THÊM MỚI: Thư viện Supabase Client -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <style>
        /* Custom Tailwind Configuration (BIDV Colors) */
        :root {
            --color-bidv-green: #006B68; /* Xanh BIDV */
            --color-bidv-yellow: #FFC62F; /* Vàng BIDV */
            --color-bidv-green-light: #e0f2f1; /* Light tone */
        }
        
        /* Custom classes based on BIDV colors */
        .bg-bidv-green { background-color: var(--color-bidv-green); }
        .text-bidv-green { color: var(--color-bidv-green); }
        .bg-bidv-yellow { background-color: var(--color-bidv-yellow); }
        .text-bidv-yellow { color: var(--color-bidv-yellow); }
        .border-bidv-green { border-color: var(--color-bidv-green); }
        
        /* Custom styles for better UI */
        body {
            font-family: 'Inter', sans-serif;
        }
        .screen {
            display: none;
        }
        .screen.active {
            display: block;
        }

        /* --- CẬP NHẬT GIAO DIỆN NỀN CHÍNH --- */
        .main-background {
            background-image: url('https://quantrh.github.io/Quantrh/Dauthau_nen.png');
            background-size: 100% 100%; /* Co giãn đầy khung hình */
            background-repeat: no-repeat;
            background-position: center;
        }
        
        /* Trên mobile có thể dùng cover để tránh hình bị méo quá nhiều nếu tỉ lệ khác biệt */
        @media (max-width: 640px) {
            .main-background {
                background-size: cover; 
            }
        }

        /* --- CẬP NHẬT: HIỆU ỨNG TRONG SUỐT (GLASSMORPHISM) --- */
        .screen-content-wrapper {
            background-color: rgba(255, 255, 255, 0.6); /* Giảm độ mờ xuống 60% để lộ nền */
            backdrop-filter: blur(10px); /* Hiệu ứng làm mờ kính */
            -webkit-backdrop-filter: blur(10px); /* Hỗ trợ Safari */
            border-radius: 0.75rem;
            padding: 1.5rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.3); /* Viền mỏng nhẹ */
        }

        /* Style for radio buttons */
        .option-label {
            display: block;
            padding: 1rem;
            border: 1px solid #d1d5db;
            border-radius: 0.5rem;
            cursor: pointer;
            transition: all 0.2s ease-in-out;
            background-color: rgba(255, 255, 255, 0.8); /* Nền nút chọn hơi trong suốt */
        }
        .option-label:hover {
            background-color: #f3f4f6;
        }
        input[type="radio"]:checked + .option-label {
            background-color: var(--color-bidv-green-light);
            border-color: var(--color-bidv-green);
        }
        .correct-answer {
            background-color: #dcfce7 !important; /* green-100 */
            border-color: #22c55e !important; /* green-500 */
        }
        .wrong-answer {
            background-color: #fee2e2 !important; /* red-100 */
            border-color: #ef4444 !important; /* red-500 */
        }
        /* Custom styles for explanation boxes */
        .explanation-box {
            padding: 1rem;
            border-radius: 0.5rem;
            margin-top: 0.75rem;
        }
        .explanation-title {
            font-weight: 600;
            margin-bottom: 0.5rem;
        }
        .explanation-right {
            background-color: #ecfdf5; /* Green-50 */
            border-left: 4px solid #10b981; /* Green-500 */
        }
        .explanation-wrong {
            background-color: #fef2f2; /* Red-50 */
            border-left: 4px solid #ef4444; /* Red-500 */
        }
        .explanation-question {
            background-color: #f0f9ff; /* Blue-50 */
            border-left: 4px solid #3b82f6; /* Blue-500 */
        }
        /* Style for Question Navigation Buttons */
        .q-nav-btn {
            @apply w-10 h-10 flex items-center justify-center rounded-full text-sm font-semibold cursor-pointer transition-colors;
        }
        .q-nav-btn.unanswered {
            @apply bg-gray-200 text-gray-700 hover:bg-gray-300;
        }
        .q-nav-btn.answered {
            background-color: var(--color-bidv-green);
            color: white;
            @apply hover:opacity-90;
        }
        .q-nav-btn.active-q {
            background-color: var(--color-bidv-yellow);
            color: #000;
            @apply ring-4 ring-yellow-400/50;
        }
        /* Modal Backdrop */
        .modal-backdrop {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            z-index: 1000;
            display: none;
            align-items: center;
            justify-content: center;
        }
        .modal-backdrop.active {
            display: flex;
        }
        .modal-content {
            background: rgba(255, 255, 255, 0.95);
            padding: 2rem;
            border-radius: 0.75rem;
            max-width: 90%;
            max-height: 90%;
            overflow-y: auto;
        }
        /* Apply custom colors to quiz-screen elements */
        #quiz-screen .bg-blue-50 {
            background-color: var(--color-bidv-green-light);
        }
        #quiz-screen .text-blue-600 {
            color: var(--color-bidv-green);
        }
        #quiz-screen .text-blue-700 {
            color: var(--color-bidv-green);
        }
        #quiz-screen .text-blue-800 {
            color: var(--color-bidv-green);
        }
        #quiz-screen #question-timer {
            color: #ef4444; /* Red for timer, keeping contrast */
        }
        #quiz-screen #submit-btn {
            @apply bg-bidv-green hover:opacity-90;
        }
        /* Style for help content from help.html */
        .help-content h2 {
            border-bottom: 2px solid var(--color-bidv-yellow);
            padding-bottom: 0.5rem;
            margin-top: 2rem;
        }
        .help-content .feature-card {
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        .help-content .feature-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 15px rgba(0, 107, 104, 0.1);
        }
        /* Search result styling */
        .search-result-item em {
            background-color: #fef08a; /* Yellow highlight */
            font-style: normal;
            font-weight: bold;
        }
        
        /* Animation cho nút xóa */
        .delete-result-btn:hover {
            background-color: #dc2626; /* red-600 */
        }
    </style>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
</head>
<body class="bg-gray-100 text-gray-800">

    <div id="app" class="container mx-auto p-4 md:p-8 max-w-6xl">
        
        <!-- Banner (BIDV Look and Feel) -->
        <div class="mb-6 rounded-xl shadow-lg overflow-hidden">
            <img src="https://quantrh.github.io/Quantrh/Bannerluyenthi.png" alt="Banner Luyện Thi" class="w-full h-auto object-cover">
        </div>

        <!-- Header -->
        <header class="mb-8 flex justify-between items-center">
            <h1 class="text-3xl font-bold text-bidv-green">Trắc nghiệm Pháp luật Đấu thầu</h1>
            <div>
                <button id="home-btn" class="px-4 py-2 bg-bidv-green text-white rounded-lg shadow hover:opacity-90 transition-colors">Trang chủ</button>
                <button id="history-btn" class="ml-2 px-4 py-2 bg-gray-500 text-white rounded-lg shadow hover:bg-gray-600 transition-colors">Lịch sử</button>
            </div>
        </header>

        <!-- Main Content -->
        <!-- SỬA ĐỔI 1: Thay bg-white bằng class main-background, bỏ bg-white mặc định -->
        <main class="main-background p-6 rounded-xl shadow-lg min-h-[500px]">
            
            <!-- Start Screen -->
            <div id="start-screen" class="screen active">
                <div class="screen-content-wrapper"> <!-- Wrapper nền trắng mờ -->

                    <!-- KHỐI THỐNG KÊ TOÀN TRANG -->
                    <div id="global-stats-section" class="mb-6 p-4 bg-bidv-green/10 rounded-lg shadow-inner">
                        <h3 class="text-xl font-semibold text-bidv-green mb-4 border-b border-bidv-green/30 pb-2">Thống kê Toàn hệ thống</h3>
                        <div id="stats-loading" class="text-center text-gray-600">
                            <svg class="animate-spin h-6 w-6 text-bidv-green mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                            </svg>
                            <p>Đang tải dữ liệu thống kê...</p>
                        </div>
                        <div id="stats-content" class="hidden grid grid-cols-2 md:grid-cols-5 gap-4 text-center">
                            <div>
                                <p class="text-2xl font-bold text-bidv-green" id="stats-total-visits">--</p>
                                <p class="text-sm font-medium text-gray-600">Lượt truy cập</p>
                            </div>
                            <div>
                                <p class="text-2xl font-bold text-bidv-green" id="stats-total-quizzes">--</p>
                                <p class="text-sm font-medium text-gray-600">Lượt bài đã làm</p>
                            </div>
                            <div>
                                <p class="text-2xl font-bold text-bidv-green" id="stats-avg-score">--</p>
                                <p class="text-sm font-medium text-gray-600">Điểm bình quân</p>
                            </div>
                            <div>
                                <p class="text-2xl font-bold text-bidv-green" id="stats-avg-questions">--</p>
                                <p class="text-sm font-medium text-gray-600">Câu hỏi / Bài</p>
                            </div>
                            <div>
                                <p class="text-2xl font-bold text-bidv-green" id="stats-avg-time-per-q">--</p>
                                <p class="text-sm font-medium text-gray-600">Giây / Câu</p>
                            </div>
                        </div>
                    </div>
                    <!-- KẾT THÚC KHỐI THỐNG KÊ -->

                    <!-- KHỐI TÌM KIẾM TRA CỨU -->
                    <!-- SỬA: Thay bg-white bằng bg-white/80 để trong suốt -->
                    <div id="search-section" class="mb-8 p-6 bg-white/80 border-2 border-bidv-yellow/30 rounded-xl shadow-md backdrop-blur-sm">
                        <div class="flex items-center mb-4 border-b border-gray-200 pb-2">
                            <svg class="w-6 h-6 text-bidv-green mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                            </svg>
                            <h3 class="text-xl font-bold text-bidv-green">Tra cứu Kiến thức / Câu hỏi</h3>
                        </div>
                        
                        <div class="relative group">
                            <input type="text" id="search-input" class="w-full px-5 py-4 pl-12 bg-gray-50/80 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-bidv-green focus:border-bidv-green focus:bg-white transition-all text-gray-800 placeholder-gray-400" placeholder="Nhập từ khóa bất kỳ để tìm kiếm trong câu hỏi, đáp án hoặc giải thích... (Ví dụ: 'gói thầu', '45 ngày', 'điều 22')">
                            <div class="absolute inset-y-0 left-0 pl-4 flex items-center pointer-events-none">
                                <svg class="h-6 w-6 text-gray-400 group-focus-within:text-bidv-green transition-colors" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                                </svg>
                            </div>
                            <button id="clear-search-btn" class="absolute inset-y-0 right-0 pr-4 flex items-center text-gray-400 hover:text-gray-600 hidden">
                                <svg class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                                </svg>
                            </button>
                        </div>
                        <div id="search-status" class="mt-2 text-sm text-gray-500 italic hidden">Đang tìm kiếm...</div>
                        <div id="search-results" class="mt-4 space-y-4 max-h-[500px] overflow-y-auto hidden pr-2 custom-scrollbar">
                            <!-- Search results will appear here -->
                        </div>
                    </div>
                    <!-- KẾT THÚC KHỐI TÌM KIẾM -->

                    <h2 class="text-2xl font-semibold mb-4 text-center text-bidv-green">Cấu hình Bài thi</h2>
                    <p class="text-center mb-6 text-gray-600">Vui lòng cấu hình bài thi và nhấn "Bắt đầu" để thử sức.</p>
                    <div class="space-y-6">
                        <div>
                            <label for="student-name" class="block text-sm font-medium text-gray-700 mb-1">Nhập tên của bạn:</label>
                            <input type="text" id="student-name" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-bidv-green focus:border-bidv-green bg-white/90" placeholder="Ví dụ: Trương Hồng Quân">
                        </div>
                    
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label for="num-questions" class="block text-sm font-medium text-gray-700 mb-1">Số câu hỏi:</label>
                                <select id="num-questions" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-bidv-green focus:border-bidv-green bg-white/90">
                                    <option value="70">70 câu (Tiêu chuẩn)</option>
                                    <option value="1">1 câu</option>
                                    <option value="10">10 câu</option>
                                    <option value="20">20 câu</option>
                                    <option value="30">30 câu</option>
                                    <option value="40">40 câu</option>
                                    <option value="50">50 câu</option>
                                    <option value="100">100 câu</option>
                                    <option value="150">150 câu</option>
                                    <option value="200">200 câu</option>
                                    <option value="250">250 câu</option>
                                    <option value="0">Tất cả</option>
                                </select>
                            </div>
                            <div>
                                <label for="time-per-question" class="block text-sm font-medium text-gray-700 mb-1">Thời gian mỗi câu (giây):</label>
                                <select id="time-per-question" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-bidv-green focus:border-bidv-green bg-white/90">
                                    <option value="51">51 giây (cho 70 câu)</option>
                                    <option value="30">30 giây</option>
                                    <option value="60">60 giây</option>
                                    <option value="90">90 giây</option>
                                    <option value="120">120 giây</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label for="quiz-order" class="block text-sm font-medium text-gray-700 mb-1">Thứ tự câu hỏi:</label>
                                <select id="quiz-order" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-bidv-green focus:border-bidv-green bg-white/90">
                                    <option value="random">Ngẫu nhiên (Đề thi thử)</option>
                                    <option value="sequential">Theo thứ tự ID (Để xem lại)</option>
                                </select>
                                
                                <div id="start-from-container" class="mt-2 hidden bg-gray-50/80 p-2 rounded border border-gray-200">
                                    <label for="start-from-question" class="block text-sm font-medium text-bidv-green mb-1">Bắt đầu từ câu số:</label>
                                    <input type="number" id="start-from-question" min="1" value="1" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-bidv-green focus:border-bidv-green bg-white/90" placeholder="Nhập ID câu bắt đầu">
                                </div>
                            </div>
                            <div>
                                <label for="timing-mode" class="block text-sm font-medium text-gray-700 mb-1">Chế độ tính giờ:</label>
                                <select id="timing-mode" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-bidv-green focus:border-bidv-green bg-white/90">
                                    <option value="total">Tổng thời gian (Mặc định)</option>
                                    <option value="per_question">Tính giờ mỗi câu hỏi</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="md:grid md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Tổng thời gian làm bài:</label>
                                <p id="total-quiz-time" class="w-full px-3 py-2 bg-gray-100/80 border border-gray-300 rounded-md shadow-sm font-semibold text-gray-700">
                                    -- phút
                                </p>
                            </div>
                        </div>

                        <p id="data-status" class="text-sm text-center text-gray-500">Đang tải dữ liệu câu hỏi...</p>
                        <button id="start-btn" class="w-full py-3 px-4 bg-bidv-green text-white font-semibold rounded-lg shadow-md hover:opacity-90 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-bidv-green disabled:bg-gray-400 disabled:cursor-not-allowed">Bắt đầu làm bài</button>
                        
                        <div class="mt-8 pt-4 border-t border-gray-200">
                            <button id="toggle-help-btn" class="w-full py-2 px-4 bg-bidv-yellow text-gray-900 font-semibold rounded-lg shadow-md hover:opacity-90 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-bidv-yellow">
                                Hiển thị Hướng dẫn sử dụng
                            </button>
                            <!-- SỬA: Thay bg-white bằng bg-white/90 -->
                            <div id="help-content-container" class="mt-4 p-6 border border-gray-100 rounded-xl shadow-inner bg-white/90 help-content" style="display: none;">
                                <h2 class="text-2xl font-bold text-bidv-green mb-4">I. TÓM TẮT TÍNH NĂNG NỔI TRỘI</h2>
                                <p class="mb-6 text-gray-700">Ứng dụng được thiết kế nhằm mô phỏng sát nhất kỳ thi thực tế, đồng thời cung cấp các công cụ phân tích sâu sắc giúp thí sinh dễ dàng ôn tập và cải thiện kiến thức một cách hiệu quả.</p>

                                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                                    <div class="feature-card p-5 bg-bidv-green/5 border-l-4 border-bidv-green rounded-lg shadow-sm">
                                        <h3 class="text-xl font-semibold mb-2 text-bidv-green">1. Mô phỏng Thi thực tế</h3>
                                        <p class="text-sm text-gray-700">Tùy chỉnh số lượng câu hỏi, thời gian và chế độ tính giờ (Tổng thời gian hoặc Tính giờ mỗi câu) để làm quen với áp lực phòng thi.</p>
                                    </div>
                                    <div class="feature-card p-5 bg-bidv-green/5 border-l-4 border-bidv-green rounded-lg shadow-sm">
                                        <h3 class="text-xl font-semibold mb-2 text-bidv-green">2. Phân tích &amp; Giải thích chi tiết</h3>
                                        <p class="text-sm text-gray-700">Sau khi nộp bài, xem lại đáp án đúng, câu trả lời của bạn, và nhận <strong>Giải thích chuyên sâu</strong> bao gồm <strong>Phân tích đáp án đúng/sai</strong> và <strong>Bóc phốt đề-soi cách ra đề</strong>.</p>
                                    </div>
                                    <div class="feature-card p-5 bg-bidv-green/5 border-l-4 border-bidv-green rounded-lg shadow-sm">
                                        <h3 class="text-xl font-semibold mb-2 text-bidv-green">3. Thống kê Lịch sử</h3>
                                        <p class="text-sm text-gray-700">Lưu lại toàn bộ lịch sử làm bài. Đặc biệt là chức năng <strong>Thống kê các câu hay sai</strong> giúp bạn tập trung ôn luyện các điểm yếu.</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div> <!-- End screen-content-wrapper -->
            </div>

            <!-- Quiz Screen -->
            <div id="quiz-screen" class="screen">
                <div class="screen-content-wrapper"> <!-- Wrapper nền trắng mờ -->
                    <div class="md:flex md:space-x-6">
                        
                        <div class="md:w-3/4 flex flex-col space-y-6">
                            <div class="flex justify-between items-center p-4 bg-bidv-green/10 rounded-lg shadow backdrop-blur-sm">
                                <div class="text-left">
                                    <span class="text-xs font-medium text-bidv-green">Thí sinh:</span>
                                    <p id="student-name-display" class="text-lg font-semibold text-bidv-green"></p>
                                </div>
                                <div class="text-right">
                                    <span class="text-xs font-medium text-gray-600">Tổng thời gian:</span>
                                    <p id="total-timer" class="text-xl font-bold text-bidv-green">00:00</p>
                                </div>
                            </div>

                            <!-- SỬA: Thay bg-white bằng bg-white/80 -->
                            <div id="question-card" class="p-6 border border-gray-200 rounded-lg shadow-md bg-white/80 backdrop-blur-sm">
                                <div class="flex justify-between items-center mb-4 border-b pb-2">
                                    <div class="text-lg font-semibold">
                                        Câu <span id="current-q-num"></span> / <span id="total-q-num"></span>
                                    </div>
                                    <div class="text-lg font-semibold text-right">
                                        Thời gian còn lại: <span id="question-timer" class="text-red-500">00</span>s
                                    </div>
                                </div>
                                
                                <div id="question-container" class="mb-6">
                                    <p id="question-text" class="text-xl font-medium mb-4"></p>
                                    <div id="options-container" class="space-y-3">
                                        <!-- Options will be generated here -->
                                    </div>
                                </div>
                                
                                <div class="flex justify-between items-center mt-6">
                                    <button id="prev-btn" class="py-2 px-6 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300">Câu trước</button>
                                    <button id="view-answer-btn" class="py-2 px-6 bg-bidv-yellow text-gray-900 rounded-lg hover:opacity-90">Xem đáp án</button>
                                    <div>
                                        <button id="next-btn" class="py-2 px-6 bg-bidv-green text-white rounded-lg hover:opacity-90">Câu tiếp</button>
                                        <button id="submit-btn" class="py-2 px-6 bg-bidv-green text-white rounded-lg hover:opacity-90" style="display: none;">Nộp bài</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="md:w-1/4 mt-6 md:mt-0">
                            <!-- SỬA: Thay bg-gray-50 bằng bg-gray-50/80 -->
                            <div class="sticky top-0 p-4 bg-gray-50/80 border border-gray-200 rounded-lg shadow-md backdrop-blur-sm">
                                <h3 class="text-lg font-semibold mb-3 border-b pb-2">Danh sách câu hỏi</h3>
                                <div id="question-nav-list" class="grid grid-cols-5 gap-3">
                                    <!-- Question number buttons go here -->
                                </div>
                                <div class="mt-4 pt-2 border-t text-sm text-gray-600">
                                    <p class="flex items-center space-x-2"><span class="q-nav-btn w-4 h-4 answered"></span><span>Đã trả lời</span></p>
                                    <p class="flex items-center space-x-2"><span class="q-nav-btn w-4 h-4 unanswered"></span><span>Chưa trả lời</span></p>
                                    <p class="flex items-center space-x-2"><span class="q-nav-btn w-4 h-4 active-q"></span><span>Đang xem</span></p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Result Screen -->
            <div id="result-screen" class="screen">
                <div class="screen-content-wrapper">
                    <h2 class="text-2xl font-semibold mb-4 text-center text-bidv-green">Kết quả bài làm</h2>
                    <!-- SỬA: bg-gray-50/80 -->
                    <div id="result-summary" class="text-center bg-gray-50/80 p-6 rounded-lg mb-6 backdrop-blur-sm">
                        <!-- Summary here -->
                    </div>
                    <h3 class="text-xl font-semibold mb-4">Xem lại chi tiết:</h3>
                    <div id="result-details" class="space-y-6">
                        <!-- Detailed results here -->
                    </div>
                    <div class="text-center mt-8">
                        <button id="back-to-home-btn" class="py-3 px-6 bg-bidv-green text-white font-semibold rounded-lg shadow-md hover:opacity-90">Làm bài thi mới</button>
                    </div>
                </div>
            </div>

            <!-- History Screen -->
            <div id="history-screen" class="screen">
                <div class="screen-content-wrapper">
                    <h2 class="text-2xl font-semibold mb-4 text-bidv-green">Lịch sử làm bài</h2>
                    
                    <div class="text-right mb-4">
                        <button id="clear-history-btn" class="py-2 px-4 bg-red-600 text-white font-semibold rounded-lg shadow-md hover:bg-red-700 transition-colors">Xóa tất cả lịch sử thi</button>
                    </div>
                    
                    <div id="history-stats" class="mb-6">
                        <h3 class="text-xl font-semibold mb-2">Thống kê các câu hay sai</h3>
                        <p class="text-sm text-gray-500 mb-2 italic">Dữ liệu được tổng hợp từ các lần thi hiện có trong lịch sử.</p>
                        <div id="missed-questions-stats" class="text-gray-600 p-4 bg-gray-50/80 rounded border">Chưa có dữ liệu.</div>
                    </div>
                    <div id="history-list" class="space-y-4">
                        <p>Chưa có lịch sử làm bài.</p>
                    </div>
                </div>
            </div>
            
            <!-- Modal for Review/Explanation -->
            <div id="review-modal-backdrop" class="modal-backdrop">
                <div id="review-modal" class="modal-content md:max-w-3xl">
                    <div id="modal-content-placeholder">
                        <!-- Content will be inserted here -->
                    </div>
                </div>
            </div>

        </main>
        
        <!-- Footer for Copyright -->
        <footer class="mt-8 text-center text-gray-500 text-sm">
            <p>Bản quyền thuộc về: Trương Hồng Quân</p>
            <p>Email: <a href="mailto:Quantrhvn@gmail.com" class="text-bidv-green hover:underline">Quantrhvn@gmail.com</a></p>
        </footer>
    </div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    
    // --- CẤU HÌNH SUPABASE ---
    const SUPABASE_URL = 'https://rmbsxccrwrktbjlnezpu.supabase.co'; 
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJtYnN4Y2Nyd3JrdGJqbG5lenB1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDg2MjczNjQsImV4cCI6MjA2NDIwMzM2NH0.ydCqificftdtn1niRciFCifeuo8aX6SDGti-hCY5Z_Y';
    
    let supabaseClient = null;
    try {
        if (SUPABASE_URL !== 'YOUR_SUPABASE_URL' && SUPABASE_KEY !== 'YOUR_SUPABASE_ANON_KEY') {
            supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
        } else {
            console.warn('Supabase chưa được cấu hình.');
        }
    } catch (error) {
        console.error('Lỗi khởi tạo Supabase:', error);
    }

    const quizApp = {
        // DOM Elements
        screens: {
            start: document.getElementById('start-screen'),
            quiz: document.getElementById('quiz-screen'),
            result: document.getElementById('result-screen'),
            history: document.getElementById('history-screen'),
        },
        buttons: {
            home: document.getElementById('home-btn'),
            history: document.getElementById('history-btn'),
            start: document.getElementById('start-btn'),
            prev: document.getElementById('prev-btn'),
            next: document.getElementById('next-btn'),
            submit: document.getElementById('submit-btn'),
            viewAnswer: document.getElementById('view-answer-btn'),
            backToHome: document.getElementById('back-to-home-btn'),
            clearHistory: document.getElementById('clear-history-btn'),
            toggleHelp: document.getElementById('toggle-help-btn'),
            clearSearch: document.getElementById('clear-search-btn'),
        },
        inputs: {
            studentName: document.getElementById('student-name'),
            numQuestions: document.getElementById('num-questions'),
            timePerQuestion: document.getElementById('time-per-question'),
            quizOrder: document.getElementById('quiz-order'),
            startFromQuestion: document.getElementById('start-from-question'),
            timingMode: document.getElementById('timing-mode'), 
            searchInput: document.getElementById('search-input'),
        },
        displays: {
            dataStatus: document.getElementById('data-status'),
            currentQNum: document.getElementById('current-q-num'),
            totalQNum: document.getElementById('total-q-num'),
            totalTimer: document.getElementById('total-timer'),
            questionTimer: document.getElementById('question-timer'),
            questionText: document.getElementById('question-text'),
            optionsContainer: document.getElementById('options-container'),
            resultSummary: document.getElementById('result-summary'),
            resultDetails: document.getElementById('result-details'),
            historyList: document.getElementById('history-list'),
            missedQuestionsStats: document.getElementById('missed-questions-stats'),
            totalQuizTime: document.getElementById('total-quiz-time'),
            questionNavList: document.getElementById('question-nav-list'),
            studentNameDisplay: document.getElementById('student-name-display'),
            reviewModalBackdrop: document.getElementById('review-modal-backdrop'),
            modalContentPlaceholder: document.getElementById('modal-content-placeholder'),
            helpContentContainer: document.getElementById('help-content-container'),
            
            // Thống kê
            statsLoading: document.getElementById('stats-loading'),
            statsContent: document.getElementById('stats-content'),
            statsTotalVisits: document.getElementById('stats-total-visits'),
            statsTotalQuizzes: document.getElementById('stats-total-quizzes'),
            statsAvgScore: document.getElementById('stats-avg-score'),
            statsAvgQuestions: document.getElementById('stats-avg-questions'),
            statsAvgTimePerQ: document.getElementById('stats-avg-time-per-q'),

            // Search
            searchResults: document.getElementById('search-results'),
            searchStatus: document.getElementById('search-status'),
        },

        // State
        allQuestions: [],
        quizQuestions: [],
        userAnswers: [],
        currentQuestionIndex: 0,
        timePerQuestion: 60,
        timingMode: 'total',
        visitorIP: null,
        searchDebounceTimer: null,
        timers: {
            total: null,
            question: null,
            totalSeconds: 0,
            questionSeconds: 0,
            remainingTotalSeconds: 0,
        },
        
        init() {
            this.addEventListeners();
            this.loadQuestions();
            this.showScreen('start');
            this.calculateTotalTime();
            this.initializeTracking();
            this.loadGlobalStats();
        },

        // --- Tracking ---
        async initializeTracking() {
            await this.getVisitorIP();
            await this.logPageVisit();
        },

        async getVisitorIP() {
            try {
                const response = await fetch('https://api.ipify.org?format=json');
                if (!response.ok) throw new Error('Không thể lấy IP');
                const data = await response.json();
                this.visitorIP = data.ip;
            } catch (error) {
                console.error('Lỗi khi lấy IP:', error);
                this.visitorIP = 'unknown';
            }
        },

        async logPageVisit() {
            if (!supabaseClient) return;
            try {
                const { error } = await supabaseClient
                    .from('page_visits')
                    .insert({ ip_address: this.visitorIP });
                if (error) throw error;
            } catch (error) {
                console.error('Lỗi ghi nhận lượt truy cập:', error.message);
            }
        },
        
        async loadGlobalStats() {
            if (!supabaseClient) {
                this.displays.statsLoading.innerHTML = '';
                return;
            }

            try {
                const { data, error } = await supabaseClient.rpc('get_global_stats');
                
                if (error) throw error;
                
                if (data && data.length > 0) {
                    const stats = data[0];
                    const totalVisits = stats.total_visits || 0;
                    const totalQuizzes = stats.total_quizzes || 0;
                    const avgScore = stats.avg_score || 0;
                    const totalTime = stats.total_time_all_quizzes || 0;
                    const totalQuestions = stats.total_questions_all_quizzes || 0;
                    const avgQuestionsPerQuiz = (totalQuizzes > 0) ? (totalQuestions / totalQuizzes) : 0;
                    const avgTimePerQuestion = (totalQuestions > 0) ? (totalTime / totalQuestions) : 0;

                    this.displays.statsTotalVisits.textContent = totalVisits;
                    this.displays.statsTotalQuizzes.textContent = totalQuizzes;
                    this.displays.statsAvgScore.textContent = avgScore.toFixed(1);
                    this.displays.statsAvgQuestions.textContent = avgQuestionsPerQuiz.toFixed(1);
                    this.displays.statsAvgTimePerQ.textContent = avgTimePerQuestion.toFixed(1);

                    this.displays.statsLoading.style.display = 'none';
                    this.displays.statsContent.classList.remove('hidden');
                }
            } catch (error) {
                console.error('Lỗi tải thống kê:', error.message);
                this.displays.statsLoading.innerHTML = `<p class="text-red-500 text-xs">Không tải được thống kê.</p>`;
            }
        },
        
        async logQuizResult(result, config) {
            if (!supabaseClient) return;

            const payload = {
                student_name: result.name,
                score: result.score,
                total_questions: result.totalQuestions,
                time_taken_seconds: result.timeTaken,
                quiz_date: result.date,
                ip_address: this.visitorIP,
                config_num_questions: config.numQuestions,
                config_time_per_question: config.timePerQuestion,
                config_quiz_order: config.quizOrder,
                config_timing_mode: config.timingMode
            };

            try {
                const { error } = await supabaseClient.from('quiz_results').insert(payload);
                if (error) throw error;
            } catch (error) {
                console.error('Lỗi lưu kết quả thi:', error.message);
            }
        },
        
        // --- SEARCH ---
        handleSearch(query) {
            const resultsContainer = this.displays.searchResults;
            const statusContainer = this.displays.searchStatus;
            const clearBtn = this.buttons.clearSearch;
            
            if(query.length > 0) {
                clearBtn.classList.remove('hidden');
            } else {
                clearBtn.classList.add('hidden');
            }

            const cleanQuery = query.trim().toLowerCase();

            if (cleanQuery.length < 2) {
                resultsContainer.innerHTML = '';
                resultsContainer.classList.add('hidden');
                statusContainer.classList.add('hidden');
                return;
            }
            
            statusContainer.textContent = "Đang tìm kiếm...";
            statusContainer.classList.remove('hidden');

            setTimeout(() => {
                const results = this.allQuestions.filter(q => {
                    const textToSearch = [
                        q.question,
                        q.options?.A, q.options?.B, q.options?.C, q.options?.D,
                        q.explanation_right,
                        q.explanation_wrong,
                        q.explanation_question
                    ].join(' ').toLowerCase();
                    
                    return textToSearch.includes(cleanQuery);
                }).slice(0, 20);

                statusContainer.classList.add('hidden');
                resultsContainer.innerHTML = '';

                if (results.length === 0) {
                    resultsContainer.innerHTML = '<p class="text-center text-gray-500 py-4">Không tìm thấy kết quả nào phù hợp.</p>';
                    resultsContainer.classList.remove('hidden');
                    return;
                }

                results.forEach(q => {
                    const card = document.createElement('div');
                    card.className = 'search-result-item bg-gray-50 p-4 rounded-lg border border-gray-200 hover:shadow-md transition-all';
                    
                    const highlight = (text) => {
                        if (!text) return '';
                        const escapedQuery = cleanQuery.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
                        const regex = new RegExp(`(${escapedQuery})`, 'gi');
                        return text.replace(regex, '<em>$1</em>');
                    };

                    let optionsHtml = '';
                    ['A', 'B', 'C', 'D'].forEach(key => {
                        if (q.options[key]) {
                            let classList = 'p-2 rounded mt-1 text-sm border border-transparent';
                            if (key === q.answer) {
                                classList += ' bg-green-100 border-green-300 text-green-800 font-semibold';
                            } else {
                                classList += ' bg-white border-gray-200 text-gray-600';
                            }
                            optionsHtml += `<div class="${classList}">${key}. ${highlight(q.options[key])}</div>`;
                        }
                    });

                    let explanationHtml = '';
                    if (q.explanation_right) {
                        explanationHtml += `<div class="mt-2 text-xs text-green-700 bg-green-50 p-2 rounded border-l-2 border-green-500"><strong>Giải thích đúng:</strong> ${highlight(q.explanation_right)}</div>`;
                    }
                    if (q.explanation_wrong) {
                         explanationHtml += `<div class="mt-2 text-xs text-red-700 bg-red-50 p-2 rounded border-l-2 border-red-500"><strong>Giải thích sai:</strong> ${highlight(q.explanation_wrong)}</div>`;
                    }
                     if (q.explanation_question) {
                         explanationHtml += `<div class="mt-2 text-xs text-blue-700 bg-blue-50 p-2 rounded border-l-2 border-blue-500"><strong>Phân tích đề:</strong> ${highlight(q.explanation_question)}</div>`;
                    }

                    card.innerHTML = `
                        <p class="font-semibold text-gray-800 mb-2">Câu hỏi ${q.id}: ${highlight(q.question)}</p>
                        <div class="space-y-1 mb-2">${optionsHtml}</div>
                        ${explanationHtml}
                    `;
                    resultsContainer.appendChild(card);
                });
                
                resultsContainer.classList.remove('hidden');
            }, 100);
        },

        addEventListeners() {
            this.buttons.home.addEventListener('click', () => this.showScreen('start'));
            this.buttons.history.addEventListener('click', () => this.showHistory());
            this.buttons.start.addEventListener('click', () => this.startQuiz());
            this.buttons.next.addEventListener('click', () => this.navigateQuestion(1));
            this.buttons.prev.addEventListener('click', () => this.navigateQuestion(-1));
            this.buttons.submit.addEventListener('click', () => this.confirmSubmit());
            this.buttons.viewAnswer.addEventListener('click', () => this.showCurrentAnswer());
            this.buttons.backToHome.addEventListener('click', () => this.showScreen('start'));
            this.buttons.clearHistory.addEventListener('click', () => this.clearHistory());
            
            this.buttons.toggleHelp.addEventListener('click', () => this.toggleHelpContent());
            
            this.inputs.numQuestions.addEventListener('change', () => this.calculateTotalTime());
            this.inputs.timePerQuestion.addEventListener('change', () => this.calculateTotalTime());
            this.inputs.timingMode.addEventListener('change', () => this.calculateTotalTime());
            
            this.inputs.quizOrder.addEventListener('change', (e) => {
                const container = document.getElementById('start-from-container');
                if (e.target.value === 'sequential') {
                    container.classList.remove('hidden');
                } else {
                    container.classList.add('hidden');
                }
            });

            this.displays.reviewModalBackdrop.addEventListener('click', (e) => {
                if (e.target === this.displays.reviewModalBackdrop) {
                    this.closeModal();
                }
            });

            this.inputs.searchInput.addEventListener('input', (e) => {
                clearTimeout(this.searchDebounceTimer);
                this.searchDebounceTimer = setTimeout(() => {
                    this.handleSearch(e.target.value);
                }, 400);
            });

            this.buttons.clearSearch.addEventListener('click', () => {
                this.inputs.searchInput.value = '';
                this.handleSearch('');
                this.inputs.searchInput.focus();
            });
        },
        
        toggleHelpContent() {
            const container = this.displays.helpContentContainer;
            const button = this.buttons.toggleHelp;
            if (container.style.display === 'none') {
                container.style.display = 'block';
                button.textContent = 'Ẩn Hướng dẫn sử dụng';
            } else {
                container.style.display = 'none';
                button.textContent = 'Hiển thị Hướng dẫn sử dụng';
            }
        },

        calculateTotalTime() {
            let numQuestions = parseInt(this.inputs.numQuestions.value);
            const timePerQuestion = parseInt(this.inputs.timePerQuestion.value);

            if (numQuestions === 0) {
                numQuestions = this.allQuestions.length;
            }

            if (numQuestions > 0 && !isNaN(timePerQuestion)) {
                const totalSeconds = numQuestions * timePerQuestion;
                const totalMinutes = Math.ceil(totalSeconds / 60);
                this.displays.totalQuizTime.textContent = `${totalMinutes} phút`;
            } else {
                 this.displays.totalQuizTime.textContent = `-- phút`;
            }
        },

        showScreen(screenId) {
            Object.values(this.screens).forEach(screen => screen.classList.remove('active'));
            if (this.screens[screenId]) {
                this.screens[screenId].classList.add('active');
            }
        },

        async loadQuestions() {
            try {
                const uniqueParam = new Date().getTime();
                const response = await fetch(`./Dauthaujson.json?v=${uniqueParam}`);
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const data = await response.json();
                
                this.allQuestions = data.filter(q => q.question && q.answer);
                
                if (this.allQuestions.length > 0) {
                    this.displays.dataStatus.textContent = `Sẵn sàng! Tải thành công ${this.allQuestions.length} câu hỏi.`;
                    this.calculateTotalTime(); 
                } else {
                    throw new Error("Tệp JSON không chứa câu hỏi hợp lệ.");
                }

            } catch (error) {
                console.error("Lỗi tải tệp JSON câu hỏi:", error);
                this.displays.dataStatus.innerHTML = '<span class="text-red-500 font-bold text-lg">LỖI: Không tải được tệp <code>./Dauthaujson.json</code>.<br>Hãy đảm bảo tệp JSON nằm CÙNG THƯ MỤC với tệp HTML trên GitHub.</span>';
                this.allQuestions = [];
            }
        },

        startQuiz() {
            if (this.allQuestions.length === 0) {
                alert('Dữ liệu câu hỏi chưa sẵn sàng. Vui lòng kiểm tra lỗi ở mục "data-status".');
                return;
            }
            
            if (this.inputs.studentName.value.trim() === '') {
                alert('Vui lòng nhập tên của bạn.'); 
                return;
            }
            
            this.timingMode = this.inputs.timingMode.value;

            let selectedQuestions = [...this.allQuestions];
            const order = this.inputs.quizOrder.value;
            
            if (order === 'sequential') {
                selectedQuestions.sort((a, b) => {
                    const idA = parseInt(a.id);
                    const idB = parseInt(b.id);
                    if (!isNaN(idA) && !isNaN(idB)) {
                        return idA - idB;
                    }
                    return 0; 
                });

                const startFromVal = parseInt(this.inputs.startFromQuestion.value);
                if (!isNaN(startFromVal) && startFromVal > 1) {
                    const startIndex = startFromVal - 1;
                    if (startIndex < selectedQuestions.length) {
                        selectedQuestions = selectedQuestions.slice(startIndex);
                    } else {
                        alert(`Số câu bắt đầu (${startFromVal}) lớn hơn tổng số câu hỏi hiện có (${selectedQuestions.length})! Sẽ bắt đầu từ câu đầu tiên.`);
                    }
                }
            } else {
                selectedQuestions.sort(() => 0.5 - Math.random());
            }

            const num = parseInt(this.inputs.numQuestions.value);
            if (num > 0 && num < selectedQuestions.length) {
                this.quizQuestions = selectedQuestions.slice(0, num);
            } else {
                this.quizQuestions = selectedQuestions;
            }

            this.timePerQuestion = parseInt(this.inputs.timePerQuestion.value);
            this.timers.remainingTotalSeconds = this.quizQuestions.length * this.timePerQuestion;

            this.userAnswers = new Array(this.quizQuestions.length).fill(null);
            this.currentQuestionIndex = 0;
            
            this.displays.totalQNum.textContent = this.quizQuestions.length;
            this.displays.studentNameDisplay.textContent = this.inputs.studentName.value.trim();
            
            this.startTimers();
            this.displayQuestion();
            this.renderQuestionNav();
            this.showScreen('quiz');
        },

        renderQuestionNav() {
            this.displays.questionNavList.innerHTML = '';
            this.quizQuestions.forEach((q, index) => {
                const btn = document.createElement('button');
                btn.className = 'q-nav-btn';
                btn.textContent = index + 1;
                btn.setAttribute('data-index', index);

                btn.addEventListener('click', () => {
                    this.saveAnswer(); 
                    if (confirm('Bạn có muốn xem đáp án và giải thích cho câu hỏi này không?')) {
                         this.showExplanationModal(index);
                    } else {
                         this.jumpToQuestion(index);
                    }
                });
                this.displays.questionNavList.appendChild(btn);
            });
            this.updateQuestionNav();
        },
        
        updateQuestionNav() {
            const navButtons = this.displays.questionNavList.querySelectorAll('.q-nav-btn');
            navButtons.forEach((btn, index) => {
                btn.classList.remove('active-q', 'answered', 'unanswered');
                
                if (index === this.currentQuestionIndex) {
                    btn.classList.add('active-q');
                } else if (this.userAnswers[index] !== null) {
                    btn.classList.add('answered');
                } else {
                    btn.classList.add('unanswered');
                }
            });
        },
        
        jumpToQuestion(index) {
            this.saveAnswer();
            this.currentQuestionIndex = index;
            this.displayQuestion();
        },

        displayQuestion() {
            if (this.currentQuestionIndex < 0 || this.currentQuestionIndex >= this.quizQuestions.length) {
                return;
            }

            const q = this.quizQuestions[this.currentQuestionIndex];
            this.displays.currentQNum.textContent = this.currentQuestionIndex + 1;
            this.displays.questionText.textContent = q.question;

            this.displays.optionsContainer.innerHTML = '';
            ['A', 'B', 'C', 'D'].forEach(key => {
                if (q.options[key]) {
                    const optionId = `q${this.currentQuestionIndex}-opt${key}`;
                    const wrapper = document.createElement('div');
                    const input = document.createElement('input');
                    input.type = 'radio';
                    input.name = `question-${this.currentQuestionIndex}`;
                    input.id = optionId;
                    input.value = key;
                    input.className = 'hidden';
                    
                    if (this.userAnswers[this.currentQuestionIndex] === key) {
                        input.checked = true;
                    }
                    
                    const label = document.createElement('label');
                    label.htmlFor = optionId;
                    label.className = 'option-label';
                    label.textContent = `${key}. ${q.options[key]}`;

                    wrapper.appendChild(input);
                    wrapper.appendChild(label);
                    this.displays.optionsContainer.appendChild(wrapper);

                    input.addEventListener('change', () => this.saveAnswer());
                }
            });
            
            this.updateNavButtons();
            this.resetQuestionTimer();
            this.updateQuestionNav();
        },
        
        saveAnswer() {
            const selectedOption = document.querySelector(`input[name="question-${this.currentQuestionIndex}"]:checked`);
            if(selectedOption) {
                this.userAnswers[this.currentQuestionIndex] = selectedOption.value;
            }
            this.updateQuestionNav();
        },

        navigateQuestion(direction) {
            this.saveAnswer();
            const newIndex = this.currentQuestionIndex + direction;
            if (newIndex >= 0 && newIndex < this.quizQuestions.length) {
                this.currentQuestionIndex = newIndex;
                this.displayQuestion();
            }
        },
        
        updateNavButtons() {
            this.buttons.prev.disabled = this.currentQuestionIndex === 0;
            this.buttons.prev.classList.toggle('opacity-50', this.buttons.prev.disabled);
            
            if (this.currentQuestionIndex === this.quizQuestions.length - 1) {
                this.buttons.next.style.display = 'none';
                this.buttons.submit.style.display = 'inline-block';
            } else {
                this.buttons.next.style.display = 'inline-block';
                this.buttons.submit.style.display = 'none';
            }
        },
        
        confirmSubmit() {
            this.saveAnswer();
            const unanswered = this.userAnswers.filter(a => a === null).length;
            if (unanswered > 0) {
                 if(!confirm(`Bạn còn ${unanswered} câu chưa trả lời. Bạn có chắc chắn muốn nộp bài không?`)) {
                     return;
                 }
            } else {
                if (!confirm('Bạn có chắc chắn muốn nộp bài không?')) {
                    return;
                }
            }
            this.submitQuiz();
        },

        submitQuiz() {
            this.stopTimers();
            
            let score = 0;
            this.quizQuestions.forEach((q, index) => {
                if (q.answer === this.userAnswers[index]) {
                    score++;
                }
            });

            const result = {
                name: this.inputs.studentName.value.trim(),
                date: new Date().toISOString(),
                score: score,
                totalQuestions: this.quizQuestions.length,
                timeTaken: this.timers.totalSeconds,
                questions: this.quizQuestions,
                userAnswers: this.userAnswers,
            };
            
            const quizConfig = {
                numQuestions: this.inputs.numQuestions.options[this.inputs.numQuestions.selectedIndex].text, 
                timePerQuestion: this.inputs.timePerQuestion.options[this.inputs.timePerQuestion.selectedIndex].text, 
                quizOrder: this.inputs.quizOrder.value,
                timingMode: this.inputs.timingMode.value
            };
            this.logQuizResult(result, quizConfig);

            this.saveResult(result);
            this.displayResult(result);
            this.showScreen('result');
        },

        showCurrentAnswer() {
            this.showExplanationModal(this.currentQuestionIndex);
        },
        
        showExplanationModal(index) {
            this.jumpToQuestion(index);
            const q = this.quizQuestions[index];
            const userAnswer = this.userAnswers[index];
            
            let optionsHtml = '';
            ['A', 'B', 'C', 'D'].forEach(key => {
                if (q.options[key]) {
                    let classList = 'option-label mt-2 cursor-default';
                    if (key === q.answer) {
                        classList += ' correct-answer';
                    }
                    if (key === userAnswer && key !== q.answer) {
                         classList += ' wrong-answer';
                    }
                    optionsHtml += `<div class="${classList}">${key}. ${q.options[key]}</div>`;
                }
            });

            let explanationHtml = '';
            if (q.explanation_right) {
                explanationHtml += `
                    <div class="explanation-box explanation-right">
                        <p class="explanation-title text-green-700">Giải thích đáp án đúng (${q.answer}):</p>
                        <p class="text-sm text-gray-700">${q.explanation_right.replace(/\n/g, '<br>')}</p>
                    </div>
                `;
            }

            if (q.explanation_wrong) {
                explanationHtml += `
                    <div class="explanation-box explanation-wrong">
                        <p class="explanation-title text-red-700">Giải thích các phương án sai:</p>
                        <p class="text-sm text-gray-700">${q.explanation_wrong.replace(/\n/g, '<br>')}</p>
                    </div>
                `;
            }
            
            if (q.explanation_question) {
                explanationHtml += `
                    <div class="explanation-box explanation-question">
                        <p class="explanation-title text-bidv-green">Bóc phốt đề (Phân tích cách ra đề):</p>
                        <p class="text-sm text-gray-700">${q.explanation_question.replace(/\n/g, '<br>')}</p>
                    </div>
                `;
            }

            this.displays.modalContentPlaceholder.innerHTML = `
                <div class="flex justify-between items-center border-b pb-2 mb-4">
                    <h3 class="text-xl font-bold text-bidv-green">Đáp án và Giải thích (Câu ${index + 1})</h3>
                    <button id="modal-close-btn" class="text-gray-500 hover:text-gray-900 font-bold text-2xl leading-none">&times;</button>
                </div>
                <p class="font-semibold mb-3">${q.question}</p>
                <div class="mb-4">
                    <p class="text-sm text-gray-700 mb-2">
                        Câu trả lời của bạn: <strong>${userAnswer ? userAnswer : 'Chưa trả lời'}</strong>. 
                        Đáp án đúng: <strong class="text-green-700">${q.answer}</strong>
                    </p>
                    ${optionsHtml}
                </div>
                <div class="mt-4 border-t pt-4">
                    ${explanationHtml}
                </div>
            `;
            
            document.getElementById('modal-close-btn').addEventListener('click', () => this.closeModal());
            this.displays.reviewModalBackdrop.classList.add('active');
            
            if (this.timers.question) {
                 clearInterval(this.timers.question);
            }
            if (this.timingMode === 'per_question' && this.timers.total) {
                clearInterval(this.timers.total);
            }
        },
        
        closeModal() {
            this.displays.reviewModalBackdrop.classList.remove('active');
            if (this.timingMode === 'per_question') {
                 if (!this.timers.total) { 
                    this.timers.total = setInterval(() => {
                        this.timers.totalSeconds++;
                        this.displays.totalTimer.textContent = this.formatTime(this.timers.totalSeconds);
                    }, 1000);
                 }
                this.resetQuestionTimer(); 
            } else {
                this.resetQuestionTimer();
            }
        },
        
        displayResult(result) {
            const { name, date, score, totalQuestions, timeTaken } = result;
            const percentage = totalQuestions > 0 ? (score / totalQuestions * 100).toFixed(2) : 0;
            const formattedTime = this.formatTime(timeTaken);

            this.displays.resultSummary.innerHTML = `
                <p class="text-lg mb-2">Thí sinh: <span class="font-bold text-bidv-green">${name}</span></p>
                <p class="text-4xl font-bold my-4 ${percentage >= 50 ? 'text-green-600' : 'text-red-600'}">
                    ${score} / ${totalQuestions} (${percentage}%)
                </p>
                <div class="flex justify-center space-x-6 text-gray-600">
                     <p>Thời gian làm bài: <strong>${formattedTime}</strong></p>
                     <p>Ngày làm: <strong>${new Date(date).toLocaleString('vi-VN')}</strong></p>
                </div>
            `;
            
            this.displays.resultDetails.innerHTML = '';
            result.questions.forEach((q, index) => {
                const userAnswer = result.userAnswers[index];
                const isCorrect = q.answer === userAnswer;
                
                const card = document.createElement('div');
                card.className = `p-4 border rounded-lg ${isCorrect ? 'border-green-300 bg-green-50' : 'border-red-300 bg-red-50'}`;
                
                let optionsHtml = '';
                ['A', 'B', 'C', 'D'].forEach(key => {
                    if (q.options[key]) {
                        let classList = 'option-label mt-2';
                        if (key === q.answer) {
                            classList += ' correct-answer';
                        }
                        if (key === userAnswer && !isCorrect) {
                            classList += ' wrong-answer';
                        }
                        optionsHtml += `<div class="${classList}">${key}. ${q.options[key]}</div>`;
                    }
                });

                let explanationHtml = '';
                if (q.explanation_right) {
                    explanationHtml += `
                        <div class="explanation-box explanation-right">
                            <p class="explanation-title text-green-700">Giải thích đáp án đúng (${q.answer}):</p>
                            <p class="text-sm text-gray-700">${q.explanation_right.replace(/\n/g, '<br>')}</p>
                        </div>
                    `;
                }
                if (q.explanation_wrong) {
                    explanationHtml += `
                        <div class="explanation-box explanation-wrong">
                            <p class="explanation-title text-red-700">Giải thích các phương án sai:</p>
                            <p class="text-sm text-gray-700">${q.explanation_wrong.replace(/\n/g, '<br>')}</p>
                        </div>
                    `;
                }
                if (q.explanation_question) {
                    explanationHtml += `
                        <div class="explanation-box explanation-question">
                            <p class="explanation-title text-bidv-green">Bóc phốt đề (Phân tích cách ra đề):</p>
                            <p class="text-sm text-gray-700">${q.explanation_question.replace(/\n/g, '<br>')}</p>
                        </div>
                    `;
                }

                card.innerHTML = `
                    <p class="font-semibold">Câu ${index + 1}: ${q.question}</p>
                    <p class="text-sm text-gray-700 mt-2">
                        Bạn đã chọn: <strong class="${isCorrect ? 'text-green-700' : 'text-red-700'}">${userAnswer ? userAnswer : 'Chưa trả lời'}</strong>. 
                        Đáp án đúng: <strong class="text-green-700">${q.answer}</strong>
                    </p>
                    <div class="mt-3">${optionsHtml}</div>
                    <div class="mt-4 p-3 bg-gray-50 rounded-md">
                        <p class="font-semibold text-sm mb-2">Phân tích chuyên sâu:</p>
                        ${explanationHtml}
                    </div>
                `;
                this.displays.resultDetails.appendChild(card);
            });
        },

        saveResult(result) {
            let history = JSON.parse(localStorage.getItem('quizHistory')) || [];
            history.unshift(result);
            localStorage.setItem('quizHistory', JSON.stringify(history));
        },

        // --- CẬP NHẬT 2: QUẢN LÝ LỊCH SỬ ---
        showHistory() {
            const history = JSON.parse(localStorage.getItem('quizHistory')) || [];
            
            this.buttons.clearHistory.disabled = (history.length === 0);

            if (history.length === 0) {
                this.displays.historyList.innerHTML = '<p class="text-center text-gray-500 italic">Chưa có lịch sử làm bài.</p>';
                this.displays.missedQuestionsStats.innerHTML = 'Chưa có dữ liệu.';
                this.showScreen('history');
                return;
            }

            this.displays.historyList.innerHTML = '';
            history.forEach((result, index) => {
                const item = document.createElement('div');
                item.className = 'p-4 border rounded-lg flex flex-col sm:flex-row justify-between items-center bg-white/90 shadow-sm';
                item.innerHTML = `
                    <div class="flex-1 mb-2 sm:mb-0">
                        <p class="font-semibold text-lg text-bidv-green">${result.name}</p>
                        <p class="text-sm text-gray-500">${new Date(result.date).toLocaleString('vi-VN')}</p>
                    </div>
                    <div class="flex items-center space-x-4">
                        <div class="text-center mr-4">
                            <span class="block text-xl font-bold ${result.score / result.totalQuestions >= 0.5 ? 'text-green-600' : 'text-red-600'}">
                                ${result.score}/${result.totalQuestions}
                            </span>
                            <span class="text-xs text-gray-500">Điểm số</span>
                        </div>
                        <div class="flex space-x-2">
                            <button data-history-index="${index}" class="view-result-btn px-3 py-2 bg-bidv-green text-white text-sm rounded hover:opacity-90 transition-colors flex items-center">
                                Xem
                            </button>
                            <button data-history-index="${index}" class="delete-result-btn px-3 py-2 bg-red-500 text-white text-sm rounded hover:bg-red-600 transition-colors flex items-center">
                                Xóa
                            </button>
                        </div>
                    </div>
                `;
                this.displays.historyList.appendChild(item);
            });
            
            // Event Listeners cho nút Xem
            document.querySelectorAll('.view-result-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    // Dùng currentTarget để đảm bảo lấy đúng attribute nếu click vào icon bên trong
                    const index = e.currentTarget.getAttribute('data-history-index');
                    const selectedResult = history[index];
                    if (selectedResult) {
                        this.displayResult(selectedResult);
                        this.showScreen('result');
                    }
                });
            });

            // Event Listeners cho nút Xóa từng mục
            document.querySelectorAll('.delete-result-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const index = e.currentTarget.getAttribute('data-history-index');
                    this.deleteHistoryItem(index);
                });
            });

            this.calculateStats(history);
            this.showScreen('history');
        },
        
        // Hàm xóa một mục lịch sử
        deleteHistoryItem(index) {
            if(confirm('Bạn có chắc muốn xóa kết quả thi này? Hành động này sẽ cập nhật lại bảng thống kê câu sai.')) {
                let history = JSON.parse(localStorage.getItem('quizHistory')) || [];
                // Xóa phần tử tại index
                history.splice(index, 1);
                localStorage.setItem('quizHistory', JSON.stringify(history));
                // Tải lại màn hình lịch sử (sẽ tự động tính toán lại thống kê)
                this.showHistory();
            }
        },
        
        clearHistory() {
            if (confirm('Bạn có chắc chắn muốn xóa TẤT CẢ lịch sử làm bài? Hành động này không thể hoàn tác.')) {
                localStorage.removeItem('quizHistory');
                this.showHistory();
            }
        },

        calculateStats(history) {
            const missedCounter = {};
            history.forEach(result => {
                result.questions.forEach((q, index) => {
                    if (q.answer !== result.userAnswers[index]) {
                        const questionId = q.id || q.question.slice(0, 50);
                        if (!missedCounter[questionId]) {
                             missedCounter[questionId] = { count: 0, text: q.question };
                        }
                        missedCounter[questionId].count++;
                    }
                });
            });

            const sortedMissed = Object.values(missedCounter).sort((a, b) => b.count - a.count).slice(0, 5);

            if (sortedMissed.length > 0) {
                let statsHtml = '<ul class="list-disc list-inside space-y-2">';
                sortedMissed.forEach(item => {
                    statsHtml += `<li><strong>Sai ${item.count} lần:</strong> ${item.text}</li>`;
                });
                statsHtml += '</ul>';
                this.displays.missedQuestionsStats.innerHTML = statsHtml;
            } else {
                this.displays.missedQuestionsStats.innerHTML = 'Tuyệt vời! Không có câu nào bị sai nhiều lần trong các bài thi này.';
            }
        },

        // Timer Functions
        startTimers() {
            this.stopTimers();
            this.timers.totalSeconds = 0;
            
            this.timers.total = setInterval(() => {
                this.timers.totalSeconds++;
                if (this.timingMode === 'per_question') {
                    this.displays.totalTimer.textContent = this.formatTime(this.timers.totalSeconds);
                } else {
                    this.timers.remainingTotalSeconds--;
                    this.displays.totalTimer.textContent = this.formatTime(this.timers.remainingTotalSeconds);
                    if (this.timers.remainingTotalSeconds <= 0) {
                        this.stopTimers();
                        this.submitQuiz();
                    }
                }
            }, 1000);
            
            this.resetQuestionTimer();
        },
        
        resetQuestionTimer() {
            clearInterval(this.timers.question);
            
            if (this.timingMode === 'per_question') {
                this.timers.questionSeconds = this.timePerQuestion;
                this.displays.questionTimer.textContent = this.timers.questionSeconds.toString().padStart(2, '0') + 's';
                
                this.timers.question = setInterval(() => {
                    this.timers.questionSeconds--;
                    this.displays.questionTimer.textContent = this.timers.questionSeconds.toString().padStart(2, '0') + 's';
                    
                    if (this.timers.questionSeconds <= 0) {
                        if (this.currentQuestionIndex === this.quizQuestions.length - 1) {
                            this.submitQuiz(); 
                        } else {
                            this.navigateQuestion(1); 
                        }
                    }
                }, 1000);
            } else {
                this.displays.questionTimer.textContent = '---';
            }
        },

        stopTimers() {
            clearInterval(this.timers.total);
            clearInterval(this.timers.question);
        },
        
        formatTime(seconds) {
            seconds = Math.max(0, seconds);
            const mins = Math.floor(seconds / 60).toString().padStart(2, '0');
            const secs = (seconds % 60).toString().padStart(2, '0');
            return `${mins}:${secs}`;
        }
    };
    
    quizApp.init();
});
</script>

</body>
</html>
