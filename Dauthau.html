<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ứng dụng Trắc nghiệm Online</title>
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- SheetJS/xlsx library for reading Excel files -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        /* Custom styles for better UI */
        body {
            font-family: 'Inter', sans-serif;
        }
        .screen {
            display: none;
        }
        .screen.active {
            display: block;
        }
        /* Style for radio buttons */
        .option-label {
            display: block;
            padding: 1rem;
            border: 1px solid #d1d5db;
            border-radius: 0.5rem;
            cursor: pointer;
            transition: all 0.2s ease-in-out;
        }
        .option-label:hover {
            background-color: #f3f4f6;
        }
        input[type="radio"]:checked + .option-label {
            background-color: #dbeafe;
            border-color: #3b82f6;
        }
        .correct-answer {
            background-color: #dcfce7 !important; /* green-100 */
            border-color: #22c55e !important; /* green-500 */
        }
        .wrong-answer {
            background-color: #fee2e2 !important; /* red-100 */
            border-color: #ef4444 !important; /* red-500 */
        }
        /* Custom styles for explanation boxes */
        .explanation-box {
            padding: 1rem;
            border-radius: 0.5rem;
            margin-top: 0.75rem;
        }
        .explanation-title {
            font-weight: 600;
            margin-bottom: 0.5rem;
        }
        .explanation-right {
            background-color: #ecfdf5; /* Green-50 */
            border-left: 4px solid #10b981; /* Green-500 */
        }
        .explanation-wrong {
            background-color: #fef2f2; /* Red-50 */
            border-left: 4px solid #ef4444; /* Red-500 */
        }
        .explanation-question {
            background-color: #f0f9ff; /* Blue-50 */
            border-left: 4px solid #3b82f6; /* Blue-500 */
        }
        /* Style for Question Navigation Buttons */
        .q-nav-btn {
            @apply w-10 h-10 flex items-center justify-center rounded-full text-sm font-semibold cursor-pointer transition-colors;
        }
        .q-nav-btn.unanswered {
            @apply bg-gray-200 text-gray-700 hover:bg-gray-300;
        }
        .q-nav-btn.answered {
            @apply bg-blue-500 text-white hover:bg-blue-600;
        }
        .q-nav-btn.active-q {
            @apply ring-4 ring-yellow-400/50 bg-yellow-500 text-white;
        }
        /* Modal Backdrop */
        .modal-backdrop {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            z-index: 1000;
            display: none;
            align-items: center;
            justify-content: center;
        }
        .modal-backdrop.active {
            display: flex;
        }
        .modal-content {
            background: white;
            padding: 2rem;
            border-radius: 0.75rem;
            max-width: 90%;
            max-height: 90%;
            overflow-y: auto;
        }
    </style>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
</head>
<body class="bg-gray-100 text-gray-800">

    <div id="app" class="container mx-auto p-4 md:p-8 max-w-6xl">
        <!-- Header -->
        <header class="mb-8 flex justify-between items-center">
            <h1 class="text-3xl font-bold text-blue-600">Trắc nghiệm Pháp luật Đấu thầu</h1>
            <div>
                <button id="home-btn" class="px-4 py-2 bg-blue-500 text-white rounded-lg shadow hover:bg-blue-600 transition-colors">Trang chủ</button>
                <button id="history-btn" class="ml-2 px-4 py-2 bg-gray-500 text-white rounded-lg shadow hover:bg-gray-600 transition-colors">Lịch sử</button>
            </div>
        </header>

        <!-- Main Content -->
        <main class="bg-white p-6 rounded-xl shadow-lg">
            <!-- Start Screen -->
            <div id="start-screen" class="screen active">
                <h2 class="text-2xl font-semibold mb-4 text-center">Chào mừng bạn!</h2>
                <p class="text-center mb-6 text-gray-600">Vui lòng cấu hình bài thi và nhấn "Bắt đầu" để thử sức.</p>
                <div class="space-y-6">
                    <div>
                        <label for="student-name" class="block text-sm font-medium text-gray-700 mb-1">Nhập tên của bạn:</label>
                        <input type="text" id="student-name" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" placeholder="Ví dụ: Nguyễn Văn A">
                    </div>
                   
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label for="num-questions" class="block text-sm font-medium text-gray-700 mb-1">Số câu hỏi:</label>
                            <select id="num-questions" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                                <option value="70">70 câu (Tiêu chuẩn)</option>
                                <option value="10">10 câu</option>
                                <option value="50">50 câu</option>
                                <option value="100">100 câu</option>
                                <option value="150">150 câu</option>
                                <option value="200">200 câu</option>
                                <option value="250">250 câu</option>
                                <option value="0">Tất cả</option>
                            </select>
                        </div>
                        <div>
                            <label for="time-per-question" class="block text-sm font-medium text-gray-700 mb-1">Thời gian mỗi câu (giây):</label>
                            <select id="time-per-question" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                                <option value="51">51 giây (cho 70 câu)</option>
                                <option value="30">30 giây</option>
                                <option value="60">60 giây</option>
                                <option value="90">90 giây</option>
                                <option value="120">120 giây</option>
                            </select>
                        </div>
                    </div>
                    
                    <!-- New row for quiz order and total time -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label for="quiz-order" class="block text-sm font-medium text-gray-700 mb-1">Thứ tự câu hỏi:</label>
                            <select id="quiz-order" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                                <option value="random">Ngẫu nhiên (Đề thi thử)</option>
                                <option value="sequential">Theo thứ tự ID (Để xem lại)</option>
                            </select>
                        </div>
                        <!-- New element to display calculated total time -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Tổng thời gian làm bài:</label>
                            <p id="total-quiz-time" class="w-full px-3 py-2 bg-gray-100 border border-gray-300 rounded-md shadow-sm font-semibold text-gray-700">
                                -- phút
                            </p>
                        </div>
                    </div>

                     <p id="data-status" class="text-sm text-center text-gray-500">Đang tải dữ liệu câu hỏi...</p>
                    <button id="start-btn" class="w-full py-3 px-4 bg-blue-600 text-white font-semibold rounded-lg shadow-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 disabled:bg-gray-400 disabled:cursor-not-allowed" disabled>Bắt đầu làm bài</button>
                </div>
            </div>

            <!-- Quiz Screen - New Layout -->
            <div id="quiz-screen" class="screen">
                <div class="md:flex md:space-x-6">
                    
                    <!-- Cột trái: Thông tin chính và Câu hỏi -->
                    <div class="md:w-3/4 flex flex-col space-y-6">
                        <div class="flex justify-between items-center p-4 bg-blue-50 rounded-lg shadow">
                             <div class="text-left">
                                <span class="text-xs font-medium text-blue-700">Thí sinh:</span>
                                <p id="student-name-display" class="text-lg font-semibold text-blue-800"></p>
                             </div>
                             <div class="text-right">
                                <span class="text-xs font-medium text-gray-600">Tổng thời gian:</span>
                                <p id="total-timer" class="text-xl font-bold text-blue-600">00:00</p>
                             </div>
                        </div>

                        <div id="question-card" class="p-6 border border-gray-200 rounded-lg shadow-md bg-white">
                            <div class="flex justify-between items-center mb-4 border-b pb-2">
                                <div class="text-lg font-semibold">
                                    Câu <span id="current-q-num"></span> / <span id="total-q-num"></span>
                                </div>
                                <div class="text-lg font-semibold text-right">
                                    Thời gian còn lại: <span id="question-timer" class="text-red-500">00</span>s
                                </div>
                            </div>
                            
                            <div id="question-container" class="mb-6">
                                <p id="question-text" class="text-xl font-medium mb-4"></p>
                                <div id="options-container" class="space-y-3">
                                    <!-- Options will be generated here -->
                                </div>
                            </div>
                            
                            <div class="flex justify-between mt-6">
                                <button id="prev-btn" class="py-2 px-6 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300">Câu trước</button>
                                <button id="next-btn" class="py-2 px-6 bg-blue-600 text-white rounded-lg hover:bg-blue-700">Câu tiếp</button>
                                <button id="submit-btn" class="py-2 px-6 bg-green-600 text-white rounded-lg hover:bg-green-700" style="display: none;">Nộp bài</button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Cột phải: Danh sách câu hỏi và chức năng điều hướng -->
                    <div class="md:w-1/4 mt-6 md:mt-0">
                        <div class="sticky top-0 p-4 bg-gray-50 border border-gray-200 rounded-lg shadow-md">
                            <h3 class="text-lg font-semibold mb-3 border-b pb-2">Danh sách câu hỏi</h3>
                            <div id="question-nav-list" class="grid grid-cols-5 gap-3">
                                <!-- Question number buttons go here -->
                            </div>
                            <div class="mt-4 pt-2 border-t text-sm text-gray-600">
                                <p class="flex items-center space-x-2"><span class="q-nav-btn w-4 h-4 answered"></span><span>Đã trả lời</span></p>
                                <p class="flex items-center space-x-2"><span class="q-nav-btn w-4 h-4 unanswered"></span><span>Chưa trả lời</span></p>
                                <p class="flex items-center space-x-2"><span class="q-nav-btn w-4 h-4 active-q"></span><span>Đang xem</span></p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Result Screen -->
            <div id="result-screen" class="screen">
                <h2 class="text-2xl font-semibold mb-4 text-center">Kết quả bài làm</h2>
                <div id="result-summary" class="text-center bg-gray-50 p-6 rounded-lg mb-6">
                    <!-- Summary here -->
                </div>
                <h3 class="text-xl font-semibold mb-4">Xem lại chi tiết:</h3>
                <div id="result-details" class="space-y-6">
                    <!-- Detailed results here -->
                </div>
                 <div class="text-center mt-8">
                    <button id="back-to-home-btn" class="py-3 px-6 bg-blue-600 text-white font-semibold rounded-lg shadow-md hover:bg-blue-700">Làm bài thi mới</button>
                </div>
            </div>

            <!-- History Screen -->
            <div id="history-screen" class="screen">
                <h2 class="text-2xl font-semibold mb-4">Lịch sử làm bài</h2>
                <div id="history-stats" class="mb-6">
                    <h3 class="text-xl font-semibold mb-2">Thống kê các câu hay sai</h3>
                    <div id="missed-questions-stats" class="text-gray-600">Chưa có dữ liệu.</div>
                </div>
                <div id="history-list" class="space-y-4">
                    <p>Chưa có lịch sử làm bài.</p>
                </div>
            </div>
            
            <!-- Modal for Review/Explanation -->
            <div id="review-modal-backdrop" class="modal-backdrop">
                <div id="review-modal" class="modal-content md:max-w-3xl">
                    <div id="modal-content-placeholder">
                        <!-- Content will be inserted here -->
                    </div>
                </div>
            </div>

        </main>
    </div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    const quizApp = {
        // DOM Elements
        screens: {
            start: document.getElementById('start-screen'),
            quiz: document.getElementById('quiz-screen'),
            result: document.getElementById('result-screen'),
            history: document.getElementById('history-screen'),
        },
        buttons: {
            home: document.getElementById('home-btn'),
            history: document.getElementById('history-btn'),
            start: document.getElementById('start-btn'),
            prev: document.getElementById('prev-btn'),
            next: document.getElementById('next-btn'),
            submit: document.getElementById('submit-btn'),
            backToHome: document.getElementById('back-to-home-btn'),
        },
        inputs: {
            studentName: document.getElementById('student-name'),
            numQuestions: document.getElementById('num-questions'),
            timePerQuestion: document.getElementById('time-per-question'),
            quizOrder: document.getElementById('quiz-order'), 
        },
        displays: {
            dataStatus: document.getElementById('data-status'),
            currentQNum: document.getElementById('current-q-num'),
            totalQNum: document.getElementById('total-q-num'),
            totalTimer: document.getElementById('total-timer'),
            questionTimer: document.getElementById('question-timer'),
            questionText: document.getElementById('question-text'),
            optionsContainer: document.getElementById('options-container'),
            resultSummary: document.getElementById('result-summary'),
            resultDetails: document.getElementById('result-details'),
            historyList: document.getElementById('history-list'),
            missedQuestionsStats: document.getElementById('missed-questions-stats'),
            totalQuizTime: document.getElementById('total-quiz-time'),
            questionNavList: document.getElementById('question-nav-list'),
            studentNameDisplay: document.getElementById('student-name-display'),
            reviewModalBackdrop: document.getElementById('review-modal-backdrop'),
            modalContentPlaceholder: document.getElementById('modal-content-placeholder'),
        },

        // State
        allQuestions: [],
        quizQuestions: [],
        userAnswers: [],
        currentQuestionIndex: 0,
        timePerQuestion: 60,
        timers: {
            total: null,
            question: null,
            totalSeconds: 0,
            questionSeconds: 0,
        },
        
        init() {
            this.addEventListeners();
            this.loadQuestions();
            this.showScreen('start');
            this.calculateTotalTime(); // Tính toán thời gian ban đầu
        },

        addEventListeners() {
            this.buttons.home.addEventListener('click', () => this.showScreen('start'));
            this.buttons.history.addEventListener('click', () => this.showHistory());
            this.buttons.start.addEventListener('click', () => this.startQuiz());
            this.buttons.next.addEventListener('click', () => this.navigateQuestion(1));
            this.buttons.prev.addEventListener('click', () => this.navigateQuestion(-1));
            this.buttons.submit.addEventListener('click', () => this.confirmSubmit());
            this.buttons.backToHome.addEventListener('click', () => this.showScreen('start'));
            
            // Lắng nghe sự kiện thay đổi để cập nhật tổng thời gian
            this.inputs.numQuestions.addEventListener('change', () => this.calculateTotalTime());
            this.inputs.timePerQuestion.addEventListener('change', () => this.calculateTotalTime());
            
            // Đóng modal khi click ra ngoài
            this.displays.reviewModalBackdrop.addEventListener('click', (e) => {
                if (e.target === this.displays.reviewModalBackdrop) {
                    this.closeModal();
                }
            });
        },

        calculateTotalTime() {
            let numQuestions = parseInt(this.inputs.numQuestions.value);
            const timePerQuestion = parseInt(this.inputs.timePerQuestion.value);

            // Xử lý trường hợp "Tất cả" (value=0)
            if (numQuestions === 0) {
                numQuestions = this.allQuestions.length;
            }

            if (numQuestions > 0 && !isNaN(timePerQuestion)) {
                const totalSeconds = numQuestions * timePerQuestion;
                const totalMinutes = Math.ceil(totalSeconds / 60);
                this.displays.totalQuizTime.textContent = `${totalMinutes} phút`;
            } else {
                 this.displays.totalQuizTime.textContent = `-- phút`;
            }
        },

        showScreen(screenId) {
            Object.values(this.screens).forEach(screen => screen.classList.remove('active'));
            if (this.screens[screenId]) {
                this.screens[screenId].classList.add('active');
            }
        },

        async loadQuestions() {
            try {
                const response = await fetch('./Dauthaujson.json');
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const data = await response.json();
                
                this.allQuestions = data.filter(q => q.question && q.answer);
                
                if (this.allQuestions.length > 0) {
                    this.displays.dataStatus.textContent = `Sẵn sàng! Tải thành công ${this.allQuestions.length} câu hỏi.`;
                    this.buttons.start.disabled = false;
                    this.calculateTotalTime(); 
                } else {
                    throw new Error("Tệp JSON không chứa câu hỏi hợp lệ.");
                }

            } catch (error) {
                console.error("Lỗi tải tệp JSON câu hỏi:", error);
                this.displays.dataStatus.textContent = 'Lỗi: Không thể tải dữ liệu câu hỏi. Vui lòng làm mới trang.';
                this.allQuestions = [];
            }
        },

        startQuiz() {
            if (this.inputs.studentName.value.trim() === '') {
                alert('Vui lòng nhập tên của bạn.');
                return;
            }
            
            // Determine question pool
            let selectedQuestions = [...this.allQuestions];
            
            // Tùy chọn sắp xếp
            const order = this.inputs.quizOrder.value;
            
            if (order === 'sequential') {
                // Sắp xếp theo ID (từ nhỏ đến lớn)
                selectedQuestions.sort((a, b) => {
                    const idA = parseInt(a.id);
                    const idB = parseInt(b.id);
                    if (!isNaN(idA) && !isNaN(idB)) {
                        return idA - idB;
                    }
                    return 0; 
                });
            } else {
                // Ngẫu nhiên (default)
                selectedQuestions.sort(() => 0.5 - Math.random());
            }

            // Select number of questions
            const num = parseInt(this.inputs.numQuestions.value);
            if (num > 0 && num < selectedQuestions.length) {
                this.quizQuestions = selectedQuestions.slice(0, num);
            } else {
                this.quizQuestions = selectedQuestions;
            }

            // Cấu hình thời gian mỗi câu
            this.timePerQuestion = parseInt(this.inputs.timePerQuestion.value);
            
            this.userAnswers = new Array(this.quizQuestions.length).fill(null);
            this.currentQuestionIndex = 0;
            
            this.displays.totalQNum.textContent = this.quizQuestions.length;
            this.displays.studentNameDisplay.textContent = this.inputs.studentName.value.trim();
            
            this.startTimers();
            this.displayQuestion();
            this.renderQuestionNav(); // Render danh sách câu hỏi
            this.showScreen('quiz');
        },

        renderQuestionNav() {
            this.displays.questionNavList.innerHTML = '';
            this.quizQuestions.forEach((q, index) => {
                const btn = document.createElement('button');
                btn.className = 'q-nav-btn';
                btn.textContent = index + 1;
                btn.setAttribute('data-index', index);

                btn.addEventListener('click', () => {
                    if (confirm('Bạn có muốn xem đáp án và giải thích cho câu hỏi này không? (Việc này sẽ không ảnh hưởng đến điểm số của bạn, nhưng bạn sẽ thấy đáp án)')) {
                         this.showExplanationModal(index);
                    } else {
                         this.jumpToQuestion(index);
                    }
                });
                this.displays.questionNavList.appendChild(btn);
            });
            this.updateQuestionNav();
        },
        
        updateQuestionNav() {
            const navButtons = this.displays.questionNavList.querySelectorAll('.q-nav-btn');
            navButtons.forEach((btn, index) => {
                btn.classList.remove('active-q', 'answered', 'unanswered');
                
                if (index === this.currentQuestionIndex) {
                    btn.classList.add('active-q');
                } else if (this.userAnswers[index] !== null) {
                    btn.classList.add('answered');
                } else {
                    btn.classList.add('unanswered');
                }
            });
        },
        
        jumpToQuestion(index) {
            this.saveAnswer();
            this.currentQuestionIndex = index;
            this.displayQuestion();
        },

        displayQuestion() {
            if (this.currentQuestionIndex < 0 || this.currentQuestionIndex >= this.quizQuestions.length) {
                return;
            }

            const q = this.quizQuestions[this.currentQuestionIndex];
            this.displays.currentQNum.textContent = this.currentQuestionIndex + 1;
            this.displays.questionText.textContent = q.question;

            this.displays.optionsContainer.innerHTML = '';
            ['A', 'B', 'C', 'D'].forEach(key => {
                if (q.options[key]) {
                    const optionId = `q${this.currentQuestionIndex}-opt${key}`;
                    const wrapper = document.createElement('div');
                    const input = document.createElement('input');
                    input.type = 'radio';
                    input.name = `question-${this.currentQuestionIndex}`;
                    input.id = optionId;
                    input.value = key;
                    input.className = 'hidden';
                    
                    if (this.userAnswers[this.currentQuestionIndex] === key) {
                        input.checked = true;
                    }
                    
                    const label = document.createElement('label');
                    label.htmlFor = optionId;
                    label.className = 'option-label';
                    label.textContent = `${key}. ${q.options[key]}`;

                    wrapper.appendChild(input);
                    wrapper.appendChild(label);
                    this.displays.optionsContainer.appendChild(wrapper);

                    input.addEventListener('change', () => this.saveAnswer());
                }
            });
            
            this.updateNavButtons();
            this.resetQuestionTimer();
            this.updateQuestionNav(); // Cập nhật trạng thái nút điều hướng
        },
        
        saveAnswer() {
            const selectedOption = document.querySelector(`input[name="question-${this.currentQuestionIndex}"]:checked`);
            if(selectedOption) {
                this.userAnswers[this.currentQuestionIndex] = selectedOption.value;
            }
            this.updateQuestionNav(); // Cập nhật trạng thái nút sau khi lưu câu trả lời
        },

        navigateQuestion(direction) {
            this.saveAnswer();
            const newIndex = this.currentQuestionIndex + direction;
            if (newIndex >= 0 && newIndex < this.quizQuestions.length) {
                this.currentQuestionIndex = newIndex;
                this.displayQuestion();
            }
        },
        
        updateNavButtons() {
            this.buttons.prev.disabled = this.currentQuestionIndex === 0;
            this.buttons.prev.classList.toggle('opacity-50', this.buttons.prev.disabled);
            
            if (this.currentQuestionIndex === this.quizQuestions.length - 1) {
                this.buttons.next.style.display = 'none';
                this.buttons.submit.style.display = 'inline-block';
            } else {
                this.buttons.next.style.display = 'inline-block';
                this.buttons.submit.style.display = 'none';
            }
        },
        
        confirmSubmit() {
            this.saveAnswer();
            const unanswered = this.userAnswers.filter(a => a === null).length;
            if (unanswered > 0) {
                 if(!confirm(`Bạn còn ${unanswered} câu chưa trả lời. Bạn có chắc chắn muốn nộp bài không?`)) {
                     return;
                 }
            } else {
                if (!confirm('Bạn có chắc chắn muốn nộp bài không?')) {
                    return;
                }
            }
            this.submitQuiz();
        },

        submitQuiz() {
            this.stopTimers();
            
            let score = 0;
            this.quizQuestions.forEach((q, index) => {
                if (q.answer === this.userAnswers[index]) {
                    score++;
                }
            });

            const result = {
                name: this.inputs.studentName.value.trim(),
                date: new Date().toISOString(),
                score: score,
                totalQuestions: this.quizQuestions.length,
                timeTaken: this.timers.totalSeconds,
                questions: this.quizQuestions,
                userAnswers: this.userAnswers,
            };

            this.saveResult(result);
            this.displayResult(result);
            this.showScreen('result');
        },
        
        // Hiển thị màn hình giải thích (Review Mode)
        showExplanationModal(index) {
            const q = this.quizQuestions[index];
            const userAnswer = this.userAnswers[index];
            
            let optionsHtml = '';
            ['A', 'B', 'C', 'D'].forEach(key => {
                if (q.options[key]) {
                    let classList = 'option-label mt-2 cursor-default';
                    // Tô xanh đáp án đúng
                    if (key === q.answer) {
                        classList += ' correct-answer';
                    }
                    // Tô đỏ nếu người dùng trả lời sai
                    if (key === userAnswer && key !== q.answer) {
                         classList += ' wrong-answer';
                    }
                    optionsHtml += `<div class="${classList}">${key}. ${q.options[key]}</div>`;
                }
            });

            let explanationHtml = '';
            
            // 1. Giải thích đáp án đúng (explanation_right)
            if (q.explanation_right) {
                explanationHtml += `
                    <div class="explanation-box explanation-right">
                        <p class="explanation-title text-green-700">Giải thích đáp án đúng (${q.answer}):</p>
                        <p class="text-sm text-gray-700">${q.explanation_right.replace(/\n/g, '<br>')}</p>
                    </div>
                `;
            }

            // 2. Giải thích đáp án sai (explanation_wrong)
            if (q.explanation_wrong) {
                explanationHtml += `
                    <div class="explanation-box explanation-wrong">
                        <p class="explanation-title text-red-700">Giải thích các phương án sai:</p>
                        <p class="text-sm text-gray-700">${q.explanation_wrong.replace(/\n/g, '<br>')}</p>
                    </div>
                `;
            }
            
            // 3. Bóc phốt đề (explanation_question)
            if (q.explanation_question) {
                explanationHtml += `
                    <div class="explanation-box explanation-question">
                        <p class="explanation-title text-blue-700">Bóc phốt đề (Phân tích cách ra đề):</p>
                        <p class="text-sm text-gray-700">${q.explanation_question.replace(/\n/g, '<br>')}</p>
                    </div>
                `;
            }

            this.displays.modalContentPlaceholder.innerHTML = `
                <div class="flex justify-between items-center border-b pb-2 mb-4">
                    <h3 class="text-xl font-bold text-blue-600">Đáp án và Giải thích (Câu ${index + 1})</h3>
                    <button id="modal-close-btn" class="text-gray-500 hover:text-gray-900 font-bold text-2xl leading-none">&times;</button>
                </div>
                <p class="font-semibold mb-3">${q.question}</p>
                <div class="mb-4">
                    <p class="text-sm text-gray-700 mb-2">
                        Câu trả lời của bạn: <strong>${userAnswer ? userAnswer : 'Chưa trả lời'}</strong>. 
                        Đáp án đúng: <strong class="text-green-700">${q.answer}</strong>
                    </p>
                    ${optionsHtml}
                </div>
                <div class="mt-4 border-t pt-4">
                    ${explanationHtml}
                </div>
            `;
            
            // Add close button event listener
            document.getElementById('modal-close-btn').addEventListener('click', () => this.closeModal());
            
            this.displays.reviewModalBackdrop.classList.add('active');
            
            // Dừng timer khi modal hiện lên
            clearInterval(this.timers.question);
        },
        
        closeModal() {
            this.displays.reviewModalBackdrop.classList.remove('active');
            this.resetQuestionTimer(); // Khởi động lại timer câu hỏi
        },
        
        displayResult(result) {
            const { name, date, score, totalQuestions, timeTaken } = result;
            const percentage = totalQuestions > 0 ? (score / totalQuestions * 100).toFixed(2) : 0;
            const formattedTime = this.formatTime(timeTaken);

            this.displays.resultSummary.innerHTML = `
                <p class="text-lg mb-2">Thí sinh: <span class="font-bold text-blue-600">${name}</span></p>
                <p class="text-4xl font-bold my-4 ${percentage >= 50 ? 'text-green-600' : 'text-red-600'}">
                    ${score} / ${totalQuestions} (${percentage}%)
                </p>
                <div class="flex justify-center space-x-6 text-gray-600">
                     <p>Thời gian làm bài: <strong>${formattedTime}</strong></p>
                     <p>Ngày làm: <strong>${new Date(date).toLocaleString('vi-VN')}</strong></p>
                </div>
            `;
            
            this.displays.resultDetails.innerHTML = '';
            result.questions.forEach((q, index) => {
                const userAnswer = result.userAnswers[index];
                const isCorrect = q.answer === userAnswer;
                
                const card = document.createElement('div');
                card.className = `p-4 border rounded-lg ${isCorrect ? 'border-green-300 bg-green-50' : 'border-red-300 bg-red-50'}`;
                
                let optionsHtml = '';
                ['A', 'B', 'C', 'D'].forEach(key => {
                    if (q.options[key]) {
                        let classList = 'option-label mt-2';
                        if (key === q.answer) {
                            classList += ' correct-answer';
                        }
                        if (key === userAnswer && !isCorrect) {
                            classList += ' wrong-answer';
                        }
                        optionsHtml += `<div class="${classList}">${key}. ${q.options[key]}</div>`;
                    }
                });

                // --- LOGIC CẬP NHẬT TRƯỜNG GIẢI THÍCH MỚI ---
                let explanationHtml = '';
                
                // 1. Giải thích đáp án đúng (explanation_right)
                if (q.explanation_right) {
                    explanationHtml += `
                        <div class="explanation-box explanation-right">
                            <p class="explanation-title text-green-700">Giải thích đáp án đúng (${q.answer}):</p>
                            <p class="text-sm text-gray-700">${q.explanation_right.replace(/\n/g, '<br>')}</p>
                        </div>
                    `;
                }

                // 2. Giải thích đáp án sai (explanation_wrong)
                if (q.explanation_wrong) {
                    explanationHtml += `
                        <div class="explanation-box explanation-wrong">
                            <p class="explanation-title text-red-700">Giải thích các phương án sai:</p>
                            <p class="text-sm text-gray-700">${q.explanation_wrong.replace(/\n/g, '<br>')}</p>
                        </div>
                    `;
                }
                
                // 3. Bóc phốt đề (explanation_question)
                if (q.explanation_question) {
                    explanationHtml += `
                        <div class="explanation-box explanation-question">
                            <p class="explanation-title text-blue-700">Bóc phốt đề (Phân tích cách ra đề):</p>
                            <p class="text-sm text-gray-700">${q.explanation_question.replace(/\n/g, '<br>')}</p>
                        </div>
                    `;
                }
                // --- KẾT THÚC LOGIC CẬP NHẬT ---

                card.innerHTML = `
                    <p class="font-semibold">Câu ${index + 1}: ${q.question}</p>
                    <p class="text-sm text-gray-700 mt-2">
                        Bạn đã chọn: <strong class="${isCorrect ? 'text-green-700' : 'text-red-700'}">${userAnswer ? userAnswer : 'Chưa trả lời'}</strong>. 
                        Đáp án đúng: <strong class="text-green-700">${q.answer}</strong>
                    </p>
                    <div class="mt-3">${optionsHtml}</div>
                    <div class="mt-4 p-3 bg-gray-50 rounded-md">
                        <p class="font-semibold text-sm mb-2">Phân tích chuyên sâu:</p>
                        ${explanationHtml}
                    </div>
                `;
                this.displays.resultDetails.appendChild(card);
            });
        },

        saveResult(result) {
            let history = JSON.parse(localStorage.getItem('quizHistory')) || [];
            history.unshift(result);
            localStorage.setItem('quizHistory', JSON.stringify(history));
        },

        showHistory() {
            const history = JSON.parse(localStorage.getItem('quizHistory')) || [];
            if (history.length === 0) {
                this.displays.historyList.innerHTML = '<p>Chưa có lịch sử làm bài.</p>';
                this.displays.missedQuestionsStats.innerHTML = 'Chưa có dữ liệu.';
                this.showScreen('history');
                return;
            }

            this.displays.historyList.innerHTML = '';
            history.forEach((result, index) => {
                const item = document.createElement('div');
                item.className = 'p-4 border rounded-lg flex justify-between items-center';
                item.innerHTML = `
                    <div>
                        <p class="font-semibold">${result.name}</p>
                        <p class="text-sm text-gray-500">${new Date(result.date).toLocaleString('vi-VN')}</p>
                    </div>
                    <div>
                        <p class="font-bold ${result.score / result.totalQuestions >= 0.5 ? 'text-green-600' : 'text-red-600'}">
                            ${result.score}/${result.totalQuestions}
                        </p>
                    </div>
                    <button data-history-index="${index}" class="view-result-btn px-4 py-2 bg-blue-500 text-white text-sm rounded-lg hover:bg-blue-600">Xem lại</button>
                `;
                this.displays.historyList.appendChild(item);
            });
            
            document.querySelectorAll('.view-result-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const index = e.target.getAttribute('data-history-index');
                    const selectedResult = history[index];
                    if (selectedResult) {
                        this.displayResult(selectedResult);
                        this.showScreen('result');
                    }
                });
            });

            this.calculateStats(history);
            this.showScreen('history');
        },

        calculateStats(history) {
            const missedCounter = {};
            history.forEach(result => {
                result.questions.forEach((q, index) => {
                    if (q.answer !== result.userAnswers[index]) {
                        const questionId = q.id || q.question.slice(0, 50);
                        if (!missedCounter[questionId]) {
                             missedCounter[questionId] = { count: 0, text: q.question };
                        }
                        missedCounter[questionId].count++;
                    }
                });
            });

            const sortedMissed = Object.values(missedCounter).sort((a, b) => b.count - a.count).slice(0, 5);

            if (sortedMissed.length > 0) {
                let statsHtml = '<ul class="list-disc list-inside space-y-2">';
                sortedMissed.forEach(item => {
                    statsHtml += `<li><strong>Sai ${item.count} lần:</strong> ${item.text}</li>`;
                });
                statsHtml += '</ul>';
                this.displays.missedQuestionsStats.innerHTML = statsHtml;
            } else {
                this.displays.missedQuestionsStats.innerHTML = 'Tuyệt vời! Không có câu nào bị sai nhiều lần.';
            }
        },

        // Timer Functions
        startTimers() {
            this.stopTimers();
            this.timers.totalSeconds = 0;
            this.timers.total = setInterval(() => {
                this.timers.totalSeconds++;
                this.displays.totalTimer.textContent = this.formatTime(this.timers.totalSeconds);
            }, 1000);
            this.resetQuestionTimer();
        },
        
        resetQuestionTimer() {
            clearInterval(this.timers.question);
            this.timers.questionSeconds = this.timePerQuestion;
            this.displays.questionTimer.textContent = this.timers.questionSeconds.toString().padStart(2, '0');
            
            this.timers.question = setInterval(() => {
                this.timers.questionSeconds--;
                this.displays.questionTimer.textContent = this.timers.questionSeconds.toString().padStart(2, '0');
                if (this.timers.questionSeconds <= 0) {
                    if (this.currentQuestionIndex === this.quizQuestions.length - 1) {
                        this.submitQuiz(); // Auto-submit on last question
                    } else {
                        this.navigateQuestion(1); // Auto-navigate to next
                    }
                }
            }, 1000);
        },

        stopTimers() {
            clearInterval(this.timers.total);
            clearInterval(this.timers.question);
        },
        
        formatTime(seconds) {
            const mins = Math.floor(seconds / 60).toString().padStart(2, '0');
            const secs = (seconds % 60).toString().padStart(2, '0');
            return `${mins}:${secs}`;
        }
    };
    
    quizApp.init();
});
</script>

</body>
</html>
