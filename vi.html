<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Multi-Pocket Wallet BIDV</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bidv-green: #006B68;
            --bidv-yellow: #FFC62F;
            --text-color: #f0f0f0; /* Light text for dark background */
            --dark-background: #1a1a1a;
            --card-background: #2a2a2a;
            --button-background: #008C89;
            --button-hover: #005A58;
            --balance-positive: #66BB6A; /* Brighter Green for positive balance changes */
            --balance-negative: #EF5350; /* Brighter Red for negative balance changes */
        }

        body {
            font-family: 'Roboto', sans-serif;
            margin: 0;
            background-color: var(--dark-background);
            color: var(--text-color);
            display: flex;
            flex-direction: column;
            min-height: 100vh;
            overflow-x: hidden; /* Prevent horizontal scroll */
        }

        /* App Container for mobile simulation */
        .app-container {
            width: 100%;
            max-width: 400px; /* Typical mobile width */
            margin: 0 auto;
            background-color: var(--bidv-green);
            box-shadow: 0 0 15px rgba(0, 0, 0, 0.5);
            display: flex;
            flex-direction: column;
            flex-grow: 1;
            position: relative; /* For modal positioning */
        }

        /* Header */
        .header {
            padding: 20px 15px;
            text-align: center;
            font-size: 1.5em;
            font-weight: 700;
            color: var(--text-color);
            display: flex; /* Added for logo alignment */
            align-items: center; /* Vertically align items */
            justify-content: center; /* Center content horizontally */
            gap: 10px; /* Space between logo and text */
        }

        .header-logo {
            max-width: 100px; /* Adjusted size for the new logo */
            height: auto; /* Maintain aspect ratio */
            border-radius: 8px; /* Apply rounded corners */
        }

        /* Balance Card */
        .balance-card {
            background-color: var(--bidv-yellow);
            color: var(--bidv-green); /* Darker text for yellow background */
            padding: 20px;
            margin: 0 15px 20px 15px;
            border-radius: 15px;
            text-align: center;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }

        .balance-card .label {
            font-size: 0.9em;
            font-weight: 500;
            margin-bottom: 5px;
            color: rgba(0, 107, 104, 0.8);
        }

        .balance-card .total-balance {
            font-size: 2.5em;
            font-weight: 700;
            margin-bottom: 10px;
        }

        .balance-card .tktt-balance {
            font-size: 1.1em;
            font-weight: 500;
            margin-top: 10px;
            color: var(--bidv-green);
        }

        /* Re-added min-max-balance as per request 1 */
        .balance-card .min-max-balance {
            font-size: 0.8em;
            color: rgba(0, 107, 104, 0.6); 
        }

        /* Pocket List */
        .pocket-list {
            flex-grow: 1;
            padding: 0 15px;
            overflow-y: auto; /* Enable scrolling for pockets */
            margin-bottom: 70px; /* Space for bottom nav */
        }

        .pocket-item {
            background-color: var(--card-background);
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
        }

        /* Specific style for Main Account pocket */
        .pocket-item.main-account-item {
            background-color: var(--bidv-green);
            color: var(--text-color);
        }

        .pocket-info {
            display: flex;
            align-items: center;
            flex-grow: 1;
        }

        .pocket-icon {
            font-size: 1.8em;
            margin-right: 15px;
            width: 40px; /* Fixed width for consistent alignment */
            text-align: center;
        }

        .pocket-details {
            flex-grow: 1;
        }

        .pocket-name {
            font-size: 1.1em;
            font-weight: 500;
            margin-bottom: 5px;
        }

        .pocket-balance {
            font-size: 1.1em;
            font-weight: 700;
            color: var(--text-color);
        }

        .pocket-min-max {
            font-size: 0.8em;
            color: rgba(255, 255, 255, 0.7); /* Lighter text for min/max in green pocket */
            margin-top: 2px;
        }

        .pocket-actions {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .pocket-actions button {
            background-color: var(--button-background);
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.8em;
            font-weight: 500;
            transition: background-color 0.3s ease;
            white-space: nowrap; /* Prevent button text from wrapping */
        }

        .pocket-actions button:hover {
            background-color: var(--button-hover);
        }

        /* Quick Actions */
        .quick-actions {
            padding: 15px;
            margin: 0 15px 20px 15px; /* Adjust margin for spacing */
            display: flex;
            flex-direction: column;
            gap: 10px;
            background-color: #FFC62F; /* Match app background or slightly darker */
            border-radius: 10px;
        }

        .quick-actions button {
            background-color: var(--button-background);
            color: white;
            border: none;
            padding: 15px;
            border-radius: 10px;
            font-size: 1.1em;
            font-weight: 500;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }

        .quick-actions button:hover {
            background-color: var(--button-hover);
        }

        /* Bottom Navigation */
        .bottom-nav {
            background-color: var(--bidv-green);
            display: flex;
            justify-content: space-around;
            padding: 10px 0;
            position: fixed;
            bottom: 0;
            width: 100%;
            max-width: 400px; /* Match app-container width */
            box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.3);
            z-index: 1000;
        }

        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            color: rgba(255, 255, 255, 0.6);
            font-size: 0.8em;
            text-decoration: none;
            padding: 5px 0;
            transition: color 0.3s ease;
        }

        .nav-item.active {
            color: var(--bidv-yellow);
        }

        .nav-item i {
            font-size: 1.5em;
            margin-bottom: 5px;
        }

        /* Modals */
        .modal {
            display: none; /* Hidden by default */
            position: fixed;
            z-index: 2000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0, 0, 0, 0.7);
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background-color: var(--card-background);
            margin: auto;
            padding: 20px;
            border-radius: 15px;
            width: 90%;
            max-width: 350px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.5);
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            padding-bottom: 10px;
            margin-bottom: 15px;
        }

        .modal-header h2 {
            margin: 0;
            font-size: 1.3em;
            color: var(--text-color);
        }

        .modal-close {
            color: rgba(255, 255, 255, 0.5);
            font-size: 1.8em;
            font-weight: bold;
            cursor: pointer;
            transition: color 0.3s ease;
        }

        .modal-close:hover,
        .modal-close:focus {
            color: var(--text-color);
            text-decoration: none;
        }

        .modal label {
            font-size: 0.9em;
            margin-bottom: 5px;
            display: block;
            color: rgba(255, 255, 255, 0.8);
        }

        .modal input[type="text"],
        .modal input[type="number"],
        .modal select,
        .modal textarea {
            width: calc(100% - 20px);
            padding: 10px;
            margin-bottom: 10px;
            border-radius: 8px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            background-color: var(--dark-background);
            color: var(--text-color);
            font-size: 1em;
        }

        /* Ensure text-align for number inputs is right to match currency display */
        .modal input[type="text"][oninput*="formatNumberInput"] {
            text-align: right;
        }


        .modal input[type="range"] {
            width: 100%;
            -webkit-appearance: none;
            height: 8px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.2);
            outline: none;
            opacity: 0.7;
            -webkit-transition: .2s;
            transition: opacity .2s;
        }

        .modal input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: var(--bidv-yellow);
            cursor: pointer;
        }

        .modal input[type="range"]::-moz-range-thumb {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: var(--bidv-yellow);
            cursor: pointer;
        }


        .modal-buttons {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-top: 20px;
        }

        .modal-buttons button {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1em;
            font-weight: 500;
            transition: background-color 0.3s ease;
        }

        .modal-buttons .btn-cancel {
            background-color: #616161;
            color: white;
        }

        .modal-buttons .btn-cancel:hover {
            background-color: #424242;
        }

        .modal-buttons .btn-primary {
            background-color: var(--bidv-yellow);
            color: var(--bidv-green);
        }

        .modal-buttons .btn-primary:hover {
            background-color: #e6b000;
        }

        /* History View Specific Styles */
        .history-list {
            margin-top: 15px;
        }

        .history-item {
            background-color: var(--dark-background);
            border-radius: 10px;
            padding: 10px 15px;
            margin-bottom: 10px;
            display: flex;
            flex-direction: column;
            gap: 5px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.2);
        }

        .history-item .row1 {
            display: flex;
            justify-content: space-between;
            font-weight: 500;
            font-size: 0.95em;
        }

        .history-item .row2 {
            display: flex;
            justify-content: space-between;
            font-size: 0.8em;
            color: rgba(255, 255, 255, 0.7);
        }

        .history-item .row3 {
            font-size: 0.85em;
            color: rgba(255, 255, 255, 0.9);
            margin-top: 5px;
        }

        .history-amount.positive {
            color: var(--balance-positive);
            font-weight: 700;
        }

        .history-amount.negative {
            color: var(--balance-negative);
            font-weight: 700;
        }

        /* Reporting Specific Styles */
        .chart-container {
            width: 100%;
            height: 500px; /* Increased height for charts */
            background-color: white; /* Changed from var(--dark-background) to white */
            border-radius: 10px;
            display: flex;
            justify-content: center;
            align-items: center;
            color: var(--bidv-green); /* Changed from rgba(255, 255, 255, 0.5) to a darker color */
            font-size: 0.9em;
            margin-bottom: 20px;
            padding: 10px; /* Add padding for content */
            box-sizing: border-box; /* Include padding in width/height */
            flex-direction: column; /* Allow content to stack */
            text-align: center;
        }

        .summary-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
            gap: 10px;
            margin-top: 20px;
        }

        .stat-item {
            background-color: var(--dark-background);
            border-radius: 10px;
            padding: 10px;
            text-align: center;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.2);
        }

        .stat-label {
            font-size: 0.8em;
            color: rgba(255, 255, 255, 0.7);
            margin-bottom: 5px;
        }

        .stat-value {
            font-size: 1.1em;
            font-weight: 700;
            color: var(--text-color);
        }

        /* Responsive Adjustments */
        @media (min-width: 600px) {
            .app-container {
                border-radius: 25px;
                overflow: hidden;
                margin-top: 20px;
                margin-bottom: 20px;
            }
        }

        /* Styles for Savings Goal Progress Bar */
        .savings-goal-progress {
            font-size: 0.85em;
            color: rgba(255, 255, 255, 0.8);
            margin-top: 5px;
        }

        .progress-bar-container {
            background-color: #4a4a4a; /* Darker grey for the empty part */
            border-radius: 5px;
            height: 10px;
            margin-top: 5px;
            overflow: hidden;
            width: 100%; /* Ensure it takes full width */
        }

        .progress-bar-fill {
            background-color: var(--bidv-yellow); /* Yellow fill */
            height: 100%;
            border-radius: 5px;
            transition: width 0.5s ease-in-out; /* Smooth transition for width changes */
        }

        /* Flow Settings List Item */
        .flow-setting-item {
            background-color: var(--dark-background);
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 10px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.2);
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
        .flow-setting-item div {
            font-size: 0.9em;
        }
        .flow-setting-item .flow-details {
            font-weight: 500;
            color: var(--text-color);
        }
        .flow-setting-item .flow-cycle {
            font-size: 0.8em;
            color: rgba(255, 255, 255, 0.7);
        }
        .flow-setting-item .flow-actions {
            display: flex;
            gap: 10px;
            margin-top: 10px;
            justify-content: flex-end;
        }
        .flow-setting-item .flow-actions button {
            padding: 5px 10px;
            font-size: 0.8em;
            border-radius: 5px;
        }
    </style>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
</head>
<body>
    <div class="app-container">
        <div class="header">
            <img src="logo.png" alt="BIDV Logo" class="header-logo">
            Multi-Pocket Wallet
        </div>

        <div id="homeScreen" class="screen">
            <div class="balance-card">
                <div class="label">BALANCE</div>
                <div class="total-balance"><span id="totalBalance"></span></div>
                <div class="tktt-balance">Số dư Tài khoản chính: <span id="tkttBalance"></span></div>
                <div class="min-max-balance">Kế hoạch: min <span id="minBalance"></span> / max <span id="maxBalance"></span></div>
            </div>

            <div class="pocket-list" id="pocketList">
                </div>

            <div class="quick-actions">
                <button onclick="openModal('addMoneyModal')">Nạp Tiền</button>
                <button onclick="openModal('transferMoneyModal')">Chuyển Tiền</button>
                <button onclick="openModal('payModal')">Thanh Toán</button>
            </div>
        </div>

        <div id="historyScreen" class="screen" style="display: none;">
            <div class="modal-header">
                <span class="modal-close" onclick="closeModal('historyScreen')">&times;</span>
                <h2 id="historyHeaderTitle">Lịch sử giao dịch</h2>
                <div></div>
            </div>
            <div class="history-list" id="transactionHistoryList">
                </div>
        </div>

        <div id="pocketsScreen" class="screen" style="display: none;">
            <div class="modal-header">
                <span class="modal-close" onclick="closeModal('pocketsScreen')">&times;</span>
                <h2>Quản lý Ngăn Ví</h2>
                <div></div>
            </div>
            <div class="pocket-list" id="managePocketList">
                </div>
            <button class="quick-actions" style="margin: 15px; background-color: #FFC62F;" onclick="openCreatePocketModal()">Thêm Pocket Mới</button>
            <button class="quick-actions" style="margin: 15px; background-color: #FFC62F;" onclick="openModal('allocationSettingsModal')">Cài đặt tỷ lệ phân bổ</button>
            <button class="quick-actions" style="margin: 15px; background-color: #FFC62F;" onclick="openFlowSettingsModal()">Cài đặt dòng tiền</button>
        </div>

        <div id="reportScreen" class="screen" style="display: none;">
            <div class="modal-header">
                <span class="modal-close" onclick="closeModal('reportScreen')">&times;</span>
                <h2>Báo cáo</h2>
                <div></div>
            </div>
            <div style="padding: 15px;">
                <h3>Tỷ trọng số dư các Pocket</h3>
                <div class="chart-container" id="pieChartContainer">
                    <canvas id="pieChartCanvas" style="width: 100%; height: 100%;"></canvas>
                </div>

                <h3>Thu - Chi theo tháng của từng ví</h3>
                <div class="chart-container" id="barChartContainer">
                   <canvas id="barChartCanvas" style="width: 100%; height: 100%;"></canvas>
                </div>

                <div class="summary-stats">
                    <div class="stat-item">
                        <div class="stat-label">Tổng Thu</div>
                        <div class="stat-value"><span id="totalIncome">0</span></div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-label">Tổng Chi</div>
                        <div class="stat-value"><span id="totalExpense">0</span></div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-label">Tổng Tiết kiệm</div>
                        <div class="stat-value"><span id="totalSavings">0</span></div>
                    </div>
                </div>
            </div>
        </div>

        <div id="addMoneyModal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2>Nạp Tiền</h2>
                    <span class="modal-close" onclick="closeModal('addMoneyModal')">&times;</span>
                </div>
                <label for="addMoneySource">Nguồn:</label>
                <input type="text" id="addMoneySource" value="Tài khoản CASA tại BIDV" readonly>

                <label for="addMoneyDestination">Đích:</label>
                <select id="addMoneyDestination">
                    </select>

                <label for="addMoneyAmount">Số tiền:</label>
                <input type="text" id="addMoneyAmount" placeholder="Nhập số tiền" oninput="formatNumberInput(this)">

                <label for="addMoneyNote">Ghi chú:</label>
                <textarea id="addMoneyNote" placeholder="Ghi chú (tùy chọn)"></textarea>

                <div class="modal-buttons">
                    <button class="btn-cancel" onclick="closeModal('addMoneyModal')">Hủy</button>
                    <button class="btn-primary" onclick="executeAddMoney()">Nạp Tiền</button>
                </div>
            </div>
        </div>

        <div id="transferMoneyModal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2>Chuyển Tiền</h2>
                    <span class="modal-close" onclick="closeModal('transferMoneyModal')">&times;</span>
                </div>
                <label for="transferSource">Nguồn:</label>
                <select id="transferSource">
                    </select>

                <label for="transferDestination">Đích:</label>
                <select id="transferDestination">
                    </select>

                <label for="transferAmount">Số tiền:</label>
                <input type="text" id="transferAmount" placeholder="Nhập số tiền" oninput="formatNumberInput(this)">

                <label for="transferNote">Ghi chú:</label>
                <textarea id="transferNote" placeholder="Ghi chú (tùy chọn)"></textarea>

                <div class="modal-buttons">
                    <button class="btn-cancel" onclick="closeModal('transferMoneyModal')">Hủy</button>
                    <button class="btn-primary" onclick="executeTransferMoney()">Chuyển Tiền</button>
                </div>
            </div>
        </div>

        <div id="payModal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2>Thanh Toán</h2>
                    <span class="modal-close" onclick="closeModal('payModal')">&times;</span>
                </div>
                <label for="paySource">Nguồn:</label>
                <input type="text" id="paySource" value="Tài khoản thanh toán chung (TTTK)" readonly>

                <label for="payService">Dịch vụ:</label>
                <select id="payService">
                    <option value="Điện">Điện</option>
                    <option value="Nước">Nước</option>
                    <option value="Điện thoại">Điện thoại</option>
                    <option value="Học phí">Học phí</option>
                    <option value="Khác">Khác</option>
                </select>

                <label for="payAmount">Số tiền:</label>
                <input type="text" id="payAmount" placeholder="Nhập số tiền" oninput="formatNumberInput(this)">

                <label for="payNote">Ghi chú:</label>
                <textarea id="payNote" placeholder="Ghi chú (tùy chọn)"></textarea>

                <div class="modal-buttons">
                    <button class="btn-cancel" onclick="closeModal('payModal')">Hủy</button>
                    <button class="btn-primary" onclick="executePay()">Thanh Toán</button>
                </div>
            </div>
        </div>

        <div id="manageTTTKModal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2>Quản lý Tài khoản thanh toán chung</h2>
                    <span class="modal-close" onclick="closeModal('manageTTTKModal')">&times;</span>
                </div>
                <label for="tttkName">Tên ví:</label>
                <input type="text" id="tttkName" value="Main Account" readonly>

                <label for="tttkMinBalance">Min Balance:</label>
                <input type="text" id="tttkMinBalance" oninput="formatNumberInput(this)">

                <label for="tttkMaxBalance">Max Balance:</label>
                <input type="text" id="tttkMaxBalance" oninput="formatNumberInput(this)">

                <div class="modal-buttons">
                    <button class="btn-cancel" onclick="closeModal('manageTTTKModal')">Hủy</button>
                    <button class="btn-primary" id="saveTTTKSettingsBtn">Lưu</button>
                </div>
            </div>
        </div>

        <div id="createEditPocketModal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2 id="createEditPocketTitle">Tạo Pocket Mới</h2>
                    <span class="modal-close" onclick="closeModal('createEditPocketModal')">&times;</span>
                </div>
                <label for="pocketName">Tên ví:</label>
                <input type="text" id="pocketName" placeholder="Tên Pocket">

                <label for="pocketIcon">Icon (Emoji hoặc Font Awesome class, ví dụ: fa-car):</label>
                <input type="text" id="pocketIcon" placeholder="Ví dụ: 🛒 hoặc fa-car">

                <label for="pocketType">Loại ví:</label>
                <select id="pocketType">
                    <option value="Chi tiêu">Chi tiêu</option>
                    <option value="Tiết kiệm">Tiết kiệm</option>
                    <option value="Đầu tư">Đầu tư</option>
                    <option value="Công nợ">Công nợ</option>
                    <option value="Khác">Khác</option>
                </select>

                <label for="pocketLimit" id="pocketLimitLabel">Hạn mức (tùy chọn):</label>
                <input type="text" id="pocketLimit" placeholder="Nhập hạn mức (nếu có)" oninput="formatNumberInput(this)">

                <div id="savingsGoalFieldsContainer" style="display: none;">
                    <h3>Cài đặt mục tiêu tiết kiệm</h3>
                    <p style="font-size: 0.85em; color: rgba(255, 255, 255, 0.7);">* Vui lòng nhập "Số tiền mục tiêu", "Ngày đạt mục tiêu" và "Chu kỳ nạp tiền". Hệ thống sẽ tự động tính "Số tiền cần nộp mỗi kỳ".</p>

                    <label for="savingsTargetAmount">1 . Số tiền mục tiêu:</label>
                    <input type="text" id="savingsTargetAmount" placeholder="Nhập số tiền mục tiêu" oninput="formatNumberInput(this)">
                    
                    <label for="savingsTargetDate">2 . Ngày đạt mục tiêu:</label>
                    <input type="date" id="savingsTargetDate" onchange="calculateSavingsGoal()">

                    <label for="savingsNumberOfCycles">3 . Chu kỳ nạp tiền:</label>
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <input type="text" id="savingsNumberOfCycles" placeholder="Số kỳ" oninput="formatNumberInput(this)">
                        <select id="savingsDepositCycle" onchange="calculateSavingsGoal()" style="width: auto;">
                            <option value="month">Tháng</m>
                            <option value="day">Ngày</option>
                            <option value="year">Năm</option>
                        </select>
                    </div>
                    
                    <label for="savingsAmountPerCycle">4 . Số tiền cần nộp mỗi kỳ:</label>
                    <input type="text" id="savingsAmountPerCycle" placeholder="Số tiền mỗi kỳ" readonly>
                </div>

                <div class="modal-buttons">
                    <button class="btn-cancel" onclick="closeModal('createEditPocketModal')">Hủy</button>
                    <button class="btn-primary" id="savePocketBtn">Lưu</button>
                </div>
            </div>
        </div>

        <div id="allocationSettingsModal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2>Cài đặt tỷ lệ phân bổ tự động</h2>
                    <span class="modal-close" onclick="closeModal('allocationSettingsModal')">&times;</span>
                </div>

                <h3>Khi TKTT ≤ minBalance (Tự động rút từ các pocket)</h3>
                <div id="minBalanceAllocation" style="display: flex; flex-direction: column; gap: 10px;">
                    </div>
                <p style="font-size: 0.85em; color: rgba(255, 255, 255, 0.7);">Tổng tỷ lệ phải bằng 100%.</p>

                <h3 style="margin-top: 20px;">Khi TKTT ≥ maxBalance (Tự động phân bổ vào các pocket)</h3>
                <div id="maxBalanceAllocation" style="display: flex; flex-direction: column; gap: 10px;">
                    </div>
                <p style="font-size: 0.85em; color: rgba(255, 255, 255, 0.7);">Tổng tỷ lệ phải bằng 100%.</p>

                <div class="modal-buttons">
                    <button class="btn-cancel" onclick="closeModal('allocationSettingsModal')">Hủy</button>
                    <button class="btn-primary" id="saveAllocationSettingsBtn">Lưu Cài đặt</button>
                </div>
            </div>
        </div>

        <div id="flowSettingsModal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2 id="flowSettingsTitle">Cài đặt Dòng tiền</h2>
                    <span class="modal-close" onclick="closeModal('flowSettingsModal')">&times;</span>
                </div>
                <label for="flowSourceAccount">Tài khoản nguồn:</label>
                <select id="flowSourceAccount"></select>

                <label for="flowDestinationAccount">Tài khoản đích:</label>
                <select id="flowDestinationAccount"></select>

                <label for="flowAmount">Số tiền:</label>
                <input type="text" id="flowAmount" placeholder="Nhập số tiền" oninput="formatNumberInput(this)">

                <label for="flowNumberOfCycles">Số kỳ chuyển:</label>
                <div style="display: flex; align-items: center; gap: 10px;">
                    <input type="text" id="flowNumberOfCycles" placeholder="Số kỳ" oninput="formatNumberInput(this)">
                    <select id="flowCycleType" style="width: auto;">
                        <option value="day">Ngày</option>
                        <option value="month">Tháng</option>
                        <option value="year">Năm</option>
                    </select>
                </div>

                <label for="flowExpiryDate">Ngày hết hạn (tùy chọn):</label>
                <input type="date" id="flowExpiryDate">

                <label for="flowNote">Ghi chú:</label>
                <textarea id="flowNote" placeholder="Ghi chú (tùy chọn)"></textarea>

                <div class="modal-buttons">
                    <button class="btn-cancel" onclick="closeModal('flowSettingsModal')">Hủy</button>
                    <button class="btn-primary" id="saveFlowSettingBtn">Lưu</button>
                </div>
                <button class="quick-actions" style="margin-top: 15px; background-color: #008C89;" onclick="openViewFlowSettingsModal()">Xem danh sách cài đặt</button>
            </div>
        </div>

        <div id="viewFlowSettingsModal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2>Danh sách Cài đặt Dòng tiền</h2>
                    <span class="modal-close" onclick="closeModal('viewFlowSettingsModal')">&times;</span>
                </div>
                <div id="flowSettingsList" style="max-height: 400px; overflow-y: auto;">
                    <p style="text-align: center; color: rgba(255,255,255,0.7);">Chưa có cài đặt dòng tiền nào.</p>
                </div>
            </div>
        </div>

        <div id="customAlertDialog" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2 id="alertDialogTitle">Thông báo</h2>
                    <span class="modal-close" onclick="closeModal('customAlertDialog')">&times;</span>
                </div>
                <p id="alertDialogMessage"></p>
                <div class="modal-buttons">
                    <button class="btn-primary" onclick="closeModal('customAlertDialog')">Đóng</button>
                </div>
            </div>
        </div>

        <div id="customConfirmDialog" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2 id="confirmDialogTitle">Xác nhận</h2>
                    <span class="modal-close" onclick="closeModal('customConfirmDialog')">&times;</span>
                </div>
                <p id="confirmDialogMessage"></p>
                <div class="modal-buttons">
                    <button class="btn-cancel" onclick="handleConfirm(false)">Hủy</button>
                    <button class="btn-primary" onclick="handleConfirm(true)">Xác nhận</button>
                </div>
            </div>
        </div>


        <div class="bottom-nav">
            <a href="#" class="nav-item active" id="navHome" onclick="showScreen('homeScreen', this)">
                <i class="fas fa-home"></i>
                <span>Trang Chủ</span>
            </a>
            <a href="#" class="nav-item" id="navHistory" onclick="showScreen('historyScreen', this)">
                <i class="fas fa-history"></i>
                <span>Lịch Sử</span>
            </a>
            <a href="#" class="nav-item" id="navPockets" onclick="showScreen('pocketsScreen', this)">
                <i class="fas fa-wallet"></i>
                <span>Ngăn Ví</span>
            </a>
            <a href="#" class="nav-item" id="navReport" onclick="showScreen('reportScreen', this)">
                <i class="fas fa-chart-bar"></i>
                <span>Báo Cáo</span>
            </a>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        // --- Data Storage and Initialization ---
        let pockets = JSON.parse(localStorage.getItem('pockets')) || [
            { id: 'TTTK', name: 'Main Account', icon: '<i class="fa-solid fa-building-columns"></i>', balance: 1200000, type: 'TTTK', minBalance: 500000, maxBalance: 1500000 },
            { id: 'groceries', name: 'Groceries', icon: '🛒', balance: 500000, type: 'Chi tiêu', limit: 600000 },
            { id: 'savings', name: 'Savings', icon: '💰', balance: 800000, type: 'Tiết kiệm', savingsGoal: { targetAmount: 2000000, amountPerCycle: 200000, depositCycle: 'month', numberOfCycles: 10, targetDate: '2026-03-28' } }, // Added savingsGoal with targetDate
        ];

        let transactions = JSON.parse(localStorage.getItem('transactions')) || [];

        let allocationSettings = JSON.parse(localStorage.getItem('allocationSettings')) || {
            minBalance: {}, // { pocketId: percentage, ... }
            maxBalance: {}  // { pocketId: percentage, ... }
        };

        let flowSettings = JSON.parse(localStorage.getItem('flowSettings')) || []; // New: Flow settings storage

        // Biến toàn cục để lưu trữ instance của Chart.js
        let pieChartInstance = null;
        let barChartInstance = null;

        // --- Utility Functions ---
        function formatCurrency(amount) {
            // Chuyển đổi sang định dạng tiền tệ Việt Nam Đồng (VND)
            return new Intl.NumberFormat('vi-VN', { style: 'currency', currency: 'VND', minimumFractionDigits: 0 }).format(amount);
        }

        // New function to format number input with thousand separators
        function formatNumberInput(inputElement) {
            let value = inputElement.value;
            // Remove all non-digit characters
            value = value.replace(/\D/g, '');
            // Convert to number and format with thousand separators
            if (value) {
                value = parseInt(value).toLocaleString('vi-VN');
            }
            inputElement.value = value;
            
            // If this input is related to savings goal calculation, call it
            if (inputElement.id.includes('savings')) {
                calculateSavingsGoal();
            }
        }

        // Helper function to parse formatted number strings back to integers
        function parseFormattedNumber(formattedString) {
            if (!formattedString) return 0;
            return parseInt(formattedString.replace(/\./g, ''));
        }

        function getCurrentDateTime() {
            const now = new Date();
            return now.toLocaleString('vi-VN', {
                day: '2-digit',
                month: '2-digit',
                year: 'numeric',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit'
            });
        }
        
        function populatePocketSelect(selectId, pocketArray, includeExternalOption = false) {
            const selectElement = document.getElementById(selectId);
            selectElement.innerHTML = ''; // Clear existing options

            pocketArray.forEach(pocket => {
                const option = document.createElement('option');
                option.value = pocket.id;
                option.textContent = pocket.name;
                selectElement.appendChild(option);
            });

            if (includeExternalOption) {
                const externalOption = document.createElement('option');
                externalOption.value = 'CASA_BIDV_EXTERNAL';
                externalOption.textContent = 'Tài khoản CASA bên ngoài BIDV';
                selectElement.appendChild(externalOption);
            }
        }

        function saveToLocalStorage() {
            localStorage.setItem('pockets', JSON.stringify(pockets));
            localStorage.setItem('transactions', JSON.stringify(transactions));
            localStorage.setItem('allocationSettings', JSON.stringify(allocationSettings));
            localStorage.setItem('flowSettings', JSON.stringify(flowSettings)); // New: Save flow settings
            // Call renderHomePage after saving to ensure UI is updated
            renderHomePage(); 
        }

        // --- Rendering Functions ---
        // All rendering functions are defined before being called by other functions
        function renderHomePage() {
            const totalBalanceElem = document.getElementById('totalBalance');
            const tkttBalanceElem = document.getElementById('tkttBalance');
            const minBalanceElem = document.getElementById('minBalance'); // Re-added
            const maxBalanceElem = document.getElementById('maxBalance'); // Re-added
            const pocketListElem = document.getElementById('pocketList');

            let totalBalance = 0;
            let tkttPocket = pockets.find(p => p.id === 'TTTK');

            pocketListElem.innerHTML = ''; // Clear existing pockets

            pockets.forEach(pocket => {
                totalBalance += pocket.balance;

                const pocketItem = document.createElement('div');
                pocketItem.className = 'pocket-item';
                if (pocket.id === 'TTTK') {
                    pocketItem.classList.add('main-account-item'); // Add class for main account styling
                }

                let pocketInfoHTML = `
                    <div class="pocket-info">
                        <span class="pocket-icon">${pocket.icon}</span>
                        <div class="pocket-details">
                            <div class="pocket-name">${pocket.name}</div>
                `;
                
                if (pocket.id === 'TTTK' && tkttPocket) {
                    // Re-added min/max display for TTTK in individual pocket item as per request 1
                    pocketInfoHTML += `<div class="pocket-min-max">Min: ${formatCurrency(tkttPocket.minBalance || 0)} / Max: ${formatCurrency(tkttPocket.maxBalance || 0)}</div>`;
                } else if (pocket.type === 'Tiết kiệm' && pocket.savingsGoal && pocket.savingsGoal.targetAmount !== null && pocket.savingsGoal.targetAmount > 0) {
                    const targetAmount = pocket.savingsGoal.targetAmount;
                    const currentBalance = pocket.balance;
                    const achievementPercentage = Math.min(100, Math.round((currentBalance / targetAmount) * 100)); // Cap at 100%

                    pocketInfoHTML += `
                        <div class="savings-goal-progress">
                            Mục tiêu: ${formatCurrency(targetAmount)} (${achievementPercentage}%)
                            <div class="progress-bar-container">
                                <div class="progress-bar-fill" style="width: ${achievementPercentage}%;"></div>
                            </div>
                        </div>
                    `;
                } else if (pocket.limit !== null) {
                    pocketInfoHTML += `<div class="pocket-min-max">Hạn mức: ${formatCurrency(pocket.limit)}</div>`;
                }
                pocketInfoHTML += `
                        </div>
                    </div>
                    <div class="pocket-balance">${formatCurrency(pocket.balance)}</div>
                    <div class="pocket-actions">
                        <button onclick="showHistory('${pocket.id}')">Lịch sử</button>
                    </div>
                `;
                pocketItem.innerHTML = pocketInfoHTML;
                pocketListElem.appendChild(pocketItem);
            });

            totalBalanceElem.textContent = formatCurrency(totalBalance);
            tkttBalanceElem.textContent = formatCurrency(tkttPocket.balance);
            // Re-added updating minBalanceElem and maxBalanceElem as per request 1
            minBalanceElem.textContent = formatCurrency(tkttPocket.minBalance);
            maxBalanceElem.textContent = formatCurrency(tkttPocket.maxBalance);

            // Populate dropdowns for modals
            populatePocketSelect('addMoneyDestination', pockets, false);
            populatePocketSelect('transferSource', pockets, false);
            populatePocketSelect('transferDestination', pockets, true);
        }

        function renderManagePocketList() {
            const managePocketListElem = document.getElementById('managePocketList');
            managePocketListElem.innerHTML = ''; // Clear existing pockets

            pockets.forEach(pocket => {
                const pocketItem = document.createElement('div');
                pocketItem.className = 'pocket-item';
                if (pocket.id === 'TTTK') {
                    pocketItem.classList.add('main-account-item');
                }

                let pocketActionsHTML = '';
                if (pocket.id === 'TTTK') {
                    // For TTTK, we specifically open the manageTTTKModal
                    pocketActionsHTML = `<button onclick="openEditPocket('TTTK')">Quản lý</button>`;
                } else {
                    pocketActionsHTML = `
                        <button onclick="openEditPocket('${pocket.id}')">Sửa</button>
                        <button onclick="deletePocket('${pocket.id}')">Xóa</button>
                    `;
                }

                pocketItem.innerHTML = `
                    <div class="pocket-info">
                        <span class="pocket-icon">${pocket.icon}</span>
                        <div class="pocket-details">
                            <div class="pocket-name">${pocket.name}</div>
                        </div>
                    </div>
                    <div class="pocket-actions">
                        ${pocketActionsHTML}
                    </div>
                `;
                managePocketListElem.appendChild(pocketItem);
            });
        }

        function renderTransactionHistory(filterPocketId = null) {
            const transactionHistoryListElem = document.getElementById('transactionHistoryList');
            transactionHistoryListElem.innerHTML = '';
            const historyHeaderTitle = document.getElementById('historyHeaderTitle');

            // Filter transactions based on the provided pocketId
            const filteredTransactions = transactions.filter(t => {
                if (!filterPocketId) {
                    return true; // Show all if no filter
                }

                // If a filterPocketId is provided, filter based on specific logic for each type
                if (t.type === 'Nạp') {
                    return t.destinationId === filterPocketId;
                } else if (t.type === 'Thanh Toán') {
                    return t.sourceId === filterPocketId;
                } else if (t.type === 'Chuyển nội bộ' || t.type === 'InternalTransfer' || t.type === 'Dòng tiền tự động') {
                    return t.sourceId === filterPocketId || t.destinationId === filterPocketId;
                } else if (t.type === 'Chuyển ra ngoài') {
                    return t.sourceId === filterPocketId;
                } else if (t.type === 'Phân bổ tự động') { // TTTK -> other pocket
                    return t.sourceId === filterPocketId || t.destinationId === filterPocketId; 
                } else if (t.type === 'Phân bổ tự động (rút)') { // other pocket -> TTTK (compensation)
                    return t.sourceId === filterPocketId || t.destinationId === filterPocketId; 
                }
                return false; // By default, hide unknown transaction types
            });

            if (filterPocketId) {
                const pocket = pockets.find(p => p.id === filterPocketId);
                historyHeaderTitle.textContent = `Lịch sử giao dịch của ${pocket ? pocket.name : 'không xác định'}`;
            } else {
                historyHeaderTitle.textContent = 'Lịch sử giao dịch chung';
            }


            if (filteredTransactions.length === 0) {
                transactionHistoryListElem.innerHTML = '<p style="text-align: center; margin-top: 20px; color: rgba(255,255,255,0.7);">Chưa có giao dịch nào.</p>';
                return;
            }

            filteredTransactions.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp)); // Sort by newest first

            filteredTransactions.forEach(t => {
                let amountClass = '';
                let displayAmount = '';
                let transactionDescription = t.type;

                // Determine amount class and display based on transaction type and filterPocketId
                if (t.type === 'Nạp') {
                    amountClass = 'positive';
                    displayAmount = `+${formatCurrency(t.amount)}`;
                    transactionDescription = `Nạp tiền vào ví ${t.destinationName}`;
                } else if (t.type === 'Thanh Toán') {
                    amountClass = 'negative';
                    displayAmount = `-${formatCurrency(t.amount)}`;
                    transactionDescription = `Thanh toán ${t.destinationName}`;
                } else if (t.type === 'Chuyển nội bộ') {
                    if (t.sourceId === filterPocketId) { // Money out from filtered pocket
                        amountClass = 'negative';
                        displayAmount = `-${formatCurrency(t.amount)}`;
                        transactionDescription = `Chuyển tiền từ ${t.sourceName} đến ${t.destinationName}`;
                    } else if (t.destinationId === filterPocketId) { // Money in to filtered pocket
                        amountClass = 'positive';
                        displayAmount = `+${formatCurrency(t.amount)}`;
                        transactionDescription = `Chuyển tiền từ ${t.sourceName} đến ${t.destinationName}`;
                    } else { // If not filtered by a specific pocket, show as a general transfer
                        displayAmount = formatCurrency(t.amount); // No +/- for general view
                        transactionDescription = `Chuyển tiền từ ${t.sourceName} đến ${t.destinationName}`;
                    }
                } else if (t.type === 'Chuyển ra ngoài') {
                     amountClass = 'negative';
                     displayAmount = `-${formatCurrency(t.amount)}`;
                     transactionDescription = `Chuyển tiền ra ngoài từ ${t.sourceName} đến ${t.destinationName}`;
                } else if (t.type === 'Phân bổ tự động') { // TTTK -> other pocket
                    if (t.destinationId === filterPocketId) { // If the filtered pocket is receiving money
                        amountClass = 'positive';
                        displayAmount = `+${formatCurrency(t.amount)}`;
                        transactionDescription = `Phân bổ tự động từ ${t.sourceName} vào ví ${t.destinationName}`;
                    } else if (t.sourceId === filterPocketId) { // If the filtered pocket is sending money (TTTK)
                        amountClass = 'negative';
                        displayAmount = `-${formatCurrency(t.amount)}`;
                        transactionDescription = `Phân bổ tự động từ ${t.sourceName} đến ví ${t.destinationName}`;
                    } else { // General view
                        displayAmount = formatCurrency(t.amount);
                        transactionDescription = `Phân bổ tự động từ ${t.sourceName} đến ví ${t.destinationName}`;
                    }
                } else if (t.type === 'Phân bổ tự động (rút)') { // other pocket -> TTTK (compensation)
                    if (t.destinationId === filterPocketId) { // If the filtered pocket is receiving money (e.g., TTTK)
                        amountClass = 'positive';
                        displayAmount = `+${formatCurrency(t.amount)}`;
                        transactionDescription = `Nhận bù đắp từ ${t.sourceName}`; // More descriptive for TTTK
                    } else if (t.sourceId === filterPocketId) { // If the filtered pocket is sending money (e.g., Groceries)
                        amountClass = 'negative';
                        displayAmount = `-${formatCurrency(t.amount)}`;
                        transactionDescription = `Bù đắp cho ${t.destinationName}`; // More descriptive for source pocket
                    } else { // General view
                        displayAmount = formatCurrency(t.amount);
                        transactionDescription = `Bù đắp tự động từ ${t.sourceName} đến ${t.destinationName}`;
                    }
                }
                else if (t.type === 'Bù đắp tự động') {
                    amountClass = 'negative';
                    displayAmount = `-${formatCurrency(t.amount)}`;
                    transactionDescription = `Bù đắp tự động từ ${t.sourceName} đến ${t.destinationName}`;
                } else if (t.type === 'InternalTransfer') {
                    if (t.sourceId === filterPocketId) {
                        amountClass = 'negative';
                        displayAmount = `-${formatCurrency(t.amount)}`;
                    } else if (t.destinationId === filterPocketId) {
                        amountClass = 'positive';
                        displayAmount = `+${formatCurrency(t.amount)}`;
                    } else { // General view
                        displayAmount = formatCurrency(t.amount);
                    }
                    transactionDescription = `Chuyển nội bộ: ${t.note}`;
                } else if (t.type === 'Dòng tiền tự động') { // New transaction type for flow settings
                     if (t.sourceId === filterPocketId) {
                        amountClass = 'negative';
                        displayAmount = `-${formatCurrency(t.amount)}`;
                    } else if (t.destinationId === filterPocketId) {
                        amountClass = 'positive';
                        displayAmount = `+${formatCurrency(t.amount)}`;
                    } else { // General view
                        displayAmount = formatCurrency(t.amount);
                    }
                    transactionDescription = `Dòng tiền tự động: ${t.note || `Chuyển từ ${t.sourceName} đến ${t.destinationName}`}`;
                }


                const item = document.createElement('div');
                item.className = 'history-item';
                item.innerHTML = `
                    <div class="row1">
                        <span>${transactionDescription}</span>
                        <span class="history-amount ${amountClass}">${displayAmount}</span>
                    </div>
                    <div class="row2">
                        <span>${t.note || 'Không có ghi chú'}</span>
                        <span>${t.timestamp}</span>
                    </div>
                `;
                transactionHistoryListElem.appendChild(item);
            });
        }


        function renderAllocationSettings() {
            const minAllocationDiv = document.getElementById('minBalanceAllocation');
            const maxAllocationDiv = document.getElementById('maxBalanceAllocation');
            minAllocationDiv.innerHTML = '';
            maxAllocationDiv.innerHTML = '';

            const userPockets = pockets.filter(p => p.id !== 'TTTK');

            if (userPockets.length === 0) {
                minAllocationDiv.innerHTML = '<p style="text-align: center; color: rgba(255,255,255,0.7);">Hãy tạo thêm Pocket để cài đặt tỷ lệ phân bổ.</p>';
                maxAllocationDiv.innerHTML = '<p style="text-align: center; color: rgba(255,255,255,0.7);">Hãy tạo thêm Pocket để cài đặt tỷ lệ phân bổ.</p>';
                return;
            }

            userPockets.forEach(pocket => {
                const minAlloc = allocationSettings.minBalance[pocket.id] !== undefined ? allocationSettings.minBalance[pocket.id] : 0;
                const maxAlloc = allocationSettings.maxBalance[pocket.id] !== undefined ? allocationSettings.maxBalance[pocket.id] : 0;

                minAllocationDiv.innerHTML += `
                    <div>
                        <label>${pocket.name} (%): <span id="minAllocValue-${pocket.id}">${minAlloc}</span>%</label>
                        <input type="range" min="0" max="100" value="${minAlloc}" class="allocation-slider" data-pocket-id="${pocket.id}" data-type="minBalance" oninput="updateAllocationValue(this)">
                    </div>
                `;
                maxAllocationDiv.innerHTML += `
                    <div>
                        <label>${pocket.name} (%): <span id="maxAllocValue-${pocket.id}">${maxAlloc}</span>%</label>
                        <input type="range" min="0" max="100" value="${maxAlloc}" class="allocation-slider" data-pocket-id="${pocket.id}" data-type="maxBalance" oninput="updateAllocationValue(this)">
                    </div>
                `;
            });
        }

        function updateReportStats() {
            let totalIncome = 0;
            let totalExpense = 0;
            let totalSavings = 0;

            transactions.forEach(t => {
                if (t.type === 'Nạp') {
                    totalIncome += t.amount;
                } else if (t.type === 'Thanh Toán') {
                    totalExpense += t.amount;
                } else if (t.type === 'Chuyển nội bộ' || t.type === 'Chuyển' || t.type === 'Dòng tiền tự động') { // Include internal transfers and flow settings for savings
                    // Check if it's a transfer *into* a savings pocket
                    const destPocket = pockets.find(p => p.id === t.destinationId);
                    if (destPocket && destPocket.type === 'Tiết kiệm') {
                        totalSavings += t.amount;
                    }
                }
                // For internal transfers (when deleting pockets), we don't count them as income/expense/savings here
            });

            document.getElementById('totalIncome').textContent = formatCurrency(totalIncome);
            document.getElementById('totalExpense').textContent = formatCurrency(totalExpense);
            document.getElementById('totalSavings').textContent = formatCurrency(totalSavings);
        }

        // Color palette for pockets
        const POCKET_COLORS = [
            '#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF', '#FF9F40', '#E7E9ED',
            '#A1F0C0', '#FFD700', '#8A2BE2', '#00CED1', '#FF4500', '#7FFF00', '#DAA520',
            '#ADFF2F', '#BA55D3', '#B0C4DE', '#F08080', '#20B2AA', '#87CEEB', '#DDA0DD'
        ];

        // Helper function to lighten or darken a color (simple version)
        function lightenDarkenColor(col, amt) {
            var usePound = false;
            if (col[0] == "#") {
                col = col.slice(1);
                usePound = true;
            }
            var num = parseInt(col, 16);
            var r = (num >> 16) + amt;
            if (r > 255) r = 255;
            else if (r < 0) r = 0;
            var b = ((num >> 8) & 0x00FF) + amt;
            if (b > 255) b = 255;
            else if (b < 0) b = 0;
            var g = (num & 0x0000FF) + amt;
            if (g > 255) g = 255;
            else if (g < 0) g = 0;
            return (usePound ? "#" : "") + (g | (b << 8) | (r << 16)).toString(16).padStart(6, '0'); // padStart to ensure 6 digits
        }

        function calculatePocketMonthlyFlows() {
            const monthlyFlows = {}; // { 'MM/YYYY': { 'pocketId': { income: 0, expense: 0 }, ... }, ... }
            const uniqueMonths = new Set();

            transactions.forEach(t => {
                const date = new Date(t.timestamp.replace(/(\d{2})\/(\d{2})\/(\d{4})/, '$2/$1/$3'));
                const monthYear = `${(date.getMonth() + 1).toString().padStart(2, '0')}/${date.getFullYear()}`;
                uniqueMonths.add(monthYear);

                if (!monthlyFlows[monthYear]) {
                    monthlyFlows[monthYear] = {};
                }

                // Ensure all pockets are initialized for the current month
                pockets.forEach(p => {
                    if (!monthlyFlows[monthYear][p.id]) {
                        monthlyFlows[monthYear][p.id] = { income: 0, expense: 0 };
                    }
                });

                // Aggregate income/expense for relevant pockets
                if (t.type === 'Nạp') {
                    if (monthlyFlows[monthYear][t.destinationId]) {
                        monthlyFlows[monthYear][t.destinationId].income += t.amount;
                    }
                } else if (t.type === 'Thanh Toán') {
                    if (monthlyFlows[monthYear][t.sourceId]) {
                        monthlyFlows[monthYear][t.sourceId].expense += t.amount;
                    }
                } else if (t.type === 'Chuyển nội bộ' || t.type === 'InternalTransfer' || t.type === 'Dòng tiền tự động') {
                    if (monthlyFlows[monthYear][t.sourceId]) {
                        monthlyFlows[monthYear][t.sourceId].expense += t.amount;
                    }
                    if (monthlyFlows[monthYear][t.destinationId]) {
                        monthlyFlows[monthYear][t.destinationId].income += t.amount;
                    }
                } else if (t.type === 'Chuyển ra ngoài') {
                    if (monthlyFlows[monthYear][t.sourceId]) {
                        monthlyFlows[monthYear][t.sourceId].expense += t.amount;
                    }
                } else if (t.type === 'Phân bổ tự động') {
                    if (monthlyFlows[monthYear][t.sourceId]) {
                        monthlyFlows[monthYear][t.sourceId].expense += t.amount;
                    }
                    if (monthlyFlows[monthYear][t.destinationId]) {
                        monthlyFlows[monthYear][t.destinationId].income += t.amount;
                    }
                } else if (t.type === 'Phân bổ tự động (rút)') {
                    if (monthlyFlows[monthYear][t.sourceId]) {
                        monthlyFlows[monthYear][t.sourceId].expense += t.amount;
                    }
                    if (monthlyFlows[monthYear][t.destinationId]) {
                        monthlyFlows[monthYear][t.destinationId].income += t.amount;
                    }
                }
            });

            const sortedMonths = Array.from(uniqueMonths).sort((a, b) => {
                const [monthA, yearA] = a.split('/').map(Number);
                const [monthB, yearB] = b.split('/').map(Number);
                return (yearA - yearB) * 12 + (monthA - monthB);
            });

            return { monthlyFlows, sortedMonths };
        }

        function renderReport() {
            updateReportStats(); // Update summary stats

            // Render Pie Chart for Pocket Balances
            const pieCtx = document.getElementById('pieChartCanvas').getContext('2d');
            if (pieChartInstance) {
                pieChartInstance.destroy(); // Destroy existing chart instance
            }

            const pocketNames = pockets.map(p => p.name);
            const pocketBalances = pockets.map(p => p.balance);
            const backgroundColors = [
                '#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF', '#FF9F40', '#E7E9ED'
            ]; // Example colors

            pieChartInstance = new Chart(pieCtx, {
                type: 'pie',
                data: {
                    labels: pocketNames,
                    datasets: [{
                        data: pocketBalances,
                        backgroundColor: backgroundColors.slice(0, pockets.length),
                        hoverOffset: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            labels: {
                                color: 'var(--bidv-green)' // Set legend text color to dark green
                            }
                        },
                        title: {
                            display: true,
                            text: 'Tỷ trọng số dư các Pocket',
                            color: 'var(--bidv-green)' // Set title color to dark green
                        }
                    }
                }
            });

            // Render Bar Chart for Monthly Income/Expense per Pocket
            const barCtx = document.getElementById('barChartCanvas').getContext('2d');
            if (barChartInstance) {
                barChartInstance.destroy(); // Destroy existing chart instance
            }

            const { monthlyFlows, sortedMonths } = calculatePocketMonthlyFlows();

            const datasets = [];
            
            pockets.forEach((pocket, index) => {
                const baseColor = POCKET_COLORS[index % POCKET_COLORS.length];
                const incomeColor = baseColor;
                const expenseColor = lightenDarkenColor(baseColor, -30); // Darken for expense

                const incomeData = sortedMonths.map(month => (monthlyFlows[month] && monthlyFlows[month][pocket.id] ? monthlyFlows[month][pocket.id].income : 0));
                const expenseData = sortedMonths.map(month => (monthlyFlows[month] && monthlyFlows[month][pocket.id] ? monthlyFlows[month][pocket.id].expense : 0));

                // Only add dataset if there's actual data for it
                if (incomeData.some(val => val > 0)) {
                    datasets.push({
                        label: `${pocket.name} (Thu)`,
                        data: incomeData,
                        backgroundColor: incomeColor,
                        borderColor: incomeColor,
                        borderWidth: 1,
                        barPercentage: 0.8, // Control width of individual bars
                        categoryPercentage: 0.8 // Control spacing between groups of bars
                    });
                }

                if (expenseData.some(val => val > 0)) {
                    datasets.push({
                        label: `${pocket.name} (Chi)`,
                        data: expenseData,
                        backgroundColor: expenseColor,
                        borderColor: expenseColor,
                        borderWidth: 1,
                        barPercentage: 0.8,
                        categoryPercentage: 0.8
                    });
                }
            });

            barChartInstance = new Chart(barCtx, {
                type: 'bar',
                data: {
                    labels: sortedMonths,
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            labels: {
                                color: 'var(--bidv-green)' // Set legend text color to dark green
                            }
                        },
                        title: {
                            display: true,
                            text: 'Thu - Chi theo tháng của từng ví',
                            color: 'var(--bidv-green)' // Set title color to dark green
                        }
                    },
                    scales: {
                        x: {
                            ticks: {
                                color: 'var(--bidv-green)' // X-axis label color to dark green
                            },
                            grid: {
                                color: 'rgba(0, 0, 0, 0.1)' // X-axis grid color to light black
                            }
                        },
                        y: {
                            ticks: {
                                color: 'var(--bidv-green)', // Y-axis label color to dark green
                                callback: function(value) {
                                    return formatCurrency(value); // Format Y-axis labels
                                }
                            },
                            grid: {
                                color: 'rgba(0, 0, 0, 0.1)' // Y-axis grid color to light black
                            }
                        }
                    }
                }
            });
        }

        // --- Modal & Screen Management ---
        let currentScreen = 'homeScreen';
        let currentNavActive = 'navHome';

        // Global callback for confirm dialog
        let _onConfirmCallback = null; 

        function showScreen(screenId, navElement = null) {
            document.querySelectorAll('.screen').forEach(screen => {
                screen.style.display = 'none';
            });
            document.getElementById(screenId).style.display = 'block';
            currentScreen = screenId;

            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active');
            });
            if (navElement) {
                navElement.classList.add('active');
                currentNavActive = navElement.id;
            }

            // Re-render content when screen is shown
            if (screenId === 'homeScreen') {
                renderHomePage();
            } else if (screenId === 'historyScreen') {
                // Removed unconditional call to renderTransactionHistory() here
                // as showHistory(pocketId) already handles rendering with the filter.
            } else if (screenId === 'pocketsScreen') {
                renderManagePocketList();
            } else if (screenId === 'reportScreen') {
                renderReport();
            }
        }

        function goHomeFromHistory() {
            showScreen('homeScreen', document.getElementById('navHome'));
        }

        function goHomeFromPockets() {
            showScreen('homeScreen', document.getElementById('navHome'));
        }

        function goHomeFromReport() {
            showScreen('homeScreen', document.getElementById('navHome'));
        }

        // --- Modal Control ---
        function openModal(modalId) {
            const modal = document.getElementById(modalId);
            modal.style.display = 'flex';

            // Populate dropdowns for Add/Transfer money
            if (modalId === 'addMoneyModal') {
                populatePocketSelect('addMoneyDestination', pockets, false); // All internal pockets can be destination
                // Clear and format input
                document.getElementById('addMoneyAmount').value = '';
                document.getElementById('addMoneyNote').value = '';
            } else if (modalId === 'transferMoneyModal') {
                populatePocketSelect('transferSource', pockets, false); // All internal pockets can be source
                populatePocketSelect('transferDestination', pockets, true); // All internal pockets + external can be destination
                // Clear and format input
                document.getElementById('transferAmount').value = '';
                document.getElementById('transferNote').value = '';
            } else if (modalId === 'payModal') {
                document.getElementById('payAmount').value = '';
                document.getElementById('payNote').value = '';
            } else if (modalId === 'allocationSettingsModal') {
                renderAllocationSettings();
            } else if (modalId === 'manageTTTKModal') { // Populate for manage TTTK modal
                const tttkPocket = pockets.find(p => p.id === 'TTTK');
                if (tttkPocket) {
                    document.getElementById('tttkMinBalance').value = tttkPocket.minBalance ? tttkPocket.minBalance.toLocaleString('vi-VN') : '';
                    document.getElementById('tttkMaxBalance').value = tttkPocket.maxBalance ? tttkPocket.maxBalance.toLocaleString('vi-VN') : '';
                }
            } else if (modalId === 'flowSettingsModal') { // New: Flow settings modal
                populatePocketSelect('flowSourceAccount', pockets, false);
                populatePocketSelect('flowDestinationAccount', pockets, true);
                document.getElementById('flowAmount').value = '';
                document.getElementById('flowNumberOfCycles').value = '';
                document.getElementById('flowCycleType').value = 'month'; // Default
                document.getElementById('flowNote').value = '';
                document.getElementById('flowExpiryDate').value = ''; // Clear expiry date for new entry
                document.getElementById('flowSettingsModal').dataset.editId = ''; // Clear edit ID for new entry
            } else if (modalId === 'viewFlowSettingsModal') { // New: View flow settings modal
                renderFlowSettingsList();
            }
        }

        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
            // If closing a screen modal, navigate back to home screen
            if (modalId === 'historyScreen' || modalId === 'pocketsScreen' || modalId === 'reportScreen') {
                showScreen('homeScreen', document.getElementById('navHome'));
            }
        }

        // Custom Alert/Confirm functions
        function showAlert(message, title = 'Thông báo') {
            document.getElementById('alertDialogTitle').textContent = title;
            document.getElementById('alertDialogMessage').textContent = message;
            openModal('customAlertDialog');
        }

        function showConfirm(message, onConfirm, title = 'Xác nhận') {
            document.getElementById('confirmDialogTitle').textContent = title;
            document.getElementById('confirmDialogMessage').textContent = message;
            _onConfirmCallback = onConfirm;
            openModal('customConfirmDialog');
        }

        function handleConfirm(isConfirmed) {
            closeModal('customConfirmDialog');
            if (_onConfirmCallback) {
                _onConfirmCallback(isConfirmed);
                _onConfirmCallback = null; // Clear callback
            }
        }

        // Hàm khởi tạo cài đặt phân bổ mặc định hoặc cập nhật khi có thay đổi pockets
        function initializeAllocationSettings() {
            const userPockets = pockets.filter(p => p.id !== 'TTTK');
            const newMinBalanceAlloc = {};
            const newMaxBalanceAlloc = {};

            if (userPockets.length === 0) {
                allocationSettings.minBalance = {};
                allocationSettings.maxBalance = {};
                return;
            }

            // Process minBalance allocations
            let currentMinTotal = 0;
            userPockets.forEach(pocket => {
                newMinBalanceAlloc[pocket.id] = allocationSettings.minBalance[pocket.id] !== undefined ? allocationSettings.minBalance[pocket.id] : 0;
                currentMinTotal += newMinBalanceAlloc[pocket.id];
            });

            if (currentMinTotal !== 100) {
                if (currentMinTotal === 0) { // If all are zero, distribute evenly
                    const defaultPercent = Math.floor(100 / userPockets.length);
                    userPockets.forEach((pocket, index) => {
                        newMinBalanceAlloc[pocket.id] = (index === userPockets.length - 1) ? (100 - (defaultPercent * (userPockets.length - 1))) : defaultPercent;
                    });
                } else { // If sum is not 100 but not zero, redistribute proportionally
                    let sumOfExistingNonZero = 0;
                    userPockets.forEach(p => {
                        sumOfExistingNonZero += newMinBalanceAlloc[p.id];
                    });

                    userPockets.forEach(p => {
                        if (sumOfExistingNonZero > 0) {
                            newMinBalanceAlloc[p.id] = Math.round((newMinBalanceAlloc[p.id] / sumOfExistingNonZero) * 100);
                        } else { // Fallback if all were zero initially
                             newMinBalanceAlloc[p.id] = Math.floor(100 / userPockets.length);
                        }
                    });

                    // Adjust for rounding errors
                    let finalSum = 0;
                    userPockets.forEach(p => finalSum += newMinBalanceAlloc[p.id]);
                    let roundDiff = 100 - finalSum;
                    let i = 0;
                    while (roundDiff !== 0 && i < userPockets.length) {
                        const p = userPockets[i];
                        if (roundDiff > 0 && newMinBalanceAlloc[p.id] < 100) {
                            newMinBalanceAlloc[p.id]++;
                            roundDiff--;
                        } else if (roundDiff < 0 && newMinBalanceAlloc[p.id] > 0) {
                            newMinBalanceAlloc[p.id]--;
                            roundDiff++;
                        }
                        i++;
                        if (i === userPockets.length && roundDiff !== 0) i = 0; // Loop if needed
                    }
                }
            }


            // Process maxBalance allocations (similar logic)
            let currentMaxTotal = 0;
            userPockets.forEach(pocket => {
                newMaxBalanceAlloc[pocket.id] = allocationSettings.maxBalance[pocket.id] !== undefined ? allocationSettings.maxBalance[pocket.id] : 0;
                currentMaxTotal += newMaxBalanceAlloc[pocket.id];
            });

            if (currentMaxTotal !== 100) {
                if (currentMaxTotal === 0) {
                    const defaultPercent = Math.floor(100 / userPockets.length);
                    userPockets.forEach((pocket, index) => {
                        newMaxBalanceAlloc[pocket.id] = (index === userPockets.length - 1) ? (100 - (defaultPercent * (userPockets.length - 1))) : defaultPercent;
                    });
                } else {
                    let sumOfExistingNonZero = 0;
                    userPockets.forEach(p => {
                        sumOfExistingNonZero += newMaxBalanceAlloc[p.id];
                    });

                    userPockets.forEach(p => {
                        if (sumOfExistingNonZero > 0) {
                            newMaxBalanceAlloc[p.id] = Math.round((newMaxBalanceAlloc[p.id] / sumOfExistingNonZero) * 100);
                        } else {
                             newMaxBalanceAlloc[p.id] = Math.floor(100 / userPockets.length);
                        }
                    });

                    let finalSum = 0;
                    userPockets.forEach(p => finalSum += newMaxBalanceAlloc[p.id]);
                    let roundDiff = 100 - finalSum;
                    let i = 0;
                    while (roundDiff !== 0 && i < userPockets.length) {
                        const p = userPockets[i];
                        if (roundDiff > 0 && newMaxBalanceAlloc[p.id] < 100) {
                            newMaxBalanceAlloc[p.id]++;
                            roundDiff--;
                        } else if (roundDiff < 0 && newMaxBalanceAlloc[p.id] > 0) {
                            newMaxBalanceAlloc[p.id]--;
                            roundDiff++;
                        }
                        i++;
                        if (i === userPockets.length && roundDiff !== 0) i = 0;
                    }
                }
            }

            allocationSettings.minBalance = newMinBalanceAlloc;
            allocationSettings.maxBalance = newMaxBalanceAlloc;

            saveToLocalStorage();
        }

        function updateAllocationValue(slider) {
            const pocketId = slider.dataset.pocketId;
            const type = slider.dataset.type; // 'minBalance' or 'maxBalance'
            
            // Tìm phần tử label là sibling trước đó của slider
            const labelElement = slider.previousElementSibling;
            // Tìm phần tử span bên trong label đó
            const valueSpan = labelElement ? labelElement.querySelector('span') : null;

            if (!valueSpan) {
                console.error(`Lỗi: Không tìm thấy span cho pocketId: ${pocketId}, type: ${type}`);
                return; // Thoát nếu không tìm thấy phần tử
            }

            let newValue = parseInt(slider.value);
            valueSpan.textContent = newValue;

            // Lấy đối tượng phân bổ hiện tại (ví dụ: allocationSettings.minBalance)
            const currentAllocationMap = allocationSettings[type];
            const userPockets = pockets.filter(p => p.id !== 'TTTK');

            // Đặt giá trị mới cho ví vừa thay đổi
            currentAllocationMap[pocketId] = newValue;

            // Tính tổng tất cả các phân bổ hiện tại
            let currentTotal = 0;
            userPockets.forEach(p => {
                currentTotal += currentAllocationMap[p.id] || 0;
            });

            // Nếu tổng không phải 100%, phân bổ lại
            if (currentTotal !== 100) {
                let remainingPercentage = 100 - newValue; // Phần trăm còn lại cho các ví khác
                let sumOfOtherPocketsCurrent = 0;

                // Tính tổng phân bổ hiện tại của *các ví khác* (trừ ví vừa thay đổi)
                userPockets.forEach(p => {
                    if (p.id !== pocketId) {
                        sumOfOtherPocketsCurrent += currentAllocationMap[p.id] || 0;
                    }
                });

                if (sumOfOtherPocketsCurrent === 0) {
                    // Nếu tất cả các ví khác hiện đang là 0, và có các ví khác để phân bổ
                    if (remainingPercentage > 0 && userPockets.length > 1) {
                        const numOtherPockets = userPockets.length - 1;
                        const baseAmountPerOther = Math.floor(remainingPercentage / numOtherPockets);
                        let remainder = remainingPercentage % numOtherPockets;

                        userPockets.forEach(p => {
                            if (p.id !== pocketId) {
                                let distributedVal = baseAmountPerOther;
                                if (remainder > 0) {
                                    distributedVal += 1;
                                    remainder--;
                                }
                                currentAllocationMap[p.id] = distributedVal;
                                const otherValueSpan = document.getElementById(`${type}AllocValue-${p.id}`);
                                if (otherValueSpan) {
                                    otherValueSpan.textContent = distributedVal;
                                }
                                const otherSlider = document.querySelector(`input[data-pocket-id="${p.id}"][data-type="${type}"]`);
                                if (otherSlider) {
                                    otherSlider.value = distributedVal;
                                }
                            }
                        });
                    } else if (remainingPercentage === 0) {
                        // Nếu slider hiện tại là 100, đặt tất cả các ví khác về 0
                        userPockets.forEach(p => {
                            if (p.id !== pocketId) {
                                currentAllocationMap[p.id] = 0;
                                const otherValueSpan = document.getElementById(`${type}AllocValue-${p.id}`);
                                if (otherValueSpan) {
                                    otherValueSpan.textContent = 0;
                                }
                                const otherSlider = document.querySelector(`input[data-pocket-id="${p.id}"][data-type="${type}"]`);
                                if (otherSlider) {
                                    otherSlider.value = 0; // Corrected: Use otherSlider instead of slider
                                }
                            }
                        });
                    }
                } else {
                    // Phân bổ lại theo tỷ lệ giữa các ví khác
                    let adjustedSumForOthers = 0;
                    userPockets.forEach((p) => {
                        if (p.id !== pocketId) {
                            // Tính giá trị mới theo tỷ lệ
                            let newOtherValue = Math.round((currentAllocationMap[p.id] / sumOfOtherPocketsCurrent) * remainingPercentage);
                            
                            // Đảm bảo giá trị không nhỏ hơn 0
                            newOtherValue = Math.max(0, newOtherValue);

                            currentAllocationMap[p.id] = newOtherValue;
                            const otherValueSpan = document.getElementById(`${type}AllocValue-${p.id}`);
                            if (otherValueSpan) {
                                otherValueSpan.textContent = newOtherValue;
                            }
                            const otherSlider = document.querySelector(`input[data-pocket-id="${p.id}"][data-type="${type}"]`);
                            if (otherSlider) {
                                otherSlider.value = newOtherValue;
                            }
                            adjustedSumForOthers += newOtherValue;
                        }
                    });

                    // Xử lý lỗi làm tròn để đảm bảo tổng chính xác là 100
                    let finalTotal = newValue + adjustedSumForOthers;
                    let diff = 100 - finalTotal; // 'diff' là lượng còn lại cần thêm hoặc bớt

                    if (diff !== 0) {
                        // Phân bổ sự khác biệt giữa các ví khác
                        const otherPocketsToAdjust = userPockets.filter(p => p.id !== pocketId);
                        let i = 0;
                        while (diff !== 0 && otherPocketsToAdjust.length > 0) {
                            const p = otherPocketsToAdjust[i % otherPocketsToAdjust.length]; // Dùng modulo để lặp lại
                            let currentVal = currentAllocationMap[p.id];

                            if (diff > 0) { // Cần thêm để đạt 100
                                if (currentVal < 100) { // Vẫn có thể thêm
                                    currentAllocationMap[p.id]++;
                                    diff--;
                                }
                            } else { // Cần bớt để đạt 100 (diff < 0)
                                if (currentVal > 0) { // Vẫn có thể bớt
                                    currentAllocationMap[p.id]--;
                                    diff++;
                                }
                            }
                            // Cập nhật UI cho ví này
                            const otherValueSpan = document.getElementById(`${type}AllocValue-${p.id}`);
                            if (otherValueSpan) {
                                otherValueSpan.textContent = currentAllocationMap[p.id];
                            }
                            const otherSlider = document.querySelector(`input[data-pocket-id="${p.id}"][data-type="${type}"]`);
                            if (otherSlider) {
                                otherSlider.value = currentAllocationMap[p.id];
                            }
                            i++;
                            // Đảm bảo vòng lặp không vô hạn nếu không thể phân bổ hết diff
                            if (i > otherPocketsToAdjust.length * 2 && diff !== 0) { // Giới hạn số lần lặp để tránh vòng lặp vô hạn
                                console.warn("Không thể phân bổ hết phần trăm còn lại do giới hạn 0-100.");
                                break;
                            }
                        }
                    }
                }
            }

            // Lưu vào local storage sau tất cả các điều chỉnh
            saveToLocalStorage();
        }

        // --- Placeholder functions for undefined references ---
        function saveAllocationSettings() {
            console.log("Hàm saveAllocationSettings được gọi. Cần triển khai logic lưu cài đặt phân bổ.");
            // Implement actual saving logic here if needed
            saveToLocalStorage(); // Ensure changes are saved
            closeModal('allocationSettingsModal');
        }

        function saveTTTKSettings() {
            console.log("Hàm saveTTTKSettings được gọi. Cần triển khai logic lưu cài đặt TTTK.");
            // Implement actual saving logic here if needed
            // Example: Update TTTK pocket's min/max balance
            const tttkPocket = pockets.find(p => p.id === 'TTTK');
            if (tttkPocket) {
                tttkPocket.minBalance = parseFormattedNumber(document.getElementById('tttkMinBalance').value);
                tttkPocket.maxBalance = parseFormattedNumber(document.getElementById('tttkMaxBalance').value);
            }
            saveToLocalStorage();
            closeModal('manageTTTKModal');
        }

        // Helper to calculate number of cycles from target date
        function calculateNOCFromDate(startDate, endDate, cycleType) {
            if (!startDate || !endDate || endDate <= startDate) return 0;

            if (cycleType === 'day') {
                const diffTime = endDate.getTime() - startDate.getTime();
                return Math.floor(diffTime / (1000 * 60 * 60 * 24)); // Use floor for full days
            } else if (cycleType === 'month') {
                let months = (endDate.getFullYear() - startDate.getFullYear()) * 12;
                months += endDate.getMonth() - startDate.getMonth();
                // Adjust if end day is before start day in the last month (e.g., Jan 31 to Feb 15 is less than a full month)
                // For simplicity, we count full months. If end day is before start day, it's not a full month yet.
                if (endDate.getDate() < startDate.getDate()) {
                    months--;
                }
                return Math.max(0, months); // Ensure non-negative
            } else if (cycleType === 'year') {
                let years = endDate.getFullYear() - startDate.getFullYear();
                // Adjust if end month/day is before start month/day in the last year
                if (endDate.getMonth() < startDate.getMonth() || (endDate.getMonth() === startDate.getMonth() && endDate.getDate() < startDate.getDate())) {
                    years--;
                }
                return Math.max(0, years); // Ensure non-negative
            }
            return 0;
        }

        // Helper to calculate target date from number of cycles
        function calculateDateFromNOC(startDate, numCycles, cycleType) {
            if (isNaN(numCycles) || numCycles <= 0) return null;
            let newDate = new Date(startDate);
            if (cycleType === 'day') {
                newDate.setDate(newDate.getDate() + numCycles);
            } else if (cycleType === 'month') {
                newDate.setMonth(newDate.getMonth() + numCycles);
            } else if (cycleType === 'year') {
                newDate.setFullYear(newDate.getFullYear() + numCycles);
            }
            return newDate;
        }

        function calculateSavingsGoal() {
            const targetAmountInput = document.getElementById('savingsTargetAmount');
            const amountPerCycleInput = document.getElementById('savingsAmountPerCycle');
            const numberOfCyclesInput = document.getElementById('savingsNumberOfCycles');
            const depositCycleSelect = document.getElementById('savingsDepositCycle');
            const targetDateInput = document.getElementById('savingsTargetDate');

            // Parse target amount by removing thousand separators
            let ta = parseFormattedNumber(targetAmountInput.value);
            let depositCycle = depositCycleSelect.value;
            let td = targetDateInput.value ? new Date(targetDateInput.value + 'T00:00:00') : null;
            let noc_manual_input = parseFormattedNumber(numberOfCyclesInput.value); // Get manual input for NOC

            const today = new Date();
            today.setHours(0, 0, 0, 0);

            const isValidNum = (val) => !isNaN(val) && val > 0;
            const isValidDate = (dateObj) => dateObj instanceof Date && !isNaN(dateObj.getTime()) && dateObj >= today;

            // Mandatory inputs: targetAmount, targetDate, depositCycle
            const isTaValid = isValidNum(ta);
            const isTdValid = isValidDate(td);

            if (!isTaValid || (!isTdValid && !isValidNum(noc_manual_input))) {
                // If mandatory inputs are not valid, clear calculated fields
                amountPerCycleInput.value = '';
                // numberOfCyclesInput.value = ''; // Don't clear NOC if it was manually entered
                return;
            }

            let effectiveNOC;

            // If user has manually entered a valid number for 'Số kỳ nạp tiền', use it.
            if (isValidNum(noc_manual_input)) {
                effectiveNOC = noc_manual_input;
                // Also, update the target date to match this manually entered number of cycles and cycle type
                const calculatedTargetDate = calculateDateFromNOC(today, effectiveNOC, depositCycle);
                if (calculatedTargetDate) {
                     // Only update if the calculated date is different, to avoid infinite loops with onchange/oninput
                     const currentTargetDateStr = targetDateInput.value;
                     const newTargetDateStr = calculatedTargetDate.toISOString().split('T')[0];
                     if (currentTargetDateStr !== newTargetDateStr) {
                         targetDateInput.value = newTargetDateStr;
                     }
                }
            } else {
                // Otherwise, calculate 'Số kỳ nạp tiền' from 'Ngày đạt mục tiêu' and 'Chu kỳ nạp tiền'
                effectiveNOC = calculateNOCFromDate(today, td, depositCycle);
                numberOfCyclesInput.value = effectiveNOC.toFixed(0) === '0' ? '' : effectiveNOC.toFixed(0); // Display the calculated NOC, clear if 0
            }

            if (effectiveNOC <= 0 || isNaN(effectiveNOC)) {
                amountPerCycleInput.value = '';
                // showAlert('Số kỳ nạp tiền không hợp lệ. Vui lòng kiểm tra lại Ngày đạt mục tiêu hoặc Số kỳ nạp tiền.'); // Removed to avoid excessive alerts during typing
                return;
            }

            // Calculate amountPerCycle based on effectiveNOC
            let calculatedAPC = ta / effectiveNOC;
            amountPerCycleInput.value = new Intl.NumberFormat('vi-VN').format(calculatedAPC);
        }

        function savePocket() {
            console.log("Hàm savePocket được gọi. Cần triển khai logic lưu/tạo Pocket mới.");
            const pocketId = document.getElementById('createEditPocketModal').dataset.editId;
            const pocketName = document.getElementById('pocketName').value;
            const pocketIcon = document.getElementById('pocketIcon').value;
            const pocketType = document.getElementById('pocketType').value;
            
            // Get elements for limit and savings goal fields
            const pocketLimitInput = document.getElementById('pocketLimit');
            // Parse target amount by removing thousand separators
            const savingsTargetAmount = parseFormattedNumber(document.getElementById('savingsTargetAmount').value);
            // amountPerCycle and numberOfCycles are now calculated, so parse them from the displayed value if needed,
            // or rely on the calculation logic to ensure they are correct when saving.
            // For simplicity, we'll parse the displayed values for consistency.
            const savingsAmountPerCycle = parseFormattedNumber(document.getElementById('savingsAmountPerCycle').value); 
            const savingsDepositCycle = document.getElementById('savingsDepositCycle').value;
            const savingsNumberOfCycles = parseFormattedNumber(document.getElementById('savingsNumberOfCycles').value);
            const savingsTargetDate = document.getElementById('savingsTargetDate').value; // Get the date string

            if (!pocketName) {
                showAlert('Tên ví không được để trống.');
                return;
            }

            if (pocketType === 'Tiết kiệm') {
                const today = new Date();
                today.setHours(0, 0, 0, 0);
                const td = savingsTargetDate ? new Date(savingsTargetDate + 'T00:00:00') : null;
                const isTaValid = !isNaN(savingsTargetAmount) && savingsTargetAmount > 0;
                const isTdValid = td instanceof Date && !isNaN(td.getTime()) && td >= today;
                const isNOCValid = !isNaN(savingsNumberOfCycles) && savingsNumberOfCycles > 0;


                if (!isTaValid || (!isTdValid && !isNOCValid)) {
                    showAlert('Vui lòng nhập "Số tiền mục tiêu" và một trong hai trường "Ngày đạt mục tiêu" hoặc "Số kỳ nạp tiền" hợp lệ cho ví tiết kiệm.');
                    return;
                }
                
                // Re-calculate NOC and APC just before saving to ensure consistency
                let effectiveNOC;
                if (isNOCValid) {
                    effectiveNOC = savingsNumberOfCycles;
                } else {
                    effectiveNOC = calculateNOCFromDate(today, td, savingsDepositCycle);
                }
                
                if (effectiveNOC <= 0 || isNaN(effectiveNOC)) {
                    showAlert('Không thể tính toán số kỳ hoặc số tiền mỗi kỳ. Vui lòng kiểm tra lại mục tiêu và ngày đạt mục tiêu.');
                    return;
                }

                let currentAPC = savingsTargetAmount / effectiveNOC;
                if (isNaN(currentAPC)) {
                    showAlert('Lỗi tính toán số tiền mỗi kỳ. Vui lòng kiểm tra lại dữ liệu.');
                    return;
                }

                // If target date was derived from NOC, update it for saving
                let finalTargetDate = savingsTargetDate;
                if (isNOCValid && !isTdValid) { // If NOC was provided but date was not
                    const calculatedDate = calculateDateFromNOC(today, effectiveNOC, savingsDepositCycle);
                    if (calculatedDate) {
                        finalTargetDate = calculatedDate.toISOString().split('T')[0];
                    }
                }
                
                // If NOC was derived from date, update it for saving
                let finalNOC = effectiveNOC;

                // Save these consistent values
                const savingsGoalData = {
                    targetAmount: savingsTargetAmount,
                    amountPerCycle: currentAPC, // Use the calculated value
                    depositCycle: savingsDepositCycle,
                    numberOfCycles: finalNOC, // Use the calculated value
                    targetDate: finalTargetDate // Save the determined target date
                };


                if (pocketId) {
                    const existingPocket = pockets.find(p => p.id === pocketId);
                    if (existingPocket) {
                        existingPocket.name = pocketName;
                        existingPocket.icon = pocketIcon;
                        existingPocket.type = pocketType;
                        existingPocket.savingsGoal = savingsGoalData;
                        existingPocket.limit = null;
                    }
                } else {
                    const newPocket = {
                        id: 'pocket_' + Date.now(),
                        name: pocketName,
                        icon: pocketIcon,
                        balance: 0,
                        type: pocketType,
                        savingsGoal: savingsGoalData,
                        limit: null
                    };
                    pockets.push(newPocket);
                }
            } else { // Non-savings pocket type
                const limitValue = parseFormattedNumber(pocketLimitInput.value);
                if (pocketId) {
                    const existingPocket = pockets.find(p => p.id === pocketId);
                    if (existingPocket) {
                        existingPocket.name = pocketName;
                        existingPocket.icon = pocketIcon;
                        existingPocket.type = pocketType;
                        existingPocket.limit = limitValue > 0 ? limitValue : null;
                        existingPocket.savingsGoal = null;
                    }
                } else {
                    const newPocket = {
                        id: 'pocket_' + Date.now(),
                        name: pocketName,
                        icon: pocketIcon,
                        balance: 0,
                        type: pocketType,
                        limit: limitValue > 0 ? limitValue : null,
                        savingsGoal: null
                    };
                    pockets.push(newPocket);
                }
            }
            saveToLocalStorage();
            closeModal('createEditPocketModal');
        }

        function updatePocketModalFieldsVisibility() {
            const pocketType = document.getElementById('pocketType').value;
            const pocketLimitLabel = document.getElementById('pocketLimitLabel');
            const pocketLimitInput = document.getElementById('pocketLimit');
            const savingsGoalFieldsContainer = document.getElementById('savingsGoalFieldsContainer');

            if (pocketType === 'Tiết kiệm') {
                pocketLimitLabel.style.display = 'none';
                pocketLimitInput.style.display = 'none';
                savingsGoalFieldsContainer.style.display = 'block';
            } else {
                pocketLimitLabel.style.display = 'block';
                pocketLimitInput.style.display = 'block';
                savingsGoalFieldsContainer.style.display = 'none';
                // Clear savings goal fields when switching away from "Tiết kiệm"
                document.getElementById('savingsTargetAmount').value = '';
                document.getElementById('savingsAmountPerCycle').value = '';
                document.getElementById('savingsNumberOfCycles').value = '';
                document.getElementById('savingsTargetDate').value = ''; // Clear target date
            }
        }

        function openCreatePocketModal() {
            console.log("Mở modal để tạo Pocket mới.");
            document.getElementById('createEditPocketTitle').textContent = 'Tạo Pocket Mới';
            document.getElementById('pocketName').value = '';
            document.getElementById('pocketIcon').value = '';
            document.getElementById('pocketType').value = 'Chi tiêu'; // Default to Chi tiêu
            document.getElementById('pocketLimit').value = '';
            document.getElementById('createEditPocketModal').dataset.editId = ''; // Clear edit ID

            // Clear savings goal fields
            document.getElementById('savingsTargetAmount').value = '';
            document.getElementById('savingsAmountPerCycle').value = '';
            document.getElementById('savingsDepositCycle').value = 'month'; // Default cycle
            document.getElementById('savingsNumberOfCycles').value = '';
            document.getElementById('savingsTargetDate').value = ''; // Clear target date

            updatePocketModalFieldsVisibility(); // Set initial visibility based on default type
            openModal('createEditPocketModal');
            // No need to call calculateSavingsGoal here as mandatory fields are empty
        }


        function openEditPocket(pocketId) {
            console.log(`Hàm openEditPocket được gọi cho pocketId: ${pocketId}`);
            const pocketToEdit = pockets.find(p => p.id === pocketId);
            if (pocketToEdit) {
                if (pocketId === 'TTTK') {
                    // Special handling for TTTK: open manageTTTKModal
                    const tttkPocket = pockets.find(p => p.id === 'TTTK');
                    if (tttkPocket) {
                        document.getElementById('tttkMinBalance').value = tttkPocket.minBalance ? tttkPocket.minBalance.toLocaleString('vi-VN') : '';
                        document.getElementById('tttkMaxBalance').value = tttkPocket.maxBalance ? tttkPocket.maxBalance.toLocaleString('vi-VN') : '';
                    }
                    openModal('manageTTTKModal');
                } else {
                    // For other pockets: populate createEditPocketModal
                    document.getElementById('createEditPocketTitle').textContent = 'Sửa Pocket';
                    document.getElementById('pocketName').value = pocketToEdit.name;
                    document.getElementById('pocketIcon').value = pocketToEdit.icon;
                    document.getElementById('pocketType').value = pocketToEdit.type;
                    document.getElementById('createEditPocketModal').dataset.editId = pocketId; // Store ID for saving

                    // Populate savings goal fields if type is 'Tiết kiệm'
                    if (pocketToEdit.type === 'Tiết kiệm' && pocketToEdit.savingsGoal) {
                        // Format target amount for display
                        document.getElementById('savingsTargetAmount').value = pocketToEdit.savingsGoal.targetAmount ? pocketToEdit.savingsGoal.targetAmount.toLocaleString('vi-VN') : '';
                        document.getElementById('savingsDepositCycle').value = pocketToEdit.savingsGoal.depositCycle || 'month';
                        document.getElementById('savingsTargetDate').value = pocketToEdit.savingsGoal.targetDate || ''; // Populate target date
                        // Populate numberOfCycles if it exists in savingsGoal
                        document.getElementById('savingsNumberOfCycles').value = pocketToEdit.savingsGoal.numberOfCycles ? pocketToEdit.savingsGoal.numberOfCycles.toLocaleString('vi-VN') : '';
                        // amountPerCycle will be calculated by calculateSavingsGoal, so clear it for fresh calculation
                        document.getElementById('savingsAmountPerCycle').value = '';
                    } else {
                        // Clear savings goal fields if not a savings pocket
                        document.getElementById('savingsTargetAmount').value = '';
                        document.getElementById('savingsAmountPerCycle').value = '';
                        document.getElementById('savingsDepositCycle').value = 'month'; // Default cycle
                        document.getElementById('savingsNumberOfCycles').value = '';
                        document.getElementById('savingsTargetDate').value = ''; // Clear target date
                    }

                    // Populate limit field if not a savings pocket
                    if (pocketToEdit.type !== 'Tiết kiệm') {
                        document.getElementById('pocketLimit').value = pocketToEdit.limit !== null ? pocketToEdit.limit.toLocaleString('vi-VN') : '';
                    } else {
                        document.getElementById('pocketLimit').value = ''; // Clear limit for savings type
                    }

                    updatePocketModalFieldsVisibility(); // Adjust visibility based on loaded type
                    openModal('createEditPocketModal');
                    if (pocketToEdit.type === 'Tiết kiệm' && pocketToEdit.savingsGoal) {
                        calculateSavingsGoal(); // Call after setting initial values for savings
                    }
                }
            } else {
                showAlert('Không tìm thấy ví để chỉnh sửa.');
            }
        }

        function deletePocket(pocketId) {
            console.log(`Hàm deletePocket được gọi cho pocketId: ${pocketId}`);
            if (pocketId === 'TTTK') {
                showAlert('Không thể xóa Tài khoản chính (TTTK).');
                return;
            }

            showConfirm('Bạn có chắc chắn muốn xóa ví này? Số dư sẽ được chuyển về Tài khoản chính (TTTK).', (confirmed) => {
                if (confirmed) {
                    const pocketToDeleteIndex = pockets.findIndex(p => p.id === pocketId);
                    if (pocketToDeleteIndex > -1) {
                        const pocketToDelete = pockets[pocketToDeleteIndex];
                        const tttkPocket = pockets.find(p => p.id === 'TTTK');

                        if (tttkPocket) {
                            tttkPocket.balance += pocketToDelete.balance; // Transfer balance to TTTK
                            transactions.push({
                                id: 'txn_' + Date.now(),
                                type: 'InternalTransfer',
                                sourceId: pocketToDelete.id,
                                sourceName: pocketToDelete.name,
                                destinationId: tttkPocket.id,
                                destinationName: tttkPocket.name,
                                amount: pocketToDelete.balance,
                                timestamp: getCurrentDateTime(),
                                note: `Chuyển số dư từ ví ${pocketToDelete.name} về TTTK trước khi xóa.`
                            });
                        }
                        pockets.splice(pocketToDeleteIndex, 1); // Remove pocket
                        saveToLocalStorage();
                        renderManagePocketList(); // Re-render the manage pocket list
                        showAlert(`Ví "${pocketToDelete.name}" đã được xóa và số dư đã được chuyển về Tài khoản chính.`);
                    }
                }
            });
        }

        function showHistory(pocketId) {
            console.log(`Hàm showHistory được gọi cho pocketId: ${pocketId}`);
            renderTransactionHistory(pocketId);
            showScreen('historyScreen');
        }

        // --- Transaction Execution Functions ---
        function executeAddMoney() {
            const destinationId = document.getElementById('addMoneyDestination').value;
            const amount = parseFormattedNumber(document.getElementById('addMoneyAmount').value);
            const note = document.getElementById('addMoneyNote').value;

            if (isNaN(amount) || amount <= 0) {
                showAlert('Vui lòng nhập số tiền hợp lệ.');
                return;
            }

            const destinationPocket = pockets.find(p => p.id === destinationId);
            if (destinationPocket) {
                destinationPocket.balance += amount;
                transactions.push({
                    id: 'txn_' + Date.now(),
                    type: 'Nạp',
                    sourceId: 'CASA_BIDV_EXTERNAL', // Source is external CASA
                    sourceName: 'Tài khoản CASA tại BIDV',
                    destinationId: destinationPocket.id,
                    destinationName: destinationPocket.name,
                    amount: amount,
                    timestamp: getCurrentDateTime(),
                    note: note || `Nạp tiền vào ví ${destinationPocket.name}`
                });
                saveToLocalStorage();
                closeModal('addMoneyModal');
                showAlert(`Đã nạp ${formatCurrency(amount)} vào ví ${destinationPocket.name}.`);
                // Check for automatic distribution after adding money to TTTK
                if (destinationPocket.id === 'TTTK') {
                    checkAndPerformAutomaticDistribution();
                }
            } else {
                showAlert('Ví đích không hợp lệ.');
            }
        }

        function executeTransferMoney() {
            const sourceId = document.getElementById('transferSource').value;
            const destinationId = document.getElementById('transferDestination').value;
            const amount = parseFormattedNumber(document.getElementById('transferAmount').value);
            const note = document.getElementById('transferNote').value;

            if (isNaN(amount) || amount <= 0) {
                showAlert('Vui lòng nhập số tiền hợp lệ.');
                return;
            }

            if (sourceId === destinationId) {
                showAlert('Không thể chuyển tiền giữa cùng một ví.');
                return;
            }

            const sourcePocket = pockets.find(p => p.id === sourceId);
            const destinationPocket = pockets.find(p => p.id === destinationId);

            if (!sourcePocket) {
                showAlert('Ví nguồn không hợp lệ.');
                return;
            }

            if (sourcePocket.balance < amount) {
                showAlert('Số dư ví nguồn không đủ.');
                return;
            }

            // Handle transfer to external account
            if (destinationId === 'CASA_BIDV_EXTERNAL') {
                sourcePocket.balance -= amount;
                transactions.push({
                    id: 'txn_' + Date.now(),
                    type: 'Chuyển ra ngoài',
                    sourceId: sourcePocket.id,
                    sourceName: sourcePocket.name,
                    destinationId: 'CASA_BIDV_EXTERNAL',
                    destinationName: 'Tài khoản CASA bên ngoài BIDV',
                    amount: amount,
                    timestamp: getCurrentDateTime(),
                    note: note || `Chuyển tiền từ ví ${sourcePocket.name} ra ngoài`
                });
                saveToLocalStorage();
                closeModal('transferMoneyModal');
                showAlert(`Đã chuyển ${formatCurrency(amount)} từ ví ${sourcePocket.name} ra tài khoản ngoài.`);
                // Check for automatic compensation if TTTK balance falls below min after transfer
                if (sourcePocket.id === 'TTTK') {
                    checkAndPerformAutomaticCompensation();
                }
                return;
            }

            if (!destinationPocket) {
                showAlert('Ví đích không hợp lệ.');
                return;
            }

            // Internal transfer between pockets
            sourcePocket.balance -= amount;
            destinationPocket.balance += amount;

            transactions.push({
                id: 'txn_' + Date.now(),
                type: 'Chuyển nội bộ',
                sourceId: sourcePocket.id,
                sourceName: sourcePocket.name,
                destinationId: destinationPocket.id,
                destinationName: destinationPocket.name,
                amount: amount,
                timestamp: getCurrentDateTime(),
                note: note || `Chuyển tiền từ ${sourcePocket.name} đến ${destinationPocket.name}`
            });
            saveToLocalStorage();
            closeModal('transferMoneyModal');
            showAlert(`Đã chuyển ${formatCurrency(amount)} từ ví ${sourcePocket.name} sang ví ${destinationPocket.name}.`);

            // Check for automatic distribution/compensation if TTTK is involved
            if (sourcePocket.id === 'TTTK') {
                checkAndPerformAutomaticCompensation();
            } else if (destinationPocket.id === 'TTTK') {
                checkAndPerformAutomaticDistribution();
            }
        }

        function executePay() {
            const sourceId = document.getElementById('paySource').value; // This is always TTTK
            const service = document.getElementById('payService').value;
            const amount = parseFormattedNumber(document.getElementById('payAmount').value);
            const note = document.getElementById('payNote').value;

            if (isNaN(amount) || amount <= 0) {
                showAlert('Vui lòng nhập số tiền hợp lệ.');
                return;
            }

            const tttkPocket = pockets.find(p => p.id === 'TTTK');
            if (!tttkPocket) {
                showAlert('Không tìm thấy Tài khoản chính (TTTK).');
                return;
            }

            if (tttkPocket.balance < amount) {
                showAlert('Số dư Tài khoản chính (TTTK) không đủ để thanh toán.');
                return;
            }

            tttkPocket.balance -= amount;
            transactions.push({
                id: 'txn_' + Date.now(),
                type: 'Thanh Toán',
                sourceId: tttkPocket.id,
                sourceName: tttkPocket.name,
                destinationId: service, // Service name as destination
                destinationName: service,
                amount: amount,
                timestamp: getCurrentDateTime(),
                note: note || `Thanh toán dịch vụ ${service}`
            });
            saveToLocalStorage();
            closeModal('payModal');
            showAlert(`Đã thanh toán ${formatCurrency(amount)} cho dịch vụ ${service}.`);
            // Check for automatic compensation after payment
            checkAndPerformAutomaticCompensation();
        }

        function checkAndPerformAutomaticDistribution() {
            const tttkPocket = pockets.find(p => p.id === 'TTTK');
            if (!tttkPocket || tttkPocket.balance < tttkPocket.maxBalance) {
                return; // No distribution needed if balance is below max
            }

            console.log("Thực hiện phân bổ tự động (TKTT >= maxBalance)");
            const amountToDistribute = tttkPocket.balance - tttkPocket.maxBalance;
            if (amountToDistribute <= 0) return;

            const userPockets = pockets.filter(p => p.id !== 'TTTK');
            let distributedTotal = 0;

            // Sort userPockets by current balance (e.g., prioritize filling up emptier pockets first, or based on type)
            // For now, distribute based on allocation settings
            
            const currentMaxAlloc = { ...allocationSettings.maxBalance }; // Copy to avoid modifying original during loop

            // Normalize percentages if their sum is not 100%
            let sumOfAllocations = 0;
            userPockets.forEach(p => sumOfAllocations += (currentMaxAlloc[p.id] || 0));

            if (sumOfAllocations === 0) {
                console.warn("Không có tỷ lệ phân bổ nào được thiết lập. Bỏ qua phân bổ tự động.");
                return;
            }

            userPockets.forEach(pocket => {
                const percentage = (currentMaxAlloc[pocket.id] || 0) / sumOfAllocations; // Use normalized percentage
                let amountForPocket = Math.floor(amountToDistribute * percentage);

                if (amountForPocket > 0) {
                    tttkPocket.balance -= amountForPocket;
                    pocket.balance += amountForPocket;
                    transactions.push({
                        id: 'txn_' + Date.now(),
                        type: 'Phân bổ tự động',
                        sourceId: tttkPocket.id,
                        sourceName: tttkPocket.name,
                        destinationId: pocket.id,
                        destinationName: pocket.name,
                        amount: amountForPocket,
                        timestamp: getCurrentDateTime(),
                        note: `Phân bổ tự động từ TTTK vào ví ${pocket.name}`
                    });
                    distributedTotal += amountForPocket;
                }
            });

            // Handle any remaining amount due to rounding
            const remainingUndistributed = amountToDistribute - distributedTotal;
            if (remainingUndistributed > 0) {
                // Distribute remaining to the first pocket or TTTK
                const firstUserPocket = userPockets[0];
                if (firstUserPocket) {
                    tttkPocket.balance -= remainingUndistributed;
                    firstUserPocket.balance += remainingUndistributed;
                    transactions.push({
                        id: 'txn_' + Date.now(),
                        type: 'Phân bổ tự động',
                        sourceId: tttkPocket.id,
                        sourceName: tttkPocket.name,
                        destinationId: firstUserPocket.id,
                        destinationName: firstUserPocket.name,
                        amount: remainingUndistributed,
                        timestamp: getCurrentDateTime(),
                        note: `Phân bổ tự động (làm tròn) từ TTTK vào ví ${firstUserPocket.name}`
                    });
                } else {
                    console.warn("Không có ví phụ để phân bổ số dư còn lại.");
                }
            }
            saveToLocalStorage();
            renderHomePage(); // Update UI after distribution
            showAlert('Đã thực hiện phân bổ tự động số dư vượt hạn mức.');
        }

        function checkAndPerformAutomaticCompensation() {
            const tttkPocket = pockets.find(p => p.id === 'TTTK');
            if (!tttkPocket || tttkPocket.balance > tttkPocket.minBalance) {
                return; // No compensation needed if balance is above min
            }

            console.log("Thực hiện bù đắp tự động (TKTT <= minBalance)");
            const amountToCompensate = tttkPocket.minBalance - tttkPocket.balance;
            if (amountToCompensate <= 0) return;

            const userPockets = pockets.filter(p => p.id !== 'TTTK');
            let compensatedTotal = 0;

            // Prioritize withdrawing from pockets with highest balances or based on allocation settings
            const currentMinAlloc = { ...allocationSettings.minBalance }; // Copy to avoid modifying original during loop

            // Normalize percentages if their sum is not 100%
            let sumOfAllocations = 0;
            userPockets.forEach(p => sumOfAllocations += (currentMinAlloc[p.id] || 0));

            if (sumOfAllocations === 0) {
                console.warn("Không có tỷ lệ phân bổ nào được thiết lập. Bỏ qua bù đắp tự động.");
                return;
            }

            // Distribute the amount to compensate proportionally
            userPockets.forEach(pocket => {
                const percentage = (currentMinAlloc[pocket.id] || 0) / sumOfAllocations; // Use normalized percentage
                let amountFromPocket = Math.floor(amountToCompensate * percentage);

                // Ensure we don't withdraw more than available in the pocket
                amountFromPocket = Math.min(amountFromPocket, pocket.balance);

                if (amountFromPocket > 0) {
                    tttkPocket.balance += amountFromPocket;
                    pocket.balance -= amountFromPocket;
                    transactions.push({
                        id: 'txn_' + Date.now(),
                        type: 'Phân bổ tự động (rút)', // Changed to indicate withdrawal
                        sourceId: pocket.id,
                        sourceName: pocket.name,
                        destinationId: tttkPocket.id,
                        destinationName: tttkPocket.name,
                        amount: amountFromPocket,
                        timestamp: getCurrentDateTime(),
                        note: `Bù đắp tự động từ ví ${pocket.name} vào TTTK`
                    });
                    compensatedTotal += amountFromPocket;
                }
            });

            // Handle any remaining amount if not fully compensated due to rounding or insufficient funds in sub-pockets
            const remainingToCompensate = amountToCompensate - compensatedTotal;
            if (remainingToCompensate > 0) {
                // Try to pull from any remaining pockets if possible, or log a warning
                const availablePockets = userPockets.filter(p => p.balance > 0);
                if (availablePockets.length > 0) {
                    const pocketToPullFrom = availablePockets[0]; // Just take from the first available
                    const actualPullAmount = Math.min(remainingToCompensate, pocketToPullFrom.balance);

                    if (actualPullAmount > 0) {
                        tttkPocket.balance += actualPullAmount;
                        pocketToPullFrom.balance -= actualPullAmount;
                        transactions.push({
                            id: 'txn_' + Date.now(),
                            type: 'Phân bổ tự động (rút)',
                            sourceId: pocketToPullFrom.id,
                            sourceName: pocketToPullFrom.name,
                            destinationId: tttkPocket.id,
                            destinationName: tttkPocket.name,
                            amount: actualPullAmount,
                            timestamp: getCurrentDateTime(),
                            note: `Bù đắp tự động (làm tròn) từ ví ${pocketToPullFrom.name} vào TTTK`
                        });
                    }
                } else {
                    console.warn("Không có đủ số dư trong các ví phụ để bù đắp TTTK.");
                }
            }

            saveToLocalStorage();
            renderHomePage(); // Update UI after compensation
            showAlert('Đã thực hiện bù đắp tự động cho số dư TTTK dưới hạn mức tối thiểu.');
        }

        // --- Flow Settings Functions ---
        function openFlowSettingsModal() {
            document.getElementById('flowSettingsTitle').textContent = 'Cài đặt Dòng tiền';
            document.getElementById('flowSettingsModal').dataset.editId = ''; // Clear edit ID for new entry
            populatePocketSelect('flowSourceAccount', pockets, false);
            populatePocketSelect('flowDestinationAccount', pockets, true);
            document.getElementById('flowAmount').value = '';
            document.getElementById('flowNumberOfCycles').value = '';
            document.getElementById('flowCycleType').value = 'month';
            document.getElementById('flowNote').value = '';
            document.getElementById('flowExpiryDate').value = ''; // Clear expiry date for new entry
            openModal('flowSettingsModal');
        }

        function saveFlowSetting() {
            const flowId = document.getElementById('flowSettingsModal').dataset.editId;
            const sourceId = document.getElementById('flowSourceAccount').value;
            const destinationId = document.getElementById('flowDestinationAccount').value;
            const amount = parseFormattedNumber(document.getElementById('flowAmount').value);
            const numberOfCycles = parseFormattedNumber(document.getElementById('flowNumberOfCycles').value);
            const cycleType = document.getElementById('flowCycleType').value;
            const expiryDate = document.getElementById('flowExpiryDate').value; // Get expiry date
            const note = document.getElementById('flowNote').value;

            if (!sourceId || !destinationId || isNaN(amount) || amount <= 0 || isNaN(numberOfCycles) || numberOfCycles <= 0) {
                showAlert('Vui lòng nhập đầy đủ và hợp lệ các thông tin: Tài khoản nguồn, Tài khoản đích, Số tiền, Số kỳ chuyển.');
                return;
            }

            if (sourceId === destinationId) {
                showAlert('Tài khoản nguồn và tài khoản đích không được trùng nhau.');
                return;
            }

            const sourcePocket = pockets.find(p => p.id === sourceId);
            const destinationPocket = pockets.find(p => p.id === destinationId);

            if (!sourcePocket) {
                showAlert('Tài khoản nguồn không hợp lệ.');
                return;
            }
            if (!destinationPocket && destinationId !== 'CASA_BIDV_EXTERNAL') {
                showAlert('Tài khoản đích không hợp lệ.');
                return;
            }

            const sourceName = sourcePocket.name;
            const destinationName = destinationId === 'CASA_BIDV_EXTERNAL' ? 'Tài khoản CASA bên ngoài BIDV' : destinationPocket.name;

            const newFlowSetting = {
                id: flowId || 'flow_' + Date.now(),
                sourceId,
                sourceName,
                destinationId,
                destinationName,
                amount,
                numberOfCycles,
                cycleType,
                expiryDate: expiryDate || null, // Save expiry date, or null if empty
                note
            };

            if (flowId) {
                // Editing existing flow setting
                const index = flowSettings.findIndex(f => f.id === flowId);
                if (index !== -1) {
                    flowSettings[index] = newFlowSetting;
                }
            } else {
                // Creating new flow setting
                flowSettings.push(newFlowSetting);
            }

            saveToLocalStorage();
            closeModal('flowSettingsModal');
            showAlert('Cài đặt dòng tiền đã được lưu.');
        }

        function openViewFlowSettingsModal() {
            renderFlowSettingsList();
            openModal('viewFlowSettingsModal');
        }

        function renderFlowSettingsList() {
            const flowListElem = document.getElementById('flowSettingsList');
            flowListElem.innerHTML = '';

            if (flowSettings.length === 0) {
                flowListElem.innerHTML = '<p style="text-align: center; color: rgba(255,255,255,0.7);">Chưa có cài đặt dòng tiền nào.</p>';
                return;
            }

            flowSettings.forEach(flow => {
                const item = document.createElement('div');
                item.className = 'flow-setting-item';
                let expiryDateDisplay = flow.expiryDate ? `<div class="flow-cycle">Ngày hết hạn: ${new Date(flow.expiryDate).toLocaleDateString('vi-VN')}</div>` : '';
                item.innerHTML = `
                    <div class="flow-details">Từ: ${flow.sourceName} -> Đến: ${flow.destinationName}</div>
                    <div class="flow-details">Số tiền: ${formatCurrency(flow.amount)}</div>
                    <div class="flow-cycle">Chu kỳ: ${flow.numberOfCycles} ${flow.cycleType === 'day' ? 'ngày' : flow.cycleType === 'month' ? 'tháng' : 'năm'}</div>
                    ${expiryDateDisplay}
                    <div class="flow-cycle">Ghi chú: ${flow.note || 'Không có'}</div>
                    <div class="flow-actions">
                        <button class="btn-primary" onclick="editFlowSetting('${flow.id}')">Sửa</button>
                        <button class="btn-cancel" onclick="deleteFlowSetting('${flow.id}')">Xóa</button>
                    </div>
                `;
                flowListElem.appendChild(item);
            });
        }

        function editFlowSetting(flowId) {
            const flowToEdit = flowSettings.find(f => f.id === flowId);
            if (flowToEdit) {
                document.getElementById('flowSettingsTitle').textContent = 'Sửa Cài đặt Dòng tiền';
                document.getElementById('flowSettingsModal').dataset.editId = flowId;
                populatePocketSelect('flowSourceAccount', pockets, false);
                populatePocketSelect('flowDestinationAccount', pockets, true);

                document.getElementById('flowSourceAccount').value = flowToEdit.sourceId;
                document.getElementById('flowDestinationAccount').value = flowToEdit.destinationId;
                // Set raw numeric values for amount and number of cycles
                document.getElementById('flowAmount').value = flowToEdit.amount;
                document.getElementById('flowNumberOfCycles').value = flowToEdit.numberOfCycles;
                document.getElementById('flowCycleType').value = flowToEdit.cycleType;
                document.getElementById('flowNote').value = flowToEdit.note;
                document.getElementById('flowExpiryDate').value = flowToEdit.expiryDate || ''; // Populate expiry date
                
                closeModal('viewFlowSettingsModal'); // Close view list modal
                openModal('flowSettingsModal'); // Open edit modal

                // Manually trigger formatNumberInput for amount and number of cycles after setting value
                // This ensures the displayed value is formatted correctly immediately
                formatNumberInput(document.getElementById('flowAmount'));
                formatNumberInput(document.getElementById('flowNumberOfCycles'));

            } else {
                showAlert('Không tìm thấy cài đặt dòng tiền để chỉnh sửa.');
            }
        }

        function deleteFlowSetting(flowId) {
            showConfirm('Bạn có chắc chắn muốn xóa cài đặt dòng tiền này?', (confirmed) => {
                if (confirmed) {
                    flowSettings = flowSettings.filter(f => f.id !== flowId);
                    saveToLocalStorage();
                    renderFlowSettingsList(); // Re-render the list
                    showAlert('Cài đặt dòng tiền đã được xóa.');
                }
            });
        }


        // --- Initial Setup and Event Listeners ---
        // Call initial setup functions
        initializeAllocationSettings(); 
        showScreen('homeScreen', document.getElementById('navHome')); 

        // Attach event listeners for buttons
        const saveAllocBtn = document.getElementById('saveAllocationSettingsBtn');
        if (saveAllocBtn) {
            saveAllocBtn.addEventListener('click', saveAllocationSettings);
        } else {
            console.error("Không tìm thấy nút có ID 'saveAllocationSettingsBtn'.");
        }

        const saveTTTKBtn = document.getElementById('saveTTTKSettingsBtn');
        if (saveTTTKBtn) {
            saveTTTKBtn.addEventListener('click', saveTTTKSettings);
        } else {
            console.error("Không tìm thấy nút có ID 'saveTTTKSettingsBtn'.");
        }

        const savePocketBtn = document.getElementById('savePocketBtn');
        if (savePocketBtn) {
            savePocketBtn.addEventListener('click', savePocket);
        } else {
            console.error("Không tìm thấy nút có ID 'savePocketBtn'.");
        }

        const saveFlowSettingBtn = document.getElementById('saveFlowSettingBtn');
        if (saveFlowSettingBtn) {
            saveFlowSettingBtn.addEventListener('click', saveFlowSetting);
        } else {
            console.error("Không tìm thấy nút có ID 'saveFlowSettingBtn'.");
        }

        // Event listener for pocketType change in createEditPocketModal
        const pocketTypeSelect = document.getElementById('pocketType');
        if (pocketTypeSelect) {
            pocketTypeSelect.addEventListener('change', updatePocketModalFieldsVisibility);
        }
    </script>
</body>
</html>
