<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Báo cáo Quyết toán - Mobile Dashboard</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Chart.js & Plugins -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
    
    <!-- SheetJS (xlsx) for Excel processing -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- Google Fonts: Inter -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">

    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f1f5f9; /* Slate 100 - Mobile optimized bg */
            color: #334155;
            -webkit-tap-highlight-color: transparent;
        }

        /* Container Layout */
        .app-container {
            max-width: 100%;
            margin: 0 auto;
            padding: 16px;
            padding-bottom: 80px; /* Space for bottom actions if needed */
        }

        @media (min-width: 1024px) {
            .app-container {
                max-width: 1200px; /* Limit width on desktop */
                padding: 24px;
            }
        }

        /* Brand Colors */
        .text-brand-teal { color: #006b68; }
        .bg-brand-teal { background-color: #006b68; }
        .border-brand-teal { border-color: #006b68; }
        
        .text-brand-yellow { color: #ffc62f; }
        .bg-brand-yellow { background-color: #ffc62f; }
        .border-brand-yellow { border-color: #ffc62f; }

        /* 3D / Shadow Effects - Optimized for Mobile Performance */
        .card-3d {
            background: white;
            border-radius: 16px;
            box-shadow: 
                0 4px 6px -1px rgba(0, 0, 0, 0.05), 
                0 10px 15px -3px rgba(0, 0, 0, 0.05);
            border: 1px solid rgba(255,255,255,0.5);
            margin-bottom: 16px;
            overflow: hidden; /* Ensure content doesn't spill rounded corners */
        }

        .kpi-card-3d {
            background: linear-gradient(145deg, #ffffff, #f8fafc);
            border-radius: 16px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.03), 0 0 0 1px rgba(0,0,0,0.02);
            border-left: 6px solid transparent; 
            position: relative;
        }

        /* Responsive Charts */
        .chart-container {
            position: relative;
            width: 100%;
            height: 250px; /* Default mobile height */
        }
        @media (min-width: 768px) {
            .chart-container { height: 300px; }
        }

        /* Scrollable Table */
        .table-responsive {
            width: 100%;
            overflow-x: auto;
            -webkit-overflow-scrolling: touch; /* Smooth scroll on iOS */
        }
        
        .compact-table th {
            white-space: nowrap;
            background-color: #f8fafc;
            color: #64748b;
            font-weight: 700;
            text-transform: uppercase;
            font-size: 10px;
            padding: 10px 12px;
            border-bottom: 2px solid #e2e8f0;
        }
        .compact-table td {
            white-space: nowrap;
            padding: 10px 12px;
            font-size: 12px;
            border-bottom: 1px solid #f1f5f9;
        }

        /* Mobile Toolbar (Bottom Fixed or Top Scroll) */
        .mobile-toolbar {
            display: flex;
            gap: 8px;
            overflow-x: auto;
            padding: 4px 0 12px 0;
            scrollbar-width: none; /* Hide scrollbar Firefox */
        }
        .mobile-toolbar::-webkit-scrollbar { display: none; } /* Hide scrollbar Chrome/Safari */

        .toolbar-btn {
            white-space: nowrap;
            flex-shrink: 0;
            font-size: 11px;
            padding: 8px 12px;
            border-radius: 8px;
            font-weight: 600;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            display: flex;
            align-items: center;
            gap: 6px;
        }

        /* Modal Animation */
        .modal { transition: opacity 0.25s ease; }
        body.modal-active { overflow: hidden; }

        /* Utilities */
        .text-xxs { font-size: 0.65rem; }
    </style>
</head>
<body>

    <div class="app-container">
        
        <!-- Header & Date -->
        <header class="flex flex-col md:flex-row justify-between items-start md:items-end mb-6 gap-2">
            <div class="flex items-center gap-3">
                <div class="w-10 h-10 bg-gradient-to-br from-brand-teal to-[#004d4a] rounded-xl flex items-center justify-center text-white text-xl shadow-md shrink-0">
                    <i class="fa-solid fa-building-columns"></i>
                </div>
                <div>
                    <h1 class="text-xl font-extrabold text-gray-800 uppercase leading-tight tracking-tight">Giám Sát Quyết Toán</h1>
                    <p class="text-xs text-gray-500 font-semibold tracking-wide">Core Banking Dashboard</p>
                </div>
            </div>
            
            <div class="flex items-center justify-between w-full md:w-auto mt-2 md:mt-0 bg-white px-3 py-2 rounded-lg shadow-sm border border-gray-100">
                <span class="text-xs font-semibold text-gray-400 uppercase mr-2">Ngày báo cáo:</span>
                <span class="text-base font-black text-brand-teal" id="report-date-display">--/--/----</span>
            </div>
        </header>

        <!-- Actions Toolbar (Scrollable on mobile) -->
        <div class="mobile-toolbar mb-6">
            <input type="file" id="excelFileInput" accept=".xlsx, .xls" class="hidden" />
            
            <button onclick="document.getElementById('excelFileInput').click()" class="toolbar-btn bg-brand-teal text-white active:bg-[#005452]">
                <i class="fa-solid fa-upload"></i> Upload Excel
            </button>
            
            <button onclick="downloadTemplate()" class="toolbar-btn bg-white text-brand-teal border border-brand-teal/30 active:bg-gray-50">
                <i class="fa-solid fa-download"></i> Tải Mẫu
            </button>

            <button onclick="toggleModal('dataModal')" class="toolbar-btn bg-white text-gray-600 border border-gray-200 active:bg-gray-50">
                <i class="fa-solid fa-database"></i> Quản lý Data
            </button>
            
            <button onclick="window.print()" class="toolbar-btn bg-blue-50 text-blue-600 border border-blue-100 active:bg-blue-100">
                <i class="fa-solid fa-print"></i> In Báo Cáo
            </button>
        </div>

        <!-- Section 1: KPIs (Stacked on Mobile, Grid on Tablet+) -->
        <section class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
            <!-- KPI 1 -->
            <div class="kpi-card-3d p-5 border-brand-teal">
                <div class="flex justify-between items-start">
                    <div>
                        <p class="text-xs font-bold text-gray-500 uppercase tracking-wider mb-1">Tổng Số Lượng GD</p>
                        <h3 class="text-3xl font-black text-gray-800 tracking-tight" id="kpi-count">--</h3>
                    </div>
                    <div class="w-10 h-10 bg-brand-teal/10 rounded-full flex items-center justify-center text-brand-teal">
                        <i class="fa-solid fa-layer-group"></i>
                    </div>
                </div>
                <div class="mt-4 flex items-center gap-2">
                    <div class="inline-flex items-center px-2 py-1 bg-green-100 text-green-700 text-xs font-bold rounded-md">
                        <i class="fa-solid fa-arrow-up mr-1"></i> <span id="kpi-growth-qty">--%</span>
                    </div>
                    <p class="text-xs font-medium text-gray-400">vs <span class="kpi-compare-date">--/--/--</span></p>
                </div>
            </div>

            <!-- KPI 2 -->
            <div class="kpi-card-3d p-5 border-brand-yellow">
                <div class="flex justify-between items-start">
                    <div>
                        <p class="text-xs font-bold text-gray-500 uppercase tracking-wider mb-1">Tổng Giá Trị (VND)</p>
                        <h3 class="text-3xl font-black text-gray-800 tracking-tight" id="kpi-value">--</h3>
                    </div>
                    <div class="w-10 h-10 bg-brand-yellow/10 rounded-full flex items-center justify-center text-brand-yellow">
                        <i class="fa-solid fa-sack-dollar"></i>
                    </div>
                </div>
                <div class="mt-4 flex items-center gap-2">
                    <div class="inline-flex items-center px-2 py-1 bg-green-100 text-green-700 text-xs font-bold rounded-md">
                        <i class="fa-solid fa-arrow-up mr-1"></i> <span id="kpi-growth-val">--%</span>
                    </div>
                    <p class="text-xs font-medium text-gray-400">vs <span class="kpi-compare-date">--/--/--</span></p>
                </div>
            </div>
        </section>

        <!-- Section 2: Trend Chart -->
        <section class="card-3d p-5">
            <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-4 gap-3">
                <h3 class="text-sm font-bold text-gray-800 uppercase">Xu hướng Giao dịch</h3>
                <!-- Legend - Wrapped for Mobile -->
                <div class="flex flex-wrap gap-2 text-[10px] font-medium bg-gray-50 px-2 py-1.5 rounded-lg border border-gray-100">
                    <span class="flex items-center gap-1.5"><span class="w-2.5 h-2.5 rounded-full bg-gray-400"></span><span id="lbl-trend-old">--</span></span>
                    <span class="flex items-center gap-1.5"><span class="w-2.5 h-2.5 rounded-full bg-brand-teal"></span><span id="lbl-trend-mid">--</span></span>
                    <span class="flex items-center gap-1.5"><span class="w-2.5 h-2.5 rounded-full bg-brand-yellow"></span><span id="lbl-trend-new">--</span></span>
                </div>
            </div>
            <div class="chart-container">
                <canvas id="trendChart"></canvas>
            </div>
        </section>

        <!-- Section 3: Channel Chart & Top 10 (Grid on Desktop, Stack on Mobile) -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
            
            <!-- Channel Chart -->
            <div class="card-3d p-5">
                <div class="mb-4 border-b border-gray-100 pb-2">
                    <h3 class="text-sm font-bold text-gray-800 uppercase">Tỷ trọng nhóm giao dịch</h3>
                </div>
                <!-- Increase height for better touch interaction -->
                <div class="chart-container" style="height: 280px;">
                    <canvas id="channelChart"></canvas>
                </div>
            </div>

            <!-- Top 10 Services Chart -->
            <div class="card-3d p-5">
                <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-4 gap-2">
                    <h3 class="text-sm font-bold text-gray-800 uppercase">Top 10 Dịch vụ</h3>
                    <div class="flex gap-2 text-[10px] font-bold">
                        <span class="flex items-center gap-1 px-2 py-1 rounded bg-brand-teal/10 text-brand-teal"><span class="w-2 h-2 rounded-full bg-brand-teal"></span><span id="lbl-top-newest">--</span></span>
                        <span class="flex items-center gap-1 px-2 py-1 rounded bg-brand-yellow/10 text-brand-yellow"><span class="w-2 h-2 rounded-full bg-brand-yellow"></span><span id="lbl-top-oldest">--</span></span>
                    </div>
                </div>
                <div class="chart-container" style="height: 350px;"> <!-- Taller for horizontal bars on mobile -->
                    <canvas id="topServiceChart"></canvas>
                </div>
            </div>
        </div>

        <!-- Section 4: Data Table (Scrollable) -->
        <section class="card-3d flex flex-col">
            <div class="bg-gray-50 px-5 py-3 border-b border-gray-200">
                <h3 class="text-xs font-extrabold text-gray-600 uppercase tracking-widest">Chi tiết giao dịch (Top 10)</h3>
            </div>
            <div class="table-responsive">
                <table class="compact-table w-full">
                    <thead>
                        <tr>
                            <th>Ngày GD</th>
                            <th>Nhóm Kênh</th>
                            <th>Mô tả Dịch vụ</th>
                            <th class="text-right">Số lượng</th>
                            <th class="text-right">Giá trị (VND)</th>
                        </tr>
                    </thead>
                    <tbody id="dataTableBody" class="text-gray-600">
                        <!-- Rows via JS -->
                    </tbody>
                </table>
            </div>
        </section>

        <!-- Footer Note -->
        <footer class="mt-8 text-center md:text-left">
            <div class="p-4 bg-red-50 rounded-xl border border-red-100">
                <p class="text-[10px] sm:text-xs text-red-600 font-bold leading-relaxed uppercase">
                    <i class="fa-solid fa-circle-exclamation mr-1"></i> Ghi chú: Tất cả giao dịch trên Core được chia thành các nhóm: Thanh toán, Mobile + Internet, Batch + Lô, ATM POS Thẻ, Smart Counter Hub, Quầy, Chứng khoán bảo hiểm. CÁC KÊNH MOBILE VÀ INTERNET BANKING CHƯA CÓ CÁC GIAO DỊCH THANH TOÁN
                </p>
            </div>
            <div class="mt-4 text-center text-[10px] text-gray-400">
                &copy; 2025 Banking Monitor System
            </div>
        </footer>

    </div>

    <!-- Data Management Modal -->
    <div id="dataModal" class="modal opacity-0 pointer-events-none fixed w-full h-full top-0 left-0 flex items-center justify-center z-50 px-4">
        <div class="modal-overlay absolute w-full h-full bg-gray-900/60 backdrop-blur-sm"></div>
        <div class="modal-container bg-white w-full max-w-md mx-auto rounded-2xl shadow-2xl z-50 overflow-hidden transform transition-all scale-95">
            <div class="bg-gray-50 px-6 py-4 border-b border-gray-100 flex justify-between items-center">
                <h3 class="font-bold text-lg text-gray-800">Quản lý Dữ liệu</h3>
                <button onclick="toggleModal('dataModal')" class="text-gray-400 hover:text-gray-600 w-8 h-8 flex items-center justify-center rounded-full hover:bg-gray-200 transition"><i class="fa-solid fa-xmark text-lg"></i></button>
            </div>
            <div class="p-6">
                <p class="text-xs text-gray-500 mb-3 uppercase font-bold">Danh sách ngày có dữ liệu:</p>
                <ul id="dateList" class="max-h-60 overflow-y-auto mb-6 border border-gray-200 rounded-xl divide-y divide-gray-100">
                    <!-- Items -->
                </ul>
                <button onclick="deleteAllData()" class="w-full bg-red-50 text-red-600 py-3 rounded-xl font-bold text-sm border border-red-100 hover:bg-red-100 transition flex items-center justify-center gap-2">
                    <i class="fa-solid fa-trash-can"></i> Xóa Toàn Bộ Dữ Liệu
                </button>
            </div>
        </div>
    </div>

    <script>
        // --- 1. CONFIG ---
        // Configure Chart.js for Mobile
        Chart.defaults.font.family = "'Inter', sans-serif";
        Chart.defaults.color = '#64748b';
        
        Chart.register(ChartDataLabels);

        const CONFIG = {
            colors: {
                teal: '#006b68',
                yellow: '#ffc62f',
                grey: '#94a3b8',
                text: '#334155',
                tealLight: '#2dd4bf',
                tealDark: '#004d4a'
            },
            storageKey: 'monitor_db_responsive_v1' // New key for mobile version
        };

        // --- 2. DATA & STATE ---
        const DEFAULT_DATA = [
            // --- Newest: 25/12/2025 ---
            { date: "2025-12-25", channel: "Thanh toán", desc: "A42 - 24x7 Napas", qty: 5086644, value: 45632437973946 },
            { date: "2025-12-25", channel: "Thanh toán", desc: "A23 - TT song phương", qty: 4900402, value: 22630370668772 },
            { date: "2025-12-25", channel: "Thanh toán", desc: "TTHD - Online bill payment", qty: 1714328, value: 8538807986287 },
            { date: "2025-12-25", channel: "Thanh toán", desc: "Payment Hub - Cau phan B2B", qty: 1485960, value: 9917109599476 },
            { date: "2025-12-25", channel: "Mobile + Internet", desc: "BIDV SmartBanking", qty: 1088714, value: 14166257422656 },
            { date: "2025-12-25", channel: "ATM POS Thẻ", desc: "Giao dịch ATM nội mạng", qty: 450000, value: 900000000000 },
            { date: "2025-12-25", channel: "Quầy", desc: "Giao dịch tiền mặt tại quầy", qty: 120000, value: 5000000000000 },
            
            // --- Middle: 24/12/2025 ---
            { date: "2025-12-24", channel: "Tổng hợp", desc: "Dữ liệu tổng hợp hôm qua", qty: 16039850, value: 95000000000000 },
            
            // --- Oldest: 25/12/2024 ---
            { date: "2024-12-25", channel: "Thanh toán", desc: "A42 - 24x7 Napas", qty: 3500000, value: 35000000000000 },
            { date: "2024-12-25", channel: "Thanh toán", desc: "A23 - TT song phương", qty: 3200000, value: 18000000000000 },
            { date: "2024-12-25", channel: "Thanh toán", desc: "TTHD - Online bill payment", qty: 1200000, value: 6000000000000 },
            { date: "2024-12-25", channel: "Mobile + Internet", desc: "BIDV SmartBanking", qty: 800000, value: 10000000000000 },
            { date: "2024-12-25", channel: "Tổng hợp", desc: "Dữ liệu khác", qty: 3290000, value: 20000000000000 }
        ];

        let appData = [];
        let charts = {};

        // --- 3. HELPERS ---
        const fmtNum = (n) => new Intl.NumberFormat('vi-VN').format(n);
        const fmtDate = (d) => d ? d.split('-').reverse().join('/') : 'N/A';
        
        const parseDate = (val) => {
            if (val instanceof Date) {
                const year = val.getFullYear();
                const month = String(val.getMonth() + 1).padStart(2, '0');
                const day = String(val.getDate()).padStart(2, '0');
                return `${year}-${month}-${day}`;
            }
            const str = String(val).trim();
            // Handle DD/MM/YYYY
            if(str.includes('/')) {
                const parts = str.split('/');
                if(parts.length === 3 && parts[2].length === 4) {
                    const day = parts[0].padStart(2, '0');
                    const month = parts[1].padStart(2, '0');
                    const year = parts[2];
                    return `${year}-${month}-${day}`;
                }
            }
            // Handle YYYY-MM-DD
            const isoParts = str.split('-');
            if(isoParts.length === 3) {
                 const year = isoParts[0];
                 const month = isoParts[1].padStart(2, '0');
                 const day = isoParts[2].padStart(2, '0');
                 return `${year}-${month}-${day}`;
            }
            return str;
        };

        // --- 4. CORE LOGIC ---
        function init() {
            const stored = localStorage.getItem(CONFIG.storageKey);
            appData = stored ? JSON.parse(stored) : [...DEFAULT_DATA];
            renderAll();
            setupFileUpload();
        }

        function renderAll() {
            // ... (Same data filtering logic as previous version, compact for brevity) ...
            if (!appData || appData.length === 0) {
                // Clear State logic here...
                document.getElementById('report-date-display').innerText = "--/--/----";
                document.getElementById('kpi-count').innerText = "0";
                document.getElementById('kpi-value').innerText = "0";
                if(charts.trend) charts.trend.destroy();
                if(charts.channel) charts.channel.destroy();
                if(charts.top10) charts.top10.destroy();
                document.getElementById('dataTableBody').innerHTML = '';
                return;
            }

            const datesAsc = [...new Set(appData.map(d => d.date))].sort((a,b) => new Date(a) - new Date(b));
            const d_oldest = datesAsc[0];
            const d_newest = datesAsc[datesAsc.length - 1];
            const d_middle = datesAsc.length > 2 ? datesAsc[datesAsc.length - 2] : null;

            document.getElementById('report-date-display').innerText = fmtDate(d_newest);

            const dataNewest = appData.filter(d => d.date === d_newest);
            const dataOldest = appData.filter(d => d.date === d_oldest);
            const dataMiddle = d_middle ? appData.filter(d => d.date === d_middle) : [];

            const qtyNewest = dataNewest.reduce((s,i) => s + i.qty, 0);
            const valNewest = dataNewest.reduce((s,i) => s + i.value, 0);
            const qtyOldest = dataOldest.reduce((s,i) => s + i.qty, 0);
            const valOldest = dataOldest.reduce((s,i) => s + i.value, 0);
            const qtyMiddle = dataMiddle.reduce((s,i) => s + i.qty, 0);

            const growthQty = qtyOldest > 0 ? ((qtyNewest - qtyOldest)/qtyOldest * 100).toFixed(1) : '--';
            const growthVal = valOldest > 0 ? ((valNewest - valOldest)/valOldest * 100).toFixed(1) : '--';

            document.getElementById('kpi-growth-qty').innerText = `${growthQty > 0 ? '+' : ''}${growthQty}%`;
            document.getElementById('kpi-growth-val').innerText = `${growthVal > 0 ? '+' : ''}${growthVal}%`;
            
            document.querySelectorAll('.kpi-compare-date').forEach(el => el.innerText = fmtDate(d_oldest));
            document.getElementById('kpi-count').innerText = fmtNum(qtyNewest);
            document.getElementById('kpi-value').innerText = (valNewest/1e12).toFixed(2) + ' Tỷ';

            document.getElementById('lbl-trend-old').innerText = fmtDate(d_oldest);
            document.getElementById('lbl-trend-mid').innerText = d_middle ? fmtDate(d_middle) : (datesAsc.length === 2 ? 'N/A' : '--/--/--');
            document.getElementById('lbl-trend-new').innerText = fmtDate(d_newest);

            document.getElementById('lbl-top-newest').innerText = fmtDate(d_newest);
            document.getElementById('lbl-top-oldest').innerText = fmtDate(d_oldest);

            renderTrendChart([qtyOldest, qtyMiddle, qtyNewest], [fmtDate(d_oldest), d_middle ? fmtDate(d_middle) : '', fmtDate(d_newest)]);
            renderChannelBarChart(dataNewest, qtyNewest);
            renderTop10(dataNewest, dataOldest, fmtDate(d_newest), fmtDate(d_oldest));
            renderTable(dataNewest);
        }

        // --- 5. CHARTS (Responsive Config) ---

        // Helper for gradients
        function getGradient(ctx, colorBase) {
            const gradient = ctx.createLinearGradient(0, 0, 0, 300);
            if(colorBase === CONFIG.colors.teal) { gradient.addColorStop(0, '#006b68'); gradient.addColorStop(1, '#008f8b'); }
            else if (colorBase === CONFIG.colors.yellow) { gradient.addColorStop(0, '#ffc62f'); gradient.addColorStop(1, '#ffda75'); }
            else { gradient.addColorStop(0, '#94a3b8'); gradient.addColorStop(1, '#cbd5e1'); }
            return gradient;
        }

        function renderTrendChart(dataArr, labelsArr) {
            const ctx = document.getElementById('trendChart').getContext('2d');
            if(charts.trend) charts.trend.destroy();

            const cleanDataSets = [];
            const cleanLabels = [];
            // Logic: 0 -> Oldest (Grey), 1 -> Middle (Teal), 2 -> Newest (Yellow)
            const baseColors = [CONFIG.colors.grey, CONFIG.colors.teal, CONFIG.colors.yellow];
            let finalColors = [];

            dataArr.forEach((val, idx) => {
                if(labelsArr[idx]) {
                    cleanDataSets.push(val);
                    cleanLabels.push(labelsArr[idx]);
                    finalColors.push(getGradient(ctx, baseColors[idx]));
                }
            });
            // Fix if only 2
            if(cleanDataSets.length === 2 && !labelsArr[1]) finalColors = [getGradient(ctx, CONFIG.colors.grey), getGradient(ctx, CONFIG.colors.yellow)];

            charts.trend = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: cleanLabels,
                    datasets: [{
                        data: cleanDataSets,
                        backgroundColor: finalColors,
                        borderRadius: 6,
                        barPercentage: 0.6,
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    layout: { padding: { top: 20 } }, 
                    plugins: {
                        legend: { display: false },
                        tooltip: { enabled: false }, // No tooltip on mobile touch
                        datalabels: {
                            anchor: 'end', align: 'top', offset: 2,
                            color: CONFIG.colors.text,
                            font: { weight: 'bold', size: 10 },
                            formatter: (val) => val > 0 ? (val/1e6).toFixed(1) + 'M' : ''
                        }
                    },
                    scales: { 
                        y: { display: false, min: 0, grace: '10%' }, 
                        x: { grid: { display: false }, ticks: { font: {size: 10} } } 
                    }
                }
            });
        }

        function renderChannelBarChart(data, total) {
            const ctx = document.getElementById('channelChart').getContext('2d');
            if(charts.channel) charts.channel.destroy();

            const groups = {};
            data.forEach(d => { groups[d.channel] = (groups[d.channel] || 0) + d.qty; });
            const entries = Object.entries(groups).sort((a, b) => b[1] - a[1]); // Sort Asc for Bar chart (Bottom up)
            
            // For Horizontal Bar, Ascending sort puts smallest at bottom, largest at top.
            // Let's reverse data for better mobile view (Largest Top)
            // But Chartjs Horizontal Bar renders first index at Top. So we need DESCENDING Sort of values
            // Currently entries is Ascending value.
            
            // Let's manually sort Descending for visual "Top to Bottom"
            entries.sort((a,b) => b[1] - a[1]); // Descending

            const labels = entries.map(e => e[0]);
            const values = entries.map(e => e[1]);

            // Gradients
            const bgColors = values.map((val, index) => {
                const pct = (val / total);
                const g = ctx.createLinearGradient(0, 0, 200, 0); 
                if (pct > 0.5) { g.addColorStop(0, CONFIG.colors.teal); g.addColorStop(1, '#008f8b'); } 
                else if (pct > 0.2) { g.addColorStop(0, '#2dd4bf'); g.addColorStop(1, '#5eead4'); } 
                else if (pct > 0.1) { g.addColorStop(0, CONFIG.colors.yellow); g.addColorStop(1, '#ffda75'); } 
                else { g.addColorStop(0, '#cbd5e1'); g.addColorStop(1, '#e2e8f0'); }
                return g;
            });

            charts.channel = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{ data: values, backgroundColor: bgColors, borderRadius: 4, barThickness: 16 }]
                },
                options: {
                    indexAxis: 'y',
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: { enabled: false },
                        datalabels: {
                            anchor: 'end', align: 'right', color: '#334155',
                            font: { size: 10, weight: 'bold' },
                            formatter: (val) => { const pct = (val/total)*100; return pct.toFixed(1) + '%'; }
                        }
                    },
                    scales: {
                        x: { display: false, max: Math.max(...values) * 1.35 }, 
                        y: { grid: { display: false }, ticks: { font: { size: 10, weight: 500 }, autoSkip: false } }
                    },
                    layout: { padding: { right: 30 } }
                }
            });
        }

        function renderTop10(dataNewest, dataOldest, labelNewest, labelOldest) {
            const ctx = document.getElementById('topServiceChart').getContext('2d');
            if(charts.top10) charts.top10.destroy();

            const getMap = (arr) => { const map = {}; arr.forEach(d => { map[d.desc] = (map[d.desc] || 0) + d.qty; }); return map; };
            const mapNewest = getMap(dataNewest);
            const mapOldest = getMap(dataOldest);

            const sortedKeys = Object.keys(mapNewest).sort((a,b) => mapNewest[b] - mapNewest[a]).slice(0, 10);
            
            // Trim labels on mobile
            const isMobile = window.innerWidth < 768;
            const maxLen = isMobile ? 20 : 38;
            const labels = sortedKeys.map(k => k.length > maxLen ? k.substring(0,maxLen-2)+'...' : k);
            
            const valuesNewest = sortedKeys.map(k => mapNewest[k]);
            const valuesOldest = sortedKeys.map(k => mapOldest[k] || 0);

            const gradNew = ctx.createLinearGradient(0, 0, 300, 0); gradNew.addColorStop(0, CONFIG.colors.teal); gradNew.addColorStop(1, '#008f8b');
            const gradOld = ctx.createLinearGradient(0, 0, 300, 0); gradOld.addColorStop(0, CONFIG.colors.yellow); gradOld.addColorStop(1, '#ffda75');

            charts.top10 = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [
                        { label: labelNewest, data: valuesNewest, backgroundColor: gradNew, borderRadius: 4, barThickness: 12 },
                        { label: labelOldest, data: valuesOldest, backgroundColor: gradOld, borderRadius: 4, barThickness: 12 }
                    ]
                },
                options: {
                    indexAxis: 'y',
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        datalabels: {
                            anchor: 'end', align: 'right',
                            color: (ctx) => ctx.datasetIndex === 0 ? CONFIG.colors.teal : '#b45309',
                            font: { weight: 'bold', size: 9 },
                            formatter: (val) => val > 0 ? fmtNum(val) : ''
                        }
                    },
                    scales: {
                        x: { display: false, max: Math.max(...valuesNewest, ...valuesOldest) * 1.3 },
                        y: { grid: { display: false }, ticks: { font: {size: 10} } }
                    },
                    layout: { padding: { right: 40 } }
                }
            });
        }

        function renderTable(data) {
            const tbody = document.getElementById('dataTableBody');
            tbody.innerHTML = '';
            
            data.slice(0, 10).forEach((row, idx) => {
                const tr = document.createElement('tr');
                tr.className = idx % 2 === 0 ? "bg-white" : "bg-gray-50/50"; 
                tr.innerHTML = `
                    <td>${fmtDate(row.date)}</td>
                    <td><span class="px-2 py-0.5 rounded-full bg-gray-100 text-[10px] font-bold border border-gray-200 text-gray-600">${row.channel}</span></td>
                    <td class="font-medium text-gray-800">${row.desc}</td>
                    <td class="text-right font-bold text-brand-teal">${fmtNum(row.qty)}</td>
                    <td class="text-right text-gray-500 font-mono text-[10px]">${fmtNum(row.value)}</td>
                `;
                tbody.appendChild(tr);
            });
        }

        // --- UTILS (Same as before) ---
        function downloadTemplate() { /* ... */ const ws_data = [["Ngay GD", "Nhóm kênh", "Mo ta", "So luong", "Gia tri quy doi"]]; const ws = XLSX.utils.aoa_to_sheet(ws_data); const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, ws, "Mau_Nhap_Lieu"); XLSX.writeFile(wb, "Template_Bao_Cao.xlsx"); }
        function setupFileUpload() { /* ... */ document.getElementById('excelFileInput').addEventListener('change', (e) => { const file = e.target.files[0]; if(!file) return; const reader = new FileReader(); reader.onload = (e) => { const data = new Uint8Array(e.target.result); const workbook = XLSX.read(data, {type: 'array'}); const jsonData = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]], {raw: false, cellDates: true}); if (jsonData.length > 0) processUploadedData(jsonData); document.getElementById('excelFileInput').value = ''; }; reader.readAsArrayBuffer(file); }); }
        function processUploadedData(rawData) { /* ... */ const mappedData = rawData.map(r => { const qtyKey = Object.keys(r).find(k => k.toLowerCase().includes('so luong') || k.toLowerCase().includes('qty')); const valKey = Object.keys(r).find(k => k.toLowerCase().includes('quy doi') || k.toLowerCase().includes('value')); const descKey = Object.keys(r).find(k => k.toLowerCase().includes('mo ta') || k.toLowerCase().includes('desc')); const dateKey = Object.keys(r).find(k => k.toLowerCase().includes('ngay') || k.toLowerCase().includes('date')); const chKey = Object.keys(r).find(k => k.toLowerCase().includes('nhóm kênh') || k.toLowerCase().includes('channel')); if(!qtyKey || !dateKey) return null; const cleanNum = (v) => (typeof v === 'number' ? v : parseFloat(String(v||'0').replace(/,/g, ''))); return { date: parseDate(r[dateKey]), channel: r[chKey] || 'Khác', desc: r[descKey] || 'N/A', qty: cleanNum(r[qtyKey]), value: cleanNum(r[valKey]) }; }).filter(i => i && i.qty > 0); if(!mappedData.length) return alert("File không hợp lệ"); const datesToUpdate = new Set(mappedData.map(d => d.date)); appData = appData.filter(d => !datesToUpdate.has(d.date)); appData.push(...mappedData); localStorage.setItem(CONFIG.storageKey, JSON.stringify(appData)); renderAll(); alert(`Cập nhật thành công ${[...datesToUpdate].length} ngày dữ liệu`); }
        function toggleModal(id){ document.getElementById(id).classList.toggle('opacity-0'); document.getElementById(id).classList.toggle('pointer-events-none'); if(!document.getElementById(id).classList.contains('opacity-0')) renderDateList(); }
        function renderDateList() { const list = document.getElementById('dateList'); const dates = [...new Set(appData.map(d => d.date))].sort().reverse(); list.innerHTML = dates.map(d => `<li class="flex justify-between items-center py-3 border-b border-gray-100 last:border-0"><span class="font-medium text-gray-700">${d}</span><button class="text-red-500 bg-red-50 p-2 rounded-lg hover:bg-red-100 transition" onclick="deleteDate('${d}')"><i class="fa-solid fa-trash"></i></button></li>`).join(''); }
        function deleteDate(d) { if(confirm('Xóa dữ liệu ngày ' + d + '?')) { appData = appData.filter(i => i.date !== d); localStorage.setItem(CONFIG.storageKey, JSON.stringify(appData)); renderDateList(); renderAll(); } }
        function deleteAllData() { if(confirm('Xóa TOÀN BỘ dữ liệu?')) { localStorage.removeItem(CONFIG.storageKey); appData = []; renderDateList(); renderAll(); toggleModal('dataModal'); } }

        window.onload = init;
    </script>
</body>
</html>
