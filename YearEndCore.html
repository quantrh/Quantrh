<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Báo cáo Quyết toán - Financial Professional Style</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Chart.js & Plugins -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
    
    <!-- SheetJS (xlsx) for Excel processing -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- Google Fonts: Inter (Data) & Playfair Display (Headers) -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Playfair+Display:wght@400;600;700&display=swap" rel="stylesheet">

    <style>
        :root {
            /* Updated Brand Colors */
            --bidv-green: #006B68;
            --bidv-yellow: #FFC62F; /* Updated from #fdb913 */
            
            --paper-bg: #fdfbf7; /* Màu giấy Wall Street */
            --text-primary: #1e293b;
            --border-color: #cbd5e1;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: #2d3748; /* Nền tối bên ngoài để làm nổi bật trang giấy */
            color: var(--text-primary);
            display: flex;
            justify-content: center;
            padding: 40px 20px;
        }

        /* Typography Override for Financial Look */
        h1, h2, h3, .serif-font {
            font-family: 'Playfair Display', serif;
        }

        /* A4 Page Simulation - Financial Report Style */
        .page-a4 {
            background-color: var(--paper-bg);
            width: 210mm;
            min-height: 297mm;
            padding: 12mm 15mm;
            /* 2D Effect: No soft shadows, just a clean hard border relative to background */
            box-shadow: 0 0 0 1px rgba(255,255,255,0.1); 
            display: flex;
            flex-direction: column;
            box-sizing: border-box;
            position: relative;
        }

        /* Components: Flat, Bordered, Professional */
        .report-card {
            background: white;
            border: 1px solid var(--border-color);
            border-radius: 2px; /* Góc vuông hoặc bo cực nhẹ */
            position: relative;
        }

        .report-section-header {
            border-bottom: 2px solid var(--bidv-green);
            padding-bottom: 8px;
            margin-bottom: 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .report-section-title {
            font-family: 'Playfair Display', serif;
            font-weight: 700;
            font-size: 14px;
            color: #0f172a;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        /* KPI Specifics */
        .kpi-box {
            background-color: #fff;
            border: 1px solid var(--border-color);
            padding: 12px 16px;
        }
        
        /* Table Styling - Clean Financial Lines */
        .financial-table th {
            font-family: 'Inter', sans-serif;
            font-size: 9px;
            font-weight: 700;
            text-transform: uppercase;
            color: var(--bidv-green);
            border-bottom: 2px solid var(--border-color);
            padding: 8px;
            background-color: transparent;
        }
        .financial-table td {
            font-size: 10px;
            padding: 8px;
            border-bottom: 1px solid #e2e8f0;
            color: #334155;
        }
        .financial-table tr:last-child td { border-bottom: none; }
        .financial-table tr:nth-child(even) { background-color: rgba(0,0,0,0.01); }

        /* Icon Styling */
        .icon-circle {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background-color: rgba(0, 107, 104, 0.1);
            color: var(--bidv-green);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
        }

        /* Utility */
        .text-bidv-green { color: var(--bidv-green); }
        .bg-bidv-green { background-color: var(--bidv-green); }
        .text-bidv-yellow { color: #d97706; /* Darker yellow for text readability */ }
        
        /* Print Settings */
        @media print {
            body { background: none; padding: 0; }
            .page-a4 { width: 100%; box-shadow: none; margin: 0; border: none; }
            .no-print { display: none !important; }
            .report-card, .kpi-box { border: 1px solid #000; } /* High contrast for print */
        }
        
        /* Modal */
        .modal { transition: opacity 0.2s ease; }
    </style>
</head>
<body>

    <!-- Toolbar (No Print) -->
    <div class="fixed top-6 right-6 flex flex-col gap-3 no-print z-50">
        <input type="file" id="excelFileInput" accept=".xlsx, .xls" class="hidden" />
        
        <button onclick="document.getElementById('excelFileInput').click()" class="bg-bidv-green text-white px-4 py-2 rounded-sm shadow hover:bg-[#005452] text-xs font-semibold flex items-center gap-2 transition border border-[#004d4a]">
            <i class="fa-solid fa-upload"></i> Upload Excel
        </button>
        
        <button onclick="downloadTemplate()" class="bg-white text-bidv-green border border-bidv-green px-4 py-2 rounded-sm shadow hover:bg-gray-50 text-xs font-semibold flex items-center gap-2 transition">
            <i class="fa-solid fa-download"></i> Tải Mẫu
        </button>

        <button onclick="toggleModal('dataModal')" class="bg-slate-700 text-white px-4 py-2 rounded-sm shadow hover:bg-slate-800 text-xs font-semibold flex items-center gap-2 transition border border-slate-900">
            <i class="fa-solid fa-database"></i> Dữ liệu
        </button>
        
        <button onclick="window.print()" class="bg-blue-700 text-white px-4 py-2 rounded-sm shadow hover:bg-blue-800 text-xs font-semibold flex items-center gap-2 transition border border-blue-900">
            <i class="fa-solid fa-print"></i> In Báo Cáo
        </button>
    </div>

    <!-- A4 PAGE CONTENT -->
    <div class="page-a4" id="printArea">
        
        <!-- Header Section -->
        <header class="flex justify-between items-start border-b-4 border-double border-gray-300 pb-4 mb-6">
            <div class="flex items-center gap-5">
                <!-- BIDV Logo Simulation -->
                <div class="w-14 h-14 bg-white border border-gray-200 flex items-center justify-center text-bidv-green text-3xl">
                    <i class="fa-solid fa-building-columns"></i>
                </div>
                <div>
                    <h1 class="text-3xl font-bold text-bidv-green uppercase tracking-tight leading-none">CORE BANKING MONITOR</h1>
                    <p class="text-[11px] text-gray-500 font-semibold tracking-widest mt-1 uppercase font-serif">Hệ thống Core Banking - Daily Report</p>
                </div>
            </div>
            <div class="text-right">
                <div class="text-[9px] font-bold text-gray-400 uppercase tracking-widest mb-1">Ngày dữ liệu</div>
                <div class="text-2xl font-bold text-gray-800 font-serif" id="report-date-display">--/--/----</div>
            </div>
        </header>

        <!-- Section 1: Executive Summary (KPIs) -->
        <section class="mb-6">
            <div class="grid grid-cols-2 gap-6">
                <!-- KPI 1: Qty -->
                <div class="kpi-box flex flex-col justify-between h-28 border-t-4 border-t-[#006B68]">
                    <div class="flex justify-between items-start">
                        <div>
                            <p class="text-[10px] font-bold text-gray-500 uppercase flex items-center gap-2">
                                <i class="fa-solid fa-file-invoice text-bidv-green"></i> Tổng Số Lượng GD
                            </p>
                            <h3 class="text-3xl font-bold text-gray-800 mt-2 font-mono tracking-tight" id="kpi-count">--</h3>
                        </div>
                    </div>
                    <div class="flex justify-between items-end border-t border-gray-100 pt-2 mt-2">
                        <span class="text-[10px] text-gray-400">So với ngày <span class="kpi-compare-date font-bold">--</span></span>
                        <div class="text-xs font-bold text-bidv-green flex items-center">
                            <i class="fa-solid fa-arrow-trend-up mr-1"></i> <span id="kpi-growth-qty">--%</span>
                        </div>
                    </div>
                </div>

                <!-- KPI 2: Value -->
                <div class="kpi-box flex flex-col justify-between h-28 border-t-4 border-t-[#FFC62F]">
                    <div class="flex justify-between items-start">
                        <div>
                            <p class="text-[10px] font-bold text-gray-500 uppercase flex items-center gap-2">
                                <i class="fa-solid fa-coins text-yellow-600"></i> Tổng Giá Trị (VND)
                            </p>
                            <h3 class="text-3xl font-bold text-gray-800 mt-2 font-mono tracking-tight" id="kpi-value">--</h3>
                        </div>
                    </div>
                    <div class="flex justify-between items-end border-t border-gray-100 pt-2 mt-2">
                        <span class="text-[10px] text-gray-400">So với ngày <span class="kpi-compare-date font-bold">--</span></span>
                        <div class="text-xs font-bold text-yellow-600 flex items-center">
                            <i class="fa-solid fa-arrow-trend-up mr-1"></i> <span id="kpi-growth-val">--%</span>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Section 2: Charts Area -->
        <section class="report-card p-5 mb-6 flex flex-row gap-6 h-[260px]">
            <!-- Trend Chart -->
            <div class="flex-1 flex flex-col border-r border-gray-200 pr-6">
                <div class="report-section-header">
                    <h3 class="report-section-title"><i class="fa-solid fa-chart-line text-bidv-green"></i> Xu hướng Giao dịch</h3>
                    <!-- Legend -->
                    <div class="flex gap-3 text-[9px] font-medium font-serif italic text-gray-500">
                        <span class="flex items-center gap-1"><span class="w-2 h-2 bg-gray-300"></span><span id="lbl-trend-old">--</span></span>
                        <span class="flex items-center gap-1"><span class="w-2 h-2 bg-bidv-green"></span><span id="lbl-trend-mid">--</span></span>
                        <span class="flex items-center gap-1"><span class="w-2 h-2 bg-[#FFC62F]"></span><span id="lbl-trend-new">--</span></span>
                    </div>
                </div>
                <div class="flex-1 relative w-full">
                    <canvas id="trendChart"></canvas>
                </div>
            </div>

            <!-- Channel Chart -->
            <div class="w-[35%] flex flex-col">
                <div class="report-section-header">
                    <h3 class="report-section-title"><i class="fa-solid fa-chart-pie text-bidv-green"></i> Tỷ trọng Kênh</h3>
                </div>
                <div class="flex-1 relative w-full">
                    <canvas id="channelChart"></canvas>
                </div>
            </div>
        </section>

        <!-- Section 3: Top Services -->
        <section class="report-card p-5 mb-6 h-[280px] flex flex-col">
            <div class="report-section-header">
                <h3 class="report-section-title"><i class="fa-solid fa-ranking-star text-bidv-green"></i> Top 10 Dịch vụ (Số lượng)</h3>
                <div class="flex gap-4 text-[9px] font-bold">
                    <div class="flex items-center gap-1 text-bidv-green">
                        <i class="fa-solid fa-square text-[8px]"></i> <span id="lbl-top-newest">--</span>
                    </div>
                    <div class="flex items-center gap-1 text-yellow-600">
                        <i class="fa-solid fa-square text-[8px]"></i> <span id="lbl-top-oldest">--</span>
                    </div>
                </div>
            </div>
            <div class="flex-1 w-full relative">
                <canvas id="topServiceChart"></canvas>
            </div>
        </section>

        <!-- Section 4: Data Table -->
        <section class="flex-1 flex flex-col mb-2">
            <div class="report-section-header mb-0">
                <h3 class="report-section-title"><i class="fa-solid fa-list-ol text-bidv-green"></i> Chi tiết Giao dịch (Top 10)</h3>
            </div>
            <div class="overflow-hidden border border-t-0 border-gray-200 bg-white">
                <table class="w-full text-left financial-table">
                    <thead>
                        <tr>
                            <th class="w-[10%]">Ngày GD</th>
                            <th class="w-[15%]">Nhóm Kênh</th>
                            <th class="w-[35%]">Mô tả Dịch vụ</th>
                            <th class="w-[15%] text-right">Số lượng</th>
                            <th class="w-[25%] text-right">Giá trị (VND)</th>
                        </tr>
                    </thead>
                    <tbody id="dataTableBody">
                        <!-- Content -->
                    </tbody>
                </table>
            </div>
        </section>

        <!-- Footer -->
        <footer class="mt-auto border-t-2 border-gray-800 pt-3">
            <div class="flex justify-between items-start text-[9px] leading-relaxed">
                <div class="w-3/4 text-gray-600 text-justify pr-4 italic font-serif">
                    <span class="font-bold text-gray-900 not-italic uppercase">Ghi chú:</span> Tất cả giao dịch trên Core được chia thành các nhóm: Thanh toán, Mobile + Internet, Batch + Lô, ATM POS Thẻ, Smart Counter Hub, Quầy, Chứng khoán bảo hiểm. CÁC KÊNH MOBILE VÀ INTERNET BANKING CHƯA CÓ CÁC GIAO DỊCH THANH TOÁN
                </div>
                <div class="w-1/4 text-right">
                    <div class="font-bold text-bidv-green font-serif text-xs">BAN QL&PT CORE BANKING</div>
                    <div class="text-gray-400 mt-1">Page 1 of 1</div>
                </div>
            </div>
        </footer>

    </div>

    <!-- Data Management Modal -->
    <div id="dataModal" class="modal opacity-0 pointer-events-none fixed w-full h-full top-0 left-0 flex items-center justify-center z-50 no-print">
        <div class="modal-overlay absolute w-full h-full bg-slate-900 opacity-70"></div>
        <div class="modal-container bg-white w-96 mx-auto rounded-sm shadow-2xl z-50 p-6 border-t-4 border-bidv-green">
            <div class="flex justify-between items-center mb-6 border-b pb-2">
                <h3 class="font-bold text-lg font-serif text-bidv-green">Quản lý Dữ liệu</h3>
                <button onclick="toggleModal('dataModal')" class="text-gray-400 hover:text-gray-600"><i class="fa-solid fa-times"></i></button>
            </div>
            <ul id="dateList" class="max-h-40 overflow-y-auto mb-6 border border-gray-200 rounded-sm text-sm p-0"></ul>
            <button onclick="deleteAllData()" class="w-full bg-red-50 text-red-700 border border-red-200 py-2 rounded-sm font-bold text-xs hover:bg-red-100 uppercase tracking-wide transition">
                <i class="fa-solid fa-trash-can mr-2"></i> Xóa Toàn Bộ Dữ liệu
            </button>
        </div>
    </div>

    <script>
        // --- 1. CONFIG & CONSTANTS ---
        Chart.register(ChartDataLabels);

        const CONFIG = {
            colors: {
                teal: '#006B68',
                yellow: '#FFC62F', // Updated Yellow
                grey: '#64748b',
                text: '#1e293b',
                gridLine: '#f1f5f9'
            },
            storageKey: 'monitor_db_finance_style_v2' 
        };

        // --- 2. LOGIC DATE PROCESSING ---
        const fmtNum = (n) => new Intl.NumberFormat('vi-VN').format(n);
        const fmtDate = (d) => d ? d.split('-').reverse().join('/') : 'N/A';
        
        const parseDate = (val) => {
            if (val instanceof Date) {
                const year = val.getFullYear();
                const month = String(val.getMonth() + 1).padStart(2, '0');
                const day = String(val.getDate()).padStart(2, '0');
                return `${year}-${month}-${day}`;
            }
            const str = String(val).trim();
            if(str.includes('/')) {
                const parts = str.split('/');
                if(parts.length === 3) {
                    let p0 = parseInt(parts[0], 10);
                    let p1 = parseInt(parts[1], 10);
                    let p2 = parseInt(parts[2], 10);
                    if (p2 < 100) p2 += 2000;
                    const sP0 = String(p0).padStart(2, '0');
                    const sP1 = String(p1).padStart(2, '0');
                    const sYear = String(p2);
                    if (p0 > 12) return `${sYear}-${sP1}-${sP0}`; 
                    else if (p1 > 12) return `${sYear}-${sP0}-${sP1}`;
                    else return `${sYear}-${sP1}-${sP0}`;
                }
            }
            if (str.match(/^\d{4}-\d{2}-\d{2}$/)) return str;
            const isoParts = str.split('-');
            if(isoParts.length === 3) {
                 return `${isoParts[0]}-${isoParts[1].padStart(2, '0')}-${isoParts[2].padStart(2, '0')}`;
            }
            return str;
        };

        // --- 3. DEFAULT DATA ---
        const DEFAULT_DATA = [
            { date: "2025-12-25", channel: "Thanh toán", desc: "A42 - 24x7 Napas", qty: 5086644, value: 45632437973946 },
            { date: "2025-12-25", channel: "Thanh toán", desc: "A23 - TT song phương", qty: 4900402, value: 22630370668772 },
            { date: "2025-12-25", channel: "Thanh toán", desc: "TTHD - Online bill payment", qty: 1714328, value: 8538807986287 },
            { date: "2025-12-25", channel: "Payment Hub", desc: "Payment Hub - Cau phan B2B", qty: 1485960, value: 9917109599476 },
            { date: "2025-12-25", channel: "Mobile + Internet", desc: "BIDV SmartBanking", qty: 1088714, value: 14166257422656 },
            { date: "2025-12-25", channel: "ATM POS Thẻ", desc: "Giao dịch ATM nội mạng", qty: 450000, value: 900000000000 },
            { date: "2025-12-25", channel: "Quầy", desc: "Giao dịch tiền mặt tại quầy", qty: 120000, value: 5000000000000 },
            { date: "2025-12-24", channel: "Tổng hợp", desc: "Dữ liệu tổng hợp hôm qua", qty: 16039850, value: 95000000000000 },
            { date: "2024-12-25", channel: "Thanh toán", desc: "A42 - 24x7 Napas", qty: 3500000, value: 35000000000000 },
            { date: "2024-12-25", channel: "Thanh toán", desc: "A23 - TT song phương", qty: 3200000, value: 18000000000000 },
            { date: "2024-12-25", channel: "Mobile + Internet", desc: "BIDV SmartBanking", qty: 800000, value: 10000000000000 },
            { date: "2024-12-25", channel: "Tổng hợp", desc: "Dữ liệu khác", qty: 3290000, value: 20000000000000 }
        ];

        let appData = [];
        let charts = {};

        // --- 4. APP LOGIC ---
        function init() {
            const stored = localStorage.getItem(CONFIG.storageKey);
            appData = stored ? JSON.parse(stored) : [...DEFAULT_DATA];
            renderAll();
            setupFileUpload();
        }

        function renderAll() {
            if (!appData || appData.length === 0) return;

            const datesAsc = [...new Set(appData.map(d => d.date))].sort((a,b) => new Date(a) - new Date(b));
            const d_oldest = datesAsc[0];
            const d_newest = datesAsc[datesAsc.length - 1];
            const d_middle = datesAsc.length > 2 ? datesAsc[datesAsc.length - 2] : null;

            document.getElementById('report-date-display').innerText = fmtDate(d_newest);

            const dataNewest = appData.filter(d => d.date === d_newest);
            const dataOldest = appData.filter(d => d.date === d_oldest);
            
            // Calc Metrics
            const qtyNewest = dataNewest.reduce((s,i) => s + i.qty, 0);
            const valNewest = dataNewest.reduce((s,i) => s + i.value, 0);
            const qtyOldest = dataOldest.reduce((s,i) => s + i.qty, 0);
            const valOldest = dataOldest.reduce((s,i) => s + i.value, 0);
            const qtyMiddle = d_middle ? appData.filter(d => d.date === d_middle).reduce((s,i)=>s+i.qty,0) : 0;

            // KPIs
            const growthQty = qtyOldest > 0 ? ((qtyNewest - qtyOldest)/qtyOldest * 100).toFixed(1) : '--';
            const growthVal = valOldest > 0 ? ((valNewest - valOldest)/valOldest * 100).toFixed(1) : '--';

            document.getElementById('kpi-growth-qty').innerText = `${growthQty > 0 ? '+' : ''}${growthQty}%`;
            document.getElementById('kpi-growth-val').innerText = `${growthVal > 0 ? '+' : ''}${growthVal}%`;
            document.querySelectorAll('.kpi-compare-date').forEach(el => el.innerText = fmtDate(d_oldest));
            document.getElementById('kpi-count').innerText = fmtNum(qtyNewest);
            document.getElementById('kpi-value').innerText = (valNewest/1e12).toFixed(2) + ' Tỷ';

            // Legend
            document.getElementById('lbl-trend-old').innerText = fmtDate(d_oldest);
            document.getElementById('lbl-trend-mid').innerText = d_middle ? fmtDate(d_middle) : (datesAsc.length === 2 ? 'N/A' : '-');
            document.getElementById('lbl-trend-new').innerText = fmtDate(d_newest);
            document.getElementById('lbl-top-newest').innerText = fmtDate(d_newest);
            document.getElementById('lbl-top-oldest').innerText = fmtDate(d_oldest);

            // Render Charts with Flat Colors
            renderTrendChart([qtyOldest, qtyMiddle, qtyNewest], [fmtDate(d_oldest), d_middle ? fmtDate(d_middle) : '', fmtDate(d_newest)]);
            renderChannelBarChart(dataNewest, qtyNewest);
            renderTop10(dataNewest, dataOldest, fmtDate(d_newest), fmtDate(d_oldest));
            renderTable(dataNewest);
        }

        // --- 5. CHART RENDERERS (2D FLAT STYLE) ---

        function renderTrendChart(dataArr, labelsArr) {
            const ctx = document.getElementById('trendChart').getContext('2d');
            if(charts.trend) charts.trend.destroy();

            // Clean data
            const cleanData = [];
            const cleanLabels = [];
            const bgColors = [];
            
            // Logic: Oldest(Grey) -> Middle(Teal) -> Newest(Yellow)
            const mapColors = ['#cbd5e1', CONFIG.colors.teal, CONFIG.colors.yellow]; 
            
            dataArr.forEach((val, idx) => {
                if(labelsArr[idx]) {
                    cleanData.push(val);
                    cleanLabels.push(labelsArr[idx]);
                    bgColors.push(mapColors[idx]);
                }
            });
            
            if(cleanData.length === 2 && !labelsArr[1]) bgColors[1] = CONFIG.colors.yellow; // If only 2, use grey & yellow

            charts.trend = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: cleanLabels,
                    datasets: [{
                        data: cleanData,
                        backgroundColor: bgColors,
                        borderRadius: 0,
                        barPercentage: 0.5,
                        borderColor: '#94a3b8',
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: { enabled: false },
                        datalabels: {
                            anchor: 'end',
                            align: 'top',
                            offset: 2,
                            color: CONFIG.colors.text,
                            font: { weight: 'bold', size: 10, family: 'Inter' },
                            formatter: (val) => val > 0 ? (val/1e6).toFixed(1) + 'M' : ''
                        }
                    },
                    scales: { 
                        y: { display: false, min: 0, grace: '15%' }, 
                        x: { 
                            grid: { display: false }, 
                            ticks: { font: {size: 10, family: 'Inter', weight: '500'}, color: CONFIG.colors.text } 
                        } 
                    },
                    layout: { padding: { top: 20 } }
                }
            });
        }

        function renderChannelBarChart(data, total) {
            const ctx = document.getElementById('channelChart').getContext('2d');
            if(charts.channel) charts.channel.destroy();

            const groups = {};
            data.forEach(d => { groups[d.channel] = (groups[d.channel] || 0) + d.qty; });
            const entries = Object.entries(groups).sort((a, b) => b[1] - a[1]);
            const labels = entries.map(e => e[0]);
            const values = entries.map(e => e[1]);

            // Simple Flat Colors
            const bgColors = values.map((val, i) => {
                if(i === 0) return CONFIG.colors.teal;
                if(i === 1) return '#2dd4bf'; // lighter teal
                return '#cbd5e1'; // grey
            });

            charts.channel = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        data: values,
                        backgroundColor: bgColors,
                        borderRadius: 0,
                        barThickness: 10
                    }]
                },
                options: {
                    indexAxis: 'y',
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: { enabled: false },
                        datalabels: {
                            anchor: 'end',
                            align: 'right',
                            color: '#1e293b',
                            font: { size: 9, weight: '600' },
                            formatter: (val) => ((val/total)*100).toFixed(1) + '%'
                        }
                    },
                    scales: {
                        x: { display: false, max: Math.max(...values) * 1.5 }, 
                        y: { grid: { display: false }, ticks: { font: { size: 9, family: 'Inter' }, autoSkip: false } }
                    },
                    layout: { padding: { right: 20 } }
                }
            });
        }

        function renderTop10(dataNewest, dataOldest, labelNewest, labelOldest) {
            const ctx = document.getElementById('topServiceChart').getContext('2d');
            if(charts.top10) charts.top10.destroy();

            const getMap = (arr) => {
                const map = {};
                arr.forEach(d => { map[d.desc] = (map[d.desc] || 0) + d.qty; });
                return map;
            };
            const mapNewest = getMap(dataNewest);
            const mapOldest = getMap(dataOldest);
            const sortedKeys = Object.keys(mapNewest).sort((a,b) => mapNewest[b] - mapNewest[a]).slice(0, 10);

            const labels = sortedKeys.map(k => k.length > 40 ? k.substring(0,38)+'...' : k);
            const valuesNewest = sortedKeys.map(k => mapNewest[k]);
            const valuesOldest = sortedKeys.map(k => mapOldest[k] || 0);

            charts.top10 = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: labelNewest, 
                            data: valuesNewest,
                            backgroundColor: CONFIG.colors.teal,
                            barThickness: 8,
                            categoryPercentage: 0.8,
                            barPercentage: 0.9
                        },
                        {
                            label: labelOldest, 
                            data: valuesOldest,
                            backgroundColor: CONFIG.colors.yellow,
                            barThickness: 8,
                            categoryPercentage: 0.8,
                            barPercentage: 0.9
                        }
                    ]
                },
                options: {
                    indexAxis: 'y',
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        datalabels: {
                            anchor: 'end',
                            align: 'right',
                            color: (ctx) => ctx.datasetIndex === 0 ? CONFIG.colors.teal : '#b45309',
                            font: { weight: 'bold', size: 9 },
                            formatter: (val) => val > 0 ? fmtNum(val) : ''
                        }
                    },
                    scales: {
                        x: { display: false, max: Math.max(...valuesNewest, ...valuesOldest) * 1.4 },
                        y: { grid: { display: false }, ticks: { font: {size: 9} } }
                    },
                    layout: { padding: { right: 40 } }
                }
            });
        }

        function renderTable(data) {
            const tbody = document.getElementById('dataTableBody');
            tbody.innerHTML = '';
            
            data.slice(0, 10).forEach((row, idx) => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td class="font-mono text-gray-500">${fmtDate(row.date)}</td>
                    <td class="font-semibold text-gray-700">${row.channel}</td>
                    <td class="truncate max-w-[150px] text-gray-600">${row.desc}</td>
                    <td class="text-right font-bold text-bidv-green font-mono">${fmtNum(row.qty)}</td>
                    <td class="text-right text-gray-800 font-mono">${fmtNum(row.value)}</td>
                `;
                tbody.appendChild(tr);
            });
        }

        // --- 6. UTILITIES ---
        function downloadTemplate() {
            const ws_data = [["Ngay GD", "Nhóm kênh", "Mo ta", "So luong", "Gia tri quy doi"]];
            const ws = XLSX.utils.aoa_to_sheet(ws_data);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Mau_Nhap_Lieu");
            XLSX.writeFile(wb, "Template_Bao_Cao.xlsx");
        }

        function setupFileUpload() {
            document.getElementById('excelFileInput').addEventListener('change', (e) => {
                const file = e.target.files[0];
                if(!file) return;
                const reader = new FileReader();
                reader.onload = (e) => {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, {type: 'array'});
                    const jsonData = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]], {raw: false, cellDates: true});
                    if (jsonData.length > 0) processUploadedData(jsonData);
                    document.getElementById('excelFileInput').value = '';
                };
                reader.readAsArrayBuffer(file);
            });
        }

        function processUploadedData(rawData) {
            const mappedData = rawData.map(r => {
                const qtyKey = Object.keys(r).find(k => k.toLowerCase().includes('so luong') || k.toLowerCase().includes('qty'));
                const valKey = Object.keys(r).find(k => k.toLowerCase().includes('quy doi') || k.toLowerCase().includes('value'));
                const descKey = Object.keys(r).find(k => k.toLowerCase().includes('mo ta') || k.toLowerCase().includes('desc'));
                const dateKey = Object.keys(r).find(k => k.toLowerCase().includes('ngay') || k.toLowerCase().includes('date'));
                const chKey = Object.keys(r).find(k => k.toLowerCase().includes('nhóm kênh') || k.toLowerCase().includes('channel'));

                if(!qtyKey || !dateKey) return null;
                const cleanNum = (v) => (typeof v === 'number' ? v : parseFloat(String(v||'0').replace(/,/g, '')));

                return {
                    date: parseDate(r[dateKey]),
                    channel: r[chKey] || 'Khác',
                    desc: r[descKey] || 'N/A',
                    qty: cleanNum(r[qtyKey]),
                    value: cleanNum(r[valKey])
                };
            }).filter(i => i && i.qty > 0);

            if(!mappedData.length) return alert("File không hợp lệ");

            const datesToUpdate = new Set(mappedData.map(d => d.date));
            appData = appData.filter(d => !datesToUpdate.has(d.date));
            appData.push(...mappedData);
            
            localStorage.setItem(CONFIG.storageKey, JSON.stringify(appData));
            renderAll();
            
            const importedDates = [...datesToUpdate].sort().map(d => fmtDate(d)).join(', ');
            alert(`Đã nhập thành công dữ liệu cho các ngày: ${importedDates}`);
        }

        function toggleModal(id){
            const m = document.getElementById(id);
            m.classList.toggle('opacity-0');
            m.classList.toggle('pointer-events-none');
            if(!m.classList.contains('opacity-0')) renderDateList();
        }
        
        function renderDateList() {
            const list = document.getElementById('dateList');
            const dates = [...new Set(appData.map(d => d.date))].sort().reverse();
            list.innerHTML = dates.map(d => `
                <li class="flex justify-between p-3 border-b hover:bg-gray-50 transition items-center">
                    <span class="font-mono text-bidv-green font-bold">${fmtDate(d)}</span>
                    <button class="text-gray-400 hover:text-red-500 transition" onclick="deleteDate('${d}')"><i class="fa-solid fa-trash"></i></button>
                </li>
            `).join('');
        }
        
        function deleteDate(d) {
            if(confirm(`Xóa dữ liệu ngày ${fmtDate(d)}?`)) {
                appData = appData.filter(i => i.date !== d);
                localStorage.setItem(CONFIG.storageKey, JSON.stringify(appData));
                renderDateList(); renderAll();
            }
        }
        
        function deleteAllData() {
            if(confirm('Bạn có chắc muốn xóa tất cả dữ liệu không?')) {
                localStorage.removeItem(CONFIG.storageKey);
                appData = [];
                renderDateList(); renderAll();
                toggleModal('dataModal');
            }
        }

        window.onload = init;
    </script>
</body>
</html>
