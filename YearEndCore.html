<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Core Banking Monitor - Compact Dual Theme</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Chart.js & Plugins -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
    
    <!-- SheetJS (xlsx) for Excel processing -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- Google Fonts: Inter & Playfair Display -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Playfair+Display:wght@500;700;800&display=swap" rel="stylesheet">

    <style>
        :root {
            /* --- DEFAULT THEME: DARK GOLD & SILVER (Luxury) --- */
            --bg-body-start: #2b2b2b;
            --bg-body-end: #121212;
            --page-bg: radial-gradient(circle at 50% -10%, #54430e, #1a1a1a 90%);
            --card-bg: linear-gradient(180deg, rgba(50,50,50,0.7) 0%, rgba(30,30,30,0.8) 100%);
            --text-main: #ffffff;
            --text-sub: #aaaaaa;
            --text-muted: #888888;
            --border-color: #444;
            --border-dim: rgba(255, 215, 0, 0.25);
            
            --accent-primary: #FFD700;   /* Gold - Newest Data */
            --accent-secondary: #FFFFFF; /* Silver - Oldest Data */
            
            /* Specific Gradient Colors for Dark Theme Title (Gold -> Bronze) */
            --title-grad-start: #FFD700;
            --title-grad-mid: #FDB931;
            --title-grad-end: #b8860b;
            
            --chart-grid: #333;
            --table-row-hover: rgba(255,255,255,0.05);
            --table-header-bg: rgba(255, 215, 0, 0.05);
            --kpi-bg: linear-gradient(145deg, #2a2a2a 0%, #181818 100%);
            --kpi-badge-bg: rgba(0,0,0,0.4);
            
            --shadow-card: 0 4px 6px rgba(0,0,0,0.2);
        }

        /* --- THEME: BIDV BRAND LIGHT (Flat Colors) --- */
        body.theme-brand {
            --bg-body-start: #525252;
            --bg-body-end: #525252;
            --page-bg: #f8fafc;
            --card-bg: #ffffff;
            --text-main: #334155;
            --text-sub: #475569;
            --text-muted: #64748b;
            --border-color: #e2e8f0;
            --border-dim: #f1f5f9;
            
            --accent-primary: #006B68;   /* BIDV Green */
            --accent-secondary: #FFC62F; /* BIDV Yellow */
            
            /* Flat Title Color for Light Theme */
            --title-grad-start: #006B68;
            --title-grad-mid: #006B68;
            --title-grad-end: #006B68;
            
            --chart-grid: #f1f5f9;
            --table-row-hover: #f8fafc;
            --table-header-bg: #f8fafc;
            --kpi-bg: linear-gradient(145deg, #ffffff, #f3f4f6); 
            --kpi-badge-bg: #dcfce7;
            
            --shadow-card: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }

        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, var(--bg-body-start) 0%, var(--bg-body-end) 100%);
            color: var(--text-main);
            display: flex;
            justify-content: center;
            padding: 20px;
            min-height: 100vh;
            transition: background 0.3s ease, color 0.3s ease;
        }

        h1, h2, h3, .serif-font {
            font-family: 'Playfair Display', serif;
        }

        /* Dynamic Text Gradient */
        .text-gradient-dynamic {
            background: linear-gradient(to bottom, var(--title-grad-start), var(--title-grad-mid), var(--title-grad-end));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            color: transparent;
        }
        
        /* Disable shadow for Brand Theme, Enable for Dark */
        body.theme-brand .text-gradient-dynamic {
            background: none;
            -webkit-background-clip: initial;
            -webkit-text-fill-color: initial;
            background-clip: initial;
            color: var(--accent-primary);
            text-shadow: none;
        }

        body:not(.theme-brand) .text-gradient-dynamic {
             text-shadow: 0px 1px 2px rgba(0,0,0,0.3);
        }

        /* A4 Page */
        .page-a4 {
            background: var(--page-bg);
            width: 210mm;
            min-height: 297mm;
            padding: 8mm; /* Reduced padding */
            border: 1px solid var(--border-color);
            box-shadow: 0 20px 50px rgba(0,0,0,0.3);
            display: flex;
            flex-direction: column;
            box-sizing: border-box;
            position: relative;
            transition: background 0.3s ease;
        }

        /* Cards - Compact spacing */
        .report-card {
            background: var(--card-bg);
            border: 1px solid var(--border-dim);
            border-top: 1px solid var(--border-color); 
            position: relative;
            padding: 8px 10px; /* Reduced padding inside cards */
            backdrop-filter: blur(8px);
            box-shadow: var(--shadow-card);
            border-radius: 6px;
        }

        .report-section-header {
            border-bottom: 1px solid;
            border-image: linear-gradient(to right, transparent, var(--accent-primary), transparent) 1;
            padding-bottom: 4px;
            margin-bottom: 4px; /* Tight spacing */
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        body.theme-brand .report-section-header {
            border-image: none;
            border-bottom: 2px solid var(--accent-primary);
        }

        .report-section-title {
            font-family: 'Playfair Display', serif;
            font-weight: 700;
            font-size: 14px; /* Slightly smaller for compact */
            color: var(--accent-primary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        /* KPI Box - Compact */
        .kpi-box {
            background: var(--kpi-bg);
            border: 1px solid var(--border-color);
            padding: 8px 12px;
            border-left: 4px solid var(--accent-primary);
            box-shadow: var(--shadow-card);
            border-radius: 8px;
        }
        
        /* Table Styling */
        .financial-table th {
            font-family: 'Inter', sans-serif;
            font-size: 10px;
            font-weight: 700;
            text-transform: uppercase;
            color: var(--accent-primary); 
            border-bottom: 2px solid var(--border-color);
            padding: 4px 6px;
            background-color: var(--table-header-bg);
            text-align: left;
        }
        
        body.theme-brand .financial-table th {
            color: #64748b; 
        }

        .financial-table td {
            font-size: 10px;
            padding: 4px 6px; /* Tight rows */
            border-bottom: 1px solid var(--border-dim);
            color: var(--text-sub);
        }
        .financial-table tr:last-child td { border-bottom: none; }
        .financial-table tr:hover td { background-color: var(--table-row-hover); }

        /* Helpers */
        .text-accent-primary { color: var(--accent-primary); }
        .text-accent-secondary { color: var(--accent-secondary); }
        .text-muted-custom { color: var(--text-muted); }
        .border-accent { border-color: var(--accent-border); }
        .bg-badge { background-color: var(--kpi-badge-bg); }
        
        body.theme-brand .kpi-value-text { color: #334155 !important; }
        body.theme-brand .kpi-badge-text { color: #15803d !important; }

        /* Print */
        @media print {
            body { background: none; padding: 0; }
            .page-a4 { 
                width: 100%; box-shadow: none; margin: 0; border: none;
                -webkit-print-color-adjust: exact !important;
                print-color-adjust: exact !important;
                background: white !important; 
                color: black !important;
            }
            .text-gradient-dynamic { 
                background: none; 
                -webkit-text-fill-color: #006B68; 
                color: #006B68;
            }
            .no-print { display: none !important; }
        }
        
        .modal { transition: opacity 0.2s ease; }
    </style>
</head>
<body class="theme-brand"> <!-- DEFAULT THEME IS BRAND LIGHT -->

    <!-- Toolbar -->
    <div class="fixed top-4 right-4 flex flex-col gap-2 no-print z-50">
        <input type="file" id="excelFileInput" accept=".xlsx, .xls" class="hidden" />
        
        <button onclick="document.getElementById('excelFileInput').click()" class="bg-[#222] text-[#d4af37] border border-[#d4af37] px-4 py-2 rounded-md hover:bg-[#333] text-sm font-bold transition shadow-md">
            <i class="fa-solid fa-upload"></i> Upload
        </button>
        
        <button onclick="downloadTemplate()" class="bg-[#222] text-gray-300 border border-gray-600 px-4 py-2 rounded-md hover:bg-[#333] text-sm font-bold transition shadow-md">
            <i class="fa-solid fa-download"></i> Template
        </button>

        <button onclick="toggleModal('dataModal')" class="bg-[#222] text-gray-300 border border-gray-600 px-4 py-2 rounded-md hover:bg-[#333] text-sm font-bold transition shadow-md">
            <i class="fa-solid fa-database"></i> Data
        </button>
        
        <button onclick="window.print()" class="bg-gradient-to-r from-[#FFD700] to-[#d4af37] text-black px-4 py-2 rounded-md hover:opacity-90 text-sm font-bold transition border border-yellow-600 shadow-lg">
            <i class="fa-solid fa-print"></i> Print
        </button>

        <button onclick="toggleTheme()" class="bg-teal-700 text-white px-4 py-2 rounded-md hover:bg-teal-600 text-sm font-bold transition border border-teal-500 shadow-lg flex items-center gap-2">
            <i class="fa-solid fa-palette"></i> Đổi Theme
        </button>
    </div>

    <!-- A4 PAGE CONTENT -->
    <div class="page-a4" id="printArea">
        
        <!-- Header -->
        <header class="flex justify-between items-center border-b border-[var(--border-color)] pb-2 mb-3 transition-colors"> <!-- Reduced mb -->
            <div class="flex items-center gap-4">
                <div class="w-12 h-12 bg-transparent border-2 border-[var(--accent-primary)] flex items-center justify-center text-accent-primary text-2xl rounded-md shadow-sm">
                    <i class="fa-solid fa-building-columns"></i>
                </div>
                <div>
                    <!-- Gradient Text Title -->
                    <h1 class="text-2xl font-extrabold text-gradient-dynamic uppercase leading-none tracking-wide whitespace-nowrap">Core Banking Monitor</h1>
                    <p class="text-[10px] text-muted-custom font-bold tracking-[0.2em] mt-1 uppercase font-serif">BC GIAO DỊCH TÀI CHÍNH HÀNG NGÀY</p>
                </div>
            </div>
            <div class="text-right">
                <div class="text-[9px] font-bold text-muted-custom uppercase tracking-widest mb-0.5">NGÀY DỮ LIỆU</div>
                <div class="text-2xl font-bold text-accent-primary font-serif" id="report-date-display">--/--/----</div>
            </div>
        </header>

        <!-- Section 1: KPIs - 3px Gap -->
        <section class="mb-[3px]"> 
            <div class="grid grid-cols-2 gap-[3px]">
                <!-- KPI 1 -->
                <div class="kpi-box flex flex-col justify-between h-24" style="border-left-color: var(--accent-primary);">
                    <div class="flex justify-between items-center">
                        <div>
                            <p class="text-[10px] font-bold text-muted-custom uppercase flex items-center gap-2">
                                <i class="fa-solid fa-file-invoice text-accent-primary"></i> Tổng Số Lượng GD
                            </p>
                            <h3 class="text-3xl font-bold text-accent-primary mt-0.5 font-mono tracking-tight drop-shadow-sm kpi-value-text" id="kpi-count">--</h3>
                        </div>
                        <div class="text-right">
                             <div class="text-xs font-bold text-accent-primary flex items-center justify-end bg-badge px-2 py-0.5 rounded border border-[var(--border-dim)] transition-colors kpi-badge-text">
                                <i class="fa-solid fa-arrow-trend-up mr-1"></i> <span id="kpi-growth-qty">--%</span>
                            </div>
                            <span class="text-[9px] text-muted-custom block mt-1">vs <span class="kpi-compare-date">--</span></span>
                        </div>
                    </div>
                </div>

                <!-- KPI 2 -->
                <div class="kpi-box flex flex-col justify-between h-24" style="border-left-color: var(--accent-secondary);">
                    <div class="flex justify-between items-center">
                        <div>
                            <p class="text-[10px] font-bold text-muted-custom uppercase flex items-center gap-2">
                                <i class="fa-solid fa-coins text-accent-secondary"></i> Tổng Giá Trị (VND)
                            </p>
                            <h3 class="text-3xl font-bold text-accent-primary mt-0.5 font-mono tracking-tight drop-shadow-sm flex items-baseline gap-1 kpi-value-text" id="kpi-value">--</h3>
                        </div>
                        <div class="text-right">
                            <div class="text-xs font-bold text-accent-secondary flex items-center justify-end bg-badge px-2 py-0.5 rounded border border-[var(--border-dim)] transition-colors kpi-badge-text">
                                <i class="fa-solid fa-arrow-trend-up mr-1"></i> <span id="kpi-growth-val">--%</span>
                            </div>
                            <span class="text-[9px] text-muted-custom block mt-1">vs <span class="kpi-compare-date">--</span></span>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Section 2: Charts Area - 3px Gap -->
        <section class="report-card mb-[3px] flex flex-row gap-[3px] h-[200px]"> <!-- Reduced height -->
            <!-- Trend Chart -->
            <div class="flex-1 flex flex-col border-r border-[var(--border-color)] pr-2 transition-colors">
                <div class="report-section-header my-0 py-0 border-none mb-1">
                    <h3 class="report-section-title"><i class="fa-solid fa-chart-line"></i> Xu hướng Giao dịch</h3>
                    <!-- Legend -->
                    <div class="flex gap-2 text-[9px] font-medium text-muted-custom">
                        <span class="flex items-center gap-1"><span class="w-1.5 h-1.5 rounded-full" id="leg-old"></span><span id="lbl-trend-old">--</span></span>
                        <span class="flex items-center gap-1"><span class="w-1.5 h-1.5 rounded-full" id="leg-mid"></span><span id="lbl-trend-mid">--</span></span>
                        <span class="flex items-center gap-1"><span class="w-1.5 h-1.5 rounded-full" id="leg-new"></span><span id="lbl-trend-new">--</span></span>
                    </div>
                </div>
                <div class="flex-1 relative w-full overflow-hidden">
                    <canvas id="trendChart"></canvas>
                </div>
            </div>

            <!-- Channel Chart -->
            <div class="w-[35%] flex flex-col">
                <div class="report-section-header my-0 py-0 border-none mb-1">
                    <h3 class="report-section-title"><i class="fa-solid fa-chart-pie"></i> TỶ TRỌNG NHÓM GIAO DỊCH</h3>
                </div>
                <div class="flex-1 relative w-full overflow-hidden">
                    <canvas id="channelChart"></canvas>
                </div>
            </div>
        </section>

        <!-- Section 3: Top Services - 3px Gap -->
        <section class="report-card mb-[3px] h-[230px] flex flex-col"> <!-- Increased height for spacing -->
            <div class="report-section-header my-0 py-0 border-none mb-1">
                <h3 class="report-section-title"><i class="fa-solid fa-ranking-star"></i> Top 10 Dịch vụ</h3>
                <div class="flex gap-3 text-[9px] font-bold">
                    <div class="flex items-center gap-1 text-accent-primary">
                        <i class="fa-solid fa-square text-[8px]"></i> <span id="lbl-top-newest">--</span>
                    </div>
                    <div class="flex items-center gap-1 text-accent-secondary">
                        <i class="fa-solid fa-square text-[8px]"></i> <span id="lbl-top-oldest">--</span>
                    </div>
                </div>
            </div>
            <div class="flex-1 w-full relative overflow-hidden">
                <canvas id="topServiceChart"></canvas>
            </div>
        </section>

        <!-- Section 4: Data Table - 3px Gap -->
        <section class="flex-1 flex flex-col mb-[3px] min-h-0">
            <div class="report-section-header mb-1 border-none">
                <h3 class="report-section-title"><i class="fa-solid fa-list-ol"></i> Chi tiết Giao dịch (Top 15)</h3>
            </div>
            <div class="overflow-hidden border border-[var(--border-color)] flex-1 transition-colors">
                <table class="w-full text-left financial-table">
                    <thead>
                        <tr>
                            <th class="w-[12%]">Ngày GD</th>
                            <th class="w-[15%]">Nhóm Kênh</th>
                            <th class="w-[38%]">Mô tả Dịch vụ</th>
                            <th class="w-[15%] text-right">Số lượng</th>
                            <th class="w-[20%] text-right">Giá trị (VND)</th>
                        </tr>
                    </thead>
                    <tbody id="dataTableBody">
                        <!-- Content -->
                    </tbody>
                </table>
            </div>
        </section>

        <!-- Footer -->
        <footer class="mt-auto border-t border-[var(--border-color)] pt-2 transition-colors">
            <div class="flex justify-between items-start text-[9px] leading-relaxed text-muted-custom">
                <div class="w-3/4 text-justify pr-4 italic font-serif">
                    <span class="font-bold text-accent-primary not-italic uppercase">Ghi chú:</span> Tất cả giao dịch trên Core được chia thành các nhóm: Thanh toán, Mobile + Internet, Batch + Lô, ATM POS Thẻ, Smart Counter Hub, Quầy, Chứng khoán bảo hiểm. CÁC KÊNH MOBILE VÀ INTERNET BANKING CHƯA CÓ CÁC GIAO DỊCH THANH TOÁN
                </div>
                <div class="w-1/4 text-right">
                    <div class="font-bold text-accent-primary font-serif text-[10px] uppercase">Ban QL&PT Core Banking</div>
                    <div class="mt-0.5">Confidential</div>
                </div>
            </div>
        </footer>

    </div>

    <!-- Data Modal -->
    <div id="dataModal" class="modal opacity-0 pointer-events-none fixed w-full h-full top-0 left-0 flex items-center justify-center z-50 no-print">
        <div class="modal-overlay absolute w-full h-full bg-black opacity-80"></div>
        <div class="modal-container bg-[#222] w-96 mx-auto rounded-md shadow-2xl z-50 p-6 border border-[#444]">
            <div class="flex justify-between items-center mb-4 border-b border-[#444] pb-2">
                <h3 class="font-bold text-xl font-serif text-[#FFD700]">Quản lý Dữ liệu</h3>
                <button onclick="toggleModal('dataModal')" class="text-gray-400 hover:text-white"><i class="fa-solid fa-times"></i></button>
            </div>
            <ul id="dateList" class="max-h-40 overflow-y-auto mb-4 border border-[#444] rounded-sm text-sm p-0 text-gray-300"></ul>
            <button onclick="deleteAllData()" class="w-full bg-red-900/40 text-red-300 border border-red-800 py-2.5 rounded-sm font-bold text-sm hover:bg-red-900/60 uppercase tracking-wide transition">
                <i class="fa-solid fa-trash-can mr-2"></i> Xóa Toàn Bộ
            </button>
        </div>
    </div>

    <script>
        // --- 1. CONFIG & CONSTANTS ---
        Chart.register(ChartDataLabels);

        const CONFIG = {
            storageKey: 'monitor_db_dual_theme_v3_compact',
            currentTheme: 'brand' // DEFAULT TO BRAND LIGHT
        };

        // Define Color Palettes for JS
        const PALETTE = {
            dark: {
                primary: '#FFD700', // Gold
                secondary: '#FFFFFF', // Silver
                tertiary: '#b8860b', // Dark Gold
                text: '#e0e0e0',
                grid: '#444'
            },
            brand: {
                primary: '#006B68', // Green
                secondary: '#FFC62F', // Yellow
                tertiary: '#2dd4bf', // Light Teal
                text: '#1e293b',
                grid: '#e2e8f0'
            }
        };

        // --- 2. LOGIC DATE PROCESSING ---
        const fmtNum = (n) => new Intl.NumberFormat('vi-VN').format(n);
        const fmtDate = (d) => d ? d.split('-').reverse().join('/') : 'N/A';
        const parseDate = (val) => {
            if (val instanceof Date) {
                const year = val.getFullYear();
                const month = String(val.getMonth() + 1).padStart(2, '0');
                const day = String(val.getDate()).padStart(2, '0');
                return `${year}-${month}-${day}`;
            }
            const str = String(val).trim();
            if(str.includes('/')) {
                const parts = str.split('/');
                if(parts.length === 3) {
                    let p0 = parseInt(parts[0], 10);
                    let p1 = parseInt(parts[1], 10);
                    let p2 = parseInt(parts[2], 10);
                    if (p2 < 100) p2 += 2000;
                    const sP0 = String(p0).padStart(2, '0');
                    const sP1 = String(p1).padStart(2, '0');
                    const sYear = String(p2);
                    if (p0 > 12) return `${sYear}-${sP1}-${sP0}`; 
                    else if (p1 > 12) return `${sYear}-${sP0}-${sP1}`;
                    else return `${sYear}-${sP1}-${sP0}`;
                }
            }
            if (str.match(/^\d{4}-\d{2}-\d{2}$/)) return str;
            const isoParts = str.split('-');
            if(isoParts.length === 3) {
                 return `${isoParts[0]}-${isoParts[1].padStart(2, '0')}-${isoParts[2].padStart(2, '0')}`;
            }
            return str;
        };

        // --- 3. DEFAULT DATA ---
        const DEFAULT_DATA = [
            { date: "2025-12-25", channel: "Thanh toán", desc: "A42 - 24x7 Napas", qty: 5086644, value: 45632437973946 },
            { date: "2025-12-25", channel: "Thanh toán", desc: "A23 - TT song phương", qty: 4900402, value: 22630370668772 },
            { date: "2025-12-25", channel: "Thanh toán", desc: "TTHD - Online bill payment", qty: 1714328, value: 8538807986287 },
            { date: "2025-12-25", channel: "Payment Hub", desc: "Payment Hub - Cau phan B2B", qty: 1485960, value: 9917109599476 },
            { date: "2025-12-25", channel: "Mobile + Internet", desc: "BIDV SmartBanking", qty: 1088714, value: 14166257422656 },
            { date: "2025-12-25", channel: "ATM POS Thẻ", desc: "Giao dịch ATM nội mạng", qty: 450000, value: 900000000000 },
            { date: "2025-12-25", channel: "Quầy", desc: "Giao dịch tiền mặt tại quầy", qty: 120000, value: 5000000000000 },
            { date: "2025-12-24", channel: "Tổng hợp", desc: "Dữ liệu tổng hợp hôm qua", qty: 16039850, value: 95000000000000 },
            { date: "2024-12-25", channel: "Thanh toán", desc: "A42 - 24x7 Napas", qty: 3500000, value: 35000000000000 },
            { date: "2024-12-25", channel: "Thanh toán", desc: "A23 - TT song phương", qty: 3200000, value: 18000000000000 },
            { date: "2024-12-25", channel: "Mobile + Internet", desc: "BIDV SmartBanking", qty: 800000, value: 10000000000000 },
            { date: "2024-12-25", channel: "Tổng hợp", desc: "Dữ liệu khác", qty: 3290000, value: 20000000000000 },
            { date: "2025-12-25", channel: "Khác", desc: "DV1 - Dịch vụ bổ sung 1", qty: 150000, value: 300000000000 },
            { date: "2025-12-25", channel: "Khác", desc: "DV2 - Dịch vụ bổ sung 2", qty: 140000, value: 280000000000 },
            { date: "2025-12-25", channel: "Khác", desc: "DV3 - Dịch vụ bổ sung 3", qty: 130000, value: 260000000000 },
            { date: "2025-12-25", channel: "Khác", desc: "DV4 - Dịch vụ bổ sung 4", qty: 120000, value: 240000000000 },
            { date: "2025-12-25", channel: "Khác", desc: "DV5 - Dịch vụ bổ sung 5", qty: 110000, value: 220000000000 }
        ];

        let appData = [];
        let charts = {};

        // --- 4. APP LOGIC ---
        function init() {
            const stored = localStorage.getItem(CONFIG.storageKey);
            appData = stored ? JSON.parse(stored) : [...DEFAULT_DATA];
            
            // Check Theme on Init
            const body = document.body;
            CONFIG.currentTheme = body.classList.contains('theme-brand') ? 'brand' : 'dark';
            
            renderAll();
            setupFileUpload();
        }

        // Toggle Theme Logic
        function toggleTheme() {
            const body = document.body;
            body.classList.toggle('theme-brand');
            CONFIG.currentTheme = body.classList.contains('theme-brand') ? 'brand' : 'dark';
            renderAll(); // Re-render charts with new colors
        }

        function getColors() {
            return PALETTE[CONFIG.currentTheme];
        }

        function renderAll() {
            if (!appData || appData.length === 0) return;

            const datesAsc = [...new Set(appData.map(d => d.date))].sort((a,b) => new Date(a) - new Date(b));
            const d_oldest = datesAsc[0];
            const d_newest = datesAsc[datesAsc.length - 1];
            const d_middle = datesAsc.length > 2 ? datesAsc[datesAsc.length - 2] : null;

            document.getElementById('report-date-display').innerText = fmtDate(d_newest);

            const dataNewest = appData.filter(d => d.date === d_newest);
            const dataOldest = appData.filter(d => d.date === d_oldest);
            
            const qtyNewest = dataNewest.reduce((s,i) => s + i.qty, 0);
            const valNewest = dataNewest.reduce((s,i) => s + i.value, 0);
            const qtyOldest = dataOldest.reduce((s,i) => s + i.qty, 0);
            const valOldest = dataOldest.reduce((s,i) => s + i.value, 0);
            const qtyMiddle = d_middle ? appData.filter(d => d.date === d_middle).reduce((s,i)=>s+i.qty,0) : 0;

            const growthQty = qtyOldest > 0 ? ((qtyNewest - qtyOldest)/qtyOldest * 100).toFixed(1) : '--';
            const growthVal = valOldest > 0 ? ((valNewest - valOldest)/valOldest * 100).toFixed(1) : '--';

            document.getElementById('kpi-growth-qty').innerText = `${growthQty > 0 ? '+' : ''}${growthQty}%`;
            document.getElementById('kpi-growth-val').innerText = `${growthVal > 0 ? '+' : ''}${growthVal}%`;
            document.querySelectorAll('.kpi-compare-date').forEach(el => el.innerText = fmtDate(d_oldest));
            document.getElementById('kpi-count').innerText = fmtNum(qtyNewest);
            
            const valStr = (valNewest/1e12).toFixed(2);
            document.getElementById('kpi-value').innerHTML = `${valStr} <span class="text-[9px] font-bold uppercase ml-1 align-baseline text-muted-custom">NGHÌN TỶ</span>`;

            // Legend Updates
            const c = getColors();
            document.getElementById('lbl-trend-old').innerText = fmtDate(d_oldest);
            document.getElementById('lbl-trend-mid').innerText = d_middle ? fmtDate(d_middle) : (datesAsc.length === 2 ? 'N/A' : '-');
            document.getElementById('lbl-trend-new').innerText = fmtDate(d_newest);
            document.getElementById('lbl-top-newest').innerText = fmtDate(d_newest);
            document.getElementById('lbl-top-oldest').innerText = fmtDate(d_oldest);
            
            // Colorize Legend Circles using inline styles for immediate update
            document.getElementById('leg-old').style.backgroundColor = CONFIG.currentTheme === 'dark' ? '#808080' : '#94a3b8';
            document.getElementById('leg-mid').style.backgroundColor = c.tertiary;
            document.getElementById('leg-new').style.backgroundColor = c.primary;

            // Render Charts
            renderTrendChart([qtyOldest, qtyMiddle, qtyNewest], [fmtDate(d_oldest), d_middle ? fmtDate(d_middle) : '', fmtDate(d_newest)]);
            renderChannelBarChart(dataNewest, qtyNewest);
            renderTop10(dataNewest, dataOldest, fmtDate(d_newest), fmtDate(d_oldest));
            renderTable(dataNewest);
        }

        // --- 5. CHART GRADIENT HELPER ---
        function createGradient(ctx, colorStart, colorEnd) {
            // BRAND THEME CHECK: If current theme is 'brand', return solid color (start color)
            if (CONFIG.currentTheme === 'brand') {
                return colorStart;
            }
            // DARK THEME: Return gradient
            const gradient = ctx.createLinearGradient(0, 0, 0, 200); 
            gradient.addColorStop(0, colorStart);
            gradient.addColorStop(1, colorEnd);
            return gradient;
        }

        // --- CHART RENDERERS ---
        function renderTrendChart(dataArr, labelsArr) {
            const ctx = document.getElementById('trendChart').getContext('2d');
            if(charts.trend) charts.trend.destroy();

            const c = getColors();
            const cleanData = [];
            const cleanLabels = [];
            const bgColors = [];
            
            // Gradients logic based on theme
            const gradNew = createGradient(ctx, c.primary, CONFIG.currentTheme === 'dark' ? 'rgba(101, 67, 33, 0.4)' : 'rgba(0, 107, 104, 0.2)'); 
            const gradMid = createGradient(ctx, c.tertiary, 'rgba(180, 180, 180, 0.2)');
            const gradOld = createGradient(ctx, CONFIG.currentTheme === 'dark' ? '#C0C0C0' : '#94a3b8', 'rgba(100, 100, 100, 0.2)');

            const mapColors = [gradOld, gradMid, gradNew]; 
            
            dataArr.forEach((val, idx) => {
                if(labelsArr[idx]) {
                    cleanData.push(val);
                    cleanLabels.push(labelsArr[idx]);
                    bgColors.push(mapColors[idx]);
                }
            });
            if(cleanData.length === 2 && !labelsArr[1]) bgColors[1] = gradNew;

            charts.trend = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: cleanLabels,
                    datasets: [{
                        data: cleanData,
                        backgroundColor: bgColors,
                        borderRadius: 3,
                        barPercentage: 0.6,
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: { enabled: false },
                        datalabels: {
                            anchor: 'end',
                            align: 'top',
                            offset: 2,
                            color: c.text, 
                            font: { weight: 'bold', size: 10, family: 'Inter' },
                            formatter: (val) => val > 0 ? (val/1e6).toFixed(1) + 'M' : ''
                        }
                    },
                    scales: { 
                        y: { display: false, min: 0, grace: '15%' }, 
                        x: { 
                            grid: { display: false }, 
                            ticks: { font: {size: 10, family: 'Inter'}, color: c.text } 
                        } 
                    },
                    layout: { padding: { top: 15 } }
                }
            });
        }

        function renderChannelBarChart(data, total) {
            const ctx = document.getElementById('channelChart').getContext('2d');
            if(charts.channel) charts.channel.destroy();

            const c = getColors();
            const groups = {};
            data.forEach(d => { groups[d.channel] = (groups[d.channel] || 0) + d.qty; });
            const entries = Object.entries(groups).sort((a, b) => b[1] - a[1]);
            const labels = entries.map(e => e[0]);
            const values = entries.map(e => e[1]);

            // Dynamic Colors/Gradients
            const bgColors = values.map((val, i) => {
                if(i === 0) return createGradient(ctx, c.primary, 'rgba(0,0,0,0.1)'); 
                if(i === 1) return createGradient(ctx, c.secondary, 'rgba(0,0,0,0.1)'); 
                return createGradient(ctx, CONFIG.currentTheme === 'dark' ? '#888' : '#cbd5e1', 'rgba(0,0,0,0.1)'); 
            });

            charts.channel = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        data: values,
                        backgroundColor: bgColors,
                        borderRadius: 3,
                        barThickness: 12
                    }]
                },
                options: {
                    indexAxis: 'y',
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: { enabled: false },
                        datalabels: {
                            anchor: 'end',
                            align: 'right',
                            color: c.text,
                            font: { size: 9, weight: 'bold' },
                            formatter: (val) => ((val/total)*100).toFixed(1) + '%'
                        }
                    },
                    scales: {
                        x: { display: false, max: Math.max(...values) * 1.5 }, 
                        y: { grid: { display: false }, ticks: { font: { size: 9, family: 'Inter' }, color: c.text, autoSkip: false } }
                    },
                    layout: { padding: { right: 20 } }
                }
            });
        }

        function renderTop10(dataNewest, dataOldest, labelNewest, labelOldest) {
            const ctx = document.getElementById('topServiceChart').getContext('2d');
            if(charts.top10) charts.top10.destroy();

            const c = getColors();
            const getMap = (arr) => {
                const map = {};
                arr.forEach(d => { map[d.desc] = (map[d.desc] || 0) + d.qty; });
                return map;
            };
            const mapNewest = getMap(dataNewest);
            const mapOldest = getMap(dataOldest);
            const sortedKeys = Object.keys(mapNewest).sort((a,b) => mapNewest[b] - mapNewest[a]).slice(0, 10);

            const labels = sortedKeys.map(k => k.length > 40 ? k.substring(0,38)+'...' : k);
            const valuesNewest = sortedKeys.map(k => mapNewest[k]);
            const valuesOldest = sortedKeys.map(k => mapOldest[k] || 0);

            let gradNewest, gradOldest;

            // Handle Gradients vs Solid based on Theme
            if(CONFIG.currentTheme === 'brand') {
                gradNewest = c.primary;   // Solid Green
                gradOldest = c.secondary; // Solid Yellow
            } else {
                // Dark Theme Gradients - GOLD to BRONZE (Newest) & SILVER to GREY (Oldest)
                gradNewest = ctx.createLinearGradient(0, 0, 300, 0); 
                gradNewest.addColorStop(0, c.primary); 
                gradNewest.addColorStop(1, '#654321');

                gradOldest = ctx.createLinearGradient(0, 0, 300, 0);
                gradOldest.addColorStop(0, '#FFFFFF'); // Silver
                gradOldest.addColorStop(1, '#808080');
            }

            charts.top10 = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: labelNewest, 
                            data: valuesNewest,
                            backgroundColor: gradNewest,
                            barThickness: 8,
                            categoryPercentage: 0.8,
                            barPercentage: 0.9
                        },
                        {
                            label: labelOldest, 
                            data: valuesOldest,
                            backgroundColor: gradOldest,
                            barThickness: 8,
                            categoryPercentage: 0.8,
                            barPercentage: 0.9
                        }
                    ]
                },
                options: {
                    indexAxis: 'y',
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        datalabels: {
                            anchor: 'end',
                            align: 'right',
                            color: (ctx) => ctx.datasetIndex === 0 ? c.primary : c.secondary,
                            font: { weight: 'bold', size: 9 },
                            formatter: (val) => val > 0 ? fmtNum(val) : ''
                        }
                    },
                    scales: {
                        x: { display: false, max: Math.max(...valuesNewest, ...valuesOldest) * 1.4 },
                        y: { grid: { display: false }, ticks: { font: {size: 9}, color: c.text } }
                    },
                    layout: { padding: { right: 40 } }
                }
            });
        }

        function renderTable(data) {
            const tbody = document.getElementById('dataTableBody');
            tbody.innerHTML = '';
            
            const c = getColors();
            
            data.slice(0, 15).forEach((row, idx) => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td class="font-mono">${fmtDate(row.date)}</td>
                    <td class="font-semibold">${row.channel}</td>
                    <td class="truncate max-w-[150px]">${row.desc}</td>
                    <td class="text-right font-bold font-mono text-accent-primary">${fmtNum(row.qty)}</td>
                    <td class="text-right font-mono">${fmtNum(row.value)}</td>
                `;
                tbody.appendChild(tr);
            });
        }

        // --- 6. UTILITIES (Keep Existing) ---
        function downloadTemplate() {
            const ws_data = [["Ngay GD", "Nhóm kênh", "Mo ta", "So luong", "Gia tri quy doi"]];
            const ws = XLSX.utils.aoa_to_sheet(ws_data);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Mau_Nhap_Lieu");
            XLSX.writeFile(wb, "Template_Bao_Cao.xlsx");
        }

        function setupFileUpload() {
            document.getElementById('excelFileInput').addEventListener('change', (e) => {
                const file = e.target.files[0];
                if(!file) return;
                const reader = new FileReader();
                reader.onload = (e) => {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, {type: 'array'});
                    const jsonData = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]], {raw: false, cellDates: true});
                    if (jsonData.length > 0) processUploadedData(jsonData);
                    document.getElementById('excelFileInput').value = '';
                };
                reader.readAsArrayBuffer(file);
            });
        }

        function processUploadedData(rawData) {
            const mappedData = rawData.map(r => {
                const qtyKey = Object.keys(r).find(k => k.toLowerCase().includes('so luong') || k.toLowerCase().includes('qty'));
                const valKey = Object.keys(r).find(k => k.toLowerCase().includes('quy doi') || k.toLowerCase().includes('value'));
                const descKey = Object.keys(r).find(k => k.toLowerCase().includes('mo ta') || k.toLowerCase().includes('desc'));
                const dateKey = Object.keys(r).find(k => k.toLowerCase().includes('ngay') || k.toLowerCase().includes('date'));
                const chKey = Object.keys(r).find(k => k.toLowerCase().includes('nhóm kênh') || k.toLowerCase().includes('channel'));

                if(!qtyKey || !dateKey) return null;
                const cleanNum = (v) => (typeof v === 'number' ? v : parseFloat(String(v||'0').replace(/,/g, '')));

                return {
                    date: parseDate(r[dateKey]),
                    channel: r[chKey] || 'Khác',
                    desc: r[descKey] || 'N/A',
                    qty: cleanNum(r[qtyKey]),
                    value: cleanNum(r[valKey])
                };
            }).filter(i => i && i.qty > 0);

            if(!mappedData.length) return alert("File không hợp lệ");

            const datesToUpdate = new Set(mappedData.map(d => d.date));
            appData = appData.filter(d => !datesToUpdate.has(d.date));
            appData.push(...mappedData);
            
            localStorage.setItem(CONFIG.storageKey, JSON.stringify(appData));
            renderAll();
            
            const importedDates = [...datesToUpdate].sort().map(d => fmtDate(d)).join(', ');
            alert(`Đã nhập thành công dữ liệu cho các ngày: ${importedDates}`);
        }

        function toggleModal(id){
            const m = document.getElementById(id);
            m.classList.toggle('opacity-0');
            m.classList.toggle('pointer-events-none');
            if(!m.classList.contains('opacity-0')) renderDateList();
        }
        
        function renderDateList() {
            const list = document.getElementById('dateList');
            const dates = [...new Set(appData.map(d => d.date))].sort().reverse();
            list.innerHTML = dates.map(d => `
                <li class="flex justify-between p-3 border-b border-gray-700 hover:bg-gray-800 transition items-center">
                    <span class="font-mono text-[#d4af37] font-bold">${fmtDate(d)}</span>
                    <button class="text-gray-500 hover:text-red-500 transition" onclick="deleteDate('${d}')"><i class="fa-solid fa-trash"></i></button>
                </li>
            `).join('');
        }
        
        function deleteDate(d) {
            if(confirm(`Xóa dữ liệu ngày ${fmtDate(d)}?`)) {
                appData = appData.filter(i => i.date !== d);
                localStorage.setItem(CONFIG.storageKey, JSON.stringify(appData));
                renderDateList(); renderAll();
            }
        }
        
        function deleteAllData() {
            if(confirm('Bạn có chắc muốn xóa tất cả dữ liệu không?')) {
                localStorage.removeItem(CONFIG.storageKey);
                appData = [];
                renderDateList(); renderAll();
                toggleModal('dataModal');
            }
        }

        window.onload = init;
    </script>
</body>
</html>
